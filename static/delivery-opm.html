<!DOCTYPE html>
<html lang="kz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-visual" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Alash Go - –ñ–µ—Ç–∫—ñ–∑—É</title>

  <!-- Telegram SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --primary:#111827; --primary-dark:#000000; --secondary:#0B63F6;
      --success:#00D395; --warning:#FFB800; --danger:#FF5C5C;
      --dark:#0F172A; --dark-light:#111827; --grey:#6B7280; --grey-light:#E5E7EB;
      --white:#FFFFFF; --bg:#F5F5F5; --radius:16px; --radius-lg:24px;
      --shadow:0 4px 24px rgba(15,23,42,.12); --shadow-lg:0 10px 40px rgba(15,23,42,.18);

      /* iOS safe areas */
      --tg-safe-area-inset-top: env(safe-area-inset-top, 0px);
      --tg-safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);

      /* Telegram content safe areas (set via JS if available) */
      --tg-content-safe-area-inset-top: 0px;
      --tg-content-safe-area-inset-bottom: 0px;

      /* Combined insets for UI */
      --tg-top-inset: calc(var(--tg-safe-area-inset-top) + var(--tg-content-safe-area-inset-top));
      --tg-bottom-inset: calc(var(--tg-safe-area-inset-bottom) + var(--tg-content-safe-area-inset-bottom));

      /* Telegram viewport */
      --tg-viewport-stable-height: 100vh;
    }

    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    html,body{
      height:100%;
      width:100%;
      overflow:hidden;
      position:fixed;
      font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display','Helvetica Neue',sans-serif;
      background:var(--bg);
    }

    /* IMPORTANT: keep body stable in Telegram fullscreen + iOS */
    body{
      height: var(--tg-viewport-stable-height, 100vh);
      padding-top: calc(var(--tg-safe-area-inset-top, 0px) + var(--tg-content-safe-area-inset-top, 0px) + 15px);
      background: var(--bg);
    }

    #map,#pickerMap{
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      touch-action:none;
      z-index:1;
      background:#f9fafb;
    }

    /* BACK BUTTON */
    .back-to-main{
      position:fixed;
      top:calc(var(--tg-top-inset) + 16px);
      left:16px;
      width:48px;
      height:48px;
      background:#fff;
      border:none;
      border-radius:50%;
      box-shadow:var(--shadow-lg);
      cursor:pointer;
      z-index:1003;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all .2s ease;
    }
    .back-to-main:active{transform:scale(.94);}
    .back-to-main svg{width:24px;height:24px;fill:var(--dark);}

    .geo-btn{
      position:fixed;
      bottom:calc(var(--tg-bottom-inset) + 240px);
      right:16px;
      width:56px;
      height:56px;
      background:#fff;
      border:none;
      border-radius:999px;
      box-shadow:var(--shadow-lg);
      cursor:pointer;
      z-index:1002;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all .2s ease;
    }
    .geo-btn:active{transform:scale(.94);}
    .geo-btn svg{width:24px;height:24px;fill:var(--dark);}

    .bottom-sheet{
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      background:#fff;
      border-radius:var(--radius-lg) var(--radius-lg) 0 0;
      box-shadow:var(--shadow-lg);
      z-index:1001;
      max-height:88vh;
      display:flex;
      flex-direction:column;
      transition:transform .3s ease;
      padding-bottom: calc(var(--tg-bottom-inset) + 10px);
    }

    .sheet-header{
      padding:12px 20px 8px;
      display:flex;
      flex-direction:column;
      align-items:center;
      flex-shrink:0;
    }
    .sheet-handle{
      width:40px;
      height:4px;
      background:var(--grey-light);
      border-radius:999px;
      margin-bottom:16px;
    }
    .step-progress{
      display:flex;
      gap:8px;
      width:100%;
      max-width:200px;
    }
    .step-bar{
      flex:1;
      height:3px;
      background:var(--grey-light);
      border-radius:999px;
      position:relative;
      overflow:hidden;
    }
    .step-bar.active::after{
      content:'';
      position:absolute;
      inset:0;
      background:var(--primary);
      animation:fillBar .4s ease;
    }
    @keyframes fillBar{from{transform:translateX(-100%)}to{transform:translateX(0)}}

    .sheet-content{
      flex:1;
      overflow-y:auto;
      overflow-x:hidden;
      -webkit-overflow-scrolling:touch;
      padding:0 20px 32px;
    }
    .form-step{display:none;animation:slideIn .3s ease;}
    .form-step.active{display:block;}
    @keyframes slideIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}

    .address-card{
      display:flex;
      align-items:center;
      gap:16px;
      padding:20px 16px;
      background:#F9FAFB;
      border-radius:var(--radius);
      margin-bottom:12px;
      cursor:pointer;
      transition:all .2s ease;
      border:1px solid rgba(148,163,184,.35);
      position:relative;
      overflow:hidden;
    }
    .address-card:active{transform:scale(.98);}
    .address-card.filled{
      background:#EEF2FF;
      border-color:#4F46E5;
      box-shadow:0 10px 30px rgba(79,70,229,.25);
    }
    .location-icon{
      width:48px;
      height:48px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      font-size:18px;
      flex-shrink:0;
      color:#fff;
    }
    .location-icon.start{background:linear-gradient(135deg,#111827,#020617);}
    .location-icon.end{background:linear-gradient(135deg,#EF4444,#FB7185);}
    .location-text{flex:1;min-width:0;}
    .location-label{
      font-size:12px;
      color:var(--grey);
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:.5px;
      margin-bottom:4px;
    }
    .location-value{
      font-size:15px;
      font-weight:500;
      color:var(--dark);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .distance-badge{
      display:none;
      align-items:center;
      gap:8px;
      padding:16px;
      background:linear-gradient(135deg,#22C55E,#4ADE80);
      color:#fff;
      border-radius:var(--radius);
      margin-bottom:20px;
      font-weight:600;
      box-shadow:0 10px 35px rgba(22,163,74,.4);
    }
    .distance-badge.active{display:flex;animation:slideDown .3s ease;}
    @keyframes slideDown{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}

    .form-title{font-size:22px;font-weight:700;color:var(--dark);margin-bottom:24px;}
    .form-field{margin-bottom:16px;}
    .field-label{font-size:13px;font-weight:600;color:var(--grey);margin-bottom:8px;display:block;}
    .field-input{
      width:100%;
      padding:16px;
      background:#F9FAFB;
      border:1px solid rgba(148,163,184,.5);
      border-radius:var(--radius);
      font-size:15px;
      font-weight:500;
      color:var(--dark);
      transition:all .2s ease;
      font-family:inherit;
    }
    .field-input:focus{
      outline:none;
      background:#fff;
      border-color:#4C6FFF;
      box-shadow:0 0 0 1px #4C6FFF33;
    }
    .field-input::placeholder{color:var(--grey);}
    .field-input.error{border-color:var(--danger);}
    textarea.field-input{min-height:100px;resize:none;}

    .truck-grid{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:12px;
      margin-bottom:20px;
    }
    .truck-card{
      padding:16px 12px;
      background:#F9FAFB;
      border:1px solid rgba(148,163,184,.4);
      border-radius:var(--radius);
      text-align:center;
      cursor:pointer;
      transition:all .2s ease;
      position:relative;
    }
    .truck-card:active{transform:scale(.96);}
    .truck-card.selected{
      background:#EEF2FF;
      border-color:#4F46E5;
      box-shadow:0 8px 30px rgba(79,70,229,.35);
    }
    .truck-card.selected::after{
      content:'‚úì';
      position:absolute;
      top:8px;
      right:8px;
      width:20px;
      height:20px;
      background:#4F46E5;
      color:#fff;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      font-weight:700;
    }
    .truck-icon{font-size:26px;margin-bottom:6px;}
    .truck-name{font-size:13px;font-weight:600;color:var(--dark);margin-bottom:2px;}
    .truck-desc{font-size:11px;color:var(--grey);}

    .photo-uploader{
      background:#F9FAFB;
      border:1px dashed rgba(148,163,184,.7);
      border-radius:var(--radius);
      padding:14px;
      display:flex;
      gap:12px;
      align-items:center;
    }
    .photo-thumb{
      width:64px;
      height:64px;
      border-radius:14px;
      background:#fff;
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
    }
    .photo-thumb img{width:100%;height:100%;object-fit:cover;}
    .photo-actions{display:flex;gap:8px;flex-wrap:wrap;}
    .uploader-note{font-size:12px;color:var(--grey);margin-top:6px;}

    .datetime-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }

    .btn-group{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
      margin-top:24px;
      position:sticky;
      bottom:0;
      background:#fff;
      padding-top:16px;
      padding-bottom: 10px;
    }
    .btn-group.double{grid-template-columns:1fr 1fr;}
    .btn{
      padding:18px 24px;
      border:none;
      border-radius:999px;
      font-size:16px;
      font-weight:600;
      cursor:pointer;
      transition:all .2s ease;
      position:relative;
      overflow:hidden;
      user-select:none;
      -webkit-user-select:none;
    }
    .btn::before{
      content:'';
      position:absolute;
      top:50%;left:50%;
      width:0;height:0;
      border-radius:50%;
      background:rgba(255,255,255,.3);
      transform:translate(-50%,-50%);
      transition:width .5s,height .5s;
    }
    .btn:active::before{width:260px;height:260px;}
    .btn-primary{
      background:linear-gradient(135deg,#111827,#020617);
      color:#fff;
      box-shadow:0 10px 40px rgba(15,23,42,.55);
    }
    .btn-primary:active{transform:scale(.96);}
    .btn-primary:disabled{
      background:#E5E7EB;
      color:#9CA3AF;
      box-shadow:none;
      cursor:not-allowed;
    }
    .btn-secondary{
      background:#F9FAFB;
      color:var(--dark);
      border:1px solid rgba(148,163,184,.7);
    }
    .btn-secondary:active{background:#E5E7EB;transform:scale(.96);}

    .error-message{
      font-size:12px;
      color:var(--danger);
      margin-top:4px;
      display:none;
    }
    .error-message.show{display:block;}

    .success-screen{
      position:fixed;
      inset:0;
      background:radial-gradient(circle at top,#4ADE80,#22C55E 45%,#16A34A 80%);
      z-index:3000;
      display:none;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      padding:40px;
      text-align:center;
    }
    .success-screen.active{display:flex;animation:fadeIn .4s ease;}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .success-icon{
      width:120px;
      height:120px;
      background:rgba(22,163,74,.25);
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:64px;
      margin-bottom:32px;
      box-shadow:0 16px 40px rgba(22,163,74,.55);
      animation:scaleIn .5s ease;
    }
    @keyframes scaleIn{from{transform:scale(0);opacity:0}to{transform:scale(1);opacity:1}}
    .success-title{font-size:28px;font-weight:700;color:#fff;margin-bottom:12px;}
    .success-message{font-size:16px;color:rgba(255,255,255,.9);margin-bottom:32px;line-height:1.6;}
    .success-btn{
      padding:16px 32px;
      background:#fff;
      color:#16A34A;
      border:none;
      border-radius:999px;
      font-size:16px;
      font-weight:600;
      cursor:pointer;
      box-shadow:0 8px 30px rgba(0,0,0,.25);
    }

    /* PICKER MODAL */
    .picker-modal{position:fixed;inset:0;background:#fff;z-index:2000;display:none;}
    .picker-modal.active{display:block;}

    .picker-header{
      position:fixed;
      top:calc(var(--tg-top-inset) + 16px);
      left:16px;
      right:16px;
      z-index:2010;
      display:flex;
      gap:12px;
      pointer-events:auto;
    }
    .picker-back-btn{
      width:48px;height:48px;
      background:#fff;
      border:none;
      border-radius:999px;
      box-shadow:var(--shadow);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      flex-shrink:0;
    }
    .picker-back-btn:active{transform:scale(.94);}
    .search-box{
      flex:1;
      background:#fff;
      border:none;
      border-radius:999px;
      padding:14px 16px;
      box-shadow:var(--shadow);
      font-size:15px;
      font-weight:500;
    }
    .search-box:focus{
      outline:none;
      box-shadow:0 0 0 1px #4C6FFF33, var(--shadow);
    }

    /* CENTER PIN (THIN UBER-STYLE) */
    .center-pin-overlay{
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      z-index:2005;
      pointer-events:none;
      display:none;
    }
    .center-pin-overlay.active{display:block;}

    .pin-container{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%, -102%);
      display:flex;
      flex-direction:column;
      align-items:center;
    }

    .pin-address-bubble{
      background:#000;
      color:#fff;
      padding:8px 14px;
      border-radius:12px;
      font-size:13px;
      font-weight:500;
      margin-bottom:10px;
      box-shadow:0 4px 20px rgba(0,0,0,.28);
      max-width:280px;
      text-align:center;
      line-height:1.4;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Thin pin using SVG */
    .uber-pin{
      width:28px;
      height:40px;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.25));
      transform: translateY(0);
      animation:pinBounce .6s ease-out;
    }
    @keyframes pinBounce{
      0%{transform:translateY(-16px) scale(.85);opacity:0;}
      70%{transform:translateY(0) scale(1.05);opacity:1;}
      100%{transform:translateY(0) scale(1);opacity:1;}
    }

    /* PICKER GEOLOCATION BUTTON */
    .picker-geo-btn{
      position:fixed;
      bottom:calc(var(--tg-bottom-inset) + 100px);
      right:16px;
      width:56px;
      height:56px;
      background:#fff;
      border:none;
      border-radius:50%;
      box-shadow:var(--shadow-lg);
      cursor:pointer;
      z-index:2008;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all .2s ease;
    }
    .picker-geo-btn:active{transform:scale(.94);}
    .picker-geo-btn svg{width:24px;height:24px;fill:var(--dark);}

    .confirm-btn{
      position:fixed;
      bottom:calc(var(--tg-bottom-inset) + 20px);
      left:16px;
      right:16px;
      z-index:2020;
    }

    .suggestions{
      position:fixed;
      top:calc(var(--tg-top-inset) + 80px);
      left:16px;
      right:16px;
      background:#fff;
      border-radius:var(--radius);
      box-shadow:var(--shadow-lg);
      max-height:45vh;
      overflow-y:auto;
      z-index:2012;
      display:none;
    }
    .suggestions.active{display:block;animation:slideDown .25s ease;}
    .suggestion-item{
      padding:10px 14px;
      border-bottom:1px solid var(--grey-light);
      cursor:pointer;
      transition:background .15s;
      font-size:14px;
    }
    .suggestion-item:last-child{border-bottom:none;}
    .suggestion-item:active{background:#F9FAFB;}
    .suggestion-title{font-weight:600;margin-bottom:2px;}
    .suggestion-sub{font-size:12px;color:var(--grey);}

    .user-marker{
      width:16px;
      height:16px;
      background:#0B63F6;
      border:3px solid #fff;
      border-radius:999px;
      box-shadow:0 2px 10px rgba(37,99,235,.75);
      animation:pulse 2s infinite;
    }
    @keyframes pulse{
      0%,100%{box-shadow:0 2px 10px rgba(37,99,235,.7);}
      50%{box-shadow:0 2px 18px rgba(37,99,235,1);}
    }

    .custom-marker{
      width:40px;
      height:40px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      color:#fff;
      font-size:18px;
      border:3px solid #fff;
      box-shadow:0 10px 30px rgba(15,23,42,.65);
    }
    .custom-marker.pickup{background:linear-gradient(135deg,#020617,#111827);}
    .custom-marker.dropoff{background:linear-gradient(135deg,#EF4444,#F97316);}

    @media (max-height:700px){
      .bottom-sheet{max-height:85vh;}
      .truck-grid{grid-template-columns:repeat(3,1fr);gap:8px;}
      .truck-card{padding:12px 8px;}
    }
    @media (max-width:360px){
      .truck-grid{grid-template-columns:repeat(2,1fr);}
    }

    .leaflet-control-container{display:none;}

    .toast-notice{
      position:fixed;
      bottom:calc(var(--tg-bottom-inset) + 24px);
      left:50%;
      transform:translateX(-50%) translateY(12px);
      background:rgba(15,23,42,0.96);
      color:#fff;
      padding:10px 18px;
      border-radius:999px;
      font-size:13px;
      font-weight:500;
      box-shadow:0 10px 30px rgba(15,23,42,0.55);
      z-index:4000;
      opacity:0;
      pointer-events:none;
      display:flex;
      align-items:center;
      gap:8px;
      transition:opacity .25s ease, transform .25s ease;
    }
    .toast-notice svg{width:16px;height:16px;flex-shrink:0;}
    .toast-notice.show{
      opacity:1;
      pointer-events:auto;
      transform:translateX(-50%) translateY(-4px);
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <!-- BACK TO MAIN BUTTON -->
  <button class="back-to-main" onclick="goToMainClient()" aria-label="–ê—Ä—Ç“õ–∞">
    <svg viewBox="0 0 24 24">
      <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
    </svg>
  </button>

  <!-- GEOLOCATION BUTTON (main map) -->
  <button class="geo-btn" onclick="centerOnUserLocation()" id="geoBtn" aria-label="–ú–µ–Ω—ñ“£ –æ—Ä–Ω—ã–º–∞ —Ñ–æ–∫—É—Å">
    <svg viewBox="0 0 24 24">
      <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3A8.994 8.994 0 0013 3.06V1h-2v2.06A8.994 8.994 0 003.06 11H1v2h2.06A8.994 8.994 0 0011 20.94V23h2v-2.06A8.994 8.994 0 0020.94 13H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/>
    </svg>
  </button>

  <!-- SUCCESS SCREEN -->
  <div class="success-screen" id="successScreen">
    <div class="success-icon">üéâ</div>
    <div class="success-title">–¢–∞–ø—Å—ã—Ä—ã—Å –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ!</div>
    <div class="success-message">
      “ö–æ–ª –∂–µ—Ç—ñ–º–¥—ñ –∂“Ø—Ä–≥—ñ–∑—É—à—ñ–ª–µ—Ä–¥—ñ —ñ–∑–¥–µ–ø –∂–∞—Ç—ã—Ä–º—ã–∑...<br/>–ë“±–ª –±—ñ—Ä–Ω–µ—à–µ —Å–µ–∫—É–Ω–¥“õ–∞ —Å–æ–∑—ã–ª–∞–¥—ã
    </div>
    <button class="success-btn" onclick="goToDriverList()">–ñ“Ø—Ä–≥—ñ–∑—É—à—ñ–ª–µ—Ä–¥—ñ –∫”©—Ä—É</button>
  </div>

  <!-- BOTTOM SHEET -->
  <div class="bottom-sheet" id="bottomSheet">
    <div class="sheet-header">
      <div class="sheet-handle"></div>
      <div class="step-progress">
        <div class="step-bar active" id="stepBar1"></div>
        <div class="step-bar" id="stepBar2"></div>
        <div class="step-bar" id="stepBar3"></div>
      </div>
    </div>

    <div class="sheet-content">
      <!-- STEP 1 -->
      <div class="form-step active" id="step1">
        <div class="address-card" onclick="openPicker('pickup')">
          <div class="location-icon start">A</div>
          <div class="location-text">
            <div class="location-label">“ö–ê–ô–î–ê–ù</div>
            <div class="location-value" id="pickupAddr">–û—Ä—ã–Ω–¥—ã –∞–Ω—ã“õ—Ç–∞—É...</div>
          </div>
        </div>

        <div class="address-card" onclick="openPicker('dropoff')">
          <div class="location-icon end">B</div>
          <div class="location-text">
            <div class="location-label">“ö–ê–ô–î–ê</div>
            <div class="location-value" id="dropoffAddr">–ë–∞—Ä–∞—Ç—ã–Ω –∂–µ—Ä–¥—ñ —Ç–∞“£–¥–∞“£—ã–∑</div>
          </div>
        </div>

        <div class="distance-badge" id="distanceBadge">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
            <path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/>
          </svg>
          <span id="distanceText"></span>
        </div>

        <div class="btn-group">
          <button class="btn btn-primary" id="nextBtn1" onclick="goToStep(2)" disabled>–ö–µ–ª–µ—Å—ñ</button>
        </div>
      </div>

      <!-- STEP 2 -->
      <div class="form-step" id="step2">
        <div class="form-title">–ñ–µ—Ç–∫—ñ–∑—É –º”ô–ª—ñ–º–µ—Ç—Ç–µ—Ä—ñ</div>

        <div class="form-field">
          <label class="field-label">üí∞ –ë–∞“ì–∞ (—Ç–µ“£–≥–µ)</label>
          <input type="number" class="field-input" id="price" placeholder="5000" min="2000" oninput="validateStep2()" />
          <div class="error-message" id="priceError">–ú–∏–Ω–∏–º—É–º 2000 —Ç–µ“£–≥–µ</div>
        </div>

        <div class="form-field">
          <label class="field-label">üöö –ö”©–ª—ñ–∫ —Ç“Ø—Ä—ñ</label>
          <div class="truck-grid">
            <div class="truck-card" data-truck="intercity" onclick="selectTruck(event,'intercity')">
              <div class="truck-icon">üöï</div>
              <div class="truck-name">“ö–∞–ª–∞ –∞—Ä–∞–ª—ã“õ</div>
              <div class="truck-desc">—Ç–∞–∫—Å–∏</div>
            </div>
            <div class="truck-card" data-truck="small" onclick="selectTruck(event,'small')">
              <div class="truck-icon">üöê</div>
              <div class="truck-name">–ö—ñ—à—ñ</div>
              <div class="truck-desc">1.5—Ç –¥–µ–π—ñ–Ω</div>
            </div>
            <div class="truck-card" data-truck="medium" onclick="selectTruck(event,'medium')">
              <div class="truck-icon">üöö</div>
              <div class="truck-name">–û—Ä—Ç–∞—à–∞</div>
              <div class="truck-desc">5—Ç –¥–µ–π—ñ–Ω</div>
            </div>
            <div class="truck-card" data-truck="large" onclick="selectTruck(event,'large')">
              <div class="truck-icon">üöõ</div>
              <div class="truck-name">“Æ–ª–∫–µ–Ω</div>
              <div class="truck-desc">20—Ç –¥–µ–π—ñ–Ω</div>
            </div>
            <div class="truck-card" data-truck="tow" onclick="selectTruck(event,'tow')">
              <div class="truck-icon">üöó</div>
              <div class="truck-name">–≠–≤–∞–∫—É–∞—Ç–æ—Ä</div>
              <div class="truck-desc">—ç–≤–∞–∫—É–∞—Ü–∏—è</div>
            </div>
            <div class="truck-card" data-truck="any" onclick="selectTruck(event,'any')">
              <div class="truck-icon">üöô</div>
              <div class="truck-name">–ö–µ–∑ –∫–µ–ª–≥–µ–Ω</div>
              <div class="truck-desc">–∂–∞—Ä–∞–π–¥—ã</div>
            </div>
          </div>
          <div class="error-message" id="truckError">–ö”©–ª—ñ–∫ —Ç“Ø—Ä—ñ–Ω —Ç–∞“£–¥–∞“£—ã–∑</div>
        </div>

        <div class="form-field">
          <label class="field-label">
            üì∏ –ñ“Ø–∫—Ç—ñ“£ —Ñ–æ—Ç–æ—Å—ã
            <span style="font-weight:400;color:var(--grey)">(–º—ñ–Ω–¥–µ—Ç—Ç—ñ –µ–º–µ—Å)</span>
          </label>
          <div class="photo-uploader">
            <div class="photo-thumb" id="photoThumb">
              <span style="font-size:22px">üñºÔ∏è</span>
            </div>
            <div style="flex:1">
              <input id="cargoPhoto" type="file" accept="image/*" style="display:none" />
              <div class="photo-actions">
                <button class="btn btn-secondary" type="button" onclick="openSystemPicker()">–§–æ—Ç–æ–Ω—ã –∂“Ø–∫—Ç–µ—É</button>
                <button class="btn btn-secondary" type="button" onclick="clearCargoPhoto()">–¢–∞–∑–∞–ª–∞—É</button>
              </div>
              <div class="uploader-note">
                20 –ú–ë-—Ç–∞–Ω –∞—Å–ø–∞—É –∫–µ—Ä–µ–∫. –ë—ñ—Ä —Ç–∞–ø ‚Äì “õ“±—Ä—ã–ª“ì—ã–Ω—ã“£ –Ω–∞—Ç–∏–≤—Ç—ñ —Ç–∞“£–¥–∞“ì—ã—à—ã –∞—à—ã–ª–∞–¥—ã.
              </div>
            </div>
          </div>
          <div class="error-message" id="photoError">–§–∞–π–ª —Ç—ã–º “Ø–ª–∫–µ–Ω (–º–∞–∫—Å. 20 –ú–ë)</div>
        </div>

        <div class="datetime-grid">
          <div class="form-field">
            <label class="field-label">üìÖ –ö“Ø–Ω—ñ</label>
            <input type="date" class="field-input" id="date" oninput="validateStep2()" />
            <div class="error-message" id="dateError">–ö“Ø–Ω–¥—ñ —Ç–∞“£–¥–∞“£—ã–∑</div>
          </div>
          <div class="form-field">
            <label class="field-label">‚è∞ –£–∞“õ—ã—Ç—ã</label>
            <input type="time" class="field-input" id="time" oninput="validateStep2()" />
            <div class="error-message" id="timeError">–£–∞“õ—ã—Ç—Ç—ã —Ç–∞“£–¥–∞“£—ã–∑</div>
          </div>
        </div>

        <div class="btn-group double">
          <button class="btn btn-secondary" onclick="goToStep(1)">–ê—Ä—Ç“õ–∞</button>
          <button class="btn btn-primary" id="nextBtn2" onclick="goToStep(3)" disabled>–ö–µ–ª–µ—Å—ñ</button>
        </div>
      </div>

      <!-- STEP 3 -->
      <div class="form-step" id="step3">
        <div class="form-title">–ë–∞–π–ª–∞–Ω—ã—Å –∞“õ–ø–∞—Ä–∞—Ç—ã</div>

        <div class="form-field">
          <label class="field-label">üì± –¢–µ–ª–µ—Ñ–æ–Ω</label>
          <input type="tel" class="field-input" id="phone" placeholder="+7 (___) ___-__-__" oninput="formatPhone(this); validateStep3()" />
          <div class="error-message" id="phoneError">–¢–æ–ª—ã“õ —Ç–µ–ª–µ—Ñ–æ–Ω –Ω”©–º—ñ—Ä—ñ–Ω –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑</div>
        </div>

        <div class="form-field">
          <label class="field-label">üí¨ –¢“Ø—Å—ñ–Ω—ñ–∫—Ç–µ–º–µ</label>
          <textarea class="field-input" id="comment" placeholder="“ö–æ—Å—ã–º—à–∞ –∞“õ–ø–∞—Ä–∞—Ç..." oninput="validateStep3()"></textarea>
          <div class="error-message" id="commentError">–¢“Ø—Å—ñ–Ω—ñ–∫—Ç–µ–º–µ–Ω—ñ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑</div>
        </div>

        <div class="btn-group double">
          <button class="btn btn-secondary" onclick="goToStep(2)">–ê—Ä—Ç“õ–∞</button>
          <button class="btn btn-primary" id="submitBtn" onclick="submitOrder()" disabled>–ñ—ñ–±–µ—Ä—É</button>
        </div>
      </div>
    </div>
  </div>

  <!-- FULLSCREEN PICKER WITH UBER PIN -->
  <div class="picker-modal" id="pickerModal">
    <div id="pickerMap"></div>

    <!-- CENTER PIN OVERLAY -->
    <div class="center-pin-overlay" id="centerPinOverlay">
      <div class="pin-container">
        <div class="pin-address-bubble" id="pinAddressBubble">–ö–∞—Ä—Ç–∞–Ω—ã –∂—ã–ª–∂—ã—Ç—ã“£—ã–∑...</div>

        <!-- Thin Uber-style pin SVG -->
        <svg class="uber-pin" viewBox="0 0 24 32" aria-hidden="true">
          <path d="M12 31s9-10.2 9-18A9 9 0 1 0 3 13c0 7.8 9 18 9 18z" fill="#000"/>
          <circle cx="12" cy="13" r="4" fill="#fff"/>
        </svg>
      </div>
    </div>

    <div class="picker-header">
      <button class="picker-back-btn" onclick="closePicker()">‚Üê</button>
      <input
        type="text"
        class="search-box"
        id="searchBox"
        placeholder="–ú–µ–∫–µ–Ω–∂–∞–π —ñ–∑–¥–µ—É..."
        oninput="debouncedSearch(this.value)"
        onfocus="onSearchFocus()"
        onblur="hideSuggestionsDelayed()"
      />
    </div>

    <!-- PICKER GEOLOCATION BUTTON -->
    <button class="picker-geo-btn" onclick="centerPickerOnUser()" aria-label="–ú–µ–Ω—ñ“£ –æ—Ä–Ω—ã–º">
      <svg viewBox="0 0 24 24">
        <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3A8.994 8.994 0 0013 3.06V1h-2v2.06A8.994 8.994 0 003.06 11H1v2h2.06A8.994 8.994 0 0011 20.94V23h2v-2.06A8.994 8.994 0 0020.94 13H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/>
      </svg>
    </button>

    <div class="suggestions" id="suggestions"></div>
    <button class="btn btn-primary confirm-btn" onclick="confirmPicker()">
      <span>–û—Å—ã –Ω“Ø–∫—Ç–µ–Ω—ñ —Ç–∞“£–¥–∞—É</span>
    </button>
  </div>

  <div class="toast-notice" id="toastNotice">
    <svg viewBox="0 0 24 24" fill="none">
      <circle cx="12" cy="12" r="10" stroke="white" stroke-width="1.5" opacity="0.8"></circle>
      <path d="M12 7V13" stroke="white" stroke-width="1.5" stroke-linecap="round"></path>
      <circle cx="12" cy="16" r="1" fill="white"></circle>
    </svg>
    <span id="toastText"></span>
  </div>

  <script>
    const NOMINATIM_BASE = 'https://nominatim.openstreetmap.org';

    const urlParams = new URLSearchParams(window.location.search);
    let currentLang = urlParams.get('lang') || localStorage.getItem('lang') || 'kz';
    localStorage.setItem('lang', currentLang);

    function langHeader(){
      return currentLang === 'ru' ? 'ru-RU' : 'kk-KZ';
    }

    function isInKazakhstan(lat, lng){
      return lat >= 40 && lat <= 56 && lng >= 46 && lng <= 88;
    }

    let toastTimeout = null;
    function showToast(messageKey){
      const el = document.getElementById('toastNotice');
      const textEl = document.getElementById('toastText');
      const msg = messageKey === 'outside_kz'
        ? (currentLang === 'ru'
            ? '–°–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞'
            : '–°–µ—Ä–≤–∏—Å —Ç–µ–∫ “ö–∞–∑–∞“õ—Å—Ç–∞–Ω –∞—É–º–∞“ì—ã–Ω–¥–∞ –∂“±–º—ã—Å —ñ—Å—Ç–µ–π–¥—ñ')
        : messageKey;
      textEl.textContent = msg;
      el.classList.add('show');
      clearTimeout(toastTimeout);
      toastTimeout = setTimeout(()=>el.classList.remove('show'), 2600);
    }

    let state = {
      userLoc: null,
      pickup: null,
      dropoff: null,
      pickingFor: null,
      currentStep: 1,
      selectedTruck: null,
      orderData: null,
      isSearching: false
    };

    let map, pickerMap, userMarker, pickupMarker, dropoffMarker;
    let pickerUserMarker = null;

    // tracking
    let geolocationWatchId = null;
    let forceTickTimer = null;
    let lastGeoUpdateAt = 0;

    let currentUserLocation = null, lastUserPosition = null;
    let suggestionsTimeout = null, searchDebounceTimer = null;
    let pickerMoveTimeout = null;

    const geocodeCache = new Map();
    const CACHE_EXPIRY = 30 * 60 * 1000;

    function getCachedGeocode(key) {
      const cached = geocodeCache.get(key);
      if (cached && Date.now() - cached.timestamp < CACHE_EXPIRY) {
        return cached.value;
      }
      geocodeCache.delete(key);
      return null;
    }

    function setCachedGeocode(key, value) {
      geocodeCache.set(key, { value, timestamp: Date.now() });
      if (geocodeCache.size > 100) {
        const firstKey = geocodeCache.keys().next().value;
        geocodeCache.delete(firstKey);
      }
    }

    async function reverseGeocode(lat, lng) {
      const cacheKey = `${lat.toFixed(6)},${lng.toFixed(6)}`;
      const cached = getCachedGeocode(cacheKey);
      if (cached) return cached;

      try {
        const url = `${NOMINATIM_BASE}/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=${encodeURIComponent(langHeader())}`;
        const res = await fetch(url, { cache: 'force-cache' });
        const data = await res.json();

        if (data?.address?.country_code && data.address.country_code.toLowerCase() !== 'kz') {
          const fallback = formatFallbackAddress(lat, lng);
          setCachedGeocode(cacheKey, fallback);
          return fallback;
        }

        const addr = data.address || {};
        const city = addr.city || addr.town || addr.village || addr.county || '';
        const street = addr.road || addr.neighbourhood || '';
        const number = addr.house_number || '';

        let formatted = '';
        if (city && street && number) formatted = `${city}, ${street}: ${number}`;
        else if (city && street) formatted = `${city}, ${street}`;
        else if (street && number) formatted = `${street}: ${number}`;
        else if (city) formatted = city;
        else if (street) formatted = street;
        else if (data.display_name) {
          const parts = data.display_name.split(',').map(p => p.trim());
          formatted = parts.slice(0, 3).join(', ');
        } else {
          formatted = formatFallbackAddress(lat, lng);
        }

        setCachedGeocode(cacheKey, formatted);
        return formatted;

      } catch (error) {
        console.error('Reverse geocode error:', error);
        const fallback = formatFallbackAddress(lat, lng);
        setCachedGeocode(cacheKey, fallback);
        return fallback;
      }
    }

    function formatFallbackAddress(lat, lng) {
      return currentLang === 'ru'
        ? `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${lat.toFixed(5)}¬∞, ${lng.toFixed(5)}¬∞`
        : `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—Ç–∞—Ä: ${lat.toFixed(5)}¬∞, ${lng.toFixed(5)}¬∞`;
    }

    function debouncedSearch(query) {
      clearTimeout(searchDebounceTimer);
      searchDebounceTimer = setTimeout(() => searchAddress(query), 280);
    }

    async function searchAddress(query) {
      const s = document.getElementById('suggestions');

      if (query.length < 2) {
        s.classList.remove('active');
        return;
      }

      state.isSearching = true;
      s.innerHTML = `<div class="suggestion-item"><div class="suggestion-title">–Ü–∑–¥–µ—É‚Ä¶</div></div>`;
      s.classList.add('active');

      try {
        const results = await performKazakhstanSearch(query);

        if (results.length === 0) {
          s.innerHTML = `<div class="suggestion-item"><div class="suggestion-title">–ï—à—Ç–µ“£–µ —Ç–∞–±—ã–ª–º–∞–¥—ã</div></div>`;
          return;
        }

        s.innerHTML = results.map(r => `
          <div class="suggestion-item"
               data-lat="${r.lat}"
               data-lng="${r.lon}"
               data-label="${escapeHtml(r.title)}"
               onclick="selectSuggestionFromElement(this)">
            <div class="suggestion-title">${escapeHtml(r.title)}</div>
            <div class="suggestion-sub">${escapeHtml(r.subtitle)}</div>
          </div>
        `).join('');

        s.classList.add('active');

      } catch (e) {
        console.error('Search error:', e);
        s.innerHTML = `<div class="suggestion-item"><div class="suggestion-title">“ö–∞—Ç–µ</div></div>`;
      } finally {
        state.isSearching = false;
      }
    }

    async function performKazakhstanSearch(query) {
      const center = pickerMap?.getCenter() || { lat: 43.238949, lng: 76.889709 };

      const params = new URLSearchParams({
        format: 'json',
        q: query,
        countrycodes: 'kz',
        limit: '20',
        addressdetails: '1',
        'accept-language': langHeader(),
        dedupe: '1'
      });

      const url = `${NOMINATIM_BASE}/search?${params}`;
      const res = await fetch(url, { cache: 'no-store' });
      let rawResults = await res.json();

      if (!rawResults || rawResults.length === 0) return [];

      const processed = rawResults.map(r => {
        const addr = r.address || {};

        let title = '';
        if (addr.house_number && addr.road) title = `${addr.road}: ${addr.house_number}`;
        else if (addr.road) title = addr.road;
        else if (r.name) title = r.name;
        else title = (r.display_name || '').split(',')[0] || '...';

        const city = addr.city || addr.town || addr.village || '';
        const st = addr.state || '';
        let subtitle = '';
        if (city && st && city !== st) subtitle = `${city}, ${st}`;
        else if (city) subtitle = city;
        else if (st) subtitle = st;

        const dist = calculateDistance(center.lat, center.lng, +r.lat, +r.lon);
        const typeScore = getTypeScore(r.type, r.class);
        const cityMatch = city && query.toLowerCase().includes(city.toLowerCase()) ? 0.5 : 1;
        const score = (dist * cityMatch) + (typeScore * 5);

        return { lat:+r.lat, lon:+r.lon, title, subtitle, score, importance:r.importance || 0 };
      });

      processed.sort((a,b) => {
        const d = a.score - b.score;
        if (Math.abs(d) > 0.1) return d;
        return b.importance - a.importance;
      });

      return processed.slice(0, 15);
    }

    function getTypeScore(type, classType) {
      const priorities = {
        city: 1, town: 2, village: 3, suburb: 4, neighbourhood: 5,
        residential: 6, amenity: 7, building: 8, street: 9
      };
      return priorities[type] || priorities[classType] || 10;
    }

    function selectSuggestionFromElement(el) {
      const lat = parseFloat(el.dataset.lat);
      const lng = parseFloat(el.dataset.lng);

      if (!isInKazakhstan(lat, lng)) {
        showToast('outside_kz');
        return;
      }

      const label = el.dataset.label;

      if (pickerMap) {
        pickerMap.setView([lat, lng], 17, { animate: true });
      }

      document.getElementById('suggestions').classList.remove('active');
      document.getElementById('searchBox').value = label;
      state.isSearching = false;
    }

    function hideSuggestionsDelayed() {
      clearTimeout(suggestionsTimeout);
      suggestionsTimeout = setTimeout(() => {
        document.getElementById('suggestions').classList.remove('active');
        state.isSearching = false;
      }, 200);
    }

    function onSearchFocus() {
      state.isSearching = true;
    }

    /* FULLSCREEN + SAFE AREAS (Telegram) */
    function updateViewportHeight() {
      const tg = window.Telegram?.WebApp;

      const vh = tg?.viewportStableHeight || window.innerHeight;

      const safeTop = tg?.safeAreaInset?.top ?? 0;
      const safeBottom = tg?.safeAreaInset?.bottom ?? 0;

      const contentTop = tg?.contentSafeAreaInset?.top ?? 0;
      const contentBottom = tg?.contentSafeAreaInset?.bottom ?? 0;

      document.documentElement.style.setProperty('--tg-viewport-stable-height', `${vh}px`);
      document.documentElement.style.setProperty('--tg-safe-area-inset-top', `${safeTop}px`);
      document.documentElement.style.setProperty('--tg-safe-area-inset-bottom', `${safeBottom}px`);
      document.documentElement.style.setProperty('--tg-content-safe-area-inset-top', `${contentTop}px`);
      document.documentElement.style.setProperty('--tg-content-safe-area-inset-bottom', `${contentBottom}px`);

      if (state.pickup && state.dropoff) queueFitAB();
    }

    function createDivMarker(html, className, size = [20, 20]) {
      const el = document.createElement('div');
      el.className = className;
      el.style.width = size[0] + 'px';
      el.style.height = size[1] + 'px';
      if (html) el.innerHTML = html;
      return el;
    }

    /* MAP OPTIMIZATION: preferCanvas + faster tile behavior */
    function createLeafletMap(containerId, center, zoom) {
      const m = L.map(containerId, {
        center,
        zoom,
        zoomControl:false,
        attributionControl:false,
        preferCanvas:true,
        inertia:true,
        worldCopyJump:true,
        updateWhenIdle:true,
        updateWhenZooming:false
      });

      L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        maxZoom: 19,
        detectRetina: true,
        crossOrigin: true,
        keepBuffer: 4,
        updateWhenIdle: true,
        updateWhenZooming: false
      }).addTo(m);

      return m;
    }

    function initMap() {
      const defaultCenter = [43.238949, 76.889709];

      map = createLeafletMap('map', defaultCenter, 15);

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            currentUserLocation = [pos.coords.latitude, pos.coords.longitude];

            if (!isInKazakhstan(currentUserLocation[0], currentUserLocation[1])) {
              addUserLocationMarker(defaultCenter);
              showToast('outside_kz');
              return;
            }

            state.userLoc = { lat: pos.coords.latitude, lng: pos.coords.longitude, accuracy: pos.coords.accuracy };
            map.setView(currentUserLocation, 15, { animate:false });
            addUserLocationMarker(currentUserLocation);
            setUserLocationAsPickup();

            startRealtimeTracking(); // 1s updates
          },
          () => {
            addUserLocationMarker(defaultCenter);
          },
          { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
        );
      } else {
        addUserLocationMarker(defaultCenter);
      }
    }

    async function setUserLocationAsPickup() {
      if (!currentUserLocation) return;
      if (!isInKazakhstan(currentUserLocation[0], currentUserLocation[1])) {
        showToast('outside_kz');
        return;
      }

      const addr = await reverseGeocode(currentUserLocation[0], currentUserLocation[1]);
      state.pickup = { lat: currentUserLocation[0], lng: currentUserLocation[1], address: addr };

      document.getElementById('pickupAddr').textContent = addr;
      document.querySelectorAll('.address-card')[0].classList.add('filled');
      await addMarker('pickup', currentUserLocation[0], currentUserLocation[1]);
      validateStep1();
    }

    /* REALTIME GEO: smooth + update every 1s, also updates picker user marker */
    function startRealtimeTracking() {
      if (!navigator.geolocation) return;

      // watchPosition is efficient; we still enforce a 1s "tick" to keep UI fresh
      geolocationWatchId = navigator.geolocation.watchPosition(
        (pos) => {
          lastGeoUpdateAt = Date.now();
          const c = [pos.coords.latitude, pos.coords.longitude];
          if (pos.coords.accuracy <= 800) {
            currentUserLocation = c;
            state.userLoc = { lat: c[0], lng: c[1], accuracy: pos.coords.accuracy };
            updateUserMarker(c[0], c[1]);
            updatePickerUserMarker(c[0], c[1]);
          }
        },
        () => {},
        { enableHighAccuracy:true, timeout:5000, maximumAge:0 }
      );

      // forced 1s tick (if watch is silent, request position)
      forceTickTimer = setInterval(() => {
        const silentTooLong = (Date.now() - lastGeoUpdateAt) > 1500;
        if (!silentTooLong) {
          // still update picker marker position if we have currentUserLocation
          if (currentUserLocation) updatePickerUserMarker(currentUserLocation[0], currentUserLocation[1]);
          return;
        }

        navigator.geolocation.getCurrentPosition(
          (pos) => {
            lastGeoUpdateAt = Date.now();
            const c = [pos.coords.latitude, pos.coords.longitude];
            if (pos.coords.accuracy <= 800) {
              currentUserLocation = c;
              state.userLoc = { lat: c[0], lng: c[1], accuracy: pos.coords.accuracy };
              updateUserMarker(c[0], c[1]);
              updatePickerUserMarker(c[0], c[1]);
            }
          },
          () => {},
          { enableHighAccuracy:true, timeout:1500, maximumAge:0 }
        );
      }, 1000);
    }

    function addUserLocationMarker(coords) {
      if (!map) return;
      const el = createDivMarker('', 'user-marker', [16, 16]);
      const icon = L.divIcon({ className:'', html: el, iconSize:[16,16] });
      userMarker = L.marker(coords, { icon, interactive:false }).addTo(map);
    }

    function updateUserMarker(lat, lng) {
      if (lastUserPosition &&
          Math.abs(lastUserPosition[0] - lat) < 0.00001 &&
          Math.abs(lastUserPosition[1] - lng) < 0.00001) return;

      lastUserPosition = [lat, lng];

      if (!userMarker && map) {
        addUserLocationMarker([lat, lng]);
        return;
      }
      if (!userMarker || !map) return;

      userMarker.setLatLng([lat, lng]);
    }

    function ensurePickerUserMarker() {
      if (!pickerMap) return;
      if (pickerUserMarker) return;

      const el = createDivMarker('', 'user-marker', [16, 16]);
      const icon = L.divIcon({ className:'', html: el, iconSize:[16,16] });
      const start = currentUserLocation || [43.238949, 76.889709];
      pickerUserMarker = L.marker(start, { icon, interactive:false }).addTo(pickerMap);
    }

    function updatePickerUserMarker(lat, lng) {
      if (!pickerMap) return;
      ensurePickerUserMarker();
      if (!pickerUserMarker) return;
      pickerUserMarker.setLatLng([lat, lng]);
    }

    function centerOnUserLocation() {
      if (!currentUserLocation || !map) return;
      map.setView(currentUserLocation, 16, { animate:true });
    }

    async function addMarker(type, lat, lng) {
      if (!map) return;

      const className = `custom-marker ${type === 'pickup' ? 'pickup' : 'dropoff'}`;
      const label = type === 'pickup' ? 'A' : 'B';
      const el = createDivMarker(label, className, [40, 40]);
      const icon = L.divIcon({ className:'', html: el, iconSize:[40,40], iconAnchor:[20,20] });

      const marker = L.marker([lat, lng], { icon, draggable:true }).addTo(map);

      marker.on('dragend', async (e) => {
        const ll = e.target.getLatLng();

        if (!isInKazakhstan(ll.lat, ll.lng)) {
          showToast('outside_kz');
          if (type === 'pickup' && state.pickup) marker.setLatLng([state.pickup.lat, state.pickup.lng]);
          else if (type === 'dropoff' && state.dropoff) marker.setLatLng([state.dropoff.lat, state.dropoff.lng]);
          return;
        }

        const addr = await reverseGeocode(ll.lat, ll.lng);

        if (type === 'pickup') {
          state.pickup = { lat: ll.lat, lng: ll.lng, address: addr };
          document.getElementById('pickupAddr').textContent = addr;
        } else {
          state.dropoff = { lat: ll.lat, lng: ll.lng, address: addr };
          document.getElementById('dropoffAddr').textContent = addr;
        }

        validateStep1();
        queueFitAB();
      });

      if (type === 'pickup') {
        if (pickupMarker) map.removeLayer(pickupMarker);
        pickupMarker = marker;
      } else {
        if (dropoffMarker) map.removeLayer(dropoffMarker);
        dropoffMarker = marker;
      }

      if (pickupMarker && dropoffMarker) setTimeout(() => autoZoomToBothPoints(true), 220);
    }

    function showDistance() {
      if (!state.pickup || !state.dropoff) return;
      const d = calculateDistance(state.pickup.lat, state.pickup.lng, state.dropoff.lat, state.dropoff.lng);
      document.getElementById('distanceText').textContent = `${d.toFixed(1)} –∫–º`;
      document.getElementById('distanceBadge').classList.add('active');
    }

    function calculateDistance(lat1, lng1, lat2, lng2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) ** 2 +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng / 2) ** 2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    async function openPicker(type) {
      state.pickingFor = type;
      state.isSearching = false;

      document.getElementById('pickerModal').classList.add('active');
      document.getElementById('centerPinOverlay').classList.add('active');

      let center;
      if (type === 'pickup' && state.pickup) center = [state.pickup.lat, state.pickup.lng];
      else if (type === 'dropoff' && state.dropoff) center = [state.dropoff.lat, state.dropoff.lng];
      else if (currentUserLocation) center = currentUserLocation;
      else center = [43.238949, 76.889709];

      await new Promise(r => setTimeout(r, 80));
      await buildPickerMap(center);

      // show live user marker on picker map immediately
      if (currentUserLocation) updatePickerUserMarker(currentUserLocation[0], currentUserLocation[1]);
    }

    function closePicker() {
      document.getElementById('pickerModal').classList.remove('active');
      document.getElementById('centerPinOverlay').classList.remove('active');
      document.getElementById('suggestions').classList.remove('active');
      document.getElementById('searchBox').value = '';

      if (pickerMap) {
        pickerMap.off('moveend');
        pickerMap.remove();
      }

      pickerMap = null;
      pickerUserMarker = null;
      state.pickingFor = null;
      state.isSearching = false;
      clearTimeout(pickerMoveTimeout);
    }

    async function buildPickerMap(center) {
      const el = document.getElementById('pickerMap');
      if (!el) return;
      el.innerHTML = '';

      pickerMap = createLeafletMap('pickerMap', center, 16);

      // update address on move (debounced)
      pickerMap.on('moveend', () => {
        clearTimeout(pickerMoveTimeout);
        pickerMoveTimeout = setTimeout(async () => {
          const c = pickerMap.getCenter();
          const addr = await reverseGeocode(c.lat, c.lng);
          document.getElementById('pinAddressBubble').textContent = addr;
        }, 260);
      });

      // initial address
      setTimeout(async () => {
        const c = pickerMap.getCenter();
        const addr = await reverseGeocode(c.lat, c.lng);
        document.getElementById('pinAddressBubble').textContent = addr;
      }, 350);

      // show user marker on picker
      ensurePickerUserMarker();
    }

    function centerPickerOnUser() {
      if (!currentUserLocation || !pickerMap) return;
      pickerMap.setView(currentUserLocation, 16, { animate:true });
    }

    async function confirmPicker() {
      if (!state.pickingFor || !pickerMap) return;

      const c = pickerMap.getCenter();
      const lat = c.lat;
      const lng = c.lng;

      if (!isInKazakhstan(lat, lng)) {
        showToast('outside_kz');
        return;
      }

      try {
        const addr = await reverseGeocode(lat, lng);

        if (state.pickingFor === 'pickup') {
          state.pickup = { lat, lng, address: addr };
          document.getElementById('pickupAddr').textContent = addr;
          document.querySelectorAll('.address-card')[0].classList.add('filled');
          await addMarker('pickup', lat, lng);
        } else {
          state.dropoff = { lat, lng, address: addr };
          document.getElementById('dropoffAddr').textContent = addr;
          document.querySelectorAll('.address-card')[1].classList.add('filled');
          await addMarker('dropoff', lat, lng);
        }

        closePicker();
        validateStep1();
      } catch (e) {
        console.error('Confirm picker failed:', e);
      }
    }

    function goToStep(step) {
      document.querySelectorAll('.form-step').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.step-bar').forEach(s => s.classList.remove('active'));
      document.getElementById(`step${step}`).classList.add('active');

      for (let i = 1; i <= step; i++) document.getElementById(`stepBar${i}`).classList.add('active');

      state.currentStep = step;
      if (step === 1) validateStep1();
      else if (step === 2) validateStep2();
      else validateStep3();

      if (state.pickup && state.dropoff) queueFitAB();
    }

    function validateStep1() {
      const valid = state.pickup && state.dropoff;
      document.getElementById('nextBtn1').disabled = !valid;
      if (valid) queueFitAB();
    }

    function validateStep2() {
      const price = Number(document.getElementById('price').value);
      const date = document.getElementById('date').value;
      const time = document.getElementById('time').value;
      const truckValid = !!state.selectedTruck;

      const priceValid = price >= 2000;
      const dateValid = !!date;
      const timeValid = !!time;

      document.getElementById('priceError').classList.toggle('show', !priceValid && price > 0);
      document.getElementById('dateError').classList.toggle('show', !dateValid);
      document.getElementById('timeError').classList.toggle('show', !timeValid);
      document.getElementById('truckError').classList.toggle('show', !truckValid);

      document.getElementById('price').classList.toggle('error', !priceValid && price > 0);
      document.getElementById('date').classList.toggle('error', !dateValid);
      document.getElementById('time').classList.toggle('error', !timeValid);

      const tooBig = currentPhotoFile && currentPhotoFile.size > 20 * 1024 * 1024;
      document.getElementById('photoError').classList.toggle('show', !!tooBig);

      const valid = priceValid && dateValid && timeValid && truckValid && !tooBig;
      document.getElementById('nextBtn2').disabled = !valid;
    }

    function validateStep3() {
      const phone = document.getElementById('phone').value;
      const comment = document.getElementById('comment').value;

      const phoneValid = phone.length >= 18;
      const commentValid = comment.trim().length >= 5;

      document.getElementById('phoneError').classList.toggle('show', !phoneValid && phone.length > 0);
      document.getElementById('commentError').classList.toggle('show', !commentValid && comment.length > 0);

      document.getElementById('phone').classList.toggle('error', !phoneValid && phone.length > 0);
      document.getElementById('comment').classList.toggle('error', !commentValid && comment.length > 0);

      document.getElementById('submitBtn').disabled = !(phoneValid && commentValid);
    }

    function selectTruck(evt, type) {
      evt.preventDefault();
      document.querySelectorAll('.truck-card').forEach(c => c.classList.remove('selected'));
      document.querySelector(`[data-truck="${type}"]`).classList.add('selected');
      state.selectedTruck = type;
      validateStep2();
    }

    function formatPhone(input) {
      let val = input.value.replace(/\D/g, '');
      if (!val) { input.value = ''; return; }
      if (val[0] !== '7') val = '7' + val;

      let fmt = '+7';
      if (val.length > 1) fmt += ` (${val.slice(1, 4)}`;
      if (val.length >= 4) fmt += ')';
      if (val.length > 4) fmt += ` ${val.slice(4, 7)}`;
      if (val.length > 7) fmt += `-${val.slice(7, 9)}`;
      if (val.length > 9) fmt += `-${val.slice(9, 11)}`;
      input.value = fmt;
    }

    const cargoPhotoInput = document.getElementById('cargoPhoto');
    const photoThumb = document.getElementById('photoThumb');
    let currentPhotoFile = null;

    function openSystemPicker() {
      cargoPhotoInput.click();
    }

    cargoPhotoInput.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      handleChosenFile(file);
    });

    function handleChosenFile(file) {
      currentPhotoFile = file || null;

      if (!file) {
        photoThumb.innerHTML = '<span style="font-size:22px">üñºÔ∏è</span>';
        document.getElementById('photoError').classList.remove('show');
        validateStep2();
        return;
      }

      if (file.size > 20 * 1024 * 1024) {
        document.getElementById('photoError').classList.add('show');
      } else {
        document.getElementById('photoError').classList.remove('show');
      }

      const reader = new FileReader();
      reader.onload = () => {
        photoThumb.innerHTML = `<img alt="preview" src="${reader.result}">`;
      };
      reader.readAsDataURL(file);
      validateStep2();
    }

    function clearCargoPhoto() {
      cargoPhotoInput.value = '';
      currentPhotoFile = null;
      photoThumb.innerHTML = '<span style="font-size:22px">üñºÔ∏è</span>';
      document.getElementById('photoError').classList.remove('show');
      validateStep2();
    }

    async function submitOrder() {
      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.textContent = '...';

      try {
        const formData = new FormData();

        formData.append('from_address', state.pickup.address);
        formData.append('from_lat', state.pickup.lat);
        formData.append('from_lon', state.pickup.lng);
        formData.append('to_address', state.dropoff.address);
        formData.append('to_lat', state.dropoff.lat);
        formData.append('to_lon', state.dropoff.lng);
        formData.append('price', document.getElementById('price').value);
        formData.append('truck_type', state.selectedTruck);
        formData.append('date', document.getElementById('date').value);
        formData.append('time', document.getElementById('time').value);
        formData.append('contact', document.getElementById('phone').value);
        formData.append('comment', document.getElementById('comment').value);

        const tg = window.Telegram?.WebApp;
        if (tg?.initDataUnsafe?.user) {
          formData.append('telegram_id', tg.initDataUnsafe.user.id);
          formData.append('telegram_username', tg.initDataUnsafe.user.username || '');
          formData.append('telegram_first_name', tg.initDataUnsafe.user.first_name || '');
          formData.append('telegram_last_name', tg.initDataUnsafe.user.last_name || '');
        }

        formData.append('distance', calculateDistance(state.pickup.lat, state.pickup.lng, state.dropoff.lat, state.dropoff.lng));

        if (currentPhotoFile) formData.append('cargo_photo', currentPhotoFile);

        const res = await fetch('/api/delivery-request', { method:'POST', body: formData });
        const json = await res.json().catch(() => ({ success:false }));

        if (json?.success) {
          state.orderData = {
            pickup: state.pickup,
            dropoff: state.dropoff,
            price: document.getElementById('price').value,
            truck_type: state.selectedTruck,
            contact: document.getElementById('phone').value,
            comment: document.getElementById('comment').value,
            request_id: json.data?.request_id
          };
          showSuccess();
          stopTracking();
        } else {
          throw new Error(json?.message || '“ö–∞—Ç–µ –æ—Ä—ã–Ω –∞–ª–¥—ã');
        }
      } catch (e) {
        alert(`“ö–∞—Ç–µ: ${e.message}`);
      } finally {
        btn.disabled = false;
        btn.textContent = '–ñ—ñ–±–µ—Ä—É';
      }
    }

    function showSuccess() {
      document.getElementById('successScreen').classList.add('active');
      setTimeout(() => goToDriverList(), 3000);
    }

    function goToDriverList() {
      const data = encodeURIComponent(JSON.stringify(state.orderData));
      window.location.href = `/driver-list?order=${data}&lang=${currentLang}`;
    }

    function goToMainClient() {
      window.location.href = '/main-client';
    }

    function stopTracking() {
      if (geolocationWatchId) navigator.geolocation.clearWatch(geolocationWatchId);
      geolocationWatchId = null;
      if (forceTickTimer) clearInterval(forceTickTimer);
      forceTickTimer = null;
    }

    let fitABScheduled = false;
    function queueFitAB() {
      if (fitABScheduled) return;
      fitABScheduled = true;
      requestAnimationFrame(() => {
        autoZoomToBothPoints(true);
        fitABScheduled = false;
      });
    }

    function getSafeInsets() {
      const safeTop = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--tg-top-inset')) || 0;
      const safeBottom = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--tg-bottom-inset')) || 0;
      return { safeTop, safeBottom };
    }

    function getBottomSheetHeight() {
      const sheet = document.getElementById('bottomSheet');
      return sheet ? sheet.offsetHeight : 0;
    }

    function autoZoomToBothPoints(withUIOffset = false) {
      if (!map || !state.pickup || !state.dropoff) return;

      const bounds = L.latLngBounds(
        [state.pickup.lat, state.pickup.lng],
        [state.dropoff.lat, state.dropoff.lng]
      );

      if (!withUIOffset) {
        map.fitBounds(bounds, { padding:[40,40] });
        showDistance();
        return;
      }

      const { safeTop, safeBottom } = getSafeInsets();
      const sheetH = getBottomSheetHeight();

      const topPad = 40 + safeTop;
      const bottomPad = 40 + sheetH + safeBottom;

      map.fitBounds(bounds, {
        paddingTopLeft: [40, topPad],
        paddingBottomRight: [40, bottomPad],
        animate: true
      });

      setTimeout(showDistance, 320);
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Telegram first (fullscreen + safe areas)
      if (window.Telegram?.WebApp) {
        const tg = Telegram.WebApp;
        tg.ready();
        tg.expand();
        tg.disableVerticalSwipes();
        tg.setHeaderColor('#000000');
        tg.onEvent('viewportChanged', updateViewportHeight);
      }

      updateViewportHeight();

      // Defer map init slightly to speed first paint
      const start = () => initMap();
      if ('requestIdleCallback' in window) requestIdleCallback(start, { timeout: 600 });
      else setTimeout(start, 80);

      const now = new Date();
      document.getElementById('date').valueAsDate = now;
      document.getElementById('time').value = now.toTimeString().slice(0, 5);
    });

    window.addEventListener('resize', updateViewportHeight);
    window.addEventListener('beforeunload', stopTracking);

    window.openPicker = openPicker;
    window.closePicker = closePicker;
    window.confirmPicker = confirmPicker;
    window.debouncedSearch = debouncedSearch;
    window.selectSuggestionFromElement = selectSuggestionFromElement;
    window.goToStep = goToStep;
    window.selectTruck = selectTruck;
    window.formatPhone = formatPhone;
    window.submitOrder = submitOrder;
    window.goToDriverList = goToDriverList;
    window.goToMainClient = goToMainClient;
    window.hideSuggestionsDelayed = hideSuggestionsDelayed;
    window.onSearchFocus = onSearchFocus;
    window.centerOnUserLocation = centerOnUserLocation;
    window.centerPickerOnUser = centerPickerOnUser;
    window.clearCargoPhoto = clearCargoPhoto;
    window.openSystemPicker = openSystemPicker;
  </script>
</body>
</html>

