<!-- delivery-opm.html (OPTIMIZED / SAME LOGIC + SAME UI) -->
<!DOCTYPE html>
<html lang="kz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-visual" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Alash Go - –ñ–µ—Ç–∫—ñ–∑—É</title>

  <!-- Faster connections -->
  <link rel="preconnect" href="https://telegram.org">
  <link rel="preconnect" href="https://nominatim.openstreetmap.org" crossorigin>
  <link rel="preconnect" href="https://a.basemaps.cartocdn.com" crossorigin>
  <link rel="preconnect" href="https://b.basemaps.cartocdn.com" crossorigin>
  <link rel="preconnect" href="https://c.basemaps.cartocdn.com" crossorigin>
  <link rel="preconnect" href="https://d.basemaps.cartocdn.com" crossorigin>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --primary:#111827; --primary-dark:#000000; --secondary:#0B63F6;
      --success:#00D395; --warning:#FFB800; --danger:#FF5C5C;
      --dark:#0F172A; --grey:#6B7280; --grey-light:#E5E7EB;
      --white:#FFFFFF; --bg:#F5F5F5; --radius:16px; --radius-lg:22px;
      --shadow:0 4px 24px rgba(15,23,42,.12); --shadow-lg:0 10px 40px rgba(15,23,42,.18);

      --tg-safe-area-inset-top: env(safe-area-inset-top, 0px);
      --tg-safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
      --tg-content-safe-area-inset-top: 0px;
      --tg-content-safe-area-inset-bottom: 0px;
      --tg-top-inset: calc(var(--tg-safe-area-inset-top) + var(--tg-content-safe-area-inset-top));
      --tg-bottom-inset: calc(var(--tg-safe-area-inset-bottom) + var(--tg-content-safe-area-inset-bottom));
      --tg-viewport-stable-height: 100vh;

      --sheet-max-height: min(520px, 64vh);
      --sheet-real-height: 360px;
      --sheet-pad-x: clamp(14px, 4vw, 18px);
      --sheet-pad-bottom: calc(var(--tg-bottom-inset) + 10px);
      --desktop-max: 560px;
      --desktop-gap: 16px;
      --picker-confirm-h: 54px;
    }

    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    html,body{height:100%;width:100%;}
    body{
      height: var(--tg-viewport-stable-height, 100vh);
      width:100%;
      overflow:hidden;
      font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display','Helvetica Neue',sans-serif;
      background:var(--bg);
      padding-top: calc(var(--tg-top-inset) + 12px);
      touch-action: manipulation;
    }

    #map,#pickerMap{position:fixed;inset:0;z-index:1;background:#f9fafb;}

    .back-to-main{
      position:fixed;top:calc(var(--tg-top-inset) + 12px);left:12px;
      width:48px;height:48px;background:#fff;border:none;border-radius:50%;
      box-shadow:var(--shadow-lg);cursor:pointer;z-index:1003;
      display:flex;align-items:center;justify-content:center;transition:transform .2s ease;
    }
    .back-to-main:active{transform:scale(.94);}
    .back-to-main svg{width:24px;height:24px;fill:var(--dark);}

    .geo-btn{
      position:fixed;right:12px;
      bottom: calc(var(--sheet-real-height) + var(--tg-bottom-inset) + 10px);
      width:56px;height:56px;background:#fff;border:none;border-radius:999px;
      box-shadow:var(--shadow-lg);cursor:pointer;z-index:1002;
      display:flex;align-items:center;justify-content:center;transition:transform .2s ease;
    }
    .geo-btn:active{transform:scale(.94);}
    .geo-btn svg{width:24px;height:24px;fill:var(--dark);}

    .bottom-sheet{
      position:fixed;bottom:0;left:0;right:0;background:#fff;
      border-radius:var(--radius-lg) var(--radius-lg) 0 0;
      box-shadow:var(--shadow-lg);z-index:1001;
      max-height: var(--sheet-max-height);
      display:flex;flex-direction:column;padding-bottom: var(--sheet-pad-bottom);
    }

    .sheet-header{padding:10px var(--sheet-pad-x) 6px;display:flex;flex-direction:column;align-items:center;flex-shrink:0;}
    .sheet-handle{width:44px;height:4px;background:var(--grey-light);border-radius:999px;margin-bottom:10px;}
    .step-progress{display:flex;gap:8px;width:100%;max-width:220px;padding-bottom:2px;}
    .step-bar{flex:1;height:3px;background:var(--grey-light);border-radius:999px;position:relative;overflow:hidden;}
    .step-bar.active::after{content:'';position:absolute;inset:0;background:var(--primary);animation:fillBar .35s ease;}
    @keyframes fillBar{from{transform:translateX(-100%)}to{transform:translateX(0)}}

    .sheet-content{overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;padding:0 var(--sheet-pad-x) 10px;}
    .form-step{display:none;animation:slideIn .28s ease;}
    .form-step.active{display:block;}
    @keyframes slideIn{from{opacity:0;transform:translateX(16px)}to{opacity:1;transform:translateX(0)}}

    .address-card{
      display:flex;align-items:center;gap:14px;padding:16px 14px;background:#F9FAFB;
      border-radius:var(--radius);margin-bottom:10px;cursor:pointer;transition:transform .18s ease;
      border:1px solid rgba(148,163,184,.35);position:relative;overflow:hidden;
    }
    .address-card:active{transform:scale(.985);}
    .address-card.filled{background:#EEF2FF;border-color:#4F46E5;box-shadow:0 10px 30px rgba(79,70,229,.22);}
    .location-icon{
      width:46px;height:46px;border-radius:999px;display:flex;align-items:center;justify-content:center;
      font-weight:800;font-size:18px;flex-shrink:0;color:#fff;
    }
    .location-icon.start{background:linear-gradient(135deg,#111827,#020617);}
    .location-icon.end{background:linear-gradient(135deg,#EF4444,#FB7185);}
    .location-text{flex:1;min-width:0;}
    .location-label{font-size:12px;color:var(--grey);font-weight:700;text-transform:uppercase;letter-spacing:.6px;margin-bottom:4px;}
    .location-value{font-size:15px;font-weight:600;color:var(--dark);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

    .distance-badge{
      display:none;align-items:center;gap:8px;padding:14px 14px;
      background:linear-gradient(135deg,#22C55E,#4ADE80);color:#fff;border-radius:var(--radius);
      margin:8px 0 14px;font-weight:700;box-shadow:0 10px 28px rgba(22,163,74,.35);
    }
    .distance-badge.active{display:flex;animation:slideDown .25s ease;}
    @keyframes slideDown{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}

    .form-title{font-size:20px;font-weight:800;color:var(--dark);margin:6px 0 16px;}
    .form-field{margin-bottom:14px;}
    .field-label{font-size:13px;font-weight:700;color:var(--grey);margin-bottom:8px;display:block;}

    .field-input{
      width:100%;padding:14px 14px;background:#F9FAFB;border:1px solid rgba(148,163,184,.5);
      border-radius:var(--radius);font-size:15px;font-weight:600;color:var(--dark);
      transition:all .18s ease;font-family:inherit;-webkit-appearance:none;appearance:none;display:block;min-height:52px;
    }
    .field-input:focus{outline:none;background:#fff;border-color:#4C6FFF;box-shadow:0 0 0 1px #4C6FFF33;}
    .field-input::placeholder{color:var(--grey);}
    .field-input.error{border-color:var(--danger);}
    textarea.field-input{min-height:92px;resize:none;}

    .truck-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:12px;}
    .truck-card{
      padding:14px 10px;background:#F9FAFB;border:1px solid rgba(148,163,184,.4);
      border-radius:var(--radius);text-align:center;cursor:pointer;position:relative;
      user-select:none;transition:transform .18s ease, box-shadow .18s ease, background .18s ease;
    }
    .truck-card:active{transform:scale(.97);}
    .truck-card.selected{background:#EEF2FF;border-color:#4F46E5;box-shadow:0 8px 26px rgba(79,70,229,.28);}
    .truck-card.selected::after{
      content:'‚úì';position:absolute;top:8px;right:8px;width:20px;height:20px;background:#4F46E5;color:#fff;
      border-radius:999px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;
    }
    .truck-icon{font-size:24px;margin-bottom:5px;}
    .truck-name{font-size:13px;font-weight:800;color:var(--dark);margin-bottom:2px;}
    .truck-desc{font-size:11px;color:var(--grey);}

    .photo-uploader{
      background:#F9FAFB;border:1px dashed rgba(148,163,184,.7);border-radius:var(--radius);
      padding:12px;display:flex;gap:12px;align-items:center;position:relative;
    }
    .photo-uploader.uploading{pointer-events:none;opacity:.6;}
    .photo-thumb{
      width:62px;height:62px;border-radius:14px;background:#fff;box-shadow:var(--shadow);
      overflow:hidden;display:flex;align-items:center;justify-content:center;flex-shrink:0;position:relative;
    }
    .photo-thumb img{width:100%;height:100%;object-fit:cover;}
    .photo-actions{display:flex;gap:8px;flex-wrap:wrap;}
    .uploader-note{font-size:12px;color:var(--grey);margin-top:6px;line-height:1.35;}

    .upload-progress{
      position:absolute;inset:0;background:rgba(0,0,0,0.7);border-radius:14px;display:none;
      align-items:center;justify-content:center;flex-direction:column;gap:8px;
    }
    .upload-progress.active{display:flex;}
    .upload-spinner{width:24px;height:24px;border:3px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg)}}
    .upload-text{color:#fff;font-size:10px;font-weight:700;}

    .datetime-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:start;}
    .datetime-grid .form-field{min-width:0;}

    .btn-group{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px;padding:6px 0;}
    .btn-group.double{grid-template-columns:1fr 1fr;}
    .btn{
      padding:16px 18px;border:none;border-radius:999px;font-size:15px;font-weight:800;cursor:pointer;
      transition:transform .18s ease, background .18s ease, box-shadow .18s ease, color .18s ease;
      position:relative;overflow:hidden;user-select:none;-webkit-appearance:none;appearance:none;
    }
    .btn::before{
      content:'';position:absolute;top:50%;left:50%;width:0;height:0;border-radius:50%;
      background:rgba(255,255,255,.3);transform:translate(-50%,-50%);transition:width .5s,height .5s;
    }
    .btn:active::before{width:260px;height:260px;}
    .btn-primary{background:linear-gradient(135deg,#111827,#020617);color:#fff;box-shadow:0 10px 34px rgba(15,23,42,.45);}
    .btn-primary:active{transform:scale(.97);}
    .btn-primary:disabled{background:#E5E7EB;color:#9CA3AF;box-shadow:none;cursor:not-allowed;}
    .btn-secondary{background:#F9FAFB;color:var(--dark);border:1px solid rgba(148,163,184,.7);}
    .btn-secondary:active{background:#E5E7EB;transform:scale(.97);}

    .error-message{font-size:12px;color:var(--danger);margin-top:4px;display:none;font-weight:700;}
    .error-message.show{display:block;}

    .success-screen{
      position:fixed;inset:0;background:radial-gradient(circle at top,#4ADE80,#22C55E 45%,#16A34A 80%);
      z-index:3000;display:none;align-items:center;justify-content:center;flex-direction:column;
      padding:40px 18px;text-align:center;
    }
    .success-screen.active{display:flex;animation:fadeIn .35s ease;}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .success-icon{
      width:116px;height:116px;background:rgba(22,163,74,.25);border-radius:999px;
      display:flex;align-items:center;justify-content:center;font-size:64px;margin-bottom:26px;
      box-shadow:0 16px 40px rgba(22,163,74,.55);animation:scaleIn .45s ease;
    }
    @keyframes scaleIn{from{transform:scale(0);opacity:0}to{transform:scale(1);opacity:1}}
    .success-title{font-size:26px;font-weight:900;color:#fff;margin-bottom:10px;}
    .success-message{font-size:15px;color:rgba(255,255,255,.92);margin-bottom:26px;line-height:1.6;}
    .success-btn{padding:14px 28px;background:#fff;color:#16A34A;border:none;border-radius:999px;font-size:15px;font-weight:900;cursor:pointer;box-shadow:0 8px 30px rgba(0,0,0,.25);}

    .picker-modal{position:fixed;inset:0;background:#fff;z-index:2000;display:none;}
    .picker-modal.active{display:block;}

    .picker-header{
      position:fixed;top:calc(var(--tg-top-inset) + 10px);left:12px;right:12px;z-index:2010;
      display:flex;gap:10px;pointer-events:auto;
    }
    .picker-back-btn{
      width:48px;height:48px;background:#fff;border:none;border-radius:999px;box-shadow:var(--shadow);
      display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;font-weight:900;
    }
    .picker-back-btn:active{transform:scale(.94);}
    .search-box{
      flex:1;background:#fff;border:none;border-radius:999px;padding:14px 16px;box-shadow:var(--shadow);
      font-size:15px;font-weight:700;min-height:48px;
    }
    .search-box:focus{outline:none;box-shadow:0 0 0 1px #4C6FFF33, var(--shadow);}

    .center-pin-overlay{position:fixed;inset:0;z-index:2005;pointer-events:none;display:none;}
    .center-pin-overlay.active{display:block;}
    .pin-container{position:absolute;left:50%;top:50%;transform:translate(-50%, -100%);display:flex;flex-direction:column;align-items:center;}
    .pin-address-bubble{
      background:rgba(0,0,0,0.92);color:#fff;padding:8px 14px;border-radius:12px;font-size:13px;font-weight:800;
      margin-bottom:10px;box-shadow:0 4px 20px rgba(0,0,0,.28);max-width:min(340px, 88vw);text-align:center;
      line-height:1.35;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .uber-pin{width:28px;height:44px;filter: drop-shadow(0 10px 18px rgba(0,0,0,.25));animation:pinBounce .55s ease-out;}
    @keyframes pinBounce{
      0%{transform:translateY(-14px) scale(.86);opacity:0;}
      70%{transform:translateY(0) scale(1.05);opacity:1;}
      100%{transform:translateY(0) scale(1);opacity:1;}
    }

    .picker-geo-btn{
      position:fixed;right:12px;bottom:calc(var(--tg-bottom-inset) + var(--picker-confirm-h) + 14px);
      width:56px;height:56px;background:#fff;border:none;border-radius:50%;box-shadow:var(--shadow-lg);
      cursor:pointer;z-index:2008;display:flex;align-items:center;justify-content:center;transition:transform .2s ease;
    }
    .picker-geo-btn:active{transform:scale(.94);}
    .picker-geo-btn svg{width:24px;height:24px;fill:var(--dark);}

    .confirm-btn{
      position:fixed;bottom:calc(var(--tg-bottom-inset) + 12px);left:12px;right:12px;z-index:2020;
      height:var(--picker-confirm-h);padding:0 18px;display:flex;align-items:center;justify-content:center;
    }

    .suggestions{
      position:fixed;top:calc(var(--tg-top-inset) + 70px);left:12px;right:12px;background:#fff;border-radius:var(--radius);
      box-shadow:var(--shadow-lg);max-height:45vh;overflow-y:auto;z-index:2012;display:none;
    }
    .suggestions.active{display:block;animation:slideDown .22s ease;}
    .suggestion-item{padding:10px 14px;border-bottom:1px solid var(--grey-light);cursor:pointer;transition:background .15s;font-size:14px;}
    .suggestion-item:last-child{border-bottom:none;}
    .suggestion-item:active{background:#F9FAFB;}
    .suggestion-title{font-weight:900;margin-bottom:2px;}
    .suggestion-sub{font-size:12px;color:var(--grey);font-weight:700;}

    .user-marker{width:16px;height:16px;background:#0B63F6;border:3px solid #fff;border-radius:999px;box-shadow:0 2px 10px rgba(37,99,235,.75);animation:pulse 2s infinite;}
    @keyframes pulse{0%,100%{box-shadow:0 2px 10px rgba(37,99,235,.7);}50%{box-shadow:0 2px 18px rgba(37,99,235,1);}}

    /* Marker fix: do NOT set transform on marker root */
    .custom-marker{
      width:40px;height:40px;border-radius:999px;display:flex;align-items:center;justify-content:center;
      font-weight:900;color:#fff;font-size:18px;line-height:1;border:3px solid #fff;
      box-shadow:0 10px 30px rgba(15,23,42,.65);-webkit-font-smoothing: antialiased;will-change: transform;
    }
    .custom-marker.pickup{background:linear-gradient(135deg,#020617,#111827);}
    .custom-marker.dropoff{background:linear-gradient(135deg,#EF4444,#F97316);}

    .leaflet-control-container{display:none;}

    .toast-notice{
      position:fixed;bottom:calc(var(--tg-bottom-inset) + 18px);left:50%;
      transform:translateX(-50%) translateY(12px);
      background:rgba(15,23,42,0.96);color:#fff;padding:10px 16px;border-radius:999px;
      font-size:13px;font-weight:800;box-shadow:0 10px 30px rgba(15,23,42,0.55);
      z-index:4000;opacity:0;pointer-events:none;display:flex;align-items:center;gap:8px;
      transition:opacity .22s ease, transform .22s ease;max-width:92vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .toast-notice svg{width:16px;height:16px;flex-shrink:0;}
    .toast-notice.show{opacity:1;pointer-events:auto;transform:translateX(-50%) translateY(-4px);}

    .submit-overlay{
      position:fixed;inset:0;z-index:5000;display:none;align-items:center;justify-content:center;padding:24px;
      background:rgba(0,0,0,.45);backdrop-filter: blur(6px);-webkit-backdrop-filter: blur(6px);
    }
    .submit-overlay.active{display:flex;}
    .submit-card{
      width:min(420px, 92vw);background:rgba(255,255,255,0.96);border-radius:22px;box-shadow:0 18px 60px rgba(0,0,0,.35);
      padding:18px 18px 16px;display:flex;align-items:center;gap:14px;
    }
    .logo-spinner{
      width:52px;height:52px;border-radius:16px;background:linear-gradient(135deg,#111827,#020617);
      display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;flex-shrink:0;
    }
    .logo-spinner::after{
      content:'';position:absolute;width:86px;height:86px;border:3px solid rgba(255,255,255,.28);
      border-top-color:#fff;border-radius:999px;animation:spin .9s linear infinite;
    }
    .logo-mark{position:relative;z-index:1;width:26px;height:26px;border-radius:10px;border:2px solid rgba(255,255,255,.9);opacity:.95;transform: rotate(12deg);}
    .submit-texts{min-width:0;}
    .submit-title{font-weight:900;color:#0f172a;font-size:16px;margin-bottom:4px;}
    .submit-sub{font-weight:700;color:#475569;font-size:13px;line-height:1.35;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:300px;}

    @media (max-height:700px){
      :root{ --sheet-max-height: min(480px, 62vh); }
      .truck-grid{grid-template-columns:repeat(3,1fr);gap:8px;}
      .truck-card{padding:12px 8px;}
    }
    @media (max-width:360px){ .truck-grid{grid-template-columns:repeat(2,1fr);} }

    @media (min-width: 900px){
      .bottom-sheet{
        left:50%;right:auto;width:min(var(--desktop-max), calc(100vw - 2*var(--desktop-gap)));
        transform: translateX(-50%);border-radius: var(--radius-lg);bottom: var(--desktop-gap);
        max-height: min(560px, 72vh);padding-bottom:14px;
      }
      .sheet-header{padding-top:12px;}
      .sheet-handle{display:none;}
      .geo-btn{
        right: calc(50% - (min(var(--desktop-max), calc(100vw - 2*var(--desktop-gap))) / 2) + 12px);
        bottom: calc(var(--sheet-real-height) + 10px);
      }
      .back-to-main{
        left: calc(50% - (min(var(--desktop-max), calc(100vw - 2*var(--desktop-gap))) / 2) + 12px);
      }
      .picker-header{left:50%;right:auto;transform:translateX(-50%);width:min(760px, calc(100vw - 24px));}
      .suggestions{left:50%;right:auto;transform:translateX(-50%);width:min(760px, calc(100vw - 24px));}
      .confirm-btn{left:50%;right:auto;transform:translateX(-50%);width:min(760px, calc(100vw - 24px));}
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <button class="back-to-main" type="button" onclick="goToMainClient()" aria-label="–ê—Ä—Ç“õ–∞">
    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
  </button>

  <button class="geo-btn" type="button" onclick="centerOnUserLocation()" id="geoBtn" aria-label="–ú–µ–Ω—ñ“£ –æ—Ä–Ω—ã–º–∞ —Ñ–æ–∫—É—Å">
    <svg viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3A8.994 8.994 0 0013 3.06V1h-2v2.06A8.994 8.994 0 003.06 11H1v2h2.06A8.994 8.994 0 0011 20.94V23h2v-2.06A8.994 8.994 0 0020.94 13H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>
  </button>

  <div class="success-screen" id="successScreen">
    <div class="success-icon">üéâ</div>
    <div class="success-title">–¢–∞–ø—Å—ã—Ä—ã—Å –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ!</div>
    <div class="success-message">“ö–æ–ª –∂–µ—Ç—ñ–º–¥—ñ –∂“Ø—Ä–≥—ñ–∑—É—à—ñ–ª–µ—Ä–¥—ñ —ñ–∑–¥–µ–ø –∂–∞—Ç—ã—Ä–º—ã–∑...<br/>–ë“±–ª –±—ñ—Ä–Ω–µ—à–µ —Å–µ–∫—É–Ω–¥“õ–∞ —Å–æ–∑—ã–ª–∞–¥—ã</div>
    <button class="success-btn" type="button" onclick="goToDriverList()">–ñ“Ø—Ä–≥—ñ–∑—É—à—ñ–ª–µ—Ä–¥—ñ –∫”©—Ä—É</button>
  </div>

  <div class="submit-overlay" id="submitOverlay" aria-hidden="true">
    <div class="submit-card">
      <div class="logo-spinner"><div class="logo-mark"></div></div>
      <div class="submit-texts">
        <div class="submit-title" id="submitOverlayTitle">–ñ—ñ–±–µ—Ä—ñ–ª—É–¥–µ...</div>
        <div class="submit-sub" id="submitOverlaySub">”®—Ç—ñ–Ω–µ–º—ñ–∑, –∫“Ø—Ç–µ —Ç“±—Ä—ã“£—ã–∑</div>
      </div>
    </div>
  </div>

  <div class="bottom-sheet" id="bottomSheet">
    <div class="sheet-header">
      <div class="sheet-handle"></div>
      <div class="step-progress">
        <div class="step-bar active" id="stepBar1"></div>
        <div class="step-bar" id="stepBar2"></div>
        <div class="step-bar" id="stepBar3"></div>
      </div>
    </div>

    <div class="sheet-content">
      <!-- STEP 1 -->
      <div class="form-step active" id="step1">
        <div class="address-card" onclick="openPicker('pickup')">
          <div class="location-icon start">A</div>
          <div class="location-text">
            <div class="location-label">“ö–ê–ô–î–ê–ù</div>
            <div class="location-value" id="pickupAddr">–û—Ä—ã–Ω–¥—ã –∞–Ω—ã“õ—Ç–∞—É...</div>
          </div>
        </div>

        <div class="address-card" onclick="openPicker('dropoff')">
          <div class="location-icon end">B</div>
          <div class="location-text">
            <div class="location-label">“ö–ê–ô–î–ê</div>
            <div class="location-value" id="dropoffAddr">–ë–∞—Ä–∞—Ç—ã–Ω –∂–µ—Ä–¥—ñ —Ç–∞“£–¥–∞“£—ã–∑</div>
          </div>
        </div>

        <div class="distance-badge" id="distanceBadge">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>
          <span id="distanceText"></span>
        </div>

        <div class="btn-group">
          <button class="btn btn-primary" id="nextBtn1" type="button" onclick="goToStep(2)" disabled>–ö–µ–ª–µ—Å—ñ</button>
        </div>
      </div>

      <!-- STEP 2 -->
      <div class="form-step" id="step2">
        <div class="form-title">–ñ–µ—Ç–∫—ñ–∑—É –º”ô–ª—ñ–º–µ—Ç—Ç–µ—Ä—ñ</div>

        <div class="form-field">
          <label class="field-label">üí∞ –ë–∞“ì–∞ (—Ç–µ“£–≥–µ)</label>
          <input type="number" class="field-input" id="price" placeholder="5000" min="2000" inputmode="numeric"
                 oninput="validateStep2(); syncSheetHeightSoon();" />
          <div class="error-message" id="priceError">–ú–∏–Ω–∏–º—É–º 2000 —Ç–µ“£–≥–µ</div>
        </div>

        <div class="form-field">
          <label class="field-label">üöö –ö”©–ª—ñ–∫ —Ç“Ø—Ä—ñ</label>
          <div class="truck-grid" id="truckGrid">
            <div class="truck-card" data-truck="intercity"><div class="truck-icon">üöï</div><div class="truck-name">“ö–∞–ª–∞ –∞—Ä–∞–ª—ã“õ</div><div class="truck-desc">—Ç–∞–∫—Å–∏</div></div>
            <div class="truck-card" data-truck="small"><div class="truck-icon">üöê</div><div class="truck-name">–ö—ñ—à—ñ</div><div class="truck-desc">1.5—Ç –¥–µ–π—ñ–Ω</div></div>
            <div class="truck-card" data-truck="medium"><div class="truck-icon">üöö</div><div class="truck-name">–û—Ä—Ç–∞—à–∞</div><div class="truck-desc">5—Ç –¥–µ–π—ñ–Ω</div></div>
            <div class="truck-card" data-truck="large"><div class="truck-icon">üöõ</div><div class="truck-name">“Æ–ª–∫–µ–Ω</div><div class="truck-desc">20—Ç –¥–µ–π—ñ–Ω</div></div>
            <div class="truck-card" data-truck="tow"><div class="truck-icon">üöó</div><div class="truck-name">–≠–≤–∞–∫—É–∞—Ç–æ—Ä</div><div class="truck-desc">—ç–≤–∞–∫—É–∞—Ü–∏—è</div></div>
            <div class="truck-card" data-truck="any"><div class="truck-icon">üöô</div><div class="truck-name">–ö–µ–∑ –∫–µ–ª–≥–µ–Ω</div><div class="truck-desc">–∂–∞—Ä–∞–π–¥—ã</div></div>
          </div>
          <div class="error-message" id="truckError">–ö”©–ª—ñ–∫ —Ç“Ø—Ä—ñ–Ω —Ç–∞“£–¥–∞“£—ã–∑</div>
        </div>

        <div class="form-field">
          <label class="field-label">üì∏ –ñ“Ø–∫—Ç—ñ“£ —Ñ–æ—Ç–æ—Å—ã <span style="font-weight:700;color:var(--grey)">(–º—ñ–Ω–¥–µ—Ç—Ç—ñ –µ–º–µ—Å)</span></label>
          <div class="photo-uploader" id="photoUploader">
            <div class="photo-thumb" id="photoThumb">
              <span style="font-size:22px">üñºÔ∏è</span>
              <div class="upload-progress" id="uploadProgress">
                <div class="upload-spinner"></div>
                <div class="upload-text">–ñ“Ø–∫—Ç–µ–ª—É–¥–µ...</div>
              </div>
            </div>
            <div style="flex:1">
              <input id="cargoPhoto" type="file" accept="image/*" style="display:none" />
              <div class="photo-actions">
                <button class="btn btn-secondary" type="button" onclick="openSystemPicker()">–§–æ—Ç–æ–Ω—ã –∂“Ø–∫—Ç–µ—É</button>
                <button class="btn btn-secondary" type="button" onclick="clearCargoPhoto()">–¢–∞–∑–∞–ª–∞—É</button>
              </div>
              <div class="uploader-note">5 –ú–ë-—Ç–∞–Ω –∞—Å–ø–∞—É –∫–µ—Ä–µ–∫. Telegram Desktop-—Ç–∞ HEIC –∫–µ–π–¥–µ –∞—à—ã–ª–º–∞–π–¥—ã ‚Äî JPG/PNG —Ç–∞“£–¥–∞“£—ã–∑.</div>
            </div>
          </div>
          <div class="error-message" id="photoError">–§–∞–π–ª —Ç—ã–º “Ø–ª–∫–µ–Ω (–º–∞–∫—Å. 5 –ú–ë)</div>
        </div>

        <div class="datetime-grid">
          <div class="form-field">
            <label class="field-label">üìÖ –ö“Ø–Ω—ñ</label>
            <input type="date" class="field-input" id="date" oninput="validateStep2(); syncSheetHeightSoon();" />
            <div class="error-message" id="dateError">–ö“Ø–Ω–¥—ñ —Ç–∞“£–¥–∞“£—ã–∑</div>
          </div>
          <div class="form-field">
            <label class="field-label">‚è∞ –£–∞“õ—ã—Ç—ã</label>
            <input type="time" class="field-input" id="time" oninput="validateStep2(); syncSheetHeightSoon();" />
            <div class="error-message" id="timeError">–£–∞“õ—ã—Ç—Ç—ã —Ç–∞“£–¥–∞“£—ã–∑</div>
          </div>
        </div>

        <div class="btn-group double">
          <button class="btn btn-secondary" type="button" onclick="goToStep(1)">–ê—Ä—Ç“õ–∞</button>
          <button class="btn btn-primary" id="nextBtn2" type="button" onclick="goToStep(3)" disabled>–ö–µ–ª–µ—Å—ñ</button>
        </div>
      </div>

      <!-- STEP 3 -->
      <div class="form-step" id="step3">
        <div class="form-title">–ë–∞–π–ª–∞–Ω—ã—Å –∞“õ–ø–∞—Ä–∞—Ç—ã</div>

        <div class="form-field">
          <label class="field-label">üì± –¢–µ–ª–µ—Ñ–æ–Ω</label>
          <input type="tel" class="field-input" id="phone" placeholder="+7 (___) ___-__-__"
                 inputmode="tel" oninput="formatPhone(this); validateStep3(); syncSheetHeightSoon();" />
          <div class="error-message" id="phoneError">–¢–æ–ª—ã“õ —Ç–µ–ª–µ—Ñ–æ–Ω –Ω”©–º—ñ—Ä—ñ–Ω –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑</div>
        </div>

        <div class="form-field">
          <label class="field-label">üí¨ –¢“Ø—Å—ñ–Ω—ñ–∫—Ç–µ–º–µ</label>
          <textarea class="field-input" id="comment" placeholder="“ö–æ—Å—ã–º—à–∞ –∞“õ–ø–∞—Ä–∞—Ç..." oninput="validateStep3(); syncSheetHeightSoon();"></textarea>
          <div class="error-message" id="commentError">–¢“Ø—Å—ñ–Ω—ñ–∫—Ç–µ–º–µ–Ω—ñ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑</div>
        </div>

        <div class="btn-group double">
          <button class="btn btn-secondary" type="button" onclick="goToStep(2)">–ê—Ä—Ç“õ–∞</button>
          <button class="btn btn-primary" id="submitBtn" type="button" onclick="submitOrder()" disabled>–ñ—ñ–±–µ—Ä—É</button>
        </div>
      </div>
    </div>
  </div>

  <!-- FULLSCREEN PICKER -->
  <div class="picker-modal" id="pickerModal">
    <div id="pickerMap"></div>

    <div class="center-pin-overlay" id="centerPinOverlay">
      <div class="pin-container">
        <div class="pin-address-bubble" id="pinAddressBubble">–ö–∞—Ä—Ç–∞–Ω—ã –∂—ã–ª–∂—ã—Ç—ã“£—ã–∑...</div>
        <svg class="uber-pin" viewBox="0 0 24 32" aria-hidden="true">
          <path d="M12 31s9-10.2 9-18A9 9 0 1 0 3 13c0 7.8 9 18 9 18z"
                fill="none" stroke="#000" stroke-width="1.8" stroke-linejoin="round"/>
          <circle cx="12" cy="13" r="4.1" fill="#000"/>
          <circle cx="12" cy="13" r="2.3" fill="#fff"/>
        </svg>
      </div>
    </div>

    <div class="picker-header">
      <button class="picker-back-btn" type="button" onclick="closePicker()">‚Üê</button>
      <input type="text" class="search-box" id="searchBox" placeholder="–ú–µ–∫–µ–Ω–∂–∞–π —ñ–∑–¥–µ—É..."
             oninput="debouncedSearch(this.value)" onfocus="onSearchFocus()" onblur="hideSuggestionsDelayed()" />
    </div>

    <button class="picker-geo-btn" type="button" onclick="centerPickerOnUser()" aria-label="–ú–µ–Ω—ñ“£ –æ—Ä–Ω—ã–º">
      <svg viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3A8.994 8.994 0 0013 3.06V1h-2v2.06A8.994 8.994 0 003.06 11H1v2h2.06A8.994 8.994 0 0011 20.94V23h2v-2.06A8.994 8.994 0 0020.94 13H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>
    </button>

    <div class="suggestions" id="suggestions"></div>
    <button class="btn btn-primary confirm-btn" type="button" onclick="confirmPicker()"><span>–û—Å—ã –Ω“Ø–∫—Ç–µ–Ω—ñ —Ç–∞“£–¥–∞—É</span></button>
  </div>

  <div class="toast-notice" id="toastNotice">
    <svg viewBox="0 0 24 24" fill="none">
      <circle cx="12" cy="12" r="10" stroke="white" stroke-width="1.5" opacity="0.8"></circle>
      <path d="M12 7V13" stroke="white" stroke-width="1.5" stroke-linecap="round"></path>
      <circle cx="12" cy="16" r="1" fill="white"></circle>
    </svg>
    <span id="toastText"></span>
  </div>

  <script>
    /* =========================
       OPTIMIZED CORE (SAME LOGIC)
    ========================= */
    const NOMINATIM_BASE = 'https://nominatim.openstreetmap.org';
    const API_URL = '/api/delivery-request';

    const $ = (id) => document.getElementById(id);
    const qs = (sel, root=document) => root.querySelector(sel);
    const qsa = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    const urlParams = new URLSearchParams(location.search);
    let currentLang = urlParams.get('lang') || localStorage.getItem('lang') || 'kz';
    localStorage.setItem('lang', currentLang);

    const t = (ru, kz) => currentLang === 'ru' ? ru : kz;
    const langHeader = () => currentLang === 'ru' ? 'ru-RU' : 'kk-KZ';
    const isInKazakhstan = (lat, lng) => lat >= 40 && lat <= 56 && lng >= 46 && lng <= 88;

    // Toast
    let toastTimer = null;
    function showToast(msg){
      $('toastText').textContent = msg;
      $('toastNotice').classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> $('toastNotice').classList.remove('show'), 2600);
    }

    // State
    const state = {
      userLoc:null,
      pickup:null,
      dropoff:null,
      pickingFor:null,
      currentStep:1,
      selectedTruck:null,
      orderData:null,
      isSearching:false
    };

    // Maps / markers
    let map, pickerMap, userMarker, pickupMarker, dropoffMarker, pickerUserMarker;
    let geolocationWatchId = null, geoTick = null, lastGeoUpdateAt = 0;
    let currentUserLocation = null, lastUserPosition = null;

    // UI helpers
    let sheetSyncTimer = null;
    const syncSheetHeight = () => {
      const bs = $('bottomSheet');
      const h = bs ? Math.max(220, Math.round((bs.getBoundingClientRect().height || 360))) : 360;
      document.documentElement.style.setProperty('--sheet-real-height', `${h}px`);
    };
    function syncSheetHeightSoon(){ clearTimeout(sheetSyncTimer); sheetSyncTimer = setTimeout(syncSheetHeight, 40); }

    function updateViewportHeight(){
      const tg = window.Telegram?.WebApp;
      const vh = tg?.viewportStableHeight || innerHeight;
      const safeTop = tg?.safeAreaInset?.top ?? 0;
      const safeBottom = tg?.safeAreaInset?.bottom ?? 0;
      const contentTop = tg?.contentSafeAreaInset?.top ?? 0;
      const contentBottom = tg?.contentSafeAreaInset?.bottom ?? 0;

      const root = document.documentElement.style;
      root.setProperty('--tg-viewport-stable-height', `${vh}px`);
      root.setProperty('--tg-safe-area-inset-top', `${safeTop}px`);
      root.setProperty('--tg-safe-area-inset-bottom', `${safeBottom}px`);
      root.setProperty('--tg-content-safe-area-inset-top', `${contentTop}px`);
      root.setProperty('--tg-content-safe-area-inset-bottom', `${contentBottom}px`);
      syncSheetHeightSoon();
    }

    function getSafeInsets(){
      const cs = getComputedStyle(document.documentElement);
      const safeTop = parseFloat(cs.getPropertyValue('--tg-top-inset')) || 0;
      const safeBottom = parseFloat(cs.getPropertyValue('--tg-bottom-inset')) || 0;
      return { safeTop, safeBottom };
    }

    function centerMarkerInVisibleArea(lat, lng, animate){
      if (!map) return;
      map.setView([lat,lng], Math.max(map.getZoom(), 15), { animate: !!animate });
      const sheetH = Math.max(220, Math.round(($('bottomSheet')?.getBoundingClientRect().height || 360)));
      if (sheetH > 0) map.panBy([0, Math.round(sheetH * 0.40)], { animate: !!animate, duration: 0.25 });
    }

    /* =========================
       GEOCODE CACHE + REVERSE
    ========================= */
    const geocodeCache = new Map();
    const CACHE_EXPIRY = 30*60*1000;
    const cacheGet = (k) => {
      const v = geocodeCache.get(k);
      if (v && Date.now() - v.ts < CACHE_EXPIRY) return v.val;
      geocodeCache.delete(k);
      return null;
    };
    const cacheSet = (k, val) => {
      geocodeCache.set(k, { val, ts: Date.now() });
      if (geocodeCache.size > 140) geocodeCache.delete(geocodeCache.keys().next().value);
    };

    let reverseAbort = null, lastReverseKey = '', lastReverseAt = 0;
    const abortReverse = () => { try{ reverseAbort?.abort(); }catch(e){} reverseAbort=null; };

    const formatFallbackAddress = (lat,lng) =>
      t(`–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${lat.toFixed(5)}¬∞, ${lng.toFixed(5)}¬∞`,
        `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—Ç–∞—Ä: ${lat.toFixed(5)}¬∞, ${lng.toFixed(5)}¬∞`);

    async function reverseGeocode(lat,lng){
      const key = `${lat.toFixed(6)},${lng.toFixed(6)}`;
      const cached = cacheGet(key);
      if (cached) return cached;

      const now = Date.now();
      if (key === lastReverseKey && (now - lastReverseAt) < 800) {
        const cached2 = cacheGet(key);
        if (cached2) return cached2;
      }
      lastReverseKey = key; lastReverseAt = now;

      abortReverse();
      reverseAbort = new AbortController();

      try{
        const url = `${NOMINATIM_BASE}/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=${encodeURIComponent(langHeader())}`;
        const res = await fetch(url, { cache:'force-cache', signal: reverseAbort.signal, headers:{'Accept':'application/json'} });
        const data = await res.json();

        if (data?.address?.country_code && String(data.address.country_code).toLowerCase() !== 'kz') {
          const fb = formatFallbackAddress(lat,lng);
          cacheSet(key, fb);
          return fb;
        }

        const a = data.address || {};
        const city = a.city || a.town || a.village || a.county || '';
        const street = a.road || a.neighbourhood || '';
        const num = a.house_number || '';

        let out = '';
        if (city && street && num) out = `${city}, ${street}: ${num}`;
        else if (city && street) out = `${city}, ${street}`;
        else if (street && num) out = `${street}: ${num}`;
        else if (city) out = city;
        else if (street) out = street;
        else if (data.display_name) out = String(data.display_name).split(',').map(s=>s.trim()).slice(0,3).join(', ');
        else out = formatFallbackAddress(lat,lng);

        cacheSet(key, out);
        return out;
      } catch(e){
        if (e?.name === 'AbortError') return null;
        const fb = formatFallbackAddress(lat,lng);
        cacheSet(key, fb);
        return fb;
      } finally {
        reverseAbort = null;
      }
    }

    /* =========================
       MAPS (FAST + STABLE)
    ========================= */
    const TILE_URL = 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png';
    const TILE_OPTS = {
      subdomains:'abcd', maxZoom:19, detectRetina:true, crossOrigin:true,
      keepBuffer:4, updateWhenIdle:true, updateWhenZooming:false,
      bounds: L.latLngBounds(L.latLng(-85,-180), L.latLng(85,180))
    };

    const iconUser = () => L.divIcon({ className:'', html:'<div class="user-marker"></div>', iconSize:[16,16], iconAnchor:[8,8] });
    const iconPoint = (type) => {
      const cls = type === 'pickup' ? 'custom-marker pickup' : 'custom-marker dropoff';
      const label = type === 'pickup' ? 'A' : 'B';
      return L.divIcon({ className:'', html:`<div class="${cls}">${label}</div>`, iconSize:[40,40], iconAnchor:[20,20] });
    };

    function createLeafletMap(containerId, center, zoom){
      const m = L.map(containerId, {
        center, zoom,
        zoomControl:false, attributionControl:false,
        preferCanvas:true, inertia:true, worldCopyJump:true,
        updateWhenIdle:true, updateWhenZooming:false,
        fadeAnimation:true, zoomAnimation:true,
        markerZoomAnimation:true,
        doubleClickZoom:true
      });
      L.tileLayer(TILE_URL, TILE_OPTS).addTo(m);
      setTimeout(() => { try{ m.invalidateSize(false); }catch(e){} }, 60);
      return m;
    }

    function updateUserMarker(lat,lng){
      if (lastUserPosition &&
          Math.abs(lastUserPosition[0]-lat) < 0.00001 &&
          Math.abs(lastUserPosition[1]-lng) < 0.00001) return;
      lastUserPosition = [lat,lng];
      if (!map) return;
      if (!userMarker) userMarker = L.marker([lat,lng], { icon: iconUser(), interactive:false, keyboard:false }).addTo(map);
      else userMarker.setLatLng([lat,lng]);
    }

    function ensurePickerUserMarker(){
      if (!pickerMap || pickerUserMarker) return;
      const start = currentUserLocation || [43.238949, 76.889709];
      pickerUserMarker = L.marker(start, { icon: iconUser(), interactive:false, keyboard:false }).addTo(pickerMap);
    }

    function updatePickerUserMarker(lat,lng){
      if (!pickerMap) return;
      ensurePickerUserMarker();
      pickerUserMarker?.setLatLng([lat,lng]);
    }

    function startRealtimeTracking(){
      if (!navigator.geolocation) return;

      geolocationWatchId = navigator.geolocation.watchPosition(
        (pos)=>{
          lastGeoUpdateAt = Date.now();
          const { latitude:lat, longitude:lng, accuracy } = pos.coords;
          if (accuracy > 1500) return;
          if (!isInKazakhstan(lat,lng)) return;

          currentUserLocation = [lat,lng];
          state.userLoc = { lat, lng, accuracy };

          updateUserMarker(lat,lng);
          updatePickerUserMarker(lat,lng);
        },
        ()=>{},
        { enableHighAccuracy:true, timeout:5000, maximumAge:1000 }
      );

      geoTick = setInterval(()=>{
        if ((Date.now() - lastGeoUpdateAt) <= 1800) return;
        navigator.geolocation.getCurrentPosition(
          (pos)=>{
            lastGeoUpdateAt = Date.now();
            const { latitude:lat, longitude:lng, accuracy } = pos.coords;
            if (accuracy > 1500) return;
            if (!isInKazakhstan(lat,lng)) return;

            currentUserLocation = [lat,lng];
            state.userLoc = { lat, lng, accuracy };

            updateUserMarker(lat,lng);
            updatePickerUserMarker(lat,lng);
          },
          ()=>{},
          { enableHighAccuracy:true, timeout:1500, maximumAge:0 }
        );
      }, 1000);
    }

    function stopTracking(){
      if (geolocationWatchId) navigator.geolocation.clearWatch(geolocationWatchId);
      geolocationWatchId = null;
      if (geoTick) clearInterval(geoTick);
      geoTick = null;
    }

    /* =========================
       DISTANCE + FIT
    ========================= */
    function calculateDistance(lat1,lng1,lat2,lng2){
      const R=6371, dLat=(lat2-lat1)*Math.PI/180, dLng=(lng2-lng1)*Math.PI/180;
      const a = Math.sin(dLat/2)**2 +
        Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)**2;
      return R*2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function showDistance(){
      if (!state.pickup || !state.dropoff) return;
      const d = calculateDistance(state.pickup.lat, state.pickup.lng, state.dropoff.lat, state.dropoff.lng);
      $('distanceText').textContent = `${d.toFixed(1)} –∫–º`;
      $('distanceBadge').classList.add('active');
      syncSheetHeightSoon();
    }

    let fitABScheduled = false;
    function queueFitAB(){
      if (fitABScheduled) return;
      fitABScheduled = true;
      requestAnimationFrame(()=>{ autoZoomToBothPoints(true); fitABScheduled=false; });
    }

    function autoZoomToBothPoints(withUIOffset=false){
      if (!map || !state.pickup || !state.dropoff) return;

      const bounds = L.latLngBounds([state.pickup.lat, state.pickup.lng],[state.dropoff.lat, state.dropoff.lng]);

      if (!withUIOffset){
        map.fitBounds(bounds, { padding:[40,40] });
        showDistance();
        return;
      }

      const { safeTop, safeBottom } = getSafeInsets();
      const sheetH = Math.max(220, Math.round(($('bottomSheet')?.getBoundingClientRect().height || 360)));

      map.fitBounds(bounds, {
        paddingTopLeft:[32, 36 + safeTop],
        paddingBottomRight:[32, 28 + sheetH + safeBottom],
        animate:true
      });
      setTimeout(showDistance, 220);
    }

    /* =========================
       A/B MARKERS (DRAG REVERSE)
    ========================= */
    async function upsertPointMarker(type, lat, lng, draggable){
      if (!map) return;

      const icon = iconPoint(type);
      const opts = { icon, draggable:!!draggable, keyboard:false, autoPan:true, autoPanPadding:[40,40] };
      let ref = type === 'pickup' ? pickupMarker : dropoffMarker;

      if (!ref) ref = L.marker([lat,lng], opts).addTo(map);
      else {
        ref.setIcon(icon);
        ref.setLatLng([lat,lng]);
        ref.dragging?.enable();
        if (!draggable) ref.dragging?.disable();
      }

      ref.off('dragend');
      ref.on('dragend', async (e)=>{
        const ll = e.target.getLatLng();
        if (!isInKazakhstan(ll.lat, ll.lng)){
          showToast(t('–°–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞','–°–µ—Ä–≤–∏—Å —Ç–µ–∫ “ö–∞–∑–∞“õ—Å—Ç–∞–Ω –∞—É–º–∞“ì—ã–Ω–¥–∞ –∂“±–º—ã—Å —ñ—Å—Ç–µ–π–¥—ñ'));
          const prev = type === 'pickup' ? state.pickup : state.dropoff;
          if (prev) ref.setLatLng([prev.lat, prev.lng]);
          return;
        }

        const addr = await reverseGeocode(ll.lat, ll.lng);
        if (!addr) return;

        if (type === 'pickup'){
          state.pickup = { lat: ll.lat, lng: ll.lng, address: addr };
          $('pickupAddr').textContent = addr;
          if (!state.dropoff) centerMarkerInVisibleArea(ll.lat, ll.lng, true);
        } else {
          state.dropoff = { lat: ll.lat, lng: ll.lng, address: addr };
          $('dropoffAddr').textContent = addr;
        }

        validateStep1();
        queueFitAB();
        syncSheetHeightSoon();
      });

      if (type === 'pickup') pickupMarker = ref; else dropoffMarker = ref;
      if (pickupMarker && dropoffMarker) setTimeout(()=> autoZoomToBothPoints(true), 200);
    }

    function centerOnUserLocation(){ if (currentUserLocation && map) map.setView(currentUserLocation, 16, { animate:true }); }
    function centerPickerOnUser(){ if (currentUserLocation && pickerMap) pickerMap.setView(currentUserLocation, 16, { animate:true }); }

    /* =========================
       SEARCH (NOMINATIM)
    ========================= */
    const escapeHtml = (s) => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    let searchDebounceTimer = null, suggestionsTimeout = null;

    function debouncedSearch(query){
      clearTimeout(searchDebounceTimer);
      searchDebounceTimer = setTimeout(()=> searchAddress(query), 280);
    }

    async function performKazakhstanSearch(query){
      const center = pickerMap?.getCenter() || { lat:43.238949, lng:76.889709 };

      const params = new URLSearchParams({
        format:'json', q:query, countrycodes:'kz', limit:'20',
        addressdetails:'1', 'accept-language': langHeader(),
        dedupe:'1'
      });

      const res = await fetch(`${NOMINATIM_BASE}/search?${params}`, { cache:'no-store', headers:{'Accept':'application/json'} });
      const raw = await res.json();
      if (!raw?.length) return [];

      const processed = raw.map(r=>{
        const a = r.address || {};
        let title = (a.house_number && a.road) ? `${a.road}: ${a.house_number}` :
                    (a.road ? a.road : (r.name ? r.name : ((r.display_name||'').split(',')[0] || '...')));
        const city = a.city || a.town || a.village || '';
        const st = a.state || '';
        const subtitle = (city && st && city !== st) ? `${city}, ${st}` : (city || st || '');

        const dist = calculateDistance(center.lat, center.lng, +r.lat, +r.lon);
        const typeScore = ({ city:1, town:2, village:3, suburb:4, neighbourhood:5, residential:6, amenity:7, building:8, street:9 }[r.type] || 10);
        const score = dist + (typeScore * 5);

        return { lat:+r.lat, lon:+r.lon, title, subtitle, score, importance:r.importance || 0 };
      });

      processed.sort((a,b)=>{
        const d=a.score-b.score;
        if (Math.abs(d) > 0.1) return d;
        return b.importance-a.importance;
      });

      return processed.slice(0,15);
    }

    async function searchAddress(query){
      const s = $('suggestions');
      if (!query || query.length < 2) { s.classList.remove('active'); return; }

      state.isSearching = true;
      s.innerHTML = `<div class="suggestion-item"><div class="suggestion-title">${t('–ü–æ–∏—Å–∫‚Ä¶','–Ü–∑–¥–µ—É‚Ä¶')}</div></div>`;
      s.classList.add('active');

      try{
        const results = await performKazakhstanSearch(query);
        if (!results.length){
          s.innerHTML = `<div class="suggestion-item"><div class="suggestion-title">${t('–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ','–ï—à—Ç–µ“£–µ —Ç–∞–±—ã–ª–º–∞–¥—ã')}</div></div>`;
          return;
        }

        s.innerHTML = results.map(r=>`
          <div class="suggestion-item" data-lat="${r.lat}" data-lng="${r.lon}" data-label="${escapeHtml(r.title)}"
               onclick="selectSuggestionFromElement(this)">
            <div class="suggestion-title">${escapeHtml(r.title)}</div>
            <div class="suggestion-sub">${escapeHtml(r.subtitle)}</div>
          </div>
        `).join('');
        s.classList.add('active');
      } catch(e){
        s.innerHTML = `<div class="suggestion-item"><div class="suggestion-title">${t('–û—à–∏–±–∫–∞','“ö–∞—Ç–µ')}</div></div>`;
      } finally {
        state.isSearching = false;
      }
    }

    function selectSuggestionFromElement(el){
      const lat = parseFloat(el.dataset.lat), lng = parseFloat(el.dataset.lng);
      if (!isInKazakhstan(lat,lng)){
        showToast(t('–°–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞','–°–µ—Ä–≤–∏—Å —Ç–µ–∫ “ö–∞–∑–∞“õ—Å—Ç–∞–Ω –∞—É–º–∞“ì—ã–Ω–¥–∞ –∂“±–º—ã—Å —ñ—Å—Ç–µ–π–¥—ñ'));
        return;
      }
      const label = el.dataset.label || '';
      pickerMap?.setView([lat,lng], 17, { animate:true });
      $('suggestions').classList.remove('active');
      $('searchBox').value = label;
      state.isSearching = false;
    }

    function hideSuggestionsDelayed(){
      clearTimeout(suggestionsTimeout);
      suggestionsTimeout = setTimeout(()=>{ $('suggestions').classList.remove('active'); state.isSearching=false; }, 200);
    }
    function onSearchFocus(){ state.isSearching=true; }

    /* =========================
       PICKER (CENTER PIN)
    ========================= */
    let pickerMoveTimer = null, pickerIsMoving = false, lastBubbleText = '', lastPickerCenterKey = '';
    const setBubble = (txt) => { if (txt !== lastBubbleText){ lastBubbleText=txt; $('pinAddressBubble').textContent=txt; } };

    function schedulePickerReverse(){
      if (!pickerMap) return;
      clearTimeout(pickerMoveTimer);
      if (state.isSearching) return;

      pickerMoveTimer = setTimeout(async ()=>{
        if (!pickerMap || pickerIsMoving) return;
        const c = pickerMap.getCenter();
        const key = `${c.lat.toFixed(6)},${c.lng.toFixed(6)}`;
        if (key === lastPickerCenterKey) return;
        lastPickerCenterKey = key;

        const addr = await reverseGeocode(c.lat, c.lng);
        if (addr) setBubble(addr);
      }, 320);
    }

    async function buildPickerMap(center){
      const el = $('pickerMap');
      if (!el) return;
      el.innerHTML = '';

      pickerMap = createLeafletMap('pickerMap', center, 16);

      pickerMap.on('movestart', ()=>{
        pickerIsMoving = true;
        abortReverse();
        clearTimeout(pickerMoveTimer);
        setBubble(t('–î–≤–∏–≥–∞–π—Ç–µ –∫–∞—Ä—Ç—É‚Ä¶','–ö–∞—Ä—Ç–∞–Ω—ã –∂—ã–ª–∂—ã—Ç—ã“£—ã–∑‚Ä¶'));
      });

      pickerMap.on('moveend', ()=>{
        pickerIsMoving = false;
        schedulePickerReverse();
      });

      setBubble(t('–û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–¥—Ä–µ—Å‚Ä¶','–ú–µ–∫–µ–Ω–∂–∞–π –∞–Ω—ã“õ—Ç–∞–ª—É–¥–∞‚Ä¶'));
      setTimeout(()=>{ if (!pickerMap) return; pickerIsMoving=false; schedulePickerReverse(); }, 220);

      ensurePickerUserMarker();
    }

    async function openPicker(type){
      state.pickingFor = type;
      state.isSearching = false;

      $('pickerModal').classList.add('active');
      $('centerPinOverlay').classList.add('active');

      let center;
      if (type === 'pickup' && state.pickup) center = [state.pickup.lat, state.pickup.lng];
      else if (type === 'dropoff' && state.dropoff) center = [state.dropoff.lat, state.dropoff.lng];
      else center = currentUserLocation || [43.238949, 76.889709];

      await new Promise(r=>setTimeout(r, 60));
      await buildPickerMap(center);
      if (currentUserLocation) updatePickerUserMarker(currentUserLocation[0], currentUserLocation[1]);
    }

    function closePicker(){
      $('pickerModal').classList.remove('active');
      $('centerPinOverlay').classList.remove('active');
      $('suggestions').classList.remove('active');
      $('searchBox').value = '';

      abortReverse();
      clearTimeout(pickerMoveTimer);

      if (pickerMap){ pickerMap.off(); pickerMap.remove(); }
      pickerMap = null; pickerUserMarker = null;
      state.pickingFor = null; state.isSearching=false;
      pickerIsMoving=false; lastPickerCenterKey=''; lastBubbleText='';
    }

    async function confirmPicker(){
      if (!state.pickingFor || !pickerMap) return;
      const c = pickerMap.getCenter();
      const lat = c.lat, lng = c.lng;

      if (!isInKazakhstan(lat,lng)){
        showToast(t('–°–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞','–°–µ—Ä–≤–∏—Å —Ç–µ–∫ “ö–∞–∑–∞“õ—Å—Ç–∞–Ω –∞—É–º–∞“ì—ã–Ω–¥–∞ –∂“±–º—ã—Å —ñ—Å—Ç–µ–π–¥—ñ'));
        return;
      }

      const addr = await reverseGeocode(lat,lng);
      if (!addr){ showToast(t('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞–¥—Ä–µ—Å','–ú–µ–∫–µ–Ω–∂–∞–π –∞–Ω—ã“õ—Ç–∞–ª–º–∞–¥—ã')); return; }

      if (state.pickingFor === 'pickup'){
        state.pickup = { lat,lng,address:addr };
        $('pickupAddr').textContent = addr;
        qsa('.address-card')[0].classList.add('filled');
        await upsertPointMarker('pickup', lat, lng, true);
      } else {
        state.dropoff = { lat,lng,address:addr };
        $('dropoffAddr').textContent = addr;
        qsa('.address-card')[1].classList.add('filled');
        await upsertPointMarker('dropoff', lat, lng, true);
      }

      closePicker();
      validateStep1();

      if (state.pickup && !state.dropoff) centerMarkerInVisibleArea(state.pickup.lat, state.pickup.lng, true);
      if (state.pickup && state.dropoff) queueFitAB();

      syncSheetHeightSoon();
    }

    /* =========================
       STEPS / VALIDATION
    ========================= */
    function goToStep(step){
      qsa('.form-step').forEach(s=>s.classList.remove('active'));
      qsa('.step-bar').forEach(s=>s.classList.remove('active'));

      $(`step${step}`).classList.add('active');
      for (let i=1;i<=step;i++) $(`stepBar${i}`).classList.add('active');

      state.currentStep = step;

      if (step===1) validateStep1();
      else if (step===2) validateStep2();
      else validateStep3();

      if (state.pickup && state.dropoff) queueFitAB();
      if (state.pickup && !state.dropoff) centerMarkerInVisibleArea(state.pickup.lat, state.pickup.lng, false);

      syncSheetHeightSoon();
    }

    function validateStep1(){
      const ok = !!(state.pickup && state.dropoff);
      $('nextBtn1').disabled = !ok;
      if (ok) queueFitAB();
      syncSheetHeightSoon();
    }

    function validateStep2(){
      const price = Number($('price').value);
      const date = $('date').value;
      const time = $('time').value;
      const truckOk = !!state.selectedTruck;

      const priceOk = price >= 2000;
      const dateOk = !!date;
      const timeOk = !!time;

      $('priceError').classList.toggle('show', !priceOk && price > 0);
      $('dateError').classList.toggle('show', !dateOk);
      $('timeError').classList.toggle('show', !timeOk);
      $('truckError').classList.toggle('show', !truckOk);

      $('price').classList.toggle('error', !priceOk && price > 0);
      $('date').classList.toggle('error', !dateOk);
      $('time').classList.toggle('error', !timeOk);

      const tooBig = currentPhotoFile && currentPhotoFile.size > 5*1024*1024;
      $('photoError').classList.toggle('show', !!tooBig);

      $('nextBtn2').disabled = !(priceOk && dateOk && timeOk && truckOk && !tooBig);
      syncSheetHeightSoon();
    }

    function validateStep3(){
      const phone = $('phone').value;
      const comment = $('comment').value;

      const digits = phone.replace(/\D/g,'');
      const phoneOk = digits.length >= 11;
      const commentOk = comment.trim().length >= 3;

      $('phoneError').classList.toggle('show', !phoneOk && phone.length > 0);
      $('commentError').classList.toggle('show', !commentOk && comment.length > 0);

      $('phone').classList.toggle('error', !phoneOk && phone.length > 0);
      $('comment').classList.toggle('error', !commentOk && comment.length > 0);

      $('submitBtn').disabled = !(phoneOk && commentOk);
      syncSheetHeightSoon();
    }

    function formatPhone(input){
      let val = input.value.replace(/\D/g,'');
      if (!val){ input.value=''; return; }
      if (val[0] !== '7') val = '7' + val;

      let fmt = '+7';
      if (val.length > 1) fmt += ` (${val.slice(1,4)}`;
      if (val.length >= 4) fmt += ')';
      if (val.length > 4) fmt += ` ${val.slice(4,7)}`;
      if (val.length > 7) fmt += `-${val.slice(7,9)}`;
      if (val.length > 9) fmt += `-${val.slice(9,11)}`;
      input.value = fmt;
    }

    // Truck: event delegation (less code, same UX)
    $('truckGrid').addEventListener('click', (e)=>{
      const card = e.target.closest('.truck-card');
      if (!card) return;
      qsa('.truck-card').forEach(c=>c.classList.remove('selected'));
      card.classList.add('selected');
      state.selectedTruck = card.dataset.truck;
      validateStep2();
      syncSheetHeightSoon();
    });

    /* =========================
       PHOTO (DESKTOP FIX)
    ========================= */
    const cargoPhotoInput = $('cargoPhoto');
    const photoThumb = $('photoThumb');
    const uploadProgress = $('uploadProgress');
    const photoUploader = $('photoUploader');
    let currentPhotoFile = null;

    function openSystemPicker(){ cargoPhotoInput.click(); }
    const isHeicLike = (f) => {
      const n = (f?.name||'').toLowerCase();
      const tp = (f?.type||'').toLowerCase();
      return tp.includes('heic') || tp.includes('heif') || n.endsWith('.heic') || n.endsWith('.heif');
    };

    function compressImageToJpeg(file){
      return new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.onerror = ()=>reject(new Error('File read error'));
        reader.onload = (e)=>{
          const img = new Image();
          img.onerror = ()=>reject(new Error('Image decode error'));
          img.onload = ()=>{
            const canvas = document.createElement('canvas');
            let w = img.width, h = img.height;
            const MAX = 1920;
            if (w > h && w > MAX){ h = (h*MAX)/w; w = MAX; }
            else if (h > MAX){ w = (w*MAX)/h; h = MAX; }

            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d', { alpha:false });
            ctx.drawImage(img, 0, 0, w, h);

            canvas.toBlob((blob)=>{
              if (!blob) return reject(new Error('toBlob failed'));
              const base = (file.name || 'photo').replace(/\.(png|jpg|jpeg|webp|heic|heif)$/i,'');
              resolve(new File([blob], `${base}.jpg`, { type:'image/jpeg', lastModified: Date.now() }));
            }, 'image/jpeg', 0.85);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    async function handleChosenFile(file){
      const pe = $('photoError');

      const reset = () => {
        currentPhotoFile=null;
        cargoPhotoInput.value='';
        photoThumb.innerHTML = '<span style="font-size:22px">üñºÔ∏è</span>';
      };

      if (!file){ reset(); pe.classList.remove('show'); validateStep2(); return; }
      if (!file.type || !file.type.startsWith('image/')){
        reset();
        pe.classList.add('show');
        pe.textContent = t('–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–ª—å–∫–æ —Ñ–æ—Ç–æ','–¢–µ–∫ —Ñ–æ—Ç–æ –∂“Ø–∫—Ç–µ—É–≥–µ –±–æ–ª–∞–¥—ã');
        showToast(pe.textContent);
        validateStep2();
        return;
      }
      if (isHeicLike(file)){
        reset();
        pe.classList.add('show');
        pe.textContent = t('HEIC/HEIF –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ Telegram Desktop. –í—ã–±–µ—Ä–∏—Ç–µ JPG/PNG.',
                           'HEIC/HEIF Telegram Desktop-—Ç–∞ “õ–æ–ª–¥–∞–º–∞–π–¥—ã. JPG/PNG —Ç–∞“£–¥–∞“£—ã–∑.');
        showToast(pe.textContent);
        validateStep2();
        return;
      }

      photoUploader.classList.add('uploading');
      uploadProgress.classList.add('active');

      try{
        let processed = file;
        if (file.size > 1*1024*1024 || (file.type && file.type !== 'image/jpeg')) processed = await compressImageToJpeg(file);

        if (processed.size > 5*1024*1024){
          pe.classList.add('show');
          pe.textContent = t('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 5 –ú–ë)','–§–∞–π–ª —Ç—ã–º “Ø–ª–∫–µ–Ω (–º–∞–∫—Å. 5 –ú–ë)');
          throw new Error('File too large');
        }

        currentPhotoFile = processed;
        pe.classList.remove('show');

        const r = new FileReader();
        r.onload = ()=>{ photoThumb.innerHTML = `<img alt="preview" src="${r.result}">`; };
        r.readAsDataURL(processed);

        validateStep2();
      } catch(e){
        currentPhotoFile=null;
        cargoPhotoInput.value='';
        photoThumb.innerHTML = '<span style="font-size:22px">üñºÔ∏è</span>';
        showToast(t('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ç–æ','–§–æ—Ç–æ ”©“£–¥–µ—É “õ–∞—Ç–µ—Å—ñ'));
      } finally {
        photoUploader.classList.remove('uploading');
        uploadProgress.classList.remove('active');
      }
    }

    cargoPhotoInput.addEventListener('change', async (e)=>{
      const file = e.target.files && e.target.files[0];
      await handleChosenFile(file);
      syncSheetHeightSoon();
    });

    function clearCargoPhoto(){
      cargoPhotoInput.value='';
      currentPhotoFile=null;
      photoThumb.innerHTML = '<span style="font-size:22px">üñºÔ∏è</span>';
      $('photoError').classList.remove('show');
      validateStep2();
      syncSheetHeightSoon();
    }

    /* =========================
       SUBMIT OVERLAY + SUBMIT
    ========================= */
    function showSubmitOverlay(hasPhoto){
      $('submitOverlayTitle').textContent = t('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º...','–ñ—ñ–±–µ—Ä—ñ–ª—É–¥–µ...');
      $('submitOverlaySub').textContent = hasPhoto
        ? t('–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏ –∑–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è','–§–æ—Ç–æ –∂“Ø–∫—Ç–µ–ª—ñ–ø, —Ç–∞–ø—Å—ã—Ä—ã—Å –∂—ñ–±–µ—Ä—ñ–ª—É–¥–µ')
        : t('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ','”®—Ç—ñ–Ω–µ–º—ñ–∑, –∫“Ø—Ç–µ —Ç“±—Ä—ã“£—ã–∑');
      $('submitOverlay').classList.add('active');
    }
    const hideSubmitOverlay = () => $('submitOverlay').classList.remove('active');

    async function submitOrder(){
      const btn = $('submitBtn');
      btn.disabled = true;
      const oldText = btn.textContent;
      btn.textContent = '...';

      const hasPhoto = !!currentPhotoFile;
      showSubmitOverlay(hasPhoto);

      try{
        if (!state.pickup || !state.dropoff) throw new Error(t('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫–∏ A –∏ B','A –∂”ô–Ω–µ B –Ω“Ø–∫—Ç–µ–ª–µ—Ä—ñ–Ω —Ç–∞“£–¥–∞“£—ã–∑'));
        if (!state.selectedTruck) throw new Error(t('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞','–ö”©–ª—ñ–∫ —Ç“Ø—Ä—ñ–Ω —Ç–∞“£–¥–∞“£—ã–∑'));

        if (currentPhotoFile){
          if (!currentPhotoFile.type || !currentPhotoFile.type.startsWith('image/'))
            throw new Error(t('–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–ª—å–∫–æ —Ñ–æ—Ç–æ','–¢–µ–∫ —Ñ–æ—Ç–æ –∂“Ø–∫—Ç–µ—É–≥–µ –±–æ–ª–∞–¥—ã'));
          if (currentPhotoFile.size > 5*1024*1024)
            throw new Error(t('–§–æ—Ç–æ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ (–º–∞–∫—Å. 5 –ú–ë)','–§–æ—Ç–æ —Ç—ã–º “Ø–ª–∫–µ–Ω (–º–∞–∫—Å. 5 –ú–ë)'));
        }

        const fd = new FormData();
        fd.append('from_address', state.pickup.address || '');
        fd.append('from_lat', String(state.pickup.lat));
        fd.append('from_lon', String(state.pickup.lng));
        fd.append('to_address', state.dropoff.address || '');
        fd.append('to_lat', String(state.dropoff.lat));
        fd.append('to_lon', String(state.dropoff.lng));
        fd.append('price', String($('price').value || ''));
        fd.append('truck_type', String(state.selectedTruck || ''));
        fd.append('date', String($('date').value || ''));
        fd.append('time', String($('time').value || ''));
        fd.append('contact', String($('phone').value || ''));
        fd.append('comment', String($('comment').value || ''));
        fd.append('distance', String(calculateDistance(state.pickup.lat, state.pickup.lng, state.dropoff.lat, state.dropoff.lng)));

        const tg = window.Telegram?.WebApp;
        if (tg?.initDataUnsafe?.user){
          const u = tg.initDataUnsafe.user;
          fd.append('telegram_id', String(u.id));
          fd.append('telegram_username', u.username || '');
          fd.append('telegram_first_name', u.first_name || '');
          fd.append('telegram_last_name', u.last_name || '');
        }

        if (currentPhotoFile) fd.append('cargo_photo', currentPhotoFile, currentPhotoFile.name || 'cargo.jpg');

        const controller = new AbortController();
        const timeout = setTimeout(()=>controller.abort(), 45000);

        const res = await fetch(API_URL, { method:'POST', body: fd, signal: controller.signal });
        clearTimeout(timeout);

        let json = null;
        try { json = await res.json(); } catch(e){}

        if (!res.ok){
          const msg = json?.message || t(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (${res.status})`, `–°–µ—Ä–≤–µ—Ä “õ–∞—Ç–µ—Å—ñ (${res.status})`);
          throw new Error(msg);
        }

        if (json?.success){
          state.orderData = {
            pickup: state.pickup,
            dropoff: state.dropoff,
            price: $('price').value,
            truck_type: state.selectedTruck,
            contact: $('phone').value,
            comment: $('comment').value,
            request_id: json.data?.request_id
          };
          showSuccess();
          stopTracking();
        } else {
          throw new Error(json?.message || t('–ó–∞–∫–∞–∑ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω','–¢–∞–ø—Å—ã—Ä—ã—Å –∂—ñ–±–µ—Ä—ñ–ª–º–µ–¥—ñ'));
        }

      } catch(e){
        const msg = (e?.name === 'AbortError')
          ? t('–¢–∞–π–º–∞—É—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ.','–£–∞“õ—ã—Ç –∞—è“õ—Ç–∞–ª–¥—ã. –ò–Ω—Ç–µ—Ä–Ω–µ—Ç—Ç—ñ —Ç–µ–∫—Å–µ—Ä—ñ–ø, “õ–∞–π—Ç–∞–ª–∞“£—ã–∑.')
          : (e?.message || t('–û—à–∏–±–∫–∞','“ö–∞—Ç–µ'));

        showToast(`${t('–û—à–∏–±–∫–∞','“ö–∞—Ç–µ')}: ${msg}`);
        try { alert(`${t('–û—à–∏–±–∫–∞','“ö–∞—Ç–µ')}: ${msg}`); } catch(_) {}
      } finally {
        hideSubmitOverlay();
        btn.disabled = false;
        btn.textContent = oldText;
      }
    }

    function showSuccess(){
      $('successScreen').classList.add('active');
      setTimeout(()=>goToDriverList(), 1200);
    }

    function goToDriverList(){
      const data = encodeURIComponent(JSON.stringify(state.orderData || {}));
      location.href = `/driver-list?order=${data}&lang=${currentLang}`;
    }
    function goToMainClient(){ location.href = '/main-client'; }

    /* =========================
       INIT
    ========================= */
    async function initMap(){
      const defaultCenter = [43.238949, 76.889709];
      map = createLeafletMap('map', defaultCenter, 15);
      userMarker = L.marker(defaultCenter, { icon: iconUser(), interactive:false, keyboard:false }).addTo(map);

      if (!navigator.geolocation) return;

      navigator.geolocation.getCurrentPosition(
        async (pos)=>{
          const lat = pos.coords.latitude, lng = pos.coords.longitude;
          if (!isInKazakhstan(lat,lng)){
            showToast(t('–°–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞','–°–µ—Ä–≤–∏—Å —Ç–µ–∫ “ö–∞–∑–∞“õ—Å—Ç–∞–Ω –∞—É–º–∞“ì—ã–Ω–¥–∞ –∂“±–º—ã—Å —ñ—Å—Ç–µ–π–¥—ñ'));
            return;
          }

          currentUserLocation = [lat,lng];
          state.userLoc = { lat, lng, accuracy: pos.coords.accuracy };

          map.setView(currentUserLocation, 15, { animate:false });
          updateUserMarker(lat,lng);

          // Set pickup once here (then stable)
          const addr = await reverseGeocode(lat,lng);
          if (addr){
            state.pickup = { lat,lng,address:addr };
            $('pickupAddr').textContent = addr;
            qsa('.address-card')[0].classList.add('filled');
            await upsertPointMarker('pickup', lat, lng, true);
            centerMarkerInVisibleArea(lat,lng,false);
            validateStep1();
          }

          startRealtimeTracking();
          syncSheetHeightSoon();
        },
        ()=>{},
        { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
      );
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      if (window.Telegram?.WebApp){
        const tg = Telegram.WebApp;
        tg.ready(); tg.expand();
        try{ tg.disableVerticalSwipes(); }catch(e){}
        try{ tg.setHeaderColor('#000000'); }catch(e){}
        tg.onEvent('viewportChanged', updateViewportHeight);
      }

      updateViewportHeight();

      const boot = () => initMap();
      if ('requestIdleCallback' in window) requestIdleCallback(boot, { timeout:500 });
      else setTimeout(boot, 40);

      const now = new Date();
      $('date').valueAsDate = now;
      $('time').value = now.toTimeString().slice(0,5);

      setTimeout(syncSheetHeight, 80);
    });

    addEventListener('resize', ()=>{ updateViewportHeight(); syncSheetHeightSoon(); });
    addEventListener('beforeunload', stopTracking);

    /* =========================
       EXPOSE (same API)
    ========================= */
    window.openPicker = openPicker;
    window.closePicker = closePicker;
    window.confirmPicker = confirmPicker;
    window.debouncedSearch = debouncedSearch;
    window.selectSuggestionFromElement = selectSuggestionFromElement;
    window.goToStep = goToStep;
    window.formatPhone = formatPhone;
    window.submitOrder = submitOrder;
    window.goToDriverList = goToDriverList;
    window.goToMainClient = goToMainClient;
    window.hideSuggestionsDelayed = hideSuggestionsDelayed;
    window.onSearchFocus = onSearchFocus;
    window.centerOnUserLocation = centerOnUserLocation;
    window.centerPickerOnUser = centerPickerOnUser;
    window.clearCargoPhoto = clearCargoPhoto;
    window.openSystemPicker = openSystemPicker;
    window.syncSheetHeightSoon = syncSheetHeightSoon;
  </script>
</body>
</html>
