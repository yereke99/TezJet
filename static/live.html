<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8" />
  <title>Esimde Live</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root {
      --bg: #050814;
      --bg-elevated: #0b1020;
      --accent: #ff3b6a;
      --accent2: #ff8b3b;

      --text-main: #ffffff;
      --text-secondary: #9fa4c0;

      --border-soft: rgba(255, 255, 255, 0.08);
      --radius-lg: 18px;
      --radius-pill: 999px;
      --shadow-soft: 0 16px 32px rgba(0, 0, 0, 0.6);

      --tg-viewport-stable-height: 100vh;
      --tg-safe-area-inset-top: 0px;
      --tg-safe-area-inset-bottom: 0px;
      --tg-content-safe-area-inset-top: 0px;

      --top-gap: 16px;
      --side-pad: 16px;
      --bottom-gap: 12px;

      --card-radius: 22px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }

    body {
      height: var(--tg-viewport-stable-height, 100vh);
      overflow: hidden;
      overscroll-behavior: none;
      -webkit-tap-highlight-color: transparent;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1b2a55 0, #050814 44%, #02030a 100%);
      color: var(--text-main);
    }

    .app {
      height: 100%;
      padding-top: calc(var(--tg-safe-area-inset-top, 0px) + var(--tg-content-safe-area-inset-top, 0px) + var(--top-gap));
      padding-bottom: calc(var(--tg-safe-area-inset-bottom, 0px) + var(--bottom-gap));
      padding-left: var(--side-pad);
      padding-right: var(--side-pad);
      display: flex;
      justify-content: center;
      align-items: stretch;
      position: relative;
    }

    .page {
      width: 100%;
      max-width: 620px;
      height: 100%;
      min-height: 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* HEADER */
    .header {
      flex: 0 0 auto;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 10px;
      position: sticky;
      top: 0;
      z-index: 20;
      padding: 6px 0;
      background: linear-gradient(to bottom, rgba(5,8,20,0.90), rgba(5,8,20,0.0));
      backdrop-filter: blur(10px);
    }

    /* USER CHIP (LEFT) */
    .user-chip {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 6px 10px 6px 6px;
      border-radius: var(--radius-pill);
      background: rgba(11, 16, 32, 0.78);
      border: 1px solid rgba(255,255,255,0.10);
      backdrop-filter: blur(12px);
      box-shadow: 0 8px 18px rgba(0,0,0,0.40);
      max-width: 100%;
      min-width: 0;
      flex: 1 1 auto;
    }
    .user-chip-avatar {
      width: 34px; height: 34px; border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      overflow: hidden;
      display: flex; align-items: center; justify-content: center;
      font-weight: 900; font-size: 13px; color: #fff;
      box-shadow: 0 0 0 2px rgba(255,255,255,0.08);
      flex-shrink: 0;
    }
    .user-chip-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .user-chip-info { display: flex; flex-direction: column; gap: 2px; min-width: 0; }

    .user-chip-name {
      font-size: 12px;
      font-weight: 900;
      white-space: normal;
      overflow: visible;
      text-overflow: clip;
      line-height: 1.15;
      max-height: 2.4em;
    }

    .user-chip-username {
      font-size: 11px;
      color: var(--text-secondary);
      white-space: normal;
      overflow: visible;
      text-overflow: clip;
      line-height: 1.15;
      max-height: 2.3em;
      word-break: break-word;
    }

    /* MAIN CARD */
    .live-card {
      flex: 1 1 auto;
      min-height: 0;
      overflow: hidden;
      background: rgba(4, 7, 20, 0.96);
      border-radius: var(--card-radius);
      padding: 10px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(255,255,255,0.06);
      backdrop-filter: blur(18px);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* VIDEO */
    .live-video-wrapper {
      flex: 0 0 auto;
      position: relative;
      border-radius: 18px;
      overflow: hidden;
      background: #000;
      border: 1px solid rgba(255,255,255,0.10);
    }
    .video-aspect { position: relative; width: 100%; padding-top: 56.25%; }
    .video-aspect iframe { position: absolute; inset: 0; width: 100%; height: 100%; border: 0; }

    .live-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 10px 12px;
      pointer-events: none;
    }
    .top-row { display: flex; justify-content: space-between; align-items: center; gap: 8px; }
    .live-pill {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 3px 10px; border-radius: var(--radius-pill);
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #fff; font-size: 11px; font-weight: 900; letter-spacing: 0.08em; text-transform: uppercase;
      box-shadow: 0 0 16px rgba(0,0,0,0.85);
    }
    .live-dot { width: 7px; height: 7px; border-radius: 50%; background: #fff; box-shadow: 0 0 10px rgba(255,255,255,0.9); }

    .viewers-pill {
      padding: 4px 10px; border-radius: var(--radius-pill);
      background: rgba(0,0,0,0.55);
      color: #f5f5f5; font-size: 11px;
      display: inline-flex; align-items: center; gap: 6px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.10);
    }
    .viewers-dot { width: 8px; height: 8px; border-radius: 50%; background: #22c55e; box-shadow: 0 0 10px rgba(34,197,94,0.9); }
    .viewers-pill.is-waiting { opacity: 0.80; }
    .viewers-pill.is-offline { opacity: 0.60; }
    .viewers-pill b { font-weight: 900; }

    .bottom-row { display: flex; justify-content: space-between; align-items: flex-end; gap: 8px; }
    .live-title {
      max-width: 75%;
      font-size: 14px; font-weight: 850; color: #fdfdfd;
      text-shadow: 0 0 14px rgba(0,0,0,0.9);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .badges { display: flex; gap: 6px; flex-wrap: wrap; justify-content: flex-end; }
    .badge {
      font-size: 10px; padding: 4px 9px; border-radius: var(--radius-pill);
      background: rgba(0,0,0,0.55); color: #f5f5f5;
      border: 1px solid rgba(255,255,255,0.10); user-select: none;
    }
    .badge.red { background: rgba(255,59,106,0.78); border-color: rgba(255,59,106,0.95); }

    /* CHAT */
    .chat-area {
      flex: 1 1 auto;
      min-height: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding-top: 8px;
      border-top: 1px solid rgba(255,255,255,0.08);
    }
    .chat-title {
      flex: 0 0 auto;
      font-size: 13px;
      font-weight: 900;
      display: flex;
      align-items: center;
      gap: 6px;
      user-select: none;
      justify-content: space-between;
    }
    .chat-title .left { display: inline-flex; align-items: center; gap: 6px; }
    .chat-title .left::before { content: "üí¨"; }

    .anti-spam {
      display: none;
      flex: 0 0 auto;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255, 59, 106, 0.12);
      padding: 8px 10px;
      font-size: 12px;
      line-height: 1.4;
      color: #ffd6e0;
    }
    .anti-spam b { color: #fff; }

    .chat-box {
      flex: 1 1 auto;
      min-height: 0;
      border-radius: 14px;
      background: rgba(12, 18, 36, 0.92);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 10px 10px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .chat-empty {
      font-size: 12px;
      color: var(--text-secondary);
      text-align: center;
      margin-top: 12px;
      user-select: none;
    }

    .chat-message {
      max-width: 92%;
      padding: 8px 10px;
      border-radius: 14px;
      background: rgba(2, 6, 23, 0.88);
      border: 1px solid rgba(148,163,184,0.28);
      font-size: 12px;
      line-height: 1.35;
      word-break: break-word;
      white-space: pre-wrap;
      box-shadow: 0 6px 16px rgba(0,0,0,0.20);
    }
    .chat-message.me {
      margin-left: auto;
      background: rgba(15, 23, 42, 0.92);
      border-color: rgba(248,250,252,0.28);
    }
    .chat-author { font-weight: 900; font-size: 11px; margin-bottom: 3px; color: #e5e7eb; }
    .chat-text { color: #e5e7eb; }
    .chat-meta {
      margin-top: 6px;
      font-size: 10px;
      color: rgba(159,164,192,0.95);
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      user-select: none;
    }

    .chat-input-row {
      flex: 0 0 auto;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chat-input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.55);
      background: rgba(15, 23, 42, 0.92);
      padding: 10px 12px;
      color: var(--text-main);
      font-size: 13px;
      outline: none;
    }
    .chat-input::placeholder { color: var(--text-secondary); }

    .chat-send-btn {
      border: none;
      border-radius: 999px;
      padding: 10px 14px;
      background: var(--accent);
      color: #fff;
      font-size: 13px;
      font-weight: 950;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(255,59,106,0.35);
      user-select: none;
    }
    .chat-send-btn:active { transform: scale(0.97); }
    .chat-send-btn[disabled] { opacity: .6; cursor: not-allowed; }

    .chat-hint { flex: 0 0 auto; font-size: 11px; color: var(--text-secondary); }

    /* PAYMENT BUTTON CENTER */
    .pay-center {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      z-index: 9999;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 999px;
      padding: 14px 18px;
      background: linear-gradient(135deg, rgba(255,59,106,0.98), rgba(255,138,59,0.92));
      color: #fff;
      font-weight: 950;
      font-size: 14px;
      letter-spacing: 0.02em;
      box-shadow: 0 18px 34px rgba(0,0,0,0.55);
      cursor: pointer;
      user-select: none;
      transition: transform 0.12s ease-out, opacity 0.15s ease;
    }
    .pay-center:active { transform: translate(-50%, -50%) scale(0.97); }
    .pay-center[disabled] { opacity: 0.6; cursor: not-allowed; }
    .pay-center.hidden { display: none; }

    /* ADMIN CONTROL (lower side) */
    .admin-control {
      display: none;
      position: sticky;
      bottom: calc(var(--tg-safe-area-inset-bottom, 0px) + 6px);
      z-index: 50;
      border-radius: 16px;
      background: rgba(15, 23, 42, 0.92);
      border: 1px solid rgba(255,255,255,0.14);
      padding: 10px 12px;
      box-shadow: 0 12px 26px rgba(0,0,0,0.55);
      backdrop-filter: blur(14px);
    }
    .admin-control.show { display: block; }

    .admin-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .admin-label {
      font-size: 11px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      user-select: none;
    }
    .toggle-btn {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      font-size: 12px;
      font-weight: 950;
      cursor: pointer;
      transition: transform 0.15s ease;
      user-select: none;
      min-width: 120px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .toggle-btn:active { transform: scale(0.97); }
    .toggle-btn.enabled { background: #22c55e; color: #06110a; }
    .toggle-btn.disabled { background: #ef4444; color: #fff; }
    .toggle-btn[disabled] { opacity: 0.6; cursor: not-allowed; }

    @media (max-width: 420px) {
      :root { --top-gap: 14px; --side-pad: 12px; }
      .user-chip-avatar { width: 32px; height: 32px; }
      .pay-center { padding: 13px 16px; font-size: 13px; }
    }
  </style>
</head>

<body>
  <div class="app">
    <button class="pay-center hidden" id="pay-btn" type="button">üí≥ –¢”©–ª–µ–º –∂–∞—Å–∞—É</button>

    <div class="page">
      <header class="header">
        <div class="user-chip" id="user-chip">
          <div class="user-chip-avatar" id="user-avatar">?</div>
          <div class="user-chip-info">
            <div class="user-chip-name" id="user-name">“ö–æ–Ω–∞“õ</div>
            <div class="user-chip-username" id="user-username"></div>
          </div>
        </div>
      </header>

      <section class="live-card">
        <div class="live-video-wrapper">
          <div class="video-aspect">
            <!-- ‚úÖ UPDATED VIDEO (YOUR NEW LINK) + MINIMIZED UI -->
            <iframe
              width="560"
              height="315"
              src="https://www.youtube.com/embed/3QS_M5xoTF0?si=brKy1mAJ-x1y0EDl&controls=0&modestbranding=1&rel=0&iv_load_policy=3&fs=0&disablekb=1&playsinline=1&origin="
              title="YouTube video player"
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              referrerpolicy="strict-origin-when-cross-origin"
              allowfullscreen
            ></iframe>
          </div>

          <div class="live-overlay">
            <div class="top-row">
              <div class="live-pill"><span class="live-dot"></span>LIVE</div>
              <div class="viewers-pill is-waiting" id="viewers-pill">
                <span class="viewers-dot"></span>
                <span id="viewer-count"><b>‚Äî</b> –∫”©—Ä–µ—Ä–º–µ–Ω</span>
              </div>
            </div>

            <div class="bottom-row">
              <div class="live-title">Esimde –ø–∞—Ä—Ñ—é–º &amp; –∫–æ—Å–º–µ—Ç–∏–∫–∞ —Ç—ñ–∫–µ–ª–µ–π —ç—Ñ–∏—Ä</div>
              <div class="badges">
                <div class="badge red">HD 1080p</div>
                <div class="badge">Esimde Live</div>
              </div>
            </div>
          </div>
        </div>

        <div class="chat-area">
          <div class="chat-title">
            <span class="left">–¢—ñ–∫–µ–ª–µ–π —ç—Ñ–∏—Ä —á–∞—Ç—ã</span>
          </div>

          <div class="anti-spam" id="anti-spam-box"></div>

          <div class="chat-box" id="chat-box">
            <div class="chat-empty" id="chat-empty">
              ”ò–∑—ñ—Ä—à–µ —Ö–∞–±–∞—Ä–ª–∞–º–∞–ª–∞—Ä –∂–æ“õ. –ë—ñ—Ä—ñ–Ω—à—ñ –±–æ–ª—ã–ø –∂–∞–∑—ã–ø –∫”©—Ä—ñ“£—ñ–∑ üôÇ
            </div>
          </div>

          <div class="admin-control" id="admin-control">
            <div class="admin-row">
              <div class="admin-label">‚öôÔ∏è –¢”©–ª–µ–º –±–∞—Ç—ã—Ä–º–∞—Å—ã</div>
              <button class="toggle-btn" id="toggle-btn" type="button">
                <span id="toggle-text">Loading...</span>
              </button>
            </div>
          </div>

          <form class="chat-input-row" id="chat-form">
            <input
              type="text"
              class="chat-input"
              id="chat-input"
              maxlength="100"
              autocomplete="off"
              placeholder="–•–∞–±–∞—Ä–ª–∞–º–∞ –∂–∞–∑—ã“£—ã–∑..."
            />
            <button class="chat-send-btn" id="chat-send-btn" type="submit">–ñ—ñ–±–µ—Ä—É</button>
          </form>

          <div class="chat-hint">
            –ß–∞—Ç Esimde —ñ—à—ñ–Ω–¥–µ “ì–∞–Ω–∞ –∂“±–º—ã—Å —ñ—Å—Ç–µ–π–¥—ñ. –°–ø–∞–º“ì–∞ “õ–∞—Ä—Å—ã “õ–∞—Ä–∞–ø–∞–π—ã–º —à–µ–∫—Ç–µ—É–ª–µ—Ä “õ–æ–π—ã–ª–∞–¥—ã.
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    (function () {
      const tg = window.Telegram ? window.Telegram.WebApp : null;

      const ROOM = "esimde-live";
      const PAY_API = "/api/pay";
      const PAY_STATUS_API = "/api/pay/status";
      const PAY_TOGGLE_API = "/api/pay/toggle";
      const ADMIN_ID = 800703982;

      const payBtn = document.getElementById("pay-btn");
      const adminControl = document.getElementById("admin-control");
      const toggleBtn = document.getElementById("toggle-btn");
      const toggleText = document.getElementById("toggle-text");

      const viewerSpan = document.getElementById("viewer-count");
      const viewersPill = document.getElementById("viewers-pill");

      const antiBox = document.getElementById("anti-spam-box");
      const chatBox = document.getElementById("chat-box");
      const chatEmpty = document.getElementById("chat-empty");
      const chatForm = document.getElementById("chat-form");
      const chatInput = document.getElementById("chat-input");
      const sendBtn = document.getElementById("chat-send-btn");

      const userChip = document.getElementById("user-chip");
      const userAvatar = document.getElementById("user-avatar");
      const userName = document.getElementById("user-name");
      const userUsername = document.getElementById("user-username");

      let currentUserID = null;
      let isAdmin = false;
      let statusCheckInterval = null;

      // ========================================
      // üë§ DISPLAY USER
      // ========================================
      function displayUserProfile() {
        if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
          const user = tg.initDataUnsafe.user;

          const firstName = user.first_name || "";
          const lastName = user.last_name || "";
          const fullName = (firstName + (lastName ? " " + lastName : "")).trim() || "“ö–æ–Ω–∞“õ";
          const username = user.username ? "@" + user.username : "ID: " + user.id;

          if (user.photo_url) {
            const img = document.createElement("img");
            img.src = user.photo_url;
            img.alt = fullName;
            userAvatar.innerHTML = "";
            userAvatar.appendChild(img);
          } else {
            const initial = firstName ? firstName.charAt(0).toUpperCase() : "?";
            userAvatar.textContent = initial;
          }

          userName.textContent = fullName;
          userUsername.textContent = username;

          userChip.style.display = "flex";
        } else {
          userChip.style.display = "flex";
          userName.textContent = "“ö–æ–Ω–∞“õ";
          userUsername.textContent = "";
          userAvatar.textContent = "?";
        }
      }

      function initUser() {
        if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
          currentUserID = tg.initDataUnsafe.user.id;
          isAdmin = (currentUserID === ADMIN_ID);
          if (isAdmin) adminControl.classList.add("show");
        }
        displayUserProfile();
      }

      // ========================================
      // üí≥ PAY BUTTON STATUS
      // ========================================
      async function checkPayButtonStatus() {
        try {
          const res = await fetch(PAY_STATUS_API, { cache: "no-store" });
          const data = await res.json();

          if (data.enabled) payBtn.classList.remove("hidden");
          else payBtn.classList.add("hidden");

          if (isAdmin) updateToggleButton(!!data.enabled);
        } catch (err) {
          console.error("Failed to check pay button status:", err);
        }
      }

      function updateToggleButton(enabled) {
        if (enabled) {
          toggleBtn.className = "toggle-btn enabled";
          toggleText.textContent = "‚úÖ “ö–æ—Å—É–ª—ã";
        } else {
          toggleBtn.className = "toggle-btn disabled";
          toggleText.textContent = "‚ùå ”®—à—ñ—Ä—É–ª—ñ";
        }
      }

      async function togglePayButton() {
        if (!isAdmin) return;
        try {
          toggleBtn.disabled = true;

          const res = await fetch(PAY_TOGGLE_API, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Telegram-User-ID": String(currentUserID)
            },
            body: JSON.stringify({ ts: Date.now() })
          });

          const data = await res.json();

          if (data.ok) {
            updateToggleButton(data.enabled);
            showAntiSpam(data.enabled ? "‚úÖ –¢”©–ª–µ–º –±–∞—Ç—ã—Ä–º–∞—Å—ã “õ–æ—Å—ã–ª–¥—ã" : "‚ùå –¢”©–ª–µ–º –±–∞—Ç—ã—Ä–º–∞—Å—ã ”©—à—ñ—Ä—ñ–ª–¥—ñ");
          } else {
            showAntiSpam("‚õî “ö–∞—Ç–µ: " + (data.error || "unknown"));
          }
        } catch (err) {
          console.error("Toggle failed:", err);
          showAntiSpam("‚õî “ö–∞—Ç–µ –æ—Ä—ã–Ω –∞–ª–¥—ã");
        } finally {
          toggleBtn.disabled = false;
        }
      }

      function startStatusPolling() {
        checkPayButtonStatus();
        statusCheckInterval = setInterval(checkPayButtonStatus, 3000);
      }
      function stopStatusPolling() {
        if (statusCheckInterval) {
          clearInterval(statusCheckInterval);
          statusCheckInterval = null;
        }
      }

      // ========================================
      // TELEGRAM VIEWPORT VARS
      // ========================================
      function applyTgViewportVars() {
        const stableH = (tg && (tg.viewportStableHeight || tg.viewportHeight)) || window.innerHeight || 700;
        document.documentElement.style.setProperty("--tg-viewport-stable-height", stableH + "px");
        if (!tg) return;
        try {
          const s = tg.safeAreaInset || {};
          const c = tg.contentSafeAreaInset || {};
          if (typeof s.top === "number") document.documentElement.style.setProperty("--tg-safe-area-inset-top", s.top + "px");
          if (typeof s.bottom === "number") document.documentElement.style.setProperty("--tg-safe-area-inset-bottom", s.bottom + "px");
          if (typeof c.top === "number") document.documentElement.style.setProperty("--tg-content-safe-area-inset-top", c.top + "px");
        } catch (e) {}
      }

      if (tg) {
        tg.ready();
        try { tg.expand(); } catch(e) {}
        applyTgViewportVars();
        try { tg.onEvent("viewportChanged", function () { applyTgViewportVars(); }); } catch(e) {}
      } else {
        applyTgViewportVars();
      }
      window.addEventListener("resize", () => { applyTgViewportVars(); }, { passive: true });

      // ‚úÖ Fix: set origin param for iframe to reduce overlays issues
      (function setIframeOrigin() {
        try {
          const ifr = document.querySelector(".video-aspect iframe");
          if (!ifr) return;
          const u = new URL(ifr.src);
          u.searchParams.set("origin", window.location.origin);
          ifr.src = u.toString();
        } catch (e) {}
      })();

      // ========================================
      // VIEWERS & UTILS
      // ========================================
      function setViewerCountUI(count) {
        if (!viewerSpan) return;
        if (typeof count === "number" && isFinite(count) && count >= 0) {
          viewersPill && viewersPill.classList.remove("is-waiting", "is-offline");
          viewerSpan.innerHTML = `<b>${count.toLocaleString("kk-KZ")}</b> –∫”©—Ä–µ—Ä–º–µ–Ω`;
        }
      }
      function setViewerStateWaiting() {
        viewersPill && viewersPill.classList.add("is-waiting");
        viewersPill && viewersPill.classList.remove("is-offline");
        if (viewerSpan) viewerSpan.innerHTML = `<b>‚Äî</b> –∫”©—Ä–µ—Ä–º–µ–Ω`;
      }
      function setViewerStateOffline() {
        viewersPill && viewersPill.classList.remove("is-waiting");
        viewersPill && viewersPill.classList.add("is-offline");
      }

      function showAntiSpam(msg) {
        if (!antiBox) return;
        antiBox.style.display = "block";
        antiBox.innerHTML = msg;
        window.clearTimeout(showAntiSpam._t);
        showAntiSpam._t = window.setTimeout(() => {
          antiBox.style.display = "none";
          antiBox.innerHTML = "";
        }, 2600);
      }

      function nowTimeHHMM() {
        const d = new Date();
        const hh = String(d.getHours()).padStart(2, "0");
        const mm = String(d.getMinutes()).padStart(2, "0");
        return `${hh}:${mm}`;
      }

      function smartScrollToBottom(force) {
        if (!chatBox) return;
        const nearBottom = (chatBox.scrollHeight - chatBox.scrollTop - chatBox.clientHeight) < 120;
        if (!force && !nearBottom) return;
        requestAnimationFrame(() => { chatBox.scrollTop = chatBox.scrollHeight; });
      }

      const pendingMap = new Map();
      const recentKeys = new Map();
      const RECENT_MS = 5000;

      function cleanupRecent() {
        const now = Date.now();
        for (const [k, ts] of recentKeys.entries()) {
          if (now - ts > RECENT_MS) recentKeys.delete(k);
        }
      }

      function addMessage(author, text, isMe, opts) {
        if (chatEmpty) chatEmpty.style.display = "none";
        const clientId = opts && opts.client_id ? String(opts.client_id) : "";
        const pending = !!(opts && opts.pending);
        const delivered = !!(opts && opts.delivered);
        const time = (opts && opts.time) ? String(opts.time) : nowTimeHHMM();

        const msg = document.createElement("div");
        msg.className = "chat-message" + (isMe ? " me" : "");
        if (clientId) msg.dataset.clientId = clientId;

        const authorEl = document.createElement("div");
        authorEl.className = "chat-author";
        authorEl.textContent = author;

        const textEl = document.createElement("div");
        textEl.className = "chat-text";
        textEl.textContent = text;

        const meta = document.createElement("div");
        meta.className = "chat-meta";

        const timeEl = document.createElement("span");
        timeEl.textContent = time;

        const statusEl = document.createElement("span");
        statusEl.className = "chat-status";
        if (isMe) {
          if (pending) statusEl.textContent = "‚è≥";
          else if (delivered) statusEl.textContent = "‚úì";
        }

        meta.appendChild(timeEl);
        meta.appendChild(statusEl);

        msg.appendChild(authorEl);
        msg.appendChild(textEl);
        msg.appendChild(meta);

        chatBox.appendChild(msg);
        smartScrollToBottom(true);
        return { statusEl };
      }

      function markDelivered(clientId) {
        const rec = pendingMap.get(clientId);
        if (!rec) return false;
        try { if (rec.statusEl) rec.statusEl.textContent = "‚úì"; } catch (e) {}
        pendingMap.delete(clientId);
        return true;
      }

      setTimeout(() => {
        addMessage("Esimde Live", "“ö–æ—à –∫–µ–ª–¥—ñ“£—ñ–∑! –°“±—Ä–∞“õ—Ç–∞—Ä—ã“£—ã–∑–¥—ã —á–∞—Ç“õ–∞ –∂–∞–∑–∞ –±–µ—Ä—ñ“£—ñ–∑ üôå", false, { delivered: true });
      }, 600);

      function resolveAuthor() {
        if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
          const u = tg.initDataUnsafe.user;
          const a = ((u.first_name || "") + (u.last_name ? " " + u.last_name : "")).trim();
          if (a) return a;
        }
        return "“ö–æ–Ω–∞“õ";
      }
      const currentAuthor = resolveAuthor();

      const COOL_MS = 5000;
      let lastSendAt = 0;

      function hasLink(text) {
        const t = text.toLowerCase();
        if (t.includes("http://") || t.includes("https://") || t.includes("www.") || t.includes("t.me/") || t.includes("telegram.me/")) return true;
        const domainRe = /\b[a-z0-9-]+\.(com|net|org|ru|kz|io|me|app|dev|site|xyz|info|biz)\b/i;
        return domainRe.test(text);
      }

      function hasPhone(text) {
        if (text.toLowerCase().includes("–æ–ø–ª–∞—Ç–∞")) return false;
        const digits = text.replace(/\D/g, "");
        if (/(\+?7|8)\d{10}\b/.test(text.replace(/\s+/g, ""))) return true;
        if ((digits.startsWith("87") || digits.startsWith("77") || digits.startsWith("7") || digits.startsWith("8")) && digits.length >= 10) return true;
        return /\b\d{10,11}\b/.test(digits);
      }

      function hasBankCard(text) {
        const digits = text.replace(/\D/g, "");
        if (digits.length >= 16 && digits.length <= 19) return true;
        return /\b\d{4}([ -]?\d{4}){3,4}\b/.test(text);
      }

      function validateMessage(text) {
        const msg = (text || "").trim();
        if (!msg) return { ok: false, reason: "–ë–æ—Å —Ö–∞–±–∞—Ä–ª–∞–º–∞ –∂—ñ–±–µ—Ä—É–≥–µ –±–æ–ª–º–∞–π–¥—ã." };
        if (msg.length > 100) return { ok: false, reason: "–•–∞–±–∞—Ä–ª–∞–º–∞ “±–∑—ã–Ω–¥—ã“ì—ã 100 —Ç–∞“£–±–∞–¥–∞–Ω –∞—Å–ø–∞—É –∫–µ—Ä–µ–∫." };
        if (hasLink(msg)) return { ok: false, reason: "–°—ñ–ª—Ç–µ–º–µ –∂—ñ–±–µ—Ä—É–≥–µ –±–æ–ª–º–∞–π–¥—ã (–∞–Ω—Ç–∏-—Å–ø–∞–º)." };
        if (hasBankCard(msg)) return { ok: false, reason: "–ë–∞–Ω–∫ –∫–∞—Ä—Ç–∞—Å—ã –¥–µ—Ä–µ–∫—Ç–µ—Ä—ñ–Ω –∂—ñ–±–µ—Ä—É–≥–µ –±–æ–ª–º–∞–π–¥—ã (–∞–Ω—Ç–∏-—Å–ø–∞–º)." };
        if (hasPhone(msg)) return { ok: false, reason: "–¢–µ–ª–µ—Ñ–æ–Ω –Ω”©–º—ñ—Ä—ñ–Ω –∂—ñ–±–µ—Ä—É–≥–µ –±–æ–ª–º–∞–π–¥—ã (–∞–Ω—Ç–∏-—Å–ø–∞–º)." };
        const now = Date.now();
        if (now - lastSendAt < COOL_MS) {
          const left = Math.ceil((COOL_MS - (now - lastSendAt)) / 1000);
          return { ok: false, reason: `–¢—ã–º –∂–∏—ñ –∂—ñ–±–µ—Ä—ñ–ø –∂–∞—Ç—ã—Ä—Å—ã–∑. ${left} —Å–µ–∫ –∫“Ø—Ç—ñ“£—ñ–∑.` };
        }
        return { ok: true };
      }

      function genClientId() {
        return "c_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 10);
      }

      // ========================================
      // WEBSOCKET
      // ========================================
      let ws = null;
      let wsConnected = false;
      let reconnectTry = 0;
      let hbTimer = null;

      function wsSend(obj) {
        if (!ws || !wsConnected) return false;
        try { ws.send(JSON.stringify(obj)); return true; } catch (e) { return false; }
      }

      function startHeartbeat() {
        stopHeartbeat();
        hbTimer = setInterval(() => {
          wsSend({ type: "ping", room: ROOM, ts: Date.now() });
          wsSend({ type: "presence_get", room: ROOM, ts: Date.now() });
        }, 10000);
      }

      function stopHeartbeat() {
        if (hbTimer) clearInterval(hbTimer);
        hbTimer = null;
      }

      function connectWebSocket() {
        setViewerStateWaiting();
        const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
        const host = window.location.host;
        const wsUrl = protocol + host + "/ws/live-chat?room=" + encodeURIComponent(ROOM) + "&author=" + encodeURIComponent(currentAuthor);

        try { ws = new WebSocket(wsUrl); } catch (e) { scheduleReconnect(); return; }

        ws.onopen = () => {
          wsConnected = true;
          reconnectTry = 0;
          wsSend({ type: "presence_join", room: ROOM, author: currentAuthor, ts: Date.now() });
          wsSend({ type: "presence_get", room: ROOM, ts: Date.now() });
          startHeartbeat();
        };

        ws.onclose = () => {
          wsConnected = false;
          stopHeartbeat();
          setViewerStateOffline();
          scheduleReconnect();
        };

        ws.onerror = () => {};

        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data || "{}");
            const maybeRoom = data.room || data.Room;

            if (maybeRoom === ROOM) {
              const v =
                (typeof data.viewers === "number") ? data.viewers :
                (typeof data.count === "number") ? data.count :
                (typeof data.Viewers === "number") ? data.Viewers :
                (typeof data.Count === "number") ? data.Count : null;

              const t = (data.type || data.Type || "").toLowerCase();
              const isPresenceType = (t === "presence" || t === "viewers" || t === "presence_update" || t === "presence_state");
              if (isPresenceType && v !== null) { setViewerCountUI(v); return; }
              if (!t && v !== null) { setViewerCountUI(v); return; }
            }

            if (!data.text) return;

            const author = data.author || "“ö–∞—Ç—ã—Å—É—à—ã";
            const text = String(data.text);

            const chk = validateMessage(text);
            if (!chk.ok) return;

            const clientId = data.client_id ? String(data.client_id) : "";
            if (clientId && pendingMap.has(clientId)) {
              markDelivered(clientId);
              return;
            }

            cleanupRecent();
            const key = author + "||" + text;
            if (recentKeys.has(key)) return;
            recentKeys.set(key, Date.now());

            const isMe = author === currentAuthor;
            addMessage(author, text, isMe, { delivered: isMe ? true : false });
          } catch (e) {}
        };
      }

      function scheduleReconnect() {
        reconnectTry++;
        const backoff = Math.min(30000, 1500 + reconnectTry * 1200);
        setTimeout(connectWebSocket, backoff);
      }

      window.addEventListener("beforeunload", () => {
        try { wsSend({ type: "presence_leave", room: ROOM, author: currentAuthor, ts: Date.now() }); } catch(e) {}
        try { stopHeartbeat(); } catch(e) {}
        try { ws && ws.close(); } catch(e) {}
        stopStatusPolling();
      });

      connectWebSocket();

      if (chatForm) {
        chatForm.addEventListener("submit", function (e) {
          e.preventDefault();
          const value = (chatInput.value || "").trim();

          const check = validateMessage(value);
          if (!check.ok) {
            showAntiSpam("‚õî <b>–ê–Ω—Ç–∏-—Å–ø–∞–º</b><br/>" + check.reason);
            return;
          }

          lastSendAt = Date.now();
          if (sendBtn) {
            sendBtn.disabled = true;
            setTimeout(() => { sendBtn.disabled = false; }, 900);
          }

          const clientId = genClientId();
          const created = addMessage(currentAuthor, value, true, {
            client_id: clientId,
            pending: true,
            time: nowTimeHHMM()
          });
          pendingMap.set(clientId, { statusEl: created.statusEl });

          chatInput.value = "";

          if (ws && wsConnected) {
            const payload = { author: currentAuthor, text: value, room: ROOM, client_id: clientId };
            try { ws.send(JSON.stringify(payload)); }
            catch (err) { try { created.statusEl.textContent = "‚ö†Ô∏è"; } catch (e) {} }
          } else {
            try { created.statusEl.textContent = "‚ö†Ô∏è"; } catch(e) {}
          }
        }, { passive: false });
      }

      // ========================================
      // ‚úÖ PAYMENT
      // ========================================
      async function handlePayment() {
        if (!tg) {
          showAntiSpam("‚õî <b>–¢”©–ª–µ–º</b><br/>–ë“±–ª –±–∞—Ç—ã—Ä–º–∞ —Ç–µ–∫ Telegram —ñ—à—ñ–Ω–¥–µ –∂“±–º—ã—Å —ñ—Å—Ç–µ–π–¥—ñ.");
          return;
        }

        const userID = tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : null;
        if (!userID) {
          showAntiSpam("‚õî <b>–¢”©–ª–µ–º</b><br/>User ID —Ç–∞–±—ã–ª–º–∞–¥—ã.");
          return;
        }

        try {
          payBtn && payBtn.setAttribute("disabled", "disabled");

          const res = await fetch(PAY_API, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Telegram-User-ID": String(userID)
            },
            body: JSON.stringify({ room: ROOM, ts: Date.now() })
          });

          const data = await res.json().catch(() => ({}));

          if (!res.ok || !data.ok) {
            showAntiSpam("‚õî <b>–¢”©–ª–µ–º</b><br/>“ö–∞—Ç–µ: " + (data.error || ("HTTP " + res.status)));
            try { payBtn && payBtn.removeAttribute("disabled"); } catch(e) {}
            return;
          }

          showAntiSpam("‚úÖ <b>–°”ô—Ç—Ç—ñ!</b><br/>–¢”©–ª–µ–º —Å—ñ–ª—Ç–µ–º–µ—Å—ñ –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ. –ë–æ—Ç —á–∞—Ç—ã–Ω —Ç–µ–∫—Å–µ—Ä—ñ“£—ñ–∑.");

          if (tg.HapticFeedback && tg.HapticFeedback.notificationOccurred) {
            try { tg.HapticFeedback.notificationOccurred("success"); } catch(e) {}
          }

          setTimeout(() => {
            try { tg.close(); } catch(e) {}
          }, 800);

        } catch (e) {
          console.error("Payment request failed:", e);
          showAntiSpam("‚õî <b>–¢”©–ª–µ–º</b><br/>–ñ–µ–ª—ñ “õ–∞—Ç–µ—Å—ñ. “ö–∞–π—Ç–∞–¥–∞–Ω –±–∞–π“õ–∞–ø –∫”©—Ä—ñ“£—ñ–∑.");
          try { payBtn && payBtn.removeAttribute("disabled"); } catch(err) {}
        }
      }

      if (payBtn) payBtn.addEventListener("click", handlePayment, { passive: true });
      if (toggleBtn) toggleBtn.addEventListener("click", togglePayButton, { passive: true });

      initUser();
      startStatusPolling();
    })();
  </script>
</body>
</html>
