<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>–ü—Ä–æ—Ñ–∏–ª—å–¥—ñ –∂–∞“£–∞—Ä—Ç—É</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#f8fafc; --card:#fff; --text:#0f172a; --text-secondary:#475569; --text-muted:#94a3b8;
      --accent:#10b981; --accent-dark:#059669; --border:#e2e8f0; --input-bg:#f8fafc;
      --shadow:0 1px 3px rgba(0,0,0,.08); --shadow-lg:0 10px 25px rgba(0,0,0,.1);

      --tg-viewport-stable-height:100vh;
      --tg-safe-area-inset-top:0px;
      --tg-safe-area-inset-bottom:0px;

      --content-top:180px;
      --content-bottom-pad:140px;

      --top-offset:28px;
    }
    [data-theme="dark"]{
      --bg:#0b1220; --card:#121a2b; --text:#eef4ff; --text-secondary:#cbd5e1; --text-muted:#94a3b8;
      --accent:#34d399; --accent-dark:#10b981; --border:#25324a; --input-bg:#121a2b;
      --shadow:0 1px 3px rgba(0,0,0,.3); --shadow-lg:0 10px 25px rgba(0,0,0,.5);
    }

    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{
      height:100%;
      overflow:hidden;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,'SF Pro','Helvetica Neue',Roboto,Arial,sans-serif
    }
    button{appearance:none;-webkit-appearance:none;cursor:pointer}

    /* ===== Top bars ===== */
    .header{
      position:fixed; left:0; right:0; z-index:1000;
      top: calc(var(--tg-safe-area-inset-top) + var(--top-offset));
      padding:12px 16px;
      display:flex; align-items:center; justify-content:space-between;
      background:transparent;
    }
    .back-btn{
      width:40px;height:40px;border-radius:999px;background:var(--card);
      border:1px solid var(--border);display:flex;align-items:center;justify-content:center;
      font-size:20px;box-shadow:var(--shadow);transition:.15s transform;
    }
    .back-btn:active{ transform:scale(.96) }
    .header-title{font-size:18px;font-weight:800}

    .profile-header{
      position:fixed; left:0; right:0; z-index:900;
      top: calc(var(--tg-safe-area-inset-top) + var(--top-offset));
      margin-top:56px; /* –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è JS */
      padding:12px 20px 14px;
      background:var(--bg);
      border-bottom:1px solid var(--border);
    }
    .ph-inner{
      max-width:680px; margin:0 auto;
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px;
      text-align:center;
    }

    .status-badge{
      display:inline-flex; gap:6px; align-items:center; padding:5px 12px; border-radius:16px;
      background:rgba(245,158,11,.1); color:#f59e0b; font-size:11px; font-weight:800;
      letter-spacing:.3px; text-transform:uppercase;
      margin:4px 0 6px;
    }

    /* ===== Avatar block ===== */
    .avatar-container{
      position:relative; margin-inline:auto;
      display:flex; align-items:center; justify-content:center;
    }
    .avatar{
      width:96px;height:96px;border-radius:999px; background:var(--card); border:3px solid var(--bg);
      display:flex;align-items:center;justify-content:center; overflow:hidden; box-shadow:var(--shadow-lg); cursor:pointer;
    }
    #avatarImg{width:100%;height:100%;object-fit:cover;display:none}
    #avatarFallback{font-size:36px;line-height:1}
    .avatar-edit{
      position:absolute; right:-2px; bottom:-2px; width:26px;height:26px; border-radius:999px;
      background:linear-gradient(135deg,var(--accent),var(--accent-dark)); border:2px solid var(--bg);
      display:flex; align-items:center; justify-content:center; font-size:12px;
    }
    .profile-name{font-size:22px;font-weight:800;margin-top:4px}
    .profile-role{font-size:13px;color:var(--text-secondary);font-weight:600}

    /* ===== Scrollable content ===== */
    .content{
      position:fixed; left:0; right:0;
      overflow:auto; -webkit-overflow-scrolling:touch;
      top: var(--content-top);
      bottom: var(--content-bottom-pad);
      padding: 0 16px 20px;
    }
    .content::-webkit-scrollbar{display:none}

    .section{
      background:var(--card); border:1px solid var(--border); border-radius:16px;
      padding:16px; margin-bottom:12px;
    }
    .section-title{font-size:15px;font-weight:800;margin-bottom:12px;display:flex;gap:8px;align-items:center}

    .field{margin-bottom:16px}
    .field-label{display:block;font-size:13px;font-weight:700;color:var(--text-secondary);margin-bottom:6px}
    .field-input{
      width:100%; padding:12px 14px; font-size:16px; font-weight:600;
      background:var(--input-bg); color:var(--text);
      border:1.5px solid var(--border); border-radius:12px; outline:none; transition:.15s border-color,.15s background;
    }
    .field-input:focus{ border-color:var(--accent); background:var(--card) }
    .field-input:disabled{ opacity:.7; cursor:not-allowed }

    .field-row{display:grid; grid-template-columns:1fr 1fr; gap:12px}

    .truck-grid{display:grid; grid-template-columns:repeat(3,1fr); gap:8px}
    .truck-card{
      padding:12px 8px; border:1.5px solid var(--border); border-radius:12px;
      text-align:center; background:var(--input-bg);
      transition:.15s border-color,.15s background;
    }
    .truck-card.selected{ border-color:var(--accent); background:rgba(16,185,129,.07) }
    .truck-icon{font-size:28px;margin-bottom:4px}
    .truck-label{font-size:11px;font-weight:800;color:var(--text-secondary)}

    .upload-box{
      border:1.5px dashed var(--border); border-radius:12px; padding:16px;
      text-align:center; background:var(--input-bg);
      transition:.15s; cursor:pointer;
    }
    .upload-box.has-file{border-style:solid;border-color:var(--accent);background:rgba(16,185,129,.07)}
    .upload-icon{font-size:32px;opacity:.5;margin-bottom:6px}
    .upload-text{font-size:13px;font-weight:800}
    .upload-hint{font-size:11px;color:var(--text-muted)}
    .file-preview{max-width:100%;max-height:110px;border-radius:10px;object-fit:cover;margin-bottom:8px}

    .location-row{display:flex;gap:8px;align-items:flex-end}
    .location-input{flex:1}
    .gps-btn{
      width:52px;height:52px;border-radius:12px;border:1.5px solid var(--border);
      background:var(--input-bg);font-size:20px;flex-shrink:0;
      display:flex;align-items:center;justify-content:center;transition:.15s;
    }
    .gps-btn.loading{ background:#f59e0b; border-color:#f59e0b; color:#fff; animation:pulse 1.5s infinite }
    .gps-btn.success{ background:var(--accent); border-color:var(--accent); color:#fff }

    /* ===== Bottom action bar (update button) ===== */
    .bottom-bar{
      position:fixed; left:0; right:0; bottom:calc(68px + var(--tg-safe-area-inset-bottom));
      z-index:1000; background:var(--card); border-top:1px solid var(--border);
      padding:12px 16px 10px;
      box-shadow:0 -2px 10px rgba(0,0,0,.05);
    }
    .btn{
      width:100%; height:60px; border:0; border-radius:14px;
      display:flex; align-items:center; justify-content:center; gap:8px;
      font-size:16px; font-weight:900; line-height:1;
    }
    .btn-primary{ background:linear-gradient(135deg,var(--accent),var(--accent-dark)); color:#fff; box-shadow:var(--shadow) }
    .btn-primary:active{ transform:translateY(1px) }
    .btn-loading::after{
      content:''; width:18px;height:18px;border:2px solid transparent;border-top:2px solid currentColor;border-radius:50%;
      animation:spin 1s linear infinite;margin-left:8px;
    }

    /* ===== Bottom navigation (3 tabs) ===== */
    .bottom-nav{
      position:fixed;
      left:0; right:0; bottom:0;
      padding:8px 12px calc(8px + var(--tg-safe-area-inset-bottom));
      background:var(--card);
      border-top:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      gap:8px;
      z-index:999;
    }
    .tab{
      flex:1;
      border:0;
      background:transparent;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      padding:6px 4px;
      border-radius:999px;
      cursor:pointer;
      color:var(--text-secondary);
      font-size:11px;
      font-weight:600;
    }
    .tab-icon{
      width:34px;height:34px;border-radius:999px;
      display:grid;place-items:center;
      background:#e5e7eb;
      box-shadow:var(--shadow);
      font-size:18px;
    }
    .tab-avatar{overflow:hidden;}
    .tab-avatar img{
      width:100%;height:100%;object-fit:cover;border-radius:999px;
    }
    .tab.active{
      background:#0f172a;
      color:#fff;
    }
    .tab.active .tab-icon{
      background:#111827;
      color:#fff;
      box-shadow:none;
    }

    /* ===== Overlays / toast ===== */
    .loading-overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(8px);
      z-index:9999;display:none;align-items:center;justify-content:center;flex-direction:column;gap:16px
    }
    .loading-overlay.show{display:flex}
    .spinner{width:42px;height:42px;border:3px solid rgba(255,255,255,.25);border-top:3px solid #fff;border-radius:50%;animation:spin 1s linear infinite}
    .loading-text{color:#fff;font-weight:800}
    .toast{
      position:fixed; top:calc(var(--tg-safe-area-inset-top) + 70px); left:50%;
      transform:translateX(-50%) translateY(-20px);
      z-index:10000; max-width:90%; padding:14px 20px; border-radius:12px; color:#fff; font-weight:800;
      box-shadow:var(--shadow-lg); opacity:0; transition:.25s;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}
    .toast.success{background:linear-gradient(135deg,var(--accent),var(--accent-dark))}
    .toast.error{background:linear-gradient(135deg,#ef4444,#dc2626)}

    input[type="file"]{display:none}

    @keyframes spin{to{transform:rotate(360deg)}}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.8}}

    @media (max-width:480px){
      .field-row{grid-template-columns:1fr}
      .truck-grid{grid-template-columns:repeat(2,1fr)}
    }
  </style>
</head>
<body>
  <!-- Loading -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div class="loading-text">–ñ“Ø–∫—Ç–µ–ª—É–¥–µ...</div>
  </div>

  <!-- Top header -->
  <div class="header" id="topHeader">
    <button class="back-btn" onclick="goToDeliveryList()">‚Üê</button>
    <div class="header-title">–ü—Ä–æ—Ñ–∏–ª—å</div>
  </div>

  <!-- Profile header (centered) -->
  <div class="profile-header" id="profileHeader">
    <div class="ph-inner">
      <div class="status-badge" id="statusBadge">‚è≥ “ö–∞—Ä–∞—É–¥–∞</div>

      <div class="avatar-container">
        <div class="avatar" onclick="document.getElementById('profilePhoto').click()">
          <img id="avatarImg" alt="Profile">
          <div id="avatarFallback">üë§</div>
        </div>
        <div class="avatar-edit" onclick="document.getElementById('profilePhoto').click()">üì∑</div>
      </div>

      <div class="profile-name" id="profileName">–ê—Ç—ã-–∂”©–Ω—ñ</div>
      <div class="profile-role">–ñ“Ø—Ä–≥—ñ–∑—É—à—ñ</div>
    </div>
  </div>

  <!-- Scrollable content -->
  <div class="content" id="content">
    <form id="updateForm" enctype="multipart/form-data">
      <div class="section">
        <div class="section-title">üë§ –ñ–µ–∫–µ –∞“õ–ø–∞—Ä–∞—Ç</div>
        <div class="field-row">
          <div class="field">
            <label class="field-label">–ê—Ç—ã</label>
            <input class="field-input" id="firstName" name="firstName" type="text" required />
          </div>
          <div class="field">
            <label class="field-label">–¢–µ–≥—ñ</label>
            <input class="field-input" id="lastName" name="lastName" type="text" required />
          </div>
        </div>
        <div class="field">
          <label class="field-label">–¢—É“ì–∞–Ω –∫“Ø–Ω—ñ</label>
          <input class="field-input" id="birthday" name="birthday" type="date" required disabled />
          <small style="font-size:11px;color:var(--text-muted);display:block;margin-top:4px">–¢—É“ì–∞–Ω –∫“Ø–Ω–¥—ñ ”©–∑–≥–µ—Ä—Ç—É –º“Ø–º–∫—ñ–Ω –µ–º–µ—Å</small>
        </div>
        <div class="field">
          <label class="field-label">–¢–µ–ª–µ—Ñ–æ–Ω –Ω”©–º—ñ—Ä—ñ</label>
          <input class="field-input" id="contactNumber" name="contactNumber" type="tel" placeholder="+7 (___) ___-__-__" required />
        </div>
      </div>

      <div class="section">
        <div class="section-title">üöö –ö”©–ª—ñ–∫ —Ç“Ø—Ä—ñ</div>
        <div class="truck-grid">
          <div class="truck-card" data-type="small"><div class="truck-icon">üöê</div><div class="truck-label">–ö—ñ—à—ñ</div></div>
          <div class="truck-card" data-type="medium"><div class="truck-icon">üöö</div><div class="truck-label">–û—Ä—Ç–∞</div></div>
          <div class="truck-card" data-type="large"><div class="truck-icon">üöõ</div><div class="truck-label">“Æ–ª–∫–µ–Ω</div></div>
          <div class="truck-card" data-type="refrigerator"><div class="truck-icon">‚ùÑÔ∏è</div><div class="truck-label">–†–µ—Ñ-—Ç–æ—Ä</div></div>
          <div class="truck-card" data-type="tow"><div class="truck-icon">üöó</div><div class="truck-label">–≠–≤–∞–∫—É–∞—Ç–æ—Ä</div></div>
        </div>
        <input type="hidden" id="truckType" name="truckType" required />
        <small style="font-size:11px;color:var(--text-muted);display:block;margin-top:8px">–ê“ì—ã–º–¥–∞“ì—ã: <span id="currentTruckType">---</span></small>
      </div>

      <div class="section">
        <div class="section-title">üìÑ “ö“±–∂–∞—Ç—Ç–∞—Ä</div>

        <div class="field">
          <label class="field-label">–ü—Ä–æ—Ñ–∏–ª—å —Ñ–æ—Ç–æ—Å—ã</label>
          <div class="upload-box" id="profilePhotoCard" onclick="document.getElementById('profilePhoto').click()">
            <div class="upload-icon">üì∏</div>
            <div class="upload-text">–§–æ—Ç–æ–Ω—ã –∂–∞“£–∞—Ä—Ç—É</div>
            <div class="upload-hint">”®–∑–≥–µ—Ä—Ç—É “Ø—à—ñ–Ω –±–∞—Å—ã“£—ã–∑</div>
          </div>
          <input id="profilePhoto" name="profilePhoto" type="file" accept="image/*" />
        </div>

        <div class="field">
          <label class="field-label">–ö—É”ô–ª—ñ–∫ (–∞–ª–¥—ã“£“ì—ã)</label>
          <div class="upload-box" id="licenseFrontCard" onclick="document.getElementById('licenseFront').click()">
            <div class="upload-icon">üÜî</div>
            <div class="upload-text">“ö“±–∂–∞—Ç—Ç—ã –∂–∞“£–∞—Ä—Ç—É</div>
            <div class="upload-hint">–ê–ª–¥—ã“£“ì—ã –∂–∞“ì—ã</div>
          </div>
          <input id="licenseFront" name="licenseFront" type="file" accept="image/*,.pdf" />
        </div>

        <div class="field">
          <label class="field-label">–ö—É”ô–ª—ñ–∫ (–∞—Ä—Ç“õ—ã)</label>
          <div class="upload-box" id="licenseBackCard" onclick="document.getElementById('licenseBack').click()">
            <div class="upload-icon">üÜî</div>
            <div class="upload-text">“ö“±–∂–∞—Ç—Ç—ã –∂–∞“£–∞—Ä—Ç—É</div>
            <div class="upload-hint">–ê—Ä—Ç“õ—ã –∂–∞“ì—ã</div>
          </div>
          <input id="licenseBack" name="licenseBack" type="file" accept="image/*,.pdf" />
        </div>
      </div>

      <div class="section">
        <div class="section-title">üìç –û—Ä–Ω–∞–ª–∞—Å“õ–∞–Ω –∂–µ—Ä</div>
        <div class="field">
          <label class="field-label">–ñ“±–º—ã—Å “õ–∞–ª–∞—Å—ã</label>
          <div class="location-row">
            <div class="location-input">
              <input class="field-input" id="startCity" name="startCity" type="text" placeholder="–ê–ª–º–∞—Ç—ã" required />
            </div>
            <button type="button" class="gps-btn" id="gpsButton" onclick="getCurrentLocation()">üìç</button>
          </div>
          <input type="hidden" id="latitude" name="latitude" />
          <input type="hidden" id="longitude" name="longitude" />
        </div>
      </div>

      <input type="hidden" id="telegramId" name="telegramId" />
    </form>
  </div>

  <!-- Bottom update button -->
  <div class="bottom-bar" id="bottomBar">
    <button class="btn btn-primary" type="button" id="updateBtn" onclick="updateProfile()">‚úÖ –ñ–∞“£–∞—Ä—Ç—É</button>
  </div>

  <!-- Bottom nav (–ü—Ä–æ—Ñ–∏–ª—å / –¢–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä / –°–∞–ø–∞—Ä) -->
  <nav class="bottom-nav" id="bottomNav">
    <button class="tab active" onclick="openProfile()">
      <div id="navAvatar" class="tab-icon tab-avatar">üë§</div>
      <div class="tab-label">–ü—Ä–æ—Ñ–∏–ª—å</div>
    </button>
    <button class="tab" onclick="openOrders()">
      <div class="tab-icon">üì¶</div>
      <div class="tab-label">–¢–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä</div>
    </button>
    <button class="tab" onclick="openSapar()">
      <div class="tab-icon">üöö</div>
      <div class="tab-label">–°–∞–ø–∞—Ä</div>
    </button>
  </nav>

  <script>
    const translations = {
      loading:'–ñ“Ø–∫—Ç–µ–ª—É–¥–µ...', success:'–°”ô—Ç—Ç—ñ', error:'“ö–∞—Ç–µ',
      updateSuccess:'–ü—Ä–æ—Ñ–∏–ª—å —Å”ô—Ç—Ç—ñ –∂–∞“£–∞—Ä—Ç—ã–ª–¥—ã', updateError:'–ñ–∞“£–∞—Ä—Ç—É–¥–∞ “õ–∞—Ç–µ',
      locationSuccess:'–û—Ä–Ω–∞–ª–∞—Å“õ–∞–Ω –∂–µ—Ä –∞–Ω—ã“õ—Ç–∞–ª–¥—ã', locationError:'–û—Ä—ã–Ω–¥—ã –∞–Ω—ã“õ—Ç–∞—É–¥–∞ “õ–∞—Ç–µ',
      fileTooBig:'–§–∞–π–ª —Ç—ã–º “Ø–ª–∫–µ–Ω (–º–∞–∫—Å. 5–ú–ë)', fillRequired:'–ë–∞—Ä–ª—ã“õ ”©—Ä—ñ—Å—Ç–µ—Ä–¥—ñ —Ç–æ–ª—Ç—ã—Ä—ã“£—ã–∑'
    };

    let currentLocation=null, originalData={};
    let userId=null;

    document.addEventListener('DOMContentLoaded', () => {
      initTelegram();
      setupTruckTypes();
      setupFileUploads();
      setupInputs();
      setTimeout(loadDriverProfile, 50);
    });

    function setAvatar(src){
      const img = document.getElementById('avatarImg');
      const fb  = document.getElementById('avatarFallback');
      if(!img || !fb) return;
      if(src){
        img.src=src;
        img.style.display='block';
        fb.style.display='none';
      }else{
        img.removeAttribute('src');
        img.style.display='none';
        fb.style.display='block';
      }
      setNavAvatar(src);
    }

    function setNavAvatar(src){
      const box=document.getElementById('navAvatar');
      if(!box) return;
      if(src){
        box.innerHTML =
          '<img src="'+src+'" alt="Avatar">';
      }else{
        box.textContent='üë§';
      }
    }

    function initTelegram(){
      const tg = window.Telegram?.WebApp;
      if(!tg){ applyLayoutSizes(); return; }

      tg.ready(); tg.expand(); tg.disableVerticalSwipes?.();
      if(tg.colorScheme==='dark') document.documentElement.setAttribute('data-theme','dark');
      tg.onEvent?.('themeChanged', ()=>document.documentElement.setAttribute('data-theme', tg.colorScheme));

      const applyVH = () => {
        const stable = tg.viewportStableHeight || window.visualViewport?.height || window.innerHeight;
        document.documentElement.style.setProperty('--tg-viewport-stable-height', stable + 'px');
        document.documentElement.style.setProperty('--tg-safe-area-inset-top',  (tg.safeAreaInset?.top||0) + 'px');
        document.documentElement.style.setProperty('--tg-safe-area-inset-bottom',(tg.safeAreaInset?.bottom||0) + 'px');
        applyLayoutSizes();
      };
      applyVH();
      tg.onEvent?.('viewportChanged', applyVH);
      window.addEventListener('resize', applyVH);
      window.addEventListener('orientationchange', applyVH);

      const user = tg.initDataUnsafe?.user;
      if(user){
        userId = user.id;
        document.getElementById('telegramId').value = user.id;
      }
      tg.BackButton?.hide?.();
    }

    function applyLayoutSizes(){
      const header = document.getElementById('topHeader');
      const prof   = document.getElementById('profileHeader');
      const bottom = document.getElementById('bottomBar');

      const headerH = header?.getBoundingClientRect().height || 56;
      prof.style.marginTop = headerH + 'px';

      const profileH = prof?.getBoundingClientRect().height || 140;
      const contentTop =
        (parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--tg-safe-area-inset-top')) || 0)
        + (parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--top-offset')) || 0)
        + headerH + profileH;

      document.documentElement.style.setProperty('--content-top', contentTop + 'px');

      const bottomH = bottom?.getBoundingClientRect().height || 100;
      const insetB  = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--tg-safe-area-inset-bottom')) || 0;
      const pad = Math.max(bottomH + 8, 90) + insetB;
      document.documentElement.style.setProperty('--content-bottom-pad', pad + 'px');
    }

    /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
    function openProfile(){
      if(!userId) return;
      location.href = `/driver-update?telegram_id=${userId}`;
    }
    function openOrders(){
      if(!userId) return;
      location.href = `/delivery-list?telegram_id=${userId}`;
    }
    function openSapar(){
      if(!userId) return;
      location.href = `/driver?telegram_id=${userId}`;
    }
    function goToDeliveryList(){ openOrders(); }
    function openDriverTrip(){ openSapar(); }

    function setupTruckTypes(){
      document.querySelectorAll('.truck-card').forEach(card=>{
        card.addEventListener('click', function(){
          document.querySelectorAll('.truck-card').forEach(c=>c.classList.remove('selected'));
          this.classList.add('selected');
          const t=this.dataset.type;
          document.getElementById('truckType').value=t;
          const names={small:'–ö—ñ—à—ñ', medium:'–û—Ä—Ç–∞', large:'“Æ–ª–∫–µ–Ω', refrigerator:'–†–µ—Ñ—Ä–∏–∂–µ—Ä–∞—Ç–æ—Ä', tow:'–≠–≤–∞–∫—É–∞—Ç–æ—Ä'};
          document.getElementById('currentTruckType').textContent=names[t]||t;
          window.Telegram?.WebApp?.HapticFeedback?.impactOccurred('light');
        });
      });
    }

    function setupFileUploads(){
      ['profilePhoto','licenseFront','licenseBack'].forEach(id=>{
        const el=document.getElementById(id);
        el?.addEventListener('change',e=>handleFileUpload(e,id));
      });
    }
    function handleFileUpload(e,id){
      const file=e.target.files?.[0];
      const card=document.getElementById(id+'Card');
      if(!file || !card) return;

      if(file.size>5*1024*1024){
        showToast('error',translations.fileTooBig);
        e.target.value=''; return;
      }

      if(file.type.startsWith('image/')){
        const r=new FileReader();
        r.onload=ev=>{
          card.classList.add('has-file');
          card.innerHTML=`
            <img src="${ev.target.result}" class="file-preview" alt="Preview">
            <div class="upload-text">${file.name}</div>
            <div class="upload-hint">${(file.size/1024/1024).toFixed(1)} MB</div>`;
          if(id==='profilePhoto'){
            setAvatar(ev.target.result);
            applyLayoutSizes();
          }
        };
        r.readAsDataURL(file);
      }else{
        card.classList.add('has-file');
        card.innerHTML=`
          <div class="upload-icon">üìÑ</div>
          <div class="upload-text">${file.name}</div>
          <div class="upload-hint">${(file.size/1024/1024).toFixed(1)} MB</div>`;
      }

      window.Telegram?.WebApp?.HapticFeedback?.notificationOccurred('success');
    }

    function setupInputs(){
      const phone=document.getElementById('contactNumber');
      phone?.addEventListener('input', (e)=>{
        let v=e.target.value.replace(/\D/g,'');
        if(v && !v.startsWith('7')) v='7'+v;
        let out='+7';
        if(v.length>1){
          out+=' ('+v.slice(1,4);
          if(v.length>4){
            out+=') '+v.slice(4,7);
            if(v.length>7){
              out+='-'+v.slice(7,9);
              if(v.length>9){ out+='-'+v.slice(9,11); }
            } else out+=')';
          }
        }
        e.target.value = out;
      });

      new ResizeObserver(applyLayoutSizes).observe(document.getElementById('bottomBar'));
      new ResizeObserver(applyLayoutSizes).observe(document.getElementById('profileHeader'));
    }

    function getCurrentLocation(){
      const btn=document.getElementById('gpsButton');
      const input=document.getElementById('startCity');
      btn.classList.add('loading'); btn.textContent='‚è≥';
      if(!navigator.geolocation){ handleLocationError(); return; }
      navigator.geolocation.getCurrentPosition(pos=>{
        const lat=pos.coords.latitude, lon=pos.coords.longitude;
        currentLocation={lat,lon};
        document.getElementById('latitude').value=lat;
        document.getElementById('longitude').value=lon;
        reverseGeocode(lat,lon).then(addr=>{
          input.value=addr;
          btn.classList.remove('loading'); btn.classList.add('success'); btn.textContent='‚úÖ';
          showToast('success',translations.locationSuccess);
          window.Telegram?.WebApp?.HapticFeedback?.notificationOccurred('success');
        }).catch(()=>{
          input.value=`${lat.toFixed(6)}, ${lon.toFixed(6)}`;
          btn.classList.remove('loading'); btn.classList.add('success'); btn.textContent='‚úÖ';
          showToast('success',translations.locationSuccess);
        });
      }, ()=>handleLocationError(), {enableHighAccuracy:true,timeout:10000,maximumAge:0});
    }
    function handleLocationError(){
      const btn=document.getElementById('gpsButton');
      btn.classList.remove('loading'); btn.textContent='üìç';
      showToast('error',translations.locationError);
      window.Telegram?.WebApp?.HapticFeedback?.notificationOccurred('error');
    }
    async function reverseGeocode(lat,lon){
      const res=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1&accept-language=kk`);
      const data=await res.json();
      return (data.address?.city||data.address?.town||data.address?.village||data.display_name||`${lat.toFixed(6)}, ${lon.toFixed(6)}`);
    }

    async function loadDriverProfile(){
      const overlay=document.getElementById('loadingOverlay');
      overlay.classList.add('show');
      try{
        const telegramId=document.getElementById('telegramId').value;
        if(!telegramId) throw new Error('Telegram ID –∂–æ“õ');
        const resp=await fetch('/api/check/who', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body:JSON.stringify({telegram_id:parseInt(telegramId)})
        });
        if(!resp.ok) throw new Error('HTTP: '+resp.status);
        const payload=await resp.json();
        if(payload.success && payload.data?.exists && payload.data.user_type==='driver'){
          originalData={...payload.data.driver_data};
          populateForm(payload.data.driver_data);
        }else{
          throw new Error('–ñ“Ø—Ä–≥—ñ–∑—É—à—ñ —Ç–∞–±—ã–ª–º–∞–¥—ã');
        }
      }catch(e){
        console.error(e);
        showToast('error', translations.error + ': ' + e.message);
      }finally{
        overlay.classList.remove('show');
        applyLayoutSizes();
      }
    }

    function populateForm(d){
      if(d.first_name) document.getElementById('firstName').value=d.first_name;
      if(d.last_name)  document.getElementById('lastName').value=d.last_name;
      if(d.birthday){
        const b=document.getElementById('birthday');
        b.value=d.birthday; b.disabled=true;
      }
      if(d.contact_number) document.getElementById('contactNumber').value=d.contact_number;
      if(d.start_city) document.getElementById('startCity').value=d.start_city;

      if(d.truck_type){
        document.getElementById('truckType').value=d.truck_type;
        const card=document.querySelector(`.truck-card[data-type="${d.truck_type}"]`);
        card?.classList.add('selected');
        const names={small:'–ö—ñ—à—ñ', medium:'–û—Ä—Ç–∞', large:'“Æ–ª–∫–µ–Ω', refrigerator:'–†–µ—Ñ—Ä–∏–∂–µ—Ä–∞—Ç–æ—Ä', tow:'–≠–≤–∞–∫—É–∞—Ç–æ—Ä'};
        document.getElementById('currentTruckType').textContent=names[d.truck_type]||d.truck_type;
      }

      if(d.latitude){ document.getElementById('latitude').value=d.latitude; }
      if(d.longitude){ document.getElementById('longitude').value=d.longitude; }

      const files=[
        {id:'profilePhoto', db:'profile_photo', base:'/ava/'},
        {id:'licenseFront', db:'license_front', base:'/documents/'},
        {id:'licenseBack',  db:'license_back',  base:'/documents/'}
      ];
      files.forEach(f=>{
        const card=document.getElementById(f.id+'Card');
        if(d[f.db]){
          const url=f.base + d[f.db];
          card?.classList.add('has-file');
          if(f.id==='profilePhoto'){
            setAvatar(url);
            if(card){
              card.innerHTML=`<img src="${url}" class="file-preview" alt="Profile">
                               <div class="upload-text">–ü—Ä–æ—Ñ–∏–ª—å —Ñ–æ—Ç–æ—Å—ã</div>
                               <div class="upload-hint">”®–∑–≥–µ—Ä—Ç—É “Ø—à—ñ–Ω –±–∞—Å—ã“£—ã–∑</div>`;
            }
          }else if(card){
            card.innerHTML=`<img src="${url}" class="file-preview" alt="License">
                             <div class="upload-text">“ö“±–∂–∞—Ç</div>
                             <div class="upload-hint">”®–∑–≥–µ—Ä—Ç—É “Ø—à—ñ–Ω –±–∞—Å—ã“£—ã–∑</div>`;
          }
        }else if(f.id==='profilePhoto'){
          setAvatar(null);
        }
      });

      const full=[d.first_name,d.last_name].filter(Boolean).join(' ')||'–ê—Ç—ã-–∂”©–Ω—ñ';
      document.getElementById('profileName').textContent=full;

      const statusMap={
        pending:{icon:'‚è≥',text:'“ö–∞—Ä–∞—É–¥–∞'},
        approved:{icon:'‚úÖ',text:'–ú–∞“õ“±–ª–¥–∞–Ω“ì–∞–Ω'},
        rejected:{icon:'‚ùå',text:'“ö–∞–±—ã–ª–¥–∞–Ω–±–∞“ì–∞–Ω'}
      };
      if(d.status && statusMap[d.status]){
        document.getElementById('statusBadge').innerHTML =
          statusMap[d.status].icon + ' ' + statusMap[d.status].text;
      }
    }

    async function updateProfile(){
      const btn=document.getElementById('updateBtn');
      const firstName=document.getElementById('firstName').value.trim();
      const lastName=document.getElementById('lastName').value.trim();
      const contactNumber=document.getElementById('contactNumber').value.trim();
      const startCity=document.getElementById('startCity').value.trim();
      const truckType=document.getElementById('truckType').value;

      if(!firstName||!lastName||!contactNumber||!startCity||!truckType){
        showToast('error',translations.fillRequired);
        window.Telegram?.WebApp?.HapticFeedback?.notificationOccurred('error');
        return;
      }
      btn.classList.add('btn-loading'); btn.disabled=true;
      try{
        const fd=new FormData(document.getElementById('updateForm'));
        const resp=await fetch('/api/driver/update',{method:'POST',body:fd});
        if(!resp.ok) throw new Error('HTTP: '+resp.status);
        const res=await resp.json();
        if(res.success){
          showToast('success',translations.updateSuccess);
          window.Telegram?.WebApp?.HapticFeedback?.notificationOccurred('success');
          setTimeout(loadDriverProfile, 800);
        }else{
          throw new Error(res.message||'Fail');
        }
      }catch(e){
        console.error(e);
        showToast('error',translations.updateError);
        window.Telegram?.WebApp?.HapticFeedback?.notificationOccurred('error');
      }finally{
        btn.classList.remove('btn-loading'); btn.disabled=false;
      }
    }

    function showToast(type,msg){
      const t=document.createElement('div');
      t.className='toast '+type;
      t.textContent=msg;
      document.body.appendChild(t);
      getComputedStyle(t).opacity;
      t.classList.add('show');
      setTimeout(()=>{
        t.classList.remove('show');
        setTimeout(()=>t.remove(),250);
      }, 2800);
    }
  </script>
</body>
</html>
