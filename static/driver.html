<!DOCTYPE html>
<html lang="kz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Driver ‚Ä¢ –ñ“Ø—Ä–≥—ñ–∑—É—à—ñ</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#f7f7f8; --surface:#fff;
      --ink:#0f172a; --ink-2:#475569; --ink-3:#94a3b8;
      --muted:#e2e8f0; --brand:#00d4aa; --danger:#ef4444;

      --r-lg:20px; --r-md:14px; --r-sm:10px;
      --shadow-sm:0 2px 8px rgba(0,0,0,.06);
      --shadow-md:0 10px 30px rgba(0,0,0,.10);

      --page-px:16px; --row-h:64px;

      /* –æ—Ç—Å—Ç—É–ø –æ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ –º–∏–Ω–∏-–∞–ø–ø–∞ */
      --sys-pad:48px;
      --bottom-ui:140px; /* CTA + bottom nav –≤—ã—Å–æ—Ç–∞ */
    }
    @media (prefers-color-scheme:dark){
      :root{
        --bg:#111214; --surface:#15171a;
        --ink:#f8fafc; --ink-2:#cbd5e1; --ink-3:#64748b;
        --muted:#23262b;
        --shadow-sm:0 2px 8px rgba(0,0,0,.4);
        --shadow-md:0 10px 30px rgba(0,0,0,.5);
      }
    }

    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    html,body{height:100%;}
    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family:-apple-system,BlinkMacSystemFont,'SF Pro','Helvetica Neue',Roboto,Arial,sans-serif;

      /* —Ä–µ–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ web-app‚Äô–∞ */
      height: var(--tg-viewport-stable-height, 100vh);
      overflow-x:hidden;
      overscroll-behavior:none;
      -webkit-overflow-scrolling:touch;

      /* –æ–ø—É—Å–∫–∞–µ–º –í–°–Å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –Ω–∏–∂–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –±–∞—Ä–∞ + –Ω–∞—à–µ–≥–æ —Ö–µ–¥–µ—Ä–∞ */
      padding-top: calc(
        var(--tg-safe-area-inset-top, 0px)
        + var(--tg-content-safe-area-inset-top, 0px)
        + 64px          /* –ø—Ä–∏–º–µ—Ä–Ω–∞—è –≤—ã—Å–æ—Ç–∞ .header */
      );

      /* –ø—Ä–æ—Å—Ç–æ safe-area —Å–Ω–∏–∑—É, –±–µ–∑ –ª–∏—à–Ω–∏—Ö –æ—Ç—Å—Ç—É–ø–æ–≤ */
      padding-bottom: env(safe-area-inset-bottom, 0px);
    }

    /* HEADER */
    .header{
      position:fixed;
      left:0;
      right:0;

      /* —Å—Ç–∞–≤–∏–º —Å–∞–º header –ø–æ–¥ —Å–∏—Å—Ç–µ–º–Ω—ã–π –±–∞—Ä Telegram */
      top: calc(
        var(--tg-safe-area-inset-top, 0px)
        + var(--tg-content-safe-area-inset-top, 0px)
      );

      z-index:50;
      background:var(--surface);
      border-bottom:1px solid var(--muted);
      padding:12px var(--page-px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      backdrop-filter:blur(12px);
      -webkit-backdrop-filter:blur(12px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:700;
      letter-spacing:.2px;
    }
    .brand-badge{
      width:28px;height:28px;border-radius:8px;
      background:var(--brand);color:#fff;
      display:grid;place-items:center;
      font-weight:800;
      box-shadow:var(--shadow-sm);
    }
    .controls{display:flex;align-items:center;gap:10px;}
    .chip{
      display:flex;align-items:center;gap:6px;
      font-size:12px;font-weight:700;
      padding:6px 10px;border-radius:999px;
      background:#eafaf7;color:#16a34a;
    }
    .chip.off{background:#f1f5f9;color:var(--ink-2);}
    .dot{width:6px;height:6px;border-radius:50%;background:currentColor;}
    .lang{
      display:flex;gap:2px;
      background:#f1f5f9;
      padding:2px;
      border-radius:999px;
    }
    .lang button{
      border:0;background:transparent;
      padding:6px 10px;border-radius:999px;
      font-weight:700;color:var(--ink-2);
      cursor:pointer;
    }
    .lang button.active{
      background:var(--surface);
      color:var(--ink);
      box-shadow:var(--shadow-sm);
    }

    /* Card */
    .card{
      background:var(--surface);
      margin:12px var(--page-px);
      border-radius:var(--r-lg);
      border:1px solid var(--muted);
      overflow:hidden;
      box-shadow:var(--shadow-sm);
    }

    /* Rows */
    .row{
      display:flex;
      align-items:center;
      gap:12px;
      padding:14px;
      min-height:var(--row-h);
    }
    .row + .row{border-top:1px solid var(--muted);}
    .row:active{background:rgba(0,0,0,.03);}
    .pin{width:14px;height:14px;border-radius:50%;flex:0 0 14px;}
    .pin.from{background:var(--brand);box-shadow:0 0 0 4px rgba(16,224,184,.15);}
    .pin.to{background:var(--ink);}
    .col{flex:1;min-width:0;}
    .label{
      font-size:11px;text-transform:uppercase;
      letter-spacing:.5px;color:var(--ink-3);
      margin-bottom:4px;font-weight:800;
    }
    .value{
      font-size:16px;line-height:1.3;
      font-weight:600;color:var(--ink);
    }
    .value.placeholder{color:var(--ink-3);font-weight:500;}
    .trailing{
      width:36px;height:36px;border-radius:999px;
      border:0;background:#f3f4f6;color:var(--ink-2);
      display:grid;place-items:center;
      cursor:pointer;
    }

    .icon{
      width:40px;height:40px;border-radius:12px;
      background:#f3f4f6;
      display:grid;place-items:center;
      font-size:18px;flex:0 0 40px;
    }
    .input{
      width:100%;border:0;outline:none;
      background:transparent;
      font-size:16px;font-weight:600;color:var(--ink);
    }
    .input::placeholder{color:var(--ink-3);font-weight:500;}
    .textarea{
      width:100%;min-height:88px;max-height:220px;
      resize:vertical;border:0;outline:none;
      background:transparent;font-size:16px;color:var(--ink);
    }

    /* CTA (green button) */
    .page-footer{
      position:fixed;
      left:0;
      right:0;

      /* –ø–æ–¥–Ω–∏–º–∞–µ–º –∫–Ω–æ–ø–∫—É —á—É—Ç—å –≤—ã—à–µ bottom-nav */
      bottom: calc(
        88px                       /* –±—ã–ª–æ 68px ‚Äì —Å—Ç–∞–ª –±–æ–ª—å—à–∏–π –∑–∞–∑–æ—Ä */
        + env(safe-area-inset-bottom, 0px)
      );

      padding:0 var(--page-px) 12px;
      z-index:40;
    }

    .cta{
      width:100%;
      min-height:52px;
      border-radius:16px;
      border:0;
      background:var(--brand);
      color:#fff;
      font-weight:800;
      font-size:16px;
      box-shadow:var(--shadow-md);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      cursor:pointer;
      transition:opacity .15s ease, transform .1s ease;
    }
    .cta:active{transform:scale(.98);}
    .cta.disabled{
      opacity:.4;
      cursor:default;
      box-shadow:none;
      transform:none;
    }

    /* Bottom nav */
    .bottom-nav{
      position:fixed;
      left:0; right:0;
      bottom:0;
      padding:8px 12px calc(8px + env(safe-area-inset-bottom,0px));
      background:var(--surface);
      border-top:1px solid var(--muted);
      display:flex;
      justify-content:space-between;
      gap:8px;
      z-index:39;
    }
    .tab{
      flex:1;
      border:0;
      background:transparent;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      padding:6px 4px;
      border-radius:999px;
      cursor:pointer;
      color:var(--ink-2);
      font-size:11px;
      font-weight:600;
    }
    .tab-icon{
      width:34px;height:34px;border-radius:999px;
      display:grid;place-items:center;
      background:#f3f4f6;
      box-shadow:var(--shadow-sm);
      font-size:18px;
    }
    /* —É–∂–µ –µ—Å—Ç—å .tab-icon ‚Äì –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞ –≤–∞–∂–Ω–æ –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –≤–æ—Ç —ç—Ç–æ */
#navAvatar{
  width:34px;
  height:34px;
  border-radius:999px;
  overflow:hidden;        /* —á—Ç–æ–±—ã —Ñ–æ—Ç–æ –Ω–µ –≤—ã–ª–µ–∑–∞–ª–æ */
  display:flex;
  align-items:center;
  justify-content:center;
}

/* —Å–∞–º–æ —Ñ–æ—Ç–æ */
#navAvatar img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
}

    .tab-avatar{
      overflow:hidden;
    }
    .tab-avatar img{
      width:100%;height:100%;object-fit:cover;border-radius:999px;
    }
    .tab.active{
      background:#0f172a;
      color:#fff;
    }
    .tab.active .tab-icon{
      background:#111827;
      color:#fff;
      box-shadow:none;
    }

    /* Fullscreen picker */
    .modal{
      position:fixed;
      inset:0;
      top:calc(var(--tg-content-safe-area-inset-top,0px) + env(safe-area-inset-top,0px) + var(--sys-pad));
      background:var(--surface);
      display:none;
      flex-direction:column;
      z-index:1000;
    }
    .modal.show{
      display:flex;
      animation:rise .25s ease-out;
    }
    @keyframes rise{
      from{transform:translateY(10%);opacity:.6;}
      to{transform:none;opacity:1;}
    }

    .m-head{
      position:sticky;top:0;z-index:5;
      background:var(--surface);
      border-bottom:1px solid var(--muted);
      padding:10px var(--page-px);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .back{
      width:36px;height:36px;border-radius:999px;
      border:0;background:#f3f4f6;color:var(--ink);
      display:grid;place-items:center;
      cursor:pointer;
    }
    .search-wrap{position:relative;flex:1;}
    .search{
      width:100%;
      border:1px solid var(--muted);
      border-radius:12px;
      padding:12px 40px 12px 12px;
      background:#f8fafc;
      font-size:16px;
      outline:none;
    }
    .clear{
      position:absolute;
      right:6px;top:50%;
      transform:translateY(-50%);
      width:28px;height:28px;
      border:0;border-radius:999px;
      background:#e2e8f0;
      display:none;
      cursor:pointer;
    }
    .clear.show{display:block;}

    .map{position:relative;flex:1;min-height:0;}
    #map{position:absolute;inset:0;}
    .center-pin{
      position:absolute;
      left:50%;top:50%;
      transform:translate(-50%,-100%);
      pointer-events:none;
      z-index:4;
    }
    .center-pin .b{
      width:32px;height:32px;border-radius:50%;
      background:#ef4444;
      border:4px solid #fff;
      box-shadow:0 6px 20px rgba(239,68,68,.35);
      display:grid;place-items:center;
      color:#fff;font-weight:800;
      transition:transform .15s ease;
    }

    .results{
      max-height:40vh;
      overflow:auto;
      border-top:1px solid var(--muted);
    }
    .empty{padding:28px;text-align:center;color:var(--ink-2);}
    .item{
      display:flex;
      gap:12px;
      padding:12px var(--page-px);
      border-bottom:1px solid var(--muted);
      cursor:pointer;
    }
    .item:last-child{border-bottom:0;}
    .ind{width:10px;height:10px;border-radius:50%;background:var(--brand);margin-top:6px;}
    .t{font-weight:700;}
    .s{font-size:14px;color:var(--ink-2);}

    .actions{
      display:flex;
      gap:10px;
      padding:12px var(--page-px) calc(12px + env(safe-area-inset-bottom,0px));
      border-top:1px solid var(--muted);
      background:var(--surface);
    }
    .btn{
      flex:1;
      min-height:52px;
      border-radius:14px;
      border:0;
      font-weight:800;
      font-size:15px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      cursor:pointer;
    }
    .btn.sec{background:#f3f4f6;color:var(--ink);}
    .btn.pri{background:var(--brand);color:#fff;}

    .leaflet-control-attribution,
    .leaflet-control-zoom{display:none!important;}
  </style>
</head>
<body>
  <!-- HEADER -->
  <div class="header">
    <div class="brand">
      <div class="brand-badge">D</div>
      Driver
    </div>
    <div class="controls">
      <div class="chip off" id="chip">
        <span class="dot"></span><span id="chipText">–ñ–µ–ª—ñ–¥–µ –µ–º–µ—Å</span>
      </div>
      <div class="lang">
        <button id="btn-ru" onclick="setLang('ru')">RU</button>
        <button id="btn-kz" class="active" onclick="setLang('kz')">KZ</button>
      </div>
    </div>
  </div>

  <!-- MAIN CARD -->
  <div class="card">
    <div class="row" onclick="openPicker('from')">
      <div class="pin from"></div>
      <div class="col">
        <div class="label" data-ru="–û–¢–ö–£–î–ê" data-kz="“ö–ê–ô–î–ê–ù">“ö–ê–ô–î–ê–ù</div>
        <div class="value placeholder" id="fromText"
             data-ru="–¢–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ"
             data-kz="–ê“ì—ã–º–¥–∞“ì—ã –æ—Ä–Ω–∞–ª–∞—Å—É">–ê“ì—ã–º–¥–∞“ì—ã –æ—Ä–Ω–∞–ª–∞—Å—É</div>
      </div>
      <button class="trailing"
              onclick="event.stopPropagation();openPicker('from')">üìç</button>
    </div>

    <div class="row" onclick="openPicker('to')">
      <div class="pin to"></div>
      <div class="col">
        <div class="label" data-ru="–ö–£–î–ê" data-kz="“ö–ê–ô–î–ê">“ö–ê–ô–î–ê</div>
        <div class="value placeholder" id="toText"
             data-ru="–í—ã–±–µ—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è"
             data-kz="–ú–∞“õ—Å–∞—Ç—Ç—ã —Ç–∞“£–¥–∞“£—ã–∑">–ú–∞“õ—Å–∞—Ç—Ç—ã —Ç–∞“£–¥–∞“£—ã–∑</div>
      </div>
      <button class="trailing"
              onclick="event.stopPropagation();openPicker('to')">üìç</button>
    </div>

    <div class="row">
      <div class="icon">üí∞</div>
      <div class="col">
        <div class="label" data-ru="–°–¢–û–ò–ú–û–°–¢–¨" data-kz="“ö“∞–ù–´">“ö“∞–ù–´</div>
        <input id="price" class="input" type="number" min="2000" placeholder="2000">
      </div>
      <div style="font-weight:800;color:var(--ink-2);">‚Ç∏</div>
    </div>

    <div class="row">
      <div class="icon">‚è∞</div>
      <div class="col">
        <div class="label" data-ru="–í–†–ï–ú–Ø –û–¢–ü–†–ê–í–õ–ï–ù–ò–Ø" data-kz="–ñ”®–ù–ï–õ–£ –£–ê“ö–´–¢–´">–ñ”®–ù–ï–õ–£ –£–ê“ö–´–¢–´</div>
        <input id="time" class="input" type="datetime-local">
      </div>
    </div>

    <div class="row" style="align-items:flex-start">
      <div class="icon">üí¨</div>
      <div class="col">
        <div class="label" data-ru="–ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô" data-kz="–¢“Æ–°–Ü–ù–Ü–ö–¢–ï–ú–ï">–¢“Æ–°–Ü–ù–Ü–ö–¢–ï–ú–ï</div>
        <textarea id="comment" class="textarea"
                  data-ru="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (—Ä–∞–∑–º–µ—Ä –≥—Ä—É–∑–∞, –æ—Å–æ–±—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è, –∫–æ–Ω—Ç–∞–∫—Ç—ã)"
                  data-kz="“ö–æ—Å—ã–º—à–∞ –∞“õ–ø–∞—Ä–∞—Ç (–∂“Ø–∫ ”©–ª—à–µ–º—ñ, –µ—Ä–µ–∫—à–µ —Ç–∞–ª–∞–ø—Ç–∞—Ä, –±–∞–π–ª–∞–Ω—ã—Å –¥–µ—Ä–µ–∫—Ç–µ—Ä—ñ)"
                  placeholder="“ö–æ—Å—ã–º—à–∞ –∞“õ–ø–∞—Ä–∞—Ç (–∂“Ø–∫ ”©–ª—à–µ–º—ñ, –µ—Ä–µ–∫—à–µ —Ç–∞–ª–∞–ø—Ç–∞—Ä, –±–∞–π–ª–∞–Ω—ã—Å –¥–µ—Ä–µ–∫—Ç–µ—Ä—ñ)"></textarea>
      </div>
    </div>
  </div>

  <!-- GREEN CTA BUTTON -->
  <div class="page-footer">
    <button id="createTripBtn" class="cta disabled">
      <span data-ru="–°–æ–∑–¥–∞—Ç—å –ø–æ–µ–∑–¥–∫—É" data-kz="–°–∞–ø–∞—Ä“ì–∞ —à—ã“ì—É">–°–∞–ø–∞—Ä“ì–∞ —à—ã“ì—É</span>
    </button>
  </div>

  <!-- BOTTOM NAV BAR (–ü—Ä–æ—Ñ–∏–ª—å / –ó–∞–∫–∞–∑—ã / –°–∞–ø–∞—Ä) -->
  <nav class="bottom-nav">
    <button class="tab" onclick="openProfile()">
      <div id="navAvatar" class="tab-icon tab-avatar">üë§</div>
      <div class="tab-label" data-ru="–ü—Ä–æ—Ñ–∏–ª—å" data-kz="–ü—Ä–æ—Ñ–∏–ª—å">–ü—Ä–æ—Ñ–∏–ª—å</div>
    </button>
    <button class="tab" onclick="openOrders()">
      <div class="tab-icon">üì¶</div>
      <div class="tab-label" data-ru="–ó–∞–∫–∞–∑—ã" data-kz="–¢–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä">–ó–∞–∫–∞–∑—ã</div>
    </button>
    <button class="tab active" onclick="openSapar()">
      <div class="tab-icon">üöö</div>
      <div class="tab-label" data-ru="–°–∞–ø–∞—Ä" data-kz="–°–∞–ø–∞—Ä">–°–∞–ø–∞—Ä</div>
    </button>
  </nav>

  <!-- FULLSCREEN PICKER (MAP) -->
  <div class="modal" id="picker">
    <div class="m-head">
      <button class="back" onclick="closePicker()">‚Üê</button>
      <div class="search-wrap">
        <input id="search" class="search" type="text"
               placeholder="–ú–µ–∫–µ–Ω–∂–∞–π —ñ–∑–¥–µ—É"
               data-ru="–ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞"
               data-kz="–ú–µ–∫–µ–Ω–∂–∞–π —ñ–∑–¥–µ—É"
               oninput="debouncedSearch(this.value)">
        <button id="clear" class="clear" onclick="clearSearch()">√ó</button>
      </div>
    </div>

    <div class="map">
      <div id="map"></div>
      <div class="center-pin"><div class="b">üìç</div></div>
    </div>

    <div class="results" id="results">
      <div class="empty" id="emptyHint">
        –û—Ä–Ω–∞–ª–∞—Å—É–¥—ã —Ç–∞“£–¥–∞—É “Ø—à—ñ–Ω –∫–∞—Ä—Ç–∞–Ω—ã –∂—ã–ª–∂—ã—Ç—ã“£—ã–∑ –Ω–µ–º–µ—Å–µ —ñ–∑–¥–µ—É–¥—ñ –ø–∞–π–¥–∞–ª–∞–Ω—ã“£—ã–∑
      </div>
    </div>

    <div class="actions">
      <button class="btn sec" onclick="useMe()">
        <span>üìç</span>
        <span data-ru="–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ" data-kz="–ú–µ–Ω—ñ“£ –æ—Ä–Ω—ã–º">–ú–µ–Ω—ñ“£ –æ—Ä–Ω—ã–º</span>
      </button>
      <button class="btn pri" onclick="confirmCenter()">
        <span>‚úì</span>
        <span data-ru="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å" data-kz="–†–∞—Å—Ç–∞—É">–†–∞—Å—Ç–∞—É</span>
      </button>
    </div>
  </div>

  <script>
    // ===== STATE =====
    let tg=null, currentLang='kz';
    let fromCoord=null, toCoord=null, fromText='', toText='';
    let map=null, userPos=null, markerMe=null, watcher=null;
    let picking=null, debounceTimer=null;
    let userId=null;

    const dict = {
      ru:{
        online:'–í —Å–µ—Ç–∏',
        offline:'–ù–µ –≤ —Å–µ—Ç–∏',
        create:'–°–æ–∑–¥–∞—Ç—å –ø–æ–µ–∑–¥–∫—É',
        opening:'–û—Ç–∫—Ä—ã–≤–∞—é‚Ä¶',
        err:'–û—à–∏–±–∫–∞',
        fill:'–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è',
        min:'–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ 2000 ‚Ç∏',
        hint:'–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∫–∞—Ä—Ç—É –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–∏—Å–∫',
        searching:'–ü–æ–∏—Å–∫‚Ä¶',
        nothing:'–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'
      },
      kz:{
        online:'–ñ–µ–ª—ñ–¥–µ',
        offline:'–ñ–µ–ª—ñ–¥–µ –µ–º–µ—Å',
        create:'–°–∞–ø–∞—Ä“ì–∞ —à—ã“ì—É',
        opening:'–ê—à—É‚Ä¶',
        err:'“ö–∞—Ç–µ',
        fill:'–ë–∞—Ä–ª—ã“õ –º—ñ–Ω–¥–µ—Ç—Ç—ñ ”©—Ä—ñ—Å—Ç–µ—Ä–¥—ñ —Ç–æ–ª—Ç—ã—Ä—ã“£—ã–∑',
        min:'–ï“£ —Ç”©–º–µ–Ω –±–∞“ì–∞—Å—ã 2000 ‚Ç∏',
        hint:'–ö–∞—Ä—Ç–∞–Ω—ã –∂—ã–ª–∂—ã—Ç—ã“£—ã–∑ –Ω–µ–º–µ—Å–µ —ñ–∑–¥–µ—É–¥—ñ –ø–∞–π–¥–∞–ª–∞–Ω—ã“£—ã–∑',
        searching:'–Ü–∑–¥–µ—É‚Ä¶',
        nothing:'–ï—à—Ç–µ“£–µ —Ç–∞–±—ã–ª–º–∞–¥—ã'
      }
    };

    // ===== INIT =====
    document.addEventListener('DOMContentLoaded', () => {
      if(window.Telegram?.WebApp){
        tg = Telegram.WebApp;
        tg.ready();
        tg.expand();
        tg.disableVerticalSwipes?.();
        const u = tg.initDataUnsafe?.user;
        if(u){
          userId = u.id;
          setOnline(true);
        }
        applyTheme();
      }

      setLang('kz');
      setNow5min();
      startGPS();
      validate();
      setInterval(checkStatus, 30000);

      document.getElementById('price').addEventListener('input', validate);
      document.getElementById('time').addEventListener('input', validate);
      document.getElementById('createTripBtn').addEventListener('click', createTrip);

      loadNavAvatar();
    });

    function applyTheme(){
      const p=tg?.themeParams || {};
      if(!p.bg_color) return;
      if(isDark(p.bg_color)) document.documentElement.style.colorScheme='dark';
    }
    function isDark(hex){
      const h=hex.replace('#','');
      const r=parseInt(h.slice(0,2),16),
            g=parseInt(h.slice(2,4),16),
            b=parseInt(h.slice(4,6),16);
      const l=(0.299*r+0.587*g+0.114*b)/255;
      return l<.5;
    }

    // ===== LANGUAGE =====
    function setLang(lang){
      currentLang = lang;
      document.getElementById('btn-ru').classList.toggle('active', lang==='ru');
      document.getElementById('btn-kz').classList.toggle('active', lang==='kz');

      document.querySelectorAll('[data-ru]').forEach(el => {
        const txt = el.getAttribute('data-'+lang);
        if(el.tagName==='INPUT' || el.tagName==='TEXTAREA'){
          if(txt) el.placeholder = txt;
        }else if(txt){
          el.textContent = txt;
        }
      });

      const chip=document.getElementById('chip');
      const chipText=document.getElementById('chipText');
      chipText.textContent = chip.classList.contains('off')
        ? dict[lang].offline
        : dict[lang].online;

      document.getElementById('emptyHint').textContent = dict[lang].hint;

      const ctaLabel = document.querySelector('#createTripBtn span');
      if(ctaLabel && ctaLabel.getAttribute('data-'+lang)){
        ctaLabel.textContent = ctaLabel.getAttribute('data-'+lang);
      }
    }

    function setOnline(on){
      const chip=document.getElementById('chip');
      const chipText=document.getElementById('chipText');
      chip.classList.toggle('off', !on);
      chipText.textContent = on ? dict[currentLang].online : dict[currentLang].offline;
    }

    // ===== FORM =====
    function setNow5min(){
      const n=new Date();
      n.setMinutes(Math.ceil(n.getMinutes()/5)*5,0,0);
      const pad=v=>String(v).padStart(2,'0');
      document.getElementById('time').value =
        `${n.getFullYear()}-${pad(n.getMonth()+1)}-${pad(n.getDate())}T${pad(n.getHours())}:${pad(n.getMinutes())}`;
    }

    function validate(){
      const p = document.getElementById('price').value;
      const tm = document.getElementById('time').value;
      const ok = fromCoord && toCoord && p && +p >= 2000 && tm;

      const btn = document.getElementById('createTripBtn');
      if(btn){
        btn.disabled = !ok;
        btn.classList.toggle('disabled', !ok);
      }
      return ok;
    }

    async function createTrip(){
      if(!validate()) return alertX(dict[currentLang].fill);
      if(+document.getElementById('price').value < 2000)
        return alertX(dict[currentLang].min);

      const btn=document.getElementById('createTripBtn');
      const labelSpan=btn.querySelector('span');
      const original=labelSpan.textContent;
      btn.disabled=true;
      btn.classList.add('disabled');
      labelSpan.textContent = dict[currentLang].opening;

      try{
        const fd=new FormData();
        fd.append('from_address', fromText);
        fd.append('from_lat', fromCoord[0]);
        fd.append('from_lon', fromCoord[1]);
        fd.append('to_address', toText);
        fd.append('to_lat', toCoord[0]);
        fd.append('to_lon', toCoord[1]);
        fd.append('price', document.getElementById('price').value);
        fd.append('start_time', document.getElementById('time').value);
        fd.append('comment', document.getElementById('comment').value);
        fd.append('telegram_id', userId || '0');

        const r = await fetch('/api/driver/start',{method:'POST',body:fd});
        const j = await r.json();
        if(!j.success) throw new Error(j.message || 'Unknown');

        tg?.HapticFeedback?.notificationOccurred('success');
        setTimeout(()=>{
          window.location.href = './delivery-list';
        }, 700);
      }catch(e){
        alertX(dict[currentLang].err + ': ' + e.message);
      }finally{
        labelSpan.textContent = original;
        btn.disabled = !validate();
        btn.classList.toggle('disabled', !validate());
      }
    }

    async function checkStatus(){
      try{
        if(!userId) return;
        const r = await fetch(`/api/driver/status?telegram_id=${userId}`);
        const j = await r.json();
        if(j.success) setOnline(!!j.is_online);
      }catch(_){}
    }

    function alertX(msg){
      if(tg) tg.showAlert(msg);
      else alert(msg);
    }

    // ===== NAV AVATAR =====
    async function loadNavAvatar(){
      try{
        if(!userId) return;
        const resp = await fetch('/api/check/who',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({telegram_id:parseInt(userId)})
        });
        const result = await resp.json();
        const box = document.getElementById('navAvatar');
        if(!box) return;

        if(result.success && result.data?.exists && result.data.user_type === 'driver'){
          const d = result.data.driver_data;
          if(d?.profile_photo?.trim()){
            const baseCandidates = [
              `./ava/${d.profile_photo}`,
              `/ava/${d.profile_photo}`,
              `/files/${d.profile_photo}`,
              `/static/ava/${d.profile_photo}`
            ];
            (function tryNext(i){
              if(i>=baseCandidates.length){ box.textContent='üë§'; return; }
              const img=new Image();
              img.onload=()=>{
                box.innerHTML=`<img src="${baseCandidates[i]}" alt="Avatar">`;
              };
              img.onerror=()=>tryNext(i+1);
              img.src=baseCandidates[i];
            })(0);
          }else{
            box.textContent='üë§';
          }
        }else{
          box.textContent='üë§';
        }
      }catch(_){
        const box=document.getElementById('navAvatar');
        if(box) box.textContent='üë§';
      }
    }

    function openProfile(){
      if(!userId) return;
      window.location.href = `/driver-update?telegram_id=${userId}`;
    }
    function openOrders(){
      if(!userId) return;
      window.location.href = `/delivery-list?telegram_id=${userId}`;
    }
    function openSapar(){
      if(!userId) return;
      window.location.href = `/driver?telegram_id=${userId}`;
    }

    // ===== PICKER / MAP =====
    function openPicker(mode){
      picking = mode;
      document.getElementById('picker').classList.add('show');
      setTimeout(initMap, 60);
    }

    function closePicker(){
      document.getElementById('picker').classList.remove('show');
      if(map){
        map.off();
        map.remove();
        map=null;
        markerMe=null;
      }
      clearSearch(true);
    }

    function initMap(){
      const center = userPos || [43.238949, 76.889709];
      map = L.map('map',{
        center,
        zoom:15,
        zoomControl:false,
        attributionControl:false,
        dragging:true,
        tap:true,
        touchZoom:true,
        scrollWheelZoom:true
      });
      L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',{maxZoom:19}).addTo(map);

      map.on('moveend', ()=>{ pulsePin(); });

      if(userPos) drawMe();
    }

    function pulsePin(){
      const el=document.querySelector('.center-pin .b');
      if(!el) return;
      el.style.transform='scale(1.1)';
      setTimeout(()=>{ el.style.transform='scale(1)'; },150);
    }

    function drawMe(){
      if(!map || !userPos) return;
      const icon = L.divIcon({
        html:'<div style="width:14px;height:14px;border-radius:50%;background:#1976d2;border:3px solid #fff;box-shadow:0 2px 10px rgba(0,0,0,.3)"></div>',
        className:'',
        iconSize:[14,14],
        iconAnchor:[7,7]
      });
      if(markerMe) markerMe.setLatLng(userPos);
      else markerMe = L.marker(userPos,{icon}).addTo(map);
    }

    function useMe(){
      if(userPos && map){
        map.setView(userPos,16);
        pulsePin();
      }
      tg?.HapticFeedback?.impactOccurred('light');
    }

    async function confirmCenter(){
      if(!map) return;
      const c = map.getCenter();
      const coords = [c.lat, c.lng];
      const text = await reverse(coords);

      if(picking === 'from'){
        fromCoord = coords;
        fromText  = text;
        const el = document.getElementById('fromText');
        el.textContent = text;
        el.classList.remove('placeholder');
      }else{
        toCoord = coords;
        toText  = text;
        const el = document.getElementById('toText');
        el.textContent = text;
        el.classList.remove('placeholder');
      }
      closePicker();
      validate();
      tg?.HapticFeedback?.notificationOccurred('success');
    }

    // ===== GPS =====
    function startGPS(){
      if(!navigator.geolocation) return;
      watcher = navigator.geolocation.watchPosition(
        p => {
          userPos = [p.coords.latitude, p.coords.longitude];
          if(!fromCoord && !fromText) setFromMe();
          if(map) drawMe();
        },
        _ => {},
        {enableHighAccuracy:true,maximumAge:0,timeout:10000}
      );
    }

    function setFromMe(){
      if(!userPos) return;
      reverse(userPos).then(txt=>{
        fromCoord = userPos;
        fromText  = txt;
        const el=document.getElementById('fromText');
        el.textContent = txt;
        el.classList.remove('placeholder');
        validate();
      });
    }

    // ===== SEARCH =====
    function debouncedSearch(q){
      const clear=document.getElementById('clear');
      clear.classList.toggle('show', q.length>0);
      clearTimeout(debounceTimer);

      if(!q || q.trim().length<2){
        showHint();
        return;
      }
      document.getElementById('results').innerHTML =
        `<div class="empty">${dict[currentLang].searching}</div>`;
      debounceTimer = setTimeout(()=>searchOSM(q.trim()), 450);
    }

    function clearSearch(keepHint){
      const s=document.getElementById('search');
      s.value='';
      document.getElementById('clear').classList.remove('show');
      if(!keepHint) showHint();
    }

    function showHint(){
      document.getElementById('results').innerHTML =
        `<div class="empty">${dict[currentLang].hint}</div>`;
    }

    function viewbox(){
      const c = map?.getCenter() || {lat:43.238949,lng:76.889709};
      const d = 0.45;
      return `${c.lng-d},${c.lat-d},${c.lng+d},${c.lat+d}`;
    }

    function langHeader(){
      return currentLang==='ru' ? 'ru-RU' : 'kk-KZ';
    }

    async function searchOSM(q){
      try{
        const vb = viewbox();
        const base = 'https://nominatim.openstreetmap.org';
        const common = `format=json&limit=15&addressdetails=1&countrycodes=kz&accept-language=${encodeURIComponent(langHeader())}&viewbox=${vb}&bounded=1`;
        const url1 = `${base}/search?${common}&q=${encodeURIComponent(q)}&extratags=1&namedetails=1`;
        const r1 = await fetch(url1);
        let results = await r1.json();

        if(!results || results.length===0){
          const url2 = `${base}/search?format=json&limit=15&addressdetails=1&q=${encodeURIComponent(q+', Kazakhstan')}&accept-language=${encodeURIComponent(langHeader())}`;
          const r2 = await fetch(url2);
          results = await r2.json();
        }

        const center = map?.getCenter() || {lat:43.238949,lng:76.889709};
        const typeWeight = t => {
          const order=['city','town','village','hamlet','suburb','neighbourhood','quarter','residential'];
          const i=order.indexOf(t||'');
          return i===-1?8:i;
        };
        const dist = (lat,lon)=>{
          const dx=(lat-center.lat)*111;
          const dy=(lon-center.lng)*85;
          return Math.hypot(dx,dy);
        };

        const uniq=new Map();
        for(const r of results){
          const k=`${r.lat},${r.lon}`;
          if(!uniq.has(k)) uniq.set(k,r);
        }

        const arr=[...uniq.values()]
          .map(r=>({
            name:(r.display_name||'').split(',')[0],
            full:r.display_name,
            lat:+r.lat, lon:+r.lon,
            type:r.type||r.class||'',
            score:typeWeight(r.type||'')*10 + dist(+r.lat,+r.lon)
          }))
          .sort((a,b)=>a.score-b.score)
          .slice(0,15);

        if(arr.length===0){
          document.getElementById('results').innerHTML =
            `<div class="empty">${dict[currentLang].nothing}</div>`;
          return;
        }

        document.getElementById('results').innerHTML = arr.map(a=>`
          <div class="item" onclick="choose(${a.lat},${a.lon}, '${escapeHtml(a.name)}')">
            <div class="ind"></div>
            <div>
              <div class="t">${escapeHtml(a.name)}</div>
              <div class="s">${escapeHtml(a.full.split(',').slice(1,4).join(', ').trim())}</div>
            </div>
          </div>
        `).join('');
      }catch(e){
        document.getElementById('results').innerHTML =
          `<div class="empty">${dict[currentLang].err}</div>`;
      }
    }

    function choose(lat,lon,name){
      if(map) map.setView([lat,lon],16);

      if(picking === 'from'){
        fromCoord=[lat,lon];
        fromText=name;
        const el=document.getElementById('fromText');
        el.textContent=name;
        el.classList.remove('placeholder');
      }else{
        toCoord=[lat,lon];
        toText=name;
        const el=document.getElementById('toText');
        el.textContent=name;
        el.classList.remove('placeholder');
      }
      closePicker();
      validate();
      tg?.HapticFeedback?.impactOccurred('light');
    }

    // ===== REVERSE GEOCODE =====
    async function reverse([lat,lon]){
      try{
        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1&accept-language=${encodeURIComponent(langHeader())}`;
        const r = await fetch(url);
        const j = await r.json();
        if(j?.display_name)
          return j.display_name.split(',').slice(0,4).join(', ');
        return `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
      }catch(_){
        return `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
      }
    }

    // ===== HELPERS =====
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m=>({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }

    window.addEventListener('beforeunload', () => {
      if(watcher) navigator.geolocation.clearWatch(watcher);
      if(map) map.remove();
    });
  </script>
</body>
</html>