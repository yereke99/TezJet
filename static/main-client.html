<!DOCTYPE html>
<html lang="kz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Alash Go ‚Äì –ö–ª–∏–µ–Ω—Ç</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg-primary: #000000;
      --bg-secondary: #ffffff;
      --bg-card: #f8f9fa;
      --bg-card-dark: #111111;
      --text-primary: #000000;
      --text-secondary: #666666;
      --text-muted: #999999;
      --text-white: #ffffff;
      --accent-primary: #000000;
      --accent-secondary: #007AFF;
      --border: #e5e5e5;
      --border-light: #f0f0f0;
      --shadow-subtle: 0 2px 8px rgba(0, 0, 0, 0.08);
      --shadow-medium: 0 4px 16px rgba(0, 0, 0, 0.12);
      --shadow-strong: 0 8px 32px rgba(0, 0, 0, 0.16);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;

      --tg-viewport-stable-height: 100vh;
      --tg-safe-area-inset-top: env(safe-area-inset-top, 0px);
      --tg-safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
      --tg-safe-area-inset-left: env(safe-area-inset-left, 0px);
      --tg-safe-area-inset-right: env(safe-area-inset-right, 0px);
      --tg-content-safe-area-inset-top: 0px;

      --bottom-nav-height: 72px;
    }

    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100vh; height: 100dvh; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Helvetica Neue", "Inter", sans-serif;
      background: var(--bg-secondary);
      color: var(--text-primary);
      position: fixed;
      inset: 0;
      width: 100%;
      height: var(--tg-viewport-stable-height, 100vh);
      padding-top: calc(
        var(--tg-safe-area-inset-top, 0px) +
        var(--tg-content-safe-area-inset-top, 0px) +
        12px
      );
      padding-bottom: calc(
        var(--bottom-nav-height) +
        max(10px, var(--tg-safe-area-inset-bottom, 0px))
      );
      padding-left: max(16px, var(--tg-safe-area-inset-left, 0px));
      padding-right: max(16px, var(--tg-safe-area-inset-right, 0px));
      overflow: hidden;
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
    }

    .background {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, rgba(0,0,0,0.05), transparent 55%),
                  var(--bg-secondary);
      z-index: -2;
    }
    .background::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(0,0,0,0.04) 0%, transparent 50%);
      z-index: -1;
    }

    .loading-overlay {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      background: var(--bg-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 24px;
      z-index: 9999;
      transition: opacity 0.25s ease, visibility 0.25s ease;
    }
    .loading-overlay.hidden { opacity:0; visibility:hidden; pointer-events:none; }

    .loading-spinner {
      width: 32px; height:32px; border-radius:50%;
      border: 2px solid var(--border-light);
      border-top: 2px solid var(--accent-primary);
      animation: spin 1s linear infinite;
    }
    .loading-text { font-size:15px; font-weight:500; color: var(--text-secondary); text-align:center; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .app-root {
      position: relative;
      height: 100%;
      max-width: 420px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      opacity: 0;
      transform: translateY(6px);
      transition: opacity 0.25s ease, transform 0.25s ease;
    }
    .app-root.visible { opacity:1; transform: translateY(0); }

    .top-bar {
      display:flex; align-items:center; justify-content:space-between;
      padding: 4px 2px 10px 2px; flex-shrink:0;
    }

    .logo-wrap { display:flex; align-items:center; gap:10px; }
    .logo-square {
      width:38px; height:38px; border-radius:14px;
      background: var(--accent-primary);
      display:flex; align-items:center; justify-content:center;
      color: var(--text-white);
      font-weight:800; font-size:20px; letter-spacing:-1px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.25);
    }
    .brand-info { display:flex; flex-direction:column; gap:2px; }
    .brand-title { font-size:18px; font-weight:700; letter-spacing:-0.3px; }
    .brand-subtitle { font-size:12px; color: var(--text-muted); }

    .user-pill {
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,0.04);
      display:flex; align-items:center; gap:6px;
      font-size:12px; color: var(--text-secondary);
      max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .user-avatar {
      width:24px; height:24px; border-radius:999px;
      background:#111; color:#fff;
      font-size:11px; font-weight:600;
      display:flex; align-items:center; justify-content:center;
      flex-shrink:0; overflow:hidden; position:relative;
    }
    .user-avatar img { width:100%; height:100%; object-fit:cover; display:none; }
    .user-avatar span { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; }

    .content-scroll {
      flex:1; min-height:0;
      overflow-y:auto;
      padding: 6px 2px 0 2px;
      -webkit-overflow-scrolling: touch;
    }
    .content-scroll::-webkit-scrollbar { width:0; height:0; }

    /* HERO */
    .hero-card {
      position: relative;
      border-radius: var(--radius-xl);
      background: radial-gradient(circle at top left, #1f2937 0%, #020617 45%, #000000 100%);
      color: var(--text-white);
      padding: 18px 16px 14px 16px;
      box-shadow: var(--shadow-strong);
      margin-bottom: 14px;
      overflow: hidden;
      display:flex; flex-direction:column; gap:10px;
    }

    .lang-switch {
      position:absolute;
      top:12px;
      right:12px;
      display:flex;
      background: rgba(15,23,42,0.9);
      border-radius:24px;
      padding:3px;
      border:1px solid rgba(148,163,184,0.6);
      box-shadow: 0 8px 18px rgba(0,0,0,0.35);
      z-index:5;
    }
    .lang-btn {
      background:transparent;
      border:none;
      border-radius:18px;
      padding:4px 12px;
      cursor:pointer;
      font-weight:700;
      font-size:11px;
      min-width:44px;
      color: rgba(226,232,240,0.78);
      transition: all 0.18s ease;
    }
    .lang-btn.active { background:#f9fafb; color:#020617; transform: scale(1.02); }
    .lang-btn:hover:not(.active) { background: rgba(148,163,184,0.25); color:#e5e7eb; }

    .hero-time {
      position:absolute;
      top:16px;
      right:110px;
      font-size:11px;
      color: rgba(255,255,255,0.78);
      letter-spacing: 0.2px;
    }

    .hero-badge-row {
      display:flex;
      justify-content:flex-start;
      align-items:center;
      margin-top: 26px;
      gap: 10px;
    }
    .pill-badge {
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background: rgba(255,255,255,0.08);
      font-size:11px; font-weight:600;
      border: 1px solid rgba(255,255,255,0.10);
    }
    .pill-dot {
      width:7px; height:7px; border-radius:50%;
      background:#22c55e;
      box-shadow: 0 0 0 3px rgba(34,197,94,0.35);
    }

    .hero-title { font-size:20px; font-weight:800; letter-spacing:-0.5px; margin-top:2px; }
    .hero-subtitle { font-size:13px; color: rgba(255,255,255,0.82); max-width:300px; line-height:1.35; }

    .hero-cta-row { display:flex; align-items:center; gap:10px; margin-top: 2px; }
    .hero-btn-primary {
      flex:1;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      border-radius:999px;
      border:none;
      padding:12px 14px;
      font-size:14px; font-weight:700;
      background:#f9fafb;
      color:#000;
      cursor:pointer;
      text-decoration:none;
      box-shadow: 0 10px 30px rgba(15,23,42,0.6);
      transition: transform 0.16s ease, box-shadow 0.16s ease, background 0.16s ease;
      -webkit-user-select:none; user-select:none;
    }
    .hero-btn-primary:hover { transform: translateY(-1px); box-shadow: 0 14px 40px rgba(15,23,42,0.8); background:#fff; }
    .hero-btn-primary:active { transform: translateY(0); box-shadow: 0 8px 24px rgba(15,23,42,0.7); }

    .hero-secondary {
      width:42px; height:42px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.45);
      display:flex; align-items:center; justify-content:center;
      font-size:18px;
      cursor:pointer;
      background: rgba(15,23,42,0.6);
      backdrop-filter: blur(12px);
      color: rgba(255,255,255,0.92);
    }
    .hero-secondary:active { transform: scale(0.98); }

    .hero-map-hint {
      margin-top:2px;
      font-size:11px;
      color: rgba(148,163,184,0.92);
      display:flex; align-items:center; gap:6px;
    }
    .hero-map-dot { width:7px; height:7px; border-radius:50%; background:#38bdf8; box-shadow: 0 0 0 3px rgba(56,189,248,0.18); }

    /* Sections */
    .section-header {
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      margin: 6px 2px 10px 2px;
      gap: 12px;
    }
    .section-title { font-size:15px; font-weight:800; letter-spacing:-0.2px; }
    .section-subtitle { font-size:12px; color: var(--text-muted); margin-top:2px; }
    .section-action { font-size:12px; color: var(--accent-secondary); font-weight:700; cursor:pointer; white-space:nowrap; }

    .card-list { display:flex; flex-direction:column; gap:10px; margin-bottom:14px; }
    .info-card {
      border-radius: var(--radius-lg);
      background: var(--bg-card);
      padding: 12px 12px;
      box-shadow: var(--shadow-subtle);
      border:1px solid var(--border-light);
      display:flex; gap:10px;
      align-items:flex-start;
    }
    .info-icon {
      width:34px; height:34px; border-radius:999px;
      background:#000; color:#fff;
      font-size:16px;
      display:flex; align-items:center; justify-content:center;
      flex-shrink:0;
      margin-top: 1px;
    }
    .info-body { flex:1; display:flex; flex-direction:column; gap:4px; }
    .info-title { font-size:14px; font-weight:800; letter-spacing:-0.2px; }
    .info-text { font-size:12px; color: var(--text-secondary); line-height:1.35; }
    .info-meta-row { display:flex; justify-content:space-between; align-items:center; margin-top:6px; font-size:11px; color: var(--text-muted); gap:10px; }
    .pill-small {
      padding:3px 10px;
      border-radius:999px;
      background: rgba(0,0,0,0.04);
      font-size:11px;
      white-space:nowrap;
    }
    .gray-text { color: var(--text-muted); font-size:11px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .bottom-nav {
      position: fixed;
      left:0; right:0; bottom:0;
      padding: 8px max(16px, var(--tg-safe-area-inset-left, 0px))
               max(8px, var(--tg-safe-area-inset-bottom, 0px))
               max(16px, var(--tg-safe-area-inset-right, 0px));
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(18px);
      border-top: 1px solid rgba(148,163,184,0.3);
      z-index:30;
      display:flex; justify-content:center;
    }
    .bottom-nav-inner {
      width:100%;
      max-width:420px;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      column-gap:10px;
      align-items:center;
    }
    .nav-item {
      border-radius:999px;
      padding:7px 8px;
      display:flex; flex-direction:row; align-items:center; justify-content:center;
      gap:6px;
      font-size:11px; font-weight:700;
      color: var(--text-secondary);
      cursor:pointer;
      border:1px solid transparent;
      background: transparent;
      -webkit-user-select:none; user-select:none;
      text-decoration:none;
      min-width:0;
    }
    .nav-item span.icon { font-size:16px; }
    .nav-item.active {
      background:#000;
      color:#fff;
      border-color:#000;
      box-shadow: 0 8px 24px rgba(15,23,42,0.45);
    }
    .nav-item:active:not(.active) { background: rgba(0,0,0,0.05); }

    @media (max-width: 480px) {
      .hero-title { font-size:19px; }
      .hero-subtitle { font-size:12px; }
      .info-title { font-size:13px; }
      .info-text { font-size:12px; }
    }
    @media (max-height: 640px) {
      body {
        padding-top: calc(
          var(--tg-safe-area-inset-top, 0px) +
          var(--tg-content-safe-area-inset-top, 0px) +
          8px
        );
      }
      .hero-card { padding:14px 12px 10px 12px; border-radius:18px; }
      .hero-time { top:14px; }
      .lang-switch { top:10px; right:10px; }
      .hero-badge-row { margin-top: 24px; }
    }
    .lang-btn:focus, .nav-item:focus { outline: 2px solid var(--accent-secondary); outline-offset:1px; }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text" data-kz="–ñ“Ø–∫—Ç–µ–ª—É–¥–µ..." data-ru="–ó–∞–≥—Ä—É–∑–∫–∞...">–ñ“Ø–∫—Ç–µ–ª—É–¥–µ...</div>
  </div>

  <div class="background"></div>

  <div class="app-root" id="appRoot">
    <header class="top-bar">
      <div class="logo-wrap">
        <div class="logo-square">AG</div>
        <div class="brand-info">
          <div class="brand-title">Alash Go</div>
          <div class="brand-subtitle" id="brandSubtitle" data-kz="–ñ–µ—Ç–∫—ñ–∑—É –∫–ª–∏–µ–Ω—Ç—ñ" data-ru="–ö–ª–∏–µ–Ω—Ç –¥–æ—Å—Ç–∞–≤–∫–∏">
            –ñ–µ—Ç–∫—ñ–∑—É –∫–ª–∏–µ–Ω—Ç—ñ
          </div>
        </div>
      </div>
      <div class="user-pill" id="userPill">
        <div class="user-avatar" id="userAvatar">
          <img id="userAvatarImg" alt="User avatar">
          <span id="userAvatarFallback">üë§</span>
        </div>
        <span id="userNameText" data-kz="–ö–ª–∏–µ–Ω—Ç" data-ru="–ö–ª–∏–µ–Ω—Ç">–ö–ª–∏–µ–Ω—Ç</span>
      </div>
    </header>

    <main class="content-scroll">
      <section class="hero-card">
        <div class="lang-switch">
          <button class="lang-btn active" id="lang-kz" onclick="setLang('kz')">“ö–ê–ó</button>
          <button class="lang-btn" id="lang-ru" onclick="setLang('ru')">–†–£–°</button>
        </div>

        <div class="hero-time" id="heroTime"></div>

        <div class="hero-badge-row">
          <div class="pill-badge">
            <span class="pill-dot"></span>
            <span id="statusBadge" data-kz="“ö—ã–∑–º–µ—Ç –æ–Ω–ª–∞–π–Ω" data-ru="–°–µ—Ä–≤–∏—Å –æ–Ω–ª–∞–π–Ω">“ö—ã–∑–º–µ—Ç –æ–Ω–ª–∞–π–Ω</span>
          </div>
        </div>

        <h1 class="hero-title" id="heroTitle" data-kz="“ö–∞–π–¥–∞ –∂–µ—Ç–∫—ñ–∑–µ–º—ñ–∑?" data-ru="–ö—É–¥–∞ –≤–µ–∑—ë–º –∂“Ø–∫?">
          “ö–∞–π–¥–∞ –∂–µ—Ç–∫—ñ–∑–µ–º—ñ–∑?
        </h1>

        <p class="hero-subtitle" id="heroSubtitle"
           data-kz="–ñ–∞“£–∞ —Ç–∞–ø—Å—ã—Ä—ã—Å –±–µ—Ä—ñ–ø, –∂–∞“õ—ã–Ω –∂“Ø—Ä–≥—ñ–∑—É—à—ñ–Ω—ñ —Ç–∞–±—ã“£—ã–∑."
           data-ru="–û—Ñ–æ—Ä–º–∏—Ç–µ –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑, –∏ –º—ã –Ω–∞–π–¥—ë–º –±–ª–∏–∂–∞–π—à–µ–≥–æ –≤–æ–¥–∏—Ç–µ–ª—è.">
          –ñ–∞“£–∞ —Ç–∞–ø—Å—ã—Ä—ã—Å –±–µ—Ä—ñ–ø, –∂–∞“õ—ã–Ω –∂“Ø—Ä–≥—ñ–∑—É—à—ñ–Ω—ñ —Ç–∞–±—ã“£—ã–∑.
        </p>

        <div class="hero-cta-row">
          <!-- ‚úÖ FIXED: Simple link to delivery-opm.html, no onclick handler -->
          <a href="/delivery" class="hero-btn-primary" id="newOrderBtn">
            <span style="display:inline-flex;align-items:center;gap:6px;">
              <span>üì¶</span>
              <span id="newOrderText" data-kz="–ñ–∞“£–∞ —Ç–∞–ø—Å—ã—Ä—ã—Å" data-ru="–ù–æ–≤—ã–π –∑–∞–∫–∞–∑">–ñ–∞“£–∞ —Ç–∞–ø—Å—ã—Ä—ã—Å</span>
            </span>
          </a>
          <button class="hero-secondary" type="button" id="historyQuickBtn" aria-label="History">‚è±</button>
        </div>

        <div class="hero-map-hint">
          <div class="hero-map-dot"></div>
          <span id="etaText" data-kz="–û—Ä—Ç–∞—à–∞ –∫“Ø—Ç—É: 5‚Äì10 –º–∏–Ω" data-ru="–°—Ä–µ–¥–Ω–µ–µ –æ–∂–∏–¥–∞–Ω–∏–µ: 5‚Äì10 –º–∏–Ω">
            –û—Ä—Ç–∞—à–∞ –∫“Ø—Ç—É: 5‚Äì10 –º–∏–Ω
          </span>
        </div>
      </section>

      <section>
        <div class="section-header">
          <div>
            <div class="section-title" id="sectionRecentTitle" data-kz="–°–æ“£“ì—ã —Ç–∞–ø—Å—ã—Ä—ã—Å—ã“£—ã–∑" data-ru="–í–∞—à –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–∫–∞–∑">
              –°–æ“£“ì—ã —Ç–∞–ø—Å—ã—Ä—ã—Å—ã“£—ã–∑
            </div>
            <div class="section-subtitle" id="sectionRecentSubtitle" data-kz="–ú”ô—Ä—Ç–µ–±–µ—Å—ñ–Ω —Ç–µ–∑ —Ç–µ–∫—Å–µ—Ä—ñ“£—ñ–∑" data-ru="–ë—ã—Å—Ç—Ä–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Å—Ç–∞—Ç—É—Å">
              –ú”ô—Ä—Ç–µ–±–µ—Å—ñ–Ω —Ç–µ–∑ —Ç–µ–∫—Å–µ—Ä—ñ“£—ñ–∑
            </div>
          </div>
          <div class="section-action" id="goHistoryFromHeader">
            <span data-kz="–ë–∞—Ä–ª—ã“õ —Ç–∞—Ä–∏—Ö" data-ru="–í—Å—è –∏—Å—Ç–æ—Ä–∏—è">–ë–∞—Ä–ª—ã“õ —Ç–∞—Ä–∏—Ö</span> ‚Üí
          </div>
        </div>

        <div class="card-list">
          <article class="info-card" id="lastOrderCard">
            <div class="info-icon">üöö</div>
            <div class="info-body">
              <div class="info-title" id="lastOrderTitle" data-kz="–°–æ“£“ì—ã —Ç–∞–ø—Å—ã—Ä—ã—Å —Ç–∞–±—ã–ª–º–∞–¥—ã" data-ru="–ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω">
                –°–æ“£“ì—ã —Ç–∞–ø—Å—ã—Ä—ã—Å —Ç–∞–±—ã–ª–º–∞–¥—ã
              </div>
              <div class="info-text" id="lastOrderDesc"
                   data-kz="–ñ–∞“£–∞ —Ç–∞–ø—Å—ã—Ä—ã—Å –∂–∞—Å–∞“ì–∞–Ω–Ω–∞–Ω –∫–µ–π—ñ–Ω –º“±–Ω–¥–∞ —Å–æ“£“ì—ã –±–∞“ì—ã—Ç –∫”©—Ä—ñ–Ω–µ–¥—ñ."
                   data-ru="–ü–æ—Å–ª–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–∞—Ä—à—Ä—É—Ç.">
                –ñ–∞“£–∞ —Ç–∞–ø—Å—ã—Ä—ã—Å –∂–∞—Å–∞“ì–∞–Ω–Ω–∞–Ω –∫–µ–π—ñ–Ω –º“±–Ω–¥–∞ —Å–æ“£“ì—ã –±–∞“ì—ã—Ç –∫”©—Ä—ñ–Ω–µ–¥—ñ.
              </div>
              <div class="info-meta-row">
                <span class="pill-small" id="lastOrderStatus" data-kz="–°—Ç–∞—Ç—É—Å: –±–µ–ª—Å–µ–Ω–¥—ñ –µ–º–µ—Å" data-ru="–°—Ç–∞—Ç—É—Å: –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö">
                  –°—Ç–∞—Ç—É—Å: –±–µ–ª—Å–µ–Ω–¥—ñ –µ–º–µ—Å
                </span>
                <span class="gray-text" id="lastOrderMeta" data-kz="”ò–∑—ñ—Ä–≥–µ —Ç–∞–ø—Å—ã—Ä—ã—Å –∂–æ“õ" data-ru="–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç">
                  ”ò–∑—ñ—Ä–≥–µ —Ç–∞–ø—Å—ã—Ä—ã—Å –∂–æ“õ
                </span>
              </div>
            </div>
          </article>
        </div>
      </section>

      <section>
        <div class="section-header">
          <div>
            <div class="section-title" id="sectionTipsTitle" data-kz="–ö–µ“£–µ—Å—Ç–µ—Ä –º–µ–Ω “õ–∞—É—ñ–ø—Å—ñ–∑–¥—ñ–∫" data-ru="–°–æ–≤–µ—Ç—ã –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å">
              –ö–µ“£–µ—Å—Ç–µ—Ä –º–µ–Ω “õ–∞—É—ñ–ø—Å—ñ–∑–¥—ñ–∫
            </div>
          </div>
        </div>
        <div class="card-list">
          <article class="info-card">
            <div class="info-icon">üõ°</div>
            <div class="info-body">
              <div class="info-title" data-kz="–ñ–µ—Ç–∫—ñ–∑—É –±–∞—Ä—ã—Å—ã–Ω –±–∞“õ—ã–ª–∞“£—ã–∑" data-ru="–û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –¥–æ—Å—Ç–∞–≤–∫—É">
                –ñ–µ—Ç–∫—ñ–∑—É –±–∞—Ä—ã—Å—ã–Ω –±–∞“õ—ã–ª–∞“£—ã–∑
              </div>
              <div class="info-text"
                   data-kz="–ñ“Ø—Ä–≥—ñ–∑—É—à—ñ —Ç–∞–ø—Å—ã—Ä—ã—Å—ã“£—ã–∑–¥—ã “õ–∞–±—ã–ª–¥–∞“ì–∞–Ω–Ω–∞–Ω –∫–µ–π—ñ–Ω —Å—ñ–∑–≥–µ Telegram-–¥–∞ —Ö–∞–±–∞—Ä–ª–∞–º–∞ –∫–µ–ª–µ–¥—ñ."
                   data-ru="–ü–æ—Å–ª–µ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞–∫–∞–∑–∞ –≤–æ–¥–∏—Ç–µ–ª–µ–º –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram.">
                –ñ“Ø—Ä–≥—ñ–∑—É—à—ñ —Ç–∞–ø—Å—ã—Ä—ã—Å—ã“£—ã–∑–¥—ã “õ–∞–±—ã–ª–¥–∞“ì–∞–Ω–Ω–∞–Ω –∫–µ–π—ñ–Ω —Å—ñ–∑–≥–µ Telegram-–¥–∞ —Ö–∞–±–∞—Ä–ª–∞–º–∞ –∫–µ–ª–µ–¥—ñ.
              </div>
            </div>
          </article>

          <article class="info-card">
            <div class="info-icon">üí≥</div>
            <div class="info-body">
              <div class="info-title" data-kz="“ö–∞—É—ñ–ø—Å—ñ–∑ —Ç”©–ª–µ–º" data-ru="–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–ø–ª–∞—Ç–∞">
                “ö–∞—É—ñ–ø—Å—ñ–∑ —Ç”©–ª–µ–º
              </div>
              <div class="info-text"
                   data-kz="–¢”©–ª–µ–º —à–∞—Ä—Ç—Ç–∞—Ä—ã–Ω –∂“Ø—Ä–≥—ñ–∑—É—à—ñ–º–µ–Ω –∂–µ–∫–µ –∫–µ–ª—ñ—Å—ñ–ø, —Ç–µ–∫ —Ä–µ—Å–º–∏ —á–µ–∫—Ç–µ—Ä–¥—ñ —Å–∞“õ—Ç–∞“£—ã–∑."
                   data-ru="–£—Ç–æ—á–Ω—è–π—Ç–µ —É—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã —Å –≤–æ–¥–∏—Ç–µ–ª–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–π—Ç–µ —á–µ–∫.">
                –¢”©–ª–µ–º —à–∞—Ä—Ç—Ç–∞—Ä—ã–Ω –∂“Ø—Ä–≥—ñ–∑—É—à—ñ–º–µ–Ω –∂–µ–∫–µ –∫–µ–ª—ñ—Å—ñ–ø, —Ç–µ–∫ —Ä–µ—Å–º–∏ —á–µ–∫—Ç–µ—Ä–¥—ñ —Å–∞“õ—Ç–∞“£—ã–∑.
              </div>
            </div>
          </article>
        </div>
      </section>
    </main>
  </div>

  <nav class="bottom-nav">
    <div class="bottom-nav-inner">
      <button class="nav-item" id="tabHistory" type="button">
        <span class="icon">üìú</span>
        <span class="nav-item-label" data-kz="–¢–∞—Ä–∏—Ö" data-ru="–ò—Å—Ç–æ—Ä–∏—è">–¢–∞—Ä–∏—Ö</span>
      </button>

      <button class="nav-item active" id="tabHome" type="button">
        <span class="icon">üè†</span>
        <span class="nav-item-label" data-kz="–ë–∞—Å—Ç—ã" data-ru="–ì–ª–∞–≤–Ω–∞—è">–ë–∞—Å—Ç—ã</span>
      </button>

      <button class="nav-item" id="tabDrivers" type="button">
        <span class="icon">üöö</span>
        <span class="nav-item-label" data-kz="–ñ“Ø—Ä–≥—ñ–∑—É—à—ñ–ª–µ—Ä" data-ru="–í–æ–¥–∏—Ç–µ–ª–∏">–ñ“Ø—Ä–≥—ñ–∑—É—à—ñ–ª–µ—Ä</span>
      </button>
    </div>
  </nav>

  <script>
    let currentLang = "kz";
    let isCheckingUser = false;

    document.addEventListener("DOMContentLoaded", async () => {
      initTelegram();
      setLang("kz");
      initTimeLabel();
      bindEvents();

      // ‚úÖ STEP 1: Check user role (driver vs client)
      await checkUserRoleAndShow();

      // ‚úÖ STEP 2: OFFERTA GATE - check ONCE on page load only
      await checkOffertaGate("client");
    });

    function initTelegram() {
      try {
        if (window.Telegram && Telegram.WebApp) {
          Telegram.WebApp.ready();
          Telegram.WebApp.expand();
          if (Telegram.WebApp.disableVerticalSwipes) Telegram.WebApp.disableVerticalSwipes();
        }
      } catch (e) {
        console.warn("Telegram init error:", e);
      }
    }

    function bindEvents() {
      const historyBtn = document.getElementById("historyQuickBtn");
      const headerHistory = document.getElementById("goHistoryFromHeader");

      const tabHome = document.getElementById("tabHome");
      const tabHistory = document.getElementById("tabHistory");
      const tabDrivers = document.getElementById("tabDrivers");

      if (historyBtn) historyBtn.addEventListener("click", () => goHistory());
      if (headerHistory) headerHistory.addEventListener("click", () => goHistory());

      if (tabHome) tabHome.addEventListener("click", () => setActiveTab("home"));

      if (tabHistory) {
        tabHistory.addEventListener("click", () => {
          setActiveTab("history");
          goHistory();
        });
      }

      if (tabDrivers) {
        tabDrivers.addEventListener("click", () => {
          setActiveTab("drivers");
          goDrivers();
        });
      }

      // ‚úÖ REMOVED: No onclick handler for newOrderBtn
      // The button is now a simple <a href="/delivery-opm.html">
      // Offerta check happens ONLY on page load, not on button click
    }

    function setActiveTab(tab) {
      document.querySelectorAll(".nav-item").forEach(btn => btn.classList.remove("active"));
      if (tab === "home") document.getElementById("tabHome")?.classList.add("active");
      if (tab === "history") document.getElementById("tabHistory")?.classList.add("active");
      if (tab === "drivers") document.getElementById("tabDrivers")?.classList.add("active");
    }

    function goHistory() { window.location.href = "/user-history"; }
    function goDrivers() { window.location.href = "/driver-list"; }

    function initTimeLabel() {
      const el = document.getElementById("heroTime");
      if (!el) return;
      const now = new Date();
      const h = String(now.getHours()).padStart(2, "0");
      const m = String(now.getMinutes()).padStart(2, "0");
      el.textContent = `${h}:${m}`;
    }

    function getTelegramId() {
      try {
        if (window.Telegram?.WebApp?.initDataUnsafe?.user) {
          return Telegram.WebApp.initDataUnsafe.user.id;
        }
      } catch (e) {
        console.warn("initDataUnsafe error:", e);
      }
      const params = new URLSearchParams(location.search);
      const testId = params.get("test_id");
      return testId || null;
    }

    async function checkUserRoleAndShow() {
      const overlay = document.getElementById("loadingOverlay");
      const root = document.getElementById("appRoot");
      const tgId = getTelegramId();

      if (!tgId) {
        updateLoadingText("noUser");
        setTimeout(() => {
          overlay?.classList.add("hidden");
          root?.classList.add("visible");
        }, 300);
        return;
      }

      isCheckingUser = true;
      updateLoadingText("checkingUser");

      try {
        const res = await fetch("/api/check/who", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ telegram_id: parseInt(tgId, 10) })
        });

        if (!res.ok) throw new Error("HTTP " + res.status);

        const data = await res.json();
        if (data && data.success && data.data) {
          const userData = data.data;

          if (userData.exists === true && userData.user_type === "driver") {
            updateLoadingText("redirectDriver");
            setTimeout(() => window.location.replace("/delivery-list"), 600);
            return;
          }

          setClientNameFromTelegram();
        } else {
          setClientNameFromTelegram();
        }
      } catch (e) {
        console.error("checkUserRole error:", e);
        updateLoadingText("error");
      } finally {
        isCheckingUser = false;
        setTimeout(() => {
          overlay?.classList.add("hidden");
          root?.classList.add("visible");
        }, 250);
      }
    }

    function setClientNameFromTelegram() {
      try {
        const user = window.Telegram?.WebApp?.initDataUnsafe?.user;
        if (!user) return;

        const nameEl = document.getElementById("userNameText");
        const avatarImg = document.getElementById("userAvatarImg");
        const avatarFallback = document.getElementById("userAvatarFallback");

        const fullName = [user.first_name, user.last_name].filter(Boolean).join(" ");
        const displayName = user.username ? ("@" + user.username) : (fullName || "–ö–ª–∏–µ–Ω—Ç");

        if (nameEl && displayName) nameEl.textContent = displayName;

        if (user.photo_url && avatarImg) {
          avatarImg.src = user.photo_url;
          avatarImg.style.display = "block";
          if (avatarFallback) avatarFallback.style.display = "none";
        } else if (avatarFallback) {
          const initials = (fullName || "A")[0].toUpperCase();
          avatarFallback.textContent = initials;
        }
      } catch (e) {
        console.warn("setClientNameFromTelegram error:", e);
      }
    }

    function updateLoadingText(key) {
      const el = document.querySelector(".loading-text");
      if (!el) return;

      const dict = {
        kz: {
          checkingUser: "–ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã —Ç“Ø—Ä—ñ —Ç–µ–∫—Å–µ—Ä—ñ–ª—É–¥–µ...",
          redirectDriver: "–ñ“Ø—Ä–≥—ñ–∑—É—à—ñ –ø–∞–Ω–µ–ª—ñ–Ω–µ –±–∞“ì—ã—Ç—Ç–∞—É...",
          error: "“ö–∞—Ç–µ –ø–∞–π–¥–∞ –±–æ–ª–¥—ã. –ö–µ–π—ñ–Ω—ñ—Ä–µ–∫ “õ–∞–π—Ç–∞–ª–∞–ø –∫”©—Ä—ñ“£—ñ–∑.",
          noUser: "WebApp –¥–µ—Ä–µ–∫—Ç–µ—Ä—ñ –∂–æ“õ. –ö–ª–∏–µ–Ω—Ç –±–µ—Ç—ñ –∞—à—ã–ª—É–¥–∞.",
          checkingOfferta: "–û—Ñ–µ—Ä—Ç–∞ —Ç–µ–∫—Å–µ—Ä—ñ–ª—É–¥–µ...",
          offertaNeed: "–û—Ñ–µ—Ä—Ç–∞ “õ–∞–±—ã–ª–¥–∞–Ω–±–∞“ì–∞–Ω. –ë–∞“ì—ã—Ç—Ç–∞—É..."
        },
        ru: {
          checkingUser: "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...",
          redirectDriver: "–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ –ø–∞–Ω–µ–ª—å –≤–æ–¥–∏—Ç–µ–ª—è...",
          error: "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
          noUser: "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö WebApp. –û—Ç–∫—Ä—ã–≤–∞–µ–º –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —ç–∫—Ä–∞–Ω.",
          checkingOfferta: "–ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ñ–µ—Ä—Ç—É...",
          offertaNeed: "–û—Ñ–µ—Ä—Ç–∞ –Ω–µ –ø—Ä–∏–Ω—è—Ç–∞. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º..."
        }
      };

      const langDict = dict[currentLang] || dict.kz;
      const text = langDict[key] || el.getAttribute("data-" + currentLang);
      if (text) el.textContent = text;
    }

    function setLang(lang) {
      if (isCheckingUser) return;
      currentLang = lang;

      document.querySelectorAll(".lang-btn").forEach(btn => btn.classList.remove("active"));
      document.getElementById("lang-" + lang)?.classList.add("active");

      document.querySelectorAll("[data-kz]").forEach(el => {
        const t = el.getAttribute("data-" + lang);
        if (t) el.textContent = t;
      });

      const root = document.getElementById("appRoot");
      if (root) {
        root.style.transform = "scale(0.99)";
        setTimeout(() => { root.style.transform = "scale(1)"; }, 100);
      }
    }
    window.setLang = setLang;

    // =========================
    // ‚úÖ OFFERTA GATE - CHECK ONLY ON PAGE LOAD
    // =========================
    function redirectToOfferta(role) {
      const ret = encodeURIComponent("/main-client");
      window.location.replace(`/offerta/${role}?return=${ret}`);
    }

    async function isOffertaAccepted(role) {
      const tgId = getTelegramId();
      if (!tgId) return true; // No user - allow access

      try {
        const timestamp = Date.now();
        const url = `/api/offerta/status?role=${encodeURIComponent(role)}&telegram_id=${encodeURIComponent(tgId)}&_t=${timestamp}`;

        const res = await fetch(url, {
          method: "GET",
          cache: "no-store"
        });

        if (!res.ok) {
          console.error("‚ùå Offerta status check failed:", res.status);
          return false;
        }

        const data = await res.json();
        return !!data.approved;
      } catch (e) {
        console.error("‚ùå Offerta status error:", e);
        return false;
      }
    }

    async function checkOffertaGate(role) {
      const overlay = document.getElementById("loadingOverlay");
      const root = document.getElementById("appRoot");

      updateLoadingText("checkingOfferta");

      const ok = await isOffertaAccepted(role);
      if (!ok) {
        // ‚úÖ Offerta NOT accepted - redirect to offerta page
        updateLoadingText("offertaNeed");
        setTimeout(() => redirectToOfferta(role), 450);
        return;
      }

      // ‚úÖ Offerta IS accepted - show main page
      // overlay/root already managed by checkUserRoleAndShow
      console.log("‚úÖ Offerta accepted - showing main page");
    }
  </script>
</body>
</html>