<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>–ó–∞–∫–∞–∑—ã | –¢–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <style>
    :root {
      --tg-theme-bg-color: #ffffff;
      --tg-theme-text-color: #000000;
      --tg-theme-hint-color: #999999;
      --tg-theme-link-color: #007AFF;
      --tg-theme-button-color: #007AFF;
      --tg-theme-button-text-color: #ffffff;
      
      /* Uber-style minimal colors */
      --primary: #000000;
      --primary-light: #333333;
      --secondary: #007AFF;
      --accent: #1565C0;
      --danger: #D32F2F;
      --warning: #F57C00;
      --success: #388E3C;
      --bg: #ffffff;
      --bg-secondary: #f8f9fa;
      --card: #ffffff;
      --text: #000000;
      --text-secondary: #666666;
      --text-muted: #999999;
      --border: #e0e0e0;
      --border-light: #f0f0f0;
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
      --shadow-xl: 0 12px 32px rgba(0, 0, 0, 0.15);
      --gradient: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      --secondary-gradient: linear-gradient(135deg, var(--secondary) 0%, var(--accent) 100%);
      
      /* Responsive breakpoints */
      --mobile-max: 767px;
      --tablet-min: 768px;
      --tablet-max: 1023px;
      --desktop-min: 1024px;
      --large-desktop-min: 1440px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', Roboto, sans-serif;
      background: var(--tg-theme-bg-color, var(--bg));
      color: var(--tg-theme-text-color, var(--text));
      min-height: 100vh;
      overflow-x: hidden;
      padding: 0;
      margin: 0;
      user-select: none;
      -webkit-user-select: none;
      font-size: clamp(14px, 2vw, 16px);
      line-height: 1.5;
      
      /* TELEGRAM WEBAPP OPTIMIZATION */
      height: var(--tg-viewport-stable-height, 100vh);
      padding-top: calc(var(--tg-safe-area-inset-top, 0px) + var(--tg-content-safe-area-inset-top, 0px) + 15px);
      padding-bottom: var(--tg-safe-area-inset-bottom, 0px);
      padding-left: var(--tg-safe-area-inset-left, 0px);
      padding-right: var(--tg-safe-area-inset-right, 0px);
    }

    /* Container for desktop layout */
    .app-container {
      max-width: 100%;
      margin: 0 auto;
      position: relative;
      height: 100%;
    }

    /* Header - Minimal Uber Style */
    .header {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: var(--tg-theme-bg-color, var(--bg));
      border-bottom: 1px solid var(--border-light);
      padding: clamp(16px, 4vw, 24px) clamp(16px, 4vw, 24px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: clamp(12px, 3vw, 16px);
    }

    .profile-btn {
      width: clamp(40px, 8vw, 48px);
      height: clamp(40px, 8vw, 48px);
      border: none;
      background: var(--gradient);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow);
      overflow: hidden;
      position: relative;
      touch-action: manipulation;
    }

    .profile-btn img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }

    .profile-btn:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-lg);
    }

    .profile-btn.no-photo {
      background: var(--gradient);
      color: white;
      font-size: clamp(18px, 4vw, 22px);
      font-weight: bold;
    }

    .header-title {
      font-size: clamp(16px, 4vw, 20px);
      font-weight: 600;
      color: var(--text);
      cursor: pointer;
      padding: clamp(8px, 2vw, 12px) clamp(12px, 3vw, 16px);
      border-radius: 12px;
      transition: all 0.2s ease;
      background: var(--bg-secondary);
      touch-action: manipulation;
    }

    .header-title:hover {
      background: var(--primary);
      color: white;
      transform: translateY(-1px);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: clamp(12px, 3vw, 16px);
    }

    .refresh-btn {
      width: clamp(40px, 8vw, 48px);
      height: clamp(40px, 8vw, 48px);
      border: none;
      background: var(--gradient);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: clamp(16px, 4vw, 20px);
      transition: all 0.2s ease;
      touch-action: manipulation;
    }

    .refresh-btn:hover {
      transform: rotate(180deg) scale(1.05);
    }

    .refresh-btn.loading {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .lang-switch {
      display: flex;
      background: var(--bg-secondary);
      border-radius: 24px;
      padding: 2px;
      border: 1px solid var(--border);
    }

    .lang-btn {
      padding: clamp(6px, 2vw, 10px) clamp(12px, 3vw, 16px);
      border: none;
      background: transparent;
      border-radius: 20px;
      font-size: clamp(12px, 3vw, 14px);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--text-muted);
      touch-action: manipulation;
      min-width: 48px;
    }

    .lang-btn.active {
      background: var(--primary);
      color: white;
    }

    /* Stats Bar - Minimal */
    .stats-bar {
      padding: clamp(16px, 4vw, 24px);
      background: var(--bg-secondary);
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: clamp(12px, 3vw, 20px);
      text-align: center;
      border-bottom: 1px solid var(--border-light);
    }

    .stat-item {
      padding: clamp(12px, 3vw, 16px);
      border-radius: 16px;
      background: var(--card);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    .stat-value {
      font-size: clamp(20px, 5vw, 28px);
      font-weight: 700;
      margin-bottom: 4px;
      color: var(--text);
    }

    .stat-label {
      font-size: clamp(10px, 2.5vw, 12px);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 500;
    }

    /* Filter Bar - Minimal */
    .filter-bar {
      padding: clamp(12px, 3vw, 20px);
      background: var(--card);
      border-bottom: 1px solid var(--border-light);
      display: flex;
      gap: clamp(8px, 2vw, 12px);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .filter-bar::-webkit-scrollbar {
      display: none;
    }

    .filter-chip {
      padding: clamp(8px, 2vw, 12px) clamp(16px, 4vw, 20px);
      border-radius: 24px;
      background: var(--bg-secondary);
      color: var(--text-secondary);
      font-size: clamp(12px, 3vw, 14px);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
      border: 1px solid var(--border);
      touch-action: manipulation;
      min-height: 48px;
      display: flex;
      align-items: center;
    }

    .filter-chip.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
      transform: scale(1.02);
    }

    /* New order notification */
    .new-order-notification {
      position: fixed;
      top: clamp(120px, 20vh, 160px);
      left: clamp(16px, 4vw, 24px);
      right: clamp(16px, 4vw, 24px);
      background: var(--primary);
      color: white;
      padding: clamp(16px, 4vw, 24px);
      border-radius: 16px;
      box-shadow: var(--shadow-xl);
      z-index: 1001;
      display: none;
      animation: slideInNotification 0.4s ease-out;
    }

    .new-order-notification.show {
      display: block;
    }

    @keyframes slideInNotification {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .notification-content {
      display: flex;
      align-items: center;
      gap: clamp(12px, 3vw, 16px);
    }

    .notification-icon {
      font-size: clamp(24px, 6vw, 32px);
      animation: bounceIcon 0.6s ease-out;
    }

    @keyframes bounceIcon {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-8px); }
      60% { transform: translateY(-4px); }
    }

    .notification-text {
      flex: 1;
    }

    .notification-title {
      font-size: clamp(16px, 4vw, 18px);
      font-weight: 700;
      margin-bottom: 4px;
    }

    .notification-subtitle {
      font-size: clamp(13px, 3vw, 15px);
      opacity: 0.9;
    }

    /* Order List - Minimal Cards */
    .order-list {
      padding: clamp(12px, 3vw, 20px);
      display: grid;
      grid-template-columns: 1fr;
      gap: clamp(12px, 3vw, 16px);
      padding-bottom: clamp(100px, 20vh, 140px);
      min-height: 60vh;
    }

    /* Desktop Layout */
    @media (min-width: 1024px) {
      .app-container {
        max-width: 1200px;
        padding: 0 24px;
      }
      
      .order-list {
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 24px;
        padding: 24px;
      }
      
      .header {
        padding: 24px 32px;
      }
      
      .stats-bar {
        grid-template-columns: repeat(3, 1fr);
        gap: 32px;
        padding: 32px;
      }
    }

    /* Large Desktop Layout */
    @media (min-width: 1440px) {
      .app-container {
        max-width: 1400px;
      }
      
      .order-list {
        grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        gap: 28px;
      }
    }

    /* Tablet Layout */
    @media (min-width: 768px) and (max-width: 1023px) {
      .order-list {
        grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
        gap: 20px;
        padding: 20px;
      }
      
      .stats-bar {
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
      }
    }

    /* UBER-STYLE Order Cards */
    .order-card {
      background: var(--card);
      border-radius: 16px;
      padding: clamp(16px, 4vw, 24px);
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
      transform: translateY(0);
      will-change: transform;
      touch-action: manipulation;
    }

    .order-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary);
    }

    .order-card.new {
      border-left: 4px solid var(--warning);
    }

    .order-card.loading {
      opacity: 0.6;
      pointer-events: none;
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: clamp(16px, 4vw, 20px);
      flex-wrap: wrap;
      gap: 8px;
    }

    .order-time {
      font-size: clamp(12px, 3vw, 14px);
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
    }

    .new-badge {
      background: var(--warning);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: clamp(10px, 2.5vw, 11px);
      font-weight: 700;
      text-transform: uppercase;
      animation: badgePulse 2s infinite;
    }

    @keyframes badgePulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .order-route {
      margin-bottom: clamp(16px, 4vw, 20px);
    }

    .route-point {
      display: flex;
      align-items: flex-start;
      gap: clamp(12px, 3vw, 16px);
      margin-bottom: clamp(12px, 3vw, 16px);
      position: relative;
    }

    .route-point:last-child {
      margin-bottom: 0;
    }

    .route-point::after {
      content: '';
      position: absolute;
      left: clamp(12px, 3vw, 16px);
      top: clamp(28px, 6vw, 32px);
      width: 2px;
      height: calc(100% + 8px);
      background: var(--border);
      z-index: 1;
    }

    .route-point:last-child::after {
      display: none;
    }

    .route-marker {
      width: clamp(24px, 5vw, 32px);
      height: clamp(24px, 5vw, 32px);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(12px, 3vw, 14px);
      font-weight: bold;
      color: white;
      flex-shrink: 0;
      z-index: 2;
      position: relative;
      box-shadow: var(--shadow);
    }

    .route-marker.from {
      background: var(--primary);
    }

    .route-marker.to {
      background: var(--secondary);
    }

    .route-info {
      flex: 1;
      min-width: 0;
    }

    .route-label {
      font-size: clamp(10px, 2.5vw, 12px);
      color: var(--text-muted);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    .route-address {
      font-size: clamp(14px, 3.5vw, 16px);
      color: var(--text);
      font-weight: 500;
      line-height: 1.3;
      word-wrap: break-word;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .order-details {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: clamp(8px, 2vw, 12px);
      margin-bottom: clamp(8px, 2vw, 12px);
    }

    .detail-item {
      text-align: center;
      padding: clamp(8px, 2vw, 12px);
      background: var(--bg-secondary);
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .detail-value {
      font-size: clamp(14px, 3.5vw, 18px);
      font-weight: 700;
      color: var(--text);
      margin-bottom: 2px;
    }

    .detail-value.price {
      color: var(--primary);
      font-size: clamp(16px, 4vw, 20px);
    }

    .detail-label {
      font-size: clamp(9px, 2vw, 11px);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    .order-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: clamp(8px, 2vw, 12px);
      flex-wrap: wrap;
      gap: 8px;
    }

    .order-comment {
      flex: 1;
      font-size: clamp(12px, 3vw, 14px);
      color: var(--text-muted);
      font-style: italic;
      margin-right: 8px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      min-width: 0;
      line-height: 1.4;
    }

    .truck-type {
      padding: 4px 10px;
      background: var(--bg-secondary);
      border-radius: 8px;
      font-size: clamp(10px, 2.5vw, 12px);
      font-weight: 600;
      color: var(--text-secondary);
      white-space: nowrap;
      border: 1px solid var(--border);
    }

    .distance-badge {
      position: absolute;
      top: clamp(16px, 4vw, 20px);
      right: clamp(16px, 4vw, 20px);
      background: var(--warning);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: clamp(9px, 2vw, 11px);
      font-weight: 700;
    }

    .distance-badge.nearby {
      background: var(--success);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: clamp(60px, 15vh, 100px) clamp(20px, 5vw, 32px);
    }

    .empty-icon {
      font-size: clamp(48px, 12vw, 64px);
      margin-bottom: clamp(16px, 4vw, 24px);
      opacity: 0.3;
    }

    .empty-title {
      font-size: clamp(18px, 4.5vw, 24px);
      font-weight: 700;
      color: var(--text);
      margin-bottom: clamp(8px, 2vw, 12px);
    }

    .empty-message {
      font-size: clamp(14px, 3.5vw, 16px);
      color: var(--text-muted);
      line-height: 1.5;
    }

    /* Loading State */
    .loading-state {
      text-align: center;
      padding: clamp(40px, 10vh, 60px) clamp(20px, 5vw, 32px);
    }

    .loading-spinner {
      width: clamp(32px, 8vw, 48px);
      height: clamp(32px, 8vw, 48px);
      border: 3px solid var(--border);
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto clamp(16px, 4vw, 24px);
    }

    .loading-text {
      font-size: clamp(14px, 3.5vw, 16px);
      color: var(--text-muted);
    }

    /* Performance optimized card loading animation */
    .order-card.fade-in {
      animation: fadeInUp 0.4s ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* UBER-STYLE Detail Modal - FIXED VERSION WITH TOP MARGIN */
.detail-modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.85);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  z-index: 2000;
  display: none;
  align-items: flex-end;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding-top: 30px;
}

.detail-modal.show {
  display: flex;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.detail-sheet {
  background: var(--card);
  border-radius: 20px 20px 0 0;
  width: 100%;
  height: 88vh;
  max-height: calc(100vh - 40px);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  animation: slideUp 0.3s ease;
  position: relative;
  margin-top: auto;
  margin-bottom: 0;
}

@keyframes slideUp {
  from { transform: translateY(100%); }
  to { transform: translateY(0); }
}

/* Desktop Modal - OPTIMIZED */
@media (min-width: 1024px) {
  .detail-modal {
    align-items: center;
    justify-content: center;
    padding-top: 0;
  }
  
  .detail-sheet {
    width: 90vw;
    max-width: 1400px;
    height: 85vh;
    max-height: 900px;
    border-radius: 24px;
    animation: scaleIn 0.3s ease;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
    margin-top: 0;
  }
  
  @keyframes scaleIn {
    from { 
      opacity: 0;
      transform: scale(0.95);
    }
    to { 
      opacity: 1;
      transform: scale(1);
    }
  }
}

/* Tablet Modal */
@media (min-width: 768px) and (max-width: 1023px) {
  .detail-modal {
    padding-top: 20px;
  }
  
  .detail-sheet {
    height: 88vh;
    max-height: calc(100vh - 30px);
    border-radius: 24px 24px 0 0;
  }
}
    /* MINIMAL Header for modal with safe areas */
    .detail-header {
      padding: clamp(20px, 5vw, 32px);
      padding-top: clamp(16px, 4vw, 24px);
      border-bottom: 1px solid var(--border-light);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: white;
      z-index: 10;
      position: relative;
      flex-shrink: 0;
    }

    .detail-title {
      font-size: clamp(18px, 4.5vw, 24px);
      font-weight: 700;
      color: var(--text);
    }

    .close-btn {
      width: clamp(36px, 8vw, 48px);
      height: clamp(36px, 8vw, 48px);
      border: none;
      background: var(--bg-secondary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: clamp(18px, 4vw, 24px);
      transition: all 0.2s ease;
      touch-action: manipulation;
      color: var(--text-secondary);
    }

    .close-btn:hover {
      background: var(--border);
      transform: scale(1.05);
      color: var(--text);
    }

    .detail-content {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    /* Responsive Map Layout */
    .detail-map {
      height: 50%;
      position: relative;
      overflow: hidden;
      background: #ffffff;
      border-bottom: 1px solid var(--border-light);
      flex-shrink: 0;
    }

    @media (min-width: 1024px) {
      .detail-content {
        flex-direction: row;
      }
      
      .detail-map {
        width: 60%;
        height: 100%;
        border-bottom: none;
        border-right: 1px solid var(--border-light);
      }
      
      .detail-info {
        width: 40%;
        height: 100%;
      }
    }

    #detailMap {
      width: 100%;
      height: 100%;
      touch-action: none;
    }

    .map-overlay {
      position: absolute;
      top: clamp(16px, 4vw, 32px);
      left: clamp(16px, 4vw, 32px);
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      color: white;
      padding: clamp(12px, 3vw, 20px);
      border-radius: 16px;
      font-size: clamp(14px, 3.5vw, 18px);
      font-weight: 600;
      z-index: 1000;
      box-shadow: var(--shadow-lg);
      border: 1px solid rgba(255, 255, 255, 0.1);
      min-width: clamp(140px, 30vw, 200px);
    }

    .route-eta {
      display: flex;
      align-items: center;
      gap: clamp(8px, 2vw, 12px);
      color: white;
      font-weight: 700;
    }

    .route-eta span:first-child {
      font-size: clamp(16px, 4vw, 20px);
    }

    /* Order Info Panel - MINIMAL */
    .detail-info {
      height: 50%;
      background: white;
      padding: clamp(20px, 5vw, 32px);
      padding-bottom: calc(clamp(20px, 5vw, 32px) + var(--tg-safe-area-inset-bottom, 0px) + env(safe-area-inset-bottom, 0px));
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      -webkit-overflow-scrolling: touch;
    }

    .price-highlight {
      text-align: center;
      margin-bottom: clamp(20px, 5vw, 32px);
    }

    .price-amount {
      font-size: clamp(32px, 8vw, 48px);
      font-weight: 800;
      color: var(--primary);
      margin-bottom: 8px;
    }

    .price-label {
      font-size: clamp(12px, 3vw, 16px);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }

    .route-details {
      background: var(--bg-secondary);
      border-radius: 16px;
      padding: clamp(16px, 4vw, 24px);
      margin-bottom: clamp(16px, 4vw, 24px);
      border: 1px solid var(--border);
    }

    .route-step {
      display: flex;
      align-items: center;
      gap: clamp(16px, 4vw, 20px);
      margin-bottom: clamp(16px, 4vw, 20px);
    }

    .route-step:last-child {
      margin-bottom: 0;
    }

    .step-marker {
      width: clamp(32px, 7vw, 40px);
      height: clamp(32px, 7vw, 40px);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(14px, 3.5vw, 18px);
      font-weight: bold;
      color: white;
      flex-shrink: 0;
      box-shadow: var(--shadow);
    }

    .step-marker.pickup {
      background: var(--primary);
    }

    .step-marker.dropoff {
      background: var(--secondary);
    }

    .step-info {
      flex: 1;
      min-width: 0;
    }

    .step-address {
      font-size: clamp(15px, 3.5vw, 18px);
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
      line-height: 1.3;
      word-wrap: break-word;
    }

    .step-label {
      font-size: clamp(11px, 2.5vw, 14px);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    .order-meta {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: clamp(12px, 3vw, 20px);
      margin-bottom: clamp(16px, 4vw, 24px);
    }

    .meta-item {
      text-align: center;
      padding: clamp(12px, 3vw, 16px);
      background: var(--bg-secondary);
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .meta-value {
      font-size: clamp(16px, 4vw, 20px);
      font-weight: 700;
      color: var(--text);
      margin-bottom: 4px;
    }

    .meta-label {
      font-size: clamp(10px, 2.5vw, 12px);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    .contact-section {
      background: var(--gradient);
      border-radius: 16px;
      padding: clamp(16px, 4vw, 24px);
      color: white;
      text-align: center;
      margin-bottom: clamp(16px, 4vw, 24px);
    }

    .contact-title {
      font-size: clamp(14px, 3.5vw, 18px);
      font-weight: 700;
      margin-bottom: 8px;
    }

    .contact-phone {
      font-size: clamp(16px, 4vw, 20px);
      margin-bottom: clamp(16px, 4vw, 20px);
      opacity: 0.95;
      font-weight: 600;
    }

    .contact-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: clamp(8px, 2vw, 12px);
    }

    .contact-btn {
      padding: clamp(10px, 2.5vw, 16px);
      border: none;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: clamp(6px, 1.5vw, 10px);
      text-decoration: none;
      font-size: clamp(12px, 3vw, 16px);
      touch-action: manipulation;
      min-height: 48px;
    }

    .contact-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-1px);
    }

    .accept-button {
      width: 100%;
      padding: clamp(16px, 4vw, 24px);
      background: var(--gradient);
      color: white;
      border: none;
      border-radius: 16px;
      font-size: clamp(16px, 4vw, 20px);
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-lg);
      touch-action: manipulation;
      min-height: 56px;
      margin-top: auto;
    }

    .accept-button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-xl);
    }

    /* Hide Leaflet controls */
    .leaflet-control-attribution,
    .leaflet-control-zoom,
    .leaflet-control {
      display: none !important;
    }

    /* UBER-STYLE Custom Leaflet Markers */
    .uber-marker {
      width: clamp(32px, 7vw, 48px);
      height: clamp(32px, 7vw, 48px);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: white;
      font-size: clamp(14px, 3.5vw, 20px);
      border: 4px solid white;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
      position: relative;
      transition: all 0.2s ease;
    }

    .uber-marker.pickup {
      background: var(--primary);
    }

    .uber-marker.dropoff {
      background: var(--secondary);
    }

    .uber-marker:hover {
      transform: scale(1.1);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    .leaflet-container {
      background: #ffffff !important;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif !important;
    }

    .leaflet-tile {
      filter: contrast(1.05) brightness(1.05) saturate(0.95) !important;
    }

    /* Accessibility Improvements */
    @media (prefers-reduced-motion: reduce) {
      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* Focus indicators for keyboard navigation */
    .profile-btn:focus,
    .refresh-btn:focus,
    .lang-btn:focus,
    .filter-chip:focus,
    .order-card:focus,
    .close-btn:focus,
    .contact-btn:focus,
    .accept-button:focus {
      outline: 2px solid var(--secondary);
      outline-offset: 2px;
    }

    /* Make elements keyboard accessible */
    .order-card {
      -webkit-user-select: none;
      user-select: none;
    }

    .order-card:focus {
      outline: 2px solid var(--secondary);
      outline-offset: 2px;
    }

    /* Improve scrollbar styling */
    .order-list::-webkit-scrollbar,
    .detail-info::-webkit-scrollbar {
      width: 6px;
    }

    .order-list::-webkit-scrollbar-track,
    .detail-info::-webkit-scrollbar-track {
      background: transparent;
    }

    .order-list::-webkit-scrollbar-thumb,
    .detail-info::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.15);
      border-radius: 3px;
    }

    .order-list::-webkit-scrollbar-thumb:hover,
    .detail-info::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.25);
    }
  </style>
  
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <button class="profile-btn no-photo" id="profileBtn" onclick="openProfile()" tabindex="0">
          üë§
        </button>
        <div class="header-title" data-ru="–ü—Ä–æ—Ñ–∏–ª—å" data-kz="–ü—Ä–æ—Ñ–∏–ª—å" onclick="openProfile()" tabindex="0">–ü—Ä–æ—Ñ–∏–ª—å</div>
      </div>
      <div class="header-right">
        <button class="refresh-btn" id="refreshBtn" onclick="refreshOrders()" tabindex="0" aria-label="–û–±–Ω–æ–≤–∏—Ç—å –∑–∞–∫–∞–∑—ã">üîÑ</button>
        <div class="lang-switch">
          <button class="lang-btn active" onclick="setLang('ru')" id="lang-ru" tabindex="0">RU</button>
          <button class="lang-btn" onclick="setLang('kz')" id="lang-kz" tabindex="0">KZ</button>
        </div>
      </div>
    </div>

    <!-- New Order Notification -->
    <div class="new-order-notification" id="newOrderNotification">
      <div class="notification-content">
        <div class="notification-icon">üöö</div>
        <div class="notification-text">
          <div class="notification-title" data-ru="–ù–æ–≤—ã–π –∑–∞–∫–∞–∑!" data-kz="–ñ–∞“£–∞ —Ç–∞–ø—Å—ã—Ä—ã—Å!">–ù–æ–≤—ã–π –∑–∞–∫–∞–∑!</div>
          <div class="notification-subtitle" id="notificationSubtitle" data-ru="–£ –≤–∞—Å –µ—Å—Ç—å –Ω–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã" data-kz="–°—ñ–∑–¥–µ –∂–∞“£–∞ —Ç–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä –±–∞—Ä">–£ –≤–∞—Å –µ—Å—Ç—å –Ω–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã</div>
        </div>
      </div>
    </div>

    <!-- Stats Bar -->
    <div class="stats-bar">
      <div class="stat-item">
        <div class="stat-value" id="totalOrders">0</div>
        <div class="stat-label" data-ru="–í—Å–µ–≥–æ" data-kz="–ë–∞—Ä–ª—ã“õ">–í—Å–µ–≥–æ</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="nearbyOrders">0</div>
        <div class="stat-label" data-ru="–†—è–¥–æ–º" data-kz="–ñ–∞“õ—ã–Ω">–†—è–¥–æ–º</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="avgPrice">0‚Ç∏</div>
        <div class="stat-label" data-ru="–°—Ä–µ–¥–Ω—è—è" data-kz="–û—Ä—Ç–∞—à–∞">–°—Ä–µ–¥–Ω—è—è</div>
      </div>
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar">
      <div class="filter-chip active" data-filter="all" onclick="setFilter('all')" tabindex="0" role="button">
        <span data-ru="–í—Å–µ" data-kz="–ë–∞—Ä–ª—ã“õ">–í—Å–µ</span>
      </div>
      <div class="filter-chip" data-filter="new" onclick="setFilter('new')" tabindex="0" role="button">
        <span data-ru="–ù–æ–≤—ã–µ" data-kz="–ñ–∞“£–∞">–ù–æ–≤—ã–µ</span>
      </div>
      <div class="filter-chip" data-filter="nearby" onclick="setFilter('nearby')" tabindex="0" role="button">
        <span data-ru="–†—è–¥–æ–º" data-kz="–ñ–∞“õ—ã–Ω">–†—è–¥–æ–º</span>
      </div>
      <div class="filter-chip" data-filter="expensive" onclick="setFilter('expensive')" tabindex="0" role="button">
        <span data-ru="–î–æ—Ä–æ–≥–∏–µ" data-kz="“ö—ã–º–±–∞—Ç">–î–æ—Ä–æ–≥–∏–µ</span>
      </div>
    </div>

    <!-- Order List -->
    <div class="order-list" id="orderList">
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <div class="loading-text" data-ru="–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤..." data-kz="–¢–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä–¥—ã –∂“Ø–∫—Ç–µ—É...">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</div>
      </div>
    </div>
  </div>

  <!-- UBER-STYLE Order Detail Modal - OPTIMIZED FOR TELEGRAM -->
  <div class="detail-modal" id="detailModal" role="dialog" aria-modal="true" aria-labelledby="detailTitle">
    <div class="detail-sheet">
      <div class="detail-header">
        <div class="detail-title" id="detailTitle" data-ru="–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞" data-kz="–¢–∞–ø—Å—ã—Ä—ã—Å –º”ô–ª—ñ–º–µ—Ç—Ç–µ—Ä—ñ">–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞</div>
        <button class="close-btn" onclick="closeDetail()" tabindex="0" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
      </div>
      
      <div class="detail-content">
        <div class="detail-map">
          <div id="detailMap"></div>
          <div class="map-overlay" id="mapOverlay">
            <div class="route-eta">
              <span>üöó</span>
              <span id="routeEta">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
          </div>
        </div>
        
        <div class="detail-info" id="detailInfo">
          <div class="price-highlight">
            <div class="price-amount" id="detailPrice">0‚Ç∏</div>
            <div class="price-label" data-ru="–ó–∞ –¥–æ—Å—Ç–∞–≤–∫—É" data-kz="–ñ–µ—Ç–∫—ñ–∑—É “Ø—à—ñ–Ω">–ó–∞ –¥–æ—Å—Ç–∞–≤–∫—É</div>
          </div>

          <div class="route-details">
            <div class="route-step">
              <div class="step-marker pickup">A</div>
              <div class="step-info">
                <div class="step-address" id="pickupAddress">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <div class="step-label" data-ru="–ó–∞–±—Ä–∞—Ç—å" data-kz="–ê–ª—ã–ø –∫–µ—Ç—É">–ó–∞–±—Ä–∞—Ç—å</div>
              </div>
            </div>
            
            <div class="route-step">
              <div class="step-marker dropoff">B</div>
              <div class="step-info">
                <div class="step-address" id="dropoffAddress">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <div class="step-label" data-ru="–î–æ—Å—Ç–∞–≤–∏—Ç—å" data-kz="–ñ–µ—Ç–∫—ñ–∑—É">–î–æ—Å—Ç–∞–≤–∏—Ç—å</div>
              </div>
            </div>
          </div>

          <div class="order-meta">
            <div class="meta-item">
              <div class="meta-value" id="detailTruck">--</div>
              <div class="meta-label" data-ru="–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç" data-kz="–ö”©–ª—ñ–∫">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</div>
            </div>
            <div class="meta-item">
              <div class="meta-value" id="detailTime">--</div>
              <div class="meta-label" data-ru="–í—Ä–µ–º—è" data-kz="–£–∞“õ—ã—Ç">–í—Ä–µ–º—è</div>
            </div>
          </div>

          <div class="contact-section" id="contactSection">
            <div class="contact-title" data-ru="–ö–æ–Ω—Ç–∞–∫—Ç –∫–ª–∏–µ–Ω—Ç–∞" data-kz="–ö–ª–∏–µ–Ω—Ç –±–∞–π–ª–∞–Ω—ã—Å—ã">–ö–æ–Ω—Ç–∞–∫—Ç –∫–ª–∏–µ–Ω—Ç–∞</div>
            <div class="contact-phone" id="contactPhone">+7 (___) ___-__-__</div>
            
            <div class="contact-buttons">
              <a href="#" class="contact-btn" id="callBtn" tabindex="0">
                <span>üìû</span>
                <span data-ru="–ó–≤–æ–Ω–æ–∫" data-kz="“ö–æ“£—ã—Ä–∞—É">–ó–≤–æ–Ω–æ–∫</span>
              </a>
              <a href="#" class="contact-btn" id="whatsappBtn" tabindex="0">
                <span>üí¨</span>
                <span>WhatsApp</span>
              </a>
            </div>
          </div>

          <button class="accept-button" onclick="acceptOrder()" id="acceptOrderBtn" tabindex="0">
            <span data-ru="–ü—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑" data-kz="–¢–∞–ø—Å—ã—Ä—ã—Å—Ç—ã “õ–∞–±—ã–ª–¥–∞—É">–ü—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let currentLang = 'ru';
    let currentFilter = 'all';
    let orders = [];
    let driverLocation = null;
    let refreshInterval = null;
    let detailMap = null;
    let driverData = null;
    let currentOrder = null;
    
    // Auto-sound notification system (always enabled)
    let audioContext = null;
    let previousOrderCount = 0;
    let lastOrderIds = new Set();

    // Enhanced Auto-Sound Notification System
    class AutoSoundNotification {
      constructor() {
        this.audioContext = null;
        this.enabled = true;
        this.initAudioContext();
        console.log('üîä Auto-sound notifications always enabled');
      }

      async initAudioContext() {
        try {
          this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
          console.log('üîä Audio context initialized for auto-notifications');
        } catch (error) {
          console.warn('‚ö†Ô∏è Audio context not supported:', error);
        }
      }

      async playNotificationSound() {
        if (!this.audioContext) {
          return;
        }

        try {
          if (this.audioContext.state === 'suspended') {
            await this.audioContext.resume();
          }

          const oscillator1 = this.audioContext.createOscillator();
          const oscillator2 = this.audioContext.createOscillator();
          const oscillator3 = this.audioContext.createOscillator();
          const gainNode = this.audioContext.createGain();

          oscillator1.connect(gainNode);
          oscillator2.connect(gainNode);
          oscillator3.connect(gainNode);
          gainNode.connect(this.audioContext.destination);

          oscillator1.frequency.setValueAtTime(800, this.audioContext.currentTime);
          oscillator2.frequency.setValueAtTime(1000, this.audioContext.currentTime);
          oscillator3.frequency.setValueAtTime(1200, this.audioContext.currentTime);

          gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
          gainNode.gain.linearRampToValueAtTime(0.3, this.audioContext.currentTime + 0.1);
          gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.8);

          oscillator1.start(this.audioContext.currentTime);
          oscillator2.start(this.audioContext.currentTime + 0.1);
          oscillator3.start(this.audioContext.currentTime + 0.2);
          
          oscillator1.stop(this.audioContext.currentTime + 0.3);
          oscillator2.stop(this.audioContext.currentTime + 0.5);
          oscillator3.stop(this.audioContext.currentTime + 0.8);

          console.log('üîä Enhanced notification sound played');
        } catch (error) {
          console.error('‚ùå Error playing notification sound:', error);
        }
      }

      isEnabled() {
        return this.enabled;
      }
    }

    const autoSoundNotification = new AutoSoundNotification();

    // Translations
    const translations = {
      ru: {
        orders: '–í—Å–µ–≥–æ',
        nearby: '–†—è–¥–æ–º',
        avgPrice: '–°—Ä–µ–¥–Ω—è—è',
        all: '–í—Å–µ',
        new: '–ù–æ–≤—ã–µ',
        expensive: '–î–æ—Ä–æ–≥–∏–µ',
        loading: '–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...',
        noOrders: '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤',
        noOrdersDesc: '–ó–∞–∫–∞–∑—ã –ø–æ—è–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏',
        from: '–û—Ç–∫—É–¥–∞',
        to: '–ö—É–¥–∞',
        price: '–¶–µ–Ω–∞',
        distance: '–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ',
        time: '–í—Ä–µ–º—è',
        comment: '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π',
        truck: '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç',
        contact: '–°–≤—è–∑–∞—Ç—å—Å—è',
        call: '–ó–≤–æ–Ω–æ–∫',
        orderDetails: '–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞',
        clientInfo: '–ö–æ–Ω—Ç–∞–∫—Ç –∫–ª–∏–µ–Ω—Ç–∞',
        km: '–∫–º',
        min: '–º–∏–Ω',
        small: '–ú–∞–ª—ã–π',
        medium: '–°—Ä–µ–¥–Ω–∏–π', 
        large: '–ë–æ–ª—å—à–æ–π',
        refrigerator: '–†–µ—Ñ—Ä–∏–∂–µ—Ä–∞—Ç–æ—Ä',
        tow: '–≠–≤–∞–∫—É–∞—Ç–æ—Ä',
        any: '–õ—é–±–æ–π',
        acceptOrder: '–ü—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑',
        calculating: '–†–∞—Å—á–µ—Ç...',
        pickup: '–ó–∞–±—Ä–∞—Ç—å',
        deliver: '–î–æ—Å—Ç–∞–≤–∏—Ç—å',
        now: '–°–µ–π—á–∞—Å',
        new_order: '–ù–û–í–´–ô',
        newOrderTitle: '–ù–æ–≤—ã–π –∑–∞–∫–∞–∑!',
        newOrderSubtitle: '–£ –≤–∞—Å –µ—Å—Ç—å –Ω–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã'
      },
      kz: {
        orders: '–ë–∞—Ä–ª—ã“õ',
        nearby: '–ñ–∞“õ—ã–Ω',
        avgPrice: '–û—Ä—Ç–∞—à–∞',
        all: '–ë–∞—Ä–ª—ã“õ',
        new: '–ñ–∞“£–∞',
        expensive: '“ö—ã–º–±–∞—Ç',
        loading: '–¢–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä–¥—ã –∂“Ø–∫—Ç–µ—É...',
        noOrders: '“ö–æ–ª –∂–µ—Ç—ñ–º–¥—ñ —Ç–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä –∂–æ“õ',
        noOrdersDesc: '–¢–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä –∞–≤—Ç–æ–º–∞—Ç—Ç—ã —Ç“Ø—Ä–¥–µ –ø–∞–π–¥–∞ –±–æ–ª–∞–¥—ã',
        from: '“ö–∞–π–¥–∞–Ω',
        to: '“ö–∞–π–¥–∞',
        price: '–ë–∞“ì–∞—Å—ã',
        distance: '“ö–∞—à—ã“õ—Ç—ã“õ',
        time: '–£–∞“õ—ã—Ç',
        comment: '–¢“Ø—Å—ñ–Ω—ñ–∫—Ç–µ–º–µ',
        truck: '–ö”©–ª—ñ–∫',
        contact: '–ë–∞–π–ª–∞–Ω—ã—Å—É',
        call: '“ö–æ“£—ã—Ä–∞—É',
        orderDetails: '–¢–∞–ø—Å—ã—Ä—ã—Å –º”ô–ª—ñ–º–µ—Ç—Ç–µ—Ä—ñ',
        clientInfo: '–ö–ª–∏–µ–Ω—Ç –±–∞–π–ª–∞–Ω—ã—Å—ã',
        km: '–∫–º',
        min: '–º–∏–Ω',
        small: '–ö—ñ—à—ñ',
        medium: '–û—Ä—Ç–∞',
        large: '“Æ–ª–∫–µ–Ω',
        refrigerator: '–†–µ—Ñ—Ä–∏–∂–µ—Ä–∞—Ç–æ—Ä',
        tow: '–≠–≤–∞–∫—É–∞—Ç–æ—Ä',
        any: '–ö–µ–∑ –∫–µ–ª–≥–µ–Ω',
        acceptOrder: '–¢–∞–ø—Å—ã—Ä—ã—Å—Ç—ã “õ–∞–±—ã–ª–¥–∞—É',
        calculating: '–ï—Å–µ–ø—Ç–µ—É...',
        pickup: '–ê–ª—ã–ø –∫–µ—Ç—É',
        deliver: '–ñ–µ—Ç–∫—ñ–∑—É',
        now: '“ö–∞–∑—ñ—Ä',
        new_order: '–ñ–ê“¢–ê',
        newOrderTitle: '–ñ–∞“£–∞ —Ç–∞–ø—Å—ã—Ä—ã—Å!',
        newOrderSubtitle: '–°—ñ–∑–¥–µ –∂–∞“£–∞ —Ç–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä –±–∞—Ä'
      }
    };

    // Initialize Telegram WebApp
    function initTelegram() {
      if (window.Telegram && Telegram.WebApp) {
        console.log('üì± Initializing Telegram WebApp for delivery list');
        
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        Telegram.WebApp.disableVerticalSwipes();
        
        if (Telegram.WebApp.colorScheme === 'dark') {
          document.documentElement.style.setProperty('--tg-theme-bg-color', '#1c1c1e');
          document.documentElement.style.setProperty('--tg-theme-text-color', '#ffffff');
        }

        const user = Telegram.WebApp.initDataUnsafe?.user;
        if (user) {
          window.telegramUserId = user.id;
          console.log('üë§ Got Telegram user ID:', user.id);
        }

        Telegram.WebApp.MainButton.hide();
        
        console.log('‚úÖ Telegram WebApp initialized for delivery list');
      } else {
        console.log('‚ö†Ô∏è Telegram WebApp not available - running in browser mode');
        window.telegramUserId = 12345;
      }
    }

    // Load driver profile with profile photo from ./ava directory
    async function loadDriverProfile() {
      try {
        const telegramId = window.telegramUserId;
        if (!telegramId) {
          console.log('‚ö†Ô∏è No Telegram ID available for profile loading');
          return;
        }

        console.log('üë§ Loading driver profile for ID:', telegramId);

        const response = await fetch('/api/check/who', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            telegram_id: parseInt(telegramId)
          })
        });

        const result = await response.json();
        console.log('üìä Driver profile response:', result);
        
        if (result.success && result.data.exists && result.data.user_type === 'driver') {
          driverData = result.data.driver_data;
          console.log('üöó Driver data loaded:', driverData);
          
          const profileBtn = document.getElementById('profileBtn');
          
          if (driverData.profile_photo && driverData.profile_photo.trim() !== '') {
            console.log('üì∏ Loading profile photo:', driverData.profile_photo);
            
            const avatarPath = `./ava/${driverData.profile_photo}`;
            
            const img = new Image();
            
            img.onload = function() {
              console.log('‚úÖ Profile photo loaded successfully from ./ava directory:', avatarPath);
              profileBtn.innerHTML = `<img src="${avatarPath}" alt="Profile" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
              profileBtn.classList.remove('no-photo');
              profileBtn.title = `${driverData.first_name || ''} ${driverData.last_name || ''}`.trim();
            };
            
            img.onerror = function() {
              console.warn('‚ùå Failed to load profile photo from ./ava directory:', avatarPath);
              
              const fallbackPaths = [
                `/ava/${driverData.profile_photo}`,
                `/files/${driverData.profile_photo}`,
                `/static/ava/${driverData.profile_photo}`
              ];
              
              let loaded = false;
              fallbackPaths.forEach((path, index) => {
                if (loaded) return;
                
                const fallbackImg = new Image();
                fallbackImg.onload = function() {
                  if (!loaded) {
                    loaded = true;
                    console.log(`‚úÖ Profile photo loaded from fallback path ${index + 1}:`, path);
                    profileBtn.innerHTML = `<img src="${path}" alt="Profile" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                    profileBtn.classList.remove('no-photo');
                  }
                };
                fallbackImg.onerror = function() {
                  console.warn(`‚ùå Fallback path ${index + 1} failed:`, path);
                };
                fallbackImg.src = path;
              });
              
              setTimeout(() => {
                if (!loaded) {
                  console.log('üë§ Using default profile icon - all photo paths failed');
                  profileBtn.innerHTML = 'üë§';
                  profileBtn.classList.add('no-photo');
                  profileBtn.title = `${driverData.first_name || ''} ${driverData.last_name || ''}`.trim();
                }
              }, 3000);
            };
            
            img.src = avatarPath;
            
          } else {
            console.log('üë§ No profile photo available - using default icon');
            profileBtn.innerHTML = 'üë§';
            profileBtn.classList.add('no-photo');
            profileBtn.title = `${driverData.first_name || ''} ${driverData.last_name || ''}`.trim();
          }
          
        } else {
          console.log('‚ö†Ô∏è Not a valid driver or no driver data');
          const profileBtn = document.getElementById('profileBtn');
          profileBtn.innerHTML = 'üë§';
          profileBtn.classList.add('no-photo');
        }
      } catch (error) {
        console.error('‚ùå Error loading driver profile:', error);
        const profileBtn = document.getElementById('profileBtn');
        profileBtn.innerHTML = 'üë§';
        profileBtn.classList.add('no-photo');
      }
    }

    // Open profile page
    function openProfile() {
      console.log('üîß Profile button clicked - navigating to driver update page');
      
      const telegramId = window.telegramUserId;
      if (!telegramId) {
        console.error('‚ùå No Telegram ID available for profile update');
        alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        return;
      }

      const updateUrl = `/driver-update?telegram_id=${telegramId}`;
      console.log('üîó Navigating to:', updateUrl);
      
      if (window.Telegram && Telegram.WebApp) {
        window.location.href = updateUrl;
      } else {
        window.location.href = updateUrl;
      }
    }

    // Get driver location
    function getDriverLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject(new Error('Geolocation not supported'));
          return;
        }

        navigator.geolocation.getCurrentPosition(
          (position) => {
            driverLocation = {
              lat: position.coords.latitude,
              lon: position.coords.longitude
            };
            console.log('üìç Driver location obtained:', driverLocation);
            resolve(driverLocation);
          },
          (error) => {
            console.warn('‚ö†Ô∏è Geolocation error:', error);
            driverLocation = { lat: 43.238949, lon: 76.889709 };
            resolve(driverLocation);
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 60000
          }
        );
      });
    }

    // Calculate distance between two points
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // Check for new orders with auto-sound
    function checkForNewOrders(newOrders) {
      if (!newOrders || newOrders.length === 0) {
        return;
      }

      const currentOrderIds = new Set(newOrders.map(order => order.id));
      const hasNewOrders = newOrders.some(order => !lastOrderIds.has(order.id));
      
      lastOrderIds = currentOrderIds;

      if (hasNewOrders && previousOrderCount > 0) {
        const newOrderCount = newOrders.length - previousOrderCount;
        console.log('üÜï New orders detected:', newOrderCount);
        
        autoSoundNotification.playNotificationSound();
        
        showNewOrderVisualNotification(newOrderCount);
      }

      previousOrderCount = newOrders.length;
    }

    // Show visual notification for new orders
    function showNewOrderVisualNotification(count = 1) {
      const notification = document.getElementById('newOrderNotification');
      const subtitle = document.getElementById('notificationSubtitle');
      
      if (notification && subtitle) {
        const countText = count > 1 ? ` (${count})` : '';
        if (currentLang === 'ru') {
          subtitle.textContent = `–£ –≤–∞—Å ${count === 1 ? '–Ω–æ–≤—ã–π –∑–∞–∫–∞–∑' : `${count} –Ω–æ–≤—ã—Ö –∑–∞–∫–∞–∑–∞`}`;
        } else {
          subtitle.textContent = `–°—ñ–∑–¥–µ ${count === 1 ? '–∂–∞“£–∞ —Ç–∞–ø—Å—ã—Ä—ã—Å' : `${count} –∂–∞“£–∞ —Ç–∞–ø—Å—ã—Ä—ã—Å`} –±–∞—Ä`;
        }

        notification.classList.add('show');

        setTimeout(() => {
          notification.classList.remove('show');
        }, 4000);
      }
    }

    // Load orders
    async function loadOrders() {
      try {
        console.log('üì¶ Loading orders from API...');
        
        if (!driverLocation) {
          await getDriverLocation();
        }

        const requestData = {
          telegram_id: window.telegramUserId || 0,
          driver_lat: driverLocation?.lat || 43.238949,
          driver_lon: driverLocation?.lon || 76.889709,
          radius: 50
        };

        console.log('üîç Requesting orders with data:', requestData);

        const response = await fetch('/api/delivery-list', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestData)
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        console.log('üìä Orders API response:', result);
        
        if (result.success && result.data) {
          const newOrders = result.data.orders || [];
          console.log('üì¶ Loaded orders count:', newOrders.length);
          
          checkForNewOrders(newOrders);
          
          orders = newOrders;
          
          if (driverLocation) {
            orders.forEach(order => {
              order.distance = calculateDistance(
                driverLocation.lat, driverLocation.lon,
                order.from_lat, order.from_lon
              );
              
              const createdAt = new Date(order.created_at);
              const now = new Date();
              const diffMinutes = (now - createdAt) / (1000 * 60);
              order.isNew = diffMinutes < 10;
            });
          }
          
          orders.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
          
          updateStats();
          displayOrders();
        } else {
          throw new Error(result.message || 'Failed to load orders');
        }
      } catch (error) {
        console.error('‚ùå Error loading orders:', error);
        showEmptyState();
      }
    }

    // Update statistics
    function updateStats() {
      const nearbyOrders = orders.filter(order => (order.distance || 999) <= 5).length;
      const avgPrice = orders.length > 0 ? 
        Math.round(orders.reduce((sum, order) => sum + (order.price || 0), 0) / orders.length) : 0;

      document.getElementById('totalOrders').textContent = orders.length;
      document.getElementById('nearbyOrders').textContent = nearbyOrders;
      document.getElementById('avgPrice').textContent = avgPrice + '‚Ç∏';
      
      console.log('üìä Stats updated - Total:', orders.length, 'Nearby:', nearbyOrders, 'Avg price:', avgPrice);
    }

    // Display orders
    function displayOrders() {
      const container = document.getElementById('orderList');
      
      let filteredOrders = [...orders];
      
      switch (currentFilter) {
        case 'new':
          filteredOrders = orders.filter(order => order.isNew);
          break;
        case 'nearby':
          filteredOrders = orders.filter(order => (order.distance || 999) <= 5);
          break;
        case 'expensive':
          filteredOrders = orders.filter(order => (order.price || 0) >= 5000);
          break;
      }

      console.log('üîç Filtered orders count:', filteredOrders.length, 'Filter:', currentFilter);

      if (filteredOrders.length === 0) {
        showEmptyState();
        return;
      }

      const fragment = document.createDocumentFragment();
      
      filteredOrders.forEach((order, index) => {
        const orderElement = createOrderCard(order, index);
        fragment.appendChild(orderElement);
      });

      container.innerHTML = '';
      container.appendChild(fragment);
      
      const cards = container.querySelectorAll('.order-card');
      cards.forEach((card, index) => {
        setTimeout(() => {
          card.classList.add('fade-in');
        }, index * 50);
      });
    }

    // Create order card - NO ORDER ID DISPLAY FOR SECURITY
    function createOrderCard(order, index) {
      const createdAt = new Date(order.created_at);
      const timeText = formatTime(createdAt);
      const distanceText = order.distance ? `${order.distance.toFixed(1)} ${translations[currentLang].km}` : '';
      const truckType = formatTruckType(order.truck_type);
      
      const cardElement = document.createElement('div');
      cardElement.className = `order-card ${order.isNew ? 'new' : ''}`;
      cardElement.onclick = () => showOrderDetail(order.id);
      cardElement.setAttribute('tabindex', '0');
      cardElement.setAttribute('role', 'button');
      cardElement.setAttribute('aria-label', `–ó–∞–∫–∞–∑ –æ—Ç ${timeText}`);
      
      cardElement.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          showOrderDetail(order.id);
        }
      });
      
      cardElement.innerHTML = `
        ${order.distance && order.distance <= 5 ? `<div class="distance-badge nearby">${distanceText}</div>` : 
          order.distance ? `<div class="distance-badge">${distanceText}</div>` : ''}
        
        <div class="order-header">
          <div class="order-time">
            <span>‚è∞</span>
            <span>${timeText}</span>
            ${order.isNew ? `<span class="new-badge">${translations[currentLang].new_order}</span>` : ''}
          </div>
        </div>
        
        <div class="order-route">
          <div class="route-point">
            <div class="route-marker from">A</div>
            <div class="route-info">
              <div class="route-label">${translations[currentLang].from}</div>
              <div class="route-address">${order.from_address}</div>
            </div>
          </div>
          
          <div class="route-point">
            <div class="route-marker to">B</div>
            <div class="route-info">
              <div class="route-label">${translations[currentLang].to}</div>
              <div class="route-address">${order.to_address}</div>
            </div>
          </div>
        </div>
        
        <div class="order-details">
          <div class="detail-item">
            <div class="detail-value price">${order.price}‚Ç∏</div>
            <div class="detail-label">${translations[currentLang].price}</div>
          </div>
          
          <div class="detail-item">
            <div class="detail-value">${distanceText || '--'}</div>
            <div class="detail-label">${translations[currentLang].distance}</div>
          </div>
          
          <div class="detail-item">
            <div class="detail-value">${formatTime(new Date(order.time_start || order.created_at))}</div>
            <div class="detail-label">${translations[currentLang].time}</div>
          </div>
        </div>
        
        ${order.comment || order.truck_type ? `
          <div class="order-footer">
            <div class="order-comment">${order.comment || ''}</div>
            <div class="truck-type">${truckType}</div>
          </div>
        ` : ''}
      `;
      
      return cardElement;
    }

    // Show order detail with bigger modal
    function showOrderDetail(orderId) {
      const order = orders.find(o => o.id === orderId);
      if (!order) return;

      console.log('üìã Showing order detail for ID:', orderId);
      currentOrder = order;
      
      document.getElementById('detailModal').classList.add('show');
      
      document.getElementById('detailPrice').textContent = `${order.price}‚Ç∏`;
      document.getElementById('pickupAddress').textContent = order.from_address;
      document.getElementById('dropoffAddress').textContent = order.to_address;
      
      document.getElementById('detailTruck').textContent = formatTruckType(order.truck_type);
      document.getElementById('detailTime').textContent = formatTime(new Date(order.time_start || order.created_at));
      
      document.getElementById('contactPhone').textContent = order.contact;
      document.getElementById('callBtn').href = `tel:${order.contact}`;
      document.getElementById('whatsappBtn').href = `https://wa.me/${order.contact.replace(/\D/g, '')}`;
      
      setTimeout(() => {
        initDetailMap(order);
      }, 300);
    }

    // Initialize detail map
    async function initDetailMap(order) {
      if (detailMap) {
        detailMap.remove();
      }

      try {
        console.log('üó∫Ô∏è Initializing map for order:', order.id);
        
        const centerLat = (order.from_lat + order.to_lat) / 2;
        const centerLon = (order.from_lon + order.to_lon) / 2;

        detailMap = L.map('detailMap', {
          zoomControl: false,
          attributionControl: false,
          scrollWheelZoom: true,
          touchZoom: true,
          doubleClickZoom: false,
          boxZoom: false,
          keyboard: false,
          fadeAnimation: true,
          zoomAnimation: true,
          markerZoomAnimation: true
        }).setView([centerLat, centerLon], 13);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
          maxZoom: 19,
          attribution: '',
          subdomains: 'abcd'
        }).addTo(detailMap);

        const pickupIcon = L.divIcon({
          html: '<div class="uber-marker pickup">A</div>',
          className: 'uber-marker-container',
          iconSize: [36, 44],
          iconAnchor: [18, 44]
        });

        const dropoffIcon = L.divIcon({
          html: '<div class="uber-marker dropoff">B</div>',
          className: 'uber-marker-container',
          iconSize: [36, 44],
          iconAnchor: [18, 44]
        });

        L.marker([order.from_lat, order.from_lon], { icon: pickupIcon }).addTo(detailMap);
        L.marker([order.to_lat, order.to_lon], { icon: dropoffIcon }).addTo(detailMap);

        await drawRoute(order);

        const bounds = L.latLngBounds([
          [order.from_lat, order.from_lon],
          [order.to_lat, order.to_lon]
        ]);
        
        detailMap.fitBounds(bounds, {
          padding: [40, 40],
          maxZoom: 16
        });

      } catch (error) {
        console.error('‚ùå Error initializing map:', error);
      }
    }

    // Draw route
    async function drawRoute(order) {
      try {
        console.log('üõ£Ô∏è Drawing route...');
        
        document.getElementById('routeEta').innerHTML = `
          <span>üöó</span>
          <span>${translations[currentLang].calculating}</span>
        `;

        const url = `https://router.project-osrm.org/route/v1/driving/${order.from_lon},${order.from_lat};${order.to_lon},${order.to_lat}?overview=full&geometries=geojson&steps=true`;
        
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error('OSRM API request failed');
        }
        
        const data = await response.json();
        
        if (data.routes && data.routes.length > 0) {
          const route = data.routes[0];
          const geometry = route.geometry;
          
          const coordinates = geometry.coordinates.map(coord => [coord[1], coord[0]]);
          
          const routeLine = L.polyline(coordinates, {
            color: '#000000',
            weight: 5,
            opacity: 0.9,
            smoothFactor: 1,
            lineCap: 'round',
            lineJoin: 'round'
          }).addTo(detailMap);

          const shadowLine = L.polyline(coordinates, {
            color: '#00000030',
            weight: 7,
            opacity: 0.3,
            smoothFactor: 1,
            lineCap: 'round',
            lineJoin: 'round'
          });
          
          shadowLine.addTo(detailMap);
          shadowLine.bringToBack();

          const distanceKm = (route.distance / 1000).toFixed(1);
          const durationMin = Math.round(route.duration / 60);
          
          document.getElementById('routeEta').innerHTML = `
            <span>üöó</span>
            <span>${distanceKm} ${translations[currentLang].km} ‚Ä¢ ${durationMin} ${translations[currentLang].min}</span>
          `;
          
          console.log('‚úÖ Route drawn successfully');
          
        } else {
          throw new Error('No route found');
        }
        
      } catch (error) {
        console.error('‚ùå Error drawing route:', error);
        
        const straightLine = L.polyline([
          [order.from_lat, order.from_lon],
          [order.to_lat, order.to_lon]
        ], {
          color: '#000000',
          weight: 4,
          opacity: 0.7,
          dashArray: '10, 5',
          lineCap: 'round'
        }).addTo(detailMap);

        const distance = calculateDistance(order.from_lat, order.from_lon, order.to_lat, order.to_lon);
        const time = Math.round((distance / 40) * 60);
        
        document.getElementById('routeEta').innerHTML = `
          <span>üöó</span>
          <span>${distance.toFixed(1)} ${translations[currentLang].km} ‚Ä¢ ${time} ${translations[currentLang].min}</span>
        `;
      }
    }

    // Accept order function
    async function acceptOrder() {
      if (!currentOrder) return;
      
      try {
        console.log('‚úÖ Accepting order:', currentOrder.id);
        
        const acceptBtn = document.getElementById('acceptOrderBtn');
        acceptBtn.disabled = true;
        acceptBtn.innerHTML = '<span>‚è≥ –ü—Ä–∏–Ω–∏–º–∞–µ–º...</span>';
        
        const response = await fetch('/api/driver/accept-order', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            telegram_id: window.telegramUserId,
            order_id: currentOrder.id
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          acceptBtn.innerHTML = '<span>‚úÖ –ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç!</span>';
          acceptBtn.style.background = '#388E3C';
          
          setTimeout(() => {
            closeDetail();
            loadOrders();
          }, 2000);
          
        } else {
          throw new Error(result.message || 'Failed to accept order');
        }
        
      } catch (error) {
        console.error('‚ùå Error accepting order:', error);
        
        const acceptBtn = document.getElementById('acceptOrderBtn');
        acceptBtn.disabled = false;
        acceptBtn.innerHTML = `<span>‚ùå –û—à–∏–±–∫–∞! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞</span>`;
        acceptBtn.style.background = '#D32F2F';
        
        setTimeout(() => {
          acceptBtn.innerHTML = `<span>${translations[currentLang].acceptOrder}</span>`;
          acceptBtn.style.background = '';
        }, 3000);
      }
    }

    // Close detail modal
    function closeDetail() {
      document.getElementById('detailModal').classList.remove('show');
      currentOrder = null;
      
      if (detailMap) {
        detailMap.remove();
        detailMap = null;
      }
    }

    // Show empty state
    function showEmptyState() {
      const container = document.getElementById('orderList');
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">üì¶</div>
          <div class="empty-title">${translations[currentLang].noOrders}</div>
          <div class="empty-message">${translations[currentLang].noOrdersDesc}</div>
        </div>
      `;
    }

    // Format time
    function formatTime(date) {
      const now = new Date();
      const diffMs = date - now;
      const diffMinutes = Math.abs(diffMs) / (1000 * 60);
      
      if (diffMinutes < 60) {
        return translations[currentLang].now;
      } else {
        return date.toLocaleTimeString(currentLang === 'ru' ? 'ru-RU' : 'kk-KZ', {
          hour: '2-digit',
          minute: '2-digit'
        });
      }
    }

    // Format truck type
    function formatTruckType(type) {
      const types = {
        small: translations[currentLang].small,
        medium: translations[currentLang].medium,
        large: translations[currentLang].large,
        refrigerator: translations[currentLang].refrigerator,
        tow: translations[currentLang].tow,
        any: translations[currentLang].any,
        '': translations[currentLang].any
      };
      return types[type] || type || translations[currentLang].any;
    }

    // Set filter
    function setFilter(filter) {
      currentFilter = filter;
      console.log('üîç Filter changed to:', filter);
      
      document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.classList.remove('active');
      });
      document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
      
      displayOrders();
    }

    // Refresh orders
    function refreshOrders() {
      console.log('üîÑ Manual refresh triggered');
      const btn = document.getElementById('refreshBtn');
      btn.classList.add('loading');
      
      loadOrders().finally(() => {
        btn.classList.remove('loading');
      });
    }

    // Set language
    function setLang(lang) {
      currentLang = lang;
      console.log('üåê Language changed to:', lang);
      
      document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`lang-${lang}`).classList.add('active');
      
      document.querySelectorAll('[data-ru]').forEach(el => {
        const text = el.getAttribute(`data-${lang}`);
        if (text) {
          el.textContent = text;
        }
      });

      updateStats();
      displayOrders();
    }

    // Auto-refresh
    function startAutoRefresh() {
      console.log('üîÑ Starting auto-refresh (8 seconds interval)');
      refreshInterval = setInterval(() => {
        loadOrders();
      }, 8000);
    }

    function stopAutoRefresh() {
      if (refreshInterval) {
        console.log('üõë Stopping auto-refresh');
        clearInterval(refreshInterval);
        refreshInterval = null;
      }
    }

    // Initialize app
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ Uber-Style Minimal Delivery List App initializing...');
      
      initTelegram();
      setLang('ru');
      
      loadDriverProfile();
      loadOrders();
      startAutoRefresh();
      
      console.log('‚úÖ Uber-Style Minimal Delivery List App initialized with Telegram WebApp optimization');
    });

    // Handle page visibility changes
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        console.log('üëÅÔ∏è Page hidden - stopping auto-refresh');
        stopAutoRefresh();
      } else {
        console.log('üëÅÔ∏è Page visible - restarting auto-refresh');
        loadOrders();
        startAutoRefresh();
      }
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      console.log('üßπ Page unloading - cleaning up');
      stopAutoRefresh();
      if (detailMap) {
        detailMap.remove();
      }
    });

    // Close modal on backdrop click
    document.getElementById('detailModal').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) {
        closeDetail();
      }
    });

    // ESC key to close modal
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && document.getElementById('detailModal').classList.contains('show')) {
        closeDetail();
      }
    });

    // Make functions globally available
    window.openProfile = openProfile;
    window.refreshOrders = refreshOrders;
    window.setFilter = setFilter;
    window.setLang = setLang;
    window.showOrderDetail = showOrderDetail;
    window.closeDetail = closeDetail;
    window.acceptOrder = acceptOrder;

    console.log('üìã Uber-Style Minimal Delivery List with Telegram WebApp optimization loaded successfully');
  </script>
</body>
</html>