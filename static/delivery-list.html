<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
  <title>–ó–∞–∫–∞–∑—ã | –¢–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä</title>

  <!-- Telegram SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      /* Telegram theme fallbacks */
      --tg-theme-bg-color:#ffffff;
      --tg-theme-text-color:#0f172a;

      /* Design tokens (Uber-ish) */
      --primary:#000000;
      --primary-600:#111111;
      --secondary:#0B63F6;
      --accent:#0B63F6;
      --danger:#D32F2F;
      --warning:#F59E0B;
      --success:#16A34A;

      --bg:#ffffff;
      --bg-2:#F3F4F6;
      --card:#ffffff;

      --text:#0f172a;
      --text-2:#475569;
      --muted:#94a3b8;

      --border:#e5e7eb;
      --border-2:#eef2f7;

      --shadow:0 6px 18px rgba(0,0,0,.08);
      --shadow-lg:0 14px 28px rgba(0,0,0,.14);

      --gradient:linear-gradient(135deg, #0A0A0A 0%, #1A1A1A 100%); /* black */
      --gradient-2:linear-gradient(135deg, #0B63F6 0%, #155EF1 100%);

      --safe-top:calc(var(--tg-safe-area-inset-top, 0px) + env(safe-area-inset-top, 0px));
      --safe-bottom:calc(var(--tg-safe-area-inset-bottom, 0px) + env(safe-area-inset-bottom, 0px));

      --header-h:56px;
      --chrome-h:168px; /* Stats + Filters total height (kept fixed) */

      /* viewport fixes */
      --vh: 100dvh;

      /* Bottom sheet */
      --sheet-head-h:56px;
      --footer-h:86px; /* fixed footer with button */
      --sheet-top-gap: calc(12px + var(--safe-top));
    }

    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}

    /* Root lock; only our custom containers scroll */
    body{
      position:fixed; inset:0;
      width:100%; height:var(--vh);
      overflow:hidden;
      font-family:-apple-system,BlinkMacSystemFont,'SF Pro Text','Segoe UI',Inter,Roboto,system-ui,sans-serif;
      background:var(--tg-theme-bg-color, var(--bg));
      color:var(--tg-theme-text-color, var(--text));
      line-height:1.5;
      -webkit-user-select:none; user-select:none;
    }

    .app{
      height:var(--vh);
      display:flex; flex-direction:column;
      background:var(--tg-theme-bg-color, var(--bg));
    }

    /* ===== Fixed TOP BAR (header) ===== */
    .header{
      position:relative;
      height:var(--header-h);
      padding:8px 16px;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      background:rgba(255,255,255,.92);
      backdrop-filter:blur(14px); -webkit-backdrop-filter:blur(14px);
      border-bottom:1px solid var(--border-2);
      margin-top:calc(var(--safe-top) + 6px);
      z-index:5;
    }
    .left,.right{display:flex;align-items:center;gap:10px}
    .profile-btn{
      width:44px;height:44px;border:none;border-radius:50%;
      display:flex;align-items:center;justify-content:center;overflow:hidden;
      background:#0A0A0A; color:#fff; font-size:20px; cursor:pointer;
      box-shadow:var(--shadow);
    }
    .profile-btn img{width:100%;height:100%;object-fit:cover;border-radius:50%}
    .title{
      font-weight:800; font-size:16px; letter-spacing:.2px;
      color:#0f172a; background:#F3F4F6; border:1px solid var(--border);
      padding:8px 12px; border-radius:12px; cursor:pointer;
    }
    .refresh{
      width:44px;height:44px;border:none;border-radius:50%;
      background:#0F172A; color:#fff; cursor:pointer;
      display:flex;align-items:center;justify-content:center;font-size:18px;
    }
    .refresh.loading{animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .lang{display:flex;gap:4px;padding:2px;border-radius:999px;background:#F3F4F6;border:1px solid var(--border)}
    .lang button{border:none;background:transparent;padding:8px 14px;border-radius:999px;font-weight:800;font-size:13px;color:#6b7280;cursor:pointer}
    .lang button.active{background:#000;color:#fff}

    /* ===== FIXED CHROME (Stats + Filters) ===== */
    .chrome{
      position:relative; /* not scrolling */
      z-index:4;
      background:var(--tg-theme-bg-color, var(--bg));
      border-bottom:1px solid var(--border-2);
    }
    .stats{
      display:grid; grid-template-columns:repeat(3,1fr); gap:12px;
      padding:14px 16px;
      background:var(--bg-2);
    }
    .stat{
      background:var(--card); border:1px solid var(--border);
      border-radius:16px; box-shadow:var(--shadow);
      padding:12px; text-align:center;
    }
    .stat .v{font-size:22px;font-weight:900;color:#0f172a}
    .stat .l{font-size:11px;color:#9CA3AF;letter-spacing:.6px;text-transform:uppercase}

    .filters{
      display:flex; gap:10px; padding:12px 16px;
      background:#fff; border-top:1px solid var(--border-2);
      overflow:hidden; /* no horizontal scroll in ‚Äúfixed chrome‚Äù */
    }
    .chip{
      padding:10px 16px;
      background:#F3F4F6; color:#111827; border:1px solid var(--border);
      border-radius:999px; font-weight:800; white-space:nowrap; cursor:pointer;
    }
    .chip.active{background:#000;color:#fff;border-color:#000}

    /* ===== SCROLL AREA (only the list scrolls) ===== */
    .scroll{
      flex:1 1 auto;
      min-height:0;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      overscroll-behavior-y:contain;
      padding:12px 16px calc(20px + var(--safe-bottom));
      background:transparent;
    }

    .list{
      display:grid; grid-template-columns:1fr; gap:12px;
      contain:content;
    }
    @media (min-width:1024px){
      .list{grid-template-columns:repeat(auto-fit,minmax(420px,1fr)); gap:20px}
    }

    .card{
      position:relative; background:#fff; border:1px solid var(--border);
      border-radius:16px; box-shadow:var(--shadow); padding:16px; cursor:pointer;
      transition:transform .15s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .card:hover{transform:translateY(-2px); box-shadow:var(--shadow-lg); border-color:#000}
    .badge-distance{
      position:absolute; top:14px; right:14px;
      background:#16A34A; color:#fff; font-weight:800; font-size:11px;
      padding:6px 10px; border-radius:12px;
    }
    .time{display:flex;gap:8px;align-items:center;color:#9CA3AF;font-weight:700;margin-bottom:10px}

    .route{display:flex;flex-direction:column;gap:12px;margin:10px 0 14px}
    .point{display:flex;gap:12px}
    .marker{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;box-shadow:var(--shadow)}
    .marker.a{background:#000}
    .marker.b{background:#0B63F6}
    .addr-wrap{flex:1;min-width:0}
    .label{font-size:11px;color:#9CA3AF;letter-spacing:.5px;text-transform:uppercase;margin-bottom:3px}
    .addr{font-weight:900;color:#0f172a;line-height:1.25;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}

    .dets{display:grid; grid-template-columns:repeat(3,1fr); gap:8px}
    .d{background:#F3F4F6;border:1px solid var(--border);border-radius:12px;padding:10px;text-align:center}
    .d .v{font-weight:900;color:#0f172a}
    .d .l{font-size:11px;color:#9CA3AF;text-transform:uppercase;letter-spacing:.5px}
    .price{color:#000;font-size:18px}

    .foot{display:flex;gap:8px;align-items:center;margin-top:10px}
    .comment{flex:1;color:#6b7280;font-style:italic;overflow:hidden;-webkit-line-clamp:2;display:-webkit-box;-webkit-box-orient:vertical}
    .truck{white-space:nowrap;background:#F3F4F6;border:1px solid var(--border);color:#111827;font-weight:800;padding:6px 10px;border-radius:10px}

    .empty{padding:14vh 16px;text-align:center;color:#9CA3AF}

    /* Toast */
    .toast{
      position:fixed; left:12px; right:12px; bottom:calc(12px + var(--safe-bottom));
      background:#111827; color:#fff; border:1px solid rgba(255,255,255,.08);
      border-radius:16px; padding:14px 16px; display:none; gap:12px; align-items:center; z-index:50;
      box-shadow:var(--shadow-lg);
    }
    .toast.show{display:flex;animation:fadein .2s ease}
    @keyframes fadein{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

    /* ======= BOTTOM SHEET (modal) ======= */
    .modal{position:fixed; inset:0; display:none; z-index:100; background:rgba(0,0,0,.72); backdrop-filter:blur(10px)}
    .modal.show{display:flex; align-items:flex-end}
    @media (min-width:1024px){.modal.show{align-items:center; justify-content:center}}

    .sheet{
      width:100%;
      margin-top:var(--sheet-top-gap);
      max-height:calc(var(--vh) - var(--sheet-top-gap));
      background:#fff; border-radius:20px 20px 0 0; overflow:hidden;
      display:flex; flex-direction:column; box-shadow:0 20px 60px rgba(0,0,0,.28);
    }
    @media (min-width:1024px){.sheet{width:92vw; max-width:1400px; height:calc(var(--vh) - 14vh); border-radius:24px}}

    .sheet-head{
      height:var(--sheet-head-h);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px; border-bottom:1px solid var(--border-2); background:#fff; z-index:1;
    }
    .sheet-title{font-weight:900;color:#0f172a}
    .close{width:40px;height:40px;border-radius:50%;border:none;background:#F3F4F6;color:#111827;font-size:22px;cursor:pointer}

    /* SCROLL only inside body; extra space for footer so nothing is cut */
    .sheet-body{
      position:relative; overflow:auto; -webkit-overflow-scrolling:touch; overscroll-behavior:contain;
      min-height:0;
      max-height:calc(var(--vh) - var(--sheet-top-gap) - var(--sheet-head-h) - var(--footer-h) - var(--safe-bottom));
      padding-bottom:16px; background:#fff;
    }

    .map-wrap{position:relative;width:100%;height:40vh;min-height:240px;border-bottom:1px solid var(--border-2)}
    #detailMap{width:100%;height:100%}
    .map-overlay{
      position:absolute; top:12px; left:12px;
      background:#111827; color:#fff; border:1px solid rgba(255,255,255,.12);
      padding:10px 12px; border-radius:12px; font-weight:900; box-shadow:var(--shadow-lg);
    }

    .photo{display:none; padding:14px 16px; border-bottom:1px solid var(--border-2); background:#fff}
    .photo img{width:100%; height:auto; max-height:360px; object-fit:cover; border-radius:14px; border:1px solid var(--border); box-shadow:var(--shadow)}
    .photo .cap{margin-top:8px; text-align:center; color:#9CA3AF; font-size:13px}

    .info{padding:16px; display:flex; flex-direction:column; gap:16px}
    .price-box{text-align:center}
    .price-val{font-size:40px;font-weight:900;color:#000}
    .price-l{color:#9CA3AF;letter-spacing:1px;text-transform:uppercase;font-weight:900}

    .route-box{background:#F3F4F6;border:1px solid var(--border);border-radius:16px;padding:14px}
    .step{display:flex;gap:14px;align-items:flex-start}
    .step + .step{margin-top:12px}
    .step .m{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;box-shadow:var(--shadow)}
    .m.a{background:#000}
    .m.b{background:#0B63F6}
    .s-addr{font-size:16px;font-weight:900;color:#0f172a}
    .s-l{font-size:12px;color:#9CA3AF;text-transform:uppercase;letter-spacing:.5px}

    .meta{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .meta .it{background:#F3F4F6;border:1px solid var(--border);border-radius:14px;padding:12px;text-align:center}
    .meta .v{font-weight:900;color:#0f172a}
    .meta .l{font-size:12px;color:#9CA3AF;text-transform:uppercase;letter-spacing:.5px}

    /* Client comment */
    .comment-box{background:#F3F4F6;border:1px solid var(--border);border-radius:14px;padding:14px}
    .comment-label{font-size:12px;color:#9CA3AF;text-transform:uppercase;letter-spacing:.6px;margin-bottom:6px}
    .comment-val{font-weight:700;color:#111827}

    /* Centered contact section */
    .contact{
      background:#fff; border-radius:16px; padding:8px 0 0; text-align:center;
    }
    .ct{font-size:18px; font-weight:900; margin-bottom:6px}
    .cp{opacity:.95; font-weight:900; margin-bottom:12px}
    .cb{display:grid; grid-template-columns:1fr 1fr; gap:12px; padding:0 16px 2px}
    .cbtn{
      border:none; text-decoration:none; display:flex; align-items:center; justify-content:center; gap:10px;
      padding:14px 16px; border-radius:14px; font-weight:900;
      border:1px solid var(--border);
      background:#fff; color:#0f172a;
    }
    .cbtn.call{background:var(--gradient); color:#fff; border:none}
    .cbtn.wa{background:#F5F5F5; color:#0f172a}
    .contact small{display:block; color:#9CA3AF; margin-top:10px}

    /* Fixed footer button */
    .sheet-footer{
      height:var(--footer-h);
      display:flex; align-items:center; justify-content:center;
      padding:10px 16px calc(12px + var(--safe-bottom));
      background:#fff; border-top:1px solid var(--border-2); box-shadow:0 -12px 24px rgba(0,0,0,.04);
    }
    .accept{
      width:100%; min-height:56px;
      background:var(--gradient); color:#fff; border:none; border-radius:16px;
      font-weight:900; font-size:18px; cursor:pointer; box-shadow:var(--shadow-lg);
    }

    /* Leaflet cosmetics */
    .leaflet-control-attribution,.leaflet-control-zoom,.leaflet-control{display:none!important}
    .leaflet-container{background:#fff!important; font-family:inherit!important}
  </style>
</head>
<body>
  <div class="app">
    <!-- Fixed Header -->
    <header class="header">
      <div class="left">
        <button id="profileBtn" class="profile-btn" onclick="openProfile()" aria-label="–ü—Ä–æ—Ñ–∏–ª—å">üë§</button>
        <div class="title" onclick="openProfile()" data-ru="–ü—Ä–æ—Ñ–∏–ª—å" data-kz="–ü—Ä–æ—Ñ–∏–ª—å">–ü—Ä–æ—Ñ–∏–ª—å</div>
      </div>
      <div class="right">
        <button id="refreshBtn" class="refresh" onclick="refreshOrders()" aria-label="–û–±–Ω–æ–≤–∏—Ç—å –∑–∞–∫–∞–∑—ã">üîÑ</button>
        <div class="lang">
          <button id="lang-ru" class="active" onclick="setLang('ru')">RU</button>
          <button id="lang-kz" onclick="setLang('kz')">KZ</button>
        </div>
      </div>
    </header>

    <!-- Fixed Chrome: Stats + Filters (does NOT scroll) -->
    <section class="chrome" aria-hidden="false">
      <div class="stats">
        <div class="stat">
          <div id="totalOrders" class="v">0</div>
          <div class="l" data-ru="–í—Å–µ–≥–æ" data-kz="–ë–∞—Ä–ª—ã“õ">–í—Å–µ–≥–æ</div>
        </div>
        <div class="stat">
          <div id="nearbyOrders" class="v">0</div>
          <div class="l" data-ru="–†—è–¥–æ–º" data-kz="–ñ–∞“õ—ã–Ω">–†—è–¥–æ–º</div>
        </div>
        <div class="stat">
          <div id="avgPrice" class="v">0‚Ç∏</div>
          <div class="l" data-ru="–°—Ä–µ–¥–Ω—è—è" data-kz="–û—Ä—Ç–∞—à–∞">–°—Ä–µ–¥–Ω—è—è</div>
        </div>
      </div>
      <nav class="filters">
        <div class="chip active" data-filter="all" onclick="setFilter('all')"><span data-ru="–í—Å–µ" data-kz="–ë–∞—Ä–ª—ã“õ">–í—Å–µ</span></div>
        <div class="chip" data-filter="new" onclick="setFilter('new')"><span data-ru="–ù–æ–≤—ã–µ" data-kz="–ñ–∞“£–∞">–ù–æ–≤—ã–µ</span></div>
        <div class="chip" data-filter="nearby" onclick="setFilter('nearby')"><span data-ru="–†—è–¥–æ–º" data-kz="–ñ–∞“õ—ã–Ω">–†—è–¥–æ–º</span></div>
        <div class="chip" data-filter="expensive" onclick="setFilter('expensive')"><span data-ru="–î–æ—Ä–æ–≥–∏–µ" data-kz="“ö—ã–º–±–∞—Ç">–î–æ—Ä–æ–≥–∏–µ</span></div>
      </nav>
    </section>

    <!-- Scroll area: ONLY the list scrolls -->
    <div class="scroll" id="scrollArea" style="padding-top:8px;">
      <!-- New order toast (floating) -->
      <div id="newOrderToast" class="toast" role="status" aria-live="polite">
        <div style="font-size:20px">üöö</div>
        <div>
          <div style="font-weight:900" data-ru="–ù–æ–≤—ã–π –∑–∞–∫–∞–∑!" data-kz="–ñ–∞“£–∞ —Ç–∞–ø—Å—ã—Ä—ã—Å!">–ù–æ–≤—ã–π –∑–∞–∫–∞–∑!</div>
          <div id="toastSubtitle" style="opacity:.9" data-ru="–£ –≤–∞—Å –µ—Å—Ç—å –Ω–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã" data-kz="–°—ñ–∑–¥–µ –∂–∞“£–∞ —Ç–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä –±–∞—Ä">–£ –≤–∞—Å –µ—Å—Ç—å –Ω–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã</div>
        </div>
      </div>

      <!-- List -->
      <main id="orderList" class="list">
        <div class="empty">
          <div style="font-size:54px; opacity:.28">üì¶</div>
          <div style="font-weight:900; margin-top:8px">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</div>
        </div>
      </main>
    </div>
  </div>

  <!-- Detail Modal -->
  <div id="detailModal" class="modal" role="dialog" aria-modal="true">
    <div class="sheet" role="document">
      <div class="sheet-head">
        <div class="sheet-title" id="detailTitle" data-ru="–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞" data-kz="–¢–∞–ø—Å—ã—Ä—ã—Å –º”ô–ª—ñ–º–µ—Ç—Ç–µ—Ä—ñ">–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞</div>
        <button class="close" onclick="closeDetail()" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
      </div>

      <div id="sheetBody" class="sheet-body">
        <!-- Map -->
        <section class="map-wrap">
          <div id="detailMap"></div>
          <div id="mapOverlay" class="map-overlay"><span id="routeEta">–ó–∞–≥—Ä—É–∑–∫–∞...</span></div>
        </section>

        <!-- Photo -->
        <section id="detailPhotoSection" class="photo" aria-live="polite">
          <img id="cargoPhoto" alt="–§–æ—Ç–æ –≥—Ä—É–∑–∞" loading="lazy" />
          <div class="cap" data-ru="–§–æ—Ç–æ –≥—Ä—É–∑–∞" data-kz="–ñ“Ø–∫ —Å—É—Ä–µ—Ç—ñ">–§–æ—Ç–æ –≥—Ä—É–∑–∞</div>
        </section>

        <!-- Info -->
        <section id="detailInfo" class="info">
          <div class="price-box">
            <div id="detailPrice" class="price-val">0‚Ç∏</div>
            <div class="price-l" data-ru="–ó–∞ –¥–æ—Å—Ç–∞–≤–∫—É" data-kz="–ñ–µ—Ç–∫—ñ–∑—É “Ø—à—ñ–Ω">–ó–∞ –¥–æ—Å—Ç–∞–≤–∫—É</div>
          </div>

          <div class="route-box">
            <div class="step">
              <div class="m a">A</div>
              <div>
                <div id="pickupAddress" class="s-addr">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <div class="s-l" data-ru="–ó–∞–±—Ä–∞—Ç—å" data-kz="–ê–ª—ã–ø –∫–µ—Ç—É">–ó–∞–±—Ä–∞—Ç—å</div>
              </div>
            </div>
            <div class="step">
              <div class="m b">B</div>
              <div>
                <div id="dropoffAddress" class="s-addr">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <div class="s-l" data-ru="–î–æ—Å—Ç–∞–≤–∏—Ç—å" data-kz="–ñ–µ—Ç–∫—ñ–∑—É">–î–æ—Å—Ç–∞–≤–∏—Ç—å</div>
              </div>
            </div>
          </div>

          <div class="meta">
            <div class="it">
              <div id="detailTruck" class="v">--</div>
              <div class="l" data-ru="–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç" data-kz="–ö”©–ª—ñ–∫">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</div>
            </div>
            <div class="it">
              <div id="detailTime" class="v">--</div>
              <div class="l" data-ru="–í—Ä–µ–º—è" data-kz="–£–∞“õ—ã—Ç">–í—Ä–µ–º—è</div>
            </div>
          </div>

          <!-- Client comment -->
          <div class="comment-box" id="commentBox" style="display:none">
            <div class="comment-label" data-ru="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫–ª–∏–µ–Ω—Ç–∞" data-kz="–ö–ª–∏–µ–Ω—Ç—Ç—ñ“£ –ø—ñ–∫—ñ—Ä—ñ">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫–ª–∏–µ–Ω—Ç–∞</div>
            <div class="comment-val" id="clientComment"></div>
          </div>

          <!-- Centered contact -->
          <div class="contact">
            <div class="ct" data-ru="–ö–æ–Ω—Ç–∞–∫—Ç –∫–ª–∏–µ–Ω—Ç–∞" data-kz="–ö–ª–∏–µ–Ω—Ç –±–∞–π–ª–∞–Ω—ã—Å—ã">–ö–æ–Ω—Ç–∞–∫—Ç –∫–ª–∏–µ–Ω—Ç–∞</div>
            <div id="contactPhone" class="cp">+7 (___) ___-__-__</div>
            <div class="cb">
              <a id="callBtn" class="cbtn call" href="#"><span>üìû</span><span data-ru="–ó–≤–æ–Ω–æ–∫" data-kz="“ö–æ“£—ã—Ä–∞—É">–ó–≤–æ–Ω–æ–∫</span></a>
              <a id="whatsappBtn" class="cbtn wa" href="#"><span>üí¨</span><span>WhatsApp</span></a>
            </div>
            <small data-ru="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–≤—è–∑–∞—Ç—å—Å—è" data-kz="–•–∞–±–∞—Ä–ª–∞—Å—É “Ø—à—ñ–Ω –±–∞—Å—ã“£—ã–∑">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–≤—è–∑–∞—Ç—å—Å—è</small>
          </div>
        </section>
      </div>

      <!-- Fixed footer -->
      <div class="sheet-footer">
        <button id="acceptOrderBtn" class="accept" onclick="acceptOrder()">
          <span data-ru="–ü—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑" data-kz="–¢–∞–ø—Å—ã—Ä—ã—Å—Ç—ã “õ–∞–±—ã–ª–¥–∞—É">–ü—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    /* ====== STATE ====== */
    let currentLang='ru';
    let currentFilter='all';
    let orders=[];
    let driverLocation=null;
    let refreshInterval=null;
    let detailMap=null;
    let currentOrder=null;
    let lastOrderIds=new Set();
    let previousOrderCount=0;

    /* ====== VIEWPORT FIX ====== */
    function applyViewportVars(){
      try{
        const h = (window.Telegram?.WebApp?.viewportStableHeight) || window.innerHeight;
        document.documentElement.style.setProperty('--vh', h + 'px');
      }catch(_){}
    }
    function bindViewportListener(){
      try{ Telegram.WebApp.onEvent('viewportChanged', applyViewportVars); }catch(_){}
    }

    /* ====== TELEGRAM INIT ====== */
    function initTelegram(){
      try{
        if(window.Telegram && Telegram.WebApp){
          Telegram.WebApp.ready();
          Telegram.WebApp.expand();
          Telegram.WebApp.disableVerticalSwipes?.();
          Telegram.WebApp.setHeaderColor?.('secondary_bg_color');
          Telegram.WebApp.setBackgroundColor?.('#ffffff');

          if(Telegram.WebApp?.colorScheme==='dark'){
            document.documentElement.style.setProperty('--tg-theme-bg-color','#0b0b0b');
            document.documentElement.style.setProperty('--tg-theme-text-color','#f9fafb');
          }
          const user=Telegram.WebApp?.initDataUnsafe?.user;
          if(user){ window.telegramUserId=user.id; }
          Telegram.WebApp.MainButton?.hide?.();
        } else {
          window.telegramUserId=12345; // dev fallback
        }
      }catch(e){}
    }

    /* ====== TOAST ====== */
    function showToast(count=1){
      const t=document.getElementById('newOrderToast');
      const sub=document.getElementById('toastSubtitle');
      sub.textContent = (currentLang==='ru')
        ? `–£ –≤–∞—Å ${count===1 ? '–Ω–æ–≤—ã–π –∑–∞–∫–∞–∑' : count+' –Ω–æ–≤—ã—Ö –∑–∞–∫–∞–∑–∞'}`
        : `–°—ñ–∑–¥–µ ${count===1 ? '–∂–∞“£–∞ —Ç–∞–ø—Å—ã—Ä—ã—Å' : count+' –∂–∞“£–∞ —Ç–∞–ø—Å—ã—Ä—ã—Å'} –±–∞—Ä`;
      t.classList.add('show');
      setTimeout(()=> t.classList.remove('show'), 3200);
    }

    /* ====== PROFILE AVATAR ====== */
    async function loadDriverProfile(){
      try{
        const telegramId=window.telegramUserId; if(!telegramId) return;
        const resp=await fetch('/api/check/who',{method:'POST',headers:{'Content-Type':'application/json'}, body:JSON.stringify({telegram_id:parseInt(telegramId)})});
        const result=await resp.json();
        const btn=document.getElementById('profileBtn');

        if(result.success && result.data?.exists && result.data.user_type==='driver'){
          const d=result.data.driver_data;
          if(d?.profile_photo?.trim()){
            const avatarPath=`./ava/${d.profile_photo}`;
            const img=new Image();
            img.onload=()=>{ btn.innerHTML=`<img src="${avatarPath}" alt="Avatar" />`; };
            img.onerror=()=>{
              const tries=[`/ava/${d.profile_photo}`,`/files/${d.profile_photo}`,`/static/ava/${d.profile_photo}`];
              (function tryNext(i){
                if(i>=tries.length){ btn.textContent='üë§'; return; }
                const t=new Image();
                t.onload=()=> btn.innerHTML=`<img src="${tries[i]}" alt="Avatar" />`;
                t.onerror=()=> tryNext(i+1);
                t.src=tries[i];
              })(0);
            };
            img.src=avatarPath;
          }else btn.textContent='üë§';
        }else btn.textContent='üë§';
      }catch(_){ document.getElementById('profileBtn').textContent='üë§'; }
    }
    function openProfile(){
      const telegramId=window.telegramUserId;
      if(!telegramId){ alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'); return; }
      window.location.href=`/driver-update?telegram_id=${telegramId}`;
    }

    /* ====== GEO ====== */
    function getDriverLocation(){
      return new Promise((resolve)=>{
        if(!navigator.geolocation){
          driverLocation={lat:43.238949, lon:76.889709}; return resolve(driverLocation);
        }
        navigator.geolocation.getCurrentPosition(
          pos=>{ driverLocation={lat:pos.coords.latitude, lon:pos.coords.longitude}; resolve(driverLocation); },
          _=>{ driverLocation={lat:43.238949, lon:76.889709}; resolve(driverLocation); },
          {enableHighAccuracy:true,timeout:10000,maximumAge:60000}
        );
      });
    }

    function haversine(lat1,lon1,lat2,lon2){
      const R=6371, dLat=(lat2-lat1)*Math.PI/180, dLon=(lon2-lon1)*Math.PI/180;
      const a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
      return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }

    /* ====== LIST ====== */
    function checkNewOrders(list){
      if(!list?.length) return;
      const ids=new Set(list.map(o=>o.id));
      const hasNew=list.some(o=>!lastOrderIds.has(o.id));
      lastOrderIds=ids;
      if(hasNew && previousOrderCount>0){
        const count=list.length-previousOrderCount;
        showToast(count>0?count:1);
      }
      previousOrderCount=list.length;
    }

    async function loadOrders(){
      try{
        if(!driverLocation) await getDriverLocation();
        const payload={
          telegram_id:window.telegramUserId||0,
          driver_lat:driverLocation?.lat||43.238949,
          driver_lon:driverLocation?.lon||76.889709,
          radius:50
        };
        const r=await fetch('/api/delivery-list',{method:'POST',headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
        if(!r.ok) throw new Error('HTTP '+r.status);
        const json=await r.json();
        if(!(json.success && json.data)) throw new Error(json.message||'bad response');

        const list=json.data.orders||[];
        checkNewOrders(list);

        orders=list.map(o=>{
          const distance=haversine((driverLocation?.lat||0),(driverLocation?.lon||0), o.from_lat, o.from_lon);
          const diffMin=(Date.now()-new Date(o.created_at).getTime())/(1000*60);
          return {...o, distance, isNew: diffMin<10};
        }).sort((a,b)=> new Date(b.created_at)-new Date(a.created_at));

        updateStats(); renderList();
      }catch(e){
        renderEmpty();
      }
    }

    function updateStats(){
      const nearby=orders.filter(o=> (o.distance||999)<=5).length;
      const avg=orders.length ? Math.round(orders.reduce((s,o)=>s+(o.price||0),0)/orders.length) : 0;
      document.getElementById('totalOrders').textContent=orders.length;
      document.getElementById('nearbyOrders').textContent=nearby;
      document.getElementById('avgPrice').textContent=avg+'‚Ç∏';
    }

    function setFilter(f){
      currentFilter=f;
      document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
      document.querySelector(`.chip[data-filter="${f}"]`)?.classList.add('active');
      renderList();
    }

    function formatTime(dt){
      const now=new Date();
      const diff=Math.abs(dt-now)/(1000*60);
      if(diff<60) return currentLang==='ru'?'–°–µ–π—á–∞—Å':'“ö–∞–∑—ñ—Ä';
      return dt.toLocaleTimeString(currentLang==='ru'?'ru-RU':'kk-KZ',{hour:'2-digit',minute:'2-digit'});
    }

    function t(key){
      const map={
        ru:{from:'–û—Ç–∫—É–¥–∞',to:'–ö—É–¥–∞',price:'–¶–µ–Ω–∞',distance:'–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ',time:'–í—Ä–µ–º—è',new:'–ù–û–í–´–ô'},
        kz:{from:'“ö–∞–π–¥–∞–Ω',to:'“ö–∞–π–¥–∞',price:'–ë–∞“ì–∞—Å—ã',distance:'“ö–∞—à—ã“õ—Ç—ã“õ',time:'–£–∞“õ—ã—Ç',new:'–ñ–ê“¢–ê'}
      };
      return map[currentLang][key]||key;
    }

    function truckLabel(v){
      const map={
        ru:{small:'–ú–∞–ª—ã–π',medium:'–°—Ä–µ–¥–Ω–∏–π',large:'–ë–æ–ª—å—à–æ–π',refrigerator:'–†–µ—Ñ—Ä–∏–∂–µ—Ä–∞—Ç–æ—Ä',tow:'–≠–≤–∞–∫—É–∞—Ç–æ—Ä',any:'–õ—é–±–æ–π'},
        kz:{small:'–ö—ñ—à—ñ',medium:'–û—Ä—Ç–∞',large:'“Æ–ª–∫–µ–Ω',refrigerator:'–†–µ—Ñ—Ä–∏–∂–µ—Ä–∞—Ç–æ—Ä',tow:'–≠–≤–∞–∫—É–∞—Ç–æ—Ä',any:'–ö–µ–∑ –∫–µ–ª–≥–µ–Ω'}
      };
      return map[currentLang][v] || v || map[currentLang].any;
    }

    function renderEmpty(){
      document.getElementById('orderList').innerHTML=`
        <div class="empty">
          <div style="font-size:54px; opacity:.28">üì¶</div>
          <div style="font-weight:900; margin-top:8px">${currentLang==='ru'?'–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤':'“ö–æ–ª –∂–µ—Ç—ñ–º–¥—ñ —Ç–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä –∂–æ“õ'}</div>
          <div style="color:#9CA3AF">${currentLang==='ru'?'–ó–∞–∫–∞–∑—ã –ø–æ—è–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏':'–¢–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä –∞–≤—Ç–æ–º–∞—Ç—Ç—ã —Ç“Ø—Ä–¥–µ –ø–∞–π–¥–∞ –±–æ–ª–∞–¥—ã'}</div>
        </div>`;
    }

    function renderList(){
      const c=document.getElementById('orderList');
      let list=[...orders];
      if(currentFilter==='new') list=list.filter(o=>o.isNew);
      if(currentFilter==='nearby') list=list.filter(o=>(o.distance||999)<=5);
      if(currentFilter==='expensive') list=list.filter(o=>(o.price||0)>=5000);

      if(!list.length) { renderEmpty(); return; }

      const frag=document.createDocumentFragment();
      list.forEach(o=>{
        const card=document.createElement('div');
        card.className='card';
        card.setAttribute('tabindex','0');
        card.onclick=()=> showOrderDetail(o.id);
        card.addEventListener('keydown',e=>{ if(e.key==='Enter'||e.key===' '){e.preventDefault(); showOrderDetail(o.id);} });

        const time=formatTime(new Date(o.created_at));
        const distText=o.distance ? `${o.distance.toFixed(1)} –∫–º` : '';
        const truck=truckLabel(o.truck_type);

        card.innerHTML=`
          ${o.distance ? `<div class="badge-distance">${distText}</div>`:''}
          <div class="time"><span>‚è∞</span><span>${time}</span></div>

          <div class="route">
            <div class="point">
              <div class="marker a">A</div>
              <div class="addr-wrap">
                <div class="label">${t('from')}</div>
                <div class="addr">${o.from_address}</div>
              </div>
            </div>
            <div class="point">
              <div class="marker b">B</div>
              <div class="addr-wrap">
                <div class="label">${t('to')}</div>
                <div class="addr">${o.to_address}</div>
              </div>
            </div>
          </div>

          <div class="dets">
            <div class="d">
              <div class="v price">${o.price}‚Ç∏</div>
              <div class="l">${t('price')}</div>
            </div>
            <div class="d">
              <div class="v">${distText || '--'}</div>
              <div class="l">${t('distance')}</div>
            </div>
            <div class="d">
              <div class="v">${formatTime(new Date(o.time_start || o.created_at))}</div>
              <div class="l">${t('time')}</div>
            </div>
          </div>

          ${(o.comment || o.truck_type) ? `
          <div class="foot">
            <div class="comment">${o.comment||''}</div>
            <div class="truck">${truck}</div>
          </div>`:''}
        `;
        frag.appendChild(card);
      });
      c.innerHTML='';
      c.appendChild(frag);
    }

    /* ====== DETAIL ====== */
    function normalizePhotoFilename(raw){
      if(!raw) return '';
      const clean=String(raw).trim();
      if(/^https?:\/\//i.test(clean)) return clean;
      return clean.split('?')[0].split('#')[0].split('/').pop().split('\\').pop();
    }
    function setCargoPhoto(rawValue){
      const section=document.getElementById('detailPhotoSection');
      const img=document.getElementById('cargoPhoto');
      const hide=()=>{ section.style.display='none'; img.removeAttribute('src'); };
      if(!rawValue){ hide(); return; }
      const raw=String(rawValue).trim();
      const isAbs=/^https?:\/\//i.test(raw);
      let candidates=[];
      if(isAbs){ candidates=[raw]; }
      else{
        const name=normalizePhotoFilename(raw);
        candidates=[
          `./delivery-photo/${name}`, `/delivery-photo/${name}`,
          `./cargo/${name}`, `/cargo/${name}`,
          `./uploads/cargo/${name}`, `/uploads/cargo/${name}`,
          `/files/${name}`, `/static/cargo/${name}`
        ];
      }
      let done=false;
      section.style.display='none'; img.removeAttribute('src');
      (function tryNext(i){
        if(done || i>=candidates.length){ hide(); return; }
        const probe=new Image();
        probe.onload=()=>{ if(!done){ done=true; img.src=candidates[i]; section.style.display='block'; } };
        probe.onerror=()=> tryNext(i+1);
        probe.src=candidates[i];
      })(0);
    }

    function showOrderDetail(orderId){
      const order=orders.find(o=>o.id===orderId); if(!order) return;
      currentOrder=order;

      document.getElementById('detailPrice').textContent=`${order.price}‚Ç∏`;
      document.getElementById('pickupAddress').textContent=order.from_address;
      document.getElementById('dropoffAddress').textContent=order.to_address;
      document.getElementById('detailTruck').textContent=truckLabel(order.truck_type);
      document.getElementById('detailTime').textContent=formatTime(new Date(order.time_start || order.created_at));

      const cmEl=document.getElementById('commentBox');
      const cmVal=document.getElementById('clientComment');
      const comment=(order.comment||'').toString().trim();
      if(comment){ cmVal.textContent=comment; cmEl.style.display='block'; } else { cmEl.style.display='none'; cmVal.textContent=''; }

      const phone = (order.contact || '').toString();
      document.getElementById('contactPhone').textContent = phone || '';
      document.getElementById('callBtn').href=`tel:${phone}`;
      document.getElementById('whatsappBtn').href=`https://wa.me/${phone.replace(/\D/g,'')}`;

      const rawPhoto=(order.cargo_photo ?? order.item_photo_path ?? order.photo ?? order.item_photo ?? '').toString().trim();
      setCargoPhoto(rawPhoto);

      document.getElementById('detailModal').classList.add('show');
      setTimeout(()=> initDetailMap(order), 200);
    }

    function closeDetail(){
      document.getElementById('detailModal').classList.remove('show');
      currentOrder=null;
      const sec=document.getElementById('detailPhotoSection');
      const img=document.getElementById('cargoPhoto');
      sec.style.display='none'; img.removeAttribute('src');
      if(detailMap){ detailMap.remove(); detailMap=null; }
    }

    async function initDetailMap(order){
      if(detailMap){ detailMap.remove(); }
      try{
        const centerLat=(order.from_lat+order.to_lat)/2;
        const centerLon=(order.from_lon+order.to_lon)/2;
        detailMap=L.map('detailMap',{
          zoomControl:false, attributionControl:false,
          scrollWheelZoom:true, touchZoom:true, doubleClickZoom:false, keyboard:false
        }).setView([centerLat, centerLon], 13);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{maxZoom:19, attribution:'', subdomains:'abcd'}).addTo(detailMap);

        const iconA=L.divIcon({html:'<div style="width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;background:#000;border:4px solid #fff;box-shadow:0 6px 20px rgba(0,0,0,.25)">A</div>', className:'', iconSize:[42,42], iconAnchor:[21,42]});
        const iconB=L.divIcon({html:'<div style="width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;background:#0B63F6;border:4px solid #fff;box-shadow:0 6px 20px rgba(0,0,0,.25)">B</div>', className:'', iconSize:[42,42], iconAnchor:[21,42]});

        L.marker([order.from_lat, order.from_lon], {icon:iconA}).addTo(detailMap);
        L.marker([order.to_lat, order.to_lon], {icon:iconB}).addTo(detailMap);

        await drawRoute(order);

        const bounds=L.latLngBounds([[order.from_lat,order.from_lon],[order.to_lat,order.to_lon]]);
        detailMap.fitBounds(bounds,{padding:[36,36], maxZoom:16});
      }catch(e){ console.error('Map init error', e); }
    }

    async function drawRoute(order){
      const etaEl=document.getElementById('routeEta');
      try{
        etaEl.textContent=currentLang==='ru'?'–†–∞—Å—á–µ—Ç...':'–ï—Å–µ–ø—Ç–µ—É...';
        const url=`https://router.project-osrm.org/route/v1/driving/${order.from_lon},${order.from_lat};${order.to_lon},${order.to_lat}?overview=full&geometries=geojson&steps=true`;
        const r=await fetch(url);
        if(!r.ok) throw new Error('OSRM');
        const data=await r.json();
        if(!(data.routes?.length)) throw new Error('No route');

        const route=data.routes[0];
        const coords=route.geometry.coordinates.map(c=>[c[1],c[0]]);
        L.polyline(coords,{color:'#000',weight:5,opacity:.9}).addTo(detailMap);
        const shadow=L.polyline(coords,{color:'#00000030',weight:7,opacity:.3}).addTo(detailMap);
        shadow.bringToBack();

        const km=(route.distance/1000).toFixed(1);
        const min=Math.round(route.duration/60);
        etaEl.textContent=`${km} –∫–º ‚Ä¢ ${min} –º–∏–Ω`;
      }catch(e){
        const dist=haversine(order.from_lat,order.from_lon,order.to_lat,order.to_lon);
        const t=Math.round((dist/40)*60);
        L.polyline([[order.from_lat,order.from_lon],[order.to_lat,order.to_lon]],{color:'#000',weight:4,opacity:.75,dashArray:'10,5'}).addTo(detailMap);
        etaEl.textContent=`${dist.toFixed(1)} –∫–º ‚Ä¢ ${t} –º–∏–Ω`;
      }
    }

    async function acceptOrder(){
      if(!currentOrder) return;
      const btn=document.getElementById('acceptOrderBtn');
      try{
        btn.disabled=true; btn.innerHTML='<span>‚è≥ –ü—Ä–∏–Ω–∏–º–∞–µ–º...</span>';
        const r=await fetch('/api/driver/accept-order',{method:'POST',headers:{'Content-Type':'application/json'}, body:JSON.stringify({telegram_id:window.telegramUserId, order_id:currentOrder.id})});
        const j=await r.json();
        if(j.success){
          btn.innerHTML='<span>‚úÖ –ì–æ—Ç–æ–≤–æ!</span>';
          btn.style.background='#16A34A';
          setTimeout(()=>{ closeDetail(); loadOrders(); }, 1100);
        }else{
          throw new Error(j.message||'fail');
        }
      }catch(e){
        btn.disabled=false; btn.innerHTML='<span>‚ùå –û—à–∏–±–∫–∞! –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ</span>';
        btn.style.background='#D32F2F';
        setTimeout(()=>{ btn.innerHTML = (currentLang==='ru')?'<span>–ü—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑</span>':'<span>–¢–∞–ø—Å—ã—Ä—ã—Å—Ç—ã “õ–∞–±—ã–ª–¥–∞—É</span>'; btn.style.background=''; }, 1500);
      }
    }

    /* ====== LANG ====== */
    function setLang(lang){
      currentLang=lang;
      document.querySelectorAll('.lang button').forEach(b=>b.classList.remove('active'));
      document.getElementById('lang-'+lang).classList.add('active');
      document.querySelectorAll('[data-ru]').forEach(el=>{ const txt=el.getAttribute('data-'+lang); if(txt) el.textContent=txt; });
      updateStats(); renderList();
    }

    /* ====== REFRESH ====== */
    function refreshOrders(){
      const b=document.getElementById('refreshBtn');
      b.classList.add('loading');
      loadOrders().finally(()=> b.classList.remove('loading'));
    }
    function startAutoRefresh(){ refreshInterval=setInterval(loadOrders, 8000); }
    function stopAutoRefresh(){ if(refreshInterval){ clearInterval(refreshInterval); refreshInterval=null; } }

    /* ====== LIFECYCLE ====== */
    document.addEventListener('DOMContentLoaded', async ()=>{
      initTelegram();
      applyViewportVars(); bindViewportListener();
      setLang('ru');
      await loadDriverProfile();
      await getDriverLocation();
      await loadOrders();
      startAutoRefresh();
    });

    document.addEventListener('visibilitychange', ()=>{
      if(document.hidden) stopAutoRefresh(); else { loadOrders(); startAutoRefresh(); }
    });

    window.addEventListener('resize', applyViewportVars);
    window.addEventListener('beforeunload', ()=>{ stopAutoRefresh(); if(detailMap) detailMap.remove(); });

    // Modal close on backdrop / Esc
    document.getElementById('detailModal').addEventListener('click', (e)=>{ if(e.target===e.currentTarget) closeDetail(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && document.getElementById('detailModal').classList.contains('show')) closeDetail(); });

    // Expose
    window.openProfile=openProfile;
    window.refreshOrders=refreshOrders;
    window.setFilter=setFilter;
    window.setLang=setLang;
    window.showOrderDetail=showOrderDetail;
    window.closeDetail=closeDetail;
    window.acceptOrder=acceptOrder;
  </script>
</body>
</html>
