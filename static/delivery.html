<!DOCTYPE html>
<html lang="kz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#000000" />
  <title>Delivery</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script defer src="https://api-maps.yandex.ru/v3/?apikey=8a3e4da0-9ef2-4176-9203-e7014c1dba6f&lang=ru_RU"></script>

  <style>
    :root {
      --safe-area-inset-top: env(safe-area-inset-top, 0px);
      --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
      --safe-area-inset-left: env(safe-area-inset-left, 0px);
      --safe-area-inset-right: env(safe-area-inset-right, 0px);
      --tg-viewport-stable-height: 100vh;
      --tg-safe-area-inset-top: 0px;
      --tg-content-safe-area-inset-top: 0px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      height: 100%;
      width: 100%;
      overflow: hidden;
      position: fixed;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'SF Pro Text', sans-serif;
      background: #000;
    }

    body {
      display: flex;
      flex-direction: column;
      height: var(--tg-viewport-stable-height, 100vh);
      padding-top: calc(var(--tg-safe-area-inset-top, 0px) + var(--tg-content-safe-area-inset-top, 0px) + 15px);
    }

    /* Full screen maps - allow touch gestures */
    #map, #pickerMap {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
      touch-action: none;
    }

    /* Top Controls - Floating style */
    .top-bar {
      position: fixed;
      top: calc(var(--safe-area-inset-top) + var(--tg-safe-area-inset-top, 0px) + var(--tg-content-safe-area-inset-top, 0px) + 12px);
      left: 12px;
      right: 12px;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      pointer-events: none;
    }

    .gps-status, .lang-switch {
      pointer-events: auto;
    }

    .gps-status {
      background: white;
      padding: 10px 14px;
      border-radius: 100px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .gps-dot {
      width: 6px;
      height: 6px;
      background: #10b981;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    .gps-dot.error {
      background: #ef4444;
    }
    .gps-dot.searching {
      background: #f59e0b;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }

    .lang-switch {
      background: white;
      border-radius: 100px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      display: flex;
      padding: 3px;
    }

    .lang-btn {
      padding: 7px 14px;
      border: none;
      background: none;
      border-radius: 100px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #6b7280;
    }
    .lang-btn.active {
      background: #000;
      color: white;
    }

    /* Bottom sheet - Modern frameless design */
    .bottom-sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-radius: 20px 20px 0 0;
      box-shadow: 0 -2px 20px rgba(0, 0, 0, 0.06);
      z-index: 101;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      padding-bottom: calc(var(--safe-area-inset-bottom) + 10px);
    }

    .sheet-handle {
      width: 48px;
      height: 5px;
      background: #e5e7eb;
      border-radius: 100px;
      margin: 10px auto 8px;
      flex-shrink: 0;
    }

    .sheet-content {
      flex: 1;
      padding: 0 20px 20px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .step-indicator {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin-bottom: 20px;
      flex-shrink: 0;
    }

    .step-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #e5e7eb;
      transition: all 0.3s ease;
    }
    .step-dot.active {
      background: #000;
      width: 20px;
      border-radius: 3px;
    }

    /* Address Cards - Clean modern style */
    .address-section {
      flex-shrink: 0;
      margin-bottom: 20px;
    }

    .address-card {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: #f5f5f7;
      border-radius: 16px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px solid transparent;
      position: relative;
      min-height: 64px;
    }
    .address-card:active { 
      transform: scale(0.98); 
      background: #ebebed;
    }
    .address-card.filled {
      background: #e8f5e9;
      border-color: #10b981;
    }

    .marker {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #000;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      flex-shrink: 0;
    }
    .marker.dropoff {
      background: #ef4444;
    }

    .address-text {
      flex: 1;
      min-width: 0;
    }

    .address-label {
      font-size: 12px;
      color: #8e8e93;
      margin-bottom: 2px;
      font-weight: 500;
    }

    .address-value {
      font-size: 15px;
      font-weight: 600;
      line-height: 1.2;
      color: #000;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Distance info */
    .distance-info {
      padding: 14px;
      background: #10b981;
      color: white;
      border-radius: 14px;
      margin: 12px 0;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      display: none;
    }
    .distance-info.active {
      display: block;
      animation: slideUp 0.4s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Form Steps */
    .form-step {
      display: none;
      flex: 1;
      flex-direction: column;
      min-height: 0;
    }
    .form-step.active { 
      display: flex; 
    }

    .form-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 20px;
      color: #000;
      flex-shrink: 0;
    }

    .form-content {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      min-height: 0;
    }

    .form-grid {
      display: grid;
      gap: 12px;
      margin-bottom: 20px;
    }
    .form-grid.two-col { 
      grid-template-columns: 1fr 1fr; 
    }

    .form-field {
      background: #f5f5f7;
      border-radius: 14px;
      padding: 14px;
      border: 2px solid transparent;
      transition: all 0.2s ease;
    }
    .form-field:focus-within {
      border-color: #000;
      background: white;
    }

    .field-label {
      font-size: 11px;
      color: #8e8e93;
      margin-bottom: 6px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .field-input {
      width: 100%;
      border: none;
      background: none;
      font-size: 15px;
      font-weight: 500;
      outline: none;
      color: #000;
    }
    .field-input::placeholder { 
      color: #c7c7cc; 
    }

    textarea.field-input {
      min-height: 60px;
      resize: none;
      font-family: inherit;
      line-height: 1.4;
    }

    /* Truck Options - Grid style */
    .truck-section {
      margin-bottom: 20px;
    }

    .truck-label {
      font-size: 11px;
      color: #8e8e93;
      margin-bottom: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .truck-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 10px;
    }

    .truck-option {
      padding: 12px 8px;
      background: #f5f5f7;
      border-radius: 14px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }
    .truck-option:active { 
      transform: scale(0.95); 
    }
    .truck-option.selected {
      border-color: #000;
      background: white;
    }

    .truck-icon {
      font-size: 24px;
      margin-bottom: 6px;
    }

    .truck-name {
      font-size: 12px;
      font-weight: 600;
      color: #000;
      margin-bottom: 2px;
    }

    .truck-desc {
      font-size: 10px;
      color: #8e8e93;
    }

    /* Buttons - Clean modern style */
    .button-container {
      padding: 12px 0 0;
      flex-shrink: 0;
      margin-top: auto;
    }

    .button-grid {
      display: grid;
      gap: 12px;
    }
    .button-grid.single { 
      grid-template-columns: 1fr; 
    }
    .button-grid.double { 
      grid-template-columns: 1fr 1fr; 
    }

    .btn {
      padding: 18px;
      border: none;
      border-radius: 14px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      position: relative;
      overflow: hidden;
      min-height: 54px;
    }

    .btn-primary {
      background: #000;
      color: white;
    }
    .btn-primary:active {
      transform: scale(0.98);
      background: #222;
    }
    .btn-primary:disabled {
      background: #e5e7eb;
      color: #9ca3af;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: #f5f5f7;
      color: #000;
    }
    .btn-secondary:active {
      background: #e5e7eb;
      transform: scale(0.98);
    }

    /* Success Screen */
    .success-screen {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      z-index: 3000;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      text-align: center;
      padding: 40px 20px;
    }
    .success-screen.active {
      display: flex;
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .success-icon {
      font-size: 80px;
      margin-bottom: 24px;
      animation: successBounce 1s ease;
    }

    @keyframes successBounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .success-title {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 12px;
    }

    .success-message {
      font-size: 17px;
      opacity: 0.95;
      margin-bottom: 32px;
      line-height: 1.5;
    }

    .success-btn {
      background: white;
      color: #10b981;
      padding: 14px 32px;
      border-radius: 100px;
      font-size: 15px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .success-btn:active {
      transform: scale(0.95);
    }

    /* Picker Modal */
    .picker-modal {
      position: fixed;
      inset: 0;
      background: white;
      z-index: 2000;
      display: none;
    }
    .picker-modal.active {
      display: block;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }

    .picker-header {
      position: fixed;
      top: calc(var(--safe-area-inset-top) + var(--tg-safe-area-inset-top, 0px) + 12px);
      left: 12px;
      right: 12px;
      z-index: 2001;
      display: flex;
      gap: 12px;
    }

    .back-btn {
      width: 44px;
      height: 44px;
      background: white;
      border: none;
      border-radius: 50%;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      font-size: 20px;
    }
    .back-btn:active { 
      transform: scale(0.9); 
    }

    .search-box {
      flex: 1;
      background: white;
      border: none;
      border-radius: 100px;
      padding: 12px 20px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
      font-size: 15px;
      outline: none;
    }

    .picker-instructions {
      position: fixed;
      top: calc(var(--safe-area-inset-top) + var(--tg-safe-area-inset-top, 0px) + 70px);
      left: 12px;
      right: 12px;
      background: #000;
      color: white;
      padding: 12px 16px;
      border-radius: 14px;
      font-size: 13px;
      font-weight: 500;
      z-index: 2001;
      text-align: center;
    }

    .confirm-btn {
      position: fixed;
      bottom: calc(var(--safe-area-inset-bottom) + 30px);
      left: 20px;
      right: 20px;
      z-index: 2010;
      min-height: 54px;
    }

    .suggestions {
      position: fixed;
      top: calc(var(--safe-area-inset-top) + var(--tg-safe-area-inset-top, 0px) + 130px);
      left: 12px;
      right: 12px;
      background: white;
      border-radius: 14px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      max-height: 40vh;
      overflow-y: auto;
      z-index: 2002;
      display: none;
    }
    .suggestions.active { 
      display: block; 
    }

    .suggestion-item {
      padding: 14px 16px;
      border-bottom: 1px solid #f5f5f7;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s ease;
    }
    .suggestion-item:active { 
      background: #f5f5f7; 
    }
    .suggestion-item:last-child { 
      border-bottom: none; 
    }

    /* Map markers */
    .user-marker {
      width: 12px !important;
      height: 12px !important;
      background: #007AFF !important;
      border: 3px solid white !important;
      border-radius: 50% !important;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2) !important;
    }

    .custom-marker {
      width: 32px !important;
      height: 32px !important;
      border-radius: 50% !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      font-weight: 700 !important;
      color: white !important;
      font-size: 14px !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2) !important;
    }
    .custom-marker.pickup {
      background: #000 !important;
    }
    .custom-marker.dropoff {
      background: #ef4444 !important;
    }

    .picker-placed-pin {
      width: 20px !important;
      height: 20px !important;
      background: #000 !important;
      border: 2px solid white !important;
      border-radius: 50% !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
    }

    /* Responsive adjustments */
    @media (max-height: 700px) {
      .bottom-sheet { 
        max-height: 80vh; 
      }
      .truck-grid { 
        grid-template-columns: repeat(3, 1fr); 
      }
    }

    @media (max-height: 600px) {
      .form-grid.two-col { 
        grid-template-columns: 1fr; 
      }
      .bottom-sheet { 
        max-height: 75vh; 
      }
    }

    @media (orientation: landscape) and (max-height: 500px) {
      .bottom-sheet { 
        max-height: 90vh; 
      }
    }

    /* Loading spinner */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Top Controls -->
  <div class="top-bar">
    <div class="gps-status">
      <div class="gps-dot searching" id="gpsDot"></div>
      <span id="gpsText">GPS —ñ–∑–¥–µ—É...</span>
    </div>
    <div class="lang-switch">
      <button class="lang-btn active" data-lang="kz">KZ</button>
      <button class="lang-btn" data-lang="ru">RU</button>
    </div>
  </div>

  <!-- Success Screen -->
  <div class="success-screen" id="successScreen">
    <div class="success-icon">‚ú®</div>
    <div class="success-title">–¢–∞–ø—Å—ã—Ä—ã—Å –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ!</div>
    <div class="success-message">
      “ö–æ–ª –∂–µ—Ç—ñ–º–¥—ñ –∂“Ø—Ä–≥—ñ–∑—É—à—ñ–ª–µ—Ä–¥—ñ —ñ–∑–¥–µ–ø –∂–∞—Ç—ã—Ä–º—ã–∑.<br />–ë“±–ª –±—ñ—Ä–Ω–µ—à–µ —Å–µ–∫—É–Ω–¥“õ–∞ —Å–æ–∑—ã–ª–∞–¥—ã
    </div>
    <button class="success-btn" onclick="goToDriverList()">–ñ“Ø—Ä–≥—ñ–∑—É—à—ñ–ª–µ—Ä–¥—ñ –∫”©—Ä—É</button>
  </div>

  <!-- Bottom Sheet -->
  <div class="bottom-sheet">
    <div class="sheet-handle"></div>
    <div class="step-indicator">
      <div class="step-dot active" id="step1"></div>
      <div class="step-dot" id="step2"></div>
      <div class="step-dot" id="step3"></div>
    </div>

    <div class="sheet-content">
      <!-- Step 1: Address Selection -->
      <div class="form-step active" id="stepAddresses">
        <div class="address-section">
          <div class="address-card" onclick="openPicker('pickup')">
            <div class="marker">A</div>
            <div class="address-text">
              <div class="address-label" data-i18n="from">“ö–∞–π–¥–∞–Ω</div>
              <div class="address-value" id="pickupAddr" data-i18n="locating">–û—Ä—ã–Ω–¥—ã –∞–Ω—ã“õ—Ç–∞—É...</div>
            </div>
          </div>

          <div class="address-card" onclick="openPicker('dropoff')">
            <div class="marker dropoff">B</div>
            <div class="address-text">
              <div class="address-label" data-i18n="to">“ö–∞–π–¥–∞</div>
              <div class="address-value" id="dropoffAddr" data-i18n="selectDest">–ë–∞—Ä–∞—Ç—ã–Ω –∂–µ—Ä–¥—ñ —Ç–∞“£–¥–∞“£—ã–∑</div>
            </div>
          </div>

          <div class="distance-info" id="distanceInfo"></div>
        </div>

        <div class="button-container">
          <div class="button-grid single">
            <button class="btn btn-primary" id="nextStep1" onclick="goToStep(2)" disabled>–ö–µ–ª–µ—Å—ñ</button>
          </div>
        </div>
      </div>

      <!-- Step 2: Order Details -->
      <div class="form-step" id="stepDetails">
        <div class="form-title">–ñ–µ—Ç–∫—ñ–∑—É –º”ô–ª—ñ–º–µ—Ç—Ç–µ—Ä—ñ</div>

        <div class="form-content">
          <div class="form-grid">
            <div class="form-field">
              <div class="field-label">üí∞ –ë–∞“ì–∞ (—Ç–µ“£–≥–µ)</div>
              <input type="number" class="field-input" id="price" placeholder="5000" min="2000" oninput="validateCurrentStep()"/>
            </div>
          </div>

          <div class="truck-section">
            <div class="truck-label">üöö –ö”©–ª—ñ–∫ —Ç“Ø—Ä—ñ</div>
            <div class="truck-grid">
              <div class="truck-option" data-truck-type="intercity">
                <div class="truck-icon">üöï</div>
                <div class="truck-name">–¢–∞–∫—Å–∏</div>
                <div class="truck-desc">“õ–∞–ª–∞ –∞—Ä–∞–ª—ã“õ</div>
              </div>
              <div class="truck-option" data-truck-type="small">
                <div class="truck-icon">üöê</div>
                <div class="truck-name">–ö—ñ—à—ñ</div>
                <div class="truck-desc">1.5—Ç</div>
              </div>
              <div class="truck-option" data-truck-type="medium">
                <div class="truck-icon">üöö</div>
                <div class="truck-name">–û—Ä—Ç–∞—à–∞</div>
                <div class="truck-desc">5—Ç</div>
              </div>
              <div class="truck-option" data-truck-type="large">
                <div class="truck-icon">üöõ</div>
                <div class="truck-name">“Æ–ª–∫–µ–Ω</div>
                <div class="truck-desc">20—Ç</div>
              </div>
              <div class="truck-option" data-truck-type="tow">
                <div class="truck-icon">üöÅ</div>
                <div class="truck-name">–≠–≤–∞–∫—É–∞—Ç–æ—Ä</div>
                <div class="truck-desc">–∞–≤—Ç–æ</div>
              </div>
              <div class="truck-option" data-truck-type="any">
                <div class="truck-icon">‚úÖ</div>
                <div class="truck-name">–ö–µ–∑ –∫–µ–ª–≥–µ–Ω</div>
                <div class="truck-desc"></div>
              </div>
            </div>
          </div>

          <div class="form-grid two-col">
            <div class="form-field">
              <div class="field-label">üìÖ –ö“Ø–Ω—ñ</div>
              <input type="date" class="field-input" id="date" oninput="validateCurrentStep()"/>
            </div>
            <div class="form-field">
              <div class="field-label">‚è∞ –£–∞“õ—ã—Ç—ã</div>
              <input type="time" class="field-input" id="time" oninput="validateCurrentStep()"/>
            </div>
          </div>
        </div>

        <div class="button-container">
          <div class="button-grid double">
            <button class="btn btn-secondary" onclick="goToStep(1)">–ê—Ä—Ç“õ–∞</button>
            <button class="btn btn-primary" id="nextStep2" onclick="goToStep(3)" disabled>–ö–µ–ª–µ—Å—ñ</button>
          </div>
        </div>
      </div>

      <!-- Step 3: Contact Info -->
      <div class="form-step" id="stepContact">
        <div class="form-title">–ë–∞–π–ª–∞–Ω—ã—Å –∞“õ–ø–∞—Ä–∞—Ç—ã</div>

        <div class="form-content">
          <div class="form-grid">
            <div class="form-field">
              <div class="field-label">üì± –¢–µ–ª–µ—Ñ–æ–Ω</div>
              <input type="tel" class="field-input" id="phone" placeholder="+7 (___) ___-__-__" oninput="formatPhone(this); validateCurrentStep()"/>
            </div>

            <div class="form-field">
              <div class="field-label">üí¨ –¢“Ø—Å—ñ–Ω—ñ–∫—Ç–µ–º–µ</div>
              <textarea class="field-input" id="comment" placeholder="“ö–æ—Å—ã–º—à–∞ –∞“õ–ø–∞—Ä–∞—Ç..."></textarea>
            </div>
          </div>
        </div>

        <div class="button-container">
          <div class="button-grid double">
            <button class="btn btn-secondary" onclick="goToStep(2)">–ê—Ä—Ç“õ–∞</button>
            <button class="btn btn-primary" id="submitBtn" onclick="submitOrder()" disabled>
              <span id="submitText">–ñ—ñ–±–µ—Ä—É</span>
              <div class="loading" id="submitLoading" style="display: none;"></div>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Picker Modal -->
  <div class="picker-modal" id="pickerModal">
    <div id="pickerMap"></div>
    <div class="picker-header">
      <button class="back-btn" onclick="closePicker()">‚Üê</button>
      <input type="text" class="search-box" id="searchBox" placeholder="–ú–µ–∫–µ–Ω–∂–∞–π —ñ–∑–¥–µ—É..." oninput="searchAddress(this.value)"/>
    </div>
    
    <div class="picker-instructions" id="pickerInstructions">
      üìç –ö–∞—Ä—Ç–∞–¥–∞ –Ω“Ø–∫—Ç–µ–Ω—ñ —Ç–∞“£–¥–∞—É “Ø—à—ñ–Ω –±–∞—Å—ã“£—ã–∑ –Ω–µ–º–µ—Å–µ –∂–æ“ì–∞—Ä—ã–¥–∞ —ñ–∑–¥–µ“£—ñ–∑
    </div>
    
    <div class="suggestions" id="suggestions"></div>
    <button class="btn btn-primary confirm-btn" onclick="confirmPicker()">
      <span data-i18n="choose">–û—Å—ã –Ω“Ø–∫—Ç–µ–Ω—ñ —Ç–∞“£–¥–∞—É</span>
    </button>
  </div>

  <script>
    // Configuration
    const Y_KEY = '8a3e4da0-9ef2-4176-9203-e7014c1dba6f';
    const YA_LANG = () => (state.lang === 'kz' ? 'kk_KZ' : 'ru_RU');

    // Application State
    let state = {
      lang: 'kz',
      userLoc: null,
      pickup: null,
      dropoff: null,
      pickingFor: null,
      currentStep: 1,
      selectedTruck: null,
      orderData: null,
      followUserMode: true,
      manuallyPlacedPin: null,
      hasFirstGPSFix: false
    };

    // Internationalization
    const i18n = {
      kz: {
        from:'“ö–∞–π–¥–∞–Ω', to:'“ö–∞–π–¥–∞', locating:'–û—Ä—ã–Ω–¥—ã –∞–Ω—ã“õ—Ç–∞—É...', selectDest:'–ë–∞—Ä–∞—Ç—ã–Ω –∂–µ—Ä–¥—ñ —Ç–∞“£–¥–∞“£—ã–∑',
        submit:'–¢–∞–ø—Å—ã—Ä—ã—Å—Ç—ã –∂—ñ–±–µ—Ä—É', gpsActive:'GPS –±–µ–ª—Å–µ–Ω–¥—ñ', searching:'GPS —ñ–∑–¥–µ—É...', choose:'–û—Å—ã –Ω“Ø–∫—Ç–µ–Ω—ñ —Ç–∞“£–¥–∞—É',
        clickToPlace: 'üìç –ö–∞—Ä—Ç–∞–¥–∞ –Ω“Ø–∫—Ç–µ–Ω—ñ —Ç–∞“£–¥–∞—É “Ø—à—ñ–Ω –±–∞—Å—ã“£—ã–∑ –Ω–µ–º–µ—Å–µ –∂–æ“ì–∞—Ä—ã–¥–∞ —ñ–∑–¥–µ“£—ñ–∑'
      },
      ru: {
        from:'–û—Ç–∫—É–¥–∞', to:'–ö—É–¥–∞', locating:'–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è...', selectDest:'–í—ã–±–µ—Ä–∏—Ç–µ –∞–¥—Ä–µ—Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è',
        submit:'–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑', gpsActive:'GPS –∞–∫—Ç–∏–≤–µ–Ω', searching:'–ü–æ–∏—Å–∫ GPS...', choose:'–í—ã–±—Ä–∞—Ç—å —ç—Ç—É —Ç–æ—á–∫—É',
        clickToPlace: 'üìç –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ç–æ—á–∫—É –∏–ª–∏ –∏—â–∏—Ç–µ –≤—ã—à–µ'
      }
    };

    // Yandex Maps globals
    let map, pickerMap, userMarker, pickupMarker, dropoffMarker, placedPinMarker;
    let geolocationWatchId = null;
    let pickerMapLoaded = false;
    let mapUpdateInterval = null;
    let locationPermissionGranted = false;
    let currentUserLocation = null;
    let suggestionsTimeout = null;
    let lastUserPosition = null;

    // Main map initialization
    async function initMap() {
      console.log('üó∫Ô∏è Initializing map...');
      await ymaps3.ready;
      requestLocationPermission();
    }

    // Location permission request
    function requestLocationPermission() {
      updateLocationStatus('searching', state.lang === 'kz' ? i18n.kz.searching : i18n.ru.searching);
      
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            locationPermissionGranted = true;
            currentUserLocation = [position.coords.latitude, position.coords.longitude];
            state.userLoc = {
              lat: position.coords.latitude, 
              lng: position.coords.longitude, 
              accuracy: position.coords.accuracy
            };
            state.hasFirstGPSFix = true;
            
            updateLocationStatus('active', `${state.lang === 'kz' ? i18n.kz.gpsActive : i18n.ru.gpsActive} ¬±${Math.round(position.coords.accuracy)}m`);
            
            initMapWithPosition(currentUserLocation);
            setUserLocationAsPickup();
            startRealtimeLocationTracking();
          },
          (error) => {
            updateLocationStatus('error', 'GPS “õ–∞—Ç–µ—Å—ñ');
            initMapWithPosition([43.238949, 76.889709]);
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
          }
        );
      } else {
        updateLocationStatus('error', 'GPS “õ–æ–ª –∂–µ—Ç—ñ–º–¥—ñ –µ–º–µ—Å');
        initMapWithPosition([43.238949, 76.889709]);
      }
    }

    // Set user location as default pickup
    async function setUserLocationAsPickup() {
      if (!currentUserLocation) return;
      
      try {
        const addr = await reverseGeocode(currentUserLocation[0], currentUserLocation[1]);
        
        state.pickup = { 
          lat: currentUserLocation[0], 
          lng: currentUserLocation[1], 
          address: addr 
        };
        
        document.getElementById('pickupAddr').textContent = addr;
        document.querySelectorAll('.address-card')[0].classList.add('filled');
        
        await addMarker('pickup', currentUserLocation[0], currentUserLocation[1]);
        validateCurrentStep();
        
      } catch (error) {
        console.error('Error setting user location as pickup:', error);
      }
    }

    // Real-time location tracking
    function startRealtimeLocationTracking() {
      if (!navigator.geolocation || !locationPermissionGranted) return;

      // Watch position with high frequency and no strict accuracy filter
      geolocationWatchId = navigator.geolocation.watchPosition(
        (position) => {
          const newCoords = [position.coords.latitude, position.coords.longitude];
          const accuracy = position.coords.accuracy;
          
          // Accept all updates, no strict accuracy filtering
          currentUserLocation = newCoords;
          state.userLoc = {lat: newCoords[0], lng: newCoords[1], accuracy};
          
          if (!state.hasFirstGPSFix) {
            state.hasFirstGPSFix = true;
          }
          
          updateUserMarker(newCoords[0], newCoords[1]);
          updateLocationStatus('active', `GPS –±–µ–ª—Å–µ–Ω–¥—ñ ¬±${Math.round(accuracy)}m`);
        },
        (error) => {
          console.error('Real-time location error:', error);
          updateLocationStatus('error', 'GPS “õ–∞—Ç–µ—Å—ñ');
        },
        {
          enableHighAccuracy: true,
          timeout: 5000,
          maximumAge: 0
        }
      );

      // Interval polling every 1 second with maximumAge: 0
      mapUpdateInterval = setInterval(() => {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const newCoords = [position.coords.latitude, position.coords.longitude];
            const accuracy = position.coords.accuracy;
            
            // Accept all updates
            currentUserLocation = newCoords;
            state.userLoc = {lat: newCoords[0], lng: newCoords[1], accuracy};
            
            if (!state.hasFirstGPSFix) {
              state.hasFirstGPSFix = true;
            }
            
            updateUserMarker(newCoords[0], newCoords[1]);
            updateLocationStatus('active', `GPS –±–µ–ª—Å–µ–Ω–¥—ñ ¬±${Math.round(accuracy)}m`);
          },
          (error) => {
            console.error('Interval location error:', error);
          },
          {
            enableHighAccuracy: true,
            timeout: 2000,
            maximumAge: 0
          }
        );
      }, 1000);
    }

    function updateLocationStatus(status, message) {
      const gpsText = document.getElementById('gpsText');
      const gpsDot = document.getElementById('gpsDot');
      
      if (gpsText) gpsText.textContent = message;
      if (gpsDot) {
        gpsDot.classList.remove('error', 'searching');
        if (status === 'error') {
          gpsDot.classList.add('error');
        } else if (status === 'searching') {
          gpsDot.classList.add('searching');
        }
      }
    }

    // Initialize map with position
    async function initMapWithPosition(center) {
      await ymaps3.ready;
      const { 
        YMap, 
        YMapDefaultSchemeLayer, 
        YMapDefaultFeaturesLayer, 
        YMapListener
      } = ymaps3;

      try {
        map = new YMap(document.getElementById('map'), {
          location: {
            center: [center[1], center[0]],
            zoom: 15
          },
          theme: 'light'
        });

        map.addChild(new YMapDefaultSchemeLayer({ theme: 'light' }));
        map.addChild(new YMapDefaultFeaturesLayer());

        const mapListener = new YMapListener({
          layer: 'any',
          onUpdate: () => {
            // User has manually panned, stop following
            state.followUserMode = false;
          }
        });
        map.addChild(mapListener);

        await addUserLocationMarker(center);

      } catch (error) {
        console.error('Error initializing map:', error);
      }
    }

    // Add user location marker
    async function addUserLocationMarker(coords) {
      if (!map) return;
      
      await ymaps3.ready;
      const { YMapMarker } = ymaps3;

      try {
        const el = document.createElement('div');
        el.className = 'user-marker';

        userMarker = new YMapMarker({
          coordinates: [coords[1], coords[0]],
          draggable: false
        }, el);

        map.addChild(userMarker);
        
      } catch (error) {
        console.error('Error adding user marker:', error);
      }
    }

    // Update user marker
    async function updateUserMarker(lat, lng) {
      try {
        if (lastUserPosition && 
            Math.abs(lastUserPosition[0] - lat) < 0.00001 && 
            Math.abs(lastUserPosition[1] - lng) < 0.00001) {
          return;
        }
        
        lastUserPosition = [lat, lng];
        
        // Create marker if it doesn't exist
        if (!userMarker && map) {
          await addUserLocationMarker([lat, lng]);
          return;
        }
        
        if (!userMarker || !map) return;
        
        userMarker.update({
          coordinates: [lng, lat]
        });
        
        // Follow user only if in follow mode and on step 1
        if (state.currentStep === 1 && state.followUserMode) {
          map.update({ 
            location: { 
              center: [lng, lat], 
              zoom: map.location?.zoom || 15 
            },
            duration: 1000
          });
        }
        
      } catch (error) {
        console.error('Error updating user marker:', error);
        await addUserLocationMarker([lat, lng]);
      }
    }

    // Build picker map
    async function buildPickerMap(center) {
      await ymaps3.ready;
      pickerMapLoaded = false;

      const { YMap, YMapDefaultSchemeLayer, YMapDefaultFeaturesLayer, YMapListener } = ymaps3;

      const el = document.getElementById('pickerMap');
      if (!el) return;

      if (pickerMap) {
        try { pickerMap.destroy(); } catch (e) {}
      }
      pickerMap = null;
      el.innerHTML = '';

      await new Promise(resolve => requestAnimationFrame(resolve));

      try {
        pickerMap = new YMap(el, {
          location: {
            center,
            zoom: 16
          },
          theme: 'light'
        });

        pickerMap.addChild(new YMapDefaultSchemeLayer({ theme: 'light' }));
        pickerMap.addChild(new YMapDefaultFeaturesLayer());

        const clickListener = new YMapListener({
          layer: 'any',
          onClick: (object, event) => {
            if (event.coordinates) {
              placePinAtCoordinates(event.coordinates);
            }
          }
        });
        pickerMap.addChild(clickListener);

        // Map is now loaded and ready
        pickerMapLoaded = true;

        if (placedPinMarker) {
          try { pickerMap.removeChild(placedPinMarker); } catch (e) {}
          placedPinMarker = null;
        }

        updatePickerInstructions();

      } catch (error) {
        console.error('Error creating picker map:', error);
        document.getElementById('pickerInstructions').textContent = '–ö–∞—Ä—Ç–∞–Ω—ã –∂“Ø–∫—Ç–µ—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã';
      }
    }

    // Place pin at coordinates
    async function placePinAtCoordinates(coordinates) {
      if (!pickerMap || !pickerMapLoaded) return;
      
      await ymaps3.ready;
      const { YMapMarker } = ymaps3;

      try {
        if (placedPinMarker) {
          try { pickerMap.removeChild(placedPinMarker); } catch (e) {}
        }

        const pinEl = document.createElement('div');
        pinEl.className = 'picker-placed-pin';
        
        placedPinMarker = new YMapMarker({
          coordinates: coordinates,
          draggable: true
        }, pinEl);

        pickerMap.addChild(placedPinMarker);
        
        state.manuallyPlacedPin = {
          lat: coordinates[1],
          lng: coordinates[0]
        };
        
        document.getElementById('pickerInstructions').textContent = 
          state.lang === 'kz' ? 
          '‚úÖ –ù“Ø–∫—Ç–µ —Ç–∞“£–¥–∞–ª–¥—ã! "–¢–∞“£–¥–∞—É" –±–∞—Ç—ã—Ä–º–∞—Å—ã–Ω –±–∞—Å—ã“£—ã–∑' : 
          '‚úÖ –¢–æ—á–∫–∞ –≤—ã–±—Ä–∞–Ω–∞! –ù–∞–∂–º–∏—Ç–µ "–í—ã–±—Ä–∞—Ç—å"';
        
      } catch (error) {
        console.error('Error placing pin:', error);
      }
    }

    // Update picker instructions
    function updatePickerInstructions() {
      const instructions = document.getElementById('pickerInstructions');
      if (instructions) {
        instructions.textContent = state.lang === 'kz' ? 
          i18n.kz.clickToPlace : 
          i18n.ru.clickToPlace;
      }
    }

    // Add marker to main map
    async function addMarker(type, lat, lng) {
      if (!map) return;
      
      await ymaps3.ready;
      const { YMapMarker } = ymaps3;

      try {
        const el = document.createElement('div');
        el.className = `custom-marker ${type}`;
        el.textContent = type === 'pickup' ? 'A' : 'B';
        
        const marker = new YMapMarker({
          coordinates: [lng, lat],
          draggable: false
        }, el);

        if (type === 'pickup') {
          if (pickupMarker && map) {
            try { map.removeChild(pickupMarker); } catch (e) {}
          }
          pickupMarker = marker;
        } else {
          if (dropoffMarker && map) {
            try { map.removeChild(dropoffMarker); } catch (e) {}
          }
          dropoffMarker = marker;
        }
        
        map.addChild(marker);
        
        if (pickupMarker && dropoffMarker) {
          setTimeout(() => fitBothPointsOnMap(), 300);
        }
        
      } catch (error) {
        console.error(`Error adding ${type} marker:`, error);
      }
    }

    // Fit both points on map
    function fitBothPointsOnMap() {
      if (!map || !state.pickup || !state.dropoff) return;
      
      try {
        const bounds = [
          [Math.min(state.pickup.lng, state.dropoff.lng), Math.min(state.pickup.lat, state.dropoff.lat)],
          [Math.max(state.pickup.lng, state.dropoff.lng), Math.max(state.pickup.lat, state.dropoff.lat)]
        ];
        
        const padding = 0.01;
        bounds[0][0] -= padding;
        bounds[0][1] -= padding;
        bounds[1][0] += padding;
        bounds[1][1] += padding;
        
        map.update({
          location: { bounds: bounds },
          duration: 1500
        });
        
        showDistanceInfo();
        
      } catch (error) {
        console.error('Error fitting points on map:', error);
      }
    }

    // Show distance info
    function showDistanceInfo() {
      if (!state.pickup || !state.dropoff) return;
      
      const distance = calculateDistance(
        state.pickup.lat, state.pickup.lng,
        state.dropoff.lat, state.dropoff.lng
      );
      
      document.getElementById('distanceInfo').innerHTML = `üìè ${distance.toFixed(1)} –∫–º`;
      document.getElementById('distanceInfo').classList.add('active');
    }

    // Geocoding functions
    async function reverseGeocode(lat, lng) {
      try {
        const res = await fetch(
          `https://geocode-maps.yandex.ru/1.x/?apikey=${Y_KEY}&geocode=${lng},${lat}&format=json&lang=${YA_LANG()}&results=1`
        );
        
        if (!res.ok) throw new Error('Geocoding request failed');
        
        const data = await res.json();
        const coll = data.response?.GeoObjectCollection;
        const feature = coll?.featureMember?.[0]?.GeoObject;
        const text =
          feature?.metaDataProperty?.GeocoderMetaData?.Address?.formatted ||
          feature?.metaDataProperty?.GeocoderMetaData?.text;
          
        return text || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      } catch (error) {
        return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      }
    }

    async function searchAddress(query) {
      if (query.length < 3) {
        document.getElementById('suggestions').classList.remove('active');
        return;
      }
      
      try {
        const res = await fetch(
          `https://geocode-maps.yandex.ru/1.x/?apikey=${Y_KEY}&geocode=${encodeURIComponent(
            query
          )}&format=json&lang=${YA_LANG()}&results=10&ll=76.889709,43.238949&spn=5,5`
        );
        
        const data = await res.json();
        const items = data.response?.GeoObjectCollection?.featureMember || [];
        
        const html = items
          .map(({ GeoObject }) => {
            const [lng, lat] = GeoObject.Point.pos.split(' ').map(Number);
            const md = GeoObject.metaDataProperty.GeocoderMetaData;
            const text = md?.Address?.formatted || md?.text || `${lat}, ${lng}`;
            return `<div class="suggestion-item" data-lat="${lat}" data-lng="${lng}">${text}</div>`;
          })
          .join('');
          
        const sug = document.getElementById('suggestions');
        sug.innerHTML = html;
        sug.classList.add('active');
        
        // Add click handlers to suggestion items
        sug.querySelectorAll('.suggestion-item').forEach(item => {
          item.addEventListener('click', function(e) {
            e.preventDefault();
            const lat = parseFloat(this.dataset.lat);
            const lng = parseFloat(this.dataset.lng);
            selectSuggestion(lat, lng);
          });
        });
        
      } catch (error) {
        console.error('Search error:', error);
      }
    }

    function selectSuggestion(lat, lng) {
      if (pickerMap && pickerMapLoaded) {
        const center = [lng, lat];
        pickerMap.update({ location: { center, zoom: 17 }, duration: 500 });
        
        setTimeout(() => {
          placePinAtCoordinates([lng, lat]);
        }, 600);
      }
      document.getElementById('suggestions').classList.remove('active');
      document.getElementById('searchBox').value = '';
    }

    // Calculate distance
    function calculateDistance(lat1, lng1, lat2, lng2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
        Math.sin(dLng/2) * Math.sin(dLng/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // Step navigation
    function goToStep(step) {
      document.querySelectorAll('.form-step').forEach((s) => s.classList.remove('active'));
      document.querySelectorAll('.step-dot').forEach((d) => d.classList.remove('active'));

      document
        .getElementById(`step${step === 1 ? 'Addresses' : step === 2 ? 'Details' : 'Contact'}`)
        .classList.add('active');
      document.getElementById(`step${step}`).classList.add('active');

      state.currentStep = step;
      validateCurrentStep();
      
      if (step === 1) {
        state.followUserMode = true;
      }
    }

    function validateCurrentStep() {
      let isValid = false;

      if (state.currentStep === 1) {
        isValid = state.pickup && state.dropoff;
        document.getElementById('nextStep1').disabled = !isValid;
      } else if (state.currentStep === 2) {
        const price = Number(document.getElementById('price').value);
        const date = document.getElementById('date').value;
        const time = document.getElementById('time').value;
        isValid = price >= 2000 && date && time && state.selectedTruck;
        document.getElementById('nextStep2').disabled = !isValid;
      } else if (state.currentStep === 3) {
        const phone = document.getElementById('phone').value;
        isValid = phone.length >= 18;
        document.getElementById('submitBtn').disabled = !isValid;
      }
    }

    function selectTruck(element) {
      const type = element.dataset.truckType;
      document.querySelectorAll('.truck-option').forEach((opt) => opt.classList.remove('selected'));
      element.classList.add('selected');
      state.selectedTruck = type;
      validateCurrentStep();
    }

    // Picker functions
    async function openPicker(type) {
      state.pickingFor = type;
      
      const modal = document.getElementById('pickerModal');
      modal.classList.add('active');

      let center;
      if (type === 'pickup' && state.pickup) {
        center = [state.pickup.lng, state.pickup.lat];
      } else if (type === 'dropoff' && state.dropoff) {
        center = [state.dropoff.lng, state.dropoff.lat];
      } else if (currentUserLocation) {
        center = [currentUserLocation[1], currentUserLocation[0]];
      } else {
        center = [76.889709, 43.238949];
      }

      await new Promise(resolve => setTimeout(resolve, 100));
      await buildPickerMap(center);
    }

    function closePicker() {
      const modal = document.getElementById('pickerModal');
      modal.classList.remove('active');
      
      document.getElementById('suggestions').classList.remove('active');
      document.getElementById('searchBox').value = '';
      
      if (pickerMap) {
        try { pickerMap.destroy(); } catch (e) {}
      }
      pickerMap = null;
      pickerMapLoaded = false;
      
      if (placedPinMarker) {
        placedPinMarker = null;
      }
      state.manuallyPlacedPin = null;
      
      state.pickingFor = null;
    }

    async function confirmPicker() {
      if (!state.pickingFor) return;

      // Fallback to map center if no manual pin placed
      let lat, lng;
      
      if (state.manuallyPlacedPin) {
        lat = state.manuallyPlacedPin.lat;
        lng = state.manuallyPlacedPin.lng;
      } else if (pickerMap && pickerMap.location) {
        // Use map center as fallback
        lng = pickerMap.location.center[0];
        lat = pickerMap.location.center[1];
      } else if (currentUserLocation) {
        // Use user location as last resort
        lat = currentUserLocation[0];
        lng = currentUserLocation[1];
      } else {
        const msg = state.lang === 'kz'
          ? '–ê–ª–¥—ã–º–µ–Ω –∫–∞—Ä—Ç–∞–¥–∞ –Ω“Ø–∫—Ç–µ–Ω—ñ —Ç–∞“£–¥–∞“£—ã–∑'
          : '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ';
        if (window.Telegram?.WebApp) Telegram.WebApp.showAlert(msg); else alert(msg);
        return;
      }

      try {
        const addr = await reverseGeocode(lat, lng);

        if (state.pickingFor === 'pickup') {
          state.pickup = { lat, lng, address: addr };
          document.getElementById('pickupAddr').textContent = addr;
          document.querySelectorAll('.address-card')[0].classList.add('filled');
          await addMarker('pickup', lat, lng);
        } else {
          state.dropoff = { lat, lng, address: addr };
          document.getElementById('dropoffAddr').textContent = addr;
          document.querySelectorAll('.address-card')[1].classList.add('filled');
          await addMarker('dropoff', lat, lng);
        }

        closePicker();
        validateCurrentStep();

      } catch (error) {
        console.error('Confirm picker error:', error);
      }
    }

    // Phone formatting
    function formatPhone(input) {
      let val = input.value.replace(/\D/g, '');
      if (!val) return;
      if (val[0] !== '7') val = '7' + val;

      let fmt = '+7';
      if (val.length > 1) fmt += ` (${val.slice(1, 4)}`;
      if (val.length >= 4) fmt += ')';
      if (val.length > 4) fmt += ` ${val.slice(4, 7)}`;
      if (val.length > 7) fmt += `-${val.slice(7, 9)}`;
      if (val.length > 9) fmt += `-${val.slice(9, 11)}`;

      input.value = fmt;
    }

    // Submit order
    async function submitOrder() {
      const submitBtn = document.getElementById('submitBtn');
      const submitText = document.getElementById('submitText');
      const submitLoading = document.getElementById('submitLoading');
      const tg = window.Telegram?.WebApp;

      submitBtn.disabled = true;
      submitText.style.display = 'none';
      submitLoading.style.display = 'block';

      try {
        const formData = new FormData();
        formData.append('from_address', state.pickup.address);
        formData.append('from_lat', state.pickup.lat);
        formData.append('from_lon', state.pickup.lng);
        formData.append('to_address', state.dropoff.address);
        formData.append('to_lat', state.dropoff.lat);
        formData.append('to_lon', state.dropoff.lng);
        formData.append('price', document.getElementById('price').value);
        formData.append('truck_type', state.selectedTruck);
        formData.append('date', document.getElementById('date').value);
        formData.append('time', document.getElementById('time').value);
        formData.append('contact', document.getElementById('phone').value);
        formData.append('comment', document.getElementById('comment').value);

        if (tg?.initDataUnsafe?.user) {
          formData.append('telegram_id', tg.initDataUnsafe.user.id);
        }

        const res = await fetch('/api/delivery-request', { method: 'POST', body: formData });
        const json = await res.json().catch(() => ({ success: false }));

        if (json?.success) {
          state.orderData = {
            pickup: state.pickup,
            dropoff: state.dropoff,
            price: document.getElementById('price').value,
            truck_type: state.selectedTruck,
            contact: document.getElementById('phone').value,
            request_id: json.data?.request_id
          };
          showSuccessScreen();
          stopRealtimeGeolocation();
        } else {
          throw new Error(json?.message || 'Request failed');
        }
      } catch (error) {
        const errorMsg = `Error: ${error.message}`;
        const tg = window.Telegram?.WebApp;
        if (tg) tg.showAlert(errorMsg);
        else alert(errorMsg);
      } finally {
        submitBtn.disabled = false;
        submitText.style.display = 'block';
        submitLoading.style.display = 'none';
        validateCurrentStep();
      }
    }

    function showSuccessScreen() {
      document.getElementById('successScreen').classList.add('active');
      setTimeout(() => {
        goToDriverList();
      }, 3000);
    }

    function goToDriverList() {
      const orderData = encodeURIComponent(JSON.stringify(state.orderData));
      window.location.href = `/driver-list?order=${orderData}`;
    }

    function stopRealtimeGeolocation() {
      if (geolocationWatchId) {
        navigator.geolocation.clearWatch(geolocationWatchId);
        geolocationWatchId = null;
      }
      if (mapUpdateInterval) {
        clearInterval(mapUpdateInterval);
        mapUpdateInterval = null;
      }
    }

    function setLang(lang) {
      state.lang = lang;
      document.querySelectorAll('.lang-btn').forEach((btn) => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
      });

      document.querySelectorAll('[data-i18n]').forEach((el) => {
        const key = el.dataset.i18n;
        if (i18n[lang][key]) el.textContent = i18n[lang][key];
      });

      updatePickerInstructions();

      // Update status if we have a fix
      if (state.hasFirstGPSFix && state.userLoc) {
        updateLocationStatus('active', `${lang === 'kz' ? i18n.kz.gpsActive : i18n.ru.gpsActive} ¬±${Math.round(state.userLoc.accuracy)}m`);
      }

      if (lang === 'kz') {
        document.querySelector('.success-title').textContent = '–¢–∞–ø—Å—ã—Ä—ã—Å –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ!';
        document.querySelector('.success-message').textContent =
          '“ö–æ–ª –∂–µ—Ç—ñ–º–¥—ñ –∂“Ø—Ä–≥—ñ–∑—É—à—ñ–ª–µ—Ä–¥—ñ —ñ–∑–¥–µ–ø –∂–∞—Ç—ã—Ä–º—ã–∑.\n–ë“±–ª –±—ñ—Ä–Ω–µ—à–µ —Å–µ–∫—É–Ω–¥“õ–∞ —Å–æ–∑—ã–ª–∞–¥—ã';
        document.querySelector('.success-btn').textContent = '–ñ“Ø—Ä–≥—ñ–∑—É—à—ñ–ª–µ—Ä–¥—ñ –∫”©—Ä—É';
      } else {
        document.querySelector('.success-title').textContent = '–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!';
        document.querySelector('.success-message').textContent =
          '–ò—â–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π.\n–≠—Ç–æ –∑–∞–π–º–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥';
        document.querySelector('.success-btn').textContent = '–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤–æ–¥–∏—Ç–µ–ª–µ–π';
      }
    }

    // Initialize application
    document.addEventListener('DOMContentLoaded', async () => {
      
      if (!window.ymaps3) {
        console.error('Yandex Maps v3 failed to load');
        return;
      }
      
      // Setup Telegram WebApp viewport height
      if (window.Telegram?.WebApp) {
        const tg = Telegram.WebApp;
        tg.ready();
        tg.expand();
        
        // Set CSS variables for Telegram safe areas
        if (tg.viewportStableHeight) {
          document.documentElement.style.setProperty('--tg-viewport-stable-height', `${tg.viewportStableHeight}px`);
        }
        if (tg.safeAreaInset) {
          document.documentElement.style.setProperty('--tg-safe-area-inset-top', `${tg.safeAreaInset.top}px`);
        }
        if (tg.contentSafeAreaInset) {
          document.documentElement.style.setProperty('--tg-content-safe-area-inset-top', `${tg.contentSafeAreaInset.top}px`);
        }
      }
      
      await initMap();

      const now = new Date();
      document.getElementById('date').valueAsDate = now;
      document.getElementById('time').value = now.toTimeString().slice(0, 5);

      // Setup language switcher with proper event handling
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          setLang(this.dataset.lang);
        });
      });

      // Setup truck options with proper event handling
      document.querySelectorAll('.truck-option').forEach(opt => {
        opt.addEventListener('click', function(e) {
          e.preventDefault();
          selectTruck(this);
        });
      });

      // Setup search box blur handler
      const searchBox = document.getElementById('searchBox');
      searchBox.addEventListener('blur', () => {
        setTimeout(() => {
          document.getElementById('suggestions').classList.remove('active');
        }, 200);
      });

      // Setup Enter key handler for suggestions
      searchBox.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const firstSuggestion = document.querySelector('.suggestion-item');
          if (firstSuggestion) {
            const lat = parseFloat(firstSuggestion.dataset.lat);
            const lng = parseFloat(firstSuggestion.dataset.lng);
            selectSuggestion(lat, lng);
          }
        }
      });

      setLang('kz');
    });

    window.addEventListener('beforeunload', () => {
      stopRealtimeGeolocation();
    });

    // Global function exports
    window.openPicker = openPicker;
    window.closePicker = closePicker;
    window.confirmPicker = confirmPicker;
    window.searchAddress = searchAddress;
    window.goToStep = goToStep;
    window.formatPhone = formatPhone;
    window.submitOrder = submitOrder;
    window.goToDriverList = goToDriverList;
    window.placePinAtCoordinates = placePinAtCoordinates;
  </script>
</body>
</html>