<!DOCTYPE html>
<html lang="kz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-visual" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>QazLine - Delivery</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script defer src="https://api-maps.yandex.ru/v3/?apikey=8a3e4da0-9ef2-4176-9203-e7014c1dba6f&lang=ru_RU"></script>

  <style>
    /* Figma Transportation Design System */
    :root {
      --primary: #4C6FFF;
      --primary-dark: #3D5ACC;
      --secondary: #00D9B9;
      --success: #00D395;
      --warning: #FFB800;
      --danger: #FF5C5C;
      --dark: #1A1D29;
      --dark-light: #2A2F3F;
      --grey: #6B7280;
      --grey-light: #E5E7EB;
      --white: #FFFFFF;
      --bg: #F7F8FA;
      
      --radius: 16px;
      --radius-lg: 24px;
      --shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.12);
      
      --tg-safe-top: env(safe-area-inset-top, 0px);
      --tg-safe-bottom: env(safe-area-inset-bottom, 0px);
      --tg-viewport-height: 100vh;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      height: 100%;
      overflow: hidden;
      position: fixed;
      width: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif;
    }

    body {
      height: var(--tg-viewport-height);
      background: var(--bg);
    }

    /* FULL SCREEN MAP - FIXED: touch-action for proper gestures */
    #map, #pickerMap {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      touch-action: none;
      z-index: 1;
    }

    /* GEOLOCATION BUTTON - FIXED: Higher position, white with black icon */
    .geo-btn {
      position: fixed;
      bottom: calc(var(--tg-safe-bottom) + 240px);
      right: 16px;
      width: 56px;
      height: 56px;
      background: var(--white);
      border: none;
      border-radius: 50%;
      box-shadow: var(--shadow-lg);
      cursor: pointer;
      z-index: 1002;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .geo-btn:active {
      transform: scale(0.92);
    }
    .geo-btn svg {
      width: 24px;
      height: 24px;
      fill: var(--dark);
    }

    /* ANIMATED BOTTOM SHEET - Figma Style */
    .bottom-sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--white);
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
      box-shadow: var(--shadow-lg);
      z-index: 1001;
      max-height: 88vh;
      display: flex;
      flex-direction: column;
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .sheet-header {
      padding: 12px 20px 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      flex-shrink: 0;
    }

    .sheet-handle {
      width: 40px;
      height: 4px;
      background: var(--grey-light);
      border-radius: 2px;
      margin-bottom: 16px;
    }

    /* Step Progress */
    .step-progress {
      display: flex;
      gap: 8px;
      width: 100%;
      max-width: 200px;
    }

    .step-bar {
      flex: 1;
      height: 3px;
      background: var(--grey-light);
      border-radius: 2px;
      position: relative;
      overflow: hidden;
    }
    .step-bar.active::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--primary);
      animation: fillBar 0.4s ease;
    }

    @keyframes fillBar {
      from { transform: translateX(-100%); }
      to { transform: translateX(0); }
    }

    /* Sheet Content */
    .sheet-content {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      padding: 0 20px 32px;
    }

    /* Form Steps */
    .form-step {
      display: none;
      animation: slideIn 0.4s ease;
    }
    .form-step.active {
      display: block;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    /* Address Cards - Figma Design */
    .address-card {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 20px 16px;
      background: var(--bg);
      border-radius: var(--radius);
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      position: relative;
      overflow: hidden;
    }
    .address-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: transparent;
      transition: background 0.3s ease;
    }
    .address-card:active {
      transform: scale(0.98);
    }
    .address-card.filled {
      background: #F0F9FF;
      border-color: var(--primary);
    }
    .address-card.filled::before {
      background: var(--primary);
    }

    .location-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      flex-shrink: 0;
      position: relative;
    }
    .location-icon.start {
      background: linear-gradient(135deg, #1A1D29, #2A2F3F);
      color: white;
    }
    .location-icon.end {
      background: linear-gradient(135deg, #FF5C5C, #FF7A7A);
      color: white;
    }

    .location-text {
      flex: 1;
      min-width: 0;
    }

    .location-label {
      font-size: 12px;
      color: var(--grey);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .location-value {
      font-size: 15px;
      font-weight: 500;
      color: var(--dark);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Distance Badge */
    .distance-badge {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 16px;
      background: linear-gradient(135deg, var(--success), #00E5A0);
      color: white;
      border-radius: var(--radius);
      margin-bottom: 20px;
      font-weight: 600;
      box-shadow: 0 4px 16px rgba(0, 211, 149, 0.3);
    }
    .distance-badge.active {
      display: flex;
      animation: slideDown 0.4s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Form Title */
    .form-title {
      font-size: 22px;
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 24px;
    }

    /* Form Fields - Figma Style */
    .form-field {
      margin-bottom: 16px;
    }

    .field-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--grey);
      margin-bottom: 8px;
      display: block;
    }

    .field-input {
      width: 100%;
      padding: 16px;
      background: var(--bg);
      border: 2px solid transparent;
      border-radius: var(--radius);
      font-size: 15px;
      font-weight: 500;
      color: var(--dark);
      transition: all 0.3s ease;
      font-family: inherit;
    }
    .field-input:focus {
      outline: none;
      background: white;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(76, 111, 255, 0.1);
    }
    .field-input::placeholder {
      color: var(--grey);
    }
    .field-input.error {
      border-color: var(--danger);
    }

    textarea.field-input {
      min-height: 100px;
      resize: none;
    }

    /* Truck Grid - Updated with Tow Truck */
    .truck-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .truck-card {
      padding: 16px 12px;
      background: var(--bg);
      border: 2px solid transparent;
      border-radius: var(--radius);
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }
    .truck-card:active {
      transform: scale(0.95);
    }
    .truck-card.selected {
      background: #F0F9FF;
      border-color: var(--primary);
      box-shadow: 0 4px 16px rgba(76, 111, 255, 0.2);
    }
    .truck-card.selected::after {
      content: '‚úì';
      position: absolute;
      top: 8px;
      right: 8px;
      width: 20px;
      height: 20px;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
    }

    .truck-icon {
      font-size: 28px;
      margin-bottom: 8px;
    }

    .truck-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 2px;
    }

    .truck-desc {
      font-size: 11px;
      color: var(--grey);
    }

    /* Date/Time Grid */
    .datetime-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    /* Buttons - Figma Style */
    .btn-group {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 24px;
      position: sticky;
      bottom: 0;
      background: white;
      padding-top: 16px;
    }
    .btn-group.double {
      grid-template-columns: 1fr 1fr;
    }

    .btn {
      padding: 18px 24px;
      border: none;
      border-radius: var(--radius);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    .btn:active::before {
      width: 300px;
      height: 300px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      box-shadow: 0 4px 16px rgba(76, 111, 255, 0.3);
    }
    .btn-primary:active {
      transform: scale(0.96);
    }
    .btn-primary:disabled {
      background: var(--grey-light);
      color: var(--grey);
      box-shadow: none;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: var(--bg);
      color: var(--dark);
      border: 2px solid var(--grey-light);
    }
    .btn-secondary:active {
      background: var(--grey-light);
      transform: scale(0.96);
    }

    /* Success Screen */
    .success-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, var(--success), #00E5A0);
      z-index: 3000;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      padding: 40px;
      text-align: center;
    }
    .success-screen.active {
      display: flex;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .success-icon {
      width: 120px;
      height: 120px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 64px;
      margin-bottom: 32px;
      animation: scaleIn 0.6s ease;
    }

    @keyframes scaleIn {
      from {
        transform: scale(0);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .success-title {
      font-size: 28px;
      font-weight: 700;
      color: white;
      margin-bottom: 12px;
    }

    .success-message {
      font-size: 16px;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 32px;
      line-height: 1.6;
    }

    .success-btn {
      padding: 16px 32px;
      background: white;
      color: var(--success);
      border: none;
      border-radius: var(--radius);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
    }
    .success-btn:active {
      transform: scale(0.96);
    }

    /* PICKER MODAL */
    .picker-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      z-index: 2000;
      display: none;
    }
    .picker-modal.active {
      display: block;
    }

    /* FIXED: Search Header with Safe Area */
    .picker-header {
      position: fixed;
      top: calc(var(--tg-safe-top) + 12px);
      left: 16px;
      right: 16px;
      z-index: 2010;
      display: flex;
      gap: 12px;
    }

    .back-btn {
      width: 48px;
      height: 48px;
      background: white;
      border: none;
      border-radius: 12px;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
    }
    .back-btn:active {
      transform: scale(0.94);
    }

    .search-box {
      flex: 1;
      background: white;
      border: none;
      border-radius: 12px;
      padding: 14px 16px;
      box-shadow: var(--shadow);
      font-size: 15px;
      font-weight: 500;
    }
    .search-box:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(76, 111, 255, 0.1), var(--shadow);
    }

    /* Instructions */
    .picker-instructions {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(26, 29, 41, 0.9);
      backdrop-filter: blur(10px);
      color: white;
      padding: 10px 20px;
      border-radius: 24px;
      font-size: 13px;
      font-weight: 500;
      z-index: 2001;
      pointer-events: none;
      white-space: nowrap;
      opacity: 0.95;
    }
    .picker-instructions.hidden {
      display: none;
    }

    .confirm-btn {
      position: fixed;
      bottom: calc(var(--tg-safe-bottom) + 20px);
      left: 16px;
      right: 16px;
      z-index: 2020;
    }

    /* FIXED: Suggestions - moved lower, z-index below confirm button */
    .suggestions {
      position: fixed;
      top: calc(var(--tg-safe-top) + 84px);
      left: 16px;
      right: 16px;
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      max-height: 45vh;
      overflow-y: auto;
      z-index: 2005;
      display: none;
    }
    .suggestions.active {
      display: block;
      animation: slideDown 0.3s ease;
    }

    .suggestion-item {
      padding: 16px;
      border-bottom: 1px solid var(--grey-light);
      cursor: pointer;
      transition: background 0.2s;
    }
    .suggestion-item:active {
      background: var(--bg);
    }
    .suggestion-item:last-child {
      border-bottom: none;
    }

    /* Map Markers */
    .user-marker {
      width: 16px;
      height: 16px;
      background: var(--primary);
      border: 3px solid white;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(76, 111, 255, 0.5);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% {
        box-shadow: 0 2px 8px rgba(76, 111, 255, 0.5);
      }
      50% {
        box-shadow: 0 2px 16px rgba(76, 111, 255, 0.8);
      }
    }

    /* FIXED: Custom markers with proper colors - A is black, B is red */
    .custom-marker {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: white;
      font-size: 18px;
      border: 3px solid white;
      box-shadow: var(--shadow);
    }
    .custom-marker.pickup {
      background: linear-gradient(135deg, #1A1D29, #2A2F3F);
    }
    .custom-marker.dropoff {
      background: linear-gradient(135deg, #FF5C5C, #FF7A7A);
    }

    .placed-pin {
      width: 24px;
      height: 24px;
      background: var(--primary);
      border: 3px solid white;
      border-radius: 50%;
      box-shadow: var(--shadow-lg);
      animation: pinDrop 0.5s ease;
    }

    @keyframes pinDrop {
      0% {
        transform: translateY(-30px) scale(0);
        opacity: 0;
      }
      60% {
        transform: translateY(0) scale(1.2);
        opacity: 1;
      }
      100% {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
    }

    /* Error Message */
    .error-message {
      font-size: 12px;
      color: var(--danger);
      margin-top: 4px;
      display: none;
    }
    .error-message.show {
      display: block;
    }

    /* Responsive */
    @media (max-height: 700px) {
      .bottom-sheet {
        max-height: 85vh;
      }
      .truck-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
      }
      .truck-card {
        padding: 12px 8px;
      }
    }

    @media (max-width: 360px) {
      .truck-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <!-- MAP -->
  <div id="map"></div>

  <!-- GEOLOCATION BUTTON -->
  <button class="geo-btn" onclick="centerOnUserLocation()" id="geoBtn">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
    </svg>
  </button>

  <!-- SUCCESS SCREEN -->
  <div class="success-screen" id="successScreen">
    <div class="success-icon">üéâ</div>
    <div class="success-title" data-i18n="successTitle">–¢–∞–ø—Å—ã—Ä—ã—Å –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ!</div>
    <div class="success-message" data-i18n="successMsg">
      “ö–æ–ª –∂–µ—Ç—ñ–º–¥—ñ –∂“Ø—Ä–≥—ñ–∑—É—à—ñ–ª–µ—Ä–¥—ñ —ñ–∑–¥–µ–ø –∂–∞—Ç—ã—Ä–º—ã–∑...<br/>–ë“±–ª –±—ñ—Ä–Ω–µ—à–µ —Å–µ–∫—É–Ω–¥“õ–∞ —Å–æ–∑—ã–ª–∞–¥—ã
    </div>
    <button class="success-btn" onclick="goToDriverList()" data-i18n="viewDrivers">–ñ“Ø—Ä–≥—ñ–∑—É—à—ñ–ª–µ—Ä–¥—ñ –∫”©—Ä—É</button>
  </div>

  <!-- BOTTOM SHEET -->
  <div class="bottom-sheet">
    <div class="sheet-header">
      <div class="sheet-handle"></div>
      <div class="step-progress">
        <div class="step-bar active" id="stepBar1"></div>
        <div class="step-bar" id="stepBar2"></div>
        <div class="step-bar" id="stepBar3"></div>
      </div>
    </div>

    <div class="sheet-content">
      <!-- STEP 1: ADDRESSES -->
      <div class="form-step active" id="step1">
        <div class="address-card" onclick="openPicker('pickup')">
          <div class="location-icon start">A</div>
          <div class="location-text">
            <div class="location-label" data-i18n="from">“ö–ê–ô–î–ê–ù</div>
            <div class="location-value" id="pickupAddr" data-i18n="locating">–û—Ä—ã–Ω–¥—ã –∞–Ω—ã“õ—Ç–∞—É...</div>
          </div>
        </div>

        <div class="address-card" onclick="openPicker('dropoff')">
          <div class="location-icon end">B</div>
          <div class="location-text">
            <div class="location-label" data-i18n="to">“ö–ê–ô–î–ê</div>
            <div class="location-value" id="dropoffAddr" data-i18n="selectDest">–ë–∞—Ä–∞—Ç—ã–Ω –∂–µ—Ä–¥—ñ —Ç–∞“£–¥–∞“£—ã–∑</div>
          </div>
        </div>

        <div class="distance-badge" id="distanceBadge">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
            <path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/>
          </svg>
          <span id="distanceText"></span>
        </div>

        <div class="btn-group">
          <button class="btn btn-primary" id="nextBtn1" onclick="goToStep(2)" disabled data-i18n="next">–ö–µ–ª–µ—Å—ñ</button>
        </div>
      </div>

      <!-- STEP 2: DETAILS -->
      <div class="form-step" id="step2">
        <div class="form-title" data-i18n="deliveryDetails">–ñ–µ—Ç–∫—ñ–∑—É –º”ô–ª—ñ–º–µ—Ç—Ç–µ—Ä—ñ</div>

        <div class="form-field">
          <label class="field-label" data-i18n="priceLabel">üí∞ –ë–∞“ì–∞ (—Ç–µ“£–≥–µ)</label>
          <input type="number" class="field-input" id="price" placeholder="5000" min="2000" oninput="validateStep2()" />
          <div class="error-message" id="priceError">–ú–∏–Ω–∏–º—É–º 2000 —Ç–µ“£–≥–µ</div>
        </div>

        <div class="form-field">
          <label class="field-label" data-i18n="truckLabel">üöö –ö”©–ª—ñ–∫ —Ç“Ø—Ä—ñ</label>
          <div class="truck-grid">
            <div class="truck-card" data-truck="intercity" onclick="selectTruck(event, 'intercity')">
              <div class="truck-icon">üöï</div>
              <div class="truck-name" data-i18n="intercity">“ö–∞–ª–∞ –∞—Ä–∞–ª—ã“õ</div>
              <div class="truck-desc" data-i18n="intercityDesc">—Ç–∞–∫—Å–∏</div>
            </div>
            <div class="truck-card" data-truck="small" onclick="selectTruck(event, 'small')">
              <div class="truck-icon">üöê</div>
              <div class="truck-name" data-i18n="small">–ö—ñ—à—ñ</div>
              <div class="truck-desc" data-i18n="smallDesc">1.5—Ç –¥–µ–π—ñ–Ω</div>
            </div>
            <div class="truck-card" data-truck="medium" onclick="selectTruck(event, 'medium')">
              <div class="truck-icon">üöö</div>
              <div class="truck-name" data-i18n="medium">–û—Ä—Ç–∞—à–∞</div>
              <div class="truck-desc" data-i18n="mediumDesc">5—Ç –¥–µ–π—ñ–Ω</div>
            </div>
            <div class="truck-card" data-truck="large" onclick="selectTruck(event, 'large')">
              <div class="truck-icon">üöõ</div>
              <div class="truck-name" data-i18n="large">“Æ–ª–∫–µ–Ω</div>
              <div class="truck-desc" data-i18n="largeDesc">20—Ç –¥–µ–π—ñ–Ω</div>
            </div>
            <div class="truck-card" data-truck="tow" onclick="selectTruck(event, 'tow')">
              <div class="truck-icon">üöó</div>
              <div class="truck-name" data-i18n="tow">–≠–≤–∞–∫—É–∞—Ç–æ—Ä</div>
              <div class="truck-desc" data-i18n="towDesc">—ç–≤–∞–∫—É–∞—Ü–∏—è</div>
            </div>
            <div class="truck-card" data-truck="any" onclick="selectTruck(event, 'any')">
              <div class="truck-icon">üöô</div>
              <div class="truck-name" data-i18n="any">–ö–µ–∑ –∫–µ–ª–≥–µ–Ω</div>
              <div class="truck-desc" data-i18n="anyDesc">–∂–∞—Ä–∞–π–¥—ã</div>
            </div>
          </div>
          <div class="error-message" id="truckError">–ö”©–ª—ñ–∫ —Ç“Ø—Ä—ñ–Ω —Ç–∞“£–¥–∞“£—ã–∑</div>
        </div>

        <div class="datetime-grid">
          <div class="form-field">
            <label class="field-label" data-i18n="dateLabel">üìÖ –ö“Ø–Ω—ñ</label>
            <input type="date" class="field-input" id="date" oninput="validateStep2()" />
            <div class="error-message" id="dateError">–ö“Ø–Ω–¥—ñ —Ç–∞“£–¥–∞“£—ã–∑</div>
          </div>
          <div class="form-field">
            <label class="field-label" data-i18n="timeLabel">‚è∞ –£–∞“õ—ã—Ç—ã</label>
            <input type="time" class="field-input" id="time" oninput="validateStep2()" />
            <div class="error-message" id="timeError">–£–∞“õ—ã—Ç—Ç—ã —Ç–∞“£–¥–∞“£—ã–∑</div>
          </div>
        </div>

        <div class="btn-group double">
          <button class="btn btn-secondary" onclick="goToStep(1)" data-i18n="back">–ê—Ä—Ç“õ–∞</button>
          <button class="btn btn-primary" id="nextBtn2" onclick="goToStep(3)" disabled data-i18n="next">–ö–µ–ª–µ—Å—ñ</button>
        </div>
      </div>

      <!-- STEP 3: CONTACT -->
      <div class="form-step" id="step3">
        <div class="form-title" data-i18n="contactInfo">–ë–∞–π–ª–∞–Ω—ã—Å –∞“õ–ø–∞—Ä–∞—Ç—ã</div>

        <div class="form-field">
          <label class="field-label" data-i18n="phoneLabel">üì± –¢–µ–ª–µ—Ñ–æ–Ω</label>
          <input type="tel" class="field-input" id="phone" placeholder="+7 (___) ___-__-__" 
            oninput="formatPhone(this); validateStep3()" />
          <div class="error-message" id="phoneError">–¢–æ–ª—ã“õ —Ç–µ–ª–µ—Ñ–æ–Ω –Ω”©–º—ñ—Ä—ñ–Ω –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑</div>
        </div>

        <div class="form-field">
          <label class="field-label" data-i18n="commentLabel">üí¨ –¢“Ø—Å—ñ–Ω—ñ–∫—Ç–µ–º–µ</label>
          <textarea class="field-input" id="comment" placeholder="“ö–æ—Å—ã–º—à–∞ –∞“õ–ø–∞—Ä–∞—Ç..." oninput="validateStep3()"></textarea>
          <div class="error-message" id="commentError">–¢“Ø—Å—ñ–Ω—ñ–∫—Ç–µ–º–µ–Ω—ñ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑</div>
        </div>

        <div class="btn-group double">
          <button class="btn btn-secondary" onclick="goToStep(2)" data-i18n="back">–ê—Ä—Ç“õ–∞</button>
          <button class="btn btn-primary" id="submitBtn" onclick="submitOrder()" disabled data-i18n="submit">–ñ—ñ–±–µ—Ä—É</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PICKER MODAL -->
  <div class="picker-modal" id="pickerModal">
    <div id="pickerMap"></div>
    <div class="picker-header">
      <button class="back-btn" onclick="closePicker()">‚Üê</button>
      <input type="text" class="search-box" id="searchBox" placeholder="–ú–µ–∫–µ–Ω–∂–∞–π —ñ–∑–¥–µ—É..."
        oninput="searchAddress(this.value)"
        onfocus="onSearchFocus()"
        onblur="hideSuggestionsDelayed()" />
    </div>
    <div class="picker-instructions" id="pickerInstructions">üìç –ö–∞—Ä—Ç–∞–Ω—ã –±–∞—Å—ã“£—ã–∑</div>
    <div class="suggestions" id="suggestions"></div>
    <button class="btn btn-primary confirm-btn" onclick="confirmPicker()">
      <span data-i18n="choose">–û—Å—ã –Ω“Ø–∫—Ç–µ–Ω—ñ —Ç–∞“£–¥–∞—É</span>
    </button>
  </div>

  <script>
    const Y_KEY = '8a3e4da0-9ef2-4176-9203-e7014c1dba6f';
    const urlParams = new URLSearchParams(window.location.search);
    let currentLang = urlParams.get('lang') || localStorage.getItem('lang') || 'kz';
    localStorage.setItem('lang', currentLang);
    const YA_LANG = () => (currentLang === 'kz' ? 'kk_KZ' : 'ru_RU');

    const i18n = {
      kz: {
        from: '“ö–ê–ô–î–ê–ù', to: '“ö–ê–ô–î–ê', locating: '–û—Ä—ã–Ω–¥—ã –∞–Ω—ã“õ—Ç–∞—É...', selectDest: '–ë–∞—Ä–∞—Ç—ã–Ω –∂–µ—Ä–¥—ñ —Ç–∞“£–¥–∞“£—ã–∑',
        next: '–ö–µ–ª–µ—Å—ñ', back: '–ê—Ä—Ç“õ–∞', submit: '–ñ—ñ–±–µ—Ä—É', choose: '–û—Å—ã –Ω“Ø–∫—Ç–µ–Ω—ñ —Ç–∞“£–¥–∞—É',
        deliveryDetails: '–ñ–µ—Ç–∫—ñ–∑—É –º”ô–ª—ñ–º–µ—Ç—Ç–µ—Ä—ñ', contactInfo: '–ë–∞–π–ª–∞–Ω—ã—Å –∞“õ–ø–∞—Ä–∞—Ç—ã',
        priceLabel: 'üí∞ –ë–∞“ì–∞ (—Ç–µ“£–≥–µ)', truckLabel: 'üöö –ö”©–ª—ñ–∫ —Ç“Ø—Ä—ñ', dateLabel: 'üìÖ –ö“Ø–Ω—ñ', timeLabel: '‚è∞ –£–∞“õ—ã—Ç—ã',
        phoneLabel: 'üì± –¢–µ–ª–µ—Ñ–æ–Ω', commentLabel: 'üí¨ –¢“Ø—Å—ñ–Ω—ñ–∫—Ç–µ–º–µ',
        intercity: '“ö–∞–ª–∞ –∞—Ä–∞–ª—ã“õ', intercityDesc: '—Ç–∞–∫—Å–∏', small: '–ö—ñ—à—ñ', smallDesc: '1.5—Ç –¥–µ–π—ñ–Ω',
        medium: '–û—Ä—Ç–∞—à–∞', mediumDesc: '5—Ç –¥–µ–π—ñ–Ω', large: '“Æ–ª–∫–µ–Ω', largeDesc: '20—Ç –¥–µ–π—ñ–Ω',
        tow: '–≠–≤–∞–∫—É–∞—Ç–æ—Ä', towDesc: '—ç–≤–∞–∫—É–∞—Ü–∏—è', any: '–ö–µ–∑ –∫–µ–ª–≥–µ–Ω', anyDesc: '–∂–∞—Ä–∞–π–¥—ã',
        successTitle: '–¢–∞–ø—Å—ã—Ä—ã—Å –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ!', successMsg: '“ö–æ–ª –∂–µ—Ç—ñ–º–¥—ñ –∂“Ø—Ä–≥—ñ–∑—É—à—ñ–ª–µ—Ä–¥—ñ —ñ–∑–¥–µ–ø –∂–∞—Ç—ã—Ä–º—ã–∑...\n–ë“±–ª –±—ñ—Ä–Ω–µ—à–µ —Å–µ–∫—É–Ω–¥“õ–∞ —Å–æ–∑—ã–ª–∞–¥—ã',
        viewDrivers: '–ñ“Ø—Ä–≥—ñ–∑—É—à—ñ–ª–µ—Ä–¥—ñ –∫”©—Ä—É', clickMap: 'üìç –ö–∞—Ä—Ç–∞–Ω—ã –±–∞—Å—ã“£—ã–∑', pinSelected: '‚úÖ –ù“Ø–∫—Ç–µ —Ç–∞“£–¥–∞–ª–¥—ã'
      },
      ru: {
        from: '–û–¢–ö–£–î–ê', to: '–ö–£–î–ê', locating: '–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è...', selectDest: '–í—ã–±–µ—Ä–∏—Ç–µ –∞–¥—Ä–µ—Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è',
        next: '–î–∞–ª–µ–µ', back: '–ù–∞–∑–∞–¥', submit: '–û—Ç–ø—Ä–∞–≤–∏—Ç—å', choose: '–í—ã–±—Ä–∞—Ç—å —ç—Ç—É —Ç–æ—á–∫—É',
        deliveryDetails: '–î–µ—Ç–∞–ª–∏ –¥–æ—Å—Ç–∞–≤–∫–∏', contactInfo: '–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è',
        priceLabel: 'üí∞ –¶–µ–Ω–∞ (—Ç–µ–Ω–≥–µ)', truckLabel: 'üöö –¢–∏–ø —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞', dateLabel: 'üìÖ –î–∞—Ç–∞', timeLabel: '‚è∞ –í—Ä–µ–º—è',
        phoneLabel: 'üì± –¢–µ–ª–µ—Ñ–æ–Ω', commentLabel: 'üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π',
        intercity: '–ú–µ–∂–≥–æ—Ä–æ–¥', intercityDesc: '—Ç–∞–∫—Å–∏', small: '–ú–∞–ª—ã–π', smallDesc: '–¥–æ 1.5—Ç',
        medium: '–°—Ä–µ–¥–Ω–∏–π', mediumDesc: '–¥–æ 5—Ç', large: '–ë–æ–ª—å—à–æ–π', largeDesc: '–¥–æ 20—Ç',
        tow: '–≠–≤–∞–∫—É–∞—Ç–æ—Ä', towDesc: '—ç–≤–∞–∫—É–∞—Ü–∏—è', any: '–õ—é–±–æ–π', anyDesc: '–ø–æ–¥–æ–π–¥–µ—Ç',
        successTitle: '–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!', successMsg: '–ò—â–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π...\n–≠—Ç–æ –∑–∞–π–º–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥',
        viewDrivers: '–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤–æ–¥–∏—Ç–µ–ª–µ–π', clickMap: 'üìç –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É', pinSelected: '‚úÖ –¢–æ—á–∫–∞ –≤—ã–±—Ä–∞–Ω–∞'
      }
    };

    let state = {
      userLoc: null, pickup: null, dropoff: null, pickingFor: null, currentStep: 1,
      selectedTruck: null, orderData: null, isSearching: false, manuallyPlacedPin: null
    };

    let map, pickerMap, userMarker, pickupMarker, dropoffMarker, placedPinMarker;
    let geolocationWatchId = null, mapUpdateInterval = null, pickerMapLoaded = false;
    let currentUserLocation = null, suggestionsTimeout = null, lastUserPosition = null;

    function updateViewportHeight() {
      const vh = window.Telegram?.WebApp?.viewportStableHeight || window.innerHeight;
      const safeTop = window.Telegram?.WebApp?.safeAreaInset?.top || 0;
      const safeBottom = window.Telegram?.WebApp?.safeAreaInset?.bottom || 0;
      document.documentElement.style.setProperty('--tg-viewport-height', `${vh}px`);
      document.documentElement.style.setProperty('--tg-safe-top', `${safeTop}px`);
      document.documentElement.style.setProperty('--tg-safe-bottom', `${safeBottom}px`);
    }

    function createDivMarker(html, className, size = [20, 20]) {
      const el = document.createElement('div');
      el.className = className;
      el.style.width = size[0] + 'px';
      el.style.height = size[1] + 'px';
      if (html) el.innerHTML = html;
      return el;
    }

    async function initMap() {
      await ymaps3.ready;
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            currentUserLocation = [pos.coords.latitude, pos.coords.longitude];
            state.userLoc = { lat: pos.coords.latitude, lng: pos.coords.longitude, accuracy: pos.coords.accuracy };
            initMapWithPosition(currentUserLocation);
            setUserLocationAsPickup();
            startRealtimeTracking();
          },
          () => initMapWithPosition([43.238949, 76.889709]),
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
      } else {
        initMapWithPosition([43.238949, 76.889709]);
      }
    }

    async function setUserLocationAsPickup() {
      if (!currentUserLocation) return;
      const addr = await reverseGeocode(currentUserLocation[0], currentUserLocation[1]);
      state.pickup = { lat: currentUserLocation[0], lng: currentUserLocation[1], address: addr };
      document.getElementById('pickupAddr').textContent = addr;
      document.querySelectorAll('.address-card')[0].classList.add('filled');
      await addMarker('pickup', currentUserLocation[0], currentUserLocation[1]);
      validateStep1();
    }

    // FIXED: Realtime tracking with relaxed accuracy and proper interval
    function startRealtimeTracking() {
      if (!navigator.geolocation) return;
      
      geolocationWatchId = navigator.geolocation.watchPosition(
        (pos) => {
          const coords = [pos.coords.latitude, pos.coords.longitude];
          // FIXED: Relaxed accuracy filter (was 100/50, now 200)
          if (pos.coords.accuracy <= 200) {
            currentUserLocation = coords;
            state.userLoc = { lat: coords[0], lng: coords[1], accuracy: pos.coords.accuracy };
            updateUserMarker(coords[0], coords[1]);
          }
        },
        null,
        { enableHighAccuracy: true, timeout: 3000, maximumAge: 0 }
      );

      // FIXED: Set to 1000ms (1 second) as specified
      mapUpdateInterval = setInterval(() => {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const coords = [pos.coords.latitude, pos.coords.longitude];
            if (pos.coords.accuracy <= 200) {
              currentUserLocation = coords;
              state.userLoc = { lat: coords[0], lng: coords[1], accuracy: pos.coords.accuracy };
              updateUserMarker(coords[0], coords[1]);
            }
          },
          null,
          { enableHighAccuracy: true, timeout: 2000, maximumAge: 0 }
        );
      }, 1000);
    }

    async function initMapWithPosition(center) {
      await ymaps3.ready;
      const { YMap, YMapDefaultSchemeLayer, YMapDefaultFeaturesLayer } = ymaps3;
      map = new YMap(document.getElementById('map'), {
        location: { center: [center[1], center[0]], zoom: 15 }
      });
      map.addChild(new YMapDefaultSchemeLayer({}));
      map.addChild(new YMapDefaultFeaturesLayer({}));
      
      // REMOVED: Broken controls code that caused crashes
      
      await addUserLocationMarker(center);
    }

    async function addUserLocationMarker(coords) {
      if (!map) return;
      await ymaps3.ready;
      const { YMapMarker } = ymaps3;
      const el = createDivMarker('', 'user-marker', [16, 16]);
      userMarker = new YMapMarker({ coordinates: [coords[1], coords[0]], draggable: false }, el);
      map.addChild(userMarker);
    }

    // FIXED: Create marker if it doesn't exist
    async function updateUserMarker(lat, lng) {
      if (lastUserPosition && Math.abs(lastUserPosition[0] - lat) < 0.00001 && Math.abs(lastUserPosition[1] - lng) < 0.00001) return;
      lastUserPosition = [lat, lng];
      
      // FIXED: Create marker if it doesn't exist yet
      if (!userMarker && map) {
        await addUserLocationMarker([lat, lng]);
        return;
      }
      if (!userMarker || !map) return;
      userMarker.update({ coordinates: [lng, lat] });
    }

    // CENTER ON USER LOCATION
    function centerOnUserLocation() {
      if (!currentUserLocation || !map) return;
      map.update({
        location: { center: [currentUserLocation[1], currentUserLocation[0]], zoom: 16 },
        duration: 800
      });
    }

    async function addMarker(type, lat, lng) {
      if (!map) return;
      await ymaps3.ready;
      const { YMapMarker } = ymaps3;
      const el = createDivMarker(type === 'pickup' ? 'A' : 'B', `custom-marker ${type}`, [40, 40]);
      const marker = new YMapMarker({ coordinates: [lng, lat], draggable: true }, el);
      if (type === 'pickup') {
        if (pickupMarker) try { map.removeChild(pickupMarker); } catch (e) {}
        pickupMarker = marker;
      } else {
        if (dropoffMarker) try { map.removeChild(dropoffMarker); } catch (e) {}
        dropoffMarker = marker;
      }
      map.addChild(marker);
      
      // AUTO ZOOM TO FIT BOTH POINTS
      if (pickupMarker && dropoffMarker) {
        setTimeout(() => autoZoomToBothPoints(), 300);
      }
    }

    // FIXED: Better auto zoom calculation to show both A and B
    function autoZoomToBothPoints() {
      if (!map || !state.pickup || !state.dropoff) return;
      
      const padding = 0.02; // More padding for better view
      const minLng = Math.min(state.pickup.lng, state.dropoff.lng) - padding;
      const maxLng = Math.max(state.pickup.lng, state.dropoff.lng) + padding;
      const minLat = Math.min(state.pickup.lat, state.dropoff.lat) - padding;
      const maxLat = Math.max(state.pickup.lat, state.dropoff.lat) + padding;
      
      const bounds = [
        [minLng, minLat],
        [maxLng, maxLat]
      ];
      
      map.update({ 
        location: { bounds }, 
        duration: 1000 
      });
      showDistance();
    }

    function showDistance() {
      if (!state.pickup || !state.dropoff) return;
      const dist = calculateDistance(state.pickup.lat, state.pickup.lng, state.dropoff.lat, state.dropoff.lng);
      document.getElementById('distanceText').textContent = `${dist.toFixed(1)} –∫–º`;
      document.getElementById('distanceBadge').classList.add('active');
    }

    function calculateDistance(lat1, lng1, lat2, lng2) {
      const R = 6371, dLat = (lat2 - lat1) * Math.PI / 180, dLng = (lng2 - lng1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLng/2) * Math.sin(dLng/2);
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    async function reverseGeocode(lat, lng) {
      try {
        const res = await fetch(`https://geocode-maps.yandex.ru/1.x/?apikey=${Y_KEY}&geocode=${lng},${lat}&format=json&lang=${YA_LANG()}&results=1`);
        const data = await res.json();
        const feature = data.response?.GeoObjectCollection?.featureMember?.[0]?.GeoObject;
        return feature?.metaDataProperty?.GeocoderMetaData?.Address?.formatted || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      } catch { return `${lat.toFixed(6)}, ${lng.toFixed(6)}`; }
    }

    async function searchAddress(query) {
      if (query.length < 3) {
        document.getElementById('suggestions').classList.remove('active');
        return;
      }
      try {
        const res = await fetch(`https://geocode-maps.yandex.ru/1.x/?apikey=${Y_KEY}&geocode=${encodeURIComponent(query)}&format=json&lang=${YA_LANG()}&results=10&ll=76.889709,43.238949&spn=5,5`);
        const data = await res.json();
        const items = data.response?.GeoObjectCollection?.featureMember || [];
        const html = items.map(({ GeoObject }) => {
          const [lng, lat] = GeoObject.Point.pos.split(' ').map(Number);
          const text = GeoObject.metaDataProperty.GeocoderMetaData?.Address?.formatted || `${lat}, ${lng}`;
          return `<div class="suggestion-item" onmousedown="selectSuggestion(${lat}, ${lng})">${text}</div>`;
        }).join('');
        document.getElementById('suggestions').innerHTML = html;
        document.getElementById('suggestions').classList.add('active');
      } catch {}
    }

    function selectSuggestion(lat, lng) {
      if (pickerMap && pickerMapLoaded) {
        pickerMap.update({ location: { center: [lng, lat], zoom: 17 } });
        setTimeout(() => placePinAtCoordinates([lng, lat]), 500);
      }
      document.getElementById('suggestions').classList.remove('active');
      document.getElementById('searchBox').value = '';
      state.isSearching = false;
      updatePickerInstructions();
    }

    function hideSuggestionsDelayed() {
      clearTimeout(suggestionsTimeout);
      suggestionsTimeout = setTimeout(() => {
        document.getElementById('suggestions').classList.remove('active');
        state.isSearching = false;
        updatePickerInstructions();
      }, 200);
    }

    async function openPicker(type) {
      state.pickingFor = type;
      state.isSearching = false;
      document.getElementById('pickerModal').classList.add('active');
      let center = type === 'pickup' && state.pickup ? [state.pickup.lng, state.pickup.lat] :
                   type === 'dropoff' && state.dropoff ? [state.dropoff.lng, state.dropoff.lat] :
                   currentUserLocation ? [currentUserLocation[1], currentUserLocation[0]] : [76.889709, 43.238949];
      await new Promise(resolve => setTimeout(resolve, 100));
      await buildPickerMap(center);
    }

    function closePicker() {
      document.getElementById('pickerModal').classList.remove('active');
      document.getElementById('suggestions').classList.remove('active');
      document.getElementById('searchBox').value = '';
      if (pickerMap) try { pickerMap.destroy(); } catch {}
      pickerMap = null;
      pickerMapLoaded = false;
      placedPinMarker = null;
      state.manuallyPlacedPin = null;
      state.pickingFor = null;
      state.isSearching = false;
    }

    async function buildPickerMap(center) {
      await ymaps3.ready;
      pickerMapLoaded = false;
      const { YMap, YMapDefaultSchemeLayer, YMapDefaultFeaturesLayer, YMapListener } = ymaps3;
      const el = document.getElementById('pickerMap');
      if (!el) return;
      if (pickerMap) try { pickerMap.destroy(); } catch {}
      pickerMap = null;
      el.innerHTML = '';
      await new Promise(resolve => requestAnimationFrame(resolve));
      try {
        pickerMap = new YMap(el, { location: { center, zoom: 16 } });
        pickerMap.addChild(new YMapDefaultSchemeLayer({}));
        pickerMap.addChild(new YMapDefaultFeaturesLayer({}));
        
        // REMOVED: Broken controls code
        
        const clickListener = new YMapListener({
          layer: 'any',
          onClick: (object, event) => { if (event.coordinates) placePinAtCoordinates(event.coordinates); }
        });
        pickerMap.addChild(clickListener);
        
        // FIXED: Set pickerMapLoaded AFTER everything is added successfully
        pickerMapLoaded = true;
        
        if (placedPinMarker) try { pickerMap.removeChild(placedPinMarker); } catch {}
        placedPinMarker = null;
        updatePickerInstructions();
      } catch (e) {
        console.error('Picker map creation failed:', e);
      }
    }

    async function placePinAtCoordinates(coordinates) {
      if (!pickerMap || !pickerMapLoaded) return;
      await ymaps3.ready;
      const { YMapMarker } = ymaps3;
      try {
        if (placedPinMarker) try { pickerMap.removeChild(placedPinMarker); } catch {}
        const pinEl = createDivMarker('', 'placed-pin', [24, 24]);
        placedPinMarker = new YMapMarker({ coordinates, draggable: true }, pinEl);
        pickerMap.addChild(placedPinMarker);
        state.manuallyPlacedPin = { lat: coordinates[1], lng: coordinates[0] };
        document.getElementById('pickerInstructions').textContent = i18n[currentLang].pinSelected;
        document.getElementById('pickerInstructions').classList.remove('hidden');
      } catch {}
    }

    function updatePickerInstructions() {
      const inst = document.getElementById('pickerInstructions');
      if (inst && !state.isSearching) {
        inst.textContent = i18n[currentLang].clickMap;
        inst.classList.remove('hidden');
      }
    }

    function onSearchFocus() {
      state.isSearching = true;
      document.getElementById('pickerInstructions').classList.add('hidden');
    }

    // FIXED: Better fallback for confirmPicker
    async function confirmPicker() {
      if (!state.pickingFor) return;
      
      // FIXED: Fallback to center if no pin placed
      if (!state.manuallyPlacedPin) {
        if (pickerMap && pickerMapLoaded) {
          const center = pickerMap.location.center;
          state.manuallyPlacedPin = { lat: center[1], lng: center[0] };
        } else if (currentUserLocation) {
          state.manuallyPlacedPin = { lat: currentUserLocation[0], lng: currentUserLocation[1] };
        } else {
          alert(i18n[currentLang].pinSelected);
          return;
        }
      }
      
      try {
        const { lat, lng } = state.manuallyPlacedPin;
        const addr = await reverseGeocode(lat, lng);
        if (state.pickingFor === 'pickup') {
          state.pickup = { lat, lng, address: addr };
          document.getElementById('pickupAddr').textContent = addr;
          document.querySelectorAll('.address-card')[0].classList.add('filled');
          await addMarker('pickup', lat, lng);
        } else {
          state.dropoff = { lat, lng, address: addr };
          document.getElementById('dropoffAddr').textContent = addr;
          document.querySelectorAll('.address-card')[1].classList.add('filled');
          await addMarker('dropoff', lat, lng);
        }
        closePicker();
        validateStep1();
      } catch (e) {
        console.error('Confirm picker failed:', e);
      }
    }

    function goToStep(step) {
      document.querySelectorAll('.form-step').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.step-bar').forEach(s => s.classList.remove('active'));
      document.getElementById(`step${step}`).classList.add('active');
      for (let i = 1; i <= step; i++) {
        document.getElementById(`stepBar${i}`).classList.add('active');
      }
      state.currentStep = step;
      if (step === 1) validateStep1();
      else if (step === 2) validateStep2();
      else validateStep3();
    }

    function validateStep1() {
      const valid = state.pickup && state.dropoff;
      document.getElementById('nextBtn1').disabled = !valid;
    }

    function validateStep2() {
      const price = Number(document.getElementById('price').value);
      const date = document.getElementById('date').value;
      const time = document.getElementById('time').value;
      
      const priceValid = price >= 2000;
      const dateValid = !!date;
      const timeValid = !!time;
      const truckValid = !!state.selectedTruck;

      document.getElementById('priceError').classList.toggle('show', !priceValid && price > 0);
      document.getElementById('dateError').classList.toggle('show', !dateValid);
      document.getElementById('timeError').classList.toggle('show', !timeValid);
      document.getElementById('truckError').classList.toggle('show', !truckValid);

      document.getElementById('price').classList.toggle('error', !priceValid && price > 0);
      document.getElementById('date').classList.toggle('error', !dateValid);
      document.getElementById('time').classList.toggle('error', !timeValid);

      const valid = priceValid && dateValid && timeValid && truckValid;
      document.getElementById('nextBtn2').disabled = !valid;
    }

    function validateStep3() {
      const phone = document.getElementById('phone').value;
      const comment = document.getElementById('comment').value;
      
      const phoneValid = phone.length >= 18;
      const commentValid = comment.trim().length >= 5;

      document.getElementById('phoneError').classList.toggle('show', !phoneValid && phone.length > 0);
      document.getElementById('commentError').classList.toggle('show', !commentValid && comment.length > 0);

      document.getElementById('phone').classList.toggle('error', !phoneValid && phone.length > 0);
      document.getElementById('comment').classList.toggle('error', !commentValid && comment.length > 0);

      const valid = phoneValid && commentValid;
      document.getElementById('submitBtn').disabled = !valid;
    }

    // FIXED: Accept event parameter properly
    function selectTruck(evt, type) {
      evt.preventDefault();
      document.querySelectorAll('.truck-card').forEach(c => c.classList.remove('selected'));
      document.querySelector(`[data-truck="${type}"]`).classList.add('selected');
      state.selectedTruck = type;
      validateStep2();
    }

    function formatPhone(input) {
      let val = input.value.replace(/\D/g, '');
      if (!val) return;
      if (val[0] !== '7') val = '7' + val;
      let fmt = '+7';
      if (val.length > 1) fmt += ` (${val.slice(1, 4)}`;
      if (val.length >= 4) fmt += ')';
      if (val.length > 4) fmt += ` ${val.slice(4, 7)}`;
      if (val.length > 7) fmt += `-${val.slice(7, 9)}`;
      if (val.length > 9) fmt += `-${val.slice(9, 11)}`;
      input.value = fmt;
    }

    async function submitOrder() {
      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.textContent = '...';
      try {
        const formData = new FormData();
        formData.append('from_address', state.pickup.address);
        formData.append('from_lat', state.pickup.lat);
        formData.append('from_lon', state.pickup.lng);
        formData.append('to_address', state.dropoff.address);
        formData.append('to_lat', state.dropoff.lat);
        formData.append('to_lon', state.dropoff.lng);
        formData.append('price', document.getElementById('price').value);
        formData.append('truck_type', state.selectedTruck);
        formData.append('date', document.getElementById('date').value);
        formData.append('time', document.getElementById('time').value);
        formData.append('contact', document.getElementById('phone').value);
        formData.append('comment', document.getElementById('comment').value);
        const tg = window.Telegram?.WebApp;
        if (tg?.initDataUnsafe?.user) {
          formData.append('telegram_id', tg.initDataUnsafe.user.id);
          formData.append('telegram_username', tg.initDataUnsafe.user.username || '');
          formData.append('telegram_first_name', tg.initDataUnsafe.user.first_name || '');
          formData.append('telegram_last_name', tg.initDataUnsafe.user.last_name || '');
        }
        formData.append('distance', calculateDistance(state.pickup.lat, state.pickup.lng, state.dropoff.lat, state.dropoff.lng));
        const res = await fetch('/api/delivery-request', { method: 'POST', body: formData });
        const json = await res.json().catch(() => ({ success: false }));
        if (json?.success) {
          state.orderData = {
            pickup: state.pickup, dropoff: state.dropoff,
            price: document.getElementById('price').value,
            truck_type: state.selectedTruck,
            contact: document.getElementById('phone').value,
            comment: document.getElementById('comment').value,
            request_id: json.data?.request_id
          };
          showSuccess();
          stopTracking();
        } else throw new Error(json?.message || 'Failed');
      } catch (e) {
        alert(`Error: ${e.message}`);
      } finally {
        btn.disabled = false;
        btn.textContent = i18n[currentLang].submit;
      }
    }

    function showSuccess() {
      document.getElementById('successScreen').classList.add('active');
      setTimeout(() => goToDriverList(), 3000);
    }

    function goToDriverList() {
      const data = encodeURIComponent(JSON.stringify(state.orderData));
      window.location.href = `/driver-list?order=${data}&lang=${currentLang}`;
    }

    function stopTracking() {
      if (geolocationWatchId) navigator.geolocation.clearWatch(geolocationWatchId);
      if (mapUpdateInterval) clearInterval(mapUpdateInterval);
    }

    function applyTranslations() {
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.dataset.i18n;
        if (i18n[currentLang][key]) el.textContent = i18n[currentLang][key];
      });
    }

    document.addEventListener('DOMContentLoaded', async () => {
      updateViewportHeight();
      applyTranslations();
      if (!window.ymaps3) return;
      await initMap();
      const now = new Date();
      document.getElementById('date').valueAsDate = now;
      document.getElementById('time').value = now.toTimeString().slice(0, 5);
      if (window.Telegram?.WebApp) {
        const tg = Telegram.WebApp;
        tg.ready();
        tg.expand();
        tg.disableVerticalSwipes();
        tg.setHeaderColor('#000000');
        tg.onEvent('viewportChanged', updateViewportHeight);
      }
    });

    window.addEventListener('resize', updateViewportHeight);
    window.addEventListener('beforeunload', stopTracking);

    window.openPicker = openPicker;
    window.closePicker = closePicker;
    window.confirmPicker = confirmPicker;
    window.searchAddress = searchAddress;
    window.selectSuggestion = selectSuggestion;
    window.goToStep = goToStep;
    window.selectTruck = selectTruck;
    window.formatPhone = formatPhone;
    window.submitOrder = submitOrder;
    window.goToDriverList = goToDriverList;
    window.hideSuggestionsDelayed = hideSuggestionsDelayed;
    window.updatePickerInstructions = updatePickerInstructions;
    window.onSearchFocus = onSearchFocus;
    window.centerOnUserLocation = centerOnUserLocation;
  </script>
</body>
</html>