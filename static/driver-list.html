<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Доступные водители</title>
  
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #fff;
      overflow-x: hidden;
    }

    /* Header */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 1000;
      padding: env(safe-area-inset-top, 12px) 16px 12px;
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .back-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 12px;
      padding: 12px;
      cursor: pointer;
      color: white;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .back-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    .header-title {
      font-size: 18px;
      font-weight: 700;
      text-align: center;
      flex: 1;
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Language Switch */
    .lang-switch {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      padding: 2px;
      display: flex;
    }

    .lang-btn {
      padding: 6px 12px;
      border: none;
      background: transparent;
      color: white;
      border-radius: 18px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .lang-btn.active {
      background: rgba(255, 255, 255, 0.8);
      color: #333;
    }

    .refresh-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 12px;
      padding: 12px;
      cursor: pointer;
      color: white;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .refresh-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: rotate(180deg);
    }

    /* Main Content */
    .main-content {
      padding-top: 80px;
      padding-bottom: 20px;
    }

    /* Order Summary */
    .order-summary {
      margin: 16px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .order-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
      color: rgba(255, 255, 255, 0.9);
    }

    .route-display {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .route-point {
      flex: 1;
    }

    .route-label {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 4px;
    }

    .route-address {
      font-size: 14px;
      font-weight: 500;
      line-height: 1.3;
    }

    .route-arrow {
      font-size: 20px;
      color: rgba(255, 255, 255, 0.8);
    }

    .order-details {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-top: 16px;
    }

    .detail-item {
      text-align: center;
    }

    .detail-value {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .detail-label {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.7);
    }

    /* Drivers Section */
    .drivers-section {
      margin: 16px;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 700;
    }

    .drivers-count {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 6px 12px;
      font-size: 14px;
      font-weight: 600;
    }

    /* Driver Cards */
    .driver-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      margin-bottom: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      color: #333;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .driver-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
    }

    .driver-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #10b981, #059669);
    }

    .driver-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .driver-photo {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #10b981;
      background: #f3f4f6;
    }

    .driver-info {
      flex: 1;
    }

    .driver-name {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 2px;
      color: #111827;
    }

    .driver-rating {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 14px;
      color: #6b7280;
    }

    .stars {
      color: #fbbf24;
    }

    .driver-price {
      text-align: right;
    }

    .price-amount {
      font-size: 20px;
      font-weight: 800;
      color: #10b981;
    }

    .price-currency {
      font-size: 14px;
      color: #6b7280;
    }

    .driver-details {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 12px;
    }

    .detail-chip {
      background: #f3f4f6;
      border-radius: 8px;
      padding: 6px 8px;
      text-align: center;
      font-size: 11px;
      color: #6b7280;
    }

    .driver-route {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 12px;
      margin-top: 12px;
    }

    .route-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
      color: #6b7280;
    }

    .route-cities {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #374151;
      margin-bottom: 4px;
    }

    .city-name {
      font-weight: 600;
      color: #10b981;
    }

    .route-addresses {
      font-size: 11px;
      color: #6b7280;
      line-height: 1.3;
    }

    .distance-badge {
      background: #e5f7f0;
      color: #047857;
      border-radius: 20px;
      padding: 4px 8px;
      font-size: 11px;
      font-weight: 600;
    }

    /* Loading State */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 50vh;
      padding: 40px 20px;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 16px;
      color: rgba(255, 255, 255, 0.9);
      text-align: center;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }

    .empty-icon {
      font-size: 60px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .empty-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 12px;
      color: rgba(255, 255, 255, 0.9);
    }

    .empty-message {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
      line-height: 1.5;
    }

    /* Driver Detail Modal */
    .driver-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      display: none;
      align-items: flex-end;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .driver-modal.active {
      display: flex;
      animation: modalSlideUp 0.4s ease-out;
    }

    @keyframes modalSlideUp {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: white;
      width: 100%;
      max-height: 90vh;
      border-radius: 20px 20px 0 0;
      overflow-y: auto;
      animation: contentSlideUp 0.4s ease-out;
    }

    @keyframes contentSlideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }

    .modal-header {
      position: sticky;
      top: 0;
      background: white;
      padding: 16px 20px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 10;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: #111827;
    }

    .close-btn {
      background: #f3f4f6;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: #6b7280;
      transition: all 0.3s ease;
    }

    .close-btn:hover {
      background: #e5e7eb;
      transform: scale(1.1);
    }

    .modal-body {
      padding: 20px;
      color: #333;
    }

    .driver-profile {
      text-align: center;
      margin-bottom: 24px;
    }

    .profile-photo {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      margin: 0 auto 16px;
      border: 4px solid #10b981;
      background: #f3f4f6;
    }

    .profile-name {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
      color: #111827;
    }

    .profile-rating {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 16px;
      color: #6b7280;
    }

    .profile-stars {
      color: #fbbf24;
      font-size: 18px;
    }

    .trip-details {
      background: #f8f9fa;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .detail-section {
      margin-bottom: 16px;
    }

    .detail-title {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    .detail-content {
      font-size: 16px;
      font-weight: 500;
      color: #111827;
    }

    .contact-section {
      margin-top: 24px;
    }

    .contact-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 16px;
    }

    .contact-btn {
      background: #10b981;
      color: white;
      border: none;
      border-radius: 12px;
      padding: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .contact-btn.whatsapp {
      background: #25D366;
    }

    .contact-btn.telegram {
      background: #0088cc;
    }

    .contact-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    /* Match Indicator */
    .match-indicator {
      position: absolute;
      top: 16px;
      right: 16px;
      background: #10b981;
      color: white;
      border-radius: 20px;
      padding: 4px 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .match-indicator.perfect-match {
      background: #059669;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* Animation Classes */
    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .slide-in {
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from { transform: translateX(-20px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* Responsive Design */
    @media (max-width: 480px) {
      .order-details {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .driver-details {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .contact-buttons {
        grid-template-columns: 1fr;
      }
      
      .header-controls {
        gap: 4px;
      }
      
      .lang-btn {
        padding: 4px 8px;
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <button class="back-btn" onclick="goBack()">←</button>
      <div class="header-title" data-text="available_drivers">Доступные водители</div>
      <div class="header-controls">
        <div class="lang-switch">
          <button class="lang-btn active" onclick="setLanguage('ru')" id="lang-ru">RU</button>
          <button class="lang-btn" onclick="setLanguage('kz')" id="lang-kz">KZ</button>
        </div>
        <button class="refresh-btn" onclick="refreshDrivers()" title="Обновить">🔄</button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Order Summary -->
    <div class="order-summary fade-in">
      <div class="order-title" data-text="your_order">Ваш заказ</div>
      <div class="route-display">
        <div class="route-point">
          <div class="route-label" data-text="from_point_a">Откуда (A)</div>
          <div class="route-address" id="fromAddress" data-text="loading">Загрузка...</div>
        </div>
        <div class="route-arrow">→</div>
        <div class="route-point">
          <div class="route-label" data-text="to_point_b">Куда (B)</div>
          <div class="route-address" id="toAddress" data-text="loading">Загрузка...</div>
        </div>
      </div>
      <div class="order-details">
        <div class="detail-item">
          <div class="detail-value" id="orderPrice">0 ₸</div>
          <div class="detail-label" data-text="your_price">Ваша цена</div>
        </div>
        <div class="detail-item">
          <div class="detail-value" id="truckType">-</div>
          <div class="detail-label" data-text="transport_type">Тип транспорта</div>
        </div>
      </div>
    </div>

    <!-- Drivers Section -->
    <div class="drivers-section">
      <div class="section-header">
        <div class="section-title" data-text="drivers_near_point_a">Водители рядом с точкой A</div>
        <div class="drivers-count" id="driversCount">0</div>
      </div>
      
      <!-- Loading State -->
      <div class="loading-container" id="loadingState">
        <div class="loading-spinner"></div>
        <div class="loading-text" data-text="searching_drivers">Ищем водителей, которые начинают маршрут рядом с вашей точкой отправления...</div>
      </div>

      <!-- Drivers List -->
      <div id="driversList" style="display: none;"></div>

      <!-- Empty State -->
      <div class="empty-state" id="emptyState" style="display: none;">
        <div class="empty-icon">🚚</div>
        <div class="empty-title" data-text="no_drivers_found">Водители не найдены</div>
        <div class="empty-message" data-text="no_drivers_message">
          В данный момент нет водителей, которые начинают поездку рядом с вашей точкой отправления.<br>
          Попробуйте обновить через несколько минут.
        </div>
      </div>
    </div>
  </div>

  <!-- Driver Detail Modal -->
  <div class="driver-modal" id="driverModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" data-text="driver_info">Информация о водителе</div>
        <button class="close-btn" onclick="closeDriverModal()">✕</button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Content will be loaded here -->
      </div>
    </div>
  </div>

  <script>
    // Translations
    const translations = {
      ru: {
        available_drivers: 'Доступные водители',
        your_order: 'Ваш заказ',
        from_point_a: 'Откуда (A)',
        to_point_b: 'Куда (B)',
        loading: 'Загрузка...',
        your_price: 'Ваша цена',
        transport_type: 'Тип транспорта',
        drivers_near_point_a: 'Водители рядом с точкой A',
        searching_drivers: 'Ищем водителей, которые начинают маршрут рядом с вашей точкой отправления...',
        no_drivers_found: 'Водители не найдены',
        no_drivers_message: 'В данный момент нет водителей, которые начинают поездку рядом с вашей точкой отправления.<br>Попробуйте обновить через несколько минут.',
        driver_info: 'Информация о водителе',
        perfect_match: 'Точное совпадение',
        good_match: 'Подходящий',
        small: 'Малый',
        medium: 'Средний',
        large: 'Большой',
        any: 'Любой',
        km_from_point_a: 'км от точки A',
        min: 'мин',
        driver_route: 'Маршрут водителя',
        route_match: 'Совпадение маршрутов',
        trip_details: 'Детали поездки',
        price_label: 'Цена:',
        transport_label: 'Транспорт:',
        eta_label: 'Время до прибытия:',
        driver_comment: 'Комментарий водителя',
        contact_info: 'Контактная информация',
        call: 'Позвонить',
        whatsapp: 'WhatsApp',
        start_city: 'Город отправления:',
        end_city: 'Город прибытия:',
        from_city: 'Из города:',
        to_city: 'В город:',
        reviews: 'отзывов'
      },
      kz: {
        available_drivers: 'Қолжетімді жүргізушілер',
        your_order: 'Сіздің тапсырысыңыз',
        from_point_a: 'Қайдан (A)',
        to_point_b: 'Қайда (B)',
        loading: 'Жүктеу...',
        your_price: 'Сіздің бағаңыз',
        transport_type: 'Көлік түрі',
        drivers_near_point_a: 'A нүктесіне жақын жүргізушілер',
        searching_drivers: 'Сіздің шығу нүктеңізге жақын маршрут бастайтын жүргізушілерді іздеуде...',
        no_drivers_found: 'Жүргізушілер табылмады',
        no_drivers_message: 'Қазіргі уақытта сіздің шығу нүктеңізге жақын сапар бастайтын жүргізушілер жоқ.<br>Бірнеше минуттан кейін жаңартып көріңіз.',
        driver_info: 'Жүргізуші туралы ақпарат',
        perfect_match: 'Дәл сәйкестік',
        good_match: 'Қолайлы',
        small: 'Кіші',
        medium: 'Орташа',
        large: 'Үлкен',
        any: 'Кез келген',
        km_from_point_a: 'км A нүктесінен',
        min: 'мин',
        driver_route: 'Жүргізуші маршруты',
        route_match: 'Маршруттардың сәйкестігі',
        trip_details: 'Сапар мәліметтері',
        price_label: 'Бағасы:',
        transport_label: 'Көлік:',
        eta_label: 'Келу уақыты:',
        driver_comment: 'Жүргізуші түсініктемесі',
        contact_info: 'Байланыс ақпараты',
        call: 'Қоңырау шалу',
        whatsapp: 'WhatsApp',
        start_city: 'Бастау қаласы:',
        end_city: 'Аяқтау қаласы:',
        from_city: 'Қаладан:',
        to_city: 'Қалаға:',
        reviews: 'пікір'
      }
    };

    // Global state
    let orderData = null;
    let availableDrivers = [];
    let currentLanguage = 'ru';

    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
      initializePage();
      setupTelegramWebApp();
    });

    // Initialize page with order data
    function initializePage() {
      try {
        // Get order data from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const orderParam = urlParams.get('order');
        
        if (orderParam) {
          orderData = JSON.parse(decodeURIComponent(orderParam));
          displayOrderSummary();
          loadDrivers();
        } else {
          // Fallback: Try to get from sessionStorage or redirect back
          const storedOrder = sessionStorage.getItem('orderData');
          if (storedOrder) {
            orderData = JSON.parse(storedOrder);
            displayOrderSummary();
            loadDrivers();
          } else {
            showError(translations[currentLanguage]['no_drivers_found']);
            setTimeout(() => goBack(), 2000);
          }
        }
      } catch (error) {
        console.error('Error initializing page:', error);
        showError('Ошибка загрузки данных заказа');
      }
    }

    // Setup Telegram WebApp
    function setupTelegramWebApp() {
      if (window.Telegram?.WebApp) {
        const tg = Telegram.WebApp;
        tg.ready();
        tg.expand();
        tg.disableVerticalSwipes();
        
        // Set theme
        if (tg.colorScheme === 'dark') {
          document.body.style.background = 'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)';
        }
      }
    }

    // Language switching
    function setLanguage(lang) {
      currentLanguage = lang;
      
      // Update language buttons
      document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById('lang-' + lang).classList.add('active');
      
      // Update all translatable elements
      document.querySelectorAll('[data-text]').forEach(element => {
        const key = element.getAttribute('data-text');
        if (translations[lang] && translations[lang][key]) {
          element.innerHTML = translations[lang][key];
        }
      });
      
      // Refresh drivers list if loaded
      if (availableDrivers.length > 0) {
        displayDrivers(availableDrivers);
      }
    }

    // Display order summary
    function displayOrderSummary() {
      if (!orderData) return;
      
      const fromAddr = orderData.pickup?.address || translations[currentLanguage]['loading'];
      const toAddr = orderData.dropoff?.address || translations[currentLanguage]['loading'];
      
      document.getElementById('fromAddress').textContent = fromAddr;
      document.getElementById('toAddress').textContent = toAddr;
      document.getElementById('orderPrice').textContent = `${orderData.price || 0} ₸`;
      
      // Format truck type
      const truckType = translations[currentLanguage][orderData.truck_type] || translations[currentLanguage]['any'];
      document.getElementById('truckType').textContent = truckType;
    }

    // Load drivers from API
    async function loadDrivers() {
      try {
        showLoadingState();
        
        // Build query parameters
        const params = new URLSearchParams({
          from_lat: orderData.pickup?.lat || 43.238949,
          from_lon: orderData.pickup?.lng || 76.889709,
          to_lat: orderData.dropoff?.lat || 43.238949,
          to_lon: orderData.dropoff?.lng || 76.889709,
          radius: 50 // Search within 50km radius
        });
        
        console.log('🔍 Loading drivers with params:', Object.fromEntries(params));
        
        const response = await fetch(`/api/driver-list?${params.toString()}`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.success && result.data && result.data.drivers) {
          availableDrivers = result.data.drivers;
          console.log(`✅ Found ${availableDrivers.length} drivers`);
          displayDrivers(availableDrivers);
        } else {
          throw new Error(result.message || 'Driver search error');
        }
        
      } catch (error) {
        console.error('Error loading drivers:', error);
        showEmptyState();
        showError('Ошибка загрузки водителей: ' + error.message);
      }
    }

    // Display drivers list
    function displayDrivers(drivers) {
      hideLoadingState();
      
      const driversList = document.getElementById('driversList');
      const driversCount = document.getElementById('driversCount');
      
      if (!drivers || drivers.length === 0) {
        showEmptyState();
        return;
      }
      
      driversCount.textContent = drivers.length;
      
      driversList.innerHTML = drivers.map((driver, index) => {
        // Distance and match calculation
        const distance = driver.distance_km || 0;
        const isPerfectMatch = distance < 5; // Within 5km is perfect match
        const matchClass = isPerfectMatch ? 'perfect-match' : '';
        const matchText = translations[currentLanguage][isPerfectMatch ? 'perfect_match' : 'good_match'];
        
        // Truck type display
        const truckTypeName = translations[currentLanguage][driver.truck_type] || translations[currentLanguage]['any'];
        
        // Cities - use extracted city names or fallback to address
        const startCity = driver.start_city || extractCityFromAddress(driver.from_address) || 'Неизвестный город';
        const endCity = driver.end_city || extractCityFromAddress(driver.to_address) || 'Неизвестный город';
        
        // Price with fallback
        const driverPrice = driver.price || 'Договорная';
        
        return `
        <div class="driver-card slide-in" style="animation-delay: ${index * 0.1}s" onclick="showDriverDetails(${driver.id})">
          <div class="match-indicator ${matchClass}">${matchText}</div>
          
          <div class="driver-header">
            <img src="/files/${driver.profile_photo || 'default-avatar.jpg'}" 
                 alt="${driver.first_name} ${driver.last_name}"
                 class="driver-photo"
                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjUiIGN5PSIyNSIgcj0iMjUiIGZpbGw9IiNGM0Y0RjYiLz4KPHA+Z3JheSBlbXB0eSBjaXJjbGUgaWNvbjwvcD4KPC9zdmc+Cg=='">
            <div class="driver-info">
              <div class="driver-name">${driver.first_name} ${driver.last_name}</div>
              <div class="driver-rating">
                <span class="stars">★★★★★</span>
                <span>4.8 (${Math.floor(Math.random() * 50) + 20})</span>
              </div>
            </div>
            <div class="driver-price">
              <div class="price-amount">${driverPrice}</div>
              <div class="price-currency">₸</div>
            </div>
          </div>
          
          <div class="driver-details">
            <div class="detail-chip">
              <div>🚚 ${truckTypeName}</div>
            </div>
            <div class="detail-chip">
              <div class="distance-badge">${distance.toFixed(1)} км</div>
            </div>
            <div class="detail-chip">
              <div>⏱️ ${driver.eta_min || 15} ${translations[currentLanguage]['min']}</div>
            </div>
          </div>
          
          <div class="driver-route">
            <div class="route-cities">
              <span class="city-name">${startCity}</span>
              <span>→</span>
              <span class="city-name">${endCity}</span>
            </div>
            <div class="route-addresses">
              <strong>А:</strong> ${(driver.from_address || '').substring(0, 35)}${(driver.from_address || '').length > 35 ? '...' : ''}<br>
              <strong>Б:</strong> ${(driver.to_address || '').substring(0, 35)}${(driver.to_address || '').length > 35 ? '...' : ''}
            </div>
          </div>
        </div>
      `}).join('');
      
      driversList.style.display = 'block';
    }

    // Extract city from address
    function extractCityFromAddress(address) {
      if (!address || address === 'Адрес не указан') {
        return 'Неизвестный город';
      }

      // Common Kazakhstan cities
      const cities = [
        'Алматы', 'Almaty', 'Астана', 'Нур-Султан', 'Nur-Sultan',
        'Шымкент', 'Shymkent', 'Караганда', 'Karaganda', 'Актобе', 'Aktobe',
        'Тараз', 'Taraz', 'Павлодар', 'Pavlodar', 'Усть-Каменогорск', 
        'Семей', 'Semey', 'Атырау', 'Atyrau', 'Костанай', 'Kostanay',
        'Кызылорда', 'Kyzylorda', 'Уральск', 'Uralsk', 'Петропавловск',
        'Актау', 'Aktau', 'Темиртау', 'Temirtau'
      ];

      const addressUpper = address.toUpperCase();
      
      for (const city of cities) {
        if (addressUpper.includes(city.toUpperCase())) {
          return city;
        }
      }

      // Try to extract first part before comma
      const parts = address.split(',');
      if (parts.length > 0) {
        const firstPart = parts[0].trim();
        if (firstPart.length > 0 && firstPart.length < 50) {
          return firstPart;
        }
      }

      return address.length > 20 ? address.substring(0, 17) + '...' : address;
    }

    // Format date time for display
    function formatDateTime(dateTimeString) {
      try {
        const date = new Date(dateTimeString);
        if (isNaN(date.getTime())) {
          return 'Время не указано';
        }
        
        const now = new Date();
        const diffMs = date.getTime() - now.getTime();
        const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
        
        const timeStr = date.toLocaleTimeString(currentLanguage === 'ru' ? 'ru-RU' : 'kk-KZ', {
          hour: '2-digit',
          minute: '2-digit'
        });
        
        if (diffDays === 0) {
          return `Сегодня в ${timeStr}`;
        } else if (diffDays === 1) {
          return `Завтра в ${timeStr}`;
        } else if (diffDays > 1 && diffDays <= 7) {
          return `Через ${diffDays} дн. в ${timeStr}`;
        } else {
          return date.toLocaleDateString(currentLanguage === 'ru' ? 'ru-RU' : 'kk-KZ') + ' в ' + timeStr;
        }
      } catch (error) {
        console.warn('Error formatting date:', error);
        return 'Время не указано';
      }
    }

    // Show driver details modal
    function showDriverDetails(driverId) {
      const driver = availableDrivers.find(d => d.id === driverId);
      if (!driver) return;
      
      const modalBody = document.getElementById('modalBody');
      const distance = driver.distance_km || 0;
      const truckTypeName = translations[currentLanguage][driver.truck_type] || translations[currentLanguage]['any'];
      const startCity = driver.start_city || extractCityFromAddress(driver.from_address) || 'Неизвестный город';
      const endCity = driver.end_city || extractCityFromAddress(driver.to_address) || 'Неизвестный город';
      
      modalBody.innerHTML = `
        <div class="driver-profile">
          <img src="/files/${driver.profile_photo || 'default-avatar.jpg'}" 
               alt="${driver.first_name} ${driver.last_name}"
               class="profile-photo"
               onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxjaXJjbGUgY3g9IjUwIiBjeT0iNTAiIHI9IjUwIiBmaWxsPSIjRjNGNEY2Ii8+Cjx0ZXh0IHg9IjUwIiB5PSI1NSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzZCNzI4MCI+Ojo6PC90ZXh0Pgo8L3N2Zz4K'">
          <div class="profile-name">${driver.first_name} ${driver.last_name}</div>
          <div class="profile-rating">
            <span class="profile-stars">★★★★★</span>
            <span>4.8 (${Math.floor(Math.random() * 50) + 20} ${translations[currentLanguage]['reviews']})</span>
          </div>
        </div>
        
        <div class="trip-details">
          <div class="detail-section">
            <div class="detail-title">${translations[currentLanguage]['driver_route']}</div>
            <div class="detail-content">
              <strong>${translations[currentLanguage]['from_city']}</strong> ${startCity}<br>
              <strong>${translations[currentLanguage]['to_city']}</strong> ${endCity}
            </div>
          </div>
          
          <div class="detail-section">
            <div class="detail-title">📍 Полные адреса</div>
            <div class="detail-content">
              <strong>Откуда:</strong> ${driver.from_address || 'Адрес не указан'}<br>
              <strong>Куда:</strong> ${driver.to_address || 'Адрес не указан'}
            </div>
          </div>
          
          <div class="detail-section">
            <div class="detail-title">${translations[currentLanguage]['route_match']}</div>
            <div class="detail-content">
              📍 <strong>Расстояние от вашей точки A:</strong> ${distance.toFixed(1)} км<br>
              ⏱️ <strong>Время в пути:</strong> ~${driver.eta_min || Math.ceil(distance * 2)} мин
            </div>
          </div>
          
          <div class="detail-section">
            <div class="detail-title">${translations[currentLanguage]['trip_details']}</div>
            <div class="detail-content">
              💰 ${translations[currentLanguage]['price_label']} ${driver.price || 'Договорная'} ₸<br>
              🚚 ${translations[currentLanguage]['transport_label']} ${truckTypeName}<br>
              📅 Отправление: ${driver.departure_time ? formatDateTime(driver.departure_time) : 'Время не указано'}
            </div>
          </div>
          
          ${driver.comment ? `
            <div class="detail-section">
              <div class="detail-title">${translations[currentLanguage]['driver_comment']}</div>
              <div class="detail-content">${driver.comment}</div>
            </div>
          ` : ''}
          
          <div class="detail-section">
            <div class="detail-title">${translations[currentLanguage]['contact_info']}</div>
            <div class="detail-content">
              📱 ${driver.contact_number}
            </div>
          </div>
        </div>
        
        <div class="contact-section">
          <div class="contact-buttons">
            <button class="contact-btn" onclick="callDriver('${driver.contact_number}')">
              📞 ${translations[currentLanguage]['call']}
            </button>
            ${driver.has_whatsapp ? `
              <button class="contact-btn whatsapp" onclick="openWhatsApp('${driver.contact_number}')">
                💬 ${translations[currentLanguage]['whatsapp']}
              </button>
            ` : ''}
            ${driver.has_telegram && driver.telegram_username ? `
              <button class="contact-btn telegram" onclick="openTelegram('${driver.telegram_username}')">
                ✈️ Telegram
              </button>
            ` : ''}
          </div>
        </div>
      `;
      
      document.getElementById('driverModal').classList.add('active');
    }

    // Close driver modal
    function closeDriverModal() {
      document.getElementById('driverModal').classList.remove('active');
    }

    // Contact functions
    function callDriver(phone) {
      window.open(`tel:${phone}`, '_self');
    }

    function openWhatsApp(phone) {
      const cleanPhone = phone.replace(/[^\d]/g, '');
      const message = encodeURIComponent(`Здравствуйте! Я нашел ваш номер в приложении TezJet. Мне нужна доставка от ${orderData.pickup?.address || 'точки A'} до ${orderData.dropoff?.address || 'точки B'}. Цена: ${orderData.price} ₸.`);
      window.open(`https://wa.me/${cleanPhone}?text=${message}`, '_blank');
    }

    function openTelegram(username) {
      window.open(`https://t.me/${username}`, '_blank');
    }

    // State management functions
    function showLoadingState() {
      document.getElementById('loadingState').style.display = 'flex';
      document.getElementById('driversList').style.display = 'none';
      document.getElementById('emptyState').style.display = 'none';
    }

    function hideLoadingState() {
      document.getElementById('loadingState').style.display = 'none';
    }

    function showEmptyState() {
      hideLoadingState();
      document.getElementById('emptyState').style.display = 'block';
      document.getElementById('driversList').style.display = 'none';
      document.getElementById('driversCount').textContent = '0';
    }

    function showError(message) {
      if (window.Telegram?.WebApp) {
        Telegram.WebApp.showAlert(message);
      } else {
        alert(message);
      }
    }

    // Navigation functions
    function goBack() {
      if (window.history.length > 1) {
        window.history.back();
      } else {
        window.location.href = '/delivery';
      }
    }

    function refreshDrivers() {
      loadDrivers();
    }

    // Event listeners
    document.addEventListener('click', (e) => {
      if (e.target.matches('.driver-modal')) {
        closeDriverModal();
      }
    });

    // Auto-refresh drivers every 30 seconds
    setInterval(() => {
      if (document.visibilityState === 'visible') {
        refreshDrivers();
      }
    }, 30000);
  </script>
</body>
</html>