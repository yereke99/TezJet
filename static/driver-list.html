<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>–î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–æ–¥–∏—Ç–µ–ª–∏</title>
  
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #fff;
      overflow-x: hidden;
    }

    /* Header */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 1000;
      padding: env(safe-area-inset-top, 12px) 16px 12px;
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .back-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 12px;
      padding: 12px;
      cursor: pointer;
      color: white;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .back-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    .header-title {
      font-size: 18px;
      font-weight: 700;
      text-align: center;
      flex: 1;
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Language Switch */
    .lang-switch {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      padding: 2px;
      display: flex;
    }

    .lang-btn {
      padding: 6px 12px;
      border: none;
      background: transparent;
      color: white;
      border-radius: 18px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .lang-btn.active {
      background: rgba(255, 255, 255, 0.8);
      color: #333;
    }

    .refresh-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 12px;
      padding: 12px;
      cursor: pointer;
      color: white;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .refresh-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: rotate(180deg);
    }

    /* Main Content */
    .main-content {
      padding-top: 80px;
      padding-bottom: 20px;
    }

    /* Order Summary */
    .order-summary {
      margin: 16px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .order-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
      color: rgba(255, 255, 255, 0.9);
    }

    .route-display {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .route-point {
      flex: 1;
    }

    .route-label {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 4px;
    }

    .route-address {
      font-size: 14px;
      font-weight: 500;
      line-height: 1.3;
    }

    .route-arrow {
      font-size: 20px;
      color: rgba(255, 255, 255, 0.8);
    }

    .order-details {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-top: 16px;
    }

    .detail-item {
      text-align: center;
    }

    .detail-value {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .detail-label {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.7);
    }

    /* Drivers Section */
    .drivers-section {
      margin: 16px;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 700;
    }

    .drivers-count {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 6px 12px;
      font-size: 14px;
      font-weight: 600;
    }

    /* Driver Cards */
    .driver-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      margin-bottom: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      color: #333;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .driver-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
    }

    .driver-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #10b981, #059669);
    }

    .driver-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .driver-photo {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #10b981;
      background: #f3f4f6;
    }

    .driver-info {
      flex: 1;
    }

    .driver-name {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 2px;
      color: #111827;
    }

    .driver-rating {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 14px;
      color: #6b7280;
    }

    .stars {
      color: #fbbf24;
    }

    .driver-price {
      text-align: right;
    }

    .price-amount {
      font-size: 20px;
      font-weight: 800;
      color: #10b981;
    }

    .price-currency {
      font-size: 14px;
      color: #6b7280;
    }

    .driver-details {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 12px;
    }

    .detail-chip {
      background: #f3f4f6;
      border-radius: 8px;
      padding: 6px 8px;
      text-align: center;
      font-size: 11px;
      color: #6b7280;
    }

    .driver-route {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 12px;
      margin-top: 12px;
    }

    .route-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
      color: #6b7280;
    }

    .route-cities {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #374151;
      margin-bottom: 4px;
    }

    .city-name {
      font-weight: 600;
      color: #10b981;
    }

    .route-addresses {
      font-size: 11px;
      color: #6b7280;
      line-height: 1.3;
    }

    .distance-badge {
      background: #e5f7f0;
      color: #047857;
      border-radius: 20px;
      padding: 4px 8px;
      font-size: 11px;
      font-weight: 600;
    }

    /* Loading State */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 50vh;
      padding: 40px 20px;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 16px;
      color: rgba(255, 255, 255, 0.9);
      text-align: center;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }

    .empty-icon {
      font-size: 60px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .empty-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 12px;
      color: rgba(255, 255, 255, 0.9);
    }

    .empty-message {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
      line-height: 1.5;
    }

    /* Driver Detail Modal */
    .driver-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      display: none;
      align-items: flex-end;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .driver-modal.active {
      display: flex;
      animation: modalSlideUp 0.4s ease-out;
    }

    @keyframes modalSlideUp {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: white;
      width: 100%;
      max-height: 90vh;
      border-radius: 20px 20px 0 0;
      overflow-y: auto;
      animation: contentSlideUp 0.4s ease-out;
    }

    @keyframes contentSlideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }

    .modal-header {
      position: sticky;
      top: 0;
      background: white;
      padding: 16px 20px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 10;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: #111827;
    }

    .close-btn {
      background: #f3f4f6;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: #6b7280;
      transition: all 0.3s ease;
    }

    .close-btn:hover {
      background: #e5e7eb;
      transform: scale(1.1);
    }

    .modal-body {
      padding: 20px;
      color: #333;
    }

    .driver-profile {
      text-align: center;
      margin-bottom: 24px;
    }

    .profile-photo {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      margin: 0 auto 16px;
      border: 4px solid #10b981;
      background: #f3f4f6;
    }

    .profile-name {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
      color: #111827;
    }

    .profile-rating {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 16px;
      color: #6b7280;
    }

    .profile-stars {
      color: #fbbf24;
      font-size: 18px;
    }

    .trip-details {
      background: #f8f9fa;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .detail-section {
      margin-bottom: 16px;
    }

    .detail-title {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    .detail-content {
      font-size: 16px;
      font-weight: 500;
      color: #111827;
    }

    .contact-section {
      margin-top: 24px;
    }

    .contact-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 16px;
    }

    .contact-btn {
      background: #10b981;
      color: white;
      border: none;
      border-radius: 12px;
      padding: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .contact-btn.whatsapp {
      background: #25D366;
    }

    .contact-btn.telegram {
      background: #0088cc;
    }

    .contact-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    /* Match Indicator */
    .match-indicator {
      position: absolute;
      top: 16px;
      right: 16px;
      background: #10b981;
      color: white;
      border-radius: 20px;
      padding: 4px 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .match-indicator.perfect-match {
      background: #059669;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* Animation Classes */
    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .slide-in {
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from { transform: translateX(-20px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* Responsive Design */
    @media (max-width: 480px) {
      .order-details {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .driver-details {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .contact-buttons {
        grid-template-columns: 1fr;
      }
      
      .header-controls {
        gap: 4px;
      }
      
      .lang-btn {
        padding: 4px 8px;
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <button class="back-btn" onclick="goBack()">‚Üê</button>
      <div class="header-title" data-text="available_drivers">–î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–æ–¥–∏—Ç–µ–ª–∏</div>
      <div class="header-controls">
        <div class="lang-switch">
          <button class="lang-btn active" onclick="setLanguage('ru')" id="lang-ru">RU</button>
          <button class="lang-btn" onclick="setLanguage('kz')" id="lang-kz">KZ</button>
        </div>
        <button class="refresh-btn" onclick="refreshDrivers()" title="–û–±–Ω–æ–≤–∏—Ç—å">üîÑ</button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Order Summary -->
    <div class="order-summary fade-in">
      <div class="order-title" data-text="your_order">–í–∞—à –∑–∞–∫–∞–∑</div>
      <div class="route-display">
        <div class="route-point">
          <div class="route-label" data-text="from_point_a">–û—Ç–∫—É–¥–∞ (A)</div>
          <div class="route-address" id="fromAddress" data-text="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        <div class="route-arrow">‚Üí</div>
        <div class="route-point">
          <div class="route-label" data-text="to_point_b">–ö—É–¥–∞ (B)</div>
          <div class="route-address" id="toAddress" data-text="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
      </div>
      <div class="order-details">
        <div class="detail-item">
          <div class="detail-value" id="orderPrice">0 ‚Ç∏</div>
          <div class="detail-label" data-text="your_price">–í–∞—à–∞ —Ü–µ–Ω–∞</div>
        </div>
        <div class="detail-item">
          <div class="detail-value" id="truckType">-</div>
          <div class="detail-label" data-text="transport_type">–¢–∏–ø —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞</div>
        </div>
      </div>
    </div>

    <!-- Drivers Section -->
    <div class="drivers-section">
      <div class="section-header">
        <div class="section-title" data-text="drivers_near_point_a">–í–æ–¥–∏—Ç–µ–ª–∏ —Ä—è–¥–æ–º —Å —Ç–æ—á–∫–æ–π A</div>
        <div class="drivers-count" id="driversCount">0</div>
      </div>
      
      <!-- Loading State -->
      <div class="loading-container" id="loadingState">
        <div class="loading-spinner"></div>
        <div class="loading-text" data-text="searching_drivers">–ò—â–µ–º –≤–æ–¥–∏—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—á–∏–Ω–∞—é—Ç –º–∞—Ä—à—Ä—É—Ç —Ä—è–¥–æ–º —Å –≤–∞—à–µ–π —Ç–æ—á–∫–æ–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è...</div>
      </div>

      <!-- Drivers List -->
      <div id="driversList" style="display: none;"></div>

      <!-- Empty State -->
      <div class="empty-state" id="emptyState" style="display: none;">
        <div class="empty-icon">üöö</div>
        <div class="empty-title" data-text="no_drivers_found">–í–æ–¥–∏—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
        <div class="empty-message" data-text="no_drivers_message">
          –í –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ—Ç –≤–æ–¥–∏—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—á–∏–Ω–∞—é—Ç –ø–æ–µ–∑–¥–∫—É —Ä—è–¥–æ–º —Å –≤–∞—à–µ–π —Ç–æ—á–∫–æ–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è.<br>
          –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.
        </div>
      </div>
    </div>
  </div>

  <!-- Driver Detail Modal -->
  <div class="driver-modal" id="driverModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" data-text="driver_info">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–æ–¥–∏—Ç–µ–ª–µ</div>
        <button class="close-btn" onclick="closeDriverModal()">‚úï</button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Content will be loaded here -->
      </div>
    </div>
  </div>

  <script>
    // Translations
    const translations = {
      ru: {
        available_drivers: '–î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–æ–¥–∏—Ç–µ–ª–∏',
        your_order: '–í–∞—à –∑–∞–∫–∞–∑',
        from_point_a: '–û—Ç–∫—É–¥–∞ (A)',
        to_point_b: '–ö—É–¥–∞ (B)',
        loading: '–ó–∞–≥—Ä—É–∑–∫–∞...',
        your_price: '–í–∞—à–∞ —Ü–µ–Ω–∞',
        transport_type: '–¢–∏–ø —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞',
        drivers_near_point_a: '–í–æ–¥–∏—Ç–µ–ª–∏ —Ä—è–¥–æ–º —Å —Ç–æ—á–∫–æ–π A',
        searching_drivers: '–ò—â–µ–º –≤–æ–¥–∏—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—á–∏–Ω–∞—é—Ç –º–∞—Ä—à—Ä—É—Ç —Ä—è–¥–æ–º —Å –≤–∞—à–µ–π —Ç–æ—á–∫–æ–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è...',
        no_drivers_found: '–í–æ–¥–∏—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã',
        no_drivers_message: '–í –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ—Ç –≤–æ–¥–∏—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—á–∏–Ω–∞—é—Ç –ø–æ–µ–∑–¥–∫—É —Ä—è–¥–æ–º —Å –≤–∞—à–µ–π —Ç–æ—á–∫–æ–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è.<br>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.',
        driver_info: '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–æ–¥–∏—Ç–µ–ª–µ',
        perfect_match: '–¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ',
        good_match: '–ü–æ–¥—Ö–æ–¥—è—â–∏–π',
        small: '–ú–∞–ª—ã–π',
        medium: '–°—Ä–µ–¥–Ω–∏–π',
        large: '–ë–æ–ª—å—à–æ–π',
        any: '–õ—é–±–æ–π',
        km_from_point_a: '–∫–º –æ—Ç —Ç–æ—á–∫–∏ A',
        min: '–º–∏–Ω',
        driver_route: '–ú–∞—Ä—à—Ä—É—Ç –≤–æ–¥–∏—Ç–µ–ª—è',
        route_match: '–°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–æ–≤',
        trip_details: '–î–µ—Ç–∞–ª–∏ –ø–æ–µ–∑–¥–∫–∏',
        price_label: '–¶–µ–Ω–∞:',
        transport_label: '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç:',
        eta_label: '–í—Ä–µ–º—è –¥–æ –ø—Ä–∏–±—ã—Ç–∏—è:',
        driver_comment: '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤–æ–¥–∏—Ç–µ–ª—è',
        contact_info: '–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è',
        call: '–ü–æ–∑–≤–æ–Ω–∏—Ç—å',
        whatsapp: 'WhatsApp',
        start_city: '–ì–æ—Ä–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è:',
        end_city: '–ì–æ—Ä–æ–¥ –ø—Ä–∏–±—ã—Ç–∏—è:',
        from_city: '–ò–∑ –≥–æ—Ä–æ–¥–∞:',
        to_city: '–í –≥–æ—Ä–æ–¥:',
        reviews: '–æ—Ç–∑—ã–≤–æ–≤'
      },
      kz: {
        available_drivers: '“ö–æ–ª–∂–µ—Ç—ñ–º–¥—ñ –∂“Ø—Ä–≥—ñ–∑—É—à—ñ–ª–µ—Ä',
        your_order: '–°—ñ–∑–¥—ñ“£ —Ç–∞–ø—Å—ã—Ä—ã—Å—ã“£—ã–∑',
        from_point_a: '“ö–∞–π–¥–∞–Ω (A)',
        to_point_b: '“ö–∞–π–¥–∞ (B)',
        loading: '–ñ“Ø–∫—Ç–µ—É...',
        your_price: '–°—ñ–∑–¥—ñ“£ –±–∞“ì–∞“£—ã–∑',
        transport_type: '–ö”©–ª—ñ–∫ —Ç“Ø—Ä—ñ',
        drivers_near_point_a: 'A –Ω“Ø–∫—Ç–µ—Å—ñ–Ω–µ –∂–∞“õ—ã–Ω –∂“Ø—Ä–≥—ñ–∑—É—à—ñ–ª–µ—Ä',
        searching_drivers: '–°—ñ–∑–¥—ñ“£ —à—ã“ì—É –Ω“Ø–∫—Ç–µ“£—ñ–∑–≥–µ –∂–∞“õ—ã–Ω –º–∞—Ä—à—Ä—É—Ç –±–∞—Å—Ç–∞–π—Ç—ã–Ω –∂“Ø—Ä–≥—ñ–∑—É—à—ñ–ª–µ—Ä–¥—ñ —ñ–∑–¥–µ—É–¥–µ...',
        no_drivers_found: '–ñ“Ø—Ä–≥—ñ–∑—É—à—ñ–ª–µ—Ä —Ç–∞–±—ã–ª–º–∞–¥—ã',
        no_drivers_message: '“ö–∞–∑—ñ—Ä–≥—ñ —É–∞“õ—ã—Ç—Ç–∞ —Å—ñ–∑–¥—ñ“£ —à—ã“ì—É –Ω“Ø–∫—Ç–µ“£—ñ–∑–≥–µ –∂–∞“õ—ã–Ω —Å–∞–ø–∞—Ä –±–∞—Å—Ç–∞–π—Ç—ã–Ω –∂“Ø—Ä–≥—ñ–∑—É—à—ñ–ª–µ—Ä –∂–æ“õ.<br>–ë—ñ—Ä–Ω–µ—à–µ –º–∏–Ω—É—Ç—Ç–∞–Ω –∫–µ–π—ñ–Ω –∂–∞“£–∞—Ä—Ç—ã–ø –∫”©—Ä—ñ“£—ñ–∑.',
        driver_info: '–ñ“Ø—Ä–≥—ñ–∑—É—à—ñ —Ç—É—Ä–∞–ª—ã –∞“õ–ø–∞—Ä–∞—Ç',
        perfect_match: '–î”ô–ª —Å”ô–π–∫–µ—Å—Ç—ñ–∫',
        good_match: '“ö–æ–ª–∞–π–ª—ã',
        small: '–ö—ñ—à—ñ',
        medium: '–û—Ä—Ç–∞—à–∞',
        large: '“Æ–ª–∫–µ–Ω',
        any: '–ö–µ–∑ –∫–µ–ª–≥–µ–Ω',
        km_from_point_a: '–∫–º A –Ω“Ø–∫—Ç–µ—Å—ñ–Ω–µ–Ω',
        min: '–º–∏–Ω',
        driver_route: '–ñ“Ø—Ä–≥—ñ–∑—É—à—ñ –º–∞—Ä—à—Ä—É—Ç—ã',
        route_match: '–ú–∞—Ä—à—Ä—É—Ç—Ç–∞—Ä–¥—ã“£ —Å”ô–π–∫–µ—Å—Ç—ñ–≥—ñ',
        trip_details: '–°–∞–ø–∞—Ä –º”ô–ª—ñ–º–µ—Ç—Ç–µ—Ä—ñ',
        price_label: '–ë–∞“ì–∞—Å—ã:',
        transport_label: '–ö”©–ª—ñ–∫:',
        eta_label: '–ö–µ–ª—É —É–∞“õ—ã—Ç—ã:',
        driver_comment: '–ñ“Ø—Ä–≥—ñ–∑—É—à—ñ —Ç“Ø—Å—ñ–Ω—ñ–∫—Ç–µ–º–µ—Å—ñ',
        contact_info: '–ë–∞–π–ª–∞–Ω—ã—Å –∞“õ–ø–∞—Ä–∞—Ç—ã',
        call: '“ö–æ“£—ã—Ä–∞—É —à–∞–ª—É',
        whatsapp: 'WhatsApp',
        start_city: '–ë–∞—Å—Ç–∞—É “õ–∞–ª–∞—Å—ã:',
        end_city: '–ê—è“õ—Ç–∞—É “õ–∞–ª–∞—Å—ã:',
        from_city: '“ö–∞–ª–∞–¥–∞–Ω:',
        to_city: '“ö–∞–ª–∞“ì–∞:',
        reviews: '–ø—ñ–∫—ñ—Ä'
      }
    };

    // Global state
    let orderData = null;
    let availableDrivers = [];
    let currentLanguage = 'ru';

    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
      initializePage();
      setupTelegramWebApp();
    });

    // Initialize page with order data
    function initializePage() {
      try {
        // Get order data from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const orderParam = urlParams.get('order');
        
        if (orderParam) {
          orderData = JSON.parse(decodeURIComponent(orderParam));
          displayOrderSummary();
          loadDrivers();
        } else {
          // Fallback: Try to get from sessionStorage or redirect back
          const storedOrder = sessionStorage.getItem('orderData');
          if (storedOrder) {
            orderData = JSON.parse(storedOrder);
            displayOrderSummary();
            loadDrivers();
          } else {
            showError(translations[currentLanguage]['no_drivers_found']);
            setTimeout(() => goBack(), 2000);
          }
        }
      } catch (error) {
        console.error('Error initializing page:', error);
        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–∞');
      }
    }

    // Setup Telegram WebApp
    function setupTelegramWebApp() {
      if (window.Telegram?.WebApp) {
        const tg = Telegram.WebApp;
        tg.ready();
        tg.expand();
        tg.disableVerticalSwipes();
        
        // Set theme
        if (tg.colorScheme === 'dark') {
          document.body.style.background = 'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)';
        }
      }
    }

    // Language switching
    function setLanguage(lang) {
      currentLanguage = lang;
      
      // Update language buttons
      document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById('lang-' + lang).classList.add('active');
      
      // Update all translatable elements
      document.querySelectorAll('[data-text]').forEach(element => {
        const key = element.getAttribute('data-text');
        if (translations[lang] && translations[lang][key]) {
          element.innerHTML = translations[lang][key];
        }
      });
      
      // Refresh drivers list if loaded
      if (availableDrivers.length > 0) {
        displayDrivers(availableDrivers);
      }
    }

    // Display order summary
    function displayOrderSummary() {
      if (!orderData) return;
      
      const fromAddr = orderData.pickup?.address || translations[currentLanguage]['loading'];
      const toAddr = orderData.dropoff?.address || translations[currentLanguage]['loading'];
      
      document.getElementById('fromAddress').textContent = fromAddr;
      document.getElementById('toAddress').textContent = toAddr;
      document.getElementById('orderPrice').textContent = `${orderData.price || 0} ‚Ç∏`;
      
      // Format truck type
      const truckType = translations[currentLanguage][orderData.truck_type] || translations[currentLanguage]['any'];
      document.getElementById('truckType').textContent = truckType;
    }

    // Load drivers from API
    async function loadDrivers() {
      try {
        showLoadingState();
        
        // Build query parameters
        const params = new URLSearchParams({
          from_lat: orderData.pickup?.lat || 43.238949,
          from_lon: orderData.pickup?.lng || 76.889709,
          to_lat: orderData.dropoff?.lat || 43.238949,
          to_lon: orderData.dropoff?.lng || 76.889709,
          radius: 50 // Search within 50km radius
        });
        
        console.log('üîç Loading drivers with params:', Object.fromEntries(params));
        
        const response = await fetch(`/api/driver-list?${params.toString()}`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.success && result.data && result.data.drivers) {
          availableDrivers = result.data.drivers;
          console.log(`‚úÖ Found ${availableDrivers.length} drivers`);
          displayDrivers(availableDrivers);
        } else {
          throw new Error(result.message || 'Driver search error');
        }
        
      } catch (error) {
        console.error('Error loading drivers:', error);
        showEmptyState();
        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–æ–¥–∏—Ç–µ–ª–µ–π: ' + error.message);
      }
    }

    // Display drivers list
    function displayDrivers(drivers) {
      hideLoadingState();
      
      const driversList = document.getElementById('driversList');
      const driversCount = document.getElementById('driversCount');
      
      if (!drivers || drivers.length === 0) {
        showEmptyState();
        return;
      }
      
      driversCount.textContent = drivers.length;
      
      driversList.innerHTML = drivers.map((driver, index) => {
        // Distance and match calculation
        const distance = driver.distance_km || 0;
        const isPerfectMatch = distance < 5; // Within 5km is perfect match
        const matchClass = isPerfectMatch ? 'perfect-match' : '';
        const matchText = translations[currentLanguage][isPerfectMatch ? 'perfect_match' : 'good_match'];
        
        // Truck type display
        const truckTypeName = translations[currentLanguage][driver.truck_type] || translations[currentLanguage]['any'];
        
        // Cities - use extracted city names or fallback to address
        const startCity = driver.start_city || extractCityFromAddress(driver.from_address) || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≥–æ—Ä–æ–¥';
        const endCity = driver.end_city || extractCityFromAddress(driver.to_address) || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≥–æ—Ä–æ–¥';
        
        // Price with fallback
        const driverPrice = driver.price || '–î–æ–≥–æ–≤–æ—Ä–Ω–∞—è';
        
        return `
        <div class="driver-card slide-in" style="animation-delay: ${index * 0.1}s" onclick="showDriverDetails(${driver.id})">
          <div class="match-indicator ${matchClass}">${matchText}</div>
          
          <div class="driver-header">
            <img src="/files/${driver.profile_photo || 'default-avatar.jpg'}" 
                 alt="${driver.first_name} ${driver.last_name}"
                 class="driver-photo"
                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjUiIGN5PSIyNSIgcj0iMjUiIGZpbGw9IiNGM0Y0RjYiLz4KPHA+Z3JheSBlbXB0eSBjaXJjbGUgaWNvbjwvcD4KPC9zdmc+Cg=='">
            <div class="driver-info">
              <div class="driver-name">${driver.first_name} ${driver.last_name}</div>
              <div class="driver-rating">
                <span class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
                <span>4.8 (${Math.floor(Math.random() * 50) + 20})</span>
              </div>
            </div>
            <div class="driver-price">
              <div class="price-amount">${driverPrice}</div>
              <div class="price-currency">‚Ç∏</div>
            </div>
          </div>
          
          <div class="driver-details">
            <div class="detail-chip">
              <div>üöö ${truckTypeName}</div>
            </div>
            <div class="detail-chip">
              <div class="distance-badge">${distance.toFixed(1)} –∫–º</div>
            </div>
            <div class="detail-chip">
              <div>‚è±Ô∏è ${driver.eta_min || 15} ${translations[currentLanguage]['min']}</div>
            </div>
          </div>
          
          <div class="driver-route">
            <div class="route-cities">
              <span class="city-name">${startCity}</span>
              <span>‚Üí</span>
              <span class="city-name">${endCity}</span>
            </div>
            <div class="route-addresses">
              <strong>–ê:</strong> ${(driver.from_address || '').substring(0, 35)}${(driver.from_address || '').length > 35 ? '...' : ''}<br>
              <strong>–ë:</strong> ${(driver.to_address || '').substring(0, 35)}${(driver.to_address || '').length > 35 ? '...' : ''}
            </div>
          </div>
        </div>
      `}).join('');
      
      driversList.style.display = 'block';
    }

    // Extract city from address
    function extractCityFromAddress(address) {
      if (!address || address === '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω') {
        return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≥–æ—Ä–æ–¥';
      }

      // Common Kazakhstan cities
      const cities = [
        '–ê–ª–º–∞—Ç—ã', 'Almaty', '–ê—Å—Ç–∞–Ω–∞', '–ù—É—Ä-–°—É–ª—Ç–∞–Ω', 'Nur-Sultan',
        '–®—ã–º–∫–µ–Ω—Ç', 'Shymkent', '–ö–∞—Ä–∞–≥–∞–Ω–¥–∞', 'Karaganda', '–ê–∫—Ç–æ–±–µ', 'Aktobe',
        '–¢–∞—Ä–∞–∑', 'Taraz', '–ü–∞–≤–ª–æ–¥–∞—Ä', 'Pavlodar', '–£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫', 
        '–°–µ–º–µ–π', 'Semey', '–ê—Ç—ã—Ä–∞—É', 'Atyrau', '–ö–æ—Å—Ç–∞–Ω–∞–π', 'Kostanay',
        '–ö—ã–∑—ã–ª–æ—Ä–¥–∞', 'Kyzylorda', '–£—Ä–∞–ª—å—Å–∫', 'Uralsk', '–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫',
        '–ê–∫—Ç–∞—É', 'Aktau', '–¢–µ–º–∏—Ä—Ç–∞—É', 'Temirtau'
      ];

      const addressUpper = address.toUpperCase();
      
      for (const city of cities) {
        if (addressUpper.includes(city.toUpperCase())) {
          return city;
        }
      }

      // Try to extract first part before comma
      const parts = address.split(',');
      if (parts.length > 0) {
        const firstPart = parts[0].trim();
        if (firstPart.length > 0 && firstPart.length < 50) {
          return firstPart;
        }
      }

      return address.length > 20 ? address.substring(0, 17) + '...' : address;
    }

    // Format date time for display
    function formatDateTime(dateTimeString) {
      try {
        const date = new Date(dateTimeString);
        if (isNaN(date.getTime())) {
          return '–í—Ä–µ–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ';
        }
        
        const now = new Date();
        const diffMs = date.getTime() - now.getTime();
        const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
        
        const timeStr = date.toLocaleTimeString(currentLanguage === 'ru' ? 'ru-RU' : 'kk-KZ', {
          hour: '2-digit',
          minute: '2-digit'
        });
        
        if (diffDays === 0) {
          return `–°–µ–≥–æ–¥–Ω—è –≤ ${timeStr}`;
        } else if (diffDays === 1) {
          return `–ó–∞–≤—Ç—Ä–∞ –≤ ${timeStr}`;
        } else if (diffDays > 1 && diffDays <= 7) {
          return `–ß–µ—Ä–µ–∑ ${diffDays} –¥–Ω. –≤ ${timeStr}`;
        } else {
          return date.toLocaleDateString(currentLanguage === 'ru' ? 'ru-RU' : 'kk-KZ') + ' –≤ ' + timeStr;
        }
      } catch (error) {
        console.warn('Error formatting date:', error);
        return '–í—Ä–µ–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ';
      }
    }

    // Show driver details modal
    function showDriverDetails(driverId) {
      const driver = availableDrivers.find(d => d.id === driverId);
      if (!driver) return;
      
      const modalBody = document.getElementById('modalBody');
      const distance = driver.distance_km || 0;
      const truckTypeName = translations[currentLanguage][driver.truck_type] || translations[currentLanguage]['any'];
      const startCity = driver.start_city || extractCityFromAddress(driver.from_address) || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≥–æ—Ä–æ–¥';
      const endCity = driver.end_city || extractCityFromAddress(driver.to_address) || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≥–æ—Ä–æ–¥';
      
      modalBody.innerHTML = `
        <div class="driver-profile">
          <img src="/files/${driver.profile_photo || 'default-avatar.jpg'}" 
               alt="${driver.first_name} ${driver.last_name}"
               class="profile-photo"
               onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxjaXJjbGUgY3g9IjUwIiBjeT0iNTAiIHI9IjUwIiBmaWxsPSIjRjNGNEY2Ii8+Cjx0ZXh0IHg9IjUwIiB5PSI1NSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzZCNzI4MCI+Ojo6PC90ZXh0Pgo8L3N2Zz4K'">
          <div class="profile-name">${driver.first_name} ${driver.last_name}</div>
          <div class="profile-rating">
            <span class="profile-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
            <span>4.8 (${Math.floor(Math.random() * 50) + 20} ${translations[currentLanguage]['reviews']})</span>
          </div>
        </div>
        
        <div class="trip-details">
          <div class="detail-section">
            <div class="detail-title">${translations[currentLanguage]['driver_route']}</div>
            <div class="detail-content">
              <strong>${translations[currentLanguage]['from_city']}</strong> ${startCity}<br>
              <strong>${translations[currentLanguage]['to_city']}</strong> ${endCity}
            </div>
          </div>
          
          <div class="detail-section">
            <div class="detail-title">üìç –ü–æ–ª–Ω—ã–µ –∞–¥—Ä–µ—Å–∞</div>
            <div class="detail-content">
              <strong>–û—Ç–∫—É–¥–∞:</strong> ${driver.from_address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'}<br>
              <strong>–ö—É–¥–∞:</strong> ${driver.to_address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'}
            </div>
          </div>
          
          <div class="detail-section">
            <div class="detail-title">${translations[currentLanguage]['route_match']}</div>
            <div class="detail-content">
              üìç <strong>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –≤–∞—à–µ–π —Ç–æ—á–∫–∏ A:</strong> ${distance.toFixed(1)} –∫–º<br>
              ‚è±Ô∏è <strong>–í—Ä–µ–º—è –≤ –ø—É—Ç–∏:</strong> ~${driver.eta_min || Math.ceil(distance * 2)} –º–∏–Ω
            </div>
          </div>
          
          <div class="detail-section">
            <div class="detail-title">${translations[currentLanguage]['trip_details']}</div>
            <div class="detail-content">
              üí∞ ${translations[currentLanguage]['price_label']} ${driver.price || '–î–æ–≥–æ–≤–æ—Ä–Ω–∞—è'} ‚Ç∏<br>
              üöö ${translations[currentLanguage]['transport_label']} ${truckTypeName}<br>
              üìÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${driver.departure_time ? formatDateTime(driver.departure_time) : '–í—Ä–µ–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ'}
            </div>
          </div>
          
          ${driver.comment ? `
            <div class="detail-section">
              <div class="detail-title">${translations[currentLanguage]['driver_comment']}</div>
              <div class="detail-content">${driver.comment}</div>
            </div>
          ` : ''}
          
          <div class="detail-section">
            <div class="detail-title">${translations[currentLanguage]['contact_info']}</div>
            <div class="detail-content">
              üì± ${driver.contact_number}
            </div>
          </div>
        </div>
        
        <div class="contact-section">
          <div class="contact-buttons">
            <button class="contact-btn" onclick="callDriver('${driver.contact_number}')">
              üìû ${translations[currentLanguage]['call']}
            </button>
            ${driver.has_whatsapp ? `
              <button class="contact-btn whatsapp" onclick="openWhatsApp('${driver.contact_number}')">
                üí¨ ${translations[currentLanguage]['whatsapp']}
              </button>
            ` : ''}
            ${driver.has_telegram && driver.telegram_username ? `
              <button class="contact-btn telegram" onclick="openTelegram('${driver.telegram_username}')">
                ‚úàÔ∏è Telegram
              </button>
            ` : ''}
          </div>
        </div>
      `;
      
      document.getElementById('driverModal').classList.add('active');
    }

    // Close driver modal
    function closeDriverModal() {
      document.getElementById('driverModal').classList.remove('active');
    }

    // Contact functions
    function callDriver(phone) {
      window.open(`tel:${phone}`, '_self');
    }

    function openWhatsApp(phone) {
      const cleanPhone = phone.replace(/[^\d]/g, '');
      const message = encodeURIComponent(`–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –Ω–∞—à–µ–ª –≤–∞—à –Ω–æ–º–µ—Ä –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ TezJet. –ú–Ω–µ –Ω—É–∂–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞ –æ—Ç ${orderData.pickup?.address || '—Ç–æ—á–∫–∏ A'} –¥–æ ${orderData.dropoff?.address || '—Ç–æ—á–∫–∏ B'}. –¶–µ–Ω–∞: ${orderData.price} ‚Ç∏.`);
      window.open(`https://wa.me/${cleanPhone}?text=${message}`, '_blank');
    }

    function openTelegram(username) {
      window.open(`https://t.me/${username}`, '_blank');
    }

    // State management functions
    function showLoadingState() {
      document.getElementById('loadingState').style.display = 'flex';
      document.getElementById('driversList').style.display = 'none';
      document.getElementById('emptyState').style.display = 'none';
    }

    function hideLoadingState() {
      document.getElementById('loadingState').style.display = 'none';
    }

    function showEmptyState() {
      hideLoadingState();
      document.getElementById('emptyState').style.display = 'block';
      document.getElementById('driversList').style.display = 'none';
      document.getElementById('driversCount').textContent = '0';
    }

    function showError(message) {
      if (window.Telegram?.WebApp) {
        Telegram.WebApp.showAlert(message);
      } else {
        alert(message);
      }
    }

    // Navigation functions
    function goBack() {
      if (window.history.length > 1) {
        window.history.back();
      } else {
        window.location.href = '/delivery';
      }
    }

    function refreshDrivers() {
      loadDrivers();
    }

    // Event listeners
    document.addEventListener('click', (e) => {
      if (e.target.matches('.driver-modal')) {
        closeDriverModal();
      }
    });

    // Auto-refresh drivers every 30 seconds
    setInterval(() => {
      if (document.visibilityState === 'visible') {
        refreshDrivers();
      }
    }, 30000);
  </script>
</body>
</html>