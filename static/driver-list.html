<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>–î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–æ–¥–∏—Ç–µ–ª–∏ ‚Ä¢ QazLine</title>
  
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://api-maps.yandex.ru/v3/?apikey=8a3e4da0-9ef2-4176-9203-e7014c1dba6f&lang=ru_RU"></script>

  <style>
    :root {
      /* Uber-inspired color palette */
      --primary-green: #10b981;
      --primary-dark: #059669;
      --primary-light: #34d399;
      --background: #f7f7f7;
      --surface: #ffffff;
      --surface-hover: #f9f9f9;
      --text-primary: #111827;
      --text-secondary: #6b7280;
      --text-muted: #9ca3af;
      --border: #e5e7eb;
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);
      --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
      --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.1);
      --radius: 12px;
      --radius-lg: 16px;
      
      /* Safe areas */
      --tg-viewport-height: 100vh;
      --tg-viewport-stable-height: 100vh;
      --tg-safe-area-inset-top: 0px;
      --tg-content-safe-area-inset-top: 0px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html {
      height: 100%;
      height: 100dvh;
      overflow-x: hidden;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
      background: var(--background);
      color: var(--text-primary);
      height: var(--tg-viewport-stable-height, 100vh);
      min-height: var(--tg-viewport-height, 100vh);
      padding-top: calc(var(--tg-safe-area-inset-top, 0px) + var(--tg-content-safe-area-inset-top, 0px) + 8px);
      padding-bottom: calc(env(safe-area-inset-bottom) + 80px);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
      overscroll-behavior: none;
      -webkit-overflow-scrolling: touch;
      transform: translateZ(0);
    }

    @supports (height: 100dvh) {
      body {
        height: 100dvh;
        min-height: 100dvh;
      }
    }

    /* Header with Uber style - FIXED POSITIONING */
    .header {
      position: fixed;
      top: calc(var(--tg-safe-area-inset-top, 0px) + var(--tg-content-safe-area-inset-top, 0px) + 8px);
      left: calc(env(safe-area-inset-left) + 16px);
      right: calc(env(safe-area-inset-right) + 16px);
      background: var(--surface);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      z-index: 1000;
      padding: 12px 16px;
      transform: translateZ(0);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .back-btn {
      background: var(--background);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      color: var(--text-primary);
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      touch-action: manipulation;
    }

    .back-btn:active {
      transform: scale(0.92);
      background: var(--border);
    }

    .header-title {
      font-size: 17px;
      font-weight: 600;
      text-align: center;
      flex: 1;
      margin: 0 12px;
      letter-spacing: -0.3px;
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .lang-switch {
      background: var(--background);
      border-radius: 20px;
      padding: 3px;
      display: flex;
      gap: 2px;
    }

    .lang-btn {
      padding: 6px 10px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      border-radius: 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      touch-action: manipulation;
      min-width: 32px;
    }

    .lang-btn.active {
      background: var(--surface);
      color: var(--primary-green);
      box-shadow: var(--shadow);
    }

    .refresh-btn {
      background: var(--background);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      color: var(--text-secondary);
      font-size: 16px;
      transition: all 0.2s ease;
      touch-action: manipulation;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .refresh-btn:active {
      transform: scale(0.92) rotate(180deg);
    }

    /* Main Content - FIXED: starts higher */
    .main-content {
      padding-top: calc(68px + var(--tg-safe-area-inset-top, 0px) + var(--tg-content-safe-area-inset-top, 0px));
      padding-bottom: calc(90px + env(safe-area-inset-bottom));
      padding-left: calc(env(safe-area-inset-left) + 16px);
      padding-right: calc(env(safe-area-inset-right) + 16px);
      height: 100%;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .drivers-section {
      margin-bottom: 16px;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .section-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.5px;
    }

    .drivers-count {
      background: var(--primary-green);
      color: white;
      border-radius: 20px;
      padding: 6px 14px;
      font-size: 14px;
      font-weight: 600;
      min-width: 32px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    /* Uber-style Driver Cards */
    .driver-card {
      background: var(--surface);
      border-radius: var(--radius-lg);
      margin-bottom: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid var(--border);
      position: relative;
      touch-action: manipulation;
      transform: translateZ(0);
    }

    .driver-card:active {
      transform: scale(0.98) translateZ(0);
      background: var(--surface-hover);
    }

    .driver-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .driver-photo {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      object-fit: cover;
      background: var(--background);
      flex-shrink: 0;
      border: 2px solid var(--border);
    }

    .driver-info {
      flex: 1;
      min-width: 0;
    }

    .driver-name {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 2px;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      letter-spacing: -0.3px;
    }

    .driver-vehicle {
      font-size: 14px;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .driver-price {
      text-align: right;
      flex-shrink: 0;
    }

    .price-amount {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary-green);
      letter-spacing: -0.5px;
    }

    .driver-details {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 8px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .distance-info {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .distance-info span {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .route-info {
      font-size: 13px;
      color: var(--text-muted);
      text-align: right;
      max-width: 45%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Loading State */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 50vh;
      padding: 40px 20px;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top: 3px solid var(--primary-green);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 16px;
      color: var(--text-secondary);
      text-align: center;
      font-weight: 500;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }

    .empty-icon {
      font-size: 72px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .empty-title {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 12px;
      color: var(--text-primary);
      letter-spacing: -0.3px;
    }

    .empty-message {
      font-size: 15px;
      color: var(--text-secondary);
      line-height: 1.5;
      max-width: 280px;
      margin: 0 auto;
    }

    /* Floating Action Button */
    .fab-container {
      position: fixed;
      bottom: calc(env(safe-area-inset-bottom) + 16px);
      right: calc(env(safe-area-inset-right) + 16px);
      z-index: 999;
      transform: translateZ(0);
    }

    .fab {
      background: var(--primary-green);
      color: white;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      transition: all 0.3s ease;
      touch-action: manipulation;
      position: relative;
    }

    .fab:active {
      transform: scale(0.9);
    }

    /* Driver Modal - FIXED: Bottom Sheet Style */
    .driver-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      display: none;
      align-items: flex-end;  /* CRITICAL: Bottom sheet alignment */
      padding: 0;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .driver-modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--surface);
      width: 100%;
      max-height: calc(var(--tg-viewport-height, 90vh) - calc(var(--tg-safe-area-inset-top, 0px) + var(--tg-content-safe-area-inset-top, 0px) + 60px));
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
      overflow: hidden;
      position: relative;
      box-shadow: var(--shadow-xl);
      transform: translateZ(0);
      animation: slideUp 0.3s ease;
      padding-bottom: calc(env(safe-area-inset-bottom) + 16px);
    }

    @keyframes slideUp {
      from {
        transform: translateY(100%);
      }
      to {
        transform: translateY(0);
      }
    }

    @supports (height: 100dvh) {
      .modal-content {
        max-height: calc(100dvh - calc(var(--tg-safe-area-inset-top, 0px) + var(--tg-content-safe-area-inset-top, 0px) + 60px));
      }
    }

    /* Modal handle */
    .modal-handle {
      width: 36px;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      margin: 8px auto 12px;
    }

    /* Map Section - FIXED: Proper touch-action */
    .modal-map-section {
      position: relative;
      height: 200px;
      width: 100%;
      background: var(--background);
      overflow: hidden;
      transform: translateZ(0);
      contain: layout style paint;
    }

    .modal-map-section.fullscreen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 3000;
      border-radius: 0;
      height: var(--tg-viewport-height, 100vh);
      min-height: var(--tg-viewport-stable-height, 100vh);
      padding-top: calc(var(--tg-safe-area-inset-top, 0px) + var(--tg-content-safe-area-inset-top, 0px));
      padding-bottom: calc(env(safe-area-inset-bottom) + 16px);
      overscroll-behavior: none;
    }

    @supports (height: 100dvh) {
      .modal-map-section.fullscreen {
        height: 100dvh;
        min-height: 100dvh;
      }
    }

    /* FIXED: Map needs proper touch handling */
    #driverRouteMap {
      width: 100%;
      height: 100%;
      contain: layout style paint;
      transform: translateZ(0);
    }

    /* Map Controls */
    .map-expand-btn,
    .map-close-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      background: var(--surface);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: var(--text-primary);
      box-shadow: var(--shadow-md);
      transition: all 0.2s ease;
      z-index: 10;
      touch-action: manipulation;
      transform: translateZ(0);
    }

    .map-expand-btn:active,
    .map-close-btn:active {
      transform: scale(0.9) translateZ(0);
    }

    .map-close-btn {
      background: #ef4444;
      color: white;
    }

    /* Modal Header */
    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
      position: relative;
      background: var(--surface);
    }

    .close-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: var(--background);
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: var(--text-secondary);
      transition: all 0.2s ease;
      touch-action: manipulation;
    }

    .close-btn:active {
      transform: scale(0.9);
      background: var(--border);
    }

    .modal-driver-photo {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      object-fit: cover;
      background: var(--background);
      border: 2px solid var(--border);
      flex-shrink: 0;
    }

    .modal-driver-info {
      flex: 1;
      min-width: 0;
      padding-right: 40px;
    }

    .modal-driver-info h3 {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      letter-spacing: -0.3px;
    }

    .modal-driver-info p {
      font-size: 14px;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Modal Body - FIXED: Proper scrolling */
    .modal-body {
      padding: 0 20px 20px;
      max-height: calc(var(--tg-viewport-height, 85vh) - 370px);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }

    @supports (height: 100dvh) {
      .modal-body {
        max-height: calc(100dvh - 370px);
      }
    }

    .trip-section {
      margin-bottom: 20px;
    }

    .section-title-modal {
      font-size: 13px;
      font-weight: 700;
      color: var(--text-muted);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .route-display {
      background: var(--background);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 12px;
    }

    .route-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 12px;
    }

    .route-item:last-child {
      margin-bottom: 0;
    }

    .route-marker {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      flex-shrink: 0;
      margin-top: 4px;
    }

    .route-marker.from {
      background: var(--primary-green);
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
    }

    .route-marker.to {
      background: #ef4444;
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
    }

    .route-text {
      font-size: 15px;
      color: var(--text-primary);
      line-height: 1.5;
      flex: 1;
      word-wrap: break-word;
      font-weight: 500;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
      gap: 16px;
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      font-size: 15px;
      color: var(--text-secondary);
      flex-shrink: 0;
    }

    .detail-value {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      text-align: right;
    }

    .price-highlight {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary-green);
      letter-spacing: -0.5px;
    }

    .comment-section {
      background: var(--background);
      border-radius: var(--radius);
      padding: 14px;
      margin: 12px 0;
    }

    .comment-text {
      font-size: 15px;
      color: var(--text-primary);
      line-height: 1.5;
      word-wrap: break-word;
    }

    /* Contact Buttons */
    .contact-buttons {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }

    .contact-btn {
      flex: 1;
      background: var(--text-primary);
      color: white;
      border: none;
      border-radius: var(--radius);
      padding: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 15px;
      touch-action: manipulation;
      min-height: 52px;
      transform: translateZ(0);
    }

    .contact-btn.whatsapp {
      background: #25D366;
    }

    .contact-btn:active {
      transform: scale(0.97) translateZ(0);
    }

    /* Map Markers */
    .custom-marker {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      color: white;
      border: 3px solid white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      position: relative;
      z-index: 100;
      transform: translateZ(0);
      letter-spacing: -0.5px;
    }

    .custom-marker.pickup {
      background: var(--primary-green);
    }

    .custom-marker.dropoff {
      background: #ef4444;
    }

    /* Responsive */
    @media (max-width: 480px) {
      .header {
        top: calc(var(--tg-safe-area-inset-top, 0px) + var(--tg-content-safe-area-inset-top, 0px) + 12px);
        left: calc(env(safe-area-inset-left) + 12px);
        right: calc(env(safe-area-inset-right) + 12px);
        padding: 10px 14px;
      }

      .header-title {
        font-size: 16px;
      }

      .section-title {
        font-size: 24px;
      }

      .driver-card {
        padding: 14px;
      }

      .driver-name {
        font-size: 16px;
      }

      .price-amount {
        font-size: 18px;
      }
    }

    @media (orientation: landscape) and (max-height: 500px) {
      .modal-map-section {
        height: 140px;
      }
      
      .modal-body {
        max-height: calc(var(--tg-viewport-height, 100vh) - 230px);
      }
    }

    @media (prefers-reduced-motion: reduce) {
      * {
        transition: none !important;
        animation: none !important;
      }
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --background: #111827;
        --surface: #1f2937;
        --surface-hover: #2d3748;
        --text-primary: #f9fafb;
        --text-secondary: #d1d5db;
        --text-muted: #9ca3af;
        --border: #374151;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <button class="back-btn" onclick="goBack()" aria-label="–ù–∞–∑–∞–¥">‚Üê</button>
      <div class="header-title" data-text="available_drivers">–î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–æ–¥–∏—Ç–µ–ª–∏</div>
      <div class="header-controls">
        <div class="lang-switch">
          <button class="lang-btn active" onclick="setLanguage('ru')" id="lang-ru" aria-label="–†—É—Å—Å–∫–∏–π">RU</button>
          <button class="lang-btn" onclick="setLanguage('kz')" id="lang-kz" aria-label="“ö–∞–∑–∞“õ—à–∞">KZ</button>
        </div>
        <button class="refresh-btn" onclick="refreshDrivers()" title="–û–±–Ω–æ–≤–∏—Ç—å" aria-label="–û–±–Ω–æ–≤–∏—Ç—å">üîÑ</button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="drivers-section">
      <div class="section-header">
        <div class="section-title" data-text="available_drivers">–î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–æ–¥–∏—Ç–µ–ª–∏</div>
        <div class="drivers-count" id="driversCount" aria-label="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ">0</div>
      </div>
      
      <!-- Loading State -->
      <div class="loading-container" id="loadingState">
        <div class="loading-spinner" role="progressbar" aria-label="–ó–∞–≥—Ä—É–∑–∫–∞"></div>
        <div class="loading-text" data-text="searching_drivers">–ò—â–µ–º –≤–æ–¥–∏—Ç–µ–ª–µ–π...</div>
      </div>

      <!-- Drivers List -->
      <div id="driversList" style="display: none;" role="list"></div>

      <!-- Empty State -->
      <div class="empty-state" id="emptyState" style="display: none;">
        <div class="empty-icon">üöö</div>
        <div class="empty-title" data-text="no_drivers_found">–í–æ–¥–∏—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
        <div class="empty-message" data-text="no_drivers_message">
          –í –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π.<br>
          –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Action Button -->
  <div class="fab-container">
    <button class="fab" onclick="createNewTrip()" aria-label="–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –ø–æ–µ–∑–¥–∫—É">+</button>
  </div>

  <!-- Driver Modal - FIXED: Bottom Sheet -->
  <div class="driver-modal" id="driverModal" role="dialog" aria-modal="true" onclick="handleModalBackdropClick(event)">
    <div class="modal-content">
      <div class="modal-handle"></div>
      
      <!-- Map Section -->
      <div class="modal-map-section" id="mapSection">
        <div id="driverRouteMap" role="application" aria-label="–ö–∞—Ä—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–∞"></div>
        <button class="map-expand-btn" id="mapExpandBtn" onclick="expandMap(event)" 
                title="–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å" aria-label="–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å">‚õ∂</button>
        <button class="map-close-btn" id="mapCloseBtn" onclick="closeFullscreenMap()" 
                style="display: none;" title="–ó–∞–∫—Ä—ã—Ç—å" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      </div>

      <!-- Driver Header -->
      <div class="modal-header">
        <img id="modalDriverPhoto" src="" alt="" class="modal-driver-photo" 
             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzAiIGN5PSIzMCIgcj0iMzAiIGZpbGw9IiNmMGYwZjAiLz4KPHRleHQgeD0iMzAiIHk9IjM2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjE0IiBmaWxsPSIjOTk5Ij7igKI8L3RleHQ+Cjwvc3ZnPgo='">
        <div class="modal-driver-info">
          <h3 id="modalDriverName">–ò–º—è –≤–æ–¥–∏—Ç–µ–ª—è</h3>
          <p id="modalDriverVehicle">–¢–∏–ø —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞</p>
        </div>
        <button class="close-btn" onclick="closeDriverModal()" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      </div>
      
      <div class="modal-body">
        <!-- Route Display -->
        <div class="trip-section">
          <div class="section-title-modal">–ú–ê–†–®–†–£–¢</div>
          <div class="route-display">
            <div class="route-item">
              <div class="route-marker from"></div>
              <div class="route-text" id="modalFromAddress">–û—Ç–∫—É–¥–∞</div>
            </div>
            <div class="route-item">
              <div class="route-marker to"></div>
              <div class="route-text" id="modalToAddress">–ö—É–¥–∞</div>
            </div>
          </div>
        </div>

        <!-- Contact Section -->
        <div class="trip-section">
          <div class="section-title-modal">–°–í–Ø–ó–ê–¢–¨–°–Ø –° –í–û–î–ò–¢–ï–õ–ï–ú</div>
          <div class="contact-buttons">
            <button class="contact-btn" onclick="callDriver()" id="callBtn" aria-label="–ü–æ–∑–≤–æ–Ω–∏—Ç—å">
              üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å
            </button>
            <button class="contact-btn whatsapp" onclick="openWhatsApp()" id="whatsappBtn" aria-label="WhatsApp">
              üí¨ WhatsApp
            </button>
          </div>
        </div>

        <!-- Trip Details -->
        <div class="trip-section">
          <div class="section-title-modal">–î–ï–¢–ê–õ–ò –ü–û–ï–ó–î–ö–ò</div>
          <div class="detail-row">
            <span class="detail-label">–¶–µ–Ω–∞</span>
            <span class="detail-value price-highlight" id="modalPrice">0 ‚Ç∏</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">–í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è</span>
            <span class="detail-value" id="modalDeparture">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –≤–∞—Å</span>
            <span class="detail-value" id="modalDistance">- –∫–º</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">–í—Ä–µ–º—è –¥–æ –ø—Ä–∏–±—ã—Ç–∏—è</span>
            <span class="detail-value" id="modalETA">- –º–∏–Ω</span>
          </div>
        </div>

        <!-- Comment Section -->
        <div id="modalCommentSection" class="trip-section" style="display: none;">
          <div class="section-title-modal">–ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô –í–û–î–ò–¢–ï–õ–Ø</div>
          <div class="comment-section">
            <div class="comment-text" id="modalComment"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Translations
    const translations = {
      ru: {
        available_drivers: '–î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–æ–¥–∏—Ç–µ–ª–∏',
        searching_drivers: '–ò—â–µ–º –≤–æ–¥–∏—Ç–µ–ª–µ–π...',
        no_drivers_found: '–í–æ–¥–∏—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã',
        no_drivers_message: '–í –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π.<br>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.',
        small: '–ú–∞–ª—ã–π',
        medium: '–°—Ä–µ–¥–Ω–∏–π',
        large: '–ë–æ–ª—å—à–æ–π',
        refrigerator: '–†–µ—Ñ—Ä–∏–∂–µ—Ä–∞—Ç–æ—Ä',
        tow: '–≠–≤–∞–∫—É–∞—Ç–æ—Ä',
        any: '–õ—é–±–æ–π',
        km: '–∫–º',
        min: '–º–∏–Ω'
      },
      kz: {
        available_drivers: '“ö–æ–ª–∂–µ—Ç—ñ–º–¥—ñ –∂“Ø—Ä–≥—ñ–∑—É—à—ñ–ª–µ—Ä',
        searching_drivers: '–ñ“Ø—Ä–≥—ñ–∑—É—à—ñ–ª–µ—Ä–¥—ñ —ñ–∑–¥–µ—É–¥–µ...',
        no_drivers_found: '–ñ“Ø—Ä–≥—ñ–∑—É—à—ñ–ª–µ—Ä —Ç–∞–±—ã–ª–º–∞–¥—ã',
        no_drivers_message: '“ö–∞–∑—ñ—Ä–≥—ñ —É–∞“õ—ã—Ç—Ç–∞ “õ–æ–ª–∂–µ—Ç—ñ–º–¥—ñ –∂“Ø—Ä–≥—ñ–∑—É—à—ñ–ª–µ—Ä –∂–æ“õ.<br>–ë—ñ—Ä–Ω–µ—à–µ –º–∏–Ω—É—Ç—Ç–∞–Ω –∫–µ–π—ñ–Ω –∂–∞“£–∞—Ä—Ç—ã–ø –∫”©—Ä—ñ“£—ñ–∑.',
        small: '–ö—ñ—à—ñ',
        medium: '–û—Ä—Ç–∞—à–∞',
        large: '“Æ–ª–∫–µ–Ω',
        refrigerator: '–†–µ—Ñ—Ä–∏–∂–µ—Ä–∞—Ç–æ—Ä',
        tow: '–≠–≤–∞–∫—É–∞—Ç–æ—Ä',
        any: '–ö–µ–∑ –∫–µ–ª–≥–µ–Ω',
        km: '–∫–º',
        min: '–º–∏–Ω'
      }
    };

    // Global state
    let availableDrivers = [];
    let currentLanguage = 'ru';
    let selectedDriver = null;
    let driverRouteMap = null;
    let pickupMarker = null;
    let dropoffMarker = null;
    let isMapFullscreen = false;
    let isLoading = false;
    let loadAttempts = 0;
    const maxLoadAttempts = 3;
    
    // Store trip coordinates from URL
    let tripCoordinates = {
      fromLat: null,
      fromLon: null,
      toLat: null,
      toLon: null,
      fromAddress: null,
      toAddress: null
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ QazLine Driver List initializing...');
      
      setupTelegramWebApp();
      setupViewportHandling();
      loadTripCoordinates();
      loadDrivers();
      
      console.log('‚úÖ QazLine initialized');
    });

    // Setup Telegram WebApp
    function setupTelegramWebApp() {
      if (window.Telegram?.WebApp) {
        const tg = Telegram.WebApp;
        console.log('üì± Telegram WebApp detected');
        
        tg.ready();
        tg.expand();
        tg.disableVerticalSwipes();
        
        if (tg.colorScheme === 'dark') {
          document.body.setAttribute('data-theme', 'dark');
        }
        
        tg.onEvent('themeChanged', () => {
          document.body.setAttribute('data-theme', tg.colorScheme || 'light');
        });
        
        tg.onEvent('viewportChanged', handleViewportChange);
        
        console.log('‚úÖ Telegram WebApp configured');
      }
    }

    // Setup viewport handling
    function setupViewportHandling() {
      updateViewportVariables();
      
      window.addEventListener('resize', debounce(handleViewportChange, 100));
      window.addEventListener('orientationchange', () => {
        setTimeout(handleViewportChange, 200);
      });
      
      document.addEventListener('fullscreenchange', handleViewportChange);
      document.addEventListener('webkitfullscreenchange', handleViewportChange);
      
      console.log('üìê Viewport handling configured');
    }

    function handleViewportChange() {
      updateViewportVariables();
      
      if (isMapFullscreen && driverRouteMap) {
        setTimeout(() => {
          try {
            if (driverRouteMap.container?.fitToViewport) {
              driverRouteMap.container.fitToViewport();
            }
          } catch (error) {
            console.warn('‚ö†Ô∏è Map resize warning:', error);
          }
        }, 100);
      }
      
      updateModalHeights();
    }

    function updateViewportVariables() {
      const vh = window.Telegram?.WebApp?.viewportHeight || window.innerHeight;
      const stableVh = window.Telegram?.WebApp?.viewportStableHeight || vh;
      const safeAreaTop = window.Telegram?.WebApp?.safeAreaInset?.top || 0;
      const contentSafeAreaTop = window.Telegram?.WebApp?.contentSafeAreaInset?.top || 0;
      
      document.documentElement.style.setProperty('--tg-viewport-height', `${vh}px`);
      document.documentElement.style.setProperty('--tg-viewport-stable-height', `${stableVh}px`);
      document.documentElement.style.setProperty('--tg-safe-area-inset-top', `${safeAreaTop}px`);
      document.documentElement.style.setProperty('--tg-content-safe-area-inset-top', `${contentSafeAreaTop}px`);
      
      console.log(`üìê Viewport: ${vh}px, Safe: ${safeAreaTop}px, Content: ${contentSafeAreaTop}px`);
    }

    function updateModalHeights() {
      const vh = window.Telegram?.WebApp?.viewportHeight || window.innerHeight;
      const safeTop = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--tg-safe-area-inset-top') || '0');
      const contentTop = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--tg-content-safe-area-inset-top') || '0');
      
      const modalContent = document.querySelector('.modal-content');
      const modalBody = document.querySelector('.modal-body');
      
      if (modalContent) {
        const modalMaxHeight = vh - (safeTop + contentTop + 60);
        modalContent.style.maxHeight = `${modalMaxHeight}px`;
      }
      
      if (modalBody) {
        const bodyMaxHeight = vh - 370;
        modalBody.style.maxHeight = `${bodyMaxHeight}px`;
      }
    }

    // Load trip coordinates from URL
    function loadTripCoordinates() {
      const urlParams = new URLSearchParams(window.location.search);
      
      tripCoordinates.fromLat = parseFloat(urlParams.get('from_lat')) || 43.238949;
      tripCoordinates.fromLon = parseFloat(urlParams.get('from_lon')) || 76.889709;
      tripCoordinates.toLat = parseFloat(urlParams.get('to_lat')) || 43.238949;
      tripCoordinates.toLon = parseFloat(urlParams.get('to_lon')) || 76.889709;
      tripCoordinates.fromAddress = urlParams.get('from_address') || null;
      tripCoordinates.toAddress = urlParams.get('to_address') || null;
      
      console.log('üìç Trip coordinates loaded:', tripCoordinates);
    }

    // Language switching
    function setLanguage(lang) {
      currentLanguage = lang;
      
      document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
      const langBtn = document.getElementById('lang-' + lang);
      if (langBtn) langBtn.classList.add('active');
      
      document.querySelectorAll('[data-text]').forEach(element => {
        const key = element.getAttribute('data-text');
        if (translations[lang]?.[key]) {
          element.innerHTML = translations[lang][key];
        }
      });
      
      if (availableDrivers.length > 0) {
        displayDrivers(availableDrivers);
      }
      
      console.log(`üåç Language: ${lang}`);
    }

    // Load drivers
    async function loadDrivers() {
      if (isLoading) return;
      
      isLoading = true;
      loadAttempts++;
      
      try {
        showLoadingState();
        
        const params = new URLSearchParams({
          from_lat: tripCoordinates.fromLat,
          from_lon: tripCoordinates.fromLon,
          to_lat: tripCoordinates.toLat,
          to_lon: tripCoordinates.toLon,
          radius: 50,
          limit: 20
        });
        
        console.log('üîç Loading drivers...');
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);
        
        const response = await fetch(`/api/driver-list?${params.toString()}`, {
          signal: controller.signal,
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          }
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success && result.data?.drivers) {
          availableDrivers = result.data.drivers;
          loadAttempts = 0;
          
          console.log(`‚úÖ Found ${availableDrivers.length} drivers`);
          displayDrivers(availableDrivers);
        } else {
          throw new Error(result.message || 'Invalid response');
        }
        
      } catch (error) {
        console.error('‚ùå Error loading drivers:', error);
        
        if (error.name === 'AbortError') {
          showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
        } else if (loadAttempts < maxLoadAttempts) {
          console.log(`üîÑ Retry ${loadAttempts}/${maxLoadAttempts}`);
          setTimeout(() => {
            isLoading = false;
            loadDrivers();
          }, 2000 * loadAttempts);
          return;
        } else {
          showEmptyState();
          showError(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`);
        }
      } finally {
        isLoading = false;
      }
    }

    // Display drivers
    function displayDrivers(drivers) {
      hideLoadingState();
      
      const driversList = document.getElementById('driversList');
      const driversCount = document.getElementById('driversCount');
      
      if (!drivers || drivers.length === 0) {
        showEmptyState();
        return;
      }
      
      driversCount.textContent = drivers.length;
      
      const fragment = document.createDocumentFragment();
      
      drivers.forEach((driver, index) => {
        const card = createDriverCard(driver, index);
        fragment.appendChild(card);
      });
      
      driversList.innerHTML = '';
      driversList.appendChild(fragment);
      driversList.style.display = 'block';
      
      console.log(`‚úÖ Displayed ${drivers.length} drivers`);
    }

    // Create driver card
    function createDriverCard(driver, index) {
      const distance = driver.distance_km || driver.distance_to_pickup_km || 0;
      const truckTypeName = translations[currentLanguage][driver.truck_type] || translations[currentLanguage]['any'];
      const startCity = driver.start_city || extractCityFromAddress(driver.from_address) || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
      const endCity = driver.end_city || extractCityFromAddress(driver.to_address) || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
      const driverPrice = driver.price || '–î–æ–≥–æ–≤–æ—Ä–Ω–∞—è';
      const etaMin = driver.eta_min || Math.ceil(distance * 2);
      
      const card = document.createElement('div');
      card.className = 'driver-card';
      card.setAttribute('role', 'listitem');
      card.setAttribute('tabindex', '0');
      
      card.innerHTML = `
        <div class="driver-header">
          <img src="/ava/${encodeURIComponent(driver.profile_photo || 'default.jpg')}" 
               alt="${escapeHtml(driver.first_name)} ${escapeHtml(driver.last_name)}"
               class="driver-photo"
               loading="lazy"
               onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTYiIGhlaWdodD0iNTYiIHZpZXdCb3g9IjAgMCA1NiA1NiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjgiIGN5PSIyOCIgcj0iMjgiIGZpbGw9IiNmMGYwZjAiLz4KPHRleHQgeD0iMjgiIHk9IjMyIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjE0IiBmaWxsPSIjOTk5Ij7igKI8L3RleHQ+Cjwvc3ZnPgo='">
          <div class="driver-info">
            <div class="driver-name">${escapeHtml(driver.first_name)} ${escapeHtml(driver.last_name)}</div>
            <div class="driver-vehicle">${escapeHtml(truckTypeName)}</div>
          </div>
          <div class="driver-price">
            <div class="price-amount">${escapeHtml(driverPrice)} ‚Ç∏</div>
          </div>
        </div>
        
        <div class="driver-details">
          <div class="distance-info">
            <span>üìç ${distance.toFixed(1)} ${translations[currentLanguage]['km']}</span>
            <span>‚Ä¢</span>
            <span>üïê ${etaMin} ${translations[currentLanguage]['min']}</span>
          </div>
          <div class="route-info">
            ${escapeHtml(startCity)} ‚Üí ${escapeHtml(endCity)}
          </div>
        </div>
      `;
      
      card.addEventListener('click', () => showDriverDetails(driver.id));
      card.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          showDriverDetails(driver.id);
        }
      });
      
      return card;
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function extractCityFromAddress(address) {
      if (!address || address === '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω') {
        return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
      }

      const cities = [
        '–ê–ª–º–∞—Ç—ã', 'Almaty', '–ê—Å—Ç–∞–Ω–∞', '–ù—É—Ä-–°—É–ª—Ç–∞–Ω', 'Nur-Sultan',
        '–®—ã–º–∫–µ–Ω—Ç', 'Shymkent', '–ö–∞—Ä–∞–≥–∞–Ω–¥–∞', 'Karaganda', '–ê–∫—Ç–æ–±–µ', 'Aktobe',
        '–¢–∞—Ä–∞–∑', 'Taraz', '–ü–∞–≤–ª–æ–¥–∞—Ä', 'Pavlodar', '–£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫', 'Ust-Kamenogorsk',
        '–°–µ–º–µ–π', 'Semey', '–ê—Ç—ã—Ä–∞—É', 'Atyrau', '–ö–æ—Å—Ç–∞–Ω–∞–π', 'Kostanay',
        '–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫', 'Petropavlovsk', '–ê–∫—Ç–∞—É', 'Aktau'
      ];

      const addressUpper = address.toUpperCase();
      
      for (const city of cities) {
        if (addressUpper.includes(city.toUpperCase())) {
          return city;
        }
      }

      const parts = address.split(',');
      if (parts.length > 0) {
        const firstPart = parts[0].trim();
        if (firstPart.length > 2 && firstPart.length < 50) {
          return firstPart;
        }
      }

      return address.length > 20 ? address.substring(0, 17) + '...' : address;
    }

    // Show driver details
    function showDriverDetails(driverId) {
      const driver = availableDrivers.find(d => d.id === driverId);
      if (!driver) {
        console.error('‚ùå Driver not found:', driverId);
        showError('–í–æ–¥–∏—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
      }
      
      selectedDriver = driver;
      
      try {
        updateModalContent(driver);
        
        const modal = document.getElementById('driverModal');
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        
        setTimeout(() => {
          initYandexDriverMap(driver);
        }, 100);
        
        console.log(`üìã Showing driver: ${driver.first_name} ${driver.last_name}`);
        
      } catch (error) {
        console.error('‚ùå Error showing driver:', error);
        showError('–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è');
      }
    }

    // Update modal content
    function updateModalContent(driver) {
      const elements = {
        modalDriverPhoto: document.getElementById('modalDriverPhoto'),
        modalDriverName: document.getElementById('modalDriverName'),
        modalDriverVehicle: document.getElementById('modalDriverVehicle'),
        modalFromAddress: document.getElementById('modalFromAddress'),
        modalToAddress: document.getElementById('modalToAddress'),
        modalPrice: document.getElementById('modalPrice'),
        modalDistance: document.getElementById('modalDistance'),
        modalETA: document.getElementById('modalETA'),
        modalDeparture: document.getElementById('modalDeparture'),
        modalCommentSection: document.getElementById('modalCommentSection'),
        modalComment: document.getElementById('modalComment')
      };
      
      for (const [key, element] of Object.entries(elements)) {
        if (!element) {
          console.warn(`‚ö†Ô∏è Missing element: ${key}`);
          return;
        }
      }
      
      elements.modalDriverPhoto.src = `/ava/${encodeURIComponent(driver.profile_photo || 'default.jpg')}`;
      elements.modalDriverName.textContent = `${driver.first_name} ${driver.last_name}`;
      elements.modalDriverVehicle.textContent = translations[currentLanguage][driver.truck_type] || translations[currentLanguage]['any'];
      elements.modalFromAddress.textContent = driver.from_address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω';
      elements.modalToAddress.textContent = driver.to_address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω';
      elements.modalPrice.textContent = `${driver.price || '–î–æ–≥–æ–≤–æ—Ä–Ω–∞—è'} ‚Ç∏`;
      
      const distance = driver.distance_km || driver.distance_to_pickup_km || 0;
      elements.modalDistance.textContent = `${distance.toFixed(1)} ${translations[currentLanguage]['km']}`;
      elements.modalETA.textContent = `${driver.eta_min || Math.ceil(distance * 2)} ${translations[currentLanguage]['min']}`;
      
      let departureText = '–í—Ä–µ–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ';
      if (driver.departure_time) {
        try {
          const date = new Date(driver.departure_time);
          if (!isNaN(date.getTime())) {
            departureText = date.toLocaleString(currentLanguage === 'ru' ? 'ru-RU' : 'kk-KZ', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
          }
        } catch (e) {
          departureText = driver.departure_time.toString();
        }
      }
      elements.modalDeparture.textContent = departureText;
      
      if (driver.comment && driver.comment.trim()) {
        elements.modalComment.textContent = driver.comment.trim();
        elements.modalCommentSection.style.display = 'block';
      } else {
        elements.modalCommentSection.style.display = 'none';
      }
    }

    // Initialize Yandex Maps
    async function initYandexDriverMap(driver) {
      cleanupDriverMap();
      
      const coords = validateAndParseCoordinates(driver);
      if (!coords) {
        showMapError();
        return;
      }
      
      const { pickupCoords, dropoffCoords } = coords;
      
      console.log('üó∫Ô∏è Initializing map:', { pickupCoords, dropoffCoords });
      
      try {
        await ymaps3.ready;
        
        const { YMap, YMapDefaultSchemeLayer, YMapDefaultFeaturesLayer, YMapMarker } = ymaps3;
        
        driverRouteMap = new YMap(
          document.getElementById('driverRouteMap'),
          {
            location: {
              center: pickupCoords,
              zoom: 12
            },
            theme: document.body.getAttribute('data-theme') === 'dark' ? 'dark' : 'light',
            behaviors: ['drag', 'pinch', 'dblClick', 'mouseWheel']
          }
        );
        
        driverRouteMap.addChild(new YMapDefaultSchemeLayer({ 
          theme: document.body.getAttribute('data-theme') === 'dark' ? 'dark' : 'light'
        }));
        driverRouteMap.addChild(new YMapDefaultFeaturesLayer());
        
        createMarkers(pickupCoords, dropoffCoords);
        
        const bounds = calculateBounds([pickupCoords, dropoffCoords]);
        
        setTimeout(() => {
          if (driverRouteMap?.setLocation) {
            driverRouteMap.setLocation({
              bounds: bounds,
              duration: 800
            });
          }
        }, 300);
        
        console.log('‚úÖ Map initialized');
        
      } catch (error) {
        console.error('‚ùå Map error:', error);
        showMapError();
      }
    }

    function validateAndParseCoordinates(driver) {
      const fromLat = parseFloat(driver.from_lat || driver.pickup_lat);
      const fromLon = parseFloat(driver.from_lon || driver.pickup_lon);
      const toLat = parseFloat(driver.to_lat || driver.dropoff_lat);
      const toLon = parseFloat(driver.to_lon || driver.dropoff_lon);
      
      const isValid = (lat, lon) => {
        return !isNaN(lat) && !isNaN(lon) && 
               Math.abs(lat) <= 90 && Math.abs(lon) <= 180 &&
               lat !== 0 && lon !== 0;
      };
      
      const pickupCoords = isValid(fromLat, fromLon) 
        ? [fromLon, fromLat] 
        : [76.889709, 43.238949];
        
      const dropoffCoords = isValid(toLat, toLon) 
        ? [toLon, toLat] 
        : [76.920000, 43.260000];
      
      console.log('üìç Coordinates:', { pickupCoords, dropoffCoords });
      
      return { pickupCoords, dropoffCoords };
    }

    function createMarkers(pickupCoords, dropoffCoords) {
      try {
        const { YMapMarker } = ymaps3;
        
        const pickupElement = document.createElement('div');
        pickupElement.className = 'custom-marker pickup';
        pickupElement.innerHTML = 'A';
        
        pickupMarker = new YMapMarker(
          { coordinates: pickupCoords, draggable: false },
          pickupElement
        );
        
        driverRouteMap.addChild(pickupMarker);
        
        const dropoffElement = document.createElement('div');
        dropoffElement.className = 'custom-marker dropoff';
        dropoffElement.innerHTML = 'B';
        
        dropoffMarker = new YMapMarker(
          { coordinates: dropoffCoords, draggable: false },
          dropoffElement
        );
        
        driverRouteMap.addChild(dropoffMarker);
        
        console.log('‚úÖ Markers created');
        
      } catch (error) {
        console.error('‚ùå Marker error:', error);
      }
    }

    function showMapError() {
      const mapContainer = document.getElementById('driverRouteMap');
      if (mapContainer) {
        mapContainer.innerHTML = `
          <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; 
                      height: 100%; color: var(--text-secondary); font-size: 14px; background: var(--background); padding: 20px; text-align: center;">
            <div style="font-size: 32px; margin-bottom: 8px;">üó∫Ô∏è</div>
            <div style="font-weight: 600; margin-bottom: 4px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã</div>
            <div style="opacity: 0.7;">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</div>
          </div>
        `;
      }
    }

    function cleanupDriverMap() {
      if (driverRouteMap) {
        try {
          if (pickupMarker) {
            driverRouteMap.removeChild(pickupMarker);
            pickupMarker = null;
          }
          if (dropoffMarker) {
            driverRouteMap.removeChild(dropoffMarker);
            dropoffMarker = null;
          }
          if (driverRouteMap.destroy) {
            driverRouteMap.destroy();
          }
          console.log('üó∫Ô∏è Map cleaned up');
        } catch (error) {
          console.warn('‚ö†Ô∏è Cleanup warning:', error);
        }
      }
      
      driverRouteMap = null;
    }

    function calculateBounds(coordinates) {
      let minLon = Math.min(...coordinates.map(c => c[0]));
      let maxLon = Math.max(...coordinates.map(c => c[0]));
      let minLat = Math.min(...coordinates.map(c => c[1]));
      let maxLat = Math.max(...coordinates.map(c => c[1]));
      
      const lonSpan = maxLon - minLon;
      const latSpan = maxLat - minLat;
      const lonPadding = Math.max(lonSpan * 0.3, 0.01);
      const latPadding = Math.max(latSpan * 0.3, 0.01);
      
      return [
        [minLon - lonPadding, minLat - latPadding],
        [maxLon + lonPadding, maxLat + latPadding]
      ];
    }

    // Expand map
    function expandMap(event) {
      event.stopPropagation();
      
      if (!driverRouteMap) {
        console.warn('‚ö†Ô∏è Cannot expand - map not initialized');
        return;
      }
      
      const mapSection = document.getElementById('mapSection');
      const expandBtn = document.getElementById('mapExpandBtn');
      const closeBtn = document.getElementById('mapCloseBtn');
      
      if (!mapSection || !expandBtn || !closeBtn) return;
      
      mapSection.classList.add('fullscreen');
      expandBtn.style.display = 'none';
      closeBtn.style.display = 'flex';
      isMapFullscreen = true;
      
      updateViewportVariables();
      
      setTimeout(() => {
        try {
          if (driverRouteMap?.container?.fitToViewport) {
            driverRouteMap.container.fitToViewport();
            console.log('üîç Map expanded');
          }
        } catch (error) {
          console.warn('‚ö†Ô∏è Resize warning:', error);
        }
      }, 300);
      
      document.addEventListener('keydown', handleEscapeKey);
    }

    function handleEscapeKey(e) {
      if (e.key === 'Escape' && isMapFullscreen) {
        closeFullscreenMap();
      }
    }

    // Close fullscreen map
    function closeFullscreenMap() {
      const mapSection = document.getElementById('mapSection');
      const expandBtn = document.getElementById('mapExpandBtn');
      const closeBtn = document.getElementById('mapCloseBtn');
      
      if (!mapSection || !expandBtn || !closeBtn) return;
      
      mapSection.classList.remove('fullscreen');
      expandBtn.style.display = 'flex';
      closeBtn.style.display = 'none';
      isMapFullscreen = false;
      
      updateViewportVariables();
      
      setTimeout(() => {
        if (driverRouteMap?.container?.fitToViewport) {
          try {
            driverRouteMap.container.fitToViewport();
            console.log('üì± Map restored');
          } catch (error) {
            console.warn('‚ö†Ô∏è Resize warning:', error);
          }
        }
      }, 300);
      
      document.removeEventListener('keydown', handleEscapeKey);
    }

    // Close modal
    function closeDriverModal() {
      const modal = document.getElementById('driverModal');
      if (!modal) return;
      
      modal.classList.remove('active');
      document.body.style.overflow = '';
      
      cleanupDriverMap();
      
      if (isMapFullscreen) {
        closeFullscreenMap();
      }
      
      selectedDriver = null;
      
      console.log('‚ùå Modal closed');
    }

    // Handle modal backdrop click
    function handleModalBackdropClick(event) {
      if (event.target.matches('.driver-modal')) {
        closeDriverModal();
      }
    }

    // Call driver
    function callDriver() {
      if (!selectedDriver) {
        console.error('‚ùå No driver selected');
        return;
      }
      
      const contactNumber = selectedDriver.contact_number || selectedDriver.contact;
      if (!contactNumber) {
        showError('–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –Ω–µ —É–∫–∞–∑–∞–Ω');
        return;
      }
      
      const cleanPhone = contactNumber.replace(/[^\d+]/g, '');
      if (cleanPhone.length < 10) {
        showError('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä');
        return;
      }
      
      console.log(`üìû Calling: ${cleanPhone}`);
      
      try {
        window.open(`tel:${cleanPhone}`, '_self');
      } catch (error) {
        console.error('‚ùå Call error:', error);
        showError('–û—à–∏–±–∫–∞');
      }
    }

    // Open WhatsApp
    function openWhatsApp() {
      if (!selectedDriver) {
        console.error('‚ùå No driver selected');
        return;
      }
      
      const contactNumber = selectedDriver.contact_number || selectedDriver.contact;
      if (!contactNumber) {
        showError('–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –Ω–µ —É–∫–∞–∑–∞–Ω');
        return;
      }
      
      const cleanPhone = contactNumber.replace(/[^\d]/g, '');
      if (cleanPhone.length < 10) {
        showError('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä');
        return;
      }
      
      let formattedPhone = cleanPhone;
      if (formattedPhone.startsWith('8')) {
        formattedPhone = '7' + formattedPhone.slice(1);
      }
      if (!formattedPhone.startsWith('7')) {
        formattedPhone = '7' + formattedPhone;
      }
      
      const driverName = `${selectedDriver.first_name} ${selectedDriver.last_name}`;
      const fromAddress = tripCoordinates.fromAddress || selectedDriver.from_address || '—É–∫–∞–∑–∞–Ω–Ω–æ–π —Ç–æ—á–∫–∏ –ê';
      const toAddress = tripCoordinates.toAddress || selectedDriver.to_address || '—É–∫–∞–∑–∞–Ω–Ω–æ–π —Ç–æ—á–∫–∏ –ë';
      
      const message = encodeURIComponent(
        `–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, ${driverName}! –Ø –Ω–∞—à–µ–ª –≤–∞—à –Ω–æ–º–µ—Ä –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ QazLine.\n\n` +
        `–ú–Ω–µ –Ω—É–∂–Ω–∞ –≥—Ä—É–∑–æ–ø–µ—Ä–µ–≤–æ–∑–∫–∞:\n` +
        `üìç –û—Ç–∫—É–¥–∞: ${fromAddress}\n` +
        `üìç –ö—É–¥–∞: ${toAddress}\n\n` +
        `–¶–µ–Ω–∞: ${selectedDriver.price || '–ø–æ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏'} ‚Ç∏\n\n` +
        `–ü—Ä–æ—à—É —Å–≤—è–∑–∞—Ç—å—Å—è —Å–æ –º–Ω–æ–π –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π.`
      );
      
      const whatsappUrl = `https://wa.me/${formattedPhone}?text=${message}`;
      
      console.log(`üí¨ WhatsApp: ${formattedPhone}`);
      
      try {
        window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
      } catch (error) {
        console.error('‚ùå WhatsApp error:', error);
        showError('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è WhatsApp');
      }
    }

    // Create new trip
    function createNewTrip() {
      console.log('‚ûï Creating new trip...');
      window.location.href = '/delivery';
    }

    // State management
    function showLoadingState() {
      const elements = {
        loadingState: document.getElementById('loadingState'),
        driversList: document.getElementById('driversList'),
        emptyState: document.getElementById('emptyState')
      };
      
      if (elements.loadingState) elements.loadingState.style.display = 'flex';
      if (elements.driversList) elements.driversList.style.display = 'none';
      if (elements.emptyState) elements.emptyState.style.display = 'none';
    }

    function hideLoadingState() {
      const loadingState = document.getElementById('loadingState');
      if (loadingState) loadingState.style.display = 'none';
    }

    function showEmptyState() {
      hideLoadingState();
      
      const elements = {
        emptyState: document.getElementById('emptyState'),
        driversList: document.getElementById('driversList'),
        driversCount: document.getElementById('driversCount')
      };
      
      if (elements.emptyState) elements.emptyState.style.display = 'block';
      if (elements.driversList) elements.driversList.style.display = 'none';
      if (elements.driversCount) elements.driversCount.textContent = '0';
    }

    function showError(message) {
      console.error('üö® Error:', message);
      
      if (window.Telegram?.WebApp) {
        Telegram.WebApp.showAlert(message);
      } else {
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
          background: #ef4444; color: white; padding: 14px 24px; border-radius: 12px;
          font-size: 14px; font-weight: 600; z-index: 10000; max-width: 90%;
          box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => notification.remove(), 5000);
      }
    }

    // Navigation
    function goBack() {
      console.log('‚¨ÖÔ∏è Going back...');
      
      if (window.Telegram?.WebApp) {
        Telegram.WebApp.close();
      } else if (window.history.length > 1) {
        window.history.back();
      } else {
        window.location.href = '/';
      }
    }

    function refreshDrivers() {
      console.log('üîÑ Refreshing...');
      
      loadAttempts = 0;
      availableDrivers = [];
      
      const refreshBtn = document.querySelector('.refresh-btn');
      if (refreshBtn) {
        refreshBtn.style.animation = 'spin 0.5s linear';
        setTimeout(() => refreshBtn.style.animation = '', 500);
      }
      
      loadDrivers();
    }

    // Utility
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Event listeners
    document.addEventListener('click', (e) => {
      if (e.target.matches('.driver-modal')) {
        closeDriverModal();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (isMapFullscreen) {
          closeFullscreenMap();
        } else if (selectedDriver) {
          closeDriverModal();
        }
      }
    });

    // Auto-refresh
    let autoRefreshInterval = setInterval(() => {
      if (document.visibilityState === 'visible' && !isLoading) {
        console.log('üîÑ Auto-refresh');
        refreshDrivers();
      }
    }, 30000);

    // Cleanup
    window.addEventListener('beforeunload', () => {
      if (autoRefreshInterval) clearInterval(autoRefreshInterval);
      cleanupDriverMap();
      document.removeEventListener('keydown', handleEscapeKey);
    });

    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible' && !isLoading && availableDrivers.length === 0) {
        loadDrivers();
      }
    });

    console.log('üöÄ QazLine Driver List loaded');
  </script>
</body>
</html>