<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>–î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–æ–¥–∏—Ç–µ–ª–∏</title>
  
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://api-maps.yandex.ru/v3/?apikey=8a3e4da0-9ef2-4176-9203-e7014c1dba6f&lang=ru_RU"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      min-height: 100vh;
      color: #333;
    }

    /* Header */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: white;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      padding: env(safe-area-inset-top, 12px) 16px 12px;
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .back-btn {
      background: #f0f0f0;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      color: #333;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .back-btn:hover {
      background: #e0e0e0;
    }

    .header-title {
      font-size: 18px;
      font-weight: 600;
      text-align: center;
      flex: 1;
      color: #333;
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .lang-switch {
      background: #f0f0f0;
      border-radius: 20px;
      padding: 2px;
      display: flex;
    }

    .lang-btn {
      padding: 6px 12px;
      border: none;
      background: transparent;
      color: #666;
      border-radius: 18px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .lang-btn.active {
      background: white;
      color: #333;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .refresh-btn {
      background: #f0f0f0;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      color: #333;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .refresh-btn:hover {
      background: #e0e0e0;
      transform: rotate(180deg);
    }

    /* Main Content */
    .main-content {
      padding-top: 70px;
      padding-bottom: 20px;
    }

    /* Drivers Section */
    .drivers-section {
      margin: 16px;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .section-title {
      font-size: 24px;
      font-weight: 700;
      color: #333;
    }

    .drivers-count {
      background: #000;
      color: white;
      border-radius: 12px;
      padding: 8px 12px;
      font-size: 14px;
      font-weight: 600;
    }

    /* Driver Cards - Uber Style */
    .driver-card {
      background: white;
      border-radius: 12px;
      margin-bottom: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid #e0e0e0;
      position: relative;
    }

    .driver-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .driver-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 12px;
    }

    .driver-photo {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      background: #f0f0f0;
    }

    .driver-info {
      flex: 1;
    }

    .driver-name {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 2px;
      color: #333;
    }

    .driver-vehicle {
      font-size: 14px;
      color: #666;
    }

    .driver-price {
      text-align: right;
    }

    .price-amount {
      font-size: 18px;
      font-weight: 700;
      color: #000;
    }

    .driver-details {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #f0f0f0;
    }

    .distance-info {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
      color: #666;
    }

    .route-info {
      font-size: 12px;
      color: #999;
    }

    /* Loading State */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 50vh;
      padding: 40px 20px;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #f0f0f0;
      border-top: 3px solid #000;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 16px;
      color: #666;
      text-align: center;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }

    .empty-icon {
      font-size: 60px;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    .empty-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #333;
    }

    .empty-message {
      font-size: 14px;
      color: #666;
      line-height: 1.5;
    }

    /* Driver Detail Modal - BIGGER with Map at Top */
    .driver-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 10px;
    }

    .driver-modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      width: 100%;
      max-width: 500px; /* BIGGER */
      max-height: 95vh;
      border-radius: 20px;
      overflow: hidden;
      position: relative;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    }

    /* Map at Top - Full Width */
    .modal-map-section {
      position: relative;
      height: 250px;
      width: 100%;
      background: #f0f0f0;
    }

    .modal-map-section.fullscreen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      height: 100vh;
      z-index: 3000;
      border-radius: 0;
    }

    #driverRouteMap {
      width: 100%;
      height: 100%;
    }

    /* Map Controls */
    .map-expand-btn,
    .map-close-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: #333;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      transition: all 0.2s ease;
      z-index: 10;
    }

    .map-expand-btn:hover,
    .map-close-btn:hover {
      background: #f0f0f0;
      transform: scale(1.05);
    }

    .map-close-btn {
      background: #ef4444;
      color: white;
    }

    .map-close-btn:hover {
      background: #dc2626;
    }

    /* Modal Header */
    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      align-items: center;
      gap: 16px;
      position: relative;
      background: white;
    }

    .close-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background: #f5f5f5;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: #666;
      transition: all 0.2s ease;
    }

    .close-btn:hover {
      background: #e0e0e0;
    }

    .modal-driver-photo {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      background: #f0f0f0;
      border: 3px solid #f0f0f0;
    }

    .modal-driver-info h3 {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
    }

    .modal-driver-info p {
      font-size: 14px;
      color: #666;
    }

    .modal-body {
      padding: 0 20px 20px;
      max-height: calc(95vh - 370px); /* Account for map + header */
      overflow-y: auto;
    }

    .trip-section {
      margin-bottom: 20px;
    }

    .section-title-modal {
      font-size: 14px;
      font-weight: 600;
      color: #666;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .route-display {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
    }

    .route-item {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .route-item:last-child {
      margin-bottom: 0;
    }

    .route-marker {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .route-marker.from {
      background: #10b981;
    }

    .route-marker.to {
      background: #ef4444;
    }

    .route-text {
      font-size: 14px;
      color: #333;
      line-height: 1.4;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      font-size: 14px;
      color: #666;
    }

    .detail-value {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }

    .price-highlight {
      font-size: 18px;
      font-weight: 700;
      color: #10b981;
    }

    .comment-section {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 12px;
      margin: 12px 0;
    }

    .comment-text {
      font-size: 14px;
      color: #333;
      line-height: 1.4;
    }

    /* Contact Buttons - Prominent */
    .contact-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }

    .contact-btn {
      flex: 1;
      background: #000;
      color: white;
      border: none;
      border-radius: 12px;
      padding: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 14px;
    }

    .contact-btn.whatsapp {
      background: #25D366;
    }

    .contact-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .contact-btn:active {
      transform: translateY(0);
    }

    /* Yandex Map Markers */
    .yandex-marker-a,
    .yandex-marker-b {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      color: white;
      border: 4px solid white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      position: relative;
      z-index: 100;
    }

    .yandex-marker-a {
      background: #10b981; /* Green for pickup */
    }

    .yandex-marker-b {
      background: #ef4444; /* Red for dropoff */
    }

    /* Responsive */
    @media (max-width: 480px) {
      .modal-content {
        margin: 5px;
        width: calc(100% - 10px);
        max-height: 98vh;
        max-width: none;
      }

      .contact-buttons {
        flex-direction: column;
        gap: 8px;
      }

      .modal-map-section {
        height: 200px;
      }

      .modal-body {
        max-height: calc(98vh - 320px);
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <button class="back-btn" onclick="goBack()">‚Üê</button>
      <div class="header-title" data-text="available_drivers">–î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–æ–¥–∏—Ç–µ–ª–∏</div>
      <div class="header-controls">
        <div class="lang-switch">
          <button class="lang-btn active" onclick="setLanguage('ru')" id="lang-ru">RU</button>
          <button class="lang-btn" onclick="setLanguage('kz')" id="lang-kz">KZ</button>
        </div>
        <button class="refresh-btn" onclick="refreshDrivers()" title="–û–±–Ω–æ–≤–∏—Ç—å">üîÑ</button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Drivers Section -->
    <div class="drivers-section">
      <div class="section-header">
        <div class="section-title" data-text="available_drivers">–î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–æ–¥–∏—Ç–µ–ª–∏</div>
        <div class="drivers-count" id="driversCount">0</div>
      </div>
      
      <!-- Loading State -->
      <div class="loading-container" id="loadingState">
        <div class="loading-spinner"></div>
        <div class="loading-text" data-text="searching_drivers">–ò—â–µ–º –≤–æ–¥–∏—Ç–µ–ª–µ–π...</div>
      </div>

      <!-- Drivers List -->
      <div id="driversList" style="display: none;"></div>

      <!-- Empty State -->
      <div class="empty-state" id="emptyState" style="display: none;">
        <div class="empty-icon">üöö</div>
        <div class="empty-title" data-text="no_drivers_found">–í–æ–¥–∏—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
        <div class="empty-message" data-text="no_drivers_message">
          –í –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π.<br>
          –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.
        </div>
      </div>
    </div>
  </div>

  <!-- Driver Detail Modal -->
  <div class="driver-modal" id="driverModal">
    <div class="modal-content">
      
      <!-- Map Section at Top -->
      <div class="modal-map-section" id="mapSection">
        <div id="driverRouteMap"></div>
        <button class="map-expand-btn" id="mapExpandBtn" onclick="expandMap()">‚õ∂</button>
        <button class="map-close-btn" id="mapCloseBtn" onclick="closeFullscreenMap()" style="display: none;">‚úï</button>
      </div>

      <!-- Driver Header -->
      <div class="modal-header">
        <img id="modalDriverPhoto" src="" alt="" class="modal-driver-photo">
        <div class="modal-driver-info">
          <h3 id="modalDriverName">–ò–º—è –≤–æ–¥–∏—Ç–µ–ª—è</h3>
          <p id="modalDriverVehicle">–¢–∏–ø —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞</p>
        </div>
        <button class="close-btn" onclick="closeDriverModal()">‚úï</button>
      </div>
      
      <div class="modal-body">
        <!-- Route Display -->
        <div class="trip-section">
          <div class="section-title-modal">–ú–∞—Ä—à—Ä—É—Ç</div>
          <div class="route-display">
            <div class="route-item">
              <div class="route-marker from"></div>
              <div class="route-text" id="modalFromAddress">–û—Ç–∫—É–¥–∞</div>
            </div>
            <div class="route-item">
              <div class="route-marker to"></div>
              <div class="route-text" id="modalToAddress">–ö—É–¥–∞</div>
            </div>
          </div>
        </div>

        <!-- Contact Section - Prominent -->
        <div class="trip-section">
          <div class="section-title-modal">–°–≤—è–∑–∞—Ç—å—Å—è —Å –≤–æ–¥–∏—Ç–µ–ª–µ–º</div>
          <div class="contact-buttons">
            <button class="contact-btn" onclick="callDriver()" id="callBtn">
              üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å
            </button>
            <button class="contact-btn whatsapp" onclick="openWhatsApp()" id="whatsappBtn">
              üí¨ WhatsApp
            </button>
          </div>
        </div>

        <!-- Trip Details -->
        <div class="trip-section">
          <div class="section-title-modal">–î–µ—Ç–∞–ª–∏ –ø–æ–µ–∑–¥–∫–∏</div>
          <div class="detail-row">
            <span class="detail-label">–¶–µ–Ω–∞</span>
            <span class="detail-value price-highlight" id="modalPrice">0 ‚Ç∏</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">–í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è</span>
            <span class="detail-value" id="modalDeparture">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –≤–∞—Å</span>
            <span class="detail-value" id="modalDistance">- –∫–º</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">–í—Ä–µ–º—è –¥–æ –ø—Ä–∏–±—ã—Ç–∏—è</span>
            <span class="detail-value" id="modalETA">- –º–∏–Ω</span>
          </div>
        </div>

        <!-- Comment Section -->
        <div id="modalCommentSection" class="trip-section" style="display: none;">
          <div class="section-title-modal">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤–æ–¥–∏—Ç–µ–ª—è</div>
          <div class="comment-section">
            <div class="comment-text" id="modalComment"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Translations
    const translations = {
      ru: {
        available_drivers: '–î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–æ–¥–∏—Ç–µ–ª–∏',
        searching_drivers: '–ò—â–µ–º –≤–æ–¥–∏—Ç–µ–ª–µ–π...',
        no_drivers_found: '–í–æ–¥–∏—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã',
        no_drivers_message: '–í –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π.<br>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.',
        small: '–ú–∞–ª—ã–π',
        medium: '–°—Ä–µ–¥–Ω–∏–π',
        large: '–ë–æ–ª—å—à–æ–π',
        refrigerator: '–†–µ—Ñ—Ä–∏–∂–µ—Ä–∞—Ç–æ—Ä',
        tow: '–≠–≤–∞–∫—É–∞—Ç–æ—Ä',
        any: '–õ—é–±–æ–π',
        km: '–∫–º',
        min: '–º–∏–Ω'
      },
      kz: {
        available_drivers: '“ö–æ–ª–∂–µ—Ç—ñ–º–¥—ñ –∂“Ø—Ä–≥—ñ–∑—É—à—ñ–ª–µ—Ä',
        searching_drivers: '–ñ“Ø—Ä–≥—ñ–∑—É—à—ñ–ª–µ—Ä–¥—ñ —ñ–∑–¥–µ—É–¥–µ...',
        no_drivers_found: '–ñ“Ø—Ä–≥—ñ–∑—É—à—ñ–ª–µ—Ä —Ç–∞–±—ã–ª–º–∞–¥—ã',
        no_drivers_message: '“ö–∞–∑—ñ—Ä–≥—ñ —É–∞“õ—ã—Ç—Ç–∞ “õ–æ–ª–∂–µ—Ç—ñ–º–¥—ñ –∂“Ø—Ä–≥—ñ–∑—É—à—ñ–ª–µ—Ä –∂–æ“õ.<br>–ë—ñ—Ä–Ω–µ—à–µ –º–∏–Ω—É—Ç—Ç–∞–Ω –∫–µ–π—ñ–Ω –∂–∞“£–∞—Ä—Ç—ã–ø –∫”©—Ä—ñ“£—ñ–∑.',
        small: '–ö—ñ—à—ñ',
        medium: '–û—Ä—Ç–∞—à–∞',
        large: '“Æ–ª–∫–µ–Ω',
        refrigerator: '–†–µ—Ñ—Ä–∏–∂–µ—Ä–∞—Ç–æ—Ä',
        tow: '–≠–≤–∞–∫—É–∞—Ç–æ—Ä',
        any: '–ö–µ–∑ –∫–µ–ª–≥–µ–Ω',
        km: '–∫–º',
        min: '–º–∏–Ω'
      }
    };

    // Global state
    let availableDrivers = [];
    let currentLanguage = 'ru';
    let selectedDriver = null;
    let driverRouteMap = null;
    let pickupMarker = null;
    let dropoffMarker = null;
    let isMapFullscreen = false;

    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
      setupTelegramWebApp();
      loadDrivers();
    });

    // Setup Telegram WebApp
    function setupTelegramWebApp() {
      if (window.Telegram?.WebApp) {
        const tg = Telegram.WebApp;
        tg.ready();
        tg.expand();
        tg.disableVerticalSwipes();
      }
    }

    // Language switching
    function setLanguage(lang) {
      currentLanguage = lang;
      
      // Update language buttons
      document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById('lang-' + lang).classList.add('active');
      
      // Update all translatable elements
      document.querySelectorAll('[data-text]').forEach(element => {
        const key = element.getAttribute('data-text');
        if (translations[lang] && translations[lang][key]) {
          element.innerHTML = translations[lang][key];
        }
      });
      
      // Refresh drivers list if loaded
      if (availableDrivers.length > 0) {
        displayDrivers(availableDrivers);
      }
    }

    // Load drivers from API
    async function loadDrivers() {
      try {
        showLoadingState();
        
        // Get location from URL params or use Almaty as default
        const urlParams = new URLSearchParams(window.location.search);
        const fromLat = urlParams.get('from_lat') || 43.238949;
        const fromLon = urlParams.get('from_lon') || 76.889709;
        const toLat = urlParams.get('to_lat') || 43.238949;
        const toLon = urlParams.get('to_lon') || 76.889709;
        
        const params = new URLSearchParams({
          from_lat: fromLat,
          from_lon: fromLon,
          to_lat: toLat,
          to_lon: toLon,
          radius: 50 // 50km radius
        });
        
        console.log('üîç Loading drivers with params:', Object.fromEntries(params));
        
        const response = await fetch(`/api/driver-list?${params.toString()}`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.success && result.data && result.data.drivers) {
          availableDrivers = result.data.drivers;
          console.log(`‚úÖ Found ${availableDrivers.length} drivers`);
          displayDrivers(availableDrivers);
        } else {
          throw new Error(result.message || 'Driver search error');
        }
        
      } catch (error) {
        console.error('Error loading drivers:', error);
        showEmptyState();
        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–æ–¥–∏—Ç–µ–ª–µ–π: ' + error.message);
      }
    }

    // Display drivers list
    function displayDrivers(drivers) {
      hideLoadingState();
      
      const driversList = document.getElementById('driversList');
      const driversCount = document.getElementById('driversCount');
      
      if (!drivers || drivers.length === 0) {
        showEmptyState();
        return;
      }
      
      driversCount.textContent = drivers.length;
      
      driversList.innerHTML = drivers.map((driver, index) => {
        const distance = driver.distance_km || driver.distance_to_pickup_km || 0;
        const truckTypeName = translations[currentLanguage][driver.truck_type] || translations[currentLanguage]['any'];
        const startCity = driver.start_city || extractCityFromAddress(driver.from_address) || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        const endCity = driver.end_city || extractCityFromAddress(driver.to_address) || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        const driverPrice = driver.price || '–î–æ–≥–æ–≤–æ—Ä–Ω–∞—è';
        
        return `
        <div class="driver-card" onclick="showDriverDetails('${driver.id}')">
          <div class="driver-header">
            <img src="/ava/${driver.profile_photo || 'default.jpg'}" 
                 alt="${driver.first_name} ${driver.last_name}"
                 class="driver-photo"
                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjUiIGN5PSIyNSIgcj0iMjUiIGZpbGw9IiNmMGYwZjAiLz4KPHRleHQgeD0iMjUiIHk9IjMwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjEyIiBmaWxsPSIjOTk5Ij7igKI8L3RleHQ+Cjwvc3ZnPgo='">
            <div class="driver-info">
              <div class="driver-name">${driver.first_name} ${driver.last_name}</div>
              <div class="driver-vehicle">${truckTypeName}</div>
            </div>
            <div class="driver-price">
              <div class="price-amount">${driverPrice} ‚Ç∏</div>
            </div>
          </div>
          
          <div class="driver-details">
            <div class="distance-info">
              <span>${distance.toFixed(1)} ${translations[currentLanguage]['km']}</span>
              <span>‚Ä¢</span>
              <span>${driver.eta_min || Math.ceil(distance * 2)} ${translations[currentLanguage]['min']}</span>
            </div>
            <div class="route-info">
              ${startCity} ‚Üí ${endCity}
            </div>
          </div>
        </div>
      `}).join('');
      
      driversList.style.display = 'block';
    }

    // Extract city from address
    function extractCityFromAddress(address) {
      if (!address || address === '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω') {
        return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
      }

      const cities = [
        '–ê–ª–º–∞—Ç—ã', 'Almaty', '–ê—Å—Ç–∞–Ω–∞', '–ù—É—Ä-–°—É–ª—Ç–∞–Ω', 'Nur-Sultan',
        '–®—ã–º–∫–µ–Ω—Ç', 'Shymkent', '–ö–∞—Ä–∞–≥–∞–Ω–¥–∞', 'Karaganda', '–ê–∫—Ç–æ–±–µ', 'Aktobe',
        '–¢–∞—Ä–∞–∑', 'Taraz', '–ü–∞–≤–ª–æ–¥–∞—Ä', 'Pavlodar'
      ];

      const addressUpper = address.toUpperCase();
      
      for (const city of cities) {
        if (addressUpper.includes(city.toUpperCase())) {
          return city;
        }
      }

      const parts = address.split(',');
      if (parts.length > 0) {
        const firstPart = parts[0].trim();
        if (firstPart.length > 0 && firstPart.length < 50) {
          return firstPart;
        }
      }

      return address.length > 15 ? address.substring(0, 12) + '...' : address;
    }

    // Show driver details modal with Yandex map at top
    function showDriverDetails(driverId) {
      const driver = availableDrivers.find(d => d.id === driverId);
      if (!driver) return;
      
      selectedDriver = driver;
      
      // Update modal content
      document.getElementById('modalDriverPhoto').src = `/ava/${driver.profile_photo || 'default.jpg'}`;
      document.getElementById('modalDriverPhoto').onerror = function() {
        this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzAiIGN5PSIzMCIgcj0iMzAiIGZpbGw9IiNmMGYwZjAiLz4KPHRleHQgeD0iMzAiIHk9IjM2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjE0IiBmaWxsPSIjOTk5Ij7igKI8L3RleHQ+Cjwvc3ZnPgo=';
      };
      
      document.getElementById('modalDriverName').textContent = `${driver.first_name} ${driver.last_name}`;
      document.getElementById('modalDriverVehicle').textContent = translations[currentLanguage][driver.truck_type] || translations[currentLanguage]['any'];
      
      document.getElementById('modalFromAddress').textContent = driver.from_address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω';
      document.getElementById('modalToAddress').textContent = driver.to_address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω';
      
      document.getElementById('modalPrice').textContent = `${driver.price || '–î–æ–≥–æ–≤–æ—Ä–Ω–∞—è'} ‚Ç∏`;
      
      const distance = driver.distance_km || driver.distance_to_pickup_km || 0;
      document.getElementById('modalDistance').textContent = `${distance.toFixed(1)} ${translations[currentLanguage]['km']}`;
      document.getElementById('modalETA').textContent = `${driver.eta_min || Math.ceil(distance * 2)} ${translations[currentLanguage]['min']}`;
      
      // Format departure time
      let departureText = '–í—Ä–µ–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ';
      if (driver.departure_time) {
        try {
          const date = new Date(driver.departure_time);
          if (!isNaN(date.getTime())) {
            departureText = date.toLocaleString(currentLanguage === 'ru' ? 'ru-RU' : 'kk-KZ');
          }
        } catch (e) {
          departureText = driver.departure_time;
        }
      }
      document.getElementById('modalDeparture').textContent = departureText;
      
      // Show/hide comment section
      const commentSection = document.getElementById('modalCommentSection');
      if (driver.comment && driver.comment.trim()) {
        document.getElementById('modalComment').textContent = driver.comment.trim();
        commentSection.style.display = 'block';
      } else {
        commentSection.style.display = 'none';
      }
      
      // Show modal first
      document.getElementById('driverModal').classList.add('active');
      
      // Initialize Yandex map with A/B points after modal is visible
      setTimeout(() => {
        initYandexDriverMap(driver);
      }, 100);
    }

    // Initialize Yandex Maps v3 with A/B points
    async function initYandexDriverMap(driver) {
      // Clean up existing map
      if (driverRouteMap) {
        try {
          if (pickupMarker) driverRouteMap.removeChild(pickupMarker);
          if (dropoffMarker) driverRouteMap.removeChild(dropoffMarker);
          driverRouteMap.destroy && driverRouteMap.destroy();
        } catch (e) {
          console.warn('Error cleaning up existing map:', e);
        }
        driverRouteMap = null;
        pickupMarker = null;
        dropoffMarker = null;
      }
      
      // Get coordinates from driver data
      const fromLat = parseFloat(driver.from_lat || driver.pickup_lat) || null;
      const fromLon = parseFloat(driver.from_lon || driver.pickup_lon) || null;
      const toLat = parseFloat(driver.to_lat || driver.dropoff_lat) || null;
      const toLon = parseFloat(driver.to_lon || driver.dropoff_lon) || null;
      
      // Fallback coordinates (Almaty area)
      const pickupCoords = [fromLon || 76.889709, fromLat || 43.238949]; // [lon, lat] for Yandex
      const dropoffCoords = [toLon || 76.920000, toLat || 43.260000];
      
      console.log('üó∫Ô∏è Initializing Yandex map with A/B points:', { pickupCoords, dropoffCoords });
      
      try {
        await ymaps3.ready;
        const { YMap, YMapDefaultSchemeLayer, YMapDefaultFeaturesLayer, YMapMarker } = ymaps3;
        
        // Create Yandex map
        driverRouteMap = new YMap(
          document.getElementById('driverRouteMap'),
          {
            location: {
              center: pickupCoords,
              zoom: 12
            },
            theme: 'light'
          }
        );
        
        // Add map layers
        driverRouteMap.addChild(new YMapDefaultSchemeLayer({ theme: 'light' }));
        driverRouteMap.addChild(new YMapDefaultFeaturesLayer());
        
        // Create pickup marker (A)
        const pickupElement = document.createElement('div');
        pickupElement.className = 'yandex-marker-a';
        pickupElement.innerHTML = 'A';
        
        pickupMarker = new YMapMarker(
          {
            coordinates: pickupCoords,
            draggable: false
          },
          pickupElement
        );
        
        driverRouteMap.addChild(pickupMarker);
        
        // Create dropoff marker (B)
        const dropoffElement = document.createElement('div');
        dropoffElement.className = 'yandex-marker-b';
        dropoffElement.innerHTML = 'B';
        
        dropoffMarker = new YMapMarker(
          {
            coordinates: dropoffCoords,
            draggable: false
          },
          dropoffElement
        );
        
        driverRouteMap.addChild(dropoffMarker);
        
        // Calculate bounds and fit both points
        const bounds = calculateBounds([pickupCoords, dropoffCoords]);
        
        setTimeout(() => {
          if (driverRouteMap && driverRouteMap.setLocation) {
            driverRouteMap.setLocation({
              bounds: bounds,
              duration: 1000
            });
          }
        }, 500);
        
        console.log('‚úÖ Yandex driver map initialized successfully');
        
      } catch (error) {
        console.error('‚ùå Error initializing Yandex driver map:', error);
        
        // Show fallback message if map fails
        const mapContainer = document.getElementById('driverRouteMap');
        mapContainer.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666; font-size: 16px; background: #f5f5f5;">
            üó∫Ô∏è –ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...
          </div>
        `;
      }
    }

    // Calculate bounds for coordinates
    function calculateBounds(coordinates) {
      let minLon = coordinates[0][0];
      let maxLon = coordinates[0][0];
      let minLat = coordinates[0][1];
      let maxLat = coordinates[0][1];
      
      coordinates.forEach(coord => {
        minLon = Math.min(minLon, coord[0]);
        maxLon = Math.max(maxLon, coord[0]);
        minLat = Math.min(minLat, coord[1]);
        maxLat = Math.max(maxLat, coord[1]);
      });
      
      // Add padding
      const lonPadding = Math.max((maxLon - minLon) * 0.2, 0.01);
      const latPadding = Math.max((maxLat - minLat) * 0.2, 0.01);
      
      return [
        [minLon - lonPadding, minLat - latPadding],
        [maxLon + lonPadding, maxLat + latPadding]
      ];
    }

    // Expand map to fullscreen
    function expandMap() {
      if (!driverRouteMap) return;
      
      const mapSection = document.getElementById('mapSection');
      const expandBtn = document.getElementById('mapExpandBtn');
      const closeBtn = document.getElementById('mapCloseBtn');
      
      mapSection.classList.add('fullscreen');
      expandBtn.style.display = 'none';
      closeBtn.style.display = 'flex';
      isMapFullscreen = true;
      
      // Resize map after fullscreen
      setTimeout(() => {
        if (driverRouteMap && driverRouteMap.container) {
          try {
            driverRouteMap.container.fitToViewport();
          } catch (e) {
            console.warn('Map resize warning:', e);
          }
        }
      }, 300);
      
      console.log('üîç Map expanded to fullscreen');
    }

    // Close fullscreen map
    function closeFullscreenMap() {
      const mapSection = document.getElementById('mapSection');
      const expandBtn = document.getElementById('mapExpandBtn');
      const closeBtn = document.getElementById('mapCloseBtn');
      
      mapSection.classList.remove('fullscreen');
      expandBtn.style.display = 'flex';
      closeBtn.style.display = 'none';
      isMapFullscreen = false;
      
      // Resize map back to normal
      setTimeout(() => {
        if (driverRouteMap && driverRouteMap.container) {
          try {
            driverRouteMap.container.fitToViewport();
          } catch (e) {
            console.warn('Map resize warning:', e);
          }
        }
      }, 300);
      
      console.log('üì± Map returned to normal size');
    }

    // Close driver modal
    function closeDriverModal() {
      document.getElementById('driverModal').classList.remove('active');
      
      // Clean up map
      if (driverRouteMap) {
        try {
          if (pickupMarker) driverRouteMap.removeChild(pickupMarker);
          if (dropoffMarker) driverRouteMap.removeChild(dropoffMarker);
          if (driverRouteMap.destroy) driverRouteMap.destroy();
          console.log('üó∫Ô∏è Yandex driver map cleaned up');
        } catch (error) {
          console.warn('‚ö†Ô∏è Error cleaning up map:', error);
        }
      }
      
      driverRouteMap = null;
      pickupMarker = null;
      dropoffMarker = null;
      selectedDriver = null;
      isMapFullscreen = false;
      
      // Reset map section
      const mapSection = document.getElementById('mapSection');
      mapSection.classList.remove('fullscreen');
      document.getElementById('mapExpandBtn').style.display = 'flex';
      document.getElementById('mapCloseBtn').style.display = 'none';
    }

    // Contact functions
    function callDriver() {
      if (selectedDriver) {
        const contactNumber = selectedDriver.contact_number || selectedDriver.contact;
        if (contactNumber) {
          window.open(`tel:${contactNumber}`, '_self');
        } else {
          showError('–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –Ω–µ —É–∫–∞–∑–∞–Ω');
        }
      }
    }

    function openWhatsApp() {
      if (selectedDriver) {
        const contactNumber = selectedDriver.contact_number || selectedDriver.contact;
        if (contactNumber) {
          const cleanPhone = contactNumber.replace(/[^\d]/g, '');
          const driverName = `${selectedDriver.first_name} ${selectedDriver.last_name}`;
          const message = encodeURIComponent(`–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, ${driverName}! –Ø –Ω–∞—à–µ–ª –≤–∞—à –Ω–æ–º–µ—Ä –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ TezJet. –ú–Ω–µ –Ω—É–∂–Ω–∞ –ø–æ–µ–∑–¥–∫–∞ –æ—Ç ${selectedDriver.from_address} –¥–æ ${selectedDriver.to_address}. –¶–µ–Ω–∞: ${selectedDriver.price || '–ø–æ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏'} ‚Ç∏.`);
          window.open(`https://wa.me/${cleanPhone}?text=${message}`, '_blank');
        } else {
          showError('–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –Ω–µ —É–∫–∞–∑–∞–Ω');
        }
      }
    }

    // State management functions
    function showLoadingState() {
      document.getElementById('loadingState').style.display = 'flex';
      document.getElementById('driversList').style.display = 'none';
      document.getElementById('emptyState').style.display = 'none';
    }

    function hideLoadingState() {
      document.getElementById('loadingState').style.display = 'none';
    }

    function showEmptyState() {
      hideLoadingState();
      document.getElementById('emptyState').style.display = 'block';
      document.getElementById('driversList').style.display = 'none';
      document.getElementById('driversCount').textContent = '0';
    }

    function showError(message) {
      if (window.Telegram?.WebApp) {
        Telegram.WebApp.showAlert(message);
      } else {
        alert(message);
      }
    }

    // Navigation functions
    function goBack() {
      if (window.history.length > 1) {
        window.history.back();
      } else {
        window.location.href = '/';
      }
    }

    function refreshDrivers() {
      loadDrivers();
    }

    // Event listeners
    document.addEventListener('click', (e) => {
      if (e.target.matches('.driver-modal')) {
        closeDriverModal();
      }
    });

    // Handle escape key for fullscreen map
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isMapFullscreen) {
        closeFullscreenMap();
      }
    });

    // Auto-refresh drivers every 30 seconds
    setInterval(() => {
      if (document.visibilityState === 'visible') {
        refreshDrivers();
      }
    }, 30000);
  </script>
</body>
</html>