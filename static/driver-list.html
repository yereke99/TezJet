<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>–î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–æ–¥–∏—Ç–µ–ª–∏ ‚Ä¢ Alash-Go</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://api-maps.yandex.ru/v3/?apikey=8a3e4da0-9ef2-4176-9203-e7014c1dba6f&lang=ru_RU"></script>

  <style>
    :root {
      --primary-green: #10b981;
      --primary-dark: #059669;
      --primary-light: #34d399;

      --background: #f7f7f7;
      --surface: #ffffff;
      --surface-hover: #f9f9f9;

      --text-primary: #111827;
      --text-secondary: #6b7280;
      --text-muted: #9ca3af;

      --border: #e5e7eb;
      --shadow: 0 1px 3px rgba(0,0,0,.1);
      --shadow-md: 0 4px 6px rgba(0,0,0,.07);
      --shadow-xl: 0 20px 25px rgba(0,0,0,.1);

      --radius: 12px;
      --radius-lg: 16px;

      /* Telegram viewport vars */
      --tg-viewport-height: 100vh;
      --tg-viewport-stable-height: 100vh;
      --tg-safe-area-inset-top: 0px;
      --tg-content-safe-area-inset-top: 0px;

      /* computed UI sizes */
      --page-pad: 16px;

      /* bottom nav like main-client */
      --bottom-nav-height: 72px;
      --accent-secondary: #007AFF;
    }

    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html { height:100%; height:100dvh; overflow:hidden; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
      background: var(--background);
      color: var(--text-primary);
      height: var(--tg-viewport-stable-height, 100vh);
      min-height: var(--tg-viewport-height, 100vh);
      overflow:hidden;
      padding: 0;
    }

    @supports(height:100dvh){
      body { height:100dvh; min-height:100dvh; }
    }

    .app {
      position: relative;
      height: var(--tg-viewport-stable-height, 100vh);
      min-height: var(--tg-viewport-height, 100vh);
      overflow:hidden;
    }

    /* ===== HEADER ===== */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;

      padding-top: calc(var(--tg-safe-area-inset-top, 0px) + var(--tg-content-safe-area-inset-top, 0px) + 8px);
      padding-left: calc(env(safe-area-inset-left) + var(--page-pad));
      padding-right: calc(env(safe-area-inset-right) + var(--page-pad));
      padding-bottom: 8px;
      background: transparent;
      pointer-events: none;
    }

    .header-card {
      pointer-events: auto;
      background: var(--surface);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      padding: 12px 14px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .header-content {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }

    /* ‚úÖ removed back button styles (kept only refresh/lang) */
    .refresh-btn {
      background: var(--background);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      color: var(--text-secondary);
      touch-action: manipulation;
      transition: transform .15s ease, background .15s ease;
      flex: 0 0 auto;
      font-size: 16px;
    }

    .refresh-btn:active { transform: scale(0.92); background: var(--border); }

    .header-title {
      flex: 1 1 auto;
      font-size: 17px;
      font-weight: 700;
      text-align: center;
      letter-spacing: -0.3px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding-left: 6px;
      padding-right: 6px;
    }

    .header-controls {
      display:flex;
      align-items:center;
      gap: 8px;
      flex: 0 0 auto;
    }

    .lang-switch {
      background: var(--background);
      border-radius: 20px;
      padding: 3px;
      display:flex;
      gap: 2px;
    }
    .lang-btn {
      padding: 6px 10px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      border-radius: 16px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      touch-action: manipulation;
      transition: all .2s ease;
      min-width: 34px;
    }
    .lang-btn.active {
      background: var(--surface);
      color: var(--primary-green);
      box-shadow: var(--shadow);
    }

    /* ===== MAIN ===== */
    .main {
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;

      padding-top: calc(
        var(--tg-safe-area-inset-top, 0px) +
        var(--tg-content-safe-area-inset-top, 0px) +
        8px + 8px + 64px
      );

      padding-left: calc(env(safe-area-inset-left) + var(--page-pad));
      padding-right: calc(env(safe-area-inset-right) + var(--page-pad));

      /* ‚úÖ reserve bottom nav */
      padding-bottom: calc(env(safe-area-inset-bottom) + var(--bottom-nav-height) + 14px);

      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: none;
    }

    .section-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin: 6px 0 14px;
    }
    .section-title {
      font-size: 26px;
      font-weight: 800;
      letter-spacing: -0.6px;
    }
    .drivers-count {
      background: var(--primary-green);
      color: #fff;
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 14px;
      font-weight: 800;
      min-width: 34px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(16,185,129,.28);
    }

    .driver-card {
      background: var(--surface);
      border-radius: var(--radius-lg);
      margin-bottom: 12px;
      padding: 16px;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: transform .15s ease, background .15s ease;
      touch-action: manipulation;
    }
    .driver-card:active { transform: scale(.985); background: var(--surface-hover); }

    .driver-header {
      display:flex;
      align-items:center;
      gap: 12px;
    }
    .driver-photo {
      width: 56px; height: 56px;
      border-radius: 50%;
      object-fit: cover;
      background: var(--background);
      flex: 0 0 auto;
      border: 2px solid var(--border);
    }
    .driver-info { flex: 1; min-width: 0; }
    .driver-name {
      font-size: 17px;
      font-weight: 800;
      margin-bottom: 3px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      letter-spacing: -0.3px;
    }
    .driver-vehicle {
      font-size: 14px;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .driver-price { flex: 0 0 auto; text-align:right; }
    .price-amount {
      font-size: 20px;
      font-weight: 900;
      color: var(--primary-green);
      letter-spacing: -0.5px;
      white-space: nowrap;
    }

    .driver-details {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .distance-info {
      display:flex;
      align-items:center;
      gap: 10px;
      font-size: 14px;
      color: var(--text-secondary);
      flex: 1;
      min-width: 0;
    }
    .route-info {
      font-size: 13px;
      color: var(--text-muted);
      max-width: 44%;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      text-align: right;
      flex: 0 0 auto;
    }

    .state {
      display:none;
      min-height: calc(var(--tg-viewport-height, 100vh) - 220px);
      align-items:center;
      justify-content:center;
      flex-direction:column;
      text-align:center;
      padding: 28px 16px;
    }
    .state.active { display:flex; }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top: 3px solid var(--primary-green);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 18px;
    }
    @keyframes spin { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }
    .loading-text {
      font-size: 16px;
      color: var(--text-secondary);
      font-weight: 600;
    }

    .empty-icon { font-size: 72px; margin-bottom: 12px; opacity:.55; }
    .empty-title { font-size: 22px; font-weight: 900; margin-bottom: 10px; letter-spacing:-.3px; }
    .empty-message { font-size: 15px; color: var(--text-secondary); line-height:1.5; max-width: 320px; }

    /* ===== MODAL ===== */
    .driver-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.5);
      z-index: 2000;
      display: none;
      align-items: flex-end;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .driver-modal.active { display:flex; }
    .modal-content {
      width:100%;
      background: var(--surface);
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
      box-shadow: var(--shadow-xl);
      overflow:hidden;
      padding-bottom: calc(env(safe-area-inset-bottom) + 14px);
      animation: slideUp .28s ease;
      max-height: calc(var(--tg-viewport-height, 90vh) - 20px);
    }
    @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
    .modal-handle {
      width: 36px; height: 4px;
      background: var(--border);
      border-radius: 2px;
      margin: 8px auto 10px;
    }

    .modal-map-section {
      position: relative;
      width: 100%;
      height: 200px;
      background: var(--background);
      overflow:hidden;
      contain: layout style paint;
    }
    .modal-map-section.fullscreen {
      position: fixed;
      inset: 0;
      z-index: 3000;
      height: var(--tg-viewport-height, 100vh);
      padding-top: calc(var(--tg-safe-area-inset-top, 0px) + var(--tg-content-safe-area-inset-top, 0px));
      padding-bottom: calc(env(safe-area-inset-bottom) + 12px);
      border-radius: 0;
    }
    #driverRouteMap { width:100%; height:100%; contain: layout style paint; }

    .map-expand-btn, .map-close-btn {
      position: absolute;
      top: 14px;
      right: 14px;
      width: 40px; height: 40px;
      border-radius: 50%;
      border:none;
      background: var(--surface);
      box-shadow: var(--shadow-md);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      z-index: 10;
      touch-action: manipulation;
      transition: transform .15s ease;
    }
    .map-expand-btn:active, .map-close-btn:active { transform: scale(.92); }
    .map-close-btn { background:#ef4444; color:#fff; display:none; }

    .modal-header {
      position: relative;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      gap: 12px;
      background: var(--surface);
    }
    .close-btn {
      position:absolute;
      top: 12px;
      right: 12px;
      width: 32px; height: 32px;
      border-radius: 50%;
      border:none;
      background: var(--background);
      color: var(--text-secondary);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      touch-action: manipulation;
      transition: transform .15s ease, background .15s ease;
    }
    .close-btn:active { transform: scale(.92); background: var(--border); }

    .modal-driver-photo {
      width: 56px; height:56px;
      border-radius: 50%;
      object-fit: cover;
      background: var(--background);
      border: 2px solid var(--border);
      flex: 0 0 auto;
    }
    .modal-driver-info { flex:1; min-width:0; padding-right: 42px; }
    .modal-driver-info h3 {
      font-size: 18px;
      font-weight: 900;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      letter-spacing:-.3px;
    }
    .modal-driver-info p {
      font-size: 14px;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .modal-body {
      padding: 0 20px 18px;
      overflow-y:auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      max-height: calc(var(--tg-viewport-height, 85vh) - 360px);
    }

    .trip-section { margin: 18px 0; }
    .section-title-modal {
      font-size: 13px;
      font-weight: 900;
      color: var(--text-muted);
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: .6px;
    }

    .route-display {
      background: var(--background);
      border-radius: var(--radius);
      padding: 16px;
    }
    .route-item {
      display:flex;
      align-items:flex-start;
      gap: 12px;
      margin-bottom: 12px;
    }
    .route-item:last-child { margin-bottom:0; }
    .route-marker {
      width: 14px; height: 14px;
      border-radius: 50%;
      flex: 0 0 auto;
      margin-top: 4px;
    }
    .route-marker.from { background: var(--primary-green); box-shadow: 0 0 0 3px rgba(16,185,129,.18); }
    .route-marker.to { background:#ef4444; box-shadow: 0 0 0 3px rgba(239,68,68,.18); }
    .route-text {
      font-size: 15px;
      font-weight: 600;
      line-height: 1.5;
      word-break: break-word;
      flex: 1;
    }

    .contact-buttons { display:flex; gap: 12px; }
    .contact-btn {
      flex:1;
      border:none;
      border-radius: var(--radius);
      padding: 16px;
      font-weight: 900;
      font-size: 15px;
      color:#fff;
      background: var(--text-primary);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      touch-action: manipulation;
      transition: transform .15s ease;
      min-height: 52px;
    }
    .contact-btn.whatsapp { background:#25D366; }
    .contact-btn:active { transform: scale(.97); }

    .detail-row {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
      gap: 14px;
    }
    .detail-row:last-child { border-bottom:none; }
    .detail-label { font-size: 15px; color: var(--text-secondary); flex:0 0 auto; }
    .detail-value { font-size: 15px; font-weight: 900; text-align:right; }
    .price-highlight { font-size: 20px; color: var(--primary-green); letter-spacing:-.5px; }

    .comment-section {
      background: var(--background);
      border-radius: var(--radius);
      padding: 14px;
    }
    .comment-text { font-size: 15px; line-height: 1.5; word-break: break-word; }

    .custom-marker {
      width: 40px; height: 40px;
      border-radius: 50%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      font-size: 18px;
      color:#fff;
      border: 3px solid #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,.2);
      letter-spacing:-.5px;
    }
    .custom-marker.pickup { background: var(--primary-green); }
    .custom-marker.dropoff { background:#ef4444; }

    @media (max-width: 480px){
      .section-title { font-size: 24px; }
    }

    @media (prefers-reduced-motion: reduce){
      * { transition:none !important; animation:none !important; }
    }

    @media (prefers-color-scheme: dark){
      :root {
        --background: #111827;
        --surface: #1f2937;
        --surface-hover: #2d3748;
        --text-primary: #f9fafb;
        --text-secondary: #d1d5db;
        --text-muted: #9ca3af;
        --border: #374151;
      }
    }

    /* ===== Bottom nav (same as main-client) ===== */
    .bottom-nav {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 8px calc(env(safe-area-inset-left) + 16px)
               max(8px, env(safe-area-inset-bottom))
               calc(env(safe-area-inset-right) + 16px);
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(18px);
      border-top: 1px solid rgba(148,163,184,0.3);
      z-index: 2500;
      display: flex;
      justify-content: center;
    }

    .bottom-nav-inner {
      width: 100%;
      max-width: 420px;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      column-gap: 10px;
      align-items: center;
    }

    .nav-item {
      border-radius: 999px;
      padding: 7px 8px;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-size: 11px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      border: 1px solid transparent;
      background: transparent;
      -webkit-user-select: none;
      user-select: none;
      text-decoration: none;
      min-width: 0;
      touch-action: manipulation;
    }

    .nav-item .icon { font-size: 16px; }

    .nav-item.active {
      background: #000;
      color: #fff;
      border-color: #000;
      box-shadow: 0 8px 24px rgba(15,23,42,0.45);
    }

    .nav-item:active:not(.active) { background: rgba(0,0,0,0.05); }

    .nav-item:focus {
      outline: 2px solid var(--accent-secondary);
      outline-offset: 1px;
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- Header (‚úÖ back button removed) -->
    <div class="header">
      <div class="header-card">
        <div class="header-content">
          <div class="header-title" data-text="available_drivers">–î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–æ–¥–∏—Ç–µ–ª–∏</div>

          <div class="header-controls">
            <div class="lang-switch" aria-label="–Ø–∑—ã–∫">
              <button class="lang-btn active" onclick="setLanguage('ru')" id="lang-ru" aria-label="–†—É—Å—Å–∫–∏–π">RU</button>
              <button class="lang-btn" onclick="setLanguage('kz')" id="lang-kz" aria-label="“ö–∞–∑–∞“õ—à–∞">KZ</button>
            </div>
            <button class="refresh-btn" onclick="refreshDrivers()" aria-label="–û–±–Ω–æ–≤–∏—Ç—å">üîÑ</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Content -->
    <div class="main">
      <div class="section-header">
        <div class="section-title" data-text="available_drivers">–î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–æ–¥–∏—Ç–µ–ª–∏</div>
        <div class="drivers-count" id="driversCount" aria-label="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ">0</div>
      </div>

      <div class="state active" id="loadingState">
        <div class="loading-spinner" role="progressbar" aria-label="–ó–∞–≥—Ä—É–∑–∫–∞"></div>
        <div class="loading-text" data-text="searching_drivers">–ò—â–µ–º –≤–æ–¥–∏—Ç–µ–ª–µ–π...</div>
      </div>

      <div id="driversList" style="display:none;" role="list"></div>

      <div class="state" id="emptyState">
        <div class="empty-icon">üöö</div>
        <div class="empty-title" data-text="no_drivers_found">–í–æ–¥–∏—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
        <div class="empty-message" data-text="no_drivers_message">
          –í –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π.<br/>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.
        </div>
      </div>
    </div>

    <!-- ‚úÖ FAB (+) removed completely -->

    <!-- Modal -->
    <div class="driver-modal" id="driverModal" role="dialog" aria-modal="true" onclick="handleModalBackdropClick(event)">
      <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-handle"></div>

        <div class="modal-map-section" id="mapSection">
          <div id="driverRouteMap" role="application" aria-label="–ö–∞—Ä—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–∞"></div>
          <button class="map-expand-btn" id="mapExpandBtn" onclick="expandMap(event)" aria-label="–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å">‚õ∂</button>
          <button class="map-close-btn" id="mapCloseBtn" onclick="closeFullscreenMap()" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
        </div>

        <div class="modal-header">
          <img id="modalDriverPhoto" src="" alt="" class="modal-driver-photo"
            onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzAiIGN5PSIzMCIgcj0iMzAiIGZpbGw9IiNmMGYwZjAiLz4KPHRleHQgeD0iMzAiIHk9IjM2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjE0IiBmaWxsPSIjOTk5Ij7igKI8L3RleHQ+Cjwvc3ZnPgo='">
          <div class="modal-driver-info">
            <h3 id="modalDriverName">–ò–º—è –≤–æ–¥–∏—Ç–µ–ª—è</h3>
            <p id="modalDriverVehicle">–¢–∏–ø —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞</p>
          </div>
          <button class="close-btn" onclick="closeDriverModal()" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
        </div>

        <div class="modal-body">
          <div class="trip-section">
            <div class="section-title-modal">–ú–ê–†–®–†–£–¢</div>
            <div class="route-display">
              <div class="route-item">
                <div class="route-marker from"></div>
                <div class="route-text" id="modalFromAddress">–û—Ç–∫—É–¥–∞</div>
              </div>
              <div class="route-item">
                <div class="route-marker to"></div>
                <div class="route-text" id="modalToAddress">–ö—É–¥–∞</div>
              </div>
            </div>
          </div>

          <div class="trip-section">
            <div class="section-title-modal">–°–í–Ø–ó–ê–¢–¨–°–Ø –° –í–û–î–ò–¢–ï–õ–ï–ú</div>
            <div class="contact-buttons">
              <button class="contact-btn" onclick="callDriver()" id="callBtn" aria-label="–ü–æ–∑–≤–æ–Ω–∏—Ç—å">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
              <button class="contact-btn whatsapp" onclick="openWhatsApp()" id="whatsappBtn" aria-label="WhatsApp">üí¨ WhatsApp</button>
            </div>
          </div>

          <div class="trip-section">
            <div class="section-title-modal">–î–ï–¢–ê–õ–ò –ü–û–ï–ó–î–ö–ò</div>
            <div class="detail-row">
              <span class="detail-label">–¶–µ–Ω–∞</span>
              <span class="detail-value price-highlight" id="modalPrice">0 ‚Ç∏</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">–í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è</span>
              <span class="detail-value" id="modalDeparture">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –≤–∞—Å</span>
              <span class="detail-value" id="modalDistance">- –∫–º</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">–í—Ä–µ–º—è –¥–æ –ø—Ä–∏–±—ã—Ç–∏—è</span>
              <span class="detail-value" id="modalETA">- –º–∏–Ω</span>
            </div>
          </div>

          <div id="modalCommentSection" class="trip-section" style="display:none;">
            <div class="section-title-modal">–ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô –í–û–î–ò–¢–ï–õ–Ø</div>
            <div class="comment-section">
              <div class="comment-text" id="modalComment"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom Nav -->
    <nav class="bottom-nav">
      <div class="bottom-nav-inner">
        <button class="nav-item" id="tabHistory" type="button">
          <span class="icon">üìú</span>
          <span class="nav-item-label" data-kz="–¢–∞—Ä–∏—Ö" data-ru="–ò—Å—Ç–æ—Ä–∏—è">–¢–∞—Ä–∏—Ö</span>
        </button>

        <button class="nav-item" id="tabHome" type="button">
          <span class="icon">üè†</span>
          <span class="nav-item-label" data-kz="–ë–∞—Å—Ç—ã" data-ru="–ì–ª–∞–≤–Ω–∞—è">–ë–∞—Å—Ç—ã</span>
        </button>

        <button class="nav-item active" id="tabDrivers" type="button">
          <span class="icon">üöö</span>
          <span class="nav-item-label" data-kz="–ñ“Ø—Ä–≥—ñ–∑—É—à—ñ–ª–µ—Ä" data-ru="–í–æ–¥–∏—Ç–µ–ª–∏">–ñ“Ø—Ä–≥—ñ–∑—É—à—ñ–ª–µ—Ä</span>
        </button>
      </div>
    </nav>
  </div>

<script>
  /* =========================
     Alash-Go Driver List
     ========================= */

  const translations = {
    ru: {
      available_drivers: '–î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–æ–¥–∏—Ç–µ–ª–∏',
      searching_drivers: '–ò—â–µ–º –≤–æ–¥–∏—Ç–µ–ª–µ–π...',
      no_drivers_found: '–í–æ–¥–∏—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã',
      no_drivers_message: '–í –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π.<br>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.',
      small: '–ú–∞–ª—ã–π',
      medium: '–°—Ä–µ–¥–Ω–∏–π',
      large: '–ë–æ–ª—å—à–æ–π',
      refrigerator: '–†–µ—Ñ—Ä–∏–∂–µ—Ä–∞—Ç–æ—Ä',
      tow: '–≠–≤–∞–∫—É–∞—Ç–æ—Ä',
      any: '–õ—é–±–æ–π',
      km: '–∫–º',
      min: '–º–∏–Ω'
    },
    kz: {
      available_drivers: '“ö–æ–ª–∂–µ—Ç—ñ–º–¥—ñ –∂“Ø—Ä–≥—ñ–∑—É—à—ñ–ª–µ—Ä',
      searching_drivers: '–ñ“Ø—Ä–≥—ñ–∑—É—à—ñ–ª–µ—Ä–¥—ñ —ñ–∑–¥–µ—É–¥–µ...',
      no_drivers_found: '–ñ“Ø—Ä–≥—ñ–∑—É—à—ñ–ª–µ—Ä —Ç–∞–±—ã–ª–º–∞–¥—ã',
      no_drivers_message: '“ö–∞–∑—ñ—Ä–≥—ñ —É–∞“õ—ã—Ç—Ç–∞ “õ–æ–ª–∂–µ—Ç—ñ–º–¥—ñ –∂“Ø—Ä–≥—ñ–∑—É—à—ñ–ª–µ—Ä –∂–æ“õ.<br>–ë—ñ—Ä–Ω–µ—à–µ –º–∏–Ω—É—Ç—Ç–∞–Ω –∫–µ–π—ñ–Ω –∂–∞“£–∞—Ä—Ç—ã–ø –∫”©—Ä—ñ“£—ñ–∑.',
      small: '–ö—ñ—à—ñ',
      medium: '–û—Ä—Ç–∞—à–∞',
      large: '“Æ–ª–∫–µ–Ω',
      refrigerator: '–†–µ—Ñ—Ä–∏–∂–µ—Ä–∞—Ç–æ—Ä',
      tow: '–≠–≤–∞–∫—É–∞—Ç–æ—Ä',
      any: '–ö–µ–∑ –∫–µ–ª–≥–µ–Ω',
      km: '–∫–º',
      min: '–º–∏–Ω'
    }
  };

  let availableDrivers = [];
  let currentLanguage = 'ru';
  let selectedDriver = null;

  let driverRouteMap = null;
  let pickupMarker = null;
  let dropoffMarker = null;
  let isMapFullscreen = false;

  let isLoading = false;
  let loadAttempts = 0;
  const maxLoadAttempts = 3;

  let tripCoordinates = {
    fromLat: null, fromLon: null,
    toLat: null, toLon: null,
    fromAddress: null, toAddress: null
  };

  document.addEventListener('DOMContentLoaded', () => {
    setupTelegramWebApp();
    setupViewportHandling();
    bindBottomNav();

    loadTripCoordinates();
    loadDrivers();
  });

  function bindBottomNav(){
    const tabHistory = document.getElementById('tabHistory');
    const tabHome = document.getElementById('tabHome');
    const tabDrivers = document.getElementById('tabDrivers');

    const setActive = (name) => {
      document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
      if (name === 'history') tabHistory?.classList.add('active');
      if (name === 'home') tabHome?.classList.add('active');
      if (name === 'drivers') tabDrivers?.classList.add('active');
    };

    tabHistory?.addEventListener('click', () => {
      setActive('history');
      window.location.href = '/user-history';
    });

    tabHome?.addEventListener('click', () => {
      setActive('home');
      // ‚úÖ MUST OPEN main-client.html
      window.location.href = '/main-client';
    });

    tabDrivers?.addEventListener('click', () => {
      setActive('drivers');
      // stays here
    });
  }

  function setupTelegramWebApp() {
    if (!window.Telegram?.WebApp) return;

    const tg = Telegram.WebApp;

    tg.ready();
    tg.expand();

    try { tg.disableVerticalSwipes(); } catch(e) {}

    document.body.setAttribute('data-theme', tg.colorScheme || 'light');
    tg.onEvent('themeChanged', () => {
      document.body.setAttribute('data-theme', tg.colorScheme || 'light');
    });

    tg.onEvent('viewportChanged', handleViewportChange);
  }

  function setupViewportHandling() {
    updateViewportVariables();
    window.addEventListener('resize', debounce(handleViewportChange, 100));
    window.addEventListener('orientationchange', () => setTimeout(handleViewportChange, 200));
    document.addEventListener('fullscreenchange', handleViewportChange);
    document.addEventListener('webkitfullscreenchange', handleViewportChange);
  }

  function handleViewportChange() {
    updateViewportVariables();
    updateModalHeights();

    if (isMapFullscreen && driverRouteMap) {
      setTimeout(() => {
        try { driverRouteMap?.container?.fitToViewport?.(); } catch(e) {}
      }, 120);
    }
  }

  function updateViewportVariables() {
    const vh = window.Telegram?.WebApp?.viewportHeight || window.innerHeight;
    const stableVh = window.Telegram?.WebApp?.viewportStableHeight || vh;
    const safeTop = window.Telegram?.WebApp?.safeAreaInset?.top || 0;
    const contentTop = window.Telegram?.WebApp?.contentSafeAreaInset?.top || 0;

    document.documentElement.style.setProperty('--tg-viewport-height', `${vh}px`);
    document.documentElement.style.setProperty('--tg-viewport-stable-height', `${stableVh}px`);
    document.documentElement.style.setProperty('--tg-safe-area-inset-top', `${safeTop}px`);
    document.documentElement.style.setProperty('--tg-content-safe-area-inset-top', `${contentTop}px`);
  }

  function updateModalHeights() {
    const vh = window.Telegram?.WebApp?.viewportHeight || window.innerHeight;
    const modalContent = document.querySelector('.modal-content');
    const modalBody = document.querySelector('.modal-body');
    if (modalContent) modalContent.style.maxHeight = `${Math.max(300, vh - 20)}px`;
    if (modalBody) modalBody.style.maxHeight = `${Math.max(200, vh - 360)}px`;
  }

  function loadTripCoordinates() {
    const p = new URLSearchParams(window.location.search);

    const readFloat = (...keys) => {
      for (const k of keys) {
        const v = p.get(k);
        const f = v !== null ? parseFloat(v) : NaN;
        if (!Number.isNaN(f) && f !== 0) return f;
      }
      return null;
    };

    const readStr = (...keys) => {
      for (const k of keys) {
        const v = p.get(k);
        if (v && String(v).trim()) return String(v).trim();
      }
      return null;
    };

    tripCoordinates.fromLat = readFloat('from_lat','pickup_lat','A_lat','a_lat','start_lat','client_from_lat') ?? 43.238949;
    tripCoordinates.fromLon = readFloat('from_lon','pickup_lon','A_lon','a_lon','start_lon','client_from_lon') ?? 76.889709;

    tripCoordinates.toLat   = readFloat('to_lat','dropoff_lat','B_lat','b_lat','end_lat','client_to_lat') ?? 43.238949;
    tripCoordinates.toLon   = readFloat('to_lon','dropoff_lon','B_lon','b_lon','end_lon','client_to_lon') ?? 76.889709;

    tripCoordinates.fromAddress = readStr('from_address','pickup_address','A_address','start_address');
    tripCoordinates.toAddress   = readStr('to_address','dropoff_address','B_address','end_address');
  }

  function setLanguage(lang) {
    currentLanguage = lang;

    document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('lang-' + lang)?.classList.add('active');

    document.querySelectorAll('[data-text]').forEach(el => {
      const key = el.getAttribute('data-text');
      if (translations[lang]?.[key]) el.innerHTML = translations[lang][key];
    });

    if (availableDrivers.length) displayDrivers(availableDrivers);
  }

  async function loadDrivers() {
    if (isLoading) return;
    isLoading = true;
    loadAttempts++;

    try {
      showLoadingState();

      const params = new URLSearchParams({
        from_lat: String(tripCoordinates.fromLat),
        from_lon: String(tripCoordinates.fromLon),
        to_lat:   String(tripCoordinates.toLat),
        to_lon:   String(tripCoordinates.toLon),
        radius:   '50',
        limit:    '20',
        truck_type: 'any'
      });

      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 12000);

      const response = await fetch(`/api/driver-list?${params.toString()}`, {
        method: 'GET',
        signal: controller.signal,
        headers: { 'Accept': 'application/json' }
      });

      clearTimeout(timeoutId);

      if (!response.ok) throw new Error(`HTTP ${response.status}`);

      const result = await response.json();

      const drivers =
        result?.data?.drivers ||
        result?.data?.data?.drivers ||
        result?.drivers ||
        [];

      if (result?.success && Array.isArray(drivers)) {
        availableDrivers = drivers;
        loadAttempts = 0;
        displayDrivers(availableDrivers);
      } else {
        throw new Error(result?.message || 'Invalid response');
      }

    } catch (err) {
      if (err?.name === 'AbortError') {
        showEmptyState();
        showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
      } else if (loadAttempts < maxLoadAttempts) {
        setTimeout(() => { isLoading = false; loadDrivers(); }, 1800 * loadAttempts);
        return;
      } else {
        showEmptyState();
        showError(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${err.message || err}`);
      }
    } finally {
      isLoading = false;
    }
  }

  function displayDrivers(drivers) {
    hideLoadingState();

    const list = document.getElementById('driversList');
    const count = document.getElementById('driversCount');

    if (!drivers || drivers.length === 0) {
      showEmptyState();
      return;
    }

    count.textContent = String(drivers.length);

    const frag = document.createDocumentFragment();
    drivers.forEach((d) => frag.appendChild(createDriverCard(d)));

    list.innerHTML = '';
    list.appendChild(frag);
    list.style.display = 'block';

    document.getElementById('emptyState')?.classList.remove('active');
  }

  function createDriverCard(driver) {
    const distance = Number(driver.distance_km ?? driver.distance_to_pickup_km ?? 0);
    const etaMin = Number(driver.eta_min ?? driver.eta_min_pickup ?? Math.ceil(distance * 2) + 5);

    const typeKey = String(driver.truck_type || 'any').toLowerCase();
    const truckTypeName = translations[currentLanguage][typeKey] || translations[currentLanguage].any;

    const startCity = driver.start_city || extractCityFromAddress(driver.from_address) || '‚Äî';
    const endCity = driver.end_city || extractCityFromAddress(driver.to_address) || '‚Äî';

    const priceVal = driver.price ?? '–î–æ–≥–æ–≤–æ—Ä–Ω–∞—è';
    const priceText = (typeof priceVal === 'number' && priceVal > 0) ? `${priceVal}` : `${priceVal}`;

    const card = document.createElement('div');
    card.className = 'driver-card';
    card.setAttribute('role', 'listitem');
    card.setAttribute('tabindex', '0');

    const fn = escapeHtml(driver.first_name || '');
    const ln = escapeHtml(driver.last_name || '');
    const fullName = `${fn} ${ln}`.trim() || '–í–æ–¥–∏—Ç–µ–ª—å';

    const photo = encodeURIComponent(driver.profile_photo || 'default.jpg');

    card.innerHTML = `
      <div class="driver-header">
        <img class="driver-photo"
             src="/ava/${photo}"
             alt="${fullName}"
             loading="lazy"
             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTYiIGhlaWdodD0iNTYiIHZpZXdCb3g9IjAgMCA1NiA1NiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjgiIGN5PSIyOCIgcj0iMjgiIGZpbGw9IiNmMGYwZjAiLz4KPHRleHQgeD0iMjgiIHk9IjMyIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjE0IiBmaWxsPSIjOTk5Ij7igKI8L3RleHQ+Cjwvc3ZnPgo='">
        <div class="driver-info">
          <div class="driver-name">${fullName}</div>
          <div class="driver-vehicle">${escapeHtml(truckTypeName)}</div>
        </div>
        <div class="driver-price">
          <div class="price-amount">${escapeHtml(priceText)} ‚Ç∏</div>
        </div>
      </div>

      <div class="driver-details">
        <div class="distance-info">
          <span>üìç ${distance.toFixed(1)} ${translations[currentLanguage].km}</span>
          <span>‚Ä¢</span>
          <span>üïê ${etaMin} ${translations[currentLanguage].min}</span>
        </div>
        <div class="route-info">${escapeHtml(startCity)} ‚Üí ${escapeHtml(endCity)}</div>
      </div>
    `;

    const id = driver.id;
    card.addEventListener('click', () => showDriverDetails(id));
    card.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); showDriverDetails(id); }
    });

    return card;
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = String(text ?? '');
    return div.innerHTML;
  }

  function extractCityFromAddress(address) {
    if (!address || address === '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω') return null;

    const cities = [
      '–ê–ª–º–∞—Ç—ã','Almaty','–ê—Å—Ç–∞–Ω–∞','–ù—É—Ä-–°—É–ª—Ç–∞–Ω','Nur-Sultan','Astana',
      '–®—ã–º–∫–µ–Ω—Ç','Shymkent','–ö–∞—Ä–∞–≥–∞–Ω–¥–∞','Karaganda','–ê–∫—Ç–æ–±–µ','Aktobe','–ê“õ—Ç”©–±–µ',
      '–¢–∞—Ä–∞–∑','Taraz','–ü–∞–≤–ª–æ–¥–∞—Ä','Pavlodar','”®—Å–∫–µ–º–µ–Ω','–£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫','Ust-Kamenogorsk',
      '–°–µ–º–µ–π','Semey','–ê—Ç—ã—Ä–∞—É','Atyrau','–ö–æ—Å—Ç–∞–Ω–∞–π','Kostanay',
      '–ü–µ—Ç—Ä–æ–ø–∞–≤–ª','–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫','Petropavl','–ê–∫—Ç–∞—É','Aktau','–ê“õ—Ç–∞—É'
    ];
    const up = String(address).toUpperCase();
    for (const c of cities) if (up.includes(c.toUpperCase())) return c;

    const parts = String(address).split(',');
    if (parts[0] && parts[0].trim().length > 2) return parts[0].trim();
    return String(address).length > 20 ? String(address).slice(0, 17) + '...' : String(address);
  }

  function showDriverDetails(driverId) {
    const driver = availableDrivers.find(d => d.id === driverId);
    if (!driver) { showError('–í–æ–¥–∏—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }

    selectedDriver = driver;

    updateModalContent(driver);

    const modal = document.getElementById('driverModal');
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';

    setTimeout(() => initYandexDriverMap(driver), 120);
  }

  function updateModalContent(driver) {
    const photo = document.getElementById('modalDriverPhoto');
    const name = document.getElementById('modalDriverName');
    const veh = document.getElementById('modalDriverVehicle');
    const from = document.getElementById('modalFromAddress');
    const to = document.getElementById('modalToAddress');
    const price = document.getElementById('modalPrice');
    const dist = document.getElementById('modalDistance');
    const eta = document.getElementById('modalETA');
    const dep = document.getElementById('modalDeparture');
    const cSec = document.getElementById('modalCommentSection');
    const cTxt = document.getElementById('modalComment');

    const photoName = encodeURIComponent(driver.profile_photo || 'default.jpg');
    photo.src = `/ava/${photoName}`;

    name.textContent = `${driver.first_name || ''} ${driver.last_name || ''}`.trim() || '–í–æ–¥–∏—Ç–µ–ª—å';

    const typeKey = String(driver.truck_type || 'any').toLowerCase();
    veh.textContent = translations[currentLanguage][typeKey] || translations[currentLanguage].any;

    from.textContent = driver.from_address || tripCoordinates.fromAddress || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω';
    to.textContent = driver.to_address || tripCoordinates.toAddress || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω';

    const priceVal = driver.price ?? '–î–æ–≥–æ–≤–æ—Ä–Ω–∞—è';
    const priceText = (typeof priceVal === 'number' && priceVal > 0) ? `${priceVal}` : `${priceVal}`;
    price.textContent = `${priceText} ‚Ç∏`;

    const distance = Number(driver.distance_km ?? driver.distance_to_pickup_km ?? 0);
    dist.textContent = `${distance.toFixed(1)} ${translations[currentLanguage].km}`;
    const etaMin = Number(driver.eta_min ?? driver.eta_min_pickup ?? Math.ceil(distance * 2) + 5);
    eta.textContent = `${etaMin} ${translations[currentLanguage].min}`;

    let departureText = '–í—Ä–µ–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ';
    if (driver.departure_time) {
      const d = new Date(driver.departure_time);
      departureText = !isNaN(d.getTime())
        ? d.toLocaleString(currentLanguage === 'ru' ? 'ru-RU' : 'kk-KZ', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' })
        : String(driver.departure_time);
    }
    dep.textContent = departureText;

    if (driver.comment && String(driver.comment).trim()) {
      cTxt.textContent = String(driver.comment).trim();
      cSec.style.display = 'block';
    } else {
      cSec.style.display = 'none';
    }
  }

  async function initYandexDriverMap(driver) {
    cleanupDriverMap();

    const coords = validateAndParseCoordinates(driver);
    if (!coords) { showMapError(); return; }

    const { pickupCoords, dropoffCoords } = coords;

    try {
      await ymaps3.ready;
      const { YMap, YMapDefaultSchemeLayer, YMapDefaultFeaturesLayer } = ymaps3;

      driverRouteMap = new YMap(
        document.getElementById('driverRouteMap'),
        {
          location: { center: pickupCoords, zoom: 12 },
          theme: document.body.getAttribute('data-theme') === 'dark' ? 'dark' : 'light',
          behaviors: ['drag','pinch','dblClick','mouseWheel']
        }
      );

      driverRouteMap.addChild(new YMapDefaultSchemeLayer({
        theme: document.body.getAttribute('data-theme') === 'dark' ? 'dark' : 'light'
      }));
      driverRouteMap.addChild(new YMapDefaultFeaturesLayer());

      createMarkers(pickupCoords, dropoffCoords);

      const bounds = calculateBounds([pickupCoords, dropoffCoords]);
      setTimeout(() => {
        try { driverRouteMap?.setLocation?.({ bounds, duration: 700 }); } catch(e) {}
      }, 250);

    } catch (e) {
      showMapError();
    }
  }

  function validateAndParseCoordinates(driver) {
    const fromLat = parseFloat(driver.from_lat ?? driver.pickup_lat ?? tripCoordinates.fromLat);
    const fromLon = parseFloat(driver.from_lon ?? driver.pickup_lon ?? tripCoordinates.fromLon);
    const toLat = parseFloat(driver.to_lat ?? driver.dropoff_lat ?? tripCoordinates.toLat);
    const toLon = parseFloat(driver.to_lon ?? driver.dropoff_lon ?? tripCoordinates.toLon);

    const isValid = (lat, lon) =>
      !isNaN(lat) && !isNaN(lon) && Math.abs(lat) <= 90 && Math.abs(lon) <= 180 && lat !== 0 && lon !== 0;

    const pickupCoords = isValid(fromLat, fromLon) ? [fromLon, fromLat] : [76.889709, 43.238949];
    const dropoffCoords = isValid(toLat, toLon) ? [toLon, toLat] : [76.920000, 43.260000];

    return { pickupCoords, dropoffCoords };
  }

  function createMarkers(pickupCoords, dropoffCoords) {
    try {
      const { YMapMarker } = ymaps3;

      const pickupEl = document.createElement('div');
      pickupEl.className = 'custom-marker pickup';
      pickupEl.textContent = 'A';

      pickupMarker = new YMapMarker({ coordinates: pickupCoords, draggable: false }, pickupEl);
      driverRouteMap.addChild(pickupMarker);

      const dropoffEl = document.createElement('div');
      dropoffEl.className = 'custom-marker dropoff';
      dropoffEl.textContent = 'B';

      dropoffMarker = new YMapMarker({ coordinates: dropoffCoords, draggable: false }, dropoffEl);
      driverRouteMap.addChild(dropoffMarker);
    } catch (e) {}
  }

  function calculateBounds(coords) {
    let minLon = Math.min(...coords.map(c => c[0]));
    let maxLon = Math.max(...coords.map(c => c[0]));
    let minLat = Math.min(...coords.map(c => c[1]));
    let maxLat = Math.max(...coords.map(c => c[1]));
    const lonSpan = maxLon - minLon;
    const latSpan = maxLat - minLat;
    const lonPad = Math.max(lonSpan * 0.3, 0.01);
    const latPad = Math.max(latSpan * 0.3, 0.01);
    return [[minLon - lonPad, minLat - latPad], [maxLon + lonPad, maxLat + latPad]];
  }

  function showMapError() {
    const c = document.getElementById('driverRouteMap');
    if (!c) return;
    c.innerHTML = `
      <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;
                  color:var(--text-secondary);font-size:14px;background:var(--background);padding:20px;text-align:center;">
        <div style="font-size:32px;margin-bottom:8px;">üó∫Ô∏è</div>
        <div style="font-weight:900;margin-bottom:4px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã</div>
        <div style="opacity:.75;">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</div>
      </div>`;
  }

  function cleanupDriverMap() {
    if (!driverRouteMap) return;
    try {
      if (pickupMarker) { driverRouteMap.removeChild(pickupMarker); pickupMarker = null; }
      if (dropoffMarker) { driverRouteMap.removeChild(dropoffMarker); dropoffMarker = null; }
      driverRouteMap.destroy?.();
    } catch (e) {}
    driverRouteMap = null;
  }

  function expandMap(event) {
    event.stopPropagation();
    if (!driverRouteMap) return;

    const sec = document.getElementById('mapSection');
    const expandBtn = document.getElementById('mapExpandBtn');
    const closeBtn = document.getElementById('mapCloseBtn');

    sec.classList.add('fullscreen');
    expandBtn.style.display = 'none';
    closeBtn.style.display = 'flex';
    isMapFullscreen = true;

    updateViewportVariables();

    setTimeout(() => {
      try { driverRouteMap?.container?.fitToViewport?.(); } catch(e) {}
    }, 220);

    document.addEventListener('keydown', handleEscapeKey);
  }

  function handleEscapeKey(e) {
    if (e.key === 'Escape' && isMapFullscreen) closeFullscreenMap();
  }

  function closeFullscreenMap() {
    const sec = document.getElementById('mapSection');
    const expandBtn = document.getElementById('mapExpandBtn');
    const closeBtn = document.getElementById('mapCloseBtn');

    sec.classList.remove('fullscreen');
    expandBtn.style.display = 'flex';
    closeBtn.style.display = 'none';
    isMapFullscreen = false;

    updateViewportVariables();

    setTimeout(() => {
      try { driverRouteMap?.container?.fitToViewport?.(); } catch(e) {}
    }, 220);

    document.removeEventListener('keydown', handleEscapeKey);
  }

  function closeDriverModal() {
    document.getElementById('driverModal')?.classList.remove('active');
    document.body.style.overflow = '';
    cleanupDriverMap();

    if (isMapFullscreen) closeFullscreenMap();
    selectedDriver = null;
  }

  function handleModalBackdropClick(e) {
    if (e.target?.id === 'driverModal') closeDriverModal();
  }

  function callDriver() {
    if (!selectedDriver) return;
    const num = selectedDriver.contact_number || selectedDriver.contact;
    if (!num) return showError('–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –Ω–µ —É–∫–∞–∑–∞–Ω');

    const clean = String(num).replace(/[^\d+]/g, '');
    if (clean.replace(/\D/g,'').length < 10) return showError('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä');

    try { window.open(`tel:${clean}`, '_self'); } catch(e) { showError('–û—à–∏–±–∫–∞'); }
  }

  function openWhatsApp() {
    if (!selectedDriver) return;

    const num = selectedDriver.contact_number || selectedDriver.contact;
    if (!num) return showError('–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –Ω–µ —É–∫–∞–∑–∞–Ω');

    const digits = String(num).replace(/[^\d]/g, '');
    if (digits.length < 10) return showError('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä');

    let phone = digits;
    if (phone.startsWith('8')) phone = '7' + phone.slice(1);
    if (!phone.startsWith('7')) phone = '7' + phone;

    const driverName = `${selectedDriver.first_name || ''} ${selectedDriver.last_name || ''}`.trim();

    const fromAddress = tripCoordinates.fromAddress || selectedDriver.from_address || '—Ç–æ—á–∫–∏ –ê';
    const toAddress = tripCoordinates.toAddress || selectedDriver.to_address || '—Ç–æ—á–∫–∏ –ë';

    const priceVal = selectedDriver.price ?? '–ø–æ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏';
    const message = encodeURIComponent(
      `–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, ${driverName || '–≤–æ–¥–∏—Ç–µ–ª—å'}! –Ø –Ω–∞—à–µ–ª –≤–∞—à –Ω–æ–º–µ—Ä –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ Alash-Go.\n\n` +
      `–ú–Ω–µ –Ω—É–∂–Ω–∞ –≥—Ä—É–∑–æ–ø–µ—Ä–µ–≤–æ–∑–∫–∞:\n` +
      `üìç –û—Ç–∫—É–¥–∞: ${fromAddress}\n` +
      `üìç –ö—É–¥–∞: ${toAddress}\n\n` +
      `–¶–µ–Ω–∞: ${priceVal} ‚Ç∏\n\n` +
      `–ü—Ä–æ—à—É —Å–≤—è–∑–∞—Ç—å—Å—è —Å–æ –º–Ω–æ–π –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π.`
    );

    try { window.open(`https://wa.me/${phone}?text=${message}`, '_blank', 'noopener,noreferrer'); }
    catch(e) { showError('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è WhatsApp'); }
  }

  function showLoadingState() {
    document.getElementById('loadingState')?.classList.add('active');
    document.getElementById('emptyState')?.classList.remove('active');
    document.getElementById('driversList').style.display = 'none';
  }

  function hideLoadingState() {
    document.getElementById('loadingState')?.classList.remove('active');
  }

  function showEmptyState() {
    hideLoadingState();
    document.getElementById('emptyState')?.classList.add('active');
    document.getElementById('driversList').style.display = 'none';
    document.getElementById('driversCount').textContent = '0';
  }

  function showError(message) {
    if (window.Telegram?.WebApp) Telegram.WebApp.showAlert(message);
    else alert(message);
  }

  function refreshDrivers() {
    loadAttempts = 0;
    availableDrivers = [];

    const btn = document.querySelector('.refresh-btn');
    if (btn) {
      btn.style.animation = 'spin 0.5s linear';
      setTimeout(() => btn.style.animation = '', 520);
    }

    loadDrivers();
  }

  function debounce(fn, wait) {
    let t;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), wait);
    };
  }

  document.addEventListener('keydown', (e) => {
    if (e.key !== 'Escape') return;
    if (isMapFullscreen) closeFullscreenMap();
    else if (selectedDriver) closeDriverModal();
  });

  let autoRefreshInterval = setInterval(() => {
    if (document.visibilityState === 'visible' && !isLoading) refreshDrivers();
  }, 30000);

  window.addEventListener('beforeunload', () => {
    clearInterval(autoRefreshInterval);
    cleanupDriverMap();
    document.removeEventListener('keydown', handleEscapeKey);
  });

  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible' && !isLoading && availableDrivers.length === 0) {
      loadDrivers();
    }
  });
</script>
</body>
</html>
