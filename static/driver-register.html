<!DOCTYPE html>
<html lang="kz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Жүргізуші тіркелуі | Регистрация водителя</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      /* Light theme - Uber colors */
      --bg-primary: #ffffff;
      --bg-secondary: #f8f9fa;
      --text-primary: #000000;
      --text-secondary: #6c757d;
      --text-muted: #9ca3af;
      --accent-primary: #000000;
      --accent-secondary: #276ef1;
      --input-bg: #ffffff;
      --input-border: #e5e7eb;
      --input-focus: #000000;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.15);
      --error-color: #dc3545;
      --success-color: #28a745;
      --warning-color: #ffc107;
    }

    [data-theme="dark"] {
      /* Dark theme */
      --bg-primary: #1a1a1a;
      --bg-secondary: #2d2d2d;
      --text-primary: #ffffff;
      --text-secondary: #b3b3b3;
      --text-muted: #666666;
      --accent-primary: #ffffff;
      --accent-secondary: #276ef1;
      --input-bg: #2d2d2d;
      --input-border: #444444;
      --input-focus: #ffffff;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.5);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      height: 100vh;
      height: 100dvh;
      overflow-x: hidden;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      position: fixed;
      width: 100%;
      top: 0;
      left: 0;
      padding-top: env(safe-area-inset-top, 20px);
      padding-bottom: env(safe-area-inset-bottom, 0px);
    }

    .container {
      max-width: 420px;
      margin: 0 auto;
      padding: 0 20px 120px;
      position: relative;
      min-height: 100vh;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
    }

    /* Language Switch */
    .lang-switch {
      position: fixed;
      top: 10px;
      right: 15px;
      display: flex;
      gap: 2px;
      z-index: 1000;
      background: var(--bg-secondary);
      border-radius: 20px;
      padding: 4px;
      box-shadow: var(--shadow-sm);
    }

    .lang-switch button {
      background: transparent;
      color: var(--text-secondary);
      border: none;
      border-radius: 16px;
      padding: 6px 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 12px;
      transition: all 0.2s ease;
    }

    .lang-switch button.active {
      background: var(--accent-primary);
      color: var(--bg-primary);
    }

    /* Header */
    .header {
      text-align: center;
      margin: 60px 0 40px;
      width: 100%;
    }

    .logo {
      width: 80px;
      height: 80px;
      background: var(--accent-primary);
      border-radius: 20px;
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      color: var(--bg-primary);
      font-weight: 700;
      box-shadow: var(--shadow-md);
    }

    .title {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
      letter-spacing: -0.02em;
    }

    .subtitle {
      font-size: 16px;
      color: var(--text-secondary);
      font-weight: 400;
    }

    /* Form Container */
    .form-container {
      width: 100%;
      max-width: 400px;
      flex: 1;
    }

    /* Form */
    .form-group {
      margin-bottom: 24px;
      position: relative;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 14px;
      color: var(--text-primary);
    }

    .required {
      color: var(--error-color);
    }

    input[type="text"],
    input[type="tel"],
    input[type="date"],
    input[type="file"] {
      width: 100%;
      padding: 16px;
      font-size: 16px;
      border: 2px solid var(--input-border);
      border-radius: 12px;
      background: var(--input-bg);
      color: var(--text-primary);
      transition: all 0.2s ease;
      font-weight: 500;
    }

    input:focus {
      outline: none;
      border-color: var(--input-focus);
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
    }

    input.error {
      border-color: var(--error-color);
      box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
    }

    input.success {
      border-color: var(--success-color);
      box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
    }

    /* Profile Photo Preview */
    .profile-photo-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .profile-photo-preview {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 3px solid var(--input-border);
      background: var(--bg-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      color: var(--text-muted);
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .profile-photo-preview:hover {
      border-color: var(--input-focus);
      transform: scale(1.02);
    }

    .profile-photo-preview.has-photo {
      border-color: var(--success-color);
    }

    .profile-photo-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* File Upload Styling */
    input[type="file"] {
      padding: 12px;
      cursor: pointer;
      border: 2px dashed var(--input-border);
      background: var(--bg-secondary);
      position: relative;
      transition: all 0.2s ease;
    }

    input[type="file"]:hover {
      border-color: var(--input-focus);
      background: var(--input-bg);
    }

    input[type="file"]::file-selector-button {
      background: var(--accent-primary);
      color: var(--bg-primary);
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      margin-right: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.85rem;
      transition: all 0.2s ease;
    }

    /* Location Input Group - FIXED LAYOUT */
    .location-input-group {
      width: 100%;
      position: relative;
    }

    .location-input {
      width: 100%;
      position: relative;
    }

    .location-input input {
      width: 100%;
      padding-right: 60px; /* Space for GPS button */
    }

    .gps-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      padding: 8px;
      border: none;
      border-radius: 8px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 40px;
      height: 40px;
    }

    .gps-btn:hover {
      background: var(--input-border);
    }

    .gps-btn.loading {
      background: var(--warning-color);
      color: white;
      animation: pulse 1.5s infinite;
    }

    .gps-btn.success {
      background: var(--success-color);
      color: white;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    /* Search Suggestions */
    .suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--input-bg);
      border: 2px solid var(--input-border);
      border-top: none;
      border-radius: 0 0 12px 12px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      display: none;
      box-shadow: var(--shadow-md);
    }

    .suggestions.show {
      display: block;
    }

    .suggestion-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid var(--input-border);
      transition: background 0.2s ease;
    }

    .suggestion-item:hover {
      background: var(--bg-secondary);
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    /* Error Messages */
    .error-message {
      color: var(--error-color);
      font-size: 12px;
      margin-top: 4px;
      font-weight: 500;
    }

    /* Success Messages */
    .success-message {
      color: var(--success-color);
      font-size: 12px;
      margin-top: 4px;
      font-weight: 500;
    }

    /* Progress Bar */
    .progress-bar {
      width: 100%;
      height: 4px;
      background: var(--bg-secondary);
      border-radius: 2px;
      margin: 20px 0;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--accent-primary);
      border-radius: 2px;
      transition: width 0.3s ease;
      width: 0%;
    }

    /* Responsive */
    @media (max-width: 480px) {
      .container {
        padding: 0 16px 100px;
      }

      .form-row {
        grid-template-columns: 1fr;
        gap: 16px;
      }
    }

    /* iOS specific adjustments */
    @supports (padding: max(0px)) {
      body {
        padding-bottom: max(0px, env(safe-area-inset-bottom));
      }
    }

    /* Prevent layout shifts */
    html {
      overflow-x: hidden;
      -webkit-text-size-adjust: 100%;
      -ms-text-size-adjust: 100%;
    }

    /* Disable zoom on inputs */
    input[type="text"],
    input[type="tel"],
    input[type="date"],
    input[type="file"],
    input {
      font-size: 16px !important;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }

    /* Prevent viewport jumping */
    .container {
      -webkit-transform: translate3d(0, 0, 0);
      transform: translate3d(0, 0, 0);
    }

    /* Smooth scrolling */
    html {
      scroll-behavior: smooth;
    }

    /* Loading states */
    .loading {
      pointer-events: none;
      opacity: 0.6;
    }

    /* Hidden elements */
    .hidden {
      display: none !important;
    }

    /* Form validation styles */
    .form-group.valid input {
      border-color: var(--success-color);
    }

    .form-group.invalid input {
      border-color: var(--error-color);
    }

    /* Custom date input */
    input[type="date"] {
      position: relative;
    }

    input[type="date"]::-webkit-calendar-picker-indicator {
      background: transparent;
      bottom: 0;
      color: transparent;
      cursor: pointer;
      height: auto;
      left: 0;
      position: absolute;
      right: 0;
      top: 0;
      width: auto;
    }
  </style>
</head>
<body>
  <!-- Language Switch -->
  <div class="lang-switch">
    <button onclick="setLang('kz')" id="lang-kz" class="active">KZ</button>
    <button onclick="setLang('ru')" id="lang-ru">RU</button>
  </div>

  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="logo">🚗</div>
      <h1 class="title" data-kz="Жүргізуші тіркелуі" data-ru="Регистрация водителя">Жүргізуші тіркелуі</h1>
      <p class="subtitle" data-kz="Жұмысты бастау үшін деректерді толтырыңыз" data-ru="Заполните данные для начала работы">Жұмысты бастау үшін деректерді толтырыңыз</p>
    </div>

    <!-- Progress Bar -->
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>

    <!-- Registration Form -->
    <div class="form-container">
      <form id="driverForm" enctype="multipart/form-data">
        <!-- Name Fields -->
        <div class="form-row">
          <div class="form-group">
            <label for="firstName">
              <span data-kz="Аты" data-ru="Имя">Аты</span>
              <span class="required">*</span>
            </label>
            <input type="text" id="firstName" name="firstName" required 
                   data-placeholder-kz="Атыңызды енгізіңіз" data-placeholder-ru="Введите имя"
                   placeholder="Атыңызды енгізіңіз">
            <div class="error-message" id="firstNameError"></div>
          </div>
          <div class="form-group">
            <label for="lastName">
              <span data-kz="Тегі" data-ru="Фамилия">Тегі</span>
              <span class="required">*</span>
            </label>
            <input type="text" id="lastName" name="lastName" required
                   data-placeholder-kz="Тегіңізді енгізіңіз" data-placeholder-ru="Введите фамилию"
                   placeholder="Тегіңізді енгізіңіз">
            <div class="error-message" id="lastNameError"></div>
          </div>
        </div>

        <!-- Profile Photo -->
        <div class="form-group">
          <label for="profilePhoto">
            <span data-kz="Профиль фотосы" data-ru="Фото профиля">Профиль фотосы</span>
            <span class="required">*</span>
          </label>
          
          <div class="profile-photo-container">
            <div class="profile-photo-preview" id="profilePhotoPreview" onclick="document.getElementById('profilePhoto').click()">
              👤
            </div>
            <input type="file" id="profilePhoto" name="profilePhoto" accept="image/*" capture="environment" required style="display: none;">
          </div>
          
          <div class="error-message" id="profilePhotoError"></div>
        </div>

        <!-- Birthday -->
        <div class="form-group">
          <label for="birthday">
            <span data-kz="Туған күні" data-ru="Дата рождения">Туған күні</span>
            <span class="required">*</span>
          </label>
          <input type="date" id="birthday" name="birthday" required max="2006-01-01">
          <div class="error-message" id="birthdayError"></div>
        </div>

        <!-- Driver License Front -->
        <div class="form-group">
          <label for="licenseFront">
            <span data-kz="Жүргізуші куәлігі (алдыңғы жағы)" data-ru="Водительское удостоверение (лицевая сторона)">Жүргізуші куәлігі (алдыңғы жағы)</span>
            <span class="required">*</span>
          </label>
          <input type="file" id="licenseFront" name="licenseFront" accept="image/*,.pdf" required>
          <div class="error-message" id="licenseFrontError"></div>
        </div>

        <!-- Driver License Back -->
        <div class="form-group">
          <label for="licenseBack">
            <span data-kz="Жүргізуші куәлігі (артқы жағы)" data-ru="Водительское удостоверение (обратная сторона)">Жүргізуші куәлігі (артқы жағы)</span>
            <span class="required">*</span>
          </label>
          <input type="file" id="licenseBack" name="licenseBack" accept="image/*,.pdf" required>
          <div class="error-message" id="licenseBackError"></div>
        </div>

        <!-- Contact Number -->
        <div class="form-group">
          <label for="contactNumber">
            <span data-kz="Телефон нөмірі" data-ru="Номер телефона">Телефон нөмірі</span>
            <span class="required">*</span>
          </label>
          <input type="tel" id="contactNumber" name="contactNumber" required
                 placeholder="+7 (___) ___-__-__">
          <div class="error-message" id="contactNumberError"></div>
          <div class="success-message" id="contactNumberSuccess"></div>
        </div>

        <!-- Start City - FIXED LAYOUT -->
        <div class="form-group">
          <label for="startCity">
            <span data-kz="Жұмыс қаласы" data-ru="Город работы">Жұмыс қаласы</span>
            <span class="required">*</span>
          </label>
          <div class="location-input-group">
            <div class="location-input">
              <input type="text" id="startCity" name="startCity" required
                     data-placeholder-kz="Қаланы енгізіңіз" 
                     data-placeholder-ru="Введите город"
                     placeholder="Қаланы енгізіңіз">
              <button type="button" class="gps-btn" id="gpsBtn" 
                      data-title-kz="Орналасқан жерді анықтау" 
                      data-title-ru="Определить местоположение"
                      title="Орналасқан жерді анықтау">📍</button>
              <div class="suggestions" id="citySuggestions"></div>
            </div>
          </div>
          
          <div class="error-message" id="startCityError"></div>
          <div class="success-message" id="startCitySuccess"></div>
        </div>

        <!-- Hidden fields for coordinates -->
        <input type="hidden" id="latitude" name="latitude">
        <input type="hidden" id="longitude" name="longitude">
        <input type="hidden" id="telegramId" name="telegramId">
      </form>
    </div>
  </div>

  <script>
    // Global variables - DEFAULT TO KZ
    let currentLang = 'kz';
    
    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
      initializeTelegram();
      setupEventListeners();
      updatePlaceholders();
      updateProgress();
    });

    // Initialize Telegram WebApp
    function initializeTelegram() {
      if (window.Telegram && Telegram.WebApp) {
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        Telegram.WebApp.enableClosingConfirmation();
        
        // Disable viewport changes
        Telegram.WebApp.disableVerticalSwipes();
        
        const user = Telegram.WebApp.initDataUnsafe?.user;
        if (user) {
          document.getElementById('telegramId').value = user.id;
        }

        // Theme handling
        if (Telegram.WebApp.colorScheme === 'dark') {
          document.documentElement.setAttribute('data-theme', 'dark');
        }

        Telegram.WebApp.onEvent('themeChanged', function() {
          document.documentElement.setAttribute('data-theme', Telegram.WebApp.colorScheme);
        });

        // Prevent viewport changes
        Telegram.WebApp.onEvent('viewportChanged', function() {
          // Do nothing to prevent shaking
        });

        // Hide main button initially
        Telegram.WebApp.MainButton.hide();
      }
    }

    // Setup event listeners
    function setupEventListeners() {
      // Form validation
      const form = document.getElementById('driverForm');
      const inputs = form.querySelectorAll('input[required]');
      
      inputs.forEach(input => {
        input.addEventListener('blur', validateField);
        input.addEventListener('input', updateProgress);
      });

      // Profile Photo handling
      const profilePhotoInput = document.getElementById('profilePhoto');
      const profilePhotoPreview = document.getElementById('profilePhotoPreview');
      
      profilePhotoInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            profilePhotoPreview.innerHTML = `<img src="${e.target.result}" alt="Profile">`;
            profilePhotoPreview.classList.add('has-photo');
          };
          reader.readAsDataURL(file);
          validateField.call(profilePhotoInput);
          updateProgress();
        }
      });

      // File upload validation
      document.getElementById('licenseFront').addEventListener('change', function() {
        validateField.call(this);
        updateProgress();
      });
      
      document.getElementById('licenseBack').addEventListener('change', function() {
        validateField.call(this);
        updateProgress();
      });

      // Phone number formatting
      document.getElementById('contactNumber').addEventListener('input', formatPhoneNumber);

      // City search
      document.getElementById('startCity').addEventListener('input', searchCities);

      // GPS button
      document.getElementById('gpsBtn').addEventListener('click', getCurrentLocation);

      // Close suggestions on outside click
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.location-input')) {
          document.getElementById('citySuggestions').classList.remove('show');
        }
      });
    }

    // Language switching
    function setLang(lang) {
      currentLang = lang;
      
      // Update active language button
      document.querySelectorAll('.lang-switch button').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById('lang-' + lang).classList.add('active');
      
      // Update all translatable elements
      document.querySelectorAll('[data-kz]').forEach(el => {
        const text = el.getAttribute('data-' + lang);
        if (text) {
          el.textContent = text;
        }
      });
      
      updatePlaceholders();
      
      // Update Telegram MainButton text
      if (window.Telegram && Telegram.WebApp) {
        const buttonText = lang === 'kz' ? 'Тіркелу' : 'Зарегистрироваться';
        Telegram.WebApp.MainButton.setText(buttonText);
      }
    }

    // Update placeholders based on language
    function updatePlaceholders() {
      const placeholders = {
        kz: {
          firstName: 'Атыңызды енгізіңіз',
          lastName: 'Тегіңізді енгізіңіз',
          startCity: 'Қаланы енгізіңіз'
        },
        ru: {
          firstName: 'Введите имя',
          lastName: 'Введите фамилию',
          startCity: 'Введите город'
        }
      };

      Object.keys(placeholders[currentLang]).forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.placeholder = placeholders[currentLang][id];
        }
      });
    }

    // Phone number formatting
    function formatPhoneNumber(e) {
      let value = e.target.value.replace(/\D/g, '');
      let formattedValue = '';
      
      if (value.length > 0) {
        if (value.startsWith('8')) {
          value = '7' + value.substring(1);
        }
        if (!value.startsWith('7')) {
          value = '7' + value;
        }
        
        formattedValue = '+7';
        if (value.length > 1) {
          formattedValue += ' (' + value.substring(1, 4);
          if (value.length > 4) {
            formattedValue += ') ' + value.substring(4, 7);
            if (value.length > 7) {
              formattedValue += '-' + value.substring(7, 9);
              if (value.length > 9) {
                formattedValue += '-' + value.substring(9, 11);
              }
            }
          } else if (value.length > 1) {
            formattedValue += ')';
          }
        }
      }
      
      e.target.value = formattedValue;
      validateField.call(e.target);
    }

    // City search with OpenStreetMap Nominatim
    let searchTimeout;
    function searchCities(e) {
      const query = e.target.value;
      const suggestions = document.getElementById('citySuggestions');
      
      clearTimeout(searchTimeout);
      
      if (query.length < 3) {
        suggestions.classList.remove('show');
        return;
      }
      
      searchTimeout = setTimeout(async () => {
        try {
          const response = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=5&countrycodes=kz&city=${encodeURIComponent(query)}`
          );
          const data = await response.json();
          
          suggestions.innerHTML = '';
          
          if (data.length > 0) {
            data.forEach(item => {
              const div = document.createElement('div');
              div.className = 'suggestion-item';
              div.textContent = item.display_name.split(',')[0];
              div.onclick = function() {
                document.getElementById('startCity').value = item.display_name.split(',')[0];
                document.getElementById('latitude').value = item.lat;
                document.getElementById('longitude').value = item.lon;
                suggestions.classList.remove('show');
                
                validateField.call(document.getElementById('startCity'));
                showSuccessMessage('startCity', currentLang === 'kz' ? 'Қала таңдалды' : 'Город выбран');
              };
              suggestions.appendChild(div);
            });
            suggestions.classList.add('show');
          } else {
            suggestions.classList.remove('show');
          }
        } catch (error) {
          console.error('Search error:', error);
          suggestions.classList.remove('show');
        }
      }, 300);
    }

    // Get current location
    function getCurrentLocation() {
      const gpsBtn = document.getElementById('gpsBtn');
      const startCityInput = document.getElementById('startCity');
      
      if (!navigator.geolocation) {
        showErrorMessage('startCity', currentLang === 'kz' ? 'Геолокация қолдау көрсетілмейді' : 'Геолокация не поддерживается');
        return;
      }
      
      gpsBtn.classList.add('loading');
      gpsBtn.innerHTML = '⏳';
      
      navigator.geolocation.getCurrentPosition(
        async function(position) {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          
          try {
            const response = await fetch(
              `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`
            );
            const data = await response.json();
            
            if (data && data.address) {
              const city = data.address.city || data.address.town || data.address.village || data.address.state;
              startCityInput.value = city || data.display_name.split(',')[0];
              document.getElementById('latitude').value = lat;
              document.getElementById('longitude').value = lon;
              
              gpsBtn.classList.remove('loading');
              gpsBtn.classList.add('success');
              gpsBtn.innerHTML = '✅';
              
              validateField.call(startCityInput);
              showSuccessMessage('startCity', currentLang === 'kz' ? 'Орналасқан жер анықталды' : 'Местоположение определено');
              
              setTimeout(() => {
                gpsBtn.classList.remove('success');
                gpsBtn.innerHTML = '📍';
              }, 2000);
            }
          } catch (error) {
            console.error('Reverse geocoding error:', error);
            showErrorMessage('startCity', currentLang === 'kz' ? 'Қаланы анықтауда қате' : 'Ошибка определения города');
            gpsBtn.classList.remove('loading');
            gpsBtn.innerHTML = '📍';
          }
        },
        function(error) {
          console.error('Geolocation error:', error);
          let errorMsg = currentLang === 'kz' ? 'Геолокация қатесі' : 'Ошибка геолокации';
          
          switch(error.code) {
            case error.PERMISSION_DENIED:
              errorMsg = currentLang === 'kz' ? 'Геолокацияға кіру тыйым салынған' : 'Доступ к геолокации запрещен';
              break;
            case error.POSITION_UNAVAILABLE:
              errorMsg = currentLang === 'kz' ? 'Орналасқан жер қолжетімді емес' : 'Местоположение недоступно';
              break;
            case error.TIMEOUT:
              errorMsg = currentLang === 'kz' ? 'Күту уақыты аяқталды' : 'Время ожидания истекло';
              break;
          }
          
          showErrorMessage('startCity', errorMsg);
          gpsBtn.classList.remove('loading');
          gpsBtn.innerHTML = '📍';
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 60000
        }
      );
    }

    // Field validation
    function validateField() {
      const field = this;
      const fieldId = field.id;
      const value = field.value.trim();
      const formGroup = field.closest('.form-group');
      const errorElement = document.getElementById(fieldId + 'Error');
      
      let isValid = true;
      let errorMessage = '';
      
      // Clear previous states
      field.classList.remove('error', 'success');
      formGroup.classList.remove('valid', 'invalid');
      if (errorElement) {
        errorElement.textContent = '';
      }
      
      // Required field check
      if (field.hasAttribute('required') && !value && field.type !== 'file') {
        isValid = false;
        errorMessage = currentLang === 'kz' ? 'Бұл өріс міндетті' : 'Это поле обязательно';
      }
      
      // File field check
      if (field.type === 'file' && field.hasAttribute('required')) {
        if (field.files.length === 0) {
          isValid = false;
          errorMessage = currentLang === 'kz' ? 'Файл міндетті' : 'Файл обязателен';
        } else {
          const file = field.files[0];
          const maxSize = 3 * 1024 * 1024; // 3MB
          
          if (file.size > maxSize) {
            isValid = false;
            errorMessage = currentLang === 'kz' ? 
              `Файл тым үлкен (макс. 3МБ, сізде ${(file.size / (1024 * 1024)).toFixed(1)}МБ)` :
              `Файл слишком большой (макс. 3МБ, у вас ${(file.size / (1024 * 1024)).toFixed(1)}МБ)`;
          }
          
          if (fieldId === 'profilePhoto') {
            if (!file.type.startsWith('image/')) {
              isValid = false;
              errorMessage = currentLang === 'kz' ? 'Тек суреттер' : 'Только изображения';
            }
          } else {
            if (!file.type.startsWith('image/') && file.type !== 'application/pdf') {
              isValid = false;
              errorMessage = currentLang === 'kz' ? 'Тек суреттер немесе PDF' : 'Только изображения или PDF';
            }
          }
        }
      }
      
      // Specific validations
      switch (fieldId) {
        case 'firstName':
        case 'lastName':
          if (value && (value.length < 2 || value.length > 50)) {
            isValid = false;
            errorMessage = currentLang === 'kz' ? '2-ден 50-ге дейін символ' : 'От 2 до 50 символов';
          }
          break;
          
        case 'birthday':
          if (value) {
            const birthDate = new Date(value);
            const today = new Date();
            const age = today.getFullYear() - birthDate.getFullYear();
            if (age < 18 || age > 80) {
              isValid = false;
              errorMessage = currentLang === 'kz' ? 'Жасы 18-ден 80-ге дейін болуы керек' : 'Возраст должен быть от 18 до 80 лет';
            }
          }
          break;
          
        case 'contactNumber':
          const phoneRegex = /^\+7 \(\d{3}\) \d{3}-\d{2}-\d{2}$/;
          if (value && !phoneRegex.test(value)) {
            isValid = false;
            errorMessage = currentLang === 'kz' ? 'Нөмір форматы дұрыс емес' : 'Неверный формат номера';
          }
          break;
      }
      
      // Apply validation state
      if (isValid && (value || field.files.length > 0)) {
        field.classList.add('success');
        formGroup.classList.add('valid');
      } else if (!isValid) {
        field.classList.add('error');
        formGroup.classList.add('invalid');
        if (errorElement) {
          errorElement.textContent = errorMessage;
        }
      }
      
      return isValid;
    }

    // Show error message
    function showErrorMessage(fieldId, message) {
      const errorElement = document.getElementById(fieldId + 'Error');
      if (errorElement) {
        errorElement.textContent = message;
      }
    }

    // Show success message
    function showSuccessMessage(fieldId, message) {
      const successElement = document.getElementById(fieldId + 'Success');
      if (successElement) {
        successElement.textContent = message;
        setTimeout(() => {
          successElement.textContent = '';
        }, 3000);
      }
    }

    // Update progress bar and show Telegram button
    function updateProgress() {
      const form = document.getElementById('driverForm');
      const requiredFields = form.querySelectorAll('input[required]');
      let filledFields = 0;
      
      requiredFields.forEach(field => {
        if (field.type === 'file') {
          if (field.files.length > 0) filledFields++;
        } else if (field.value.trim()) {
          filledFields++;
        }
      });
      
      const progress = (filledFields / requiredFields.length) * 100;
      document.getElementById('progressFill').style.width = progress + '%';
      
      // Show/hide Telegram main button
      if (window.Telegram && Telegram.WebApp) {
        if (progress === 100) {
          const buttonText = currentLang === 'kz' ? 'Тіркелу' : 'Зарегистрироваться';
          Telegram.WebApp.MainButton.setText(buttonText);
          Telegram.WebApp.MainButton.show();
          
          // Remove any existing click handlers and add new one
          Telegram.WebApp.MainButton.offClick(submitForm);
          Telegram.WebApp.MainButton.onClick(submitForm);
        } else {
          Telegram.WebApp.MainButton.hide();
        }
      }
    }

    // Submit form with better error handling
    async function submitForm() {
      const form = document.getElementById('driverForm');

      const telegramId = document.getElementById('telegramId').value;
      if (!telegramId) {
        console.error('❌ Missing Telegram ID');
        // Try to recover Telegram ID
        if (window.Telegram?.WebApp?.initDataUnsafe?.user) {
          document.getElementById('telegramId').value = Telegram.WebApp.initDataUnsafe.user.id;
        } else {
          const errorMsg = currentLang === 'kz' ? 
            'Қате: Telegram пайдаланушы ID алынбады' :
            'Ошибка: не удалось получить ID пользователя Telegram';
          
          if (window.Telegram && Telegram.WebApp) {
            Telegram.WebApp.showAlert(errorMsg);
          } else {
            alert(errorMsg);
          }
          return;
        }
      }
      
      // Validate all fields
      let isFormValid = true;
      const requiredFields = form.querySelectorAll('input[required]');
      
      requiredFields.forEach(field => {
        if (!validateField.call(field)) {
          isFormValid = false;
        }
      });
      
      if (!isFormValid) {
        const errorMsg = currentLang === 'kz' ? 
          'Барлық өрістерді дұрыс толтырыңыз' :
          'Пожалуйста, заполните все поля корректно';
        
        if (window.Telegram && Telegram.WebApp) {
          Telegram.WebApp.showAlert(errorMsg);
        } else {
          alert(errorMsg);
        }
        return;
      }

      // Check file sizes before upload
      const fileInputs = ['profilePhoto', 'licenseFront', 'licenseBack'];
      let totalSize = 0;
      let oversizedFiles = [];
      
      for (const inputId of fileInputs) {
        const input = document.getElementById(inputId);
        if (input.files.length > 0) {
          const fileSize = input.files[0].size;
          totalSize += fileSize;
          
          // Check individual file size (3MB max)
          if (fileSize > 3 * 1024 * 1024) {
            oversizedFiles.push(`${inputId}: ${(fileSize / (1024 * 1024)).toFixed(1)}МБ`);
          }
        }
      }
      
      if (oversizedFiles.length > 0) {
        const errorMsg = currentLang === 'kz' ? 
          `Файлдар тым үлкен (макс. 3МБ әрқайсысы):\n${oversizedFiles.join('\n')}` :
          `Слишком большие файлы (макс. 3МБ каждый):\n${oversizedFiles.join('\n')}`;
        
        if (window.Telegram && Telegram.WebApp) {
          Telegram.WebApp.showAlert(errorMsg);
        } else {
          alert(errorMsg);
        }
        return;
      }
      
      if (totalSize > 9 * 1024 * 1024) { // 9MB total
        const errorMsg = currentLang === 'kz' ? 
          `Файлдардың жалпы көлемі тым үлкен (${(totalSize / (1024 * 1024)).toFixed(1)}МБ). Максимум 9МБ.` :
          `Общий размер файлов слишком большой (${(totalSize / (1024 * 1024)).toFixed(1)}МБ). Максимум 9МБ.`;
        
        if (window.Telegram && Telegram.WebApp) {
          Telegram.WebApp.showAlert(errorMsg);
        } else {
          alert(errorMsg);
        }
        return;
      }
      
      // Show loading state
      if (window.Telegram && Telegram.WebApp) {
        Telegram.WebApp.MainButton.showProgress();
        Telegram.WebApp.MainButton.setText(currentLang === 'kz' ? 'Тіркелуде...' : 'Регистрация...');
      }
      
      try {
        const formData = new FormData(form);
        
        // Debug: Log form data
        console.log('Submitting form data:');
        for (const [key, value] of formData.entries()) {
          if (value instanceof File) {
            console.log(key, `File(${value.name}, ${(value.size / 1024).toFixed(1)}KB, ${value.type})`);
          } else {
            console.log(key, value);
          }
        }
        
        console.log(`Total upload size: ${(totalSize / (1024 * 1024)).toFixed(1)}MB`);
        
        // Create abort controller for timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 90000); // 90 seconds timeout
        
        const response = await fetch('/api/driver/register', {
          method: 'POST',
          body: formData,
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        const result = await response.json();
        
        if (response.ok && result.success) {
          // Success
          const successMsg = currentLang === 'kz' ? 
            'Тіркелу сәтті! Растауды күтіңіз.' :
            'Регистрация успешна! Ожидайте подтверждения.';
          
          if (window.Telegram && Telegram.WebApp) {
            Telegram.WebApp.showAlert(successMsg, () => Telegram.WebApp.close());
          } else {
            alert(successMsg);
          }
        } else {
          // Error from server
          throw new Error(result.message || 'Registration failed');
        }
      } catch (error) {
        console.error('Registration error:', error);
        
        let errorMsg;
        if (error.name === 'AbortError') {
          errorMsg = currentLang === 'kz' ? 
            'Жүктеу уақыты аяқталды. Файл көлемін азайтып көріңіз.' :
            'Время загрузки истекло. Попробуйте уменьшить размер файлов.';
        } else if (error.message.includes('NetworkError') || error.message.includes('fetch')) {
          errorMsg = currentLang === 'kz' ? 
            'Желі қатесі. Интернет байланысын тексеріңіз.' :
            'Ошибка сети. Проверьте подключение к интернету.';
        } else {
          errorMsg = currentLang === 'kz' ? 
            `Тіркелу қатесі: ${error.message}` :
            `Ошибка регистрации: ${error.message}`;
        }
        
        if (window.Telegram && Telegram.WebApp) {
          Telegram.WebApp.showAlert(errorMsg);
        } else {
          alert(errorMsg);
        }
      } finally {
        // Hide loading state
        if (window.Telegram && Telegram.WebApp) {
          Telegram.WebApp.MainButton.hideProgress();
          const buttonText = currentLang === 'kz' ? 'Тіркелу' : 'Зарегистрироваться';
          Telegram.WebApp.MainButton.setText(buttonText);
        }
      }
    }

    // Global functions
    window.setLang = setLang;
  </script>
</body>
</html>