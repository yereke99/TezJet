<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤–æ–¥–∏—Ç–µ–ª—è | –ñ“Ø—Ä–≥—ñ–∑—É—à—ñ —Ç—ñ—Ä–∫–µ–ª—É—ñ</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root {
      /* Light theme - Uber colors */
      --bg-primary: #ffffff;
      --bg-secondary: #f8f9fa;
      --text-primary: #000000;
      --text-secondary: #6c757d;
      --text-muted: #9ca3af;
      --accent-primary: #000000;
      --accent-secondary: #276ef1;
      --input-bg: #ffffff;
      --input-border: #e5e7eb;
      --input-focus: #000000;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.15);
      --error-color: #dc3545;
      --success-color: #28a745;
      --warning-color: #ffc107;
    }

    [data-theme="dark"] {
      /* Dark theme */
      --bg-primary: #1a1a1a;
      --bg-secondary: #2d2d2d;
      --text-primary: #ffffff;
      --text-secondary: #b3b3b3;
      --text-muted: #666666;
      --accent-primary: #ffffff;
      --accent-secondary: #276ef1;
      --input-bg: #2d2d2d;
      --input-border: #444444;
      --input-focus: #ffffff;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.5);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      height: 100vh;
      height: 100dvh;
      overflow-x: hidden;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      position: fixed;
      width: 100%;
      top: 0;
      left: 0;
      padding-top: env(safe-area-inset-top, 20px);
      padding-bottom: env(safe-area-inset-bottom, 0px);
    }

    .container {
      max-width: 420px;
      margin: 0 auto;
      padding: 0 20px 120px;
      position: relative;
      min-height: 100vh;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
    }

    /* Language Switch */
    .lang-switch {
      position: fixed;
      top: 10px;
      right: 15px;
      display: flex;
      gap: 2px;
      z-index: 1000;
      background: var(--bg-secondary);
      border-radius: 20px;
      padding: 4px;
      box-shadow: var(--shadow-sm);
    }

    .lang-switch button {
      background: transparent;
      color: var(--text-secondary);
      border: none;
      border-radius: 16px;
      padding: 6px 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 12px;
      transition: all 0.2s ease;
    }

    .lang-switch button.active {
      background: var(--accent-primary);
      color: var(--bg-primary);
    }

    /* Header */
    .header {
      text-align: center;
      margin: 60px 0 40px;
      width: 100%;
    }

    .logo {
      width: 80px;
      height: 80px;
      background: var(--accent-primary);
      border-radius: 20px;
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      color: var(--bg-primary);
      font-weight: 700;
      box-shadow: var(--shadow-md);
    }

    .title {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
      letter-spacing: -0.02em;
    }

    .subtitle {
      font-size: 16px;
      color: var(--text-secondary);
      font-weight: 400;
    }

    /* Form Container */
    .form-container {
      width: 100%;
      max-width: 400px;
      flex: 1;
    }

    /* Form */
    .form-group {
      margin-bottom: 24px;
      position: relative;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 14px;
      color: var(--text-primary);
    }

    .required {
      color: var(--error-color);
    }

    input[type="text"],
    input[type="tel"],
    input[type="date"],
    input[type="file"] {
      width: 100%;
      padding: 16px;
      font-size: 16px;
      border: 2px solid var(--input-border);
      border-radius: 12px;
      background: var(--input-bg);
      color: var(--text-primary);
      transition: all 0.2s ease;
      font-weight: 500;
    }

    input:focus {
      outline: none;
      border-color: var(--input-focus);
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
    }

    input.error {
      border-color: var(--error-color);
      box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
    }

    input.success {
      border-color: var(--success-color);
      box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
    }

    /* Profile Photo Preview - FIXED */
    .profile-photo-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .profile-photo-preview {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 3px solid var(--input-border);
      background: var(--bg-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      color: var(--text-muted);
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .profile-photo-preview:hover {
      border-color: var(--input-focus);
      transform: scale(1.02);
    }

    .profile-photo-preview.has-photo {
      border-color: var(--success-color);
    }

    .profile-photo-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* File Upload Styling */
    input[type="file"] {
      padding: 12px;
      cursor: pointer;
      border: 2px dashed var(--input-border);
      background: var(--bg-secondary);
      position: relative;
      transition: all 0.2s ease;
    }

    input[type="file"]:hover {
      border-color: var(--input-focus);
      background: var(--input-bg);
    }

    input[type="file"]::file-selector-button {
      background: var(--accent-primary);
      color: var(--bg-primary);
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      margin-right: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.85rem;
      transition: all 0.2s ease;
    }

    /* Map - Uber Style Fullscreen */
    .map-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 2000;
      background: var(--bg-primary);
      transform: translateY(100%);
      transition: transform 0.3s ease-out;
      display: none;
    }

    .map-container.open {
      transform: translateY(0);
      display: block;
    }

    .map-header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      z-index: 2001;
      background: var(--bg-primary);
      padding: env(safe-area-inset-top, 20px) 20px 20px;
      border-bottom: 1px solid var(--input-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    .map-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .map-close-btn {
      background: var(--bg-secondary);
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-primary);
      font-size: 18px;
      transition: all 0.2s ease;
    }

    .map-close-btn:hover {
      background: var(--input-border);
      transform: scale(1.05);
    }

    .map-search {
      position: absolute;
      top: calc(env(safe-area-inset-top, 20px) + 70px);
      left: 20px;
      right: 20px;
      z-index: 2001;
      background: var(--input-bg);
      border: 2px solid var(--input-border);
      border-radius: 12px;
      padding: 16px;
      font-size: 16px;
      font-weight: 500;
      color: var(--text-primary);
      box-shadow: var(--shadow-lg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    .map-search:focus {
      outline: none;
      border-color: var(--input-focus);
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
    }

    .map-confirm-btn {
      position: absolute;
      bottom: calc(env(safe-area-inset-bottom, 20px) + 20px);
      left: 20px;
      right: 20px;
      z-index: 2001;
      background: var(--accent-primary);
      color: var(--bg-primary);
      border: none;
      border-radius: 16px;
      padding: 18px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: var(--shadow-lg);
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .map-confirm-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
    }

    .map-confirm-btn:disabled {
      background: var(--text-muted);
      cursor: not-allowed;
      transform: none;
    }

    .current-location-btn {
      position: absolute;
      bottom: calc(env(safe-area-inset-bottom, 20px) + 90px);
      right: 20px;
      z-index: 2001;
      background: var(--bg-primary);
      border: 2px solid var(--input-border);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      color: var(--text-primary);
      box-shadow: var(--shadow-lg);
      transition: all 0.2s ease;
    }

    .current-location-btn:hover {
      transform: scale(1.05);
      border-color: var(--input-focus);
    }

    .current-location-btn.loading {
      background: var(--warning-color);
      border-color: var(--warning-color);
      color: white;
      animation: pulse 1.5s infinite;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .map-toggle-btn {
      width: 100%;
      padding: 16px;
      border: 2px solid var(--input-border);
      border-radius: 12px;
      background: var(--input-bg);
      color: var(--text-primary);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 8px;
    }

    .map-toggle-btn:hover {
      border-color: var(--input-focus);
      background: var(--bg-secondary);
      transform: translateY(-1px);
    }

    /* Location Input Group */
    .location-input-group {
      display: flex;
      gap: 8px;
      align-items: end;
    }

    .location-input {
      flex: 1;
    }

    .gps-btn {
      padding: 16px;
      border: 2px solid var(--input-border);
      border-radius: 12px;
      background: var(--input-bg);
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 56px;
    }

    .gps-btn:hover {
      border-color: var(--input-focus);
      background: var(--bg-secondary);
    }

    .gps-btn.loading {
      background: var(--warning-color);
      border-color: var(--warning-color);
      color: white;
      animation: pulse 1.5s infinite;
    }

    .gps-btn.success {
      background: var(--success-color);
      border-color: var(--success-color);
      color: white;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    /* Search Suggestions */
    .suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--input-bg);
      border: 2px solid var(--input-border);
      border-top: none;
      border-radius: 0 0 12px 12px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      display: none;
      box-shadow: var(--shadow-md);
    }

    .suggestions.show {
      display: block;
    }

    .suggestion-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid var(--input-border);
      transition: background 0.2s ease;
    }

    .suggestion-item:hover {
      background: var(--bg-secondary);
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    /* Error Messages */
    .error-message {
      color: var(--error-color);
      font-size: 12px;
      margin-top: 4px;
      font-weight: 500;
    }

    /* Success Messages */
    .success-message {
      color: var(--success-color);
      font-size: 12px;
      margin-top: 4px;
      font-weight: 500;
    }

    /* Progress Bar */
    .progress-bar {
      width: 100%;
      height: 4px;
      background: var(--bg-secondary);
      border-radius: 2px;
      margin: 20px 0;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--accent-primary);
      border-radius: 2px;
      transition: width 0.3s ease;
      width: 0%;
    }

    /* Floating Action Button (Telegram Main Button Alternative) */
    .fab {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--accent-primary);
      color: var(--bg-primary);
      border: none;
      border-radius: 25px;
      padding: 16px 32px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: var(--shadow-lg);
      transition: all 0.3s ease;
      display: none;
      align-items: center;
      gap: 8px;
      z-index: 1000;
      min-width: 200px;
      justify-content: center;
    }

    .fab.show {
      display: flex;
    }

    .fab:hover {
      transform: translateX(-50%) translateY(-2px);
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
    }

    .fab:disabled {
      background: var(--text-muted);
      cursor: not-allowed;
      transform: translateX(-50%);
      box-shadow: var(--shadow-md);
    }

    .fab .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: none;
    }

    .fab.loading .loading-spinner {
      display: block;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 480px) {
      .container {
        padding: 0 16px 100px;
      }

      .form-row {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .location-input-group {
        flex-direction: column;
        gap: 12px;
      }

      .gps-btn {
        width: 100%;
      }
    }

    /* iOS specific adjustments */
    @supports (padding: max(0px)) {
      .fab {
        bottom: max(20px, env(safe-area-inset-bottom));
      }
    }

    /* Prevent layout shifts */
    html {
      overflow-x: hidden;
      -webkit-text-size-adjust: 100%;
      -ms-text-size-adjust: 100%;
    }

    /* Disable zoom on inputs */
    input[type="text"],
    input[type="tel"],
    input[type="date"],
    input[type="file"],
    input {
      font-size: 16px !important;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }

    /* Prevent viewport jumping */
    .container {
      -webkit-transform: translate3d(0, 0, 0);
      transform: translate3d(0, 0, 0);
    }

    /* Smooth scrolling */
    html {
      scroll-behavior: smooth;
    }

    /* Loading states */
    .loading {
      pointer-events: none;
      opacity: 0.6;
    }

    /* Hidden elements */
    .hidden {
      display: none !important;
    }

    /* Form validation styles */
    .form-group.valid input {
      border-color: var(--success-color);
    }

    .form-group.invalid input {
      border-color: var(--error-color);
    }

    /* Custom date input */
    input[type="date"] {
      position: relative;
    }

    input[type="date"]::-webkit-calendar-picker-indicator {
      background: transparent;
      bottom: 0;
      color: transparent;
      cursor: pointer;
      height: auto;
      left: 0;
      position: absolute;
      right: 0;
      top: 0;
      width: auto;
    }
  </style>
</head>
<body>
  <!-- Language Switch -->
  <div class="lang-switch">
    <button onclick="setLang('ru')" id="lang-ru" class="active">RU</button>
    <button onclick="setLang('kz')" id="lang-kz">KZ</button>
  </div>

  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="logo">üöó</div>
      <h1 class="title" data-ru="–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤–æ–¥–∏—Ç–µ–ª—è" data-kz="–ñ“Ø—Ä–≥—ñ–∑—É—à—ñ —Ç—ñ—Ä–∫–µ–ª—É—ñ">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤–æ–¥–∏—Ç–µ–ª—è</h1>
      <p class="subtitle" data-ru="–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã" data-kz="–ñ“±–º—ã—Å—Ç—ã –±–∞—Å—Ç–∞—É “Ø—à—ñ–Ω –¥–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ —Ç–æ–ª—Ç—ã—Ä—ã“£—ã–∑">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã</p>
    </div>

    <!-- Progress Bar -->
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>

    <!-- Registration Form -->
    <div class="form-container">
      <form id="driverForm" enctype="multipart/form-data">
        <!-- Name Fields -->
        <div class="form-row">
          <div class="form-group">
            <label for="firstName">
              <span data-ru="–ò–º—è" data-kz="–ê—Ç—ã">–ò–º—è</span>
              <span class="required">*</span>
            </label>
            <input type="text" id="firstName" name="firstName" required 
                   data-placeholder-ru="–í–≤–µ–¥–∏—Ç–µ –∏–º—è" data-placeholder-kz="–ê—Ç—ã“£—ã–∑–¥—ã –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑">
            <div class="error-message" id="firstNameError"></div>
          </div>
          <div class="form-group">
            <label for="lastName">
              <span data-ru="–§–∞–º–∏–ª–∏—è" data-kz="–¢–µ–≥—ñ">–§–∞–º–∏–ª–∏—è</span>
              <span class="required">*</span>
            </label>
            <input type="text" id="lastName" name="lastName" required
                   data-placeholder-ru="–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é" data-placeholder-kz="–¢–µ–≥—ñ“£—ñ–∑–¥—ñ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑">
            <div class="error-message" id="lastNameError"></div>
          </div>
        </div>

        <!-- Profile Photo -->
        <div class="form-group">
          <label for="profilePhoto">
            <span data-ru="–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è" data-kz="–ü—Ä–æ—Ñ–∏–ª—å —Ñ–æ—Ç–æ—Å—ã">–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è</span>
            <span class="required">*</span>
          </label>
          
          <div class="profile-photo-container">
            <div class="profile-photo-preview" id="profilePhotoPreview" onclick="document.getElementById('profilePhoto').click()">
              üë§
            </div>
            <input type="file" id="profilePhoto" name="profilePhoto" accept="image/*" capture="environment" required style="display: none;">
          </div>
          
          <div class="error-message" id="profilePhotoError"></div>
        </div>

        <!-- Birthday -->
        <div class="form-group">
          <label for="birthday">
            <span data-ru="–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è" data-kz="–¢—É“ì–∞–Ω –∫“Ø–Ω—ñ">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</span>
            <span class="required">*</span>
          </label>
          <input type="date" id="birthday" name="birthday" required max="2006-01-01">
          <div class="error-message" id="birthdayError"></div>
        </div>

        <!-- Driver License Front -->
        <div class="form-group">
          <label for="licenseFront">
            <span data-ru="–í–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ (–ª–∏—Ü–µ–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞)" data-kz="–ñ“Ø—Ä–≥—ñ–∑—É—à—ñ –∫—É”ô–ª—ñ–≥—ñ (–∞–ª–¥—ã“£“ì—ã –∂–∞“ì—ã)">–í–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ (–ª–∏—Ü–µ–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞)</span>
            <span class="required">*</span>
          </label>
          <input type="file" id="licenseFront" name="licenseFront" accept="image/*,.pdf" required>
          <div class="error-message" id="licenseFrontError"></div>
        </div>

        <!-- Driver License Back -->
        <div class="form-group">
          <label for="licenseBack">
            <span data-ru="–í–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ (–æ–±—Ä–∞—Ç–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞)" data-kz="–ñ“Ø—Ä–≥—ñ–∑—É—à—ñ –∫—É”ô–ª—ñ–≥—ñ (–∞—Ä—Ç“õ—ã –∂–∞“ì—ã)">–í–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ (–æ–±—Ä–∞—Ç–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞)</span>
            <span class="required">*</span>
          </label>
          <input type="file" id="licenseBack" name="licenseBack" accept="image/*,.pdf" required>
          <div class="error-message" id="licenseBackError"></div>
        </div>

        <!-- Contact Number -->
        <div class="form-group">
          <label for="contactNumber">
            <span data-ru="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞" data-kz="–¢–µ–ª–µ—Ñ–æ–Ω –Ω”©–º—ñ—Ä—ñ">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</span>
            <span class="required">*</span>
          </label>
          <input type="tel" id="contactNumber" name="contactNumber" required
                 placeholder="+7 (___) ___-__-__">
          <div class="error-message" id="contactNumberError"></div>
          <div class="success-message" id="contactNumberSuccess"></div>
        </div>

        <!-- Start City -->
        <div class="form-group">
          <label for="startCity">
            <span data-ru="–ì–æ—Ä–æ–¥ —Ä–∞–±–æ—Ç—ã" data-kz="–ñ“±–º—ã—Å “õ–∞–ª–∞—Å—ã">–ì–æ—Ä–æ–¥ —Ä–∞–±–æ—Ç—ã</span>
            <span class="required">*</span>
          </label>
          <div class="location-input-group">
            <div class="location-input">
              <input type="text" id="startCity" name="startCity" required
                     data-placeholder-ru="–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ" 
                     data-placeholder-kz="“ö–∞–ª–∞–Ω—ã –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑ –Ω–µ–º–µ—Å–µ –∫–∞—Ä—Ç–∞–¥–∞–Ω —Ç–∞“£–¥–∞“£—ã–∑">
              <div class="suggestions" id="citySuggestions"></div>
            </div>
            <button type="button" class="gps-btn" id="gpsBtn" 
                    data-title-ru="–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ" 
                    data-title-kz="–û—Ä–Ω–∞–ª–∞—Å“õ–∞–Ω –∂–µ—Ä–¥—ñ –∞–Ω—ã“õ—Ç–∞—É">üìç</button>
          </div>
          <button type="button" class="map-toggle-btn" id="mapToggleBtn">
            <span>üó∫Ô∏è</span>
            <span data-ru="–í—ã–±—Ä–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ" data-kz="–ö–∞—Ä—Ç–∞–¥–∞–Ω —Ç–∞“£–¥–∞—É">–í—ã–±—Ä–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ</span>
          </button>
          
          <!-- Map Container -->
          <div class="map-container" id="mapContainer">
            <div class="map-header">
              <div class="map-title" data-ru="–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ" data-kz="–û—Ä–Ω–∞–ª–∞—Å“õ–∞–Ω –∂–µ—Ä–¥—ñ —Ç–∞“£–¥–∞“£—ã–∑">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</div>
              <button class="map-close-btn" id="mapCloseBtn">√ó</button>
            </div>
            <input type="text" class="map-search" id="mapSearch" 
                   data-placeholder-ru="–ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞..." 
                   data-placeholder-kz="–ú–µ–∫–µ–Ω–∂–∞–π —ñ–∑–¥–µ—É..."
                   placeholder="–ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞...">
            <div id="map"></div>
            <button class="current-location-btn" id="mapGpsBtn">üìç</button>
            <button class="map-confirm-btn" id="mapConfirmBtn" disabled>
              <span>‚úì</span>
              <span data-ru="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–±–æ—Ä" data-kz="–¢–∞“£–¥–∞—É–¥—ã —Ä–∞—Å—Ç–∞—É">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–±–æ—Ä</span>
            </button>
          </div>
          
          <div class="error-message" id="startCityError"></div>
          <div class="success-message" id="startCitySuccess"></div>
        </div>

        <!-- Hidden fields for coordinates -->
        <input type="hidden" id="latitude" name="latitude">
        <input type="hidden" id="longitude" name="longitude">
        <input type="hidden" id="telegramId" name="telegramId">
      </form>
    </div>

    <!-- Register Button (FAB) -->
    <button type="button" class="fab" id="registerBtn">
      <div class="loading-spinner"></div>
      <span data-ru="–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è" data-kz="–¢—ñ—Ä–∫–µ–ª—É">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</span>
    </button>
  </div>

  <script>
    // Global variables
    let currentLang = 'ru';
    let map = null;
    let mapMarker = null;
    let isMapOpen = false;
    
    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
      initializeTelegram();
      setupEventListeners();
      updatePlaceholders();
      updateProgress();
    });

    // Initialize Telegram WebApp
    function initializeTelegram() {
      if (window.Telegram && Telegram.WebApp) {
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        Telegram.WebApp.enableClosingConfirmation();
        
        // Disable viewport changes
        Telegram.WebApp.disableVerticalSwipes();
        
        const user = Telegram.WebApp.initDataUnsafe?.user;
        if (user) {
          document.getElementById('telegramId').value = user.id;
        }

        // Theme handling
        if (Telegram.WebApp.colorScheme === 'dark') {
          document.documentElement.setAttribute('data-theme', 'dark');
        }

        Telegram.WebApp.onEvent('themeChanged', function() {
          document.documentElement.setAttribute('data-theme', Telegram.WebApp.colorScheme);
        });

        // Prevent viewport changes
        Telegram.WebApp.onEvent('viewportChanged', function() {
          // Do nothing to prevent shaking
        });
      }
    }

    // Setup event listeners
    function setupEventListeners() {
      // Form validation
      const form = document.getElementById('driverForm');
      const inputs = form.querySelectorAll('input[required]');
      
      inputs.forEach(input => {
        input.addEventListener('blur', validateField);
        input.addEventListener('input', updateProgress);
      });

      // FIXED: Profile Photo handling
      const profilePhotoInput = document.getElementById('profilePhoto');
      const profilePhotoPreview = document.getElementById('profilePhotoPreview');
      
      profilePhotoInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            profilePhotoPreview.innerHTML = `<img src="${e.target.result}" alt="Profile">`;
            profilePhotoPreview.classList.add('has-photo');
          };
          reader.readAsDataURL(file);
          validateField.call(profilePhotoInput);
          updateProgress();
        }
      });

      // File upload validation
      document.getElementById('licenseFront').addEventListener('change', function() {
        validateField.call(this);
        updateProgress();
      });
      
      document.getElementById('licenseBack').addEventListener('change', function() {
        validateField.call(this);
        updateProgress();
      });

      // Phone number formatting
      document.getElementById('contactNumber').addEventListener('input', formatPhoneNumber);

      // City search
      document.getElementById('startCity').addEventListener('input', searchCities);

      // GPS button
      document.getElementById('gpsBtn').addEventListener('click', getCurrentLocation);

      // Map toggle
      document.getElementById('mapToggleBtn').addEventListener('click', openMap);
      document.getElementById('mapCloseBtn').addEventListener('click', closeMap);
      document.getElementById('mapConfirmBtn').addEventListener('click', confirmMapSelection);
      document.getElementById('mapGpsBtn').addEventListener('click', getCurrentLocationOnMap);
      document.getElementById('mapSearch').addEventListener('input', searchOnMap);

      // Register button
      document.getElementById('registerBtn').addEventListener('click', submitForm);

      // Close suggestions on outside click
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.location-input')) {
          document.getElementById('citySuggestions').classList.remove('show');
        }
      });
    }

    // Language switching
    function setLang(lang) {
      currentLang = lang;
      
      // Update active language button
      document.querySelectorAll('.lang-switch button').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById('lang-' + lang).classList.add('active');
      
      // Update all translatable elements
      document.querySelectorAll('[data-ru]').forEach(el => {
        const text = el.getAttribute('data-' + lang);
        if (text) {
          el.textContent = text;
        }
      });
      
      updatePlaceholders();
    }

    // Update placeholders based on language
    function updatePlaceholders() {
      const placeholders = {
        ru: {
          firstName: '–í–≤–µ–¥–∏—Ç–µ –∏–º—è',
          lastName: '–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é',
          startCity: '–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ'
        },
        kz: {
          firstName: '–ê—Ç—ã“£—ã–∑–¥—ã –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑',
          lastName: '–¢–µ–≥—ñ“£—ñ–∑–¥—ñ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑',
          startCity: '“ö–∞–ª–∞–Ω—ã –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑ –Ω–µ–º–µ—Å–µ –∫–∞—Ä—Ç–∞–¥–∞–Ω —Ç–∞“£–¥–∞“£—ã–∑'
        }
      };

      Object.keys(placeholders[currentLang]).forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.placeholder = placeholders[currentLang][id];
        }
      });
    }

    // Phone number formatting
    function formatPhoneNumber(e) {
      let value = e.target.value.replace(/\D/g, '');
      let formattedValue = '';
      
      if (value.length > 0) {
        if (value.startsWith('8')) {
          value = '7' + value.substring(1);
        }
        if (!value.startsWith('7')) {
          value = '7' + value;
        }
        
        formattedValue = '+7';
        if (value.length > 1) {
          formattedValue += ' (' + value.substring(1, 4);
          if (value.length > 4) {
            formattedValue += ') ' + value.substring(4, 7);
            if (value.length > 7) {
              formattedValue += '-' + value.substring(7, 9);
              if (value.length > 9) {
                formattedValue += '-' + value.substring(9, 11);
              }
            }
          } else if (value.length > 1) {
            formattedValue += ')';
          }
        }
      }
      
      e.target.value = formattedValue;
      validateField.call(e.target);
    }

    // City search with OpenStreetMap Nominatim
    let searchTimeout;
    function searchCities(e) {
      const query = e.target.value;
      const suggestions = document.getElementById('citySuggestions');
      
      clearTimeout(searchTimeout);
      
      if (query.length < 3) {
        suggestions.classList.remove('show');
        return;
      }
      
      searchTimeout = setTimeout(async () => {
        try {
          const response = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=5&countrycodes=kz&city=${encodeURIComponent(query)}`
          );
          const data = await response.json();
          
          suggestions.innerHTML = '';
          
          if (data.length > 0) {
            data.forEach(item => {
              const div = document.createElement('div');
              div.className = 'suggestion-item';
              div.textContent = item.display_name.split(',')[0];
              div.onclick = function() {
                document.getElementById('startCity').value = item.display_name.split(',')[0];
                document.getElementById('latitude').value = item.lat;
                document.getElementById('longitude').value = item.lon;
                suggestions.classList.remove('show');
                
                if (map && mapMarker) {
                  updateMapMarker(parseFloat(item.lat), parseFloat(item.lon));
                }
                
                validateField.call(document.getElementById('startCity'));
                showSuccessMessage('startCity', currentLang === 'ru' ? '–ì–æ—Ä–æ–¥ –≤—ã–±—Ä–∞–Ω' : '“ö–∞–ª–∞ —Ç–∞“£–¥–∞–ª–¥—ã');
              };
              suggestions.appendChild(div);
            });
            suggestions.classList.add('show');
          } else {
            suggestions.classList.remove('show');
          }
        } catch (error) {
          console.error('Search error:', error);
          suggestions.classList.remove('show');
        }
      }, 300);
    }

    // Get current location
    function getCurrentLocation() {
      const gpsBtn = document.getElementById('gpsBtn');
      const startCityInput = document.getElementById('startCity');
      
      if (!navigator.geolocation) {
        showErrorMessage('startCity', currentLang === 'ru' ? '–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è' : '–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è “õ–æ–ª–¥–∞—É –∫”©—Ä—Å–µ—Ç—ñ–ª–º–µ–π–¥—ñ');
        return;
      }
      
      gpsBtn.classList.add('loading');
      gpsBtn.innerHTML = '‚è≥';
      
      navigator.geolocation.getCurrentPosition(
        async function(position) {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          
          try {
            const response = await fetch(
              `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`
            );
            const data = await response.json();
            
            if (data && data.address) {
              const city = data.address.city || data.address.town || data.address.village || data.address.state;
              startCityInput.value = city || data.display_name.split(',')[0];
              document.getElementById('latitude').value = lat;
              document.getElementById('longitude').value = lon;
              
              if (map && mapMarker) {
                updateMapMarker(lat, lon);
              }
              
              gpsBtn.classList.remove('loading');
              gpsBtn.classList.add('success');
              gpsBtn.innerHTML = '‚úÖ';
              
              validateField.call(startCityInput);
              showSuccessMessage('startCity', currentLang === 'ru' ? '–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ' : '–û—Ä–Ω–∞–ª–∞—Å“õ–∞–Ω –∂–µ—Ä –∞–Ω—ã“õ—Ç–∞–ª–¥—ã');
              
              setTimeout(() => {
                gpsBtn.classList.remove('success');
                gpsBtn.innerHTML = 'üìç';
              }, 2000);
            }
          } catch (error) {
            console.error('Reverse geocoding error:', error);
            showErrorMessage('startCity', currentLang === 'ru' ? '–û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≥–æ—Ä–æ–¥–∞' : '“ö–∞–ª–∞–Ω—ã –∞–Ω—ã“õ—Ç–∞—É–¥–∞ “õ–∞—Ç–µ');
            gpsBtn.classList.remove('loading');
            gpsBtn.innerHTML = 'üìç';
          }
        },
        function(error) {
          console.error('Geolocation error:', error);
          let errorMsg = currentLang === 'ru' ? '–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏' : '–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è “õ–∞—Ç–µ—Å—ñ';
          
          switch(error.code) {
            case error.PERMISSION_DENIED:
              errorMsg = currentLang === 'ru' ? '–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â–µ–Ω' : '–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è“ì–∞ –∫—ñ—Ä—É —Ç—ã–π—ã–º —Å–∞–ª—ã–Ω“ì–∞–Ω';
              break;
            case error.POSITION_UNAVAILABLE:
              errorMsg = currentLang === 'ru' ? '–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ' : '–û—Ä–Ω–∞–ª–∞—Å“õ–∞–Ω –∂–µ—Ä “õ–æ–ª–∂–µ—Ç—ñ–º–¥—ñ –µ–º–µ—Å';
              break;
            case error.TIMEOUT:
              errorMsg = currentLang === 'ru' ? '–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ' : '–ö“Ø—Ç—É —É–∞“õ—ã—Ç—ã –∞—è“õ—Ç–∞–ª–¥—ã';
              break;
          }
          
          showErrorMessage('startCity', errorMsg);
          gpsBtn.classList.remove('loading');
          gpsBtn.innerHTML = 'üìç';
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 60000
        }
      );
    }

    // Open Uber-style fullscreen map
    function openMap() {
      const mapContainer = document.getElementById('mapContainer');
      mapContainer.classList.add('open');
      document.body.style.overflow = 'hidden';
      
      if (!map) {
        setTimeout(() => {
          initializeMap();
        }, 300);
      }
      
      // Update search placeholder
      updateMapPlaceholder();
    }

    // Close map
    function closeMap() {
      const mapContainer = document.getElementById('mapContainer');
      mapContainer.classList.remove('open');
      document.body.style.overflow = '';
    }

    // Confirm map selection
    function confirmMapSelection() {
      const lat = parseFloat(document.getElementById('latitude').value);
      const lon = parseFloat(document.getElementById('longitude').value);
      
      if (lat && lon) {
        closeMap();
        validateField.call(document.getElementById('startCity'));
        showSuccessMessage('startCity', currentLang === 'ru' ? '–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–æ' : '–û—Ä–Ω–∞–ª–∞—Å“õ–∞–Ω –∂–µ—Ä —Ç–∞“£–¥–∞–ª–¥—ã');
      }
    }

    // Update map search placeholder
    function updateMapPlaceholder() {
      const mapSearch = document.getElementById('mapSearch');
      if (mapSearch) {
        mapSearch.placeholder = currentLang === 'ru' ? '–ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞...' : '–ú–µ–∫–µ–Ω–∂–∞–π —ñ–∑–¥–µ—É...';
      }
    }

    // Search on map
    let mapSearchTimeout;
    function searchOnMap(e) {
      const query = e.target.value;
      
      clearTimeout(mapSearchTimeout);
      
      if (query.length < 3) return;
      
      mapSearchTimeout = setTimeout(async () => {
        try {
          const response = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=1&countrycodes=kz&q=${encodeURIComponent(query)}`
          );
          const data = await response.json();
          
          if (data.length > 0) {
            const item = data[0];
            const lat = parseFloat(item.lat);
            const lon = parseFloat(item.lon);
            
            updateMapMarker(lat, lon);
            document.getElementById('startCity').value = item.display_name.split(',')[0];
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lon;
            document.getElementById('mapConfirmBtn').disabled = false;
          }
        } catch (error) {
          console.error('Map search error:', error);
        }
      }, 500);
    }

    // Get current location on map
    function getCurrentLocationOnMap() {
      const mapGpsBtn = document.getElementById('mapGpsBtn');
      
      if (!navigator.geolocation) return;
      
      mapGpsBtn.classList.add('loading');
      
      navigator.geolocation.getCurrentPosition(
        async function(position) {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          
          try {
            const response = await fetch(
              `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`
            );
            const data = await response.json();
            
            if (data && data.address) {
              const city = data.address.city || data.address.town || data.address.village || data.address.state;
              document.getElementById('startCity').value = city || data.display_name.split(',')[0];
              document.getElementById('latitude').value = lat;
              document.getElementById('longitude').value = lon;
              document.getElementById('mapSearch').value = city || data.display_name.split(',')[0];
              document.getElementById('mapConfirmBtn').disabled = false;
              
              updateMapMarker(lat, lon);
            }
            
            mapGpsBtn.classList.remove('loading');
          } catch (error) {
            console.error('Reverse geocoding error:', error);
            mapGpsBtn.classList.remove('loading');
          }
        },
        function(error) {
          console.error('Geolocation error:', error);
          mapGpsBtn.classList.remove('loading');
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 60000
        }
      );
    }

    // Initialize map
    function initializeMap() {
      const lat = parseFloat(document.getElementById('latitude').value) || 43.238949;
      const lon = parseFloat(document.getElementById('longitude').value) || 76.889709;
      
      if (map) {
        map.remove();
      }
      
      map = L.map('map', {
        zoomControl: false,
        attributionControl: false
      }).setView([lat, lon], 13);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
      }).addTo(map);
      
      // Custom zoom controls
      L.control.zoom({
        position: 'bottomleft'
      }).addTo(map);
      
      mapMarker = L.marker([lat, lon], { 
        draggable: true,
        icon: L.divIcon({
          className: 'custom-map-marker',
          html: '<div style="background: #000; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">üìç</div>',
          iconSize: [30, 30],
          iconAnchor: [15, 30]
        })
      }).addTo(map);
      
      mapMarker.on('dragend', async function(e) {
        const position = e.target.getLatLng();
        await updateLocationFromMap(position.lat, position.lng);
      });
      
      map.on('click', async function(e) {
        const lat = e.latlng.lat;
        const lon = e.latlng.lng;
        
        updateMapMarker(lat, lon);
        await updateLocationFromMap(lat, lon);
      });
      
      // Force map resize
      setTimeout(() => {
        map.invalidateSize();
      }, 100);
    }

    // Update location from map interaction
    async function updateLocationFromMap(lat, lon) {
      try {
        document.getElementById('latitude').value = lat;
        document.getElementById('longitude').value = lon;
        document.getElementById('mapConfirmBtn').disabled = false;
        
        const response = await fetch(
          `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`
        );
        const data = await response.json();
        
        if (data && data.address) {
          const city = data.address.city || data.address.town || data.address.village || data.address.state;
          const address = city || data.display_name.split(',')[0];
          document.getElementById('startCity').value = address;
          document.getElementById('mapSearch').value = address;
        }
      } catch (error) {
        console.error('Reverse geocoding error:', error);
      }
    }

    // Update map marker
    function updateMapMarker(lat, lon) {
      if (map && mapMarker) {
        mapMarker.setLatLng([lat, lon]);
        map.setView([lat, lon], 12);
      }
    }

    // Field validation
    function validateField() {
      const field = this;
      const fieldId = field.id;
      const value = field.value.trim();
      const formGroup = field.closest('.form-group');
      const errorElement = document.getElementById(fieldId + 'Error');
      
      let isValid = true;
      let errorMessage = '';
      
      // Clear previous states
      field.classList.remove('error', 'success');
      formGroup.classList.remove('valid', 'invalid');
      if (errorElement) {
        errorElement.textContent = '';
      }
      
      // Required field check
      if (field.hasAttribute('required') && !value && field.type !== 'file') {
        isValid = false;
        errorMessage = currentLang === 'ru' ? '–≠—Ç–æ –ø–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ' : '–ë“±–ª ”©—Ä—ñ—Å –º—ñ–Ω–¥–µ—Ç—Ç—ñ';
      }
      
      // File field check
      if (field.type === 'file' && field.hasAttribute('required')) {
        if (field.files.length === 0) {
          isValid = false;
          errorMessage = currentLang === 'ru' ? '–§–∞–π–ª –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω' : '–§–∞–π–ª –º—ñ–Ω–¥–µ—Ç—Ç—ñ';
        } else {
          const file = field.files[0];
          const maxSize = 3 * 1024 * 1024; // 3MB (reduced for better reliability)
          
          if (file.size > maxSize) {
            isValid = false;
            errorMessage = currentLang === 'ru' ? 
              `–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 3–ú–ë, —É –≤–∞—Å ${(file.size / (1024 * 1024)).toFixed(1)}–ú–ë)` : 
              `–§–∞–π–ª —Ç—ã–º “Ø–ª–∫–µ–Ω (–º–∞–∫—Å. 3–ú–ë, —Å—ñ–∑–¥–µ ${(file.size / (1024 * 1024)).toFixed(1)}–ú–ë)`;
          }
          
          if (fieldId === 'profilePhoto') {
            if (!file.type.startsWith('image/')) {
              isValid = false;
              errorMessage = currentLang === 'ru' ? '–¢–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è' : '–¢–µ–∫ —Å—É—Ä–µ—Ç—Ç–µ—Ä';
            }
          } else {
            if (!file.type.startsWith('image/') && file.type !== 'application/pdf') {
              isValid = false;
              errorMessage = currentLang === 'ru' ? '–¢–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ PDF' : '–¢–µ–∫ —Å—É—Ä–µ—Ç—Ç–µ—Ä –Ω–µ–º–µ—Å–µ PDF';
            }
          }
        }
      }
      
      // Specific validations
      switch (fieldId) {
        case 'firstName':
        case 'lastName':
          if (value && (value.length < 2 || value.length > 50)) {
            isValid = false;
            errorMessage = currentLang === 'ru' ? '–û—Ç 2 –¥–æ 50 —Å–∏–º–≤–æ–ª–æ–≤' : '2-–¥–µ–Ω 50-–≥–µ –¥–µ–π—ñ–Ω —Å–∏–º–≤–æ–ª';
          }
          break;
          
        case 'birthday':
          if (value) {
            const birthDate = new Date(value);
            const today = new Date();
            const age = today.getFullYear() - birthDate.getFullYear();
            if (age < 18 || age > 80) {
              isValid = false;
              errorMessage = currentLang === 'ru' ? '–í–æ–∑—Ä–∞—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 18 –¥–æ 80 –ª–µ—Ç' : '–ñ–∞—Å—ã 18-–¥–µ–Ω 80-–≥–µ –¥–µ–π—ñ–Ω –±–æ–ª—É—ã –∫–µ—Ä–µ–∫';
            }
          }
          break;
          
        case 'contactNumber':
          const phoneRegex = /^\+7 \(\d{3}\) \d{3}-\d{2}-\d{2}$/;
          if (value && !phoneRegex.test(value)) {
            isValid = false;
            errorMessage = currentLang === 'ru' ? '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞' : '–ù”©–º—ñ—Ä —Ñ–æ—Ä–º–∞—Ç—ã –¥“±—Ä—ã—Å –µ–º–µ—Å';
          }
          break;
      }
      
      // Apply validation state
      if (isValid && (value || field.files.length > 0)) {
        field.classList.add('success');
        formGroup.classList.add('valid');
      } else if (!isValid) {
        field.classList.add('error');
        formGroup.classList.add('invalid');
        if (errorElement) {
          errorElement.textContent = errorMessage;
        }
      }
      
      return isValid;
    }

    // Show error message
    function showErrorMessage(fieldId, message) {
      const errorElement = document.getElementById(fieldId + 'Error');
      if (errorElement) {
        errorElement.textContent = message;
      }
    }

    // Show success message
    function showSuccessMessage(fieldId, message) {
      const successElement = document.getElementById(fieldId + 'Success');
      if (successElement) {
        successElement.textContent = message;
        setTimeout(() => {
          successElement.textContent = '';
        }, 3000);
      }
    }

    // Update progress bar
    function updateProgress() {
      const form = document.getElementById('driverForm');
      const requiredFields = form.querySelectorAll('input[required]');
      let filledFields = 0;
      
      requiredFields.forEach(field => {
        if (field.type === 'file') {
          if (field.files.length > 0) filledFields++;
        } else if (field.value.trim()) {
          filledFields++;
        }
      });
      
      const progress = (filledFields / requiredFields.length) * 100;
      document.getElementById('progressFill').style.width = progress + '%';
      
      // Show register button when form is complete
      const registerBtn = document.getElementById('registerBtn');
      if (progress === 100) {
        registerBtn.classList.add('show');
        
        // Show Telegram main button if available
        if (window.Telegram && Telegram.WebApp) {
          Telegram.WebApp.MainButton.setText(currentLang === 'ru' ? '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è' : '–¢—ñ—Ä–∫–µ–ª—É');
          Telegram.WebApp.MainButton.show();
          Telegram.WebApp.MainButton.onClick(submitForm);
        }
      } else {
        registerBtn.classList.remove('show');
        
        if (window.Telegram && Telegram.WebApp) {
          Telegram.WebApp.MainButton.hide();
        }
      }
    }

    // Submit form with better error handling
    async function submitForm() {
      const form = document.getElementById('driverForm');
      const registerBtn = document.getElementById('registerBtn');

      const telegramId = document.getElementById('telegramId').value;
      if (!telegramId) {
        console.error('‚ùå Missing Telegram ID');
        // Try to recover Telegram ID
        if (window.Telegram?.WebApp?.initDataUnsafe?.user) {
          document.getElementById('telegramId').value = Telegram.WebApp.initDataUnsafe.user.id;
        } else {
          const errorMsg = currentLang === 'ru' ? 
            '–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram' : 
            '“ö–∞—Ç–µ: Telegram –ø–∞–π–¥–∞–ª–∞–Ω—É—à—ã ID –∞–ª—ã–Ω–±–∞–¥—ã';
          
          if (window.Telegram && Telegram.WebApp) {
            Telegram.WebApp.showAlert(errorMsg);
          } else {
            alert(errorMsg);
          }
          return;
        }
      }
      
      // Validate all fields
      let isFormValid = true;
      const requiredFields = form.querySelectorAll('input[required]');
      
      requiredFields.forEach(field => {
        if (!validateField.call(field)) {
          isFormValid = false;
        }
      });
      
      if (!isFormValid) {
        const errorMsg = currentLang === 'ru' ? 
          '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ' : 
          '–ë–∞—Ä–ª—ã“õ ”©—Ä—ñ—Å—Ç–µ—Ä–¥—ñ –¥“±—Ä—ã—Å —Ç–æ–ª—Ç—ã—Ä—ã“£—ã–∑';
        
        if (window.Telegram && Telegram.WebApp) {
          Telegram.WebApp.showAlert(errorMsg);
        } else {
          alert(errorMsg);
        }
        return;
      }

      // Check file sizes before upload
      const fileInputs = ['profilePhoto', 'licenseFront', 'licenseBack'];
      let totalSize = 0;
      let oversizedFiles = [];
      
      for (const inputId of fileInputs) {
        const input = document.getElementById(inputId);
        if (input.files.length > 0) {
          const fileSize = input.files[0].size;
          totalSize += fileSize;
          
          // Check individual file size (3MB max)
          if (fileSize > 3 * 1024 * 1024) {
            oversizedFiles.push(`${inputId}: ${(fileSize / (1024 * 1024)).toFixed(1)}–ú–ë`);
          }
        }
      }
      
      if (oversizedFiles.length > 0) {
        const errorMsg = currentLang === 'ru' ? 
          `–°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã (–º–∞–∫—Å. 3–ú–ë –∫–∞–∂–¥—ã–π):\n${oversizedFiles.join('\n')}` :
          `–§–∞–π–ª–¥–∞—Ä —Ç—ã–º “Ø–ª–∫–µ–Ω (–º–∞–∫—Å. 3–ú–ë ”ô—Ä“õ–∞–π—Å—ã—Å—ã):\n${oversizedFiles.join('\n')}`;
        
        if (window.Telegram && Telegram.WebApp) {
          Telegram.WebApp.showAlert(errorMsg);
        } else {
          alert(errorMsg);
        }
        return;
      }
      
      if (totalSize > 9 * 1024 * 1024) { // 9MB total
        const errorMsg = currentLang === 'ru' ? 
          `–û–±—â–∏–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (${(totalSize / (1024 * 1024)).toFixed(1)}–ú–ë). –ú–∞–∫—Å–∏–º—É–º 9–ú–ë.` :
          `–§–∞–π–ª–¥–∞—Ä–¥—ã“£ –∂–∞–ª–ø—ã –∫”©–ª–µ–º—ñ —Ç—ã–º “Ø–ª–∫–µ–Ω (${(totalSize / (1024 * 1024)).toFixed(1)}–ú–ë). –ú–∞–∫—Å–∏–º—É–º 9–ú–ë.`;
        
        if (window.Telegram && Telegram.WebApp) {
          Telegram.WebApp.showAlert(errorMsg);
        } else {
          alert(errorMsg);
        }
        return;
      }
      
      // Show loading state
      registerBtn.classList.add('loading');
      registerBtn.disabled = true;
      
      if (window.Telegram && Telegram.WebApp) {
        Telegram.WebApp.MainButton.showProgress();
      }
      
      try {
        const formData = new FormData(form);
        
        // Debug: Log form data
        console.log('Submitting form data:');
        for (const [key, value] of formData.entries()) {
          if (value instanceof File) {
            console.log(key, `File(${value.name}, ${(value.size / 1024).toFixed(1)}KB, ${value.type})`);
          } else {
            console.log(key, value);
          }
        }
        
        console.log(`Total upload size: ${(totalSize / (1024 * 1024)).toFixed(1)}MB`);
        
        // Create abort controller for timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 90000); // 90 seconds timeout
        
        const response = await fetch('/api/driver/register', {
          method: 'POST',
          body: formData,
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        const result = await response.json();
        
        if (response.ok && result.success) {
          // Success
          const successMsg = currentLang === 'ru' ? 
            '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.' : 
            '–¢—ñ—Ä–∫–µ–ª—É —Å”ô—Ç—Ç—ñ! –†–∞—Å—Ç–∞—É–¥—ã –∫“Ø—Ç—ñ“£—ñ–∑.';
          
          if (window.Telegram && Telegram.WebApp) {
            Telegram.WebApp.showAlert(successMsg, () => Telegram.WebApp.close());
          } else {
            alert(successMsg);
          }
        } else {
          // Error from server
          throw new Error(result.message || 'Registration failed');
        }
      } catch (error) {
        console.error('Registration error:', error);
        
        let errorMsg;
        if (error.name === 'AbortError') {
          errorMsg = currentLang === 'ru' ? 
            '–í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–µ–∫–ª–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–º–µ–Ω—å—à–∏—Ç—å —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤.' :
            '–ñ“Ø–∫—Ç–µ—É —É–∞“õ—ã—Ç—ã –∞—è“õ—Ç–∞–ª–¥—ã. –§–∞–π–ª –∫”©–ª–µ–º—ñ–Ω –∞–∑–∞–π—Ç—ã–ø –∫”©—Ä—ñ“£—ñ–∑.';
        } else if (error.message.includes('NetworkError') || error.message.includes('fetch')) {
          errorMsg = currentLang === 'ru' ? 
            '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.' :
            '–ñ–µ–ª—ñ “õ–∞—Ç–µ—Å—ñ. –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –±–∞–π–ª–∞–Ω—ã—Å—ã–Ω —Ç–µ–∫—Å–µ—Ä—ñ“£—ñ–∑.';
        } else {
          errorMsg = currentLang === 'ru' ? 
            `–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${error.message}` :
            `–¢—ñ—Ä–∫–µ–ª—É “õ–∞—Ç–µ—Å—ñ: ${error.message}`;
        }
        
        if (window.Telegram && Telegram.WebApp) {
          Telegram.WebApp.showAlert(errorMsg);
        } else {
          alert(errorMsg);
        }
      } finally {
        // Hide loading state
        registerBtn.classList.remove('loading');
        registerBtn.disabled = false;
        
        if (window.Telegram && Telegram.WebApp) {
          Telegram.WebApp.MainButton.hideProgress();
        }
      }
    }

    // Image compression utility function
    function compressImage(file, quality = 0.8, maxWidth = 800, maxHeight = 600) {
      return new Promise((resolve, reject) => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        img.onload = function() {
          // Calculate new dimensions while maintaining aspect ratio
          let { width, height } = img;
          
          if (width > maxWidth || height > maxHeight) {
            const ratio = Math.min(maxWidth / width, maxHeight / height);
            width *= ratio;
            height *= ratio;
          }
          
          canvas.width = width;
          canvas.height = height;
          
          // Draw and compress
          ctx.drawImage(img, 0, 0, width, height);
          
          canvas.toBlob(
            (blob) => {
              if (blob) {
                // Create new file with compressed data
                const compressedFile = new File([blob], file.name, {
                  type: file.type,
                  lastModified: Date.now()
                });
                resolve(compressedFile);
              } else {
                reject(new Error('Compression failed'));
              }
            },
            file.type,
            quality
          );
        };
        
        img.onerror = () => reject(new Error('Failed to load image'));
        img.src = URL.createObjectURL(file);
      });
    }

    // Global functions
    window.setLang = setLang;
  </script>
</body>
</html>