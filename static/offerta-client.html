<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Alash-Go ‚Ä¢ –ö–ª–∏–µ–Ω—Ç –æ—Ñ–µ—Ä—Ç–∞—Å—ã</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- ‚úÖ mammoth.js –¥–ª—è —á—Ç–µ–Ω–∏—è DOCX -->
  <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>

  <style>
    :root{
      --bg1:#050814;
      --bg2:#0b1020;

      --card:rgba(255,255,255,0.08);
      --border:rgba(255,255,255,0.10);

      --text:#ffffff;
      --text2:rgba(255,255,255,0.72);
      --text3:rgba(255,255,255,0.52);

      --ok:#7c5cff;
      --ok2:#5a7bff;
      --success:#22c55e;
      --danger:#ef4444;

      --r-xl:22px;
      --shadow:0 18px 45px rgba(0,0,0,.55);

      --sat: var(--tg-safe-area-inset-top, 0px);
      --sab: var(--tg-safe-area-inset-bottom, 0px);
      --csat: var(--tg-content-safe-area-inset-top, 0px);
      --csab: var(--tg-content-safe-area-inset-bottom, 0px);

      --topPad: calc(var(--sat) + var(--csat) + 14px);
      --botPad: calc(var(--sab) + var(--csab) + 14px);

      --vh: var(--tg-viewport-stable-height, 100vh);
    }

    *{ box-sizing:border-box; }
    html, body{
      margin:0; padding:0; height:100%;
      background:#000; color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      -webkit-text-size-adjust:100%;
      overscroll-behavior:none;
    }

    body{
      background:
        radial-gradient(1100px 650px at 50% -10%, rgba(124,92,255,.35), transparent 60%),
        radial-gradient(800px 500px at 20% 10%, rgba(90,123,255,.18), transparent 55%),
        linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 55%, #070b18 100%);
    }

    .page{
      height: var(--vh);
      display:flex;
      flex-direction:column;
      padding: var(--topPad) 16px var(--botPad);
      gap:14px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .topbtn{
      appearance:none;
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(255,255,255,0.06);
      color:var(--text);
      border-radius:999px;
      padding:10px 12px;
      font-size:14px;
      line-height:1;
      display:inline-flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      backdrop-filter: blur(10px);
    }
    .topbtn:active{ transform:scale(.98); }

    .titleWrap{
      text-align:center;
      margin-top:6px;
      margin-bottom:4px;
    }
    h1{
      margin:0;
      font-size:34px;
      font-weight:800;
      letter-spacing:.2px;
    }
    .subtitle{
      margin:8px auto 0;
      max-width:520px;
      color:var(--text2);
      font-size:15px;
      line-height:1.35;
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
      border:1px solid var(--border);
      border-radius:var(--r-xl);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      display:flex;
      gap:12px;
      padding:16px 16px 14px;
      align-items:flex-start;
      border-bottom:1px solid rgba(255,255,255,0.07);
    }
    .badge{
      width:44px; height:44px;
      border-radius:14px;
      background:rgba(124,92,255,0.18);
      border:1px solid rgba(124,92,255,0.35);
      display:flex;
      align-items:center;
      justify-content:center;
      flex:0 0 auto;
    }
    .badge span{ font-size:20px; }
    .cardHeadTitle{
      font-size:18px;
      font-weight:800;
      margin:0;
    }
    .cardHeadDesc{
      margin:6px 0 0;
      color:var(--text2);
      font-size:14px;
      line-height:1.35;
    }

    .docBox{
      margin:14px 16px 16px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(0,0,0,0.22);
      overflow:hidden;
    }

    .docToolbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,0.08);
      background:rgba(255,255,255,0.03);
    }
    .docStatus{
      font-size:13px;
      color:var(--text2);
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
    }
    .dot{
      width:8px; height:8px; border-radius:99px;
      background: rgba(255,255,255,0.35);
      flex:0 0 auto;
    }
    .miniBtn{
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(255,255,255,0.06);
      color:var(--text);
      border-radius:12px;
      padding:8px 10px;
      font-weight:800;
      font-size:13px;
      cursor:pointer;
      backdrop-filter: blur(10px);
      flex:0 0 auto;
    }
    .miniBtn:active{ transform:scale(.99); }

    .docContent{
      max-height:56vh;
      min-height:360px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding:14px 14px 18px;
    }

    .docText{
      color: rgba(255,255,255,0.88);
      font-size:14px;
      line-height:1.75;
    }

    .docText h1, .docText h2, .docText h3 {
      color: var(--ok);
      margin-top: 20px;
      margin-bottom: 12px;
    }

    .docText p {
      margin: 12px 0;
      text-align: justify;
    }

    .docText ul, .docText ol {
      margin: 12px 0;
      padding-left: 24px;
    }

    .docText li {
      margin: 8px 0;
    }

    .docErr{
      padding:14px;
      border:1px solid rgba(239,68,68,0.25);
      background:rgba(239,68,68,0.10);
      border-radius:14px;
      color:rgba(255,255,255,0.92);
      font-size:14px;
      line-height:1.45;
    }

    .footer{
      margin-top:auto;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .agreeRow{
      display:flex;
      align-items:flex-start;
      gap:12px;
      padding:14px 14px;
      border-radius:18px;
      border:1px solid rgba(34,197,94,0.20);
      background:rgba(34,197,94,0.10);
      backdrop-filter: blur(10px);
      cursor:pointer;
      user-select:none;
    }
    .check{
      width:22px; height:22px;
      margin-top:2px;
      border-radius:6px;
      border:1px solid rgba(255,255,255,0.25);
      background:rgba(0,0,0,0.25);
      display:flex;
      align-items:center;
      justify-content:center;
      flex:0 0 auto;
      position:relative;
    }
    .check input{
      width:22px; height:22px;
      opacity:0;
      position:absolute; inset:0;
      margin:0;
      cursor:pointer;
    }
    .checkMark{
      width:22px;height:22px;
      border-radius:6px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      color:#0b1220;
      background:transparent;
    }

    .agreeText{
      font-size:14px;
      line-height:1.35;
      color:var(--text);
    }
    .agreeText b{ font-weight:800; }

    .primaryBtn{
      width:100%;
      border:0;
      border-radius:18px;
      padding:16px 16px;
      font-size:16px;
      font-weight:900;
      color:white;
      background: linear-gradient(90deg, var(--ok) 0%, var(--ok2) 100%);
      box-shadow: 0 14px 30px rgba(124,92,255,0.35);
      cursor:pointer;
    }
    .primaryBtn:active{ transform:scale(.99); }
    .primaryBtn[disabled]{
      opacity:.45;
      cursor:not-allowed;
      box-shadow:none;
    }

    .bottomRow{
      display:flex;
      gap:10px;
    }
    .ghostBtn{
      flex:1;
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(255,255,255,0.06);
      color:var(--text);
      border-radius:16px;
      padding:14px 14px;
      font-weight:800;
      cursor:pointer;
      backdrop-filter: blur(10px);
    }
    .ghostBtn:active{ transform:scale(.99); }

    @media (max-width:380px){
      h1{ font-size:30px; }
      .docContent{ max-height:54vh; }
    }
  </style>
</head>

<body>
  <div class="page" id="page">
    <div class="topbar">
      <button class="topbtn" id="btnClose" type="button">‚úï –ñ–∞–±—É</button>
      <div style="width:42px"></div>
    </div>

    <div class="titleWrap">
      <h1>–û—Ñ–µ—Ä—Ç–∞ –∫–µ–ª—ñ—Å—ñ–º—ñ</h1>
      <div class="subtitle">
        –ñ–∞–ª“ì–∞—Å—Ç—ã—Ä—É “Ø—à—ñ–Ω —Ç”©–º–µ–Ω–¥–µ–≥—ñ “õ“±–∂–∞—Ç–ø–µ–Ω —Ç–∞–Ω—ã—Å—ã–ø, –∫–µ–ª—ñ—Å—ñ–º –±–µ—Ä—ñ“£—ñ–∑.
      </div>
    </div>

    <div class="card">
      <div class="cardHead">
        <div class="badge"><span>üõ°Ô∏è</span></div>
        <div>
          <div class="cardHeadTitle">“ö“±–ø–∏—è–ª—ã–ª—ã“õ —Å–∞—è—Å–∞—Ç—ã (–ö–ª–∏–µ–Ω—Ç)</div>
          <div class="cardHeadDesc">
            “ö“±–∂–∞—Ç DOCX —Ñ–∞–π–ª—ã–Ω–∞–Ω –∂“Ø–∫—Ç–µ–ª—É–¥–µ...
          </div>
        </div>
      </div>

      <div class="docBox">
        <div class="docToolbar">
          <div class="docStatus">
            <span class="dot" id="dot"></span>
            <span id="statusText">–ñ“Ø–∫—Ç–µ–ª—É–¥–µ‚Ä¶</span>
          </div>
          <button class="miniBtn" id="btnReload" type="button">“ö–∞–π—Ç–∞ –∂“Ø–∫—Ç–µ—É</button>
        </div>

        <div class="docContent" id="docContent">
          <div class="docText" id="docText"></div>
        </div>
      </div>
    </div>

    <div class="footer">
      <label class="agreeRow" for="agree">
        <div class="check">
          <div class="checkMark" id="checkMark"></div>
          <input id="agree" type="checkbox" />
        </div>
        <div class="agreeText">
          <b>–û“õ—ã–¥—ã–º –∂”ô–Ω–µ –∫–µ–ª—ñ—Å–µ–º—ñ–Ω.</b> –û—Å—ã –∫–µ–ª—ñ—Å—ñ–º—Å—ñ–∑ –∫–ª–∏–µ–Ω—Ç —Ä–µ—Ç—ñ–Ω–¥–µ “õ–æ–ª–¥–∞–Ω—É –º“Ø–º–∫—ñ–Ω –µ–º–µ—Å.
        </div>
      </label>

      <button class="primaryBtn" id="btnOk" type="button" disabled>
        OK ‚Ä¢ –ö–µ–ª—ñ—Å–µ–º—ñ–Ω
      </button>

      <div class="bottomRow">
        <button class="ghostBtn" id="btnBack" type="button">‚Üê –ê—Ä—Ç“õ–∞</button>
        <button class="ghostBtn" id="btnMain" type="button">üè† Main</button>
      </div>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;

    try {
      if (tg) {
        tg.ready();
        tg.expand();
        tg.setHeaderColor?.("#050814");
        tg.setBackgroundColor?.("#050814");
        tg.disableVerticalSwipes?.();
      }
    } catch (e) {
      console.error('Telegram WebApp init error:', e);
    }

    // ‚úÖ –ü—É—Ç—å –∫ DOCX –¥–æ–∫—É–º–µ–Ω—Ç—É
    const DOC_URL = "/offerta-files/client-privicy.docx";

    const dot = document.getElementById("dot");
    const statusText = document.getElementById("statusText");
    const docTextEl = document.getElementById("docText");
    const docContent = document.getElementById("docContent");

    function setStatus(kind, text){
      statusText.textContent = text;
      if (kind === "loading") dot.style.background = "rgba(255,255,255,0.35)";
      if (kind === "ok") dot.style.background = "rgba(34,197,94,0.95)";
      if (kind === "err") dot.style.background = "rgba(239,68,68,0.95)";
    }

    function escapeHtml(s){
      return (s || "").replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    // ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ DOCX —Ñ–∞–π–ª–∞
    async function loadDoc(){
      setStatus("loading", "DOCX —Ñ–∞–π–ª—ã –∂“Ø–∫—Ç–µ–ª—É–¥–µ‚Ä¶");
      docTextEl.innerHTML = "";
      docContent.scrollTop = 0;

      try {
        console.log("üìÑ Fetching DOCX from:", DOC_URL);
        
        const res = await fetch(DOC_URL, { 
          cache: "no-store",
          headers: {
            'Accept': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
          }
        });
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }

        console.log("‚úÖ DOCX fetched, converting with mammoth.js...");
        
        const arrayBuffer = await res.arrayBuffer();
        
        // ‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è DOCX –≤ HTML —Å –ø–æ–º–æ—â—å—é mammoth.js
        const result = await mammoth.convertToHtml(
          { arrayBuffer: arrayBuffer },
          {
            styleMap: [
              "p[style-name='Heading 1'] => h2:fresh",
              "p[style-name='Heading 2'] => h3:fresh"
            ]
          }
        );

        if (!result.value || result.value.length < 40) {
          throw new Error("“ö“±–∂–∞—Ç –±–æ—Å –Ω–µ–º–µ—Å–µ “õ–∞—Ç–µ —Ñ–æ—Ä–º–∞—Ç—Ç–∞–ª“ì–∞–Ω");
        }

        console.log("‚úÖ DOCX converted successfully");
        
        // ‚úÖ –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ HTML –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        docTextEl.innerHTML = result.value;

        // Log warnings if any
        if (result.messages && result.messages.length > 0) {
          console.warn("‚ö†Ô∏è Mammoth warnings:", result.messages);
        }

        setStatus("ok", "“ö“±–∂–∞—Ç –∂“Ø–∫—Ç–µ–ª–¥—ñ ‚úì");
        
      } catch (e) {
        console.error("‚ùå Error loading DOCX:", e);
        setStatus("err", "“ö“±–∂–∞—Ç –∂“Ø–∫—Ç–µ–ª–º–µ–¥—ñ");
        docTextEl.innerHTML = `
          <div class="docErr">
            <b>“ö–∞—Ç–µ:</b> DOCX “õ“±–∂–∞—Ç—ã –æ“õ—ã–ª–º–∞–¥—ã.<br/>
            <span style="opacity:.85">–§–∞–π–ª:</span> ${escapeHtml(DOC_URL)}<br/>
            <span style="opacity:.85">–°–µ–±–µ–ø:</span> ${escapeHtml(String(e.message || e))}<br/><br/>
            <small>Mammoth.js –∂“Ø–∫—Ç–µ–ª–≥–µ–Ω—ñ–Ω–µ –∫”©–∑ –∂–µ—Ç–∫—ñ–∑—ñ“£—ñ–∑ –∂”ô–Ω–µ DOCX —Ñ–∞–π–ª—ã —Å–µ—Ä–≤–µ—Ä–¥–µ–≥—ñ –¥“±—Ä—ã—Å –∂–µ—Ä–¥–µ –µ–∫–µ–Ω—ñ–Ω–µ –∫”©–∑ –∂–µ—Ç–∫—ñ–∑—ñ“£—ñ–∑.</small>
          </div>
        `;
      }
    }

    document.getElementById("btnReload").addEventListener("click", loadDoc);

    // --- Agree logic ---
    const agree = document.getElementById("agree");
    const btnOk = document.getElementById("btnOk");
    const checkMark = document.getElementById("checkMark");

    function syncAgreeUI(){
      const on = !!agree.checked;
      btnOk.disabled = !on;
      checkMark.textContent = on ? "‚úì" : "";
      checkMark.style.background = on ? "rgba(34,197,94,0.95)" : "transparent";
    }
    agree.addEventListener("change", syncAgreeUI);
    syncAgreeUI();

    // --- Buttons ---
    document.getElementById("btnClose").addEventListener("click", () => {
      if (tg) tg.close();
      else window.history.back();
    });

    document.getElementById("btnBack").addEventListener("click", () => {
      window.location.href = "/welcome";
    });

    document.getElementById("btnMain").addEventListener("click", () => {
      window.location.href = "/main-client";
    });

    // ‚úÖ approve endpoint
    btnOk.addEventListener("click", async () => {
  if (btnOk.disabled) return;

  const payload = {
    role: "client",
    telegram_id: tg?.initDataUnsafe?.user?.id || 0
  };

  // ‚úÖ Validate telegram_id before sending
  if (!payload.telegram_id || payload.telegram_id === 0) {
    console.error("‚ùå No telegram_id available");
    if (tg?.showPopup) {
      tg.showPopup({
        title: "‚ö†Ô∏è “ö–∞—Ç–µ",
        message: "Telegram –¥–µ—Ä–µ–∫—Ç–µ—Ä—ñ –∂–æ“õ. –ë–æ—Ç—Ç—ã “õ–∞–π—Ç–∞ –∞—à—ã“£—ã–∑.",
        buttons: [{type:"ok"}]
      });
    }
    return;
  }

  try {
    btnOk.disabled = true;
    btnOk.textContent = "–°–∞“õ—Ç–∞–ª—É–¥–∞...";
    
    console.log("üì§ Sending approval:", payload);

    const res = await fetch("/api/offerta/approve", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });

    const responseText = await res.text();
    console.log("üì• Response:", responseText);

    if (!res.ok) {
      throw new Error(responseText || "–°–∞“õ—Ç–∞—É “õ–∞—Ç–µ—Å—ñ");
    }

    // ‚úÖ Parse JSON response
    let result;
    try {
      result = JSON.parse(responseText);
    } catch (e) {
      throw new Error("Invalid JSON response");
    }

    if (!result.success) {
      throw new Error(result.message || "–°–∞“õ—Ç–∞—É “õ–∞—Ç–µ—Å—ñ");
    }

    console.log("‚úÖ Offerta approved successfully");

    if (tg?.showPopup) {
      tg.showPopup({
        title: "‚úÖ –°–∞“õ—Ç–∞–ª–¥—ã",
        message: "–ö–µ–ª—ñ—Å—ñ–º “õ–∞–±—ã–ª–¥–∞–Ω–¥—ã. –ï–Ω–¥—ñ “õ–æ—Å—ã–º—à–∞–Ω—ã “õ–æ–ª–¥–∞–Ω–∞ –∞–ª–∞—Å—ã–∑.",
        buttons: [{type:"ok"}]
      });
    }

    // ‚úÖ CRITICAL: Wait longer to ensure DB write completes
    setTimeout(() => {
      console.log("üîÑ Redirecting to main-client...");
      window.location.replace("/main-client"); // Use replace() instead of href
    }, 800); // Increased delay

  } catch (e) {
    console.error('‚ùå Approve error:', e);
    
    if (tg?.showPopup) {
      tg.showPopup({
        title: "‚ö†Ô∏è “ö–∞—Ç–µ",
        message: "–ö–µ–ª—ñ—Å—ñ–º–¥—ñ —Å–∞“õ—Ç–∞—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã: " + e.message,
        buttons: [{type:"ok"}]
      });
    } else {
      alert("“ö–∞—Ç–µ: " + e.message);
    }
    
    btnOk.disabled = !agree.checked;
    btnOk.textContent = "OK ‚Ä¢ –ö–µ–ª—ñ—Å–µ–º—ñ–Ω";
  }
});

    // ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadDoc();
  </script>
</body>
</html>