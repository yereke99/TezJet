<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Alash Go ‚Äì –¢–∞—Ä–∏—Ö</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Leaflet (OpenStreetMap) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg-primary:#000000;
      --bg-secondary:#ffffff;
      --bg-card:#f8f9fa;
      --bg-card-dark:#020617;
      --text-primary:#000000;
      --text-secondary:#4b5563;
      --text-muted:#9ca3af;
      --text-white:#ffffff;
      --accent-primary:#000000;
      --accent-secondary:#0b63f6;
      --border:#e5e7eb;
      --border-light:#edf1f5;
      --shadow-subtle:0 2px 8px rgba(0,0,0,.06);
      --shadow-medium:0 4px 16px rgba(0,0,0,.12);
      --radius-md:12px;
      --radius-lg:18px;
      --radius-xl:24px;

      --tg-viewport-stable-height:100vh;
      --tg-safe-area-inset-top:env(safe-area-inset-top,0px);
      --tg-safe-area-inset-bottom:env(safe-area-inset-bottom,0px);
      --tg-safe-area-inset-left:env(safe-area-inset-left,0px);
      --tg-safe-area-inset-right:env(safe-area-inset-right,0px);

      --tg-content-safe-area-inset-top:15px;
      --bottom-nav-height:72px;
    }

    *{
      margin:0;
      padding:0;
      box-sizing:border-box;
      -webkit-tap-highlight-color:transparent;
    }

    html,body{
      height:100vh;
      height:100dvh;
    }

    body{
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","Inter",system-ui,sans-serif;
      background:var(--bg-secondary);
      color:var(--text-primary);

      position:fixed;
      inset:0;
      width:100%;
      height:var(--tg-viewport-stable-height,100vh);

      padding-top:calc(
        var(--tg-safe-area-inset-top,0px) +
        var(--tg-content-safe-area-inset-top,15px)
      );

      padding-bottom:calc(
        var(--bottom-nav-height)+
        max(10px,var(--tg-safe-area-inset-bottom,0px))
      );
      padding-left:max(16px,var(--tg-safe-area-inset-left,0px));
      padding-right:max(16px,var(--tg-safe-area-inset-right,0px));

      overflow:hidden;
      overscroll-behavior:contain;
      -webkit-overflow-scrolling:touch;
    }

    .background{
      position:fixed;
      inset:0;
      background:radial-gradient(circle at top,rgba(0,0,0,.04),transparent 55%),var(--bg-secondary);
      z-index:-2;
    }

    .background::before{
      content:"";
      position:absolute;
      inset:0;
      background:linear-gradient(135deg,rgba(15,23,42,.06) 0%,transparent 50%);
      z-index:-1;
    }

    .loading-overlay{
      position:fixed;
      inset:0;
      width:100%;
      height:100%;
      background:var(--bg-secondary);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:20px;
      z-index:9999;
      transition:opacity .25s ease,visibility .25s ease;
    }
    .loading-overlay.hidden{
      opacity:0;
      visibility:hidden;
      pointer-events:none;
    }
    .loading-spinner{
      width:32px;
      height:32px;
      border-radius:50%;
      border:2px solid var(--border-light);
      border-top:2px solid var(--accent-primary);
      animation:spin 1s linear infinite;
    }
    .loading-text{
      font-size:14px;
      font-weight:500;
      color:var(--text-secondary);
      text-align:center;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    .app-root{
      position:relative;
      height:100%;
      max-width:420px;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      opacity:0;
      transform:translateY(4px);
      transition:opacity .25s ease,transform .25s ease;
    }
    .app-root.visible{
      opacity:1;
      transform:translateY(0);
    }

    .top-bar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:2px 2px 8px 2px;
      flex-shrink:0;
    }
    .top-left{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .back-btn{
      width:32px;
      height:32px;
      border-radius:999px;
      border:none;
      display:flex;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.04);
      cursor:pointer;
      font-size:18px;
    }
    .page-title-wrap{
      display:flex;
      flex-direction:column;
    }
    .page-title{
      font-size:18px;
      font-weight:700;
    }
    .page-subtitle{
      font-size:12px;
      color:var(--text-muted);
    }

    .user-pill{
      padding:6px 10px;
      border-radius:999px;
      background:rgba(0,0,0,.04);
      display:flex;
      align-items:center;
      gap:6px;
      font-size:12px;
      color:var(--text-secondary);
      max-width:170px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .user-avatar{
      width:24px;
      height:24px;
      border-radius:999px;
      background:#111;
      color:#fff;
      font-size:11px;
      font-weight:600;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      position:relative;
      flex-shrink:0;
    }
    .user-avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:none;
    }
    .user-avatar span{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .lang-switch{
      position:absolute;
      top:10px;
      right:10px;
      display:flex;
      background:rgba(15,23,42,.92);
      border-radius:24px;
      padding:3px;
      border:1px solid rgba(148,163,184,.6);
      box-shadow:0 8px 18px rgba(0,0,0,.35);
      z-index:5;
    }
    .lang-btn{
      background:transparent;
      border:none;
      border-radius:18px;
      padding:4px 12px;
      cursor:pointer;
      font-weight:600;
      font-size:11px;
      min-width:40px;
      color:rgba(226,232,240,.8);
      transition:all .18s ease;
    }
    .lang-btn.active{
      background:#f9fafb;
      color:#020617;
      transform:scale(1.02);
    }
    .lang-btn:hover:not(.active){
      background:rgba(148,163,184,.25);
      color:#e5e7eb;
    }

    .content-scroll{
      flex:1;
      min-height:0;
      overflow-y:auto;
      padding:4px 2px 0 2px;
      -webkit-overflow-scrolling:touch;
    }
    .content-scroll::-webkit-scrollbar{width:0;height:0;}

    .summary-card{
      position:relative;
      border-radius:var(--radius-xl);
      background:radial-gradient(circle at top left,#111827 0%,#020617 45%,#000 100%);
      color:var(--text-white);
      padding:18px 14px 14px 14px;
      box-shadow:0 8px 26px rgba(15,23,42,.7);
      margin-bottom:14px;
      overflow:hidden;
    }
    .summary-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .summary-title{
      font-size:16px;
      font-weight:600;
    }
    .summary-caption{
      font-size:12px;
      color:rgba(209,213,219,.9);
    }
    .summary-metrics{
      display:flex;
      gap:10px;
      margin-top:6px;
    }
    .metric-pill{
      flex:1;
      border-radius:14px;
      background:rgba(15,23,42,.75);
      padding:8px 10px;
      display:flex;
      flex-direction:column;
      gap:2px;
      border:1px solid rgba(148,163,184,.4);
    }
    .metric-label{
      font-size:11px;
      color:rgba(148,163,184,1);
    }
    .metric-value{
      font-size:15px;
      font-weight:600;
    }

    .filters-row{
      display:flex;
      gap:8px;
      margin:0 2px 10px 2px;
    }
    .filter-pill{
      border-radius:999px;
      padding:6px 10px;
      border:1px solid var(--border-light);
      background:#fff;
      font-size:12px;
      color:var(--text-secondary);
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
      box-shadow:0 1px 2px rgba(0,0,0,.04);
    }
    .filter-pill.active{
      background:#000;
      color:#fff;
      border-color:#000;
      box-shadow:0 6px 16px rgba(15,23,42,.36);
    }

    .card-list{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-bottom:12px;
    }

    .order-card{
      border-radius:var(--radius-lg);
      background:var(--bg-card);
      box-shadow:var(--shadow-subtle);
      border:1px solid var(--border-light);
      padding:10px 11px;
      display:flex;
      flex-direction:column;
      gap:6px;
      cursor:pointer;
    }

    .order-route{
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:flex-start;
    }
    .route-main{
      flex:1;
      min-width:0;
    }
    .route-line{
      font-size:13px;
      font-weight:600;
      color:#111827;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .route-city{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .route-arrow{
      font-size:14px;
    }
    .route-sub{
      font-size:11px;
      color:var(--text-muted);
      margin-top:1px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .price-pill{
      padding:4px 8px;
      border-radius:999px;
      background:#000;
      color:#fff;
      font-size:11px;
      font-weight:600;
      white-space:nowrap;
      align-self:flex-start;
    }

    .order-meta-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      row-gap:4px;
      margin-top:2px;
    }
    .status-pill{
      padding:3px 9px;
      border-radius:999px;
      font-size:11px;
      font-weight:500;
      display:inline-flex;
      align-items:center;
      gap:5px;
    }
    .status-dot{
      width:6px;
      height:6px;
      border-radius:50%;
    }
    .status-pending{
      background:rgba(251,191,36,.15);
      color:#92400e;
    }
    .status-pending .status-dot{
      background:#fbbf24;
    }
    .status-active{
      background:rgba(34,197,94,.15);
      color:#166534;
    }
    .status-active .status-dot{
      background:#22c55e;
    }
    .status-completed{
      background:rgba(59,130,246,.15);
      color:#1d4ed8;
    }
    .status-completed .status-dot{
      background:#3b82f6;
    }
    .status-cancelled{
      background:rgba(239,68,68,.15);
      color:#b91c1c;
    }
    .status-cancelled .status-dot{
      background:#ef4444;
    }

    .meta-right{
      font-size:11px;
      color:var(--text-muted);
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .empty-state{
      margin-top:24px;
      padding:18px 14px;
      border-radius:18px;
      background:#f9fafb;
      border:1px dashed var(--border);
      text-align:center;
      font-size:13px;
      color:var(--text-secondary);
    }

    .bottom-nav{
      position:fixed;
      left:0;right:0;bottom:0;
      padding:8px max(16px,var(--tg-safe-area-inset-left,0px))
              max(8px,var(--tg-safe-area-inset-bottom,0px))
              max(16px,var(--tg-safe-area-inset-right,0px));
      background:rgba(255,255,255,.96);
      backdrop-filter:blur(18px);
      border-top:1px solid rgba(148,163,184,.3);
      z-index:30;
      display:flex;
      justify-content:center;
    }
    .bottom-nav-inner{
      width:100%;
      max-width:420px;
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      column-gap:10px;
      align-items:center;
    }
    .nav-item{
      border-radius:999px;
      padding:7px 8px;
      display:flex;
      flex-direction:row;
      align-items:center;
      justify-content:center;
      gap:6px;
      font-size:11px;
      font-weight:500;
      color:var(--text-secondary);
      cursor:pointer;
      border:1px solid transparent;
      background:transparent;
      -webkit-user-select:none;
      user-select:none;
      text-decoration:none;
      min-width:0;
    }
    .nav-item span.icon{font-size:16px;}
    .nav-item.active{
      background:#000;
      color:#fff;
      border-color:#000;
      box-shadow:0 8px 24px rgba(15,23,42,.45);
    }
    .nav-item:active:not(.active){
      background:rgba(0,0,0,.05);
    }
    .nav-spacer{width:100%;height:100%;}

    /* Detail bottom sheet */
    .detail-overlay{
      position:fixed;
      inset:0;
      padding-top:var(--tg-safe-area-inset-top,0px);
      padding-bottom:var(--tg-safe-area-inset-bottom,0px);
      padding-left:var(--tg-safe-area-inset-left,0px);
      padding-right:var(--tg-safe-area-inset-right,0px);
      display:none;
      align-items:flex-end;
      justify-content:center;
      background:rgba(15,23,42,.45);
      backdrop-filter:blur(8px);
      z-index:40;
    }
    .detail-overlay.visible{
      display:flex;
    }
    .detail-sheet{
      width:100%;
      max-width:420px;
      margin:0 auto;
      background:#f9fafb;
      border-radius:22px 22px 0 0;
      box-shadow:0 -10px 30px rgba(15,23,42,.5);
      max-height:calc(100% - 70px - var(--tg-safe-area-inset-top,0px));
      display:flex;
      flex-direction:column;
      overflow:hidden;
      transform:translateY(12px);
      opacity:0;
      transition:transform .22s ease,opacity .22s ease;
    }
    .detail-overlay.visible .detail-sheet{
      transform:translateY(0);
      opacity:1;
    }
    .detail-header{
      padding:10px 16px 6px 16px;
      display:flex;
      flex-direction:column;
      gap:8px;
      border-bottom:1px solid rgba(148,163,184,.4);
      background:#fff;
    }
    .detail-handle{
      width:46px;
      height:4px;
      border-radius:999px;
      background:rgba(148,163,184,.7);
      margin:4px auto 6px auto;
    }
    .detail-header-main{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .detail-title{
      font-size:15px;
      font-weight:600;
      color:#0f172a;
    }
    .detail-subtitle{
      font-size:11px;
      color:#6b7280;
    }
    .detail-price{
      padding:4px 10px;
      border-radius:999px;
      background:#000;
      color:#fff;
      font-size:12px;
      font-weight:600;
      white-space:nowrap;
    }
    .detail-status-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:4px;
    }
    .detail-status-info{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      color:#4b5563;
    }
    .detail-body{
      flex:1;
      min-height:0;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .detail-map{
      height:170px;
      background:#ffffff;
    }
    .detail-content{
      padding:10px 14px 14px 14px;
      overflow-y:auto;
    }
    .detail-row{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      font-size:12px;
      margin-bottom:6px;
    }
    .detail-label{
      color:#6b7280;
      min-width:80px;
    }
    .detail-value{
      color:#111827;
      text-align:right;
      flex:1;
    }
    .detail-address-block{
      margin-top:6px;
      padding:8px 9px;
      border-radius:12px;
      background:#fff;
      border:1px solid #e5e7eb;
      font-size:12px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .addr-line{
      display:flex;
      gap:6px;
      align-items:flex-start;
    }
    .addr-icon{
      width:16px;
      margin-top:1px;
    }
    .addr-text{
      flex:1;
      color:#111827;
    }

    .detail-close-btn{
      border:none;
      background:rgba(0,0,0,.04);
      width:30px;
      height:30px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      cursor:pointer;
      flex-shrink:0;
    }

    @media (max-height:640px){
      :root{
        --tg-content-safe-area-inset-top:10px;
      }
      .summary-card{
        padding:14px 12px 10px 12px;
        border-radius:18px;
      }
      .detail-map{
        height:150px;
      }
    }

    /* Leaflet cosmetics ‚Äì white "Uber-style" map */
    .leaflet-control-attribution,
    .leaflet-control-zoom,
    .leaflet-control{
      display:none !important;
    }
    .leaflet-container{
      background:#ffffff !important;
      font-family:inherit !important;
    }
  </style>
</head>
<body>
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
  <div class="loading-text"
       data-kz="–¢–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä –∂“Ø–∫—Ç–µ–ª—É–¥–µ..."
       data-ru="–ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∞—à–∏ –∑–∞–∫–∞–∑—ã...">
    –¢–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä –∂“Ø–∫—Ç–µ–ª—É–¥–µ...
  </div>
</div>

<div class="background"></div>

<div class="app-root" id="appRoot">
  <header class="top-bar">
    <div class="top-left">
      <button class="back-btn" id="backBtn" aria-label="Back">‚Üê</button>
      <div class="page-title-wrap">
        <div class="page-title"
             id="pageTitle"
             data-kz="–¢–∞—Ä–∏—Ö"
             data-ru="–ò—Å—Ç–æ—Ä–∏—è">
          –¢–∞—Ä–∏—Ö
        </div>
        <div class="page-subtitle"
             id="pageSubtitle"
             data-kz="–°–æ“£“ì—ã —Ç–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä—ã“£—ã–∑"
             data-ru="–í–∞—à–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–∫–∞–∑—ã">
          –°–æ“£“ì—ã —Ç–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä—ã“£—ã–∑
        </div>
      </div>
    </div>

    <div class="user-pill" id="userPill">
      <div class="user-avatar" id="userAvatar">
        <img id="userAvatarImg" alt="Avatar">
        <span id="userAvatarFallback">üë§</span>
      </div>
      <span id="userNameText"
            data-kz="–ö–ª–∏–µ–Ω—Ç"
            data-ru="–ö–ª–∏–µ–Ω—Ç">–ö–ª–∏–µ–Ω—Ç</span>
    </div>
  </header>

  <main class="content-scroll">
    <section class="summary-card">
      <div class="lang-switch">
        <button class="lang-btn active" id="lang-kz" onclick="setLang('kz')">“ö–ê–ó</button>
        <button class="lang-btn" id="lang-ru" onclick="setLang('ru')">–†–£–°</button>
      </div>

      <div class="summary-header">
        <div>
          <div class="summary-title"
               id="summaryTitle"
               data-kz="–°—ñ–∑–¥—ñ“£ –∂–µ—Ç–∫—ñ–∑—É —Ç–∞—Ä–∏—Ö—ã“£—ã–∑"
               data-ru="–ò—Å—Ç–æ—Ä–∏—è –≤–∞—à–∏—Ö –¥–æ—Å—Ç–∞–≤–æ–∫">
            –°—ñ–∑–¥—ñ“£ –∂–µ—Ç–∫—ñ–∑—É —Ç–∞—Ä–∏—Ö—ã“£—ã–∑
          </div>
          <div class="summary-caption"
               id="summaryCaption"
               data-kz="–ë–∞—Ä–ª—ã“õ —Ç–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä –±—ñ—Ä –∂–µ—Ä–¥–µ"
               data-ru="–í—Å–µ –≤–∞—à–∏ –∑–∞–∫–∞–∑—ã –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ">
            –ë–∞—Ä–ª—ã“õ —Ç–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä –±—ñ—Ä –∂–µ—Ä–¥–µ
          </div>
        </div>
      </div>

      <div class="summary-metrics">
        <div class="metric-pill">
          <div class="metric-label"
               data-kz="–ë–∞—Ä–ª—ã“ì—ã"
               data-ru="–í—Å–µ–≥–æ">
            –ë–∞—Ä–ª—ã“ì—ã
          </div>
          <div class="metric-value" id="metricTotal">0</div>
        </div>
        <div class="metric-pill">
          <div class="metric-label"
               data-kz="–ë–µ–ª—Å–µ–Ω–¥—ñ"
               data-ru="–ê–∫—Ç–∏–≤–Ω—ã–µ">
            –ë–µ–ª—Å–µ–Ω–¥—ñ
          </div>
          <div class="metric-value" id="metricActive">0</div>
        </div>
        <div class="metric-pill">
          <div class="metric-label"
               data-kz="–°–æ“£“ì—ã—Å—ã"
               data-ru="–ü–æ—Å–ª–µ–¥–Ω–∏–π">
            –°–æ“£“ì—ã—Å—ã
          </div>
          <div class="metric-value" id="metricLast">‚Äî</div>
        </div>
      </div>
    </section>

    <section>
      <div class="filters-row">
        <button class="filter-pill active" data-filter="all" id="filterAll">
          <span>üì¶</span>
          <span data-kz="–ë–∞—Ä–ª—ã“ì—ã" data-ru="–í—Å–µ">–ë–∞—Ä–ª—ã“ì—ã</span>
        </button>
        <button class="filter-pill" data-filter="active" id="filterActive">
          <span>üü¢</span>
          <span data-kz="–ë–µ–ª—Å–µ–Ω–¥—ñ" data-ru="–ê–∫—Ç–∏–≤–Ω—ã–µ">–ë–µ–ª—Å–µ–Ω–¥—ñ</span>
        </button>
        <button class="filter-pill" data-filter="completed" id="filterCompleted">
          <span>‚úÖ</span>
          <span data-kz="–ê—è“õ—Ç–∞–ª“ì–∞–Ω" data-ru="–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ">–ê—è“õ—Ç–∞–ª“ì–∞–Ω</span>
        </button>
      </div>

      <div class="card-list" id="ordersList"></div>

      <div class="empty-state" id="emptyState" style="display:none"
           data-kz="”ò–∑—ñ—Ä–≥–µ —Ç–∞–ø—Å—ã—Ä—ã—Å —Ç–∞—Ä–∏—Ö—ã –∂–æ“õ. –ë–∞—Å—Ç—ã –±–µ—Ç—Ç–µ–Ω –∂–∞“£–∞ –∂–µ—Ç–∫—ñ–∑—É–≥–µ —Ç–∞–ø—Å—ã—Ä—ã—Å –±–µ—Ä—ñ–ø –∫”©—Ä—ñ“£—ñ–∑."
           data-ru="–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –ø—É—Å—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ñ–æ—Ä–º–∏—Ç—å –ø–µ—Ä–≤—É—é –¥–æ—Å—Ç–∞–≤–∫—É –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ.">
        ”ò–∑—ñ—Ä–≥–µ —Ç–∞–ø—Å—ã—Ä—ã—Å —Ç–∞—Ä–∏—Ö—ã –∂–æ“õ. –ë–∞—Å—Ç—ã –±–µ—Ç—Ç–µ–Ω –∂–∞“£–∞ –∂–µ—Ç–∫—ñ–∑—É–≥–µ —Ç–∞–ø—Å—ã—Ä—ã—Å –±–µ—Ä—ñ–ø –∫”©—Ä—ñ“£—ñ–∑.
      </div>
    </section>
  </main>
</div>

<nav class="bottom-nav">
  <div class="bottom-nav-inner">
    <button class="nav-item active" id="tabHistory" type="button">
      <span class="icon">üìú</span>
      <span class="nav-item-label"
            data-kz="–¢–∞—Ä–∏—Ö"
            data-ru="–ò—Å—Ç–æ—Ä–∏—è">–¢–∞—Ä–∏—Ö</span>
    </button>

    <button class="nav-item" id="tabHome" type="button">
      <span class="icon">üè†</span>
      <span class="nav-item-label"
            data-kz="–ë–∞—Å—Ç—ã"
            data-ru="–ì–ª–∞–≤–Ω–∞—è">–ë–∞—Å—Ç—ã</span>
    </button>

    <div class="nav-spacer"></div>
  </div>
</nav>

<!-- –ú–∏–Ω–∏-–æ–∫–Ω–æ —Å –¥–µ—Ç–∞–ª—è–º–∏ –∑–∞–∫–∞–∑–∞ + –∫–∞—Ä—Ç–∞ -->
<div class="detail-overlay" id="detailOverlay">
  <div class="detail-sheet">
    <div class="detail-header">
      <div class="detail-handle"></div>
      <div class="detail-header-main">
        <div>
          <div class="detail-title" id="detailTitle">‚Äî</div>
          <div class="detail-subtitle" id="detailSubtitle">‚Äî</div>
        </div>
        <div class="detail-price" id="detailPrice">‚Äî</div>
        <button class="detail-close-btn" id="detailCloseBtn">‚úï</button>
      </div>
      <div class="detail-status-row">
        <div class="status-pill status-pending" id="detailStatusPill">
          <span class="status-dot"></span>
          <span id="detailStatusText">‚Äî</span>
        </div>
        <div class="detail-status-info" id="detailMetaSmall">
          <!-- distance / time here -->
        </div>
      </div>
    </div>

    <div class="detail-body">
      <div id="detailMap" class="detail-map"></div>
      <div class="detail-content">
        <div class="detail-row">
          <div class="detail-label" data-kz="“ö–∞—à—ã“õ—Ç—ã“õ" data-ru="–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ">“ö–∞—à—ã“õ—Ç—ã“õ</div>
          <div class="detail-value" id="detailDistance">‚Äî</div>
        </div>
        <div class="detail-row">
          <div class="detail-label" data-kz="–£–∞“õ—ã—Ç—ã" data-ru="–í—Ä–µ–º—è –≤ –ø—É—Ç–∏">–£–∞“õ—ã—Ç—ã</div>
          <div class="detail-value" id="detailEta">‚Äî</div>
        </div>
        <div class="detail-row">
          <div class="detail-label" data-kz="“ö“±—Ä—ã–ª“ì–∞–Ω" data-ru="–°–æ–∑–¥–∞–Ω">“ö“±—Ä—ã–ª“ì–∞–Ω</div>
          <div class="detail-value" id="detailCreatedAt">‚Äî</div>
        </div>

        <div class="detail-address-block">
          <div class="addr-line">
            <div class="addr-icon">üìç</div>
            <div class="addr-text" id="detailFrom">‚Äî</div>
          </div>
          <div class="addr-line">
            <div class="addr-icon">üèÅ</div>
            <div class="addr-text" id="detailTo">‚Äî</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  let currentLang = "kz";
  let allOrders = [];
  let currentFilter = "all";

  let detailOverlay, detailStatusPill, detailStatusText, detailTitle,
      detailSubtitle, detailPrice, detailDistance, detailEta,
      detailCreatedAt, detailFrom, detailTo, detailMetaSmall;

  let mapInstance = null;

  document.addEventListener("DOMContentLoaded", () => {
    detailOverlay = document.getElementById("detailOverlay");
    detailStatusPill = document.getElementById("detailStatusPill");
    detailStatusText = document.getElementById("detailStatusText");
    detailTitle = document.getElementById("detailTitle");
    detailSubtitle = document.getElementById("detailSubtitle");
    detailPrice = document.getElementById("detailPrice");
    detailDistance = document.getElementById("detailDistance");
    detailEta = document.getElementById("detailEta");
    detailCreatedAt = document.getElementById("detailCreatedAt");
    detailFrom = document.getElementById("detailFrom");
    detailTo = document.getElementById("detailTo");
    detailMetaSmall = document.getElementById("detailMetaSmall");

    initTelegramViewport();
    initTelegramUser();
    bindEvents();
    setLang("kz");
    loadHistory();
  });

  function initTelegramViewport() {
    try {
      const tg = window.Telegram?.WebApp;
      if (!tg) return;
      tg.ready();
      tg.expand();

      const root = document.documentElement;
      if (tg.viewportStableHeight) {
        root.style.setProperty("--tg-viewport-stable-height", tg.viewportStableHeight + "px");
      }
      if (tg.safeAreaInsetTop !== undefined) {
        root.style.setProperty("--tg-safe-area-inset-top", tg.safeAreaInsetTop + "px");
        root.style.setProperty("--tg-safe-area-inset-bottom", tg.safeAreaInsetBottom + "px");
        root.style.setProperty("--tg-safe-area-inset-left", tg.safeAreaInsetLeft + "px");
        root.style.setProperty("--tg-safe-area-inset-right", tg.safeAreaInsetRight + "px");
      }

      if (tg.disableVerticalSwipes) tg.disableVerticalSwipes();
    } catch (e) {
      console.warn("Telegram viewport init error:", e);
    }
  }

  function getTelegramId() {
    try {
      if (window.Telegram?.WebApp?.initDataUnsafe?.user) {
        return window.Telegram.WebApp.initDataUnsafe.user.id;
      }
    } catch(e){}

    const params = new URLSearchParams(location.search);
    const testId = params.get("test_id");
    return testId ? parseInt(testId, 10) : null;
  }

  function initTelegramUser() {
    try {
      const user = window.Telegram?.WebApp?.initDataUnsafe?.user;
      if (!user) return;

      const nameEl = document.getElementById("userNameText");
      const avatarImg = document.getElementById("userAvatarImg");
      const avatarFallback = document.getElementById("userAvatarFallback");

      const fullName = [user.first_name, user.last_name].filter(Boolean).join(" ");
      const displayName = user.username ? ("@" + user.username) : (fullName || "–ö–ª–∏–µ–Ω—Ç");
      if (nameEl) nameEl.textContent = displayName;

      if (user.photo_url && avatarImg) {
        avatarImg.src = user.photo_url;
        avatarImg.style.display = "block";
        if (avatarFallback) avatarFallback.style.display = "none";
      } else if (avatarFallback) {
        avatarFallback.textContent = (fullName || "A")[0].toUpperCase();
      }
    } catch(e){
      console.warn("init user error:", e);
    }
  }

  function bindEvents() {
    const backBtn = document.getElementById("backBtn");
    const tabHome = document.getElementById("tabHome");
    const tabHistory = document.getElementById("tabHistory");
    const detailCloseBtn = document.getElementById("detailCloseBtn");

    if (backBtn) backBtn.addEventListener("click", () => {
      window.location.href = "/main-client";
    });

    if (tabHome) {
      tabHome.addEventListener("click", () => {
        window.location.href = "/main-client";
      });
    }
    if (tabHistory) {
      tabHistory.addEventListener("click", () => {
        // already here
      });
    }

    document.querySelectorAll(".filter-pill").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".filter-pill").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentFilter = btn.getAttribute("data-filter");
        renderOrders();
      });
    });

    if (detailCloseBtn) {
      detailCloseBtn.addEventListener("click", closeDetailOverlay);
    }
    if (detailOverlay) {
      detailOverlay.addEventListener("click", (e) => {
        if (e.target === detailOverlay) {
          closeDetailOverlay();
        }
      });
    }
  }

  async function loadHistory() {
    const overlay = document.getElementById("loadingOverlay");
    const appRoot = document.getElementById("appRoot");
    const tgId = getTelegramId();

    if (!tgId) {
      updateLoadingText("noUser");
      setTimeout(() => {
        overlay.classList.add("hidden");
        appRoot.classList.add("visible");
      }, 250);
      return;
    }

    updateLoadingText("loading");

    try {
      const res = await fetch("/api/user/history", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({telegram_id: tgId})
      });

      if (!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      if (!data.success) throw new Error(data.message || "Error");

      allOrders = (data.data && data.data.orders) || [];
      updateSummary();
      renderOrders();
    } catch(e){
      console.error("loadHistory error:", e);
      updateLoadingText("error");
    } finally {
      setTimeout(() => {
        overlay.classList.add("hidden");
        appRoot.classList.add("visible");
      }, 250);
    }
  }

  function updateLoadingText(mode) {
    const el = document.querySelector(".loading-text");
    if (!el) return;

    const dict = {
      kz:{
        loading:"–¢–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä –∂“Ø–∫—Ç–µ–ª—É–¥–µ...",
        error:"“ö–∞—Ç–µ –ø–∞–π–¥–∞ –±–æ–ª–¥—ã. –ö–µ–π—ñ–Ω—ñ—Ä–µ–∫ “õ–∞–π—Ç–∞–ª–∞–ø –∫”©—Ä—ñ“£—ñ–∑.",
        noUser:"Telegram –¥–µ—Ä–µ–∫—Ç–µ—Ä—ñ —Ç–∞–±—ã–ª–º–∞–¥—ã. –ü—Ä–æ—Ñ–∏–ª—å –∞—à—ã–ª—É–¥–∞."
      },
      ru:{
        loading:"–ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∞—à–∏ –∑–∞–∫–∞–∑—ã...",
        error:"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
        noUser:"–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö Telegram. –û—Ç–∫—Ä—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é."
      }
    };
    const langDict = dict[currentLang] || dict.kz;
    el.textContent = langDict[mode] || langDict.loading;
  }

  function statusToLabel(status){
    status = (status || "").toLowerCase();
    const map = {
      pending:{kz:"–ö“Ø—Ç—É–¥–µ",ru:"–í –æ–∂–∏–¥–∞–Ω–∏–∏"},
      matched:{kz:"–ñ“Ø—Ä–≥—ñ–∑—É—à—ñ —Ç–∞–±—ã–ª–¥—ã",ru:"–í–æ–¥–∏—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω"},
      in_progress:{kz:"–ñ–æ–ª–¥–∞",ru:"–í –ø—É—Ç–∏"},
      completed:{kz:"–ê—è“õ—Ç–∞–ª“ì–∞–Ω",ru:"–ó–∞–≤–µ—Ä—à—ë–Ω"},
      cancelled:{kz:"–ë–∞—Å —Ç–∞—Ä—Ç—ã–ª–¥—ã",ru:"–û—Ç–º–µ–Ω—ë–Ω"}
    };
    const item = map[status] || map["pending"];
    return item[currentLang];
  }

  function statusClass(status){
    status = (status || "").toLowerCase();
    if (status === "completed") return "status-completed";
    if (status === "cancelled") return "status-cancelled";
    if (status === "in_progress" || status === "matched") return "status-active";
    return "status-pending";
  }

  function isActiveStatus(status){
    status = (status || "").toLowerCase();
    return status === "pending" || status === "matched" || status === "in_progress";
  }

  function formatDate(str){
    if (!str) return "‚Äî";
    const d = new Date(str);
    if (isNaN(d.getTime())) return str;
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const hh = String(d.getHours()).padStart(2,"0");
    const min = String(d.getMinutes()).padStart(2,"0");
    return `${dd}.${mm} ${hh}:${min}`;
  }

  function updateSummary(){
    const total = allOrders.length;
    let active = 0;
    let lastDate = null;

    allOrders.forEach(o => {
      if (isActiveStatus(o.status)) active++;
      const dt = new Date(o.created_at || o.CreatedAt || o.createdAt);
      if (!isNaN(dt.getTime())) {
        if (!lastDate || dt > lastDate) lastDate = dt;
      }
    });

    const totalEl = document.getElementById("metricTotal");
    const activeEl = document.getElementById("metricActive");
    const lastEl = document.getElementById("metricLast");

    if (totalEl) totalEl.textContent = total;
    if (activeEl) activeEl.textContent = active;
    if (lastEl) {
      if (!lastDate) {
        lastEl.textContent = "‚Äî";
      } else {
        const dd = String(lastDate.getDate()).padStart(2,"0");
        const mm = String(lastDate.getMonth()+1).padStart(2,"0");
        lastEl.textContent = `${dd}.${mm}`;
      }
    }
  }

  function renderOrders(){
    const list = document.getElementById("ordersList");
    const empty = document.getElementById("emptyState");
    if (!list) return;
    list.innerHTML = "";

    let filtered = allOrders;
    if (currentFilter === "active") {
      filtered = allOrders.filter(o => isActiveStatus(o.status));
    } else if (currentFilter === "completed") {
      filtered = allOrders.filter(o => (o.status || "").toLowerCase() === "completed");
    }

    if (!filtered.length) {
      if (empty) {
        const t = empty.getAttribute("data-" + currentLang);
        if (t) empty.textContent = t;
        empty.style.display = "block";
      }
      return;
    } else if (empty) {
      empty.style.display = "none";
    }

    filtered.forEach(o => {
      const card = document.createElement("article");
      card.className = "order-card";

      const from = o.from_address || o.FromAddress || "";
      const to = o.to_address || o.ToAddress || "";
      const price = o.price || o.Price || 0;
      const status = o.status || o.Status || "pending";
      const distance = o.distance_km || o.DistanceKm || null;
      const eta = o.eta_min || o.EtaMin || null;
      const created = o.created_at || o.CreatedAt || o.createdAt;

      card.innerHTML = `
        <div class="order-route">
          <div class="route-main">
            <div class="route-line">
              <span class="route-city">${escapeHTML(from)}</span>
              <span class="route-arrow">‚Üí</span>
              <span class="route-city">${escapeHTML(to)}</span>
            </div>
            <div class="route-sub">
              ${formatDate(created)}
            </div>
          </div>
          <div class="price-pill">${price.toLocaleString("ru-RU")} ‚Ç∏</div>
        </div>

        <div class="order-meta-row">
          <div class="status-pill ${statusClass(status)}">
            <span class="status-dot"></span>
            <span>${statusToLabel(status)}</span>
          </div>
          <div class="meta-right">
            ${distance ? `<span>${Number(distance).toFixed(1)} –∫–º</span>` : ""}
            ${eta ? `<span>~${eta} –º–∏–Ω</span>` : ""}
          </div>
        </div>
      `;

      card.addEventListener("click", () => {
        openDetailOverlay(o);
      });

      list.appendChild(card);
    });
  }

  function escapeHTML(str){
    if (!str) return "";
    return String(str)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;");
  }

  function setLang(lang){
    currentLang = lang;

    document.querySelectorAll(".lang-btn").forEach(b => b.classList.remove("active"));
    const active = document.getElementById("lang-" + lang);
    if (active) active.classList.add("active");

    document.querySelectorAll("[data-kz]").forEach(el => {
      const text = el.getAttribute("data-" + lang);
      if (text) el.textContent = text;
    });

    renderOrders();
    updateSummary();
  }
  window.setLang = setLang;

  /* ===== DETAIL SHEET + UBER-STYLE MAP ===== */

  function openDetailOverlay(order){
    if (!order || !detailOverlay) return;

    const from = order.from_address || order.FromAddress || "";
    const to = order.to_address || order.ToAddress || "";
    const price = order.price || order.Price || 0;
    const status = order.status || order.Status || "pending";
    const distance = order.distance_km || order.DistanceKm || null;
    const eta = order.eta_min || order.EtaMin || null;
    const created = order.created_at || order.CreatedAt || order.createdAt;

    detailTitle.textContent = from && to
      ? `${shorten(from)} ‚Üí ${shorten(to)}`
      : (from || to || "–ñ–µ—Ç–∫—ñ–∑—É");

    detailSubtitle.textContent = formatDate(created);
    detailPrice.textContent = `${(price || 0).toLocaleString("ru-RU")} ‚Ç∏`;

    detailStatusPill.className = "status-pill " + statusClass(status);
    detailStatusText.textContent = statusToLabel(status);

    detailDistance.textContent = distance
      ? `${Number(distance).toFixed(1)} –∫–º`
      : "‚Äî";

    detailEta.textContent = eta ? `~${eta} –º–∏–Ω` : "‚Äî";
    detailCreatedAt.textContent = formatDate(created);

    detailFrom.textContent = from || "‚Äî";
    detailTo.textContent = to || "‚Äî";

    detailMetaSmall.textContent = "";
    const parts = [];
    if (distance) parts.push(`${Number(distance).toFixed(1)} –∫–º`);
    if (eta) parts.push(`~${eta} –º–∏–Ω`);
    detailMetaSmall.textContent = parts.join(" ‚Ä¢ ");

    detailOverlay.classList.add("visible");

    setTimeout(() => {
      initOrUpdateMap(order);
    }, 50);
  }

  function closeDetailOverlay(){
    if (!detailOverlay) return;
    detailOverlay.classList.remove("visible");
    if (mapInstance) {
      mapInstance.remove();
      mapInstance = null;
    }
  }

  function shorten(text){
    if (!text) return "";
    const maxLen = 26;
    return text.length > maxLen ? text.slice(0,maxLen-1) + "‚Ä¶" : text;
  }

  function initOrUpdateMap(order){
    const mapContainer = document.getElementById("detailMap");
    if (!mapContainer) return;

    const fromLat = parseFloat(order.from_lat || order.FromLat);
    const fromLng = parseFloat(order.from_lng || order.FromLng);
    const toLat = parseFloat(order.to_lat || order.ToLat);
    const toLng = parseFloat(order.to_lng || order.ToLng);

    const hasFrom = !isNaN(fromLat) && !isNaN(fromLng);
    const hasTo = !isNaN(toLat) && !isNaN(toLng);

    if (!mapInstance) {
      mapInstance = L.map(mapContainer, {
        zoomControl:false,
        attributionControl:false
      }).setView([43.238949, 76.889709], 11); // fallback Almaty

      // Uber-style white basemap (Carto light)
      L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
        maxZoom:19,
        subdomains:"abcd"
      }).addTo(mapInstance);
    }

    // Remove all layers except tileLayer
    mapInstance.eachLayer(l => {
      if (!(l instanceof L.TileLayer)) {
        mapInstance.removeLayer(l);
      }
    });

    // Custom markers A/B
    if (hasFrom) {
      const iconA = L.divIcon({
        html:'<div style="width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;background:#000;border:3px solid #fff;box-shadow:0 4px 14px rgba(0,0,0,.25)">A</div>',
        className:"",
        iconSize:[32,32],
        iconAnchor:[16,32]
      });
      L.marker([fromLat, fromLng], {icon:iconA}).addTo(mapInstance);
    }

    if (hasTo) {
      const iconB = L.divIcon({
        html:'<div style="width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;background:#0B63F6;border:3px solid #fff;box-shadow:0 4px 14px rgba(0,0,0,.25)">B</div>',
        className:"",
        iconSize:[32,32],
        iconAnchor:[16,32]
      });
      L.marker([toLat, toLng], {icon:iconB}).addTo(mapInstance);
    }

    if (hasFrom && hasTo) {
      drawRouteUberStyle({fromLat, fromLng, toLat, toLng});
    } else if (hasFrom) {
      mapInstance.setView([fromLat, fromLng], 12);
      setTimeout(() => mapInstance.invalidateSize(), 150);
    } else if (hasTo) {
      mapInstance.setView([toLat, toLng], 12);
      setTimeout(() => mapInstance.invalidateSize(), 150);
    } else {
      mapInstance.setView([43.238949, 76.889709], 11);
      setTimeout(() => mapInstance.invalidateSize(), 150);
    }
  }

  async function drawRouteUberStyle(coords){
    if (!mapInstance) return;
    const {fromLat, fromLng, toLat, toLng} = coords;

    if ([fromLat, fromLng, toLat, toLng].some(v => isNaN(v))) return;

    try {
      const url = `https://router.project-osrm.org/route/v1/driving/${fromLng},${fromLat};${toLng},${toLat}?overview=full&geometries=geojson&steps=true`;
      const r = await fetch(url);
      if (!r.ok) throw new Error("OSRM error");
      const data = await r.json();
      if (!(data.routes && data.routes.length)) throw new Error("No route");

      const route = data.routes[0];
      const coordsList = route.geometry.coordinates.map(c => [c[1], c[0]]);

      const main = L.polyline(coordsList, {
        color:"#000000",
        weight:5,
        opacity:0.9
      }).addTo(mapInstance);
      const shadow = L.polyline(coordsList, {
        color:"#00000030",
        weight:7,
        opacity:0.3
      }).addTo(mapInstance);
      shadow.bringToBack();

      const bounds = L.latLngBounds(coordsList);
      mapInstance.fitBounds(bounds, {padding:[24,24], maxZoom:16});

      const km = (route.distance/1000).toFixed(1);
      const min = Math.round(route.duration/60);
      detailEta.textContent = `~${min} –º–∏–Ω`;
      detailDistance.textContent = `${km} –∫–º`;
      detailMetaSmall.textContent = `${km} –∫–º ‚Ä¢ ${min} –º–∏–Ω`;
    } catch(e) {
      // Fallback: simple line A‚ÜíB + bounds
      const coordsAB = [[fromLat, fromLng],[toLat, toLng]];
      L.polyline(coordsAB, {
        color:"#000000",
        weight:4,
        opacity:0.75,
        dashArray:"10,5"
      }).addTo(mapInstance);
      const bounds = L.latLngBounds(coordsAB);
      mapInstance.fitBounds(bounds, {padding:[24,24], maxZoom:16});
      setTimeout(() => mapInstance.invalidateSize(), 150);
    }
  }
</script>
</body>
</html>
