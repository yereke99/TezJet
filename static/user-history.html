<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Alash Go ‚Äì –¢–∞—Ä–∏—Ö</title>

  <!-- Telegram SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Leaflet (map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg-primary:#000000;
      --bg-secondary:#ffffff;
      --bg-card:#f8f9fa;
      --bg-card-dark:#020617;
      --text-primary:#000000;
      --text-secondary:#4b5563;
      --text-muted:#9ca3af;
      --text-white:#ffffff;
      --accent-primary:#000000;
      --accent-secondary:#0b63f6;
      --border:#e5e7eb;
      --border-light:#edf1f5;
      --shadow-subtle:0 2px 8px rgba(0,0,0,.06);
      --shadow-medium:0 4px 16px rgba(0,0,0,.12);
      --radius-md:12px;
      --radius-lg:18px;
      --radius-xl:24px;

      --tg-viewport-stable-height:100vh;
      --tg-safe-area-inset-top:env(safe-area-inset-top,0px);
      --tg-safe-area-inset-bottom:env(safe-area-inset-bottom,0px);
      --tg-safe-area-inset-left:env(safe-area-inset-left,0px);
      --tg-safe-area-inset-right:env(safe-area-inset-right,0px);

      --tg-content-safe-area-inset-top:15px;
      --bottom-nav-height:72px;
    }

    *{
      margin:0;
      padding:0;
      box-sizing:border-box;
      -webkit-tap-highlight-color:transparent;
    }

    html,body{
      height:100vh;
      height:100dvh;
    }

    body{
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","Inter",system-ui,sans-serif;
      background:var(--bg-secondary);
      color:var(--text-primary);

      position:fixed;
      inset:0;
      width:100%;
      height:var(--tg-viewport-stable-height,100vh);

      padding-top:calc(
        var(--tg-safe-area-inset-top,0px) +
        var(--tg-content-safe-area-inset-top,15px)
      );
      padding-bottom:calc(
        var(--bottom-nav-height)+
        max(10px,var(--tg-safe-area-inset-bottom,0px))
      );
      padding-left:max(16px,var(--tg-safe-area-inset-left,0px));
      padding-right:max(16px,var(--tg-safe-area-inset-right,0px));

      overflow:hidden;
      overscroll-behavior:contain;
      -webkit-overflow-scrolling:touch;
    }

    .background{
      position:fixed;
      inset:0;
      background:radial-gradient(circle at top,rgba(0,0,0,.04),transparent 55%),var(--bg-secondary);
      z-index:-2;
    }
    .background::before{
      content:"";
      position:absolute;
      inset:0;
      background:linear-gradient(135deg,rgba(15,23,42,.06) 0%,transparent 50%);
      z-index:-1;
    }

    .loading-overlay{
      position:fixed;
      inset:0;
      width:100%;
      height:100%;
      background:var(--bg-secondary);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:20px;
      z-index:9999;
      transition:opacity .25s ease,visibility .25s ease;
    }
    .loading-overlay.hidden{
      opacity:0;
      visibility:hidden;
      pointer-events:none;
    }
    .loading-spinner{
      width:32px;
      height:32px;
      border-radius:50%;
      border:2px solid var(--border-light);
      border-top:2px solid var(--accent-primary);
      animation:spin 1s linear infinite;
    }
    .loading-text{
      font-size:14px;
      font-weight:500;
      color:var(--text-secondary);
      text-align:center;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    .app-root{
      position:relative;
      height:100%;
      max-width:420px;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      opacity:0;
      transform:translateY(4px);
      transition:opacity .25s ease,transform .25s ease;
    }
    .app-root.visible{
      opacity:1;
      transform:translateY(0);
    }

    /* ======= TOP BAR ======= */
    .top-bar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:2px 2px 8px 2px;
      flex-shrink:0;
    }
    .top-left{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .back-btn{
      width:32px;
      height:32px;
      border-radius:999px;
      border:none;
      display:flex;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.04);
      cursor:pointer;
      font-size:18px;
    }
    .page-title-wrap{
      display:flex;
      flex-direction:column;
    }
    .page-title{
      font-size:18px;
      font-weight:700;
    }
    .page-subtitle{
      font-size:12px;
      color:var(--text-muted);
    }

    .user-pill{
      padding:6px 10px;
      border-radius:999px;
      background:rgba(0,0,0,.04);
      display:flex;
      align-items:center;
      gap:6px;
      font-size:12px;
      color:var(--text-secondary);
      max-width:170px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .user-avatar{
      width:24px;
      height:24px;
      border-radius:999px;
      background:#111;
      color:#fff;
      font-size:11px;
      font-weight:600;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      position:relative;
      flex-shrink:0;
    }
    .user-avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:none;
    }
    .user-avatar span{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .lang-switch{
      position:absolute;
      top:10px;
      right:10px;
      display:flex;
      background:rgba(15,23,42,.92);
      border-radius:24px;
      padding:3px;
      border:1px solid rgba(148,163,184,.6);
      box-shadow:0 8px 18px rgba(0,0,0,.35);
      z-index:5;
    }
    .lang-btn{
      background:transparent;
      border:none;
      border-radius:18px;
      padding:4px 12px;
      cursor:pointer;
      font-weight:600;
      font-size:11px;
      min-width:40px;
      color:rgba(226,232,240,.8);
      transition:all .18s ease;
    }
    .lang-btn.active{
      background:#f9fafb;
      color:#020617;
      transform:scale(1.02);
    }
    .lang-btn:hover:not(.active){
      background:rgba(148,163,184,.25);
      color:#e5e7eb;
    }

    /* ======= MAIN CONTENT ======= */
    .content-scroll{
      flex:1;
      min-height:0;
      overflow-y:auto;
      padding:4px 2px 0 2px;
      -webkit-overflow-scrolling:touch;
    }
    .content-scroll::-webkit-scrollbar{width:0;height:0;}

    .summary-card{
      position:relative;
      border-radius:var(--radius-xl);
      background:radial-gradient(circle at top left,#111827 0%,#020617 45%,#000 100%);
      color:var(--text-white);
      padding:18px 14px 14px 14px;
      box-shadow:0 8px 26px rgba(15,23,42,.7);
      margin-bottom:14px;
      overflow:hidden;
    }
    .summary-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .summary-title{
      font-size:16px;
      font-weight:600;
    }
    .summary-caption{
      font-size:12px;
      color:rgba(209,213,219,.9);
    }
    .summary-metrics{
      display:flex;
      gap:10px;
      margin-top:6px;
    }
    .metric-pill{
      flex:1;
      border-radius:14px;
      background:rgba(15,23,42,.75);
      padding:8px 10px;
      display:flex;
      flex-direction:column;
      gap:2px;
      border:1px solid rgba(148,163,184,.4);
    }
    .metric-label{
      font-size:11px;
      color:rgba(148,163,184,1);
    }
    .metric-value{
      font-size:15px;
      font-weight:600;
    }

    .filters-row{
      display:flex;
      gap:8px;
      margin:0 2px 10px 2px;
    }
    .filter-pill{
      border-radius:999px;
      padding:6px 10px;
      border:1px solid var(--border-light);
      background:#fff;
      font-size:12px;
      color:var(--text-secondary);
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
      box-shadow:0 1px 2px rgba(0,0,0,.04);
    }
    .filter-pill.active{
      background:#000;
      color:#fff;
      border-color:#000;
      box-shadow:0 6px 16px rgba(15,23,42,.36);
    }

    .card-list{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-bottom:12px;
    }

    .order-card{
      border-radius:var(--radius-lg);
      background:var(--bg-card);
      box-shadow:var(--shadow-subtle);
      border:1px solid var(--border-light);
      padding:10px 11px;
      display:flex;
      flex-direction:column;
      gap:6px;
      position:relative;
      transition:transform .12s ease, box-shadow .12s ease;
    }

    .order-card-content{
      cursor:pointer;
    }
    .order-card-content:active{
      transform:scale(.99);
    }

    .order-route{
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:flex-start;
    }
    .route-main{
      flex:1;
      min-width:0;
    }
    .route-line{
      font-size:13px;
      font-weight:600;
      color:#111827;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .route-city{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .route-arrow{
      font-size:14px;
    }
    .route-sub{
      font-size:11px;
      color:var(--text-muted);
      margin-top:1px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .price-pill{
      padding:4px 8px;
      border-radius:999px;
      background:#000;
      color:#fff;
      font-size:11px;
      font-weight:600;
      white-space:nowrap;
      align-self:flex-start;
    }

    .order-meta-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      row-gap:4px;
      margin-top:2px;
    }
    .status-pill{
      padding:3px 9px;
      border-radius:999px;
      font-size:11px;
      font-weight:500;
      display:inline-flex;
      align-items:center;
      gap:5px;
    }
    .status-dot{
      width:6px;
      height:6px;
      border-radius:50%;
    }
    .status-pending{
      background:rgba(251,191,36,.15);
      color:#92400e;
    }
    .status-pending .status-dot{background:#fbbf24;}
    .status-active{
      background:rgba(34,197,94,.15);
      color:#166534;
    }
    .status-active .status-dot{background:#22c55e;}
    .status-completed{
      background:rgba(59,130,246,.15);
      color:#1d4ed8;
    }
    .status-completed .status-dot{background:#3b82f6;}
    .status-cancelled{
      background:rgba(239,68,68,.15);
      color:#b91c1c;
    }
    .status-cancelled .status-dot{background:#ef4444;}

    .meta-right{
      font-size:11px;
      color:var(--text-muted);
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    /* NEW: Cancel button styles */
    .order-actions{
      display:flex;
      gap:6px;
      margin-top:6px;
      padding-top:6px;
      border-top:1px solid var(--border-light);
    }
    .cancel-btn{
      flex:1;
      padding:7px 12px;
      border-radius:999px;
      border:1px solid #ef4444;
      background:#fff;
      color:#dc2626;
      font-size:11px;
      font-weight:600;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:4px;
      transition:all .15s ease;
    }
    .cancel-btn:hover{
      background:#fef2f2;
    }
    .cancel-btn:active{
      transform:scale(.97);
      background:#fee2e2;
    }
    .cancel-btn:disabled{
      opacity:.4;
      cursor:not-allowed;
      border-color:#d1d5db;
      color:#9ca3af;
    }
    .cancel-btn:disabled:hover{
      background:#fff;
    }

    .empty-state{
      margin-top:24px;
      padding:18px 14px;
      border-radius:18px;
      background:#f9fafb;
      border:1px dashed var(--border);
      text-align:center;
      font-size:13px;
      color:var(--text-secondary);
    }

    /* ======= BOTTOM NAV ======= */
    .bottom-nav{
      position:fixed;
      left:0;right:0;bottom:0;
      padding:8px max(16px,var(--tg-safe-area-inset-left,0px))
              max(8px,var(--tg-safe-area-inset-bottom,0px))
              max(16px,var(--tg-safe-area-inset-right,0px));
      background:rgba(255,255,255,.96);
      backdrop-filter:blur(18px);
      border-top:1px solid rgba(148,163,184,.3);
      z-index:30;
      display:flex;
      justify-content:center;
    }
    .bottom-nav-inner{
      width:100%;
      max-width:420px;
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      column-gap:10px;
      align-items:center;
    }
    .nav-item{
      border-radius:999px;
      padding:7px 8px;
      display:flex;
      flex-direction:row;
      align-items:center;
      justify-content:center;
      gap:6px;
      font-size:11px;
      font-weight:500;
      color:var(--text-secondary);
      cursor:pointer;
      border:1px solid transparent;
      background:transparent;
      -webkit-user-select:none;
      user-select:none;
      text-decoration:none;
      min-width:0;
    }
    .nav-item span.icon{font-size:16px;}
    .nav-item.active{
      background:#000;
      color:#fff;
      border-color:#000;
      box-shadow:0 8px 24px rgba(15,23,42,.45);
    }
    .nav-item:active:not(.active){
      background:rgba(0,0,0,.05);
    }
    .nav-spacer{width:100%;height:100%;}

    @media (max-height:640px){
      :root{ --tg-content-safe-area-inset-top:10px; }
      .summary-card{
        padding:14px 12px 10px 12px;
        border-radius:18px;
      }
    }

    /* ======= ORDER DETAIL MODAL / SHEET ======= */
    .order-detail-modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:flex-end;
      justify-content:center;
      background:rgba(0,0,0,.55);
      backdrop-filter:blur(8px);
      -webkit-backdrop-filter:blur(8px);
      z-index:200;
    }
    .order-detail-modal.show{display:flex;}

    .order-detail-sheet{
      width:100%;
      max-width:460px;
      max-height:calc(
        var(--tg-viewport-stable-height,100vh)
        - var(--tg-safe-area-inset-top,0px)
        - 32px
      );
      margin-top:calc(var(--tg-safe-area-inset-top,0px) + 16px);
      border-radius:22px 22px 0 0;
      background:#ffffff;
      box-shadow:0 20px 40px rgba(15,23,42,.5);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }

    .order-detail-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px 10px 16px;
      border-bottom:1px solid var(--border-light);
    }
    .order-detail-title{
      font-size:16px;
      font-weight:600;
    }
    .order-detail-subtitle{
      font-size:11px;
      color:var(--text-muted);
      margin-top:2px;
    }
    .order-detail-close{
      width:32px;
      height:32px;
      border-radius:999px;
      border:none;
      background:#f3f4f6;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:20px;
      cursor:pointer;
    }

    .order-detail-content{
      flex:1;
      min-height:0;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
    }

    .order-detail-map-wrap{
      position:relative;
      width:100%;
      height:240px;
      border-bottom:1px solid var(--border-light);
      background:#ffffff;
    }
    #detailMap{
      width:100%;
      height:100%;
    }
    .order-detail-map-chip{
      position:absolute;
      left:12px;
      top:12px;
      padding:8px 10px;
      border-radius:999px;
      background:#111827;
      color:#f9fafb;
      font-size:11px;
      font-weight:500;
      box-shadow:0 10px 24px rgba(0,0,0,.35);
    }

    .order-detail-body{
      padding:14px 16px 18px 16px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .detail-route-block{
      background:#f9fafb;
      border-radius:16px;
      padding:10px 10px 10px 10px;
      border:1px solid var(--border-light);
    }
    .detail-route-line{
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .detail-pin{
      width:28px;
      height:28px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:13px;
      color:#fff;
      font-weight:700;
      box-shadow:0 4px 10px rgba(0,0,0,.25);
    }
    .detail-pin.a{background:#000;}
    .detail-pin.b{background:#0b63f6;}
    .detail-route-text{
      flex:1;
      min-width:0;
    }
    .detail-route-label{
      font-size:11px;
      color:var(--text-muted);
      text-transform:uppercase;
      letter-spacing:.4px;
    }
    .detail-route-address{
      font-size:13px;
      font-weight:600;
      color:#0f172a;
    }

    .detail-meta-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .detail-chip{
      border-radius:999px;
      padding:6px 10px;
      border:1px solid var(--border-light);
      background:#fff;
      font-size:11px;
      color:var(--text-secondary);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    .detail-price-main{
      font-size:18px;
      font-weight:700;
    }
    .detail-status-pill{
      padding:4px 10px;
      border-radius:999px;
      font-size:11px;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    /* NEW: Confirmation Dialog */
    .confirm-dialog{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.6);
      backdrop-filter:blur(6px);
      z-index:300;
      padding:20px;
    }
    .confirm-dialog.show{display:flex;}
    .confirm-dialog-box{
      background:#fff;
      border-radius:18px;
      padding:20px;
      max-width:340px;
      width:100%;
      box-shadow:0 20px 40px rgba(0,0,0,.3);
    }
    .confirm-dialog-title{
      font-size:16px;
      font-weight:700;
      margin-bottom:8px;
    }
    .confirm-dialog-message{
      font-size:13px;
      color:var(--text-secondary);
      line-height:1.5;
      margin-bottom:16px;
    }
    .confirm-dialog-actions{
      display:flex;
      gap:8px;
    }
    .confirm-dialog-btn{
      flex:1;
      padding:10px 16px;
      border-radius:999px;
      border:none;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
      transition:all .15s ease;
    }
    .confirm-dialog-btn.secondary{
      background:#f3f4f6;
      color:#4b5563;
    }
    .confirm-dialog-btn.secondary:hover{
      background:#e5e7eb;
    }
    .confirm-dialog-btn.danger{
      background:#ef4444;
      color:#fff;
    }
    .confirm-dialog-btn.danger:hover{
      background:#dc2626;
    }
    .confirm-dialog-btn:active{
      transform:scale(.97);
    }

    /* Leaflet cosmetics */
    .leaflet-control-attribution,
    .leaflet-control-zoom,
    .leaflet-control{display:none!important;}
    .leaflet-container{
      background:#ffffff!important;
      font-family:inherit!important;
    }
  </style>
</head>
<body>
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
  <div class="loading-text"
       data-kz="–¢–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä –∂“Ø–∫—Ç–µ–ª—É–¥–µ..."
       data-ru="–ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∞—à–∏ –∑–∞–∫–∞–∑—ã...">
    –¢–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä –∂“Ø–∫—Ç–µ–ª—É–¥–µ...
  </div>
</div>

<div class="background"></div>

<div class="app-root" id="appRoot">
  <header class="top-bar">
    <div class="top-left">
      <button class="back-btn" id="backBtn" aria-label="Back">‚Üê</button>
      <div class="page-title-wrap">
        <div class="page-title"
             id="pageTitle"
             data-kz="–¢–∞—Ä–∏—Ö"
             data-ru="–ò—Å—Ç–æ—Ä–∏—è">
          –¢–∞—Ä–∏—Ö
        </div>
        <div class="page-subtitle"
             id="pageSubtitle"
             data-kz="–°–æ“£“ì—ã —Ç–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä—ã“£—ã–∑"
             data-ru="–í–∞—à–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–∫–∞–∑—ã">
          –°–æ“£“ì—ã —Ç–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä—ã“£—ã–∑
        </div>
      </div>
    </div>

    <div class="user-pill" id="userPill">
      <div class="user-avatar" id="userAvatar">
        <img id="userAvatarImg" alt="Avatar">
        <span id="userAvatarFallback">üë§</span>
      </div>
      <span id="userNameText"
            data-kz="–ö–ª–∏–µ–Ω—Ç"
            data-ru="–ö–ª–∏–µ–Ω—Ç">–ö–ª–∏–µ–Ω—Ç</span>
    </div>
  </header>

  <main class="content-scroll">
    <section class="summary-card">
      <div class="lang-switch">
        <button class="lang-btn active" id="lang-kz" data-lang="kz">“ö–ê–ó</button>
        <button class="lang-btn" id="lang-ru" data-lang="ru">–†–£–°</button>
      </div>

      <div class="summary-header">
        <div>
          <div class="summary-title"
               id="summaryTitle"
               data-kz="–°—ñ–∑–¥—ñ“£ –∂–µ—Ç–∫—ñ–∑—É —Ç–∞—Ä–∏—Ö—ã“£—ã–∑"
               data-ru="–ò—Å—Ç–æ—Ä–∏—è –≤–∞—à–∏—Ö –¥–æ—Å—Ç–∞–≤–æ–∫">
            –°—ñ–∑–¥—ñ“£ –∂–µ—Ç–∫—ñ–∑—É —Ç–∞—Ä–∏—Ö—ã“£—ã–∑
          </div>
          <div class="summary-caption"
               id="summaryCaption"
               data-kz="–ë–∞—Ä–ª—ã“õ —Ç–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä –±—ñ—Ä –∂–µ—Ä–¥–µ"
               data-ru="–í—Å–µ –≤–∞—à–∏ –∑–∞–∫–∞–∑—ã –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ">
            –ë–∞—Ä–ª—ã“õ —Ç–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä –±—ñ—Ä –∂–µ—Ä–¥–µ
          </div>
        </div>
      </div>

      <div class="summary-metrics">
        <div class="metric-pill">
          <div class="metric-label"
               data-kz="–ë–∞—Ä–ª—ã“ì—ã"
               data-ru="–í—Å–µ–≥–æ">
            –ë–∞—Ä–ª—ã“ì—ã
          </div>
          <div class="metric-value" id="metricTotal">0</div>
        </div>
        <div class="metric-pill">
          <div class="metric-label"
               data-kz="–ë–µ–ª—Å–µ–Ω–¥—ñ"
               data-ru="–ê–∫—Ç–∏–≤–Ω—ã–µ">
            –ë–µ–ª—Å–µ–Ω–¥—ñ
          </div>
          <div class="metric-value" id="metricActive">0</div>
        </div>
        <div class="metric-pill">
          <div class="metric-label"
               data-kz="–°–æ“£“ì—ã—Å—ã"
               data-ru="–ü–æ—Å–ª–µ–¥–Ω–∏–π">
            –°–æ“£“ì—ã—Å—ã
          </div>
          <div class="metric-value" id="metricLast">‚Äî</div>
        </div>
      </div>
    </section>

    <section>
      <div class="filters-row">
        <button class="filter-pill active" data-filter="all" id="filterAll">
          <span>üì¶</span>
          <span data-kz="–ë–∞—Ä–ª—ã“ì—ã" data-ru="–í—Å–µ">–ë–∞—Ä–ª—ã“ì—ã</span>
        </button>
        <button class="filter-pill" data-filter="active" id="filterActive">
          <span>üü¢</span>
          <span data-kz="–ë–µ–ª—Å–µ–Ω–¥—ñ" data-ru="–ê–∫—Ç–∏–≤–Ω—ã–µ">–ë–µ–ª—Å–µ–Ω–¥—ñ</span>
        </button>
        <button class="filter-pill" data-filter="completed" id="filterCompleted">
          <span>‚úÖ</span>
          <span data-kz="–ê—è“õ—Ç–∞–ª“ì–∞–Ω" data-ru="–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ">–ê—è“õ—Ç–∞–ª“ì–∞–Ω</span>
        </button>
      </div>

      <div class="card-list" id="ordersList"></div>

      <div class="empty-state" id="emptyState" style="display:none"
           data-kz="”ò–∑—ñ—Ä–≥–µ —Ç–∞–ø—Å—ã—Ä—ã—Å —Ç–∞—Ä–∏—Ö—ã –∂–æ“õ. –ë–∞—Å—Ç—ã –±–µ—Ç—Ç–µ–Ω –∂–∞“£–∞ –∂–µ—Ç–∫—ñ–∑—É–≥–µ —Ç–∞–ø—Å—ã—Ä—ã—Å –±–µ—Ä—ñ–ø –∫”©—Ä—ñ“£—ñ–∑."
           data-ru="–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –ø—É—Å—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ñ–æ—Ä–º–∏—Ç—å –ø–µ—Ä–≤—É—é –¥–æ—Å—Ç–∞–≤–∫—É –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ.">
        ”ò–∑—ñ—Ä–≥–µ —Ç–∞–ø—Å—ã—Ä—ã—Å —Ç–∞—Ä–∏—Ö—ã –∂–æ“õ. –ë–∞—Å—Ç—ã –±–µ—Ç—Ç–µ–Ω –∂–∞“£–∞ –∂–µ—Ç–∫—ñ–∑—É–≥–µ —Ç–∞–ø—Å—ã—Ä—ã—Å –±–µ—Ä—ñ–ø –∫”©—Ä—ñ“£—ñ–∑.
      </div>
    </section>
  </main>
</div>

<nav class="bottom-nav">
  <div class="bottom-nav-inner">
    <button class="nav-item active" id="tabHistory" type="button">
      <span class="icon">üìú</span>
      <span class="nav-item-label"
            data-kz="–¢–∞—Ä–∏—Ö"
            data-ru="–ò—Å—Ç–æ—Ä–∏—è">–¢–∞—Ä–∏—Ö</span>
    </button>

    <button class="nav-item" id="tabHome" type="button">
      <span class="icon">üè†</span>
      <span class="nav-item-label"
            data-kz="–ë–∞—Å—Ç—ã"
            data-ru="–ì–ª–∞–≤–Ω–∞—è">–ë–∞—Å—Ç—ã</span>
    </button>

    <div class="nav-spacer"></div>
  </div>
</nav>

<!-- ORDER DETAIL SHEET WITH MAP -->
<div class="order-detail-modal" id="orderDetailModal">
  <div class="order-detail-sheet">
    <div class="order-detail-header">
      <div>
        <div class="order-detail-title"
             data-kz="–¢–∞–ø—Å—ã—Ä—ã—Å –º”ô–ª—ñ–º–µ—Ç—Ç–µ—Ä—ñ"
             data-ru="–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞">
          –î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞
        </div>
        <div class="order-detail-subtitle" id="detailCreatedText">‚Äî</div>
      </div>
      <button class="order-detail-close" id="detailCloseBtn" aria-label="Close">√ó</button>
    </div>

    <div class="order-detail-content">
      <div class="order-detail-map-wrap">
        <div id="detailMap"></div>
        <div class="order-detail-map-chip" id="detailRouteChip">–ú–∞—Ä—à—Ä—É—Ç...</div>
      </div>

      <div class="order-detail-body">
        <div class="detail-route-block">
          <div class="detail-route-line" style="margin-bottom:8px;">
            <div class="detail-pin a">A</div>
            <div class="detail-route-text">
              <div class="detail-route-label"
                   data-kz="“ö–∞–π–¥–∞–Ω"
                   data-ru="–û—Ç–∫—É–¥–∞">–û—Ç–∫—É–¥–∞</div>
              <div class="detail-route-address" id="detailFrom">‚Äî</div>
            </div>
          </div>
          <div class="detail-route-line">
            <div class="detail-pin b">B</div>
            <div class="detail-route-text">
              <div class="detail-route-label"
                   data-kz="“ö–∞–π–¥–∞"
                   data-ru="–ö—É–¥–∞">–ö—É–¥–∞</div>
              <div class="detail-route-address" id="detailTo">‚Äî</div>
            </div>
          </div>
        </div>

        <div class="detail-meta-row">
          <div class="detail-chip">
            <span data-kz="“ö“±–Ω—ã" data-ru="–°—Ç–æ–∏–º–æ—Å—Ç—å">–°—Ç–æ–∏–º–æ—Å—Ç—å</span>
            <span class="detail-price-main" id="detailPrice">0 ‚Ç∏</span>
          </div>
          <div class="detail-chip">
            <span id="detailDistance">‚Äî –∫–º</span>
          </div>
          <div class="detail-chip">
            <span id="detailEta">‚Äî –º–∏–Ω</span>
          </div>
        </div>

        <div class="detail-meta-row">
          <div class="detail-status-pill" id="detailStatusPill">
            <span class="status-dot"></span>
            <span id="detailStatusText">‚Äî</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- NEW: Confirmation Dialog -->
<div class="confirm-dialog" id="confirmDialog">
  <div class="confirm-dialog-box">
    <div class="confirm-dialog-title" id="confirmTitle"
         data-kz="–¢–∞–ø—Å—ã—Ä—ã—Å—Ç—ã –±–∞—Å —Ç–∞—Ä—Ç—É?"
         data-ru="–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑?">
      –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑?
    </div>
    <div class="confirm-dialog-message" id="confirmMessage"
         data-kz="–°—ñ–∑ —Ç–∞–ø—Å—ã—Ä—ã—Å—Ç—ã –±–∞—Å —Ç–∞—Ä—Ç“õ—ã“£—ã–∑ –∫–µ–ª–µ—Ç—ñ–Ω—ñ–Ω–µ —Å–µ–Ω—ñ–º–¥—ñ—Å—ñ–∑ –±–µ? –ë“±–ª ”ô—Ä–µ–∫–µ—Ç—Ç—ñ “õ–∞–π—Ç–∞—Ä—É –º“Ø–º–∫—ñ–Ω –µ–º–µ—Å."
         data-ru="–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å.">
      –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å.
    </div>
    <div class="confirm-dialog-actions">
      <button class="confirm-dialog-btn secondary" id="confirmCancel"
              data-kz="–ñ–æ“õ"
              data-ru="–ù–µ—Ç">–ù–µ—Ç</button>
      <button class="confirm-dialog-btn danger" id="confirmOk"
              data-kz="–ò”ô, –±–∞—Å —Ç–∞—Ä—Ç—É"
              data-ru="–î–∞, –æ—Ç–º–µ–Ω–∏—Ç—å">–î–∞, –æ—Ç–º–µ–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<script>
  let currentLang = "kz";
  let allOrders = [];
  let currentFilter = "all";

  let detailMap = null;
  let currentOrder = null;
  let orderToCancel = null;

  document.addEventListener("DOMContentLoaded", () => {
    initTelegramViewport();
    initTelegramUser();
    bindEvents();
    setLang("kz");
    loadHistory();
  });

  function initTelegramViewport() {
    try {
      const tg = window.Telegram?.WebApp;
      if (!tg) return;
      tg.ready();
      tg.expand();

      const root = document.documentElement;
      if (tg.viewportStableHeight) {
        root.style.setProperty("--tg-viewport-stable-height", tg.viewportStableHeight + "px");
      }
      if (tg.safeAreaInsetTop !== undefined) {
        root.style.setProperty("--tg-safe-area-inset-top", tg.safeAreaInsetTop + "px");
        root.style.setProperty("--tg-safe-area-inset-bottom", tg.safeAreaInsetBottom + "px");
        root.style.setProperty("--tg-safe-area-inset-left", tg.safeAreaInsetLeft + "px");
        root.style.setProperty("--tg-safe-area-inset-right", tg.safeAreaInsetRight + "px");
      }

      if (tg.disableVerticalSwipes) tg.disableVerticalSwipes();
    } catch (e) {
      console.warn("Telegram viewport init error:", e);
    }
  }

  function getTelegramId() {
    try {
      if (window.Telegram?.WebApp?.initDataUnsafe?.user) {
        return window.Telegram.WebApp.initDataUnsafe.user.id;
      }
    } catch(e){}

    const params = new URLSearchParams(location.search);
    const testId = params.get("test_id");
    return testId ? parseInt(testId, 10) : null;
  }

  function initTelegramUser() {
    try {
      const user = window.Telegram?.WebApp?.initDataUnsafe?.user;
      if (!user) return;

      const nameEl = document.getElementById("userNameText");
      const avatarImg = document.getElementById("userAvatarImg");
      const avatarFallback = document.getElementById("userAvatarFallback");

      const fullName = [user.first_name, user.last_name].filter(Boolean).join(" ");
      const displayName = user.username ? ("@" + user.username) : (fullName || "–ö–ª–∏–µ–Ω—Ç");
      if (nameEl) nameEl.textContent = displayName;

      if (user.photo_url && avatarImg) {
        avatarImg.src = user.photo_url;
        avatarImg.style.display = "block";
        if (avatarFallback) avatarFallback.style.display = "none";
      } else if (avatarFallback) {
        avatarFallback.textContent = (fullName || "A")[0].toUpperCase();
      }
    } catch(e){
      console.warn("init user error:", e);
    }
  }

  function bindEvents() {
    const backBtn = document.getElementById("backBtn");
    const tabHome = document.getElementById("tabHome");
    const tabHistory = document.getElementById("tabHistory");
    const modal = document.getElementById("orderDetailModal");
    const closeBtn = document.getElementById("detailCloseBtn");

    if (backBtn) backBtn.addEventListener("click", () => {
      window.location.href = "/main-client";
    });

    if (tabHome) {
      tabHome.addEventListener("click", () => {
        window.location.href = "/main-client";
      });
    }
    if (tabHistory) {
      tabHistory.addEventListener("click", () => {
        // already here
      });
    }

    // Filter pills
    document.querySelectorAll(".filter-pill").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".filter-pill").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentFilter = btn.getAttribute("data-filter");
        renderOrders();
      });
    });

    // Language buttons
    document.querySelectorAll(".lang-btn").forEach(btn => {
      btn.addEventListener("click", (e) => {
        const lang = e.currentTarget.getAttribute("data-lang");
        setLang(lang);
      });
    });

    // Modal close
    if (modal) {
      modal.addEventListener("click", (e) => {
        if (e.target === modal) {
          closeOrderDetail();
        }
      });
    }
    if (closeBtn) {
      closeBtn.addEventListener("click", closeOrderDetail);
    }
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        const modalEl = document.getElementById("orderDetailModal");
        if (modalEl && modalEl.classList.contains("show")) {
          closeOrderDetail();
        }
        const confirmEl = document.getElementById("confirmDialog");
        if (confirmEl && confirmEl.classList.contains("show")) {
          closeConfirmDialog();
        }
      }
    });

    // Confirm dialog
    const confirmCancel = document.getElementById("confirmCancel");
    const confirmOk = document.getElementById("confirmOk");
    if (confirmCancel) {
      confirmCancel.addEventListener("click", closeConfirmDialog);
    }
    if (confirmOk) {
      confirmOk.addEventListener("click", confirmCancelOrder);
    }
  }

  async function loadHistory() {
    const overlay = document.getElementById("loadingOverlay");
    const appRoot = document.getElementById("appRoot");
    const tgId = getTelegramId();

    if (!tgId) {
      updateLoadingText("noUser");
      setTimeout(() => {
        overlay.classList.add("hidden");
        appRoot.classList.add("visible");
      }, 250);
      return;
    }

    updateLoadingText("loading");

    try {
      const res = await fetch("/api/user/history", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({telegram_id: tgId})
      });

      if (!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      if (!data.success) throw new Error(data.message || "Error");

      allOrders = (data.data && data.data.orders) || [];
      updateSummary();
      renderOrders();
    } catch(e){
      console.error("loadHistory error:", e);
      updateLoadingText("error");
    } finally {
      setTimeout(() => {
        overlay.classList.add("hidden");
        appRoot.classList.add("visible");
      }, 250);
    }
  }

  function updateLoadingText(mode) {
    const el = document.querySelector(".loading-text");
    if (!el) return;

    const dict = {
      kz:{
        loading:"–¢–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä –∂“Ø–∫—Ç–µ–ª—É–¥–µ...",
        error:"“ö–∞—Ç–µ –ø–∞–π–¥–∞ –±–æ–ª–¥—ã. –ö–µ–π—ñ–Ω—ñ—Ä–µ–∫ “õ–∞–π—Ç–∞–ª–∞–ø –∫”©—Ä—ñ“£—ñ–∑.",
        noUser:"Telegram –¥–µ—Ä–µ–∫—Ç–µ—Ä—ñ —Ç–∞–±—ã–ª–º–∞–¥—ã. –ü—Ä–æ—Ñ–∏–ª—å –∞—à—ã–ª—É–¥–∞."
      },
      ru:{
        loading:"–ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∞—à–∏ –∑–∞–∫–∞–∑—ã...",
        error:"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
        noUser:"–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö Telegram. –û—Ç–∫—Ä—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é."
      }
    };
    const langDict = dict[currentLang] || dict.kz;
    el.textContent = langDict[mode] || langDict.loading;
  }

  function statusToLabel(status){
    status = (status || "").toLowerCase();
    const map = {
      pending:{kz:"–ö“Ø—Ç—É–¥–µ",ru:"–í –æ–∂–∏–¥–∞–Ω–∏–∏"},
      matched:{kz:"–ñ“Ø—Ä–≥—ñ–∑—É—à—ñ —Ç–∞–±—ã–ª–¥—ã",ru:"–í–æ–¥–∏—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω"},
      in_progress:{kz:"–ñ–æ–ª–¥–∞",ru:"–í –ø—É—Ç–∏"},
      completed:{kz:"–ê—è“õ—Ç–∞–ª“ì–∞–Ω",ru:"–ó–∞–≤–µ—Ä—à—ë–Ω"},
      cancelled:{kz:"–ë–∞—Å —Ç–∞—Ä—Ç—ã–ª–¥—ã",ru:"–û—Ç–º–µ–Ω—ë–Ω"}
    };
    const item = map[status] || map["pending"];
    return item[currentLang];
  }

  function statusClass(status){
    status = (status || "").toLowerCase();
    if (status === "completed") return "status-completed";
    if (status === "cancelled") return "status-cancelled";
    if (status === "in_progress" || status === "matched") return "status-active";
    return "status-pending";
  }

  function isActiveStatus(status){
    status = (status || "").toLowerCase();
    return status === "pending" || status === "matched" || status === "in_progress";
  }

  function canCancelOrder(status){
    status = (status || "").toLowerCase();
    return status === "pending" || status === "matched" || status === "in_progress";
  }

  function formatDate(str){
    if (!str) return "‚Äî";
    const d = new Date(str);
    if (isNaN(d.getTime())) return str;
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const hh = String(d.getHours()).padStart(2,"0");
    const min = String(d.getMinutes()).padStart(2,"0");
    return `${dd}.${mm} ${hh}:${min}`;
  }

  function updateSummary(){
    const total = allOrders.length;
    let active = 0;
    let lastDate = null;

    allOrders.forEach(o => {
      if (isActiveStatus(o.status)) active++;
      const dt = new Date(o.created_at || o.CreatedAt || o.createdAt);
      if (!isNaN(dt.getTime())) {
        if (!lastDate || dt > lastDate) lastDate = dt;
      }
    });

    const totalEl = document.getElementById("metricTotal");
    const activeEl = document.getElementById("metricActive");
    const lastEl = document.getElementById("metricLast");

    if (totalEl) totalEl.textContent = total;
    if (activeEl) activeEl.textContent = active;
    if (lastEl) {
      if (!lastDate) {
        lastEl.textContent = "‚Äî";
      } else {
        const dd = String(lastDate.getDate()).padStart(2,"0");
        const mm = String(lastDate.getMonth()+1).padStart(2,"0");
        lastEl.textContent = `${dd}.${mm}`;
      }
    }
  }

  function renderOrders(){
    const list = document.getElementById("ordersList");
    const empty = document.getElementById("emptyState");
    if (!list) return;
    list.innerHTML = "";

    let filtered = allOrders;
    if (currentFilter === "active") {
      filtered = allOrders.filter(o => isActiveStatus(o.status));
    } else if (currentFilter === "completed") {
      filtered = allOrders.filter(o => (o.status || "").toLowerCase() === "completed");
    }

    if (!filtered.length) {
      if (empty) {
        const t = empty.getAttribute("data-" + currentLang);
        if (t) empty.textContent = t;
        empty.style.display = "block";
      }
      return;
    } else if (empty) {
      empty.style.display = "none";
    }

    const cancelBtnText = {
      kz: "–ë–∞—Å —Ç–∞—Ä—Ç—É",
      ru: "–û—Ç–º–µ–Ω–∏—Ç—å"
    };

    filtered.forEach(o => {
      const card = document.createElement("article");
      card.className = "order-card";

      const from = o.from_address || o.FromAddress || "";
      const to = o.to_address || o.ToAddress || "";
      const price = o.price || o.Price || 0;
      const status = o.status || o.Status || "pending";
      const distance = o.distance_km || o.DistanceKm || null;
      const eta = o.eta_min || o.EtaMin || null;
      const created = o.created_at || o.CreatedAt || o.createdAt;

      const canCancel = canCancelOrder(status);

      card.innerHTML = `
        <div class="order-card-content" data-order-id="${escapeHTML(o.id || o.ID || o.Id)}">
          <div class="order-route">
            <div class="route-main">
              <div class="route-line">
                <span class="route-city">${escapeHTML(from)}</span>
                <span class="route-arrow">‚Üí</span>
                <span class="route-city">${escapeHTML(to)}</span>
              </div>
              <div class="route-sub">
                ${formatDate(created)}
              </div>
            </div>
            <div class="price-pill">${Number(price).toLocaleString("ru-RU")} ‚Ç∏</div>
          </div>

          <div class="order-meta-row">
            <div class="status-pill ${statusClass(status)}">
              <span class="status-dot"></span>
              <span>${statusToLabel(status)}</span>
            </div>
            <div class="meta-right">
              ${distance ? `<span>${Number(distance).toFixed(1)} –∫–º</span>` : ""}
              ${eta ? `<span>~${eta} –º–∏–Ω</span>` : ""}
            </div>
          </div>
        </div>

        ${canCancel ? `
          <div class="order-actions">
            <button class="cancel-btn" data-order-id="${escapeHTML(o.id || o.ID || o.Id)}">
              <span>‚úï</span>
              <span>${cancelBtnText[currentLang]}</span>
            </button>
          </div>
        ` : ''}
      `;

      // Click on card content to open details
      const cardContent = card.querySelector('.order-card-content');
      if (cardContent) {
        cardContent.addEventListener("click", () => openOrderDetail(o));
      }

      // Cancel button handler
      if (canCancel) {
        const cancelBtn = card.querySelector('.cancel-btn');
        if (cancelBtn) {
          cancelBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            showConfirmDialog(o);
          });
        }
      }

      list.appendChild(card);
    });
  }

  function escapeHTML(str){
    if (!str) return "";
    return String(str)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;");
  }

  /* ===== CANCEL ORDER FUNCTIONALITY ===== */
  
  function showConfirmDialog(order) {
    orderToCancel = order;
    const dialog = document.getElementById("confirmDialog");
    if (dialog) {
      dialog.classList.add("show");
      
      // Apply language to dialog
      applyLangToElement(document.getElementById("confirmTitle"));
      applyLangToElement(document.getElementById("confirmMessage"));
      applyLangToElement(document.getElementById("confirmCancel"));
      applyLangToElement(document.getElementById("confirmOk"));
    }
  }

  function closeConfirmDialog() {
    orderToCancel = null;
    const dialog = document.getElementById("confirmDialog");
    if (dialog) {
      dialog.classList.remove("show");
    }
  }

  async function confirmCancelOrder() {
    if (!orderToCancel) return;

    const orderId = orderToCancel.id || orderToCancel.ID || orderToCancel.Id;
    const tgId = getTelegramId();

    if (!orderId || !tgId) {
      alert(currentLang === "kz" ? "“ö–∞—Ç–µ: —Ç–∞–ø—Å—ã—Ä—ã—Å –∞–Ω—ã“õ—Ç–∞–ª–º–∞–¥—ã" : "–û—à–∏–±–∫–∞: –∑–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω");
      closeConfirmDialog();
      return;
    }

    // Disable confirm button to prevent double-clicks
    const confirmBtn = document.getElementById("confirmOk");
    if (confirmBtn) {
      confirmBtn.disabled = true;
      confirmBtn.textContent = currentLang === "kz" ? "–ö“Ø—Ç–µ —Ç“±—Ä—ã“£—ã–∑..." : "–ü–æ–¥–æ–∂–¥–∏—Ç–µ...";
    }

    try {
      const res = await fetch("/api/user/cancel-order", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          telegram_id: tgId,
          order_id: orderId
        })
      });

      const data = await res.json();

      if (!res.ok || !data.success) {
        throw new Error(data.message || "Failed to cancel order");
      }

      // Update the order status in local array
      const orderIndex = allOrders.findIndex(o => 
        (o.id || o.ID || o.Id) === orderId
      );
      if (orderIndex !== -1) {
        allOrders[orderIndex].status = "cancelled";
        allOrders[orderIndex].Status = "cancelled";
      }

      // Close dialog and refresh UI
      closeConfirmDialog();
      updateSummary();
      renderOrders();

      // Show success message (optional)
      if (window.Telegram?.WebApp?.showAlert) {
        const successMsg = currentLang === "kz" 
          ? "–¢–∞–ø—Å—ã—Ä—ã—Å —Å”ô—Ç—Ç—ñ –±–∞—Å —Ç–∞—Ä—Ç—ã–ª–¥—ã"
          : "–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ–Ω—ë–Ω";
        window.Telegram.WebApp.showAlert(successMsg);
      }

    } catch (error) {
      console.error("Cancel order error:", error);
      
      const errorMsg = currentLang === "kk"
        ? "–¢–∞–ø—Å—ã—Ä—ã—Å—Ç—ã –±–∞—Å —Ç–∞—Ä—Ç—É –∫–µ–∑—ñ–Ω–¥–µ “õ–∞—Ç–µ –ø–∞–π–¥–∞ –±–æ–ª–¥—ã. “ö–∞–π—Ç–∞–ª–∞–ø –∫”©—Ä—ñ“£—ñ–∑."
        : "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–∫–∞–∑–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.";
      
      if (window.Telegram?.WebApp?.showAlert) {
        window.Telegram.WebApp.showAlert(errorMsg);
      } else {
        alert(errorMsg);
      }
      
      closeConfirmDialog();
    }
  }

  /* ===== DETAIL SHEET + MAP ===== */

  function openOrderDetail(order){
    currentOrder = order;

    const modal = document.getElementById("orderDetailModal");
    if (!modal) return;

    const from = order.from_address || order.FromAddress || "";
    const to = order.to_address || order.ToAddress || "";
    const price = order.price || order.Price || 0;
    const status = order.status || order.Status || "pending";
    const distance = order.distance_km || order.DistanceKm || null;
    const eta = order.eta_min || order.EtaMin || null;
    const created = order.created_at || order.CreatedAt || order.createdAt;

    document.getElementById("detailFrom").textContent = from || "‚Äî";
    document.getElementById("detailTo").textContent = to || "‚Äî";
    document.getElementById("detailPrice").textContent =
      `${Number(price).toLocaleString("ru-RU")} ‚Ç∏`;
    document.getElementById("detailCreatedText").textContent = formatDate(created);

    const distLabel = document.getElementById("detailDistance");
    const etaLabel = document.getElementById("detailEta");
    const chip = document.getElementById("detailRouteChip");

    const distText = distance ? `${Number(distance).toFixed(1)} –∫–º` : "‚Äî –∫–º";
    const etaText = eta ? `~${eta} –º–∏–Ω` : "‚Äî –º–∏–Ω";

    distLabel.textContent = distText;
    etaLabel.textContent = etaText;
    chip.textContent = (distance || eta) ? `${distText} ‚Ä¢ ${etaText}` : "–ú–∞—Ä—à—Ä—É—Ç";

    const pill = document.getElementById("detailStatusPill");
    const text = document.getElementById("detailStatusText");
    pill.className = "detail-status-pill " + statusClass(status);
    text.textContent = statusToLabel(status);

    modal.classList.add("show");

    setTimeout(() => {
      initDetailMap(order);
    }, 200);
  }

  function closeOrderDetail(){
    const modal = document.getElementById("orderDetailModal");
    if (modal) modal.classList.remove("show");
    currentOrder = null;
    if (detailMap) {
      detailMap.remove();
      detailMap = null;
    }
  }

  function getNum(v){
    const n = parseFloat(v);
    return isNaN(n) ? null : n;
  }

  async function initDetailMap(order){
    const mapContainer = document.getElementById("detailMap");
    if (!mapContainer) return;

    const fromLat = getNum(order.from_lat || order.FromLat || order.fromLat);
    const fromLon = getNum(order.from_lon || order.FromLon || order.fromLon || order.from_lng || order.fromLng);
    const toLat   = getNum(order.to_lat   || order.ToLat   || order.toLat);
    const toLon   = getNum(order.to_lon   || order.ToLon   || order.toLon   || order.to_lng   || order.toLng);

    const hasFrom = fromLat !== null && fromLon !== null;
    const hasTo   = toLat   !== null && toLon   !== null;

    if (!detailMap) {
      detailMap = L.map(mapContainer, {
        zoomControl:false,
        attributionControl:false
      }).setView([43.238949, 76.889709], 11);

      L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
        {maxZoom:19, subdomains:"abcd"}
      ).addTo(detailMap);
    }

    detailMap.eachLayer(l => {
      if (!(l instanceof L.TileLayer)) {
        detailMap.removeLayer(l);
      }
    });

    if (!hasFrom && !hasTo) {
      detailMap.setView([43.238949, 76.889709], 11);
      setTimeout(() => detailMap.invalidateSize(), 150);
      return;
    }

    if (hasFrom) {
      const iconA = L.divIcon({
        html:'<div style="width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;background:#000;border:3px solid #fff;box-shadow:0 4px 14px rgba(0,0,0,.25)">A</div>',
        className:"",
        iconSize:[32,32],
        iconAnchor:[16,32]
      });
      L.marker([fromLat, fromLon], {icon:iconA}).addTo(detailMap);
    }

    if (hasTo) {
      const iconB = L.divIcon({
        html:'<div style="width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;background:#0B63F6;border:3px solid #fff;box-shadow:0 4px 14px rgba(0,0,0,.25)">B</div>',
        className:"",
        iconSize:[32,32],
        iconAnchor:[16,32]
      });
      L.marker([toLat, toLon], {icon:iconB}).addTo(detailMap);
    }

    if (hasFrom && hasTo) {
      await drawRouteUberStyle({fromLat, fromLon, toLat, toLon});
    } else if (hasFrom) {
      detailMap.setView([fromLat, fromLon], 13);
      setTimeout(() => detailMap.invalidateSize(), 150);
    } else if (hasTo) {
      detailMap.setView([toLat, toLon], 13);
      setTimeout(() => detailMap.invalidateSize(), 150);
    }
  }

  async function drawRouteUberStyle(coords){
    if (!detailMap) return;
    const {fromLat, fromLon, toLat, toLon} = coords;
    const chip = document.getElementById("detailRouteChip");
    const distLabel = document.getElementById("detailDistance");
    const etaLabel = document.getElementById("detailEta");

    try {
      chip.textContent = currentLang === "ru" ? "–†–∞—Å—á—ë—Ç –º–∞—Ä—à—Ä—É—Ç–∞..." : "–ú–∞—Ä—à—Ä—É—Ç –µ—Å–µ–ø—Ç–µ–ª—É–¥–µ...";

      const url =
        `https://router.project-osrm.org/route/v1/driving/` +
        `${fromLon},${fromLat};${toLon},${toLat}` +
        `?overview=full&geometries=geojson&steps=true`;

      const r = await fetch(url);
      if (!r.ok) throw new Error("OSRM");
      const data = await r.json();
      if (!(data.routes && data.routes.length)) throw new Error("no route");

      const route = data.routes[0];
      const coordsList = route.geometry.coordinates.map(c => [c[1], c[0]]);

      const main = L.polyline(coordsList, {
        color:"#000000",
        weight:5,
        opacity:0.9
      }).addTo(detailMap);

      const shadow = L.polyline(coordsList, {
        color:"#00000030",
        weight:7,
        opacity:0.3
      }).addTo(detailMap);
      shadow.bringToBack();

      const bounds = L.latLngBounds(coordsList);
      detailMap.fitBounds(bounds, {padding:[24,24], maxZoom:16});
      setTimeout(() => detailMap.invalidateSize(), 150);

      const km = (route.distance/1000).toFixed(1);
      const min = Math.round(route.duration/60);

      const distText = `${km} –∫–º`;
      const etaText = `~${min} –º–∏–Ω`;

      distLabel.textContent = distText;
      etaLabel.textContent = etaText;
      chip.textContent = `${distText} ‚Ä¢ ${etaText}`;
    } catch(e){
      console.warn("route error", e);
      const coordsAB = [[fromLat, fromLon],[toLat, toLon]];
      L.polyline(coordsAB, {
        color:"#000000",
        weight:4,
        opacity:0.8,
        dashArray:"10,5"
      }).addTo(detailMap);

      const bounds = L.latLngBounds(coordsAB);
      detailMap.fitBounds(bounds, {padding:[24,24], maxZoom:16});
      setTimeout(() => detailMap.invalidateSize(), 150);

      const R = 6371;
      const dLat = (toLat - fromLat) * Math.PI/180;
      const dLon = (toLon - fromLon) * Math.PI/180;
      const a = Math.sin(dLat/2)**2 +
                Math.cos(fromLat*Math.PI/180) *
                Math.cos(toLat*Math.PI/180) *
                Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      const d = R * c;

      const km = d.toFixed(1);
      const min = Math.round((d / 40) * 60);

      const distText = `${km} –∫–º`;
      const etaText = `~${min} –º–∏–Ω`;

      distLabel.textContent = distText;
      etaLabel.textContent = etaText;
      chip.textContent = `${distText} ‚Ä¢ ${etaText}`;
    }
  }

  /* ===== LANG ===== */
  function setLang(lang){
    currentLang = lang;

    document.querySelectorAll(".lang-btn").forEach(b => b.classList.remove("active"));
    const active = document.getElementById("lang-" + lang);
    if (active) active.classList.add("active");

    document.querySelectorAll("[data-kz]").forEach(el => {
      applyLangToElement(el);
    });

    renderOrders();
    updateSummary();
  }

  function applyLangToElement(el) {
    if (!el) return;
    const text = el.getAttribute("data-" + currentLang);
    if (text) el.textContent = text;
  }

  window.setLang = setLang;
</script>
</body>
</html>